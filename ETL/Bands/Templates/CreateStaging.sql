USE [master]
GO
/****** Object:  Database [MiXStaging]    Script Date: 2012/12/02 02:27:05 PM ******/
CREATE DATABASE [MiXStaging] ON  PRIMARY 
( NAME = N'MiXStaging_Primary', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging.mdf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [auditFG] 
( NAME = N'auditFile', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_audit.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [ControlFG] 
( NAME = N'controlFile', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_control.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [StageControlFG] 
( NAME = N'stageControlFile', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageControl.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [StageUser10FG] 
( NAME = N'stageUser10_1', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser10_1.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
( NAME = N'stageUser10_2', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser10_2.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [StageUser1FG] 
( NAME = N'stageUser1_1', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_StageUser1_1.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
( NAME = N'stageUser1_2', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser1_2.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [StageUser2FG] 
( NAME = N'stageUser2_1', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser2_1.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
( NAME = N'stageUser2_2', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser2_2.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [StageUser3FG] 
( NAME = N'stageUser3_1', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser3_1.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
( NAME = N'stageUser3_2', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser3_2.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [StageUser4FG] 
( NAME = N'stageUser4_1', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser4_1.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
( NAME = N'stageUser4_2', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser4_2.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [StageUser5FG] 
( NAME = N'stageUser5_1', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser5_1.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
( NAME = N'stageUser5_2', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser5_2.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [StageUser6FG] 
( NAME = N'stageUser6_1', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser6_1.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
( NAME = N'stageUser6_2', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser6_2.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [StageUser7FG] 
( NAME = N'stageUser7_1', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser7_1.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
( NAME = N'stageUser7_2', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser7_2.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [StageUser8FG] 
( NAME = N'stageUser8_1', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser8_1.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
( NAME = N'stageUser8_2', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser8_2.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [StageUser9FG] 
( NAME = N'stageUser9_1', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser9_1.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
( NAME = N'stageUser9_2', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser9_2.ndf' , SIZE = 4096KB , MAXSIZE = UNLIMITED, FILEGROWTH = 4096KB ), 
 FILEGROUP [StageUserFG] 
( NAME = N'stageUserFile', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging_stageUser.ndf' , SIZE = 2048KB , MAXSIZE = 2048KB , FILEGROWTH = 0)
 LOG ON 
( NAME = N'MixStaging_log', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL10_50.SQL2K8R2\MSSQL\DATA\MiXStaging.ldf' , SIZE = 4096KB , MAXSIZE = 268435456KB , FILEGROWTH = 4096KB )
GO
ALTER DATABASE [MiXStaging] ADD FILEGROUP [StageUser11FG]
GO
ALTER DATABASE [MiXStaging] ADD FILEGROUP [StageUser12FG]
GO
ALTER DATABASE [MiXStaging] ADD FILEGROUP [StageUser13FG]
GO
ALTER DATABASE [MiXStaging] ADD FILEGROUP [StageUser14FG]
GO
ALTER DATABASE [MiXStaging] ADD FILEGROUP [StageUser15FG]
GO
ALTER DATABASE [MiXStaging] SET COMPATIBILITY_LEVEL = 100
GO
IF (1 = FULLTEXTSERVICEPROPERTY('IsFullTextInstalled'))
begin
EXEC [MiXStaging].[dbo].[sp_fulltext_database] @action = 'enable'
end
GO
ALTER DATABASE [MiXStaging] SET ANSI_NULL_DEFAULT OFF 
GO
ALTER DATABASE [MiXStaging] SET ANSI_NULLS ON 
GO
ALTER DATABASE [MiXStaging] SET ANSI_PADDING ON 
GO
ALTER DATABASE [MiXStaging] SET ANSI_WARNINGS ON 
GO
ALTER DATABASE [MiXStaging] SET ARITHABORT OFF 
GO
ALTER DATABASE [MiXStaging] SET AUTO_CLOSE OFF 
GO
ALTER DATABASE [MiXStaging] SET AUTO_CREATE_STATISTICS ON 
GO
ALTER DATABASE [MiXStaging] SET AUTO_SHRINK OFF 
GO
ALTER DATABASE [MiXStaging] SET AUTO_UPDATE_STATISTICS ON 
GO
ALTER DATABASE [MiXStaging] SET CURSOR_CLOSE_ON_COMMIT OFF 
GO
ALTER DATABASE [MiXStaging] SET CURSOR_DEFAULT  LOCAL 
GO
ALTER DATABASE [MiXStaging] SET CONCAT_NULL_YIELDS_NULL ON 
GO
ALTER DATABASE [MiXStaging] SET NUMERIC_ROUNDABORT OFF 
GO
ALTER DATABASE [MiXStaging] SET QUOTED_IDENTIFIER ON 
GO
ALTER DATABASE [MiXStaging] SET RECURSIVE_TRIGGERS OFF 
GO
ALTER DATABASE [MiXStaging] SET  DISABLE_BROKER 
GO
ALTER DATABASE [MiXStaging] SET AUTO_UPDATE_STATISTICS_ASYNC OFF 
GO
ALTER DATABASE [MiXStaging] SET DATE_CORRELATION_OPTIMIZATION OFF 
GO
ALTER DATABASE [MiXStaging] SET TRUSTWORTHY ON 
GO
ALTER DATABASE [MiXStaging] SET ALLOW_SNAPSHOT_ISOLATION OFF 
GO
ALTER DATABASE [MiXStaging] SET PARAMETERIZATION SIMPLE 
GO
ALTER DATABASE [MiXStaging] SET READ_COMMITTED_SNAPSHOT OFF 
GO
ALTER DATABASE [MiXStaging] SET HONOR_BROKER_PRIORITY OFF 
GO
ALTER DATABASE [MiXStaging] SET RECOVERY SIMPLE 
GO
ALTER DATABASE [MiXStaging] SET  MULTI_USER 
GO
ALTER DATABASE [MiXStaging] SET PAGE_VERIFY CHECKSUM  
GO
ALTER DATABASE [MiXStaging] SET DB_CHAINING OFF 
GO
EXEC sys.sp_db_vardecimal_storage_format N'MiXStaging', N'ON'
GO
USE [MiXStaging]
GO
/****** Object:  User [WarehouseReports]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [WarehouseReports] FOR LOGIN [WarehouseReports] WITH DEFAULT_SCHEMA=[Control]
GO
/****** Object:  User [WarehouseMonitor]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [WarehouseMonitor] FOR LOGIN [WarehouseMonitor] WITH DEFAULT_SCHEMA=[Control]
GO
/****** Object:  User [WarehouseMaintenance]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [WarehouseMaintenance] FOR LOGIN [WarehouseMaintenance] WITH DEFAULT_SCHEMA=[Control]
GO
/****** Object:  User [WarehouseLoad]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [WarehouseLoad] FOR LOGIN [WarehouseLoad] WITH DEFAULT_SCHEMA=[Control]
GO
/****** Object:  User [WarehouseExtract]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [WarehouseExtract] FOR LOGIN [WarehouseExtract] WITH DEFAULT_SCHEMA=[Control]
GO
/****** Object:  User [StageUser9]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [StageUser9] FOR LOGIN [StageUser9] WITH DEFAULT_SCHEMA=[StageUser9]
GO
/****** Object:  User [StageUser8]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [StageUser8] FOR LOGIN [StageUser8] WITH DEFAULT_SCHEMA=[StageUser8]
GO
/****** Object:  User [StageUser7]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [StageUser7] FOR LOGIN [StageUser7] WITH DEFAULT_SCHEMA=[StageUser7]
GO
/****** Object:  User [StageUser6]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [StageUser6] FOR LOGIN [StageUser6] WITH DEFAULT_SCHEMA=[StageUser6]
GO
/****** Object:  User [StageUser5]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [StageUser5] FOR LOGIN [StageUser5] WITH DEFAULT_SCHEMA=[StageUser5]
GO
/****** Object:  User [StageUser4]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [StageUser4] FOR LOGIN [StageUser4] WITH DEFAULT_SCHEMA=[StageUser4]
GO
/****** Object:  User [StageUser3]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [StageUser3] FOR LOGIN [StageUser3] WITH DEFAULT_SCHEMA=[StageUser3]
GO
/****** Object:  User [StageUser2]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [StageUser2] FOR LOGIN [StageUser2] WITH DEFAULT_SCHEMA=[StageUser2]
GO
/****** Object:  User [StageUser10]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [StageUser10] FOR LOGIN [StageUser10] WITH DEFAULT_SCHEMA=[StageUser10]
GO
/****** Object:  User [StageUser1]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE USER [StageUser1] FOR LOGIN [StageUser1] WITH DEFAULT_SCHEMA=[StageUser1]
GO
/****** Object:  User [AFRICA\SteveC]    Script Date: 2012/12/02 02:27:06 PM ******/

GO
/****** Object:  DatabaseRole [WarehouseStagingRole]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE ROLE [WarehouseStagingRole]
GO
/****** Object:  SqlAssembly [MiX.Insight.Staging]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE ASSEMBLY [MiX.Insight.Staging]
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030017D398500000000000000000E00002210B0108000086000000060000000000001EA400000020000000C0000000004000002000000002000004000000000000000400000000000000000001000002000002E70000030040850000100000100000000010000010000000000000100000000000000000000000CCA300004F00000000C00000D80300000000000000000000000000000000000000E000000C00000034A300001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E7465787400000024840000002000000086000000020000000000000000000000000000200000602E72737263000000D803000000C000000004000000880000000000000000000000000000400000402E72656C6F6300000C00000000E0000000020000008C0000000000000000000000000000400000420000000000000000000000000000000000A40000000000004800000002000500185A00001C490000090000000000000000000000000000005020000080000000000000000000000000000000000000000000000000000000000000000000000053E79CDC0014FB5980DD04F50A33F6A4AC6E410F9F8D61E25183E73C22DBD1DC479E9893223A774693E8BD9D1044D3FDBAC4C2F439F7F81A867CAAEC914C80E3722480F04ED5CB0E497F8D17C97E7C025E58FDAD0093F36A1547899A2E1F35D28301ECAD396834D82CDBFA5BB97E21207F33941DB46AAEEEF474ABFBA8B20EB31B3003005B0000000100001100000203280D0000060A0F02280F00000A281000000A25281100000A2D110416281200000A281300000A281400000A281100000A16FE010C082D0500060BDE1800060F02281500000A6C6F1600000A0BDE062600140BDE0000072A000110000000000100515200062E000001133006005C00000002000011000F02281700000A0A0F00281800000A0F01281800000A1200281900000A6C140F02281A00000A731D0000060B0720007701006A6F3100000600076F2F0000060D1203230000000000002E40281B00000A06731C00000A0C2B00082A1B300600380100000300001100140A7E1D00000A0B140C000514FE0116FE01130711072D0400002B2F056F1E00000A16FE01130711072D0400002B1C00056F1F00000A0A056F1F00000A732000000A0B056F2100000A0C000F01282200000A2D120F02280F00000A2D090F00282300000A2B0117130711073AAD000000007201000070732400000A0D00096F2500000A007317000006130411040F00282600000A0F01282700000A0F02281500000A08096F160000061305096F2800000A00110514FE0116FE01130711072D0400002B4211056F2900000A17FE0416FE01130711072D0400002B2B0011057231000070282A00000A16FE01130711072D0A007E1D00000A0B002B0A001105732000000A0B000000DE120914FE01130711072D07096F2B00000A00DC000000DE0E2600120106282000000A0000DE00000713062B0011062A41340000020000007D0000008D0000000A0100001200000000000000000000000B00000016010000210100000E0000002E0000011B300300FE0000000400001100000F00282300000A16FE01130511052D1100724F0000707285000070732C00000A7A0F01280F00000A16FE01130511052D1100729F00007072C3000070732C00000A7A0F00282600000A0F01281500000A28710000060A068E6916FE0216FE01130511053A8300000000068E6917590B06168F0C000002286C00000606078F0C000002286C000006331C06168F0C000002286E00000606078F0C000002286E000006FE012B0116130511052D32000717580B060C0717588D0C0000020A0806166F2D00000A0006078F0C00000206168F0C000002710C000002810C00000200061928720000060D091304DE0D00141304DE072600141304DE000011042A00000110000000000100F2F300072E0000011B3003007C0000000500001100000F00282300000A16FE010D092D1100724F0000707285000070732C00000A7A0F01280F00000A16FE010D092D1100729F00007072C3000070732C00000A7A0F00282600000A0F01281500000A28710000060A068E6916FE0216FE010D092D0D00061828720000060B070CDE0B00140CDE062600140CDE0000082A0110000000000100727300062E0000011B30060065010000060000110072D90000700A7E1D00000A0B140C000514FE0116FE01130811082D0400002B3F056F1E00000A16FE01130811082D0400002B2C000672EF000070056F1F00000A282E00000A282F00000A0A056F1F00000A732000000A0B056F2100000A0C000F01282200000A2D120F02282200000A2D090F00282300000A2B0117130811083AAD000000007201000070732400000A0D00096F2500000A007381000006130411040F00282600000A0F01282700000A0F02282700000A08096F800000061305096F2800000A00110514FE0116FE01130811082D0400002B4211056F2900000A17FE0416FE01130811082D0400002B2B0011057215010070282A00000A16FE01130811082D0A007E1D00000A0B002B0A001105732000000A0B000000DE120914FE01130811082D07096F2B00000A00DC000000DE2713060006722F01007011066F3000000A282E00000A282F00000A0A120106282000000A0000DE00000713072B0011072A0000004134000002000000910000008D0000001E0100001200000000000000000000000F0000002601000035010000270000002E0000011B3006009603000007000011007273010070283100000A0A000406283200000A16FE01131511152D0D007E3300000A1314DD68030000000F02281700000A0B0F00281800000A0F01281800000A1201281900000A6C140F02281A00000A731D0000060C0820007701006A6F3100000600283400000A13161216281700000A0D0F02283500000A733600000A1316121607283700000A131612160907283800000A283900000A13040F03283500000A733600000A1316121607283700000A131612160907283800000A283900000A1305086F2E00000613171217230000000000002EC0281B00000A13171217283A00000A1306086F2F00000613171217230000000000002E40281B00000A13171217283A00000A1307120423000000000000F03F283B00000A131612161106283900000A12041107283900000A283C00000A13081209FE1509000001120AFE1509000001120BFE1509000001120CFE1509000001120DFE152F000001120EFE152F000001120FFE152F0000010412041106283900000A283D00000A16FE01131511152D2C00120423000000000000F0BF283B00000A131612161107283900000A130912041106283900000A130A002B420412041106283900000A283E00000A16FE01131511152D2A0012041107283900000A1309120423000000000000F03F283B00000A131612161106283900000A130A000512051107283900000A283D00000A16FE01131511152D2C00120523000000000000F0BF283B00000A131612161107283900000A130B12051106283900000A130C002B420512051107283900000A283E00000A16FE01131511152D2A0012051107283900000A130B120523000000000000F03F283B00000A131612161106283900000A130C00110B110A283C00000A13101211FE15090000011212FE15090000011109110B283F00000A16FE01131511152D3300041109284000000A16300411092B0104131105110C284000000A163204110C2B0105131211121111283C00000A130D002B311109110B283200000A16FE01131511152D1F00041109284000000A16300411092B01041311110A1111283C00000A130D001210284100000A163003162B071210284100000A13131208284200000A11136A5A284300000A130E1109110B283200000A16FE01131511152D1F0005110C284000000A163204110C2B010513121112110B283C00000A130F00120D284400000A120E284400000A58120F284400000A58284500000A284600000A1314DE0B26007E3300000A1314DE000011142A0000411C0000000000000C0000007B030000870300000B0000000100000113300300E100000008000011000F01282300000A16FE01130411042D0C0072AF010070734700000A7A0F01282300000A16FE01130411042D0C0072E7010070734700000A7A0F00282300000A16FE01130411042D13000F02281800000A734800000A0D3883000000000F00282600000A0F01282600000A722702007028460000060A067227020070282A00000A16FE01130411042D10000F02281800000A734800000A0D2B45007229020070734900000A0B23000000000000F83F13051205284A00000A176F4B00000A13061206284C00000A0C0706086F4D00000A0A06284E00000A734800000A0D2B00092A000000133004004300000009000011000F00282300000A16FE010C082D0A0014284F00000A0B2B280F00282600000A198D390000010D09171F209D09181F099D096F5000000A0A06732000000A0B2B00072A0013300600A40000000A000011000F02281700000A0A0F00281800000A0F01281800000A1200281900000A6C140F02281A00000A731D0000060B0720007701006A6F31000006000F02281A00000A076F2E0000060D1203230000000000002EC0281B00000A285100000A2D280F02281A00000A076F2F0000060D1203230000000000002E40281B00000A285200000A16FE012B0116130411042D0A0017735300000A0C2B0A0016735300000A0C2B00082A133003002E0000000B000011000F00282300000A16FE010B072D0500020A2B18000F00282600000A161F206F5400000A732000000A0A2B00062A000013300300780000000C000011000F01282300000A16FE010B072D0C0072AF010070734700000A7A0F01282300000A16FE010B072D0C0072E7010070734700000A7A0F00282300000A16FE010B072D10000F02281500000A735500000A0A2B23000F00282600000A0F01282600000A0F02281500000A2850000006735500000A0A2B00062A1B300300910000000D00001100000F00285600000A16FE010C082D1100722F0200707267020070732C00000A7A0F01285600000A16FE010C082D1100727B02007072B1020070732C00000A7A735700000A0A0620E61000006F5800000A0006176F5900000A00060F01285A00000A6C0F00285A00000A6C6F5B00000A00066F5C00000A00066F5D00000A00066F5E00000A0BDE062600140BDE0000072A0000000110000000000100878800062E00000113300600950000000E000011000F02281700000A0A0F00281800000A0F01281800000A1200281900000A6C140F02281A00000A731D0000060B0720007701006A6F3100000600283400000A13051205281700000A0C0F02283500000A733600000A1305120506283700000A130512050806283800000A283900000A0D076F2E00000613061206230000000000002EC0281B00000A06731C00000A13042B0011042A00000013300300720000000B000011000F01282300000A16FE010B072D0C0072AF010070734700000A7A0F01282300000A16FE010B072D0C0072E7010070734700000A7A0F00282300000A16FE010B072D0A0014284F00000A0A2B23000F00282600000A0F01282600000A0F02282600000A2846000006732000000A0A2B00062A00001B300300850100000F00001100000F00285600000A16FE01130711072D110072C30200707211030070732C00000A7A0F01285600000A16FE01130711072D110072370300707283030070732C00000A7A0F02285600000A16FE01130711072D110072A703007072F7030070732C00000A7A0F03285600000A16FE01130711072D1100721F040070726D040070732C00000A7A0F00285A00000A6C0A0F01285A00000A6C0B0F02285A00000A6C0C0F03285A00000A6C0D735700000A1304110420E61000006F5800000A00060833090709FE0116FE012B0117130711072D17001104176F5900000A00110407066F5B00000A00002B7206082E090709FE0116FE012B0116130711072D21001104186F5900000A00110407066F5B00000A00110409086F5F00000A00002B3D001104196F5900000A00110407086F5B00000A00110407066F5F00000A00110409066F5F00000A00110409086F5F00000A00110407086F5F00000A000011046F5C00000A0011046F5D00000A0011046F5E00000A130511051306DE072600141306DE000011062A000000411C00000000000001000000790100007A010000070000002E0000011E02286000000A2A1B3005005801000010000011000E056F6100000A0A061A6F6200000A0006037293040070282F00000A6F6300000A00066F6400000A72FF040070048C3D0000016F6500000A26066F6400000A721D050070058C3F0000016F6500000A26140B06176F6600000A0C0038AA000000000714FE0116FE01130511052D24000E0414FE0116FE01130511052D0A0073770000060B002B0A000E0473780000060B00000872390500706F6700000A74310000011620AC0000006F5400000A0D0872530500706F6700000A74310000017267050070282A00000A16FE01130511052D0C0007096F7B00000600002B2500070908726B0500706F6700000A74310000011620AC0000006F5400000A6F7A000006000016286800000A0000086F6900000A130511053A47FFFFFF086F6A00000A0000DE120814FE01130511052D07086F2B00000A00DC000714FE0116FE01130511052D06001413042B0B00076F7C00000613042B0011042A0110000002005B00C9240112000000001E02286000000A2A133003001F00000011000011000304736B00000A0A06056F6C00000A00026F6400000A066F6D00000A262A00133003002C0000001100001100031F1D736B00000A0A0672870500706F6E00000A0006046F6C00000A00026F6400000A066F6D00000A262A13300400260000001100001100031F0C046F2900000A736F00000A0A06046F6C00000A00026F6400000A066F6D00000A262A00000330030070000000000000000220E0A501006A7D0100000402286000000A0000022300000000000000007D03000004022300000000000000007D020000040223000000000000F03F7D0400000402287000000A7D0500000402287100000A027C05000004287200000A6F7300000A7D0600000402282200000600002A0330020045000000000000000220E0A501006A7D0100000402286000000A000002037D0300000402047D0200000402057D0400000402287000000A7D05000004020E047D0600000402282200000600002A0000000330020042000000000000000220E0A501006A7D0100000402286000000A000002037D0300000402047D0200000402057D04000004020E047D06000004020E057D0500000402282200000600002A0000133002001B000000120000110023182D4454FB210940025A2300000000008066405B0A2B00062A00133002001B0000001200001100230000000000806640025A23182D4454FB2109405B0A2B00062A00133003002C00000013000011002B07020403595810000203FE040B072DF12B07020403595910000204FE0516FE010B072DEE020A2B00062A13300400D40200001400001100027C05000004287400000A0A027B02000004230000000000002E405B0B0316FE0116FE01130F110F2D1B066C23000000000000184007592300000000000038405B580C2B19066C23000000000000324007592300000000000038405B580C23D200DE02098AEF3F085A231D5A643BDF4F0A40590D09230E2DB29DEFA7FE3F09281E000006287500000A5A58237B14AE47E17A943F230000000000000040095A281E000006287500000A5A5823A01A2FDD24AA714058130411042300000000000000002300000000008076402820000006130423CC0BB08F4E5DED3F1104281E000006287600000A5A287700000A281F000006130511052300000000000000002300000000008076402820000006130511042300000000008056405B287800000A2300000000008056405A130611052300000000008056405B287800000A2300000000008056405A1307110511061107595813051105230000000000002E405B1305234B766C04E275D93F1104281E000006287500000A5A13081108287900000A287A00000A1309027B010000046C230000000000408F405B281E000006287A00000A1108027B03000004281E000006287500000A5A591109027B03000004281E000006287A00000A5A5B130A0316FE0116FE01130F110F2D1A230000000000807640110A287B00000A281F00000659130B2B0E110A287B00000A281F000006130B110B230000000000002E405B130B110B11055823352905DD5ED2B03F085A5923B0726891ED7C1A4059130C110C0759130D110D027B0400000458130D027B0600000414FE01130F110F2D53027B05000004027B060000046F7C00000A285200000A2C1B027B05000004027B060000046F7D00000A285100000A16FE012B0117130F110F2D19110D027B060000046F7E00000A13101210287F00000A58130D110D2300000000000000002300000000000038402820000006130D110D23000000000020AC405A288000000A69130E2B00110E2A720002021628210000067D0700000402021728210000067D080000042A000000133003004E000000130000110002230000000000000000FE0416FE010B072D1C0203230000000000004E405B590423000000000020AC405B590A2B1C0203230000000000004E405B580423000000000020AC405B580A2B00062A0000133001000C0000001200001100027B020000040A2B00062A420002037D02000004022822000006002A000000133001000C0000001200001100027B030000040A2B00062A420002037D03000004022822000006002A000000133001000C0000001500001100027B050000040A2B00062A420002037D05000004022822000006002A000000133001000C0000001200001100027B040000040A2B00062A420002037D04000004022822000006002A000000133001000C0000001600001100027B070000040A2B00062A133001000C0000001600001100027B080000040A2B00062A13300200200000001700001100027C05000004288100000A0B1201027B070000046C288200000A0A2B00062A13300200200000001700001100027C05000004288100000A0B1201027B080000046C288200000A0A2B00062A133001000C0000001800001100027B010000040A2B00062A420002037D01000004022822000006002A000000133001000C0000001900001100027B060000040A2B00062A420002037D06000004022822000006002A000000133001000B0000001A000011027B110000040A2B00062A2202037D110000042A133001000B0000001A000011027B120000040A2B00062A2202037D120000042A133001000B00000016000011027B130000040A2B00062A2202037D130000042A133001000B0000001A000011027B140000040A2B00062A2202037D140000042A133001000B00000012000011027B150000040A2B00062A2202037D150000042A133001000B0000001B000011027B160000040A2B00062A2202037D160000042A133001000B0000001C000011027B170000040A2B00062A2202037D170000042A133001000B0000001D000011007E180000040A2B00062A00133001000B0000001D000011007E190000040A2B00062A00133001000B0000001D000011007E1A0000040A2B00062A0013300300120000001D000011000203722702007028460000060A2B00062A000013300400BD0000001E00001100040A02285E000006100002285B0000061000026F2900000A15FE01130411043A9200000000027E18000004282F00000A1000020328600000060B0715FE01130411042D7100027E19000004076F8500000A0B0715FE01130411042D5800027E180000040717586F8500000A0C0815FE01130411042D22000207175808075917596F8600000A285F000006285D000006285A0000060A002B1B00020717586F8700000A285F000006285D000006285A0000060A00000000060D2B00092A00000013300400790000001F00001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B0117130511052D35000620FF010000288A00000A1202288B00000A0D0916FE01130511052D0B0008288C00000A0B002B090006288D00000A0B00002B0400040B000713042B0011042A000000133002004B0000002000001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B01170D092D0B0006288E00000A0B002B0400040B00070C2B00082A00133002004B0000002100001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B01170D092D0B0006288F00000A0B002B0400040B00070C2B00082A00133002004B0000002200001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B01170D092D0B0006289000000A0B002B0400040B00070C2B00082A00133002004B0000002300001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B01170D092D0B0006289100000A0B002B0400040B00070C2B00082A00133002004B0000002400001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B01170D092D0B0006284E00000A0B002B0400040B00070C2B00082A00133003007B0000002300001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B01170D092D3B000516FE010D092D2400020328450000060A06729B0500707E1C0000046F9200000A0A06289100000A0B002B0B00020304284B0000060B00002B0400040B00070C2B00082A00133003007B0000002400001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B01170D092D3B000516FE010D092D2400020328450000060A06729B0500707E1C0000046F9200000A0A06284E00000A0B002B0B00020304284C0000060B00002B0400040B00070C2B00082A00133003007B0000002200001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B01170D092D3B000516FE010D092D2400020328450000060A06729B0500707E1C0000046F9200000A0A06289000000A0B002B0B00020304284A0000060B00002B0400040B00070C2B00082A00133002004B0000002500001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B01170D092D0B0006289300000A0B002B0400040B00070C2B00082A00133002004B0000002600001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B01170D092D0B0006289400000A0B002B0400040B00070C2B00082A00133002004B0000002700001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B01170D092D0B0006289500000A0B002B0400040B00070C2B00082A00133002004B0000002800001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B01170D092D0B0006289600000A0B002B0400040B00070C2B00082A00133002004B0000002900001100020328450000060A067E8800000A288900000A2C1B067227020070288900000A2C0E066F2900000A16FE0216FE012B01170D092D0B0006289700000A0B002B0400040B00070C2B00082A001B3003009F0000002A0000110000037E180000046F9800000A153313037E190000046F9800000A15FE0116FE012B01170C082D6200020A02285B0000061000020328560000060A046F2900000A16FE0216FE010C082D3C0004285C00000610021C8D310000010D091606A2091703A209187E19000004A2091904A2091A729F050070A2091B7E18000004A209289900000A0A00002B0400020A0000DE072600020A00DE0000060B2B00072A00011000000000010090910007010000011B300400020100001E000011000072270200700A02285E000006100002285B0000061000026F2900000A16FE0216FE01130411043ABF00000000027E18000004282F00000A1000020328600000060B0715FE01130411043A9700000000027E180000040717586F8500000A0C0815FE01130411042D54000716FE0216FE01130411042D0D000216076F8600000A0A002B080072270200700A0008026F2900000AFE0416FE01130411042D140006020817586F8700000A282F00000A0A002B080072270200700A00002B26000716FE0216FE01130411042D0F0002160717596F8600000A0A002B080072270200700A0000002B0400020A000000DE072600020A00DE000006285F0000060D2B00092A00000110000000000100EEEF000701000001133003007A0000002B0000110072270200700C02285E000006100002285B0000061000027E180000046F9A00000A6F9B00000A0A000613051613062B2E110511069A0D00097E190000046F9A00000A6F9B00000A0B0807169A7E18000004289C00000A0C00110617581306110611058E69FE04130711072DC408285B00000613042B0011042A0000133002001C0000002C0000110072A3050070289D00000A0A06026F9E00000A00066F9F00000A002A13300500C70000002D00001100140A140B140C166A0D026F2900000A16FE0116FE01130611062D0F00161673A000000A130538990000000002285E000006100002285B0000061000027E180000046F9A00000A6F9B00000A0B078E691873A000000A0C000713071613082B51110711089A13040011047E190000046F9A00000A6F9B00000A0A0809D4166AD406169A28A100000A0809D4176AD406179A285F000006285D000006285A00000628A100000A09176A580D00110817581308110811078E69FE04130611062DA10813052B0011052A00133004004B0000002E00001100026F2900000A16FE0216FE010B072D340002026F2900000A17596F8700000A729F050070282A00000A16FE010B072D13000216026F2900000A17596F8600000A10000000020A2B00062A00133002002B0000002E00001100026F2900000A16FE0216FE010B072D1400027E180000046F9A00000A6F5000000A100000020A2B00062A0013300400510000002E00001100026F2900000A16FE0216FE010B072D3A00027E190000047E1A0000047E19000004282F00000A6F9200000A1000027E180000047E1A0000047E18000004282F00000A6F9200000A100000020A2B00062A00000013300300510000002E00001100026F2900000A16FE0216FE010B072D3A00027E1A0000047E19000004282F00000A7E190000046F9200000A1000027E1A0000047E18000004282F00000A7E180000046F9200000A100000020A2B00062A00000013300300A10000002F000011001628A200000A0D1203284C00000A1628A200000A0D1203284C00000A282F00000A0A20FF00000028A200000A0D1203284C00000A20FF00000028A200000A0D1203284C00000A282F00000A0B026F2900000A16FE0216FE01130411042D3C00027E1A0000047E19000004282F00000A066FA300000A6F9200000A1000027E1A0000047E18000004282F00000A076FA300000A6F9200000A100000020C2B00082A00000013300400970000002F000011001628A200000A0D1203284C00000A1628A200000A0D1203284C00000A282F00000A0A20FF00000028A200000A0D1203284C00000A20FF00000028A200000A0D1203284C00000A282F00000A0B026F2900000A16FE0216FE01130411042D320002067E1A0000047E19000004282F00000A6F9200000A100002077E1A0000047E18000004282F00000A6F9200000A100000020C2B00082A00133003007B0000003000001100160A026F2900000A16310E036F2900000A16FE0216FE012B01170D092D5600160B0002037E19000004282F00000A076F8500000A0A0617FE0416FE010D092D03002B300002061759176F8600000A7E18000004282A00000A16FE010D092D03002B11000617580B000615FE0116FE010D092DAE00060C2B00082AF672C5050070801800000472C9050070801900000472CD050070801A000004288A00000A6FA400000A801B000004288A00000A6FA500000A801C0000042A1E02286000000A2A2A02286000000A0000002A0B300200210000000000000002286000000A0000000203286A0000060000DE0A00036FA700000A0000DC00002A00000001100000020008000C14000A00000000133002004E0000003100001100027B1E00000414FE0116FE010B072D0C0072D105007073A800000A7A027B1E000004036FA900000A16FE010B072D1000027B1E000004036FAA00000A0A2B0C0072D105007073AB00000A7A062A000013300300540000001B00001100027B1E00000414FE0116FE010A062D0D000273AC00000A7D1E00000400027B1E000004036FA900000A16FE010A062D1200027B1E00000403046FAD00000A00002B1000027B1E00000403046FAE00000A00002A133002002F0000001B00001100027B1E0000042C11027B1E000004036FA900000A16FE012B01170A062D0F00027B1E000004036FAF00000A26002A001B300200A7000000320000110072270200700A027B1E00000414FE01130611063A860000000073B000000A0B0073B100000A0C08176FB200000A00070828B300000A0D000209286B0000060000DE120914FE01130611062D07096F2B00000A00DC0007166A6FB400000A000773B500000A13040011046FB600000A0A00DE14110414FE01130611062D0811046F2B00000A00DC0000DE120714FE01130611062D07076F2B00000A00DC00000613052B0011052A0001280000020037000C43001200000000020067000C73001400000000020020006B8B0012000000001E0073B700000A7A13300300B901000033000011000273AC00000A7D1E0000043898010000000372E50500706FB800000A16FE01130911093A7F01000000160A160B160C160D171304161305036FB900000A16FE01130911093AD90000000000036FBA00000A130A110A39B7000000110A72F5050070282A00000A2D48110A72FB050070282A00000A2D48110A720D060070282A00000A2D48110A7221060070282A00000A2D48110A7233060070282A00000A2D48110A7245060070282A00000A2D542B61036FBB00000A288E00000A0A2B53036FBB00000A288E00000A0B2B45036FBB00000A289300000A0C2B37036FBB00000A288E00000A0D2B29036FBB00000A724F060070282A00000A2D03172B011613042B0F036FBB00000A288E00000A13052B0000036FBC00000A130911093A29FFFFFF00036FBD00000A26036FBE00000A26036FBB00000A284E00000A13061208FE1509000002120807283700000600120808283900000600120809283B0000060012081106283D0000060012081104283F0000060011081307110516FE0216FE01130911092D11001207110573BF00000A28410000060000027B1E0000040611076FAE00000A000000036FBE00000A130911093A59FEFFFF2A0000001B300300D2010000340000110003725306007072270200706FC000000A0000027B1E0000046FC100000A0C3884010000120228C200000A0A000372E505007072270200706FC000000A000372F505007072270200706FC300000A0003120028C400000A6FC500000A00036FC600000A000372FB05007072270200706FC300000A0003120028C700000A0D120328360000066FC500000A00036FC600000A0003720D06007072270200706FC300000A0003120028C700000A0D120328380000066FC500000A00036FC600000A0003722106007072270200706FC300000A0003120028C700000A0D1203283A0000066FC500000A00036FC600000A0003723306007072270200706FC300000A00120028C700000A0D1203283E0000062D03162B01170B03076FC500000A00036FC600000A00120028C700000A0D120328400000061304120428C800000A16FE01130511052D450003724506007072270200706FC300000A0003120028C700000A0D120328400000061304120428C800000A2D03162B07120428C900000A6FC500000A00036FC600000A000003120028C700000A0D1203283C0000066FCA00000A00036FCB00000A0000120228CC00000A130511053A6CFEFFFFDE0F1202FE160400001B6F2B00000A00DC00036FCB00000A002A0000411C0000020000001F0000009B010000BA0100000F00000000000000133001000B00000012000011027B1F0000040A2B00062A2202037D1F0000042A133001000B00000012000011027B200000040A2B00062A2202037D200000042A13300300260000001D00001100726506007002286C0000068C3800000102286E0000068C3800000128CD00000A0A2B00062A00001B300400DA000000350000110073CE00000A0A7201000070732400000A0B00076F6100000A0C081A6F6200000A0008027275060070282F00000A6F6300000A00086F6400000A72B7060070038C3F00000173CF00000A6F6D00000A26076F2500000A0008176F6600000A0D002B3300061204FE150C000002120409166FD000000A6C286D00000600120409176FD000000A6C286F0000060011046FD100000A0000096F6900000A130611062DC100DE120914FE01130611062D07096F2B00000A00DC0000DE120714FE01130611062D07076F2B00000A00DC00066FD200000A13052B0011052A0000011C000002005F0045A400120000000002001200A8BA0012000000001B300400540100003600001100140A022C0B028E6916FE0216FE012B0117130611063A3101000000140B0319330B028E6917FE0216FE012B0117130611063AA3000000000228750000060C0815FE0116FE01130611062D3400028E6917590D2B1B0003120102098F0C000002710C000002287300000600000917590D0916FE0416FE01130611062DD8002B570817FE0116FE01130611062D3E00000213071613082B23110711088F0C000002710C000002130400031201110428730000060000110817581308110811078E69FE04130611062DCF002B0C0072CF06007073AB00000A7A002B3C00000213071613082B23110711088F0C000002710C000002130400031201110428730000060000110817581308110811078E69FE04130611062DCF00076F5C00000A00076F5D00000A0000076F5E00000A0A00DE1B26000319FE0116FE01130611062D09000228740000060A0000DE0000000613052B0011052A01100000000024010B2F011B3300000113300300770000001B00001100035014FE0116FE010A062D510003735700000A51035020E61000006F5800000A000218FE0116FE010A062D0D000350186F5900000A00002B0B000350196F5900000A000003500F02286E0000060F02286C0000066F5B00000A00002B180003500F02286E0000060F02286C0000066F5F00000A00002A0013300300BF0000003700001100140A000213061613072B6E110611078F0C000002710C0000020B000614FE0116FE01130811082D330073D300000A0A0620E61000006FD400000A0006196FD500000A00061201286C0000061201286E0000066FD600000A00002B1700061201286C0000061201286E0000066FD700000A000000110717581307110711068E69FE04130811082D84066FD800000A00066FD900000A00066FDA00000A0C086FDB00000A0D096FDC00000A20E610000028DD00000A1304110413052B0011052A00133004000501000038000011002300000000000000000A028E6917590B0719FE0416FE01130611062D0C00722107007073DE00000A7A02168F0C000002286C00000602078F0C000002286C000006331C02168F0C000002286E00000602078F0C000002286E000006FE012B0116130611062D0C00726307007073DE00000A7A160C2B450002088F0C000002710C0000020D020817588F0C000002710C0000021304061204286C0000061203286C000006591203286E0000061204286E000006585A580A000817580C0807FE04130611062DB106230000000000000000FE0416FE01130611062D06001713052B2106230000000000000000FE0216FE01130611062D06001513052B06001613052B0011052A1E02286000000A2A2A02286000000A0000002A0B300200210000000000000002286000000A0000000203287E0000060000DE0A00036FA700000A0000DC00002A00000001100000020008000C14000A0000000013300200400000002E00001100027B2600000414FE0116FE010B072D0500140A2B28027B26000004036FDF00000A16FE010B072D1000027B26000004036FE000000A0A2B0500140A2B00062A13300300540000001B00001100027B2600000414FE0116FE010A062D0D000273E100000A7D2600000400027B26000004036FDF00000A16FE010A062D1200027B2600000403046FE200000A00002B1000027B2600000403046FE300000A00002A133002002F0000001B00001100027B260000042C11027B26000004036FDF00000A16FE012B01170A062D0F00027B26000004036FE400000A26002A001B300200A7000000320000110072270200700A027B2600000414FE01130611063A860000000073B000000A0B0073B100000A0C08176FB200000A00070828B300000A0D000209287F0000060000DE120914FE01130611062D07096F2B00000A00DC0007166A6FB400000A000773B500000A13040011046FB600000A0A00DE14110414FE01130611062D0811046F2B00000A00DC0000DE120714FE01130611062D07076F2B00000A00DC00000613052B0011052A0001280000020037000C43001200000000020067000C73001400000000020020006B8B0012000000001E0073B700000A7A133003006000000039000011000273E100000A7D260000042B47000372A90700706FB800000A16FE010C082D3300036FB900000A26036FBB00000A0A036FBD00000A26036FE500000A0B036FE600000A00027B2600000406076FE300000A000000036FBE00000A0C082DAF2A1B3003009C0000003A000011000372BB07007072270200706FC000000A0000027B260000046FE700000A0B2B56120128E800000A0A000372A907007072270200706FC000000A000372D107007072270200706FC300000A0003120028E900000A6FEA00000A00036FC600000A0003120028EB00000A6FEA00000A00036FCB00000A0000120128EC00000A0C082D9FDE0F1201FE160800001B6F2B00000A00DC00036FCB00000A002A0110000002001F006584000F000000001B300300040200003B000011000E056F6100000A0A061A6F6200000A00060372DB070070282F00000A6F6300000A00066F6400000A72FF040070048C3D0000016F6500000A26066F6400000A7235080070058C3F0000016F6500000A26140B061F116F6600000A0C003855010000000714FE0116FE01130711072D24000E0414FE0116FE01130711072D0A0073630000060B002B0A000E0473640000060B000008724F0800706F6700000AA54E0000010D0872530500706F6700000A7431000001130411047267050070282A00000A16FE01130711072D0F0007096F67000006000038DB000000001205FE150900000212050872630800706F6700000AA54E00000128370000060012050872750800706F6700000AA53F000001283900000600120508728F0800706F6700000AA54E000001283B0000060012050872A10800706F6700000AA538000001283D0000060012050872BF0800706F6700000AA568000001283F00000600080872D10800706FED00000A6FEE00000A16FE01130711072D160012051208FE150300001B1108284100000600002B1F0012050872D10800706F6700000AA54E00000173BF00000A28410000060000070911056F66000006000000086F6900000A130711073A9CFEFFFF086F6A00000A0000DE120814FE01130711072D07086F2B00000A00DC000714FE0116FE01130711072D06001413062B0B00076F6800000613062B0011062A411C0000020000005C00000074010000D001000012000000000000001E02286000000A2A13300600BC0100003C00001100027227020070282A00000A16FE01130911092D090028F000000A10000072EB0800700273F100000A0A1B8D6C000001130A110A1672030900701F0C20000100006A73F200000AA2110A17720F0900701F1620000100006A73F200000AA2110A1872250900701F1620000100006A73F200000AA2110A19723D0900701F1620000100006A73F200000AA2110A1A72550900701F161C6A73F200000AA2110A73F300000A0B28F400000A076FF500000A0000066FF600000A130B16130C38DE000000110B110C9A0C0072EB0800707277090070080273F700000A0D72EB0800707291090070080273F700000A1304096FF800000A130511046FF800000A22000080445B13061106220000C8425A11055B1307110711065913080872AF090070288900000A16FE01130911092D6C00071608284F00000A6FF900000A000717120728FA00000A284F00000A6FF900000A000718120828FA00000A284F00000A6FF900000A000719120628FA00000A284F00000A6FF900000A00071A120528FA00000A284F00000A6FF900000A0028F400000A076FFB00000A000000110C1758130C110C110B8E69FE04130911093A11FFFFFF28F400000A6FFC00000A002A1E02286000000A2A42534A4201000100000000000C00000076322E302E35303732370000000005006C000000E41A0000237E0000501B00006419000023537472696E677300000000B4340000C009000023555300743E0000100000002347554944000000843E0000980A000023426C6F620000000000000002000001571FA2090902000000FA2533001600000100000070000000110000002600000083000000C300000002000000FC0000000B000000390000003C000000060000001A0000002B0000000900000001000000050000000200000000000A0001000000000006003B0134010600420134010600540134010600590134010A0087016E010E00B20198011200E001CB011200EA01CB0106000202340112001102CB0112002902CB0112003302CB0112003C02CB011200D802CB0112001703CB010600A10334010600AE0334010A00D20363011200F203DC0312001504DC0312002004BF010600840434010600A704920406003D07340106000C0934010600FA09DF090A00460A340A0A00620A63010E00EF0A98010E00130B98010600E90DD70D0600000ED70D06001D0ED70D06003C0ED70D0600550ED70D06006E0ED70D0600890ED70D0600A40ED70D0600DC0EBD0E0600F00ED70D06001C0F090FA700300F000006005F0F3F0F06007F0F3F0F1200B80F9D0F06000E10340106001810340112007310601006008B10340106009D1034010600B11034010600C310340106008E11340106009E1134011600D711B8110600DD1134010600EE11340112006912601012007312BF0112009F12DC030600C51234011200CB12DC030600E51234011200EB12DC031200F912BF0112001713BF0106003413231312004113BF011200521360100600781334010600BF13340106002114BD0E06003714BD0E060042143F0F0600831492040600A41492040600B11434010600D41434010600D91434010600DF1434010600E61434010600ED1434010600F3143401060016150C1506001B150C15060033150C1506008E15D70D0600A51534010600C71534010600EA150C150A00F71563010A000916630106002F160C1506004A160C15060057160C1506006C1634016B00E51600000600FE16DF0906008A17DF090E00A21798010E00B51798010E00E317980112001118CB01060059183401120075189D0F06008B1834011600A718090F1200C2189D0F1200CE189D0F1200DC189D0F1200E7189D0F16001A19090F000000000100000000000100010001001000220000000500010001000001000037004C000900010012000000100060004C000500010016008001100075004C00050001001800010010007C008400050001001B00020100008B0000000D000900340005010000970000000D000E00340009011000A1004C0011001100340001001000AE00B40005001800420001001000C5004C0005001D00630008011000D300000011001F006C0000010000DB0000000D002100710000001000EB00000005002500710001001000F6004C000500250077000000100007014C00050027008000010010001A01000005002700820001006004E60001006704EA0001007104EA0001007A04EA0001008D04ED000100B404F1000100C404F5000100D004F50006064F06630156805706E60056806006E60056806606E60056806F06E60006064F06F50056807C068A01568084068A0101006A07C00101008507C00101009F07F5000100BD07C0010100D707EA000100F707C30101001108C60131007D08DD0131008D08DD0131009E08DD013100AB08DD013100BB08DD015180DC09DD010100070A79020100890AEA000100A40AEA0006064F06F5005680BE0AAE025680C60AAE025680D00AAE025180DC09DD0101005D0BE402D020000000009600F3011300010048210000000096001B021E000400B0210000000096004302290007002823000000009600670236000B004424000000009600930236000D00DC24000000009600BC023F000F008426000000009600E1024C001300442A000000009600F60259001700342B0000000096000B0364001A00842B00000000960022036B001B00342C000000009600310364001E00702C000000009600440376001F00F42C000000009600560381002200A42D00000000960064031E002400482E00000000960073038A002700C82E000000009600820395002A0078300000000086189403A2002E0000000000030086189403A6002E00000000000300C6019A03AC003000000000000300C601BC03B1003100000000000300C601C803BA00340080300000000083000004C0003500F4310000000086189403A2003A00FC310000000093002A04CB003A0028320000000093003704D5003E0060320000000093004D04DE00410094320000000086189403A200440010330000000086189403F80044006433000000008618940301014800B433000000009100DB040C014D00DC33000000009100E3040C014E000434000000009100EB0411014F003C34000000008100F404180152001C37000000008100FE04A20053003C37000000009600050511015300983700000000860814051E015600B037000000008608220522015600C43700000000860830051E015700DC370000000086083D0522015700F0370000000086084A0527015800083800000000860853052C0158001C380000000086085C051E01590034380000000086086A05220159004838000000008608780532015A006038000000008608880532015A007838000000008608970527015A00A438000000008608A40527015A00D038000000008608B00536015A00E838000000008608BB053B015A00FC38000000008608C60541015B001439000000008608DA0546015B0028390000000086088B0698015C003F3900000000860899069C015C004839000000008608A70698015D005F39000000008608B4069C015D006839000000008608C10632015E007F39000000008608D206A1015E008839000000008608E30698015F009F39000000008608F0069C015F00A839000000008608FD061E016000BF39000000008608100722016000C8390000000086082307A6016100DF390000000086083007AA016100E8390000000086084807AF016200FF390000000086085907B7016200083A000000009608CD08E0016300203A000000009608E008E0016300383A000000009608F408E0016300503A0000000096000409E4016300703A0000000096000409EA0165003C3B0000000096000409F1016800C43B0000000096000409F8016B001C3C0000000096000409FF016E00743C000000009600040906027100CC3C00000000960004090D027400243D0000000096000409160277007C3D00000000960004091D027A00043E000000009600040927027E008C3E00000000960004092F028200143F0000000096000409370286006C3F00000000960004093E028900C43F000000009600040945028C001C4000000000960004094C028F007440000000009600040953029200CC400000000096001409EA01950088410000000096001C09E4019800A84200000000960027095A029A00304300000000910033095F029B0058430000000096003D0964029C002C4400000000910048095A029D00844400000000910058095A029E00BC4400000000910077095A029F001C450000000091007E095A02A0007C4500000000910087095A02A1002C4600000000910095095A02A200D046000000009100A4096F02A30095470000000086189403A200A500574700000000911853150B08A5009D470000000086189403A200A500A84700000000861894038202A500E847000000008608110A8802A60044480000000086081A0A8E02A700A448000000008600230A9C01A900E0480000000083082A0A9502AA00BC4900000000E601500A9902AA00C44900000000E6015A0A8202AA008C4B00000000E6016C0A9E02AB00884D00000000830814051E01AC009F4D00000000830822052201AC00A84D00000000830830051E01AD00BF4D0000000083083D052201AD00C84D00000000C600800A9502AE00FC4D000000009300E10AB702AE00004F000000009300040BBF02B0007050000000009100270BC902B200F450000000009100320BD402B500C0510000000093004A0BDC02B600D1520000000086189403A200B700D9520000000086189403A200B700E45200000000861894038202B7002453000000008608110AEC02B80070530000000086081A0AF102B900D053000000008600230AAC00BB000C540000000083082A0A9502BC00E85400000000E601500A9902BC00F05400000000E6015A0A8202BC005C5500000000E6016C0A9E02BD001456000000008300690BC000BE0040580000000086189403A200C3004858000000009600800B5F02C300105A0000000086189403A200C40000000100EE0500000200F805000003008F0B00000100710400000200670400000300960B00000100A00B00000200AB0B00000300B90B00000400C60B00000100D90B00000200E60B00000100D90B00000200E60B00000100A00B00000200AB0B00000300F10B00000400FD0B000001007104000002006704000003000E0C00000400240C00000100380C00000200460C000003004E0C000001005B0C00000100710400000200670400000300960B00000100610C00000100380C00000200460C000003004E0C00000100670400000200710400000100710400000200670400000300960B00000100380C00000200460C000003004E0C000001006D0C00000200800C00000300920C00000400A60C00000100B90C00000200C00C00000100C70C00000100C70C00000200CC0C00000300B90C00000100D50C00000100A00B00000200AB0B00000300B90B00000400C60B00000500DC0C00000100E10C00000200E90C00000300F70C00000400050D00000100E10C00000200E90C00000300050D00000100E10C00000200E90C00000300050D000001007104000002006704000003007A0400000400B404000001007104000002006704000003007A0400000400B404000005008D04000001000B0D000001000B0D00000100050D00000200110D00000300150D00000100190D00000100230D000002002B0D00000300330D00000100050D00000100050D00000100050D00000100050D00000100050D00000100050D00000100050D00000100050D00000100050D00000100050D00000100050D00000100050D00000100050D000001003B0D00000200490D000001003B0D00000200490D000003004E0C000001003B0D00000200490D000003004E0C000001003B0D00000200490D000003004E0C000001003B0D00000200490D000003004E0C000001003B0D00000200490D000003004E0C000001003B0D00000200490D000003004E0C000001003B0D00000200490D000003004E0C000001003B0D00000200490D000003004E0C00000400520D000001003B0D00000200490D000003004E0C00000400520D000001003B0D00000200490D000003004E0C00000400520D000001003B0D00000200490D000003004E0C000001003B0D00000200490D000003004E0C000001003B0D00000200490D000003004E0C000001003B0D00000200490D000003004E0C000001003B0D00000200490D000003004E0C000001003B0D00000200490D000003005C0D000001003B0D00000200490D000001003B0D00000100660D00000100720D00000100770D00000100770D00000100770D00000100770D00000100770D00000100770D000001003B0D00000200490D00000100790D00000100820D00000100820D00000200050D00000100820D000001008C0D00000100930D00000100050D00000100050D00000100A00B00000200E60B000001009A0D00000200A10D00000100A10D00000200AD0D00000300B30D000001009A0D000001009A0D00000100B80D00000100C30D00000100C30D00000200050D00000100C30D000001008C0D00000100930D00000100A00B00000200AB0B00000300F10B00000400FD0B00000500DC0C00000100CC0D0B0015000F001500F9009403AC0001019403AC0009019403AC0011019403AC0019019403AC0021019403AC0029019403AC0031019403AC0039019403AA0141019403AC0049019403FC0259019403A10161019403A20069019403A2004100CD0FA6017900D80FA5037900E40FAB034100D80FB1034100EC0FB7037900F80FC00341002A0A320131000510C90349002110D70351002A0A1E0179012C103201490036102701B1004310DD0349009403E30359004E1089046900CD0FA60169002A0A950259009403AC00690053108D046100CD0FA6015900CD0FA60199009403AC0081018010A20059002A0A950261002A0A920481018510A2008901921032018901EC0F96049101A910A20099019403F102A101C910AC048901D010CE048901D710E4017101DE1095024900EA10E7044900F010ED0471004E10F5044900FC10F90449004A052701490094032C0149000411FE0479010D11060549001C11FE04B1002011D70349002E11120549000D11180549003611ED0449004911ED044900EC0FED04490058112205790160113201790169112A05790173112E0579017D111E01A901961135057100D80F3A05B1019403AC00510094032201B9019403AC00C101800A95028901E4117A05C901800A9502B901F3117F05C101EA1085055900D80F97058901FB119D05B100F010AC05B1004911AC0579009403AA018901F311C10541009403A1013900CD0FA601F1009403A200F1000012A101F1000812D30539002A0AD905F1001712DD05F1002312A200F1002D12A200F1003A12E305F1005312DD0509009403A20099005B121106D1017F121606D1018F12AC00A100B6121D06E101D8122306A10009132B061102110A340619023B13390621024D13A60121028510A200F10194034B0629025E135206E1011C115706F1016813AC00F10194036606B100FC106E06310281137306B1009513320131029E137906B100B11332013902C4130C013902C8130C013902CC130C013902D1130C013902D7130C013902DC130C013902E0130C01B900E5132701B900EF132701B900F713D703790101141E01390210140C01B1004A052701B1001614DD0341029403B80651029403A20089015D14D30689016514D90689016514DF0689016F14DD0189017514960459029414EC06C101C114F206A901CA14FF06A901CA1404077102EA1012077902EA101E078102EA102A07C900EA1036078901F3117F05F901EA104C078902EA1058079102EA106407E901EA1070079902EA107C0789015D1488078901D7108D078901FA149B0789010615A0078901D710EA01A1022815B507B1023E15AC00B1028510A2000C009403CA070C004815D007A9014C15F7070900800A950259025A159502590273159502B9029403AC0091008510A200C1029403AC001400BB1521081400110A2708C9029403AC0014009403A20014001A0A340814001C1134081400E3152108D1029403A200D9029403A200D9021A163C08E10036164308E9023D164E08F10294035308F9026216950201039403A200910084166B0891009316A6019100A816950291002A0A95029100B116A6019100C516A60191004D13A6011C0094037608E100D316F1021400F0168C0824000D17A108E1001917F1022C002D17B608E1003517A101E1004017A2002C002A0ABB081C005217A6011C005F17B608E10035172201E1007117A20024008117A6018901D010DC0834009403A200F1019403EB0811029117F10834001C11760834009A17F60821039403A20021030012A1012103C917260921031712DD0521035312DD0521032312A2002103D717A2002103EF172D09310307182D0931031A18330931002518390999019403AC003C00BB1521083C00110A27083C009403A2003C001A0A34083C001C1134083C00E315210891003318950291003E18A2003C00F0168C0844000D17A1084C002D17B608E1004D18AC004C002A0ABB0844008117A60111026118880711026C18950949039403A20051039718E00159039403F10261039403AF0969039403B7097103EF18BF097903F818C50959030919CC0981039403D10981032D19D90569033719D9098102800A950279034419C50979035319A2000A00280066010A002C006F010A00300078010A003400810108003C008E010800400093010E0074000000080088008E0108008C00B2020800900093010E00940000002000730093012E004B00140A2E0063006E0A2E003B00140A2E005B00650A2E006B00770A2E001B00140A2E0033003F0A2E001300140A2E000B00FC092E0023001A0A2E002B002E0A40007300930160007300F80380007300F803A0007300F803C0007300F803E00073009301000173009301200173009301400173009301600173009301630133050F08800173009301A00173009301C00173009301E00173009301E30133050F08000273009301210223049301410223049301610223049301810223049301A10223049301C10223049301E10223049301E10323049301010423049301800623049301A00623049301C00623049301E00623049301000723049301200723049301400723049301600723049301800723049301A00723049301C00723049301E00723049301000823049301200823049301800D23049301A00D23049301C00D23049301E00D2304930140107B079301CF03EC039C04B404C304D40440058A05A305B405C705CD05E805F00503063E0660067F06830688069E06A306A706AE06B306BF06C306C706CF06E4060907170723072F073C07450751075D076907750781079307A707BC07D707F207FC0704082E085A087C08C008FC081309420959096D0983099A09E0090600010009000B000A0012000B0015000C0017000F0019000000EE054C010000F8054C01000001065001000006064C0100001006550100001C06550100002706500100003006500100003806590100003F065E0100002F08CD0100003908CD0100004208550100004F08CD01000058084C0100006708D10100007008D5010000B10975020000C00975020000D00975020000750AA40200007A0AAA020000EE054C010000F8054C010000750AF70200007A0AAA0202002400030001002500030002002600050001002700050002002800070001002900070002002A00090001002B00090002002C000B0002002D000D0002002E000F0002002F001100020030001300010031001300020032001500010033001500010035001700020034001700020036001900010037001900010039001B00020038001B0002003A001D0001003B001D0001003D001F0002003C001F0001003F00210002003E002100020040002300010041002300020042002500020043002700020044002900020065002B00010066002B00020068002D0001006D002F0002006C002F0001006F00310002006E00310002007900330001007A00330002007C003500C207190870089808AD08E308660973097B09048000000100000055121B4E0100000003034C00000002000000000000000000000001002B010000000002000000000000000000000001006301000000000A00000000000000000000000A009801000000000200000000000000000000000100BF0100000000020000000000000000000000010034010000000007000600080006000000003C4D6F64756C653E004D69582E496E73696768742E53746167696E672E646C6C0055736572446566696E656446756E6374696F6E73004275696C64457863657074696F6E52657475726E004D69582E496E73696768742E53746167696E670044657669636550726F7065727479576F726B657200436F6D6D6F6E0053756E54696D650053756E4E4554005A656E69746856616C756500446972656374696F6E004576656E7454726967676572004C697374730043494465762E4C69737473546F6F6C73004576656E745472696767657273004C6F6E674C61740052696E674F7269656E746174696F6E0047656F7370617469616C0044657669636550726F70657274696573004576656E7454726967676572576F726B65720053746F72656450726F63656475726573006D73636F726C69620053797374656D004F626A656374004D756C74696361737444656C656761746500456E756D0056616C7565547970650053797374656D2E586D6C0053797374656D2E586D6C2E53657269616C697A6174696F6E0049586D6C53657269616C697A61626C65004D6963726F736F66742E53716C5365727665722E54797065730053716C47656F6772617068790053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C53696E676C650053716C496E74333200666E634275696C64436972636C65004461746554696D654F66667365740053716C446F75626C6500666E6353756E73657454696D650053716C537472696E670053716C496E7431360053716C586D6C00666E635472616E73666F726D56656869636C6544657669636550726F7065727469657300666E634275696C64506F6C79676F6E46726F6D4D61704C6F636174696F6E506F6C79676F6E506F696E747300666E634275696C644C696E6546726F6D4D61704C6F636174696F6E506F6C79676F6E506F696E747300666E635472616E73666F726D56656869636C6554726967676572730053716C496E74363400666E634E6967687454696D654475726174696F6E00666E634765744C6973744974656D446F75626C6500666E6346756C6C5472696D0053716C426F6F6C65616E00666E6349734E6967687454696D6500666E635265706C6163654E756C6C4368617200666E634765744C6973744974656D496E7400666E634275696C64506F696E7400666E6353756E7269736554696D6500666E634765744C6973744974656D00666E634275696C6452656374616E676C65002E63746F7200496E766F6B6500494173796E63526573756C74004173796E6343616C6C6261636B00426567696E496E766F6B6500456E64496E766F6B6500586D6C5265616465720053797374656D2E446174612E53716C436C69656E740053716C436F6E6E656374696F6E0050726F6365737356656869636C654465766963650053716C436F6D6D616E640053716C44625479706500416464506172616D657465720041646447656F677261706879506172616D6574657200416464537472696E67506172616D65746572007A656E697468006C6F6E676974756465006C61746974756465007574634F6666736574004461746554696D6500646174650053797374656D2E476C6F62616C697A6174696F6E004461796C6967687454696D65006461796C696768744368616E6765730073756E7269736554696D650073756E73657454696D65004465673252616400526164324465670046697856616C75650043616C63756C617465005570646174650044656772656573546F416E676C65006765745F4C6F6E676974756465007365745F4C6F6E676974756465006765745F4C61746974756465007365745F4C61746974756465006765745F44617465007365745F44617465006765745F5574634F6666736574007365745F5574634F6666736574006765745F5269736554696D65536563006765745F53657454696D65536563006765745F5269736554696D65006765745F53657454696D65006765745F5A656E697468007365745F5A656E697468006765745F4461796C696768744368616E676573007365745F4461796C696768744368616E676573004C6F6E676974756465004C617469747564650044617465005574634F6666736574005269736554696D655365630053657454696D65536563005269736554696D650053657454696D65005A656E697468004461796C696768744368616E6765730076616C75655F5F004F6666696369616C00436976696C004E6175746963616C00417374726F6E6F6D6963616C0053756E726973650053756E736574006765745F547269676765724944007365745F547269676765724944006765745F53657175656E6365007365745F53657175656E6365006765745F506172616D657465724B6579007365745F506172616D657465724B6579006765745F4F70657261746F72007365745F4F70657261746F72006765745F5468726573686F6C6456616C7565007365745F5468726573686F6C6456616C7565006765745F5265717569726564007365745F5265717569726564004E756C6C61626C656031006765745F4A6F696E4F70657261746F72007365745F4A6F696E4F70657261746F72003C5472696767657249443E6B5F5F4261636B696E674669656C64003C53657175656E63653E6B5F5F4261636B696E674669656C64003C506172616D657465724B65793E6B5F5F4261636B696E674669656C64003C4F70657261746F723E6B5F5F4261636B696E674669656C64003C5468726573686F6C6456616C75653E6B5F5F4261636B696E674669656C64003C52657175697265643E6B5F5F4261636B696E674669656C64003C4A6F696E4F70657261746F723E6B5F5F4261636B696E674669656C64005472696767657249440053657175656E636500506172616D657465724B6579004F70657261746F72005468726573686F6C6456616C7565005265717569726564004A6F696E4F70657261746F72004C495354535F534550415241544F52004C495354535F41535349474E4D454E54004C495354535F455343415045005F67726F7570536570657261746F72005F646563696D616C536570657261746F72006765745F4C69737473536570617261746F72006765745F4C6973747341737369676E6D656E74006765745F4C69737473457363617065004765744974656D00446563696D616C005365744974656D0044656C6574654974656D004765744974656D4C697374005072696E7454657874004C697374324172726179005374726970526967687453706163650053747269704C656164696E67547261696C696E67536570617261746F72730045736361706500556E4573636170650052656D6F76654573636170657300526573746F726545736361706573004974656D506F736974696F6E004C69737473536570617261746F72004C6973747341737369676E6D656E74004C69737473457363617065004E530053797374656D2E436F6C6C656374696F6E732E47656E657269630044696374696F6E6172796032005F7472696767657273006765745F4974656D007365745F4974656D0044656C657465006765745F56616C75650053797374656D2E586D6C2E536368656D6100586D6C536368656D6100476574536368656D610052656164586D6C00586D6C577269746572005772697465586D6C004974656D0056616C756500546F537472696E67003C4C6F6E6769747564653E6B5F5F4261636B696E674669656C64003C4C617469747564653E6B5F5F4261636B696E674669656C6400556E6B6E6F776E00436C6F636B7769736500436F756E746572436C6F636B776973650052657472697665506F696E7473004F70656E47697347656F67726170687954797065004275696C6447656F6772617068790053716C47656F6772617068794275696C646572004275696C64506F696E74004275696C64506F6C79676F6E56696147656F6D657472790047657452696E674F7269656E746174696F6E005F70726F706572746965730050726F6365737356656869636C655472696767657273006973705F447269766553706163650052616469757300636865636B54696D6500736368656D614E616D650076656869636C65486F7374494400646576696365486F73744944006578697374696E6750726F7065727469657300736F75726365536368656D61006C6F636174696F6E4944006576656E74486F73744944006578697374696E67547269676765727300616374697669747953746172744461746554696D65006163746976697479456E644461746554696D650064656C696D697465644C697374006B65794E616D650064656661756C7456616C756500696E707574006469727479537472696E670075707065724C6566744C6F6E6769747564650075707065724C6566744C61746974756465006C6F77657252696768744C6F6E676974756465006C6F77657252696768744C61746974756465006F626A656374006D6574686F6400746578740063616C6C6261636B00726573756C7400636F6E6E00636F6D6D616E6400706172616D657465724E616D6500706172616D65746572547970650076616C756500616E676C65006D696E006D617800646972656374696F6E0064656772656573006D696E75746573007365636F6E64730044656C696D697465644C697374004974656D4E616D6500506172736550697065004974656D56616C75650074657874546F5072696E74006C697374007300747269676765727300747269676765724944007265616465720077726974657200706F696E7473004465736972656454797065006275696C64006974656D0070726F706572746965730070726F7065727479007365727665724E616D650053797374656D2E5265666C656374696F6E00417373656D626C795469746C6541747472696275746500417373656D626C794465736372697074696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7954726164656D61726B41747472696275746500417373656D626C7943756C747572654174747269627574650053797374656D2E52756E74696D652E496E7465726F70536572766963657300436F6D56697369626C6541747472696275746500417373656D626C7956657273696F6E4174747269627574650053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E417474726962757465006765745F49734E756C6C006F705F496D706C69636974006F705F54727565006F705F457175616C697479006F705F426974776973654F7200535442756666657200457863657074696F6E0054696D655370616E006765745F4F6666736574006765745F486F757273006765745F4461746554696D65004164644D696E75746573004E756C6C004372656174655265616465720053797374656D2E446174612E436F6D6D6F6E004462436F6E6E656374696F6E004F70656E00436C6F736500537472696E67006765745F4C656E6774680049446973706F7361626C6500446973706F736500417267756D656E74457863657074696F6E00417272617900436F7079546F00466F726D617400436F6E636174006765745F4D657373616765005061727365006F705F4C6573735468616E006765745F4E6F7700546F4F6666736574006F705F5375627472616374696F6E00416464006765745F54696D654F664461790041646444617973006F705F4C6573735468616E4F72457175616C006F705F477265617465725468616E00436F6D70617265006765745F44617973006765745F5469636B730046726F6D5469636B73006765745F546F74616C5365636F6E647300436F6E7665727400546F496E74363400496E76616C69644F7065726174696F6E457863657074696F6E0053797374656D2E546578742E526567756C617245787072657373696F6E7300526567657800446F75626C65006765745F43686172730043686172005265706C616365005472696D005365745372696400426567696E47656F67726170687900426567696E46696775726500456E6446696775726500456E6447656F677261706879006765745F436F6E737472756374656447656F677261706879004164644C696E6500437265617465436F6D6D616E64004462436F6D6D616E6400436F6D6D616E6454797065007365745F436F6D6D616E6454797065007365745F436F6D6D616E64546578740053716C506172616D65746572436F6C6C656374696F6E006765745F506172616D657465727300496E7431360053716C506172616D65746572004164645769746856616C756500496E7433320053716C4461746152656164657200436F6D6D616E644265686176696F7200457865637574655265616465720049446174615265636F72640053797374656D2E546872656164696E670054687265616400536C6565700049446174615265616465720052656164004462506172616D65746572007365745F56616C7565007365745F556474547970654E616D650054696D655A6F6E65006765745F43757272656E7454696D655A6F6E65006765745F59656172004765744461796C696768744368616E676573006765745F4461794F6659656172004D6174680053696E0054616E004174616E00466C6F6F72004173696E00436F730041636F73006765745F5374617274006765745F456E64006765745F44656C7461006765745F546F74616C486F75727300526F756E64004164645365636F6E6473005374727563744C61796F7574417474726962757465004C61796F75744B696E6400436F6D70696C657247656E65726174656441747472696275746500496E6465784F6600537562737472696E6700456D707479006F705F496E657175616C697479004E756D626572466F726D6174496E666F006765745F43757272656E74496E666F004E756D6265725374796C65730049466F726D617450726F766964657200547279506172736500546F426F6F6C65616E00427974650053427974650053696E676C650055496E74333200496E7436340055496E74313600546F4368617241727261790053706C69740053797374656D2E494F0046696C650053747265616D57726974657200417070656E645465787400546578745772697465720057726974654C696E650053657400546F43686172002E6363746F72006765745F4E756D62657247726F7570536570617261746F72006765745F4E756D626572446563696D616C536570617261746F720044656661756C744D656D62657241747472696275746500417267756D656E744E756C6C457863657074696F6E00436F6E7461696E734B657900417267756D656E744F75744F6652616E6765457863657074696F6E0052656D6F7665004D656D6F727953747265616D00586D6C57726974657253657474696E677300436F6E666F726D616E63654C6576656C007365745F436F6E666F726D616E63654C6576656C0053747265616D00437265617465007365745F506F736974696F6E0053747265616D52656164657200546578745265616465720052656164546F456E64004E6F74496D706C656D656E746564457863657074696F6E0049735374617274456C656D656E74004D6F7665546F4669727374417474726962757465006765745F4E616D65004D6F7665546F4E657874417474726962757465004D6F7665546F456C656D656E740057726974655374617274456C656D656E7400456E756D657261746F7200476574456E756D657261746F72004B657956616C7565506169726032006765745F43757272656E740057726974655374617274417474726962757465006765745F4B657900577269746556616C7565005772697465456E64417474726962757465006765745F48617356616C75650047657456616C75654F7244656661756C74005772697465456E64456C656D656E74004D6F76654E657874004C697374603100476574466C6F617400546F41727261790053716C47656F6D657472794275696C646572004F70656E47697347656F6D657472795479706500426567696E47656F6D6574727900456E6447656F6D657472790053716C47656F6D65747279006765745F436F6E737472756374656447656F6D65747279004D616B6556616C69640053716C4279746573005354417342696E61727900535447656F6D46726F6D574B420052656164537472696E670052656164456E64456C656D656E74005772697465537472696E6700426F6F6C65616E004765744F7264696E616C00497344424E756C6C0053716C50726F63656475726541747472696275746500456E7669726F6E6D656E74006765745F4D616368696E654E616D6500506572666F726D616E6365436F756E74657243617465676F72790053716C4D657461446174610053716C446174615265636F72640053716C436F6E746578740053716C50697065006765745F506970650053656E64526573756C7473537461727400476574496E7374616E63654E616D657300506572666F726D616E6365436F756E746572004E65787456616C75650053657453716C537472696E670053656E64526573756C7473526F770053656E64526573756C7473456E64000000002F63006F006E007400650078007400200063006F006E006E0065006300740069006F006E003D007400720075006500001D3C00700072006F00700065007200740069006500730020002F003E0000354D0069007300730069006E006700200073006F007500720063006500200053006300680065006D00610020006E0061006D006500001973006F00750072006300650053006300680065006D00610000234D0069007300730069006E006700200073006F00750072006300650020004900440000156C006F0063006100740069006F006E004900440000153C006500780065007000740069006F006E003E0000253C0069006E007000750074003E007B0030007D003C002F0069006E007000750074003E0000193C007400720069006700670065007200730020002F003E0000433C006D006500730073006100670065003E007B0030007D003C002F006D006500730073006100670065003E003C002F006500780065007000740069006F006E003E00003B300031002F00300031002F0031003900380030002000300030003A00300030003A0030003000200041004D0020002B00300030003A003000300000376B006500790020006900730020006100200072006500710075006900720065006400200070006100720061006D006500740065007200003F640065006600610075006C00740020006900730020006100200072006500710075006900720065006400200070006100720061006D006500740065007200000100055C007C0000374C006F006E00670069007400750064006500200070006100720061006D00650074006500720020006D0069007300730069006E00670000136C006F006E0067006900740075006400650000354C006100740069007400750064006500200070006100720061006D00650074006500720020006D0069007300730069006E00670000116C006100740069007400750064006500004D5500700070006500720020006C0065006600740020006C006F006E00670069007400750064006500200070006100720061006D00650074006500720020006D0069007300730069006E0067000025750070007000650072004C006500660074004C006F006E00670069007400750064006500004B5500700070006500720020006C0065006600740020006C006100740069007400750064006500200070006100720061006D00650074006500720020006D0069007300730069006E0067000023750070007000650072004C006500660074004C006100740069007400750064006500004F4C006F0077006500720020007200690067006800740020006C006F006E00670069007400750064006500200070006100720061006D00650074006500720020006D0069007300730069006E00670000276C006F00770065007200520069006700680074004C006F006E00670069007400750064006500004D4C006F0077006500720020007200690067006800740020006C006100740069007400750064006500200070006100720061006D00650074006500720020006D0069007300730069006E00670000256C006F00770065007200520069006700680074004C006100740069007400750064006500006B2E00730070007200530054004100470045005F00560065006800690063006C006500440065007600690063006500500072006F0070006500720074006900650073005F0047006500740046006F007200560065006800690063006C006500440065007600690063006500001D4000760065006800690063006C00650048006F007300740049004400001B400064006500760069006300650048006F0073007400490044000019500072006F00700065007200740079004E0061006D00650000134F007000650072006100740069006F006E0000034400001B500072006F0070006500720074007900560061006C00750065000013670065006F0067007200610070006800790000037C0000032000002143003A005C00540065006D0070005C00740065006D0070002E0074007800740000033B0000033D0000035C000013740072006900670067006500720049004400000F74007200690067006700650072000005690064000011730065007100750065006E0063006500001370006100720061006D00650074006500720000116F00700065007200610074006F00720000117200650071007500690072006500640000096A006F0069006E0000033000001174007200690067006700650072007300000F7B0030007D0020007B0031007D0000412E007300700072004D00610070004C006F0063006100740069006F006E0050006F006C00790067006F006E0050006F0069006E00740073005F00470065007400001740006C006F0063006100740069006F006E0049004400005150006F0069006E0074007300200064006F0020006E006F00740020006300720065006100740065002000760061006C0069006400200050006F006C00790067006F006E0020007300680061007000650000416E006F007400200065006E006F00750067006800200070006F0069006E0074007300200074006F0020006D0061006B006500200061002000720069006E006700004573007500700070006C00690065006400200070006F0069006E0074007300200064006F0020006E006F00740020006D0061006B006500200061002000720069006E0067000011700072006F00700065007200740079000015700072006F00700065007200740069006500730000096E0061006D00650000592E00730070007200530054004100470045005F00560065006800690063006C006500540072006900670067006500720073005F0047006500740046006F007200560065006800690063006C0065004500760065006E007400001940006500760065006E00740048006F00730074004900440000135400720069006700670065007200490044000011530065007100750065006E0063006500001950006100720061006D0065007400650072004B006500790000114F00700065007200610074006F007200001D5400680072006500730068006F006C006400560061006C007500650000115200650071007500690072006500640000194A006F0069006E004F00700065007200610074006F00720000174C006F0067006900630061006C004400690073006B00000B44007200690076006500001543006100700061006300690074007900470062000017550073006500640053007000610063006500470062000017460072006500650053007000610063006500470062000021500065007200630065006E0074004600720065006500530070006100630065000019250020004600720065006500200053007000610063006500001D460072006500650020004D0065006700610062007900740065007300000D5F0054006F00740061006C0000000000D0C83B0FF323864BB3E7054BE24F863F0008B77A5C561934E0890889845DCD8080CC910A00031219111D111D11210A000311251129112911250C0004112D112D1131112112350800021219112D11210C0004112D112D1131113112350C0004113911291129112511250A00031129112D112D1129060001112D112D0A0003113D1129112911250A00031121112D112D11210800021219111D111D0A0003112D112D112D112D0C00041219111D111D111D111D03200001052002011C18042001010E08200312410E12451C0520010112410A20050E0E06081249124D0900040112510E11551C0800030112510E12190700030112510E0E0306111C02060D030611590306125D020608082004010D0D0D125D0A2005010D0D0D125D11590400010D0D0600030D0D0D0D0520010811200320000D042001010D042000115905200101115903200008042000111C05200101111C042000125D05200101125D0328000D042800115903280008042800111C042800125D02060A08846101000000000008007701000000000008708E01000000000008E0A5010000000000030611200400000000040100000003200005042001010504200101080320000204200101020720001511610105082001011511610105020605020602060615116101050328000503280002072800151161010502060E0300000E0500020E0E0E0600030E0E0E0E060003020E0E02060003050E0E05060003040E0E040600030C0E0E0C08000311650E0E11650600030D0E0E0D09000411650E0E1165020700040D0E0E0D020700040C0E0E0C02060003080E0E08060003090E0E090600030A0E0E0A060003060E0E06060003070E0E070400010E0E040001010E0A0001140E02000200000E050002080E0E0308000E080615126902051124052001011249052001112405062002010511240320000E042000126D0520010112710528011124050328000E0306113404FFFFFFFF0700021D11300E0809000212191D113011750A0003011175101279113007000112191D113007000111341D11300706151269020E0E0420010E0E052002010E0E0428010E0E062001011180A980A000240000048000009400000006020000002400005253413100040000010001007F83CA9608B019BEF3771042BEEE36C3084B9909C37FA7543314053CF9EF7837CCCA442DA0D7068237E6BFCDEBD7E5E14DD078F10066F644B4A60045321D9D7FFA256B194A711E454416F9708A8671EE9F09CB289052BF40254055878C69A47B5E8EB29819976879C86C855E6B6AEAAAF8A1BCE3AC7AE7152BB94A8472AA19C4050001113D0205000102113D050001112108080002113D11211121080002113D113D113D05200112190D07070312191219020520001180BD05200111590D0820020111591180BD0B07041180BD121811251159808F010001005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A44617461416363657373010000000306112D042000124903200006050002020E0E0F07080E112D1249124D12100E112D02072002011280D1080E07061D1130081D113012191219020A07041D113012191219020500020E0E1C1207090E112D1249124D12400E1280B9112D0205000111250E070002021125112503061139040000112507200111251180BD0B00021180BD1180BD1180BD05200111250D0900021180BD1125112507000208112511250320000A0600011180BD0A0400010A0D05000111390A39071811251180BD12181180BD112511251180BD1180BD1180BD11251125112511251180BD1180BD1180BD1180BD11251125081139021125115904200103080520020E0E0E0400010D0E0C07070E1280DD0E1129020D03050001112D0E0520010E1D030807040E112D021D0307000202115911590C07051180BD1218113D1159020520020E0303050702112D020507021121020520010111750320000C052002010D0D042000121907070312791219021207071180BD12181180BD11251125112511590D07080D0D0D0D127912191219020420001251062001011180ED0520001280F10720021280F90E1C0820011281011181050420011C0E04000101080C07061251123C1281110E0E02062002010E1155042001011C0820011280F91280F90507011280F9072003010E1155080400001159050000128119052001125D080307010D0407020D02150711080D0D0D0D0D0D0D0D0D0D0D0D0D08021180BD04070111590307010806070211591159040701111C040701125D06200101118125030701050307010207070115116101050307010E052002080E080520020E08080420010E080707050E08080E0205000012812D0C0004020E118131128135100D040001020D040001020E0807060E020D020202040001050E0607040E050502040001040E0607040E0404020400010C0E0607040E0C0C0205000111650E0807040E11651165020607040E0D0D02040001080E0607040E080802040001090E0607040E0909020400010A0E0607040E0A0A02040001060E0607040E060602040001070E0607040E070702042001080E0500010E1D0E0707040E0E021D0E0420001D030620011D0E1D030D07081D0E1D0E0E0E0E1D0E08020600011281550E05070112815907140E02000200000520020108080620030108080E1A07091D0E1D0E140E02000200000A0E140E0200020000021D0E080407020E0204000103080707050E0E0E03020607040808080203000001090100044974656D00000715126902051124052001021300062001130113000507021124020720020113001301062001011181710A0002127112817512816D042001010A062001011281751007070E12816912816D12711281790E02042001020E0515116101050520010113000F070B0505080502050D11241124020E0B20001511818502130013010815118185020511240B2000151181890213001301081511818902051124042000130004200013011B0706151181890205112408151181850205112411241511610105020600030E0E1C1C071512818D011130052002010E1C0420010C080520001D13001607071512818D011130124D125112811111301D1130021207091219127911340811301219021D1130080620010111819505200012819905200012819D080002121912819D081607091281911130128199128199121912191D113008020C07070D08081130113011340206151269020E0E0507030E0E020715118185020E0E0715118189020E0E11070315118189020E0E15118185020E0E0204200102081407091251122C128111050E11240E021511610105072003010E11550A072001011D1281B10500001281BD062001011281B50420001D0E072004010E0E0E0E0620020108112D1B070D1281AD1281B50E1281C11281C10C0C0C0C021D1281B11D0E08170100124D69582E496E73696768742E53514C434C5200000501000000001301000E4D69582054656C656D617469637300001001000B4D695820496E7369676874000025010020436F7079726967687420C2A9204D69582054656C656D6174696373203230303900000801000701000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730100000000000017D3985000000000020000007C00000050A3000050850000525344536202F21972B74B449420C15F93E12DAC01000000433A5C50726F6A656374735C5A6572675C494E532D3731375C44617461626173655C4F4C41505C53514C434C525C4D69582E496E73696768742E53746167696E675C6F626A5C44656275675C4D69582E496E73696768742E53746167696E672E70646200F4A3000000000000000000000EA4000000200000000000000000000000000000000000000000000000A40000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF2500204000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058C000007C03000000000000000000007C0334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001001B4E5512000001001B4E55123F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004DC020000010053007400720069006E006700460069006C00650049006E0066006F000000B8020000010030003000300030003000340062003000000040000F00010043006F006D00700061006E0079004E0061006D006500000000004D00690058002000540065006C0065006D006100740069006300730000000000500013000100460069006C0065004400650073006300720069007000740069006F006E00000000004D00690058002E0049006E00730069006700680074002E00530051004C0043004C0052000000000040000F000100460069006C006500560065007200730069006F006E000000000031002E0030002E0034003600390033002E00310039003900390035000000000050001800010049006E007400650072006E0061006C004E0061006D00650000004D00690058002E0049006E00730069006700680074002E00530074006100670069006E0067002E0064006C006C0000006400200001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020004D00690058002000540065006C0065006D00610074006900630073002000320030003000390000005800180001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000004D00690058002E0049006E00730069006700680074002E00530074006100670069006E0067002E0064006C006C00000038000C000100500072006F0064007500630074004E0061006D006500000000004D0069005800200049006E0073006900670068007400000044000F000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0034003600390033002E00310039003900390035000000000048000F00010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0034003600390033002E003100390039003900350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000A000000C000000203400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
WITH PERMISSION_SET = UNSAFE

GO
/****** Object:  SqlAssembly [MiX.SQL.Selection]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE ASSEMBLY [MiX.SQL.Selection]
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030016D398500000000000000000E00002210B010800002400000006000000000000BE42000000200000006000000000400000200000000200000400000000000000040000000000000000A000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000644200005700000000600000F003000000000000000000000000000000000000008000000C000000CC4100001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000C4220000002000000024000000020000000000000000000000000000200000602E72737263000000F0030000006000000004000000260000000000000000000000000000400000402E72656C6F6300000C0000000080000000020000002A00000000000000000000000000004000004200000000000000000000000000000000A0420000000000004800000002000500142C0000B81500000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000133002004A00000001000011281600000A6F1700000A027B03000004330F027B020000041FFEFE0116FE012B01170C082D0B02167D02000004020A2B071673130000060A06027B050000047D04000004060B2B00072A0000133001000B0000000200001102280C0000060A2B00062A001B3005000D01000003000011027B020000040B0745030000000700000009000000020000002B0738BF0000002B0538D700000002157D0200000400027C04000004281800000A16FE010C082D060038B7000000027C04000004281900000A6F1A00000A17FE0416FE010C082D0600389700000002027C04000004281900000A178D1E0000010D09161F2C9D096F1B00000A731C00000A7D06000004027B060000046F1D00000A000002027B060000046F1E00000A7D0800000402177D020000042B3102027C08000004281F00000A7D070000040002027B070000047D0100000402187D02000004170ADE2B02177D0200000400027C08000004282000000A0C082DC00228140000060000160ADE0802281100000600DC00062A000000411C0000040000000000000002010000020100000800000000000000133001000B00000004000011027B010000040A2B00062A1A732100000A7A00001B3002002B00000005000011027B020000040A061759450200000004000000020000002B042B042B022B0BDE0802281400000600DC002A000110000002001F000221000800000000133001000B00000004000011027B010000040A2B00062A7A02282200000A02037D0200000402281600000A6F1700000A7D030000042A6A02157D02000004027C08000004FE160400001B6F1300000A002A0000001330020015000000060000111FFE73130000060A06027D05000004060B2B00072A4E000302741D000001282300000A81030000012A000000133002004A00000007000011281600000A6F1700000A027B0B000004330F027B0A0000041FFEFE0116FE012B01170C082D0B02167D0A000004020A2B0716731C0000060A06027B0D0000047D0C000004060B2B00072A0000133001000B000000020000110228150000060A2B00062A001B3005003001000003000011027B0A0000040B0745030000000700000009000000020000002B0738CF0000002B0538FA00000002157D0A00000400027C0C000004281800000A16FE010C082D060038DA000000027C0C000004281900000A6F1A00000A17FE0416FE010C082D060038BA00000002027C0C000004281900000A178D1E0000010D09161F2C9D096F1B00000A7D0E0000040002177D0A00000402027B0E0000047D1100000402167D120000042B5E02027B11000004027B120000049A7D1000000400027B10000004027C0F000004282400000A16FE010C082D2302027B0F0000048C200000017D0900000402187D0A000004170ADE3E02177D0A0000040002027B1200000417587D12000004027B12000004027B110000048E69FE040C082D8E02281D0000060000160ADE0802281A00000600DC00062A411C0000040000000000000025010000250100000800000000000000133001000B00000004000011027B090000040A2B00062A1A732100000A7A0000133002002700000005000011027B0A0000040A061759450200000004000000020000002B042B042B022B0702281D000006002A00133001000B00000004000011027B090000040A2B00062A7A02282200000A02037D0A00000402281600000A6F1700000A7D0B0000042A2202157D0A0000042A001330020015000000080000111FFE731C0000060A06027D0D000004060B2B00072A4E000302A520000001282500000A81040000012A000000133002004A00000009000011281600000A6F1700000A027B15000004330F027B140000041FFEFE0116FE012B01170C082D0B02167D14000004020A2B071673250000060A06027B170000047D16000004060B2B00072A0000133001000B0000000200001102281E0000060A2B00062A001B3005006001000003000011027B140000040B0745030000000700000009000000020000002B0738010100002B05382A01000002157D1400000400027C16000004281800000A16FE010C082D0600380A010000027C16000004281900000A6F1A00000A17FE0416FE010C082D060038EA00000002027C16000004281900000A178D1E0000010D09161F2C9D096F1B00000A731C00000A7D18000004027B180000046F1D00000A000272010000707D1A0000040002027B180000046F1E00000A7D1C00000402177D140000042B7602027C1C000004281F00000A7D1B00000400027B1B000004027B1A000004282600000A16FE010C082D4B00027B1B000004027C19000004282700000A16FE010C082D250002027B190000048C210000017D1300000402187D14000004170ADE3C02177D140000040002027B1B0000047D1A0000040000027C1C000004282000000A0C083A78FFFFFF0228260000060000160ADE0802282300000600DC00062A411C0000040000000000000055010000550100000800000000000000133001000B00000004000011027B130000040A2B00062A1A732100000A7A00001B3002002B00000005000011027B140000040A061759450200000004000000020000002B042B042B022B0BDE0802282600000600DC002A000110000002001F000221000800000000133001000B00000004000011027B130000040A2B00062A7A02282200000A02037D1400000402281600000A6F1700000A7D150000042A6A02157D14000004027C1C000004FE160400001B6F1300000A002A00000013300200150000000A0000111FFE73250000060A06027D17000004060B2B00072A4E000302A521000001282800000A81050000012A000000133002004A0000000B000011281600000A6F1700000A027B1F000004330F027B1E0000041FFEFE0116FE012B01170C082D0B02167D1E000004020A2B0716732E0000060A06027B210000047D20000004060B2B00072A0000133001000B000000020000110228270000060A2B00062A001B3005004401000003000011027B1E0000040B07162E0B07192E022B0738E90000002B05381801000002157D1E00000400027C20000004281800000A16FE010C082D060038F8000000027C20000004281900000A6F1A00000A17FE0416FE010C082D060038D80000000002177D1E00000402027C20000004281900000A178D1E0000010D09161F2C9D096F1B00000A7D2400000402167D25000004388200000002027B24000004027B250000049A7D2200000400027E2900000A7D230000040002027B22000004732A00000A7D2300000400DE05260000DE0000027C230000047E2900000A282B00000A0C082D250002027B230000048C220000017D1D00000402197D1E000004170ADE4202177D1E000004000002027B2500000417587D25000004027B25000004027B240000048E69FE040C083A67FFFFFF02282F0000060000160ADE0802282C00000600DC00062A4134000000000000B300000015000000C80000000500000023000001040000000000000039010000390100000800000000000000133001000B00000004000011027B1D0000040A2B00062A1A732100000A7A0000133002002B00000005000011027B1E0000040A06175945030000000400000006000000020000002B042B042B022B0702282F000006002A00133001000B00000004000011027B1D0000040A2B00062A7A02282200000A02037D1E00000402281600000A6F1700000A7D1F0000042A2202157D1E0000042A0013300200150000000C0000111FFE732E0000060A06027D21000004060B2B00072A4E000302A522000001282C00000A81060000012A1E02282200000A2A00000013300400C50000000D0000110072010000700A0F00281800000A2D090F01281800000A2B0117130511053A95000000000F02281800000A2D0E0F02281900000A6F2E00000A2B10178D1E00000113061106161F3B9D11060B0F00281900000A076F1B00000A0C000813071613082B46110711089A0D00090F01281900000A7203000070282F00000A6F3000000A16FE01130511052D1800090F01281900000A6F1A00000A17586F3100000A0A2B1500110817581308110811078E69FE04130511052DAC0006733200000A13042B0011042A1E02282200000A2A00000042534A4201000100000000000C00000076322E302E35303732370000000005006C00000090090000237E0000FC090000F407000023537472696E677300000000F01100000800000023555300F811000010000000234755494400000008120000B003000023426C6F6200000000000000020000015717A20B0902000000FA253300160000010000002400000007000000250000002F0000001300000014000000320000002B0000000D0000000400000008000000080000001C0000000400000001000000020000000400000000000A00010000000000060053004C0006006D005A000A009A0085000A00C70085000A00E60085000A000201850006005401350106008F017D010600A6017D010600C3017D010600E2017D010600FB017D01060014027D0106002F023501060043027D0106006F025C024300830200000600B20292020600D20292020A001D03020306005E03430306006C03430306007A035A00060086034C0006001A0543036700360500000600BF055C020600E805D70506002A064C0006003C064C0006004C064C000600C6064C0006003F074C00060064074C000600A6074C000600B007920200000000010000000000010001000100100020002A000500010001000100100032000000050001000A000301100032030000050001000C00030110006E06000005000900150003011000D5060000050013001E00030110004507000005001D00270001001A04DB000100C304E7000100CE04E70006002701EA0006000E05EA0006002105EE0006002B05F50006004105F80001001A04DB000100C304E7000100CE04E70006002701EA0006000E05EA0006008306BE0106008D06C20106009906F5000600B006BE010600BB06E70001001A04DB000100C304E7000100CE04E70006002701EA0006000E05EA000600E606EE000600F106E7000600FE06F50006000C07F50006001607F80001001A04DB000100C304E7000100CE04E70006002701EA0006000E05EA0006005807F50006006907B60206008107BE0106008D07E700B422000000009600A4000A000100D522000000009600AF00110002004825000000009600B8000A0004006925000000009600D000190005003428000000009600DC000A0007005528000000009600EF0021000800F82A000000009600F6000A000A00192B0000000096000A0129000B002D2B000000008618140131000D00382B0000000096001A0135000D00092C000000008618140131001000502000000000E1019203C1001000A82000000000E101E403D2001000C02000000000E1011104D7001000F82100000000E1092704DE0010000F2200000000E101750431001000182200000000E101A00431001000602200000000E109E304DE001000772200000000861814015000100096220000000081004C0531001100EC2200000000E1019203C1001100442300000000E101E403D20011005C2300000000E1011104D7001100B42400000000E1092704DE001100CB2400000000E101750431001100D42400000000E101A00431001100082500000000E109E304DE0011001F250000000086181401500011003E25000000008100A20631001200802500000000E1019203C1001200D82500000000E101E403D2001200F02500000000E1011104D7001200782700000000E1092704DE0012008F2700000000E101750431001200982700000000E101A00431001200E02700000000E109E304DE001200F72700000000861814015000120016280000000081002207310013006C2800000000E1019203C1001300C42800000000E101E403D2001300DC2800000000E1011104D7001300602A00000000E1092704DE001300772A00000000E101750431001300802A00000000E101A00431001300B82A00000000E109E304DE001300CF2A000000008618140150001300EE2A000000008100720731001400000001002701000001002E01020002003201000001002701000001002E01020002003201000001002701000001002E01020002003201000001002701000001002E01020002003201000001006101000002006F0100000300730100000100C30400000100C30400000100C30400000100C304040006000400090004000A0004005D0004006100050006000500090005000A0005005D0005006100060006000600090006000A0006005D0006006100070006000700090007000A0007005D0007006100390014013100410014014000490014014000510014014000590014014000610014014000690014014000710014014500790014014000810014014A00910014015000990014013100A100140131000C00D603C9001100D603D200B9001104D70014006904E200B9009A043100C100BB043100B9006904DE00D90014013100E100EF050801E10001060D0119001506D700190020062101E90031060D01E900410625011C00140132011C00470631001C00D6033C0124006904E20024001104D700F900140131000900140131001900620662010101CC06D00121006206DE01E90031073C020901CC06420229006206500211019907B60211011401400011019F07C60231006206D402210114013100E900CB07DC02E900D707E102E900DE07E702E900E907EC0219001401400020006B0055002E0063008E032E001B001D032E0023001D032E005B0085032E00130002032E002B0023032E00330037032E003B0048032E0043001D032E0053007C0360006B00680183006B010301A0006B00E401A3006B010301C3006B010301E0006B005602E3006B01030140016B0003018001AB000301A001AB000301E001AB0003010002AB0003014002AB0003016002AB000301A002AB000301C002AB0003010003AB0003012003AB0003016003AB0003018003AB000301C003AB000301E003AB0003012004AB0003014004AB0003018004AB000301A004AB000301E004AB0003010005AB0003014005AB0003016005AB000301A005AB000301C005AB00030111011C014B01530157015B01C501D70131024902BB02CD02F1020400010005000300060005000700070000005A05FF0000009805FF0000005A05FF0000009805FF0000005A05FF0000009805FF0000005A05FF0000009805FF0002000F00030002001200050002001800070002001B000900020021000B00020024000D0002002A000F0002002D001100040018001D0004001A001F0004001C00210004001E00230004002000250004002200270004002400290005003600290005002C001F0005002E00210005003000230005003200250005003400270005002A001D0006004200230006003E001F0006004000210006003C001D0006004400250006004600270006004800290007004E001D00070050001F0007005200210007005400230007005600250007005800270007005A002900B500BB002C014501048000000100000055121B4E000000000000F0020000020000000000000000000000010043000000000002000000000000000000000001007900000000000400020005000200060002000700020000000000003C4D6F64756C653E004D69582E53514C2E53656C656374696F6E2E646C6C0053656C656374696F6E004D69582E53514C0047656E6572616C46756E6374696F6E73006D73636F726C69620053797374656D004F626A6563740053797374656D2E436F6C6C656374696F6E730049456E756D657261626C650053797374656D2E446174610053797374656D2E446174612E53716C54797065730053716C537472696E6700556E7061636B546578740046696C6C5465787400556E7061636B536D616C6C4944730053716C496E7431360046696C6C536D616C6C494400556E7061636B4944730053716C496E7433320046696C6C494400556E7061636B47756964730053716C477569640046696C6C4775696473002E63746F72004578747261637456616C75650049444C697374006F626A0049440053797374656D2E52756E74696D652E496E7465726F705365727669636573004F75744174747269627574650044656C696D697465644C697374004B65790044656C696D697465720053797374656D2E5265666C656374696F6E00417373656D626C795469746C6541747472696275746500417373656D626C794465736372697074696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500436F6D56697369626C6541747472696275746500417373656D626C7956657273696F6E4174747269627574650053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465004D69582E53514C2E53656C656374696F6E004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E417474726962757465003C556E7061636B546578743E645F5F300053797374656D2E436F6C6C656374696F6E732E47656E657269630049456E756D657261626C6560310049456E756D657261746F7260310049456E756D657261746F720049446973706F7361626C650053797374656D2E436F6C6C656374696F6E732E47656E657269632E49456E756D657261626C653C53797374656D2E4F626A6563743E2E476574456E756D657261746F7200476574456E756D657261746F720053797374656D2E436F6C6C656374696F6E732E49456E756D657261626C652E476574456E756D657261746F72004D6F76654E657874003C3E325F5F63757272656E740053797374656D2E436F6C6C656374696F6E732E47656E657269632E49456E756D657261746F723C53797374656D2E4F626A6563743E2E6765745F43757272656E74006765745F43757272656E740053797374656D2E436F6C6C656374696F6E732E49456E756D657261746F722E52657365740052657365740053797374656D2E49446973706F7361626C652E446973706F736500446973706F7365003C3E315F5F7374617465003C3E6C5F5F696E697469616C54687265616449640053797374656D2E436F6C6C656374696F6E732E49456E756D657261746F722E6765745F43757272656E74003C3E335F5F49444C697374004C6973746031003C6964733E355F5F31003C6974656D3E355F5F3200456E756D657261746F72003C3E375F5F7772617033003C3E6D5F5F46696E616C6C79340053797374656D2E436F6C6C656374696F6E732E47656E657269632E49456E756D657261746F723C53797374656D2E4F626A6563743E2E43757272656E740053797374656D2E436F6C6C656374696F6E732E49456E756D657261746F722E43757272656E7400446562756767657248696464656E4174747269627574650053797374656D2E546872656164696E6700546872656164006765745F43757272656E74546872656164006765745F4D616E616765645468726561644964006765745F49734E756C6C006765745F56616C756500537472696E67006765745F4C656E67746800436861720053706C697400536F7274004E6F74537570706F72746564457863657074696F6E006F705F496D706C69636974003C556E7061636B536D616C6C4944733E645F5F37003C6964733E355F5F38003C76616C75653E355F5F39003C69643E355F5F61003C3E6D5F5F46696E616C6C7962003C3E375F5F7772617063003C3E375F5F777261706400496E743136005472795061727365003C556E7061636B4944733E645F5F3130003C6964733E355F5F3131003C76616C75653E355F5F3132003C6C61737449443E355F5F3133003C69643E355F5F3134003C3E375F5F777261703135003C3E6D5F5F46696E616C6C793136006F705F496E657175616C69747900496E743332003C556E7061636B47756964733E645F5F3139003C6974656D3E355F5F31610047756964003C673E355F5F3162003C3E6D5F5F46696E616C6C793163003C3E375F5F777261703164003C3E375F5F77726170316500456D70747900457175616C7300457863657074696F6E00436F6D70696C657247656E65726174656441747472696275746500546F43686172417272617900436F6E636174005374617274735769746800537562737472696E670000000100033D0000007F35469FFB56BD42ADD50C088AC686B80008B77A5C561934E0890600011209110D070002011C10110D070002011C101111070002011C101115070002011C101119032000010A0003110D110D110D110D042001010E042001010205200101114504200101085F0100030054020F497344657465726D696E697374696301540E1146696C6C526F774D6574686F644E616D650846696C6C54657874540E0F5461626C65446566696E6974696F6E1854657874436F6C756D6E206E76617263686172286D61782905151255011C05151259011C072000151259011C082000151259011300042000125D0320000202061C0320001C04200013000206080306110D0606151265010E02060E0606151169010E0328001C04010000000400001271032000080A07031210151259011C02040701125D0320000E0620011D0E1D0305151265010E0920010115125501130008200015116901130005151169010E0707040208021D030307011C0307010806070212101209050001110D0E550100030054020F497344657465726D696E697374696301540E1146696C6C526F774D6574686F644E616D650B46696C6C536D616C6C4944540E0F5461626C65446566696E6974696F6E0B494420736D616C6C696E7403061D0E0206060A07031214151259011C02060002020E1006060702121412090500011111064C0100030054020F497344657465726D696E697374696301540E1146696C6C526F774D6574686F644E616D650646696C6C4944540E0F5461626C65446566696E6974696F6E07494420696E74200A07031218151259011C02050002020E0E060002020E1008060702121812090500011115085F0100030054020F497344657465726D696E697374696301540E1146696C6C526F774D6574686F644E616D650946696C6C4775696473540E0F5461626C65446566696E6974696F6E175B477569645D20756E697175656964656E74696669657204061180890A0703121C151259011C0206200102118089060702121C120907000111191180890420001D030500020E0E0E042001020E0420010E081007090E1D031D0E0E110D021D031D0E081A0100154D695820496E73696768742053656C656374696F6E00000501000000001301000E4D69582054656C656D617469637300001001000B4D695820496E736967687400003301002E436F7079726967687420C2A9204D69582054656C656D617469637320496E7465726E6174696F6E616C203230303900000801000701000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010000000000000016D3985000000000020000007C000000E8410000E8230000525344532A6450F38254C647A06AE70EBE219DEE01000000433A5C50726F6A656374735C5A6572675C494E532D3731375C44617461626173655C4F4C41505C53514C434C525C4D69582E496E73696768742E53656C656374696F6E5C6F626A5C44656275675C4D69582E53514C2E53656C656374696F6E2E706462008C4200000000000000000000AE420000002000000000000000000000000000000000000000000000A04200000000000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058600000940300000000000000000000940334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001001B4E5512000001001B4E55123F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004F4020000010053007400720069006E006700460069006C00650049006E0066006F000000D0020000010030003000300030003000340062003000000040000F00010043006F006D00700061006E0079004E0061006D006500000000004D00690058002000540065006C0065006D006100740069006300730000000000540016000100460069006C0065004400650073006300720069007000740069006F006E00000000004D0069005800200049006E00730069006700680074002000530065006C0065006300740069006F006E00000040000F000100460069006C006500560065007200730069006F006E000000000031002E0030002E0034003600390033002E0031003900390039003500000000004C001600010049006E007400650072006E0061006C004E0061006D00650000004D00690058002E00530051004C002E00530065006C0065006300740069006F006E002E0064006C006C00000080002E0001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020004D00690058002000540065006C0065006D0061007400690063007300200049006E007400650072006E006100740069006F006E0061006C002000320030003000390000005400160001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000004D00690058002E00530051004C002E00530065006C0065006300740069006F006E002E0064006C006C00000038000C000100500072006F0064007500630074004E0061006D006500000000004D0069005800200049006E0073006900670068007400000044000F000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0034003600390033002E00310039003900390035000000000048000F00010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0034003600390033002E0031003900390039003500000000000000000000000000000000000000000000000000004000000C000000C03200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
WITH PERMISSION_SET = UNSAFE

GO
/****** Object:  Schema [audit]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [audit]
GO
/****** Object:  Schema [Control]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [Control]
GO
/****** Object:  Schema [StageControl]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [StageControl]
GO
/****** Object:  Schema [StageUser]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [StageUser]
GO
/****** Object:  Schema [StageUser1]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [StageUser1]
GO
/****** Object:  Schema [StageUser10]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [StageUser10]
GO
/****** Object:  Schema [StageUser2]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [StageUser2]
GO
/****** Object:  Schema [StageUser3]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [StageUser3]
GO
/****** Object:  Schema [StageUser4]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [StageUser4]
GO
/****** Object:  Schema [StageUser5]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [StageUser5]
GO
/****** Object:  Schema [StageUser6]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [StageUser6]
GO
/****** Object:  Schema [StageUser7]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [StageUser7]
GO
/****** Object:  Schema [StageUser8]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [StageUser8]
GO
/****** Object:  Schema [StageUser9]    Script Date: 2012/12/02 02:27:06 PM ******/
CREATE SCHEMA [StageUser9]
GO
/****** Object:  StoredProcedure [Control].[sprActivateOrganisation]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprActivateOrganisation]
(
  @organisationID     int = -1,
  @organisationGUID   uniqueidentifier,
  @activationStatus   bit = 1,
  @deactivateAllOther bit = 0,
  @organisationName   nvarchar(100) = ''
)
AS
BEGIN
  
  IF @organisationID = -1
  BEGIN

    UPDATE [Control].OrganisationController
      SET DWActive = 1;

  END
  ELSE
  BEGIN

    ;WITH OrganisationToActivate (OrganisationID,OrganisationGUID,DWActive) AS
    (
      SELECT OrganisationID   = @organisationID,
             OrganisationGUID = @organisationGUID,
             DWActive         = @activationStatus
    )
    MERGE INTO [Control].OrganisationController tar
      USING OrganisationToActivate stg
         ON tar.OrganisationID   = stg.OrganisationID
        AND tar.OrganisationGUID = stg.OrganisationGUID
    -- Matched and DW IsCurrent record (then just update)
      WHEN MATCHED
        THEN UPDATE
          SET tar.DWActive = stg.DWActive
      WHEN NOT MATCHED
        THEN INSERT
        ( OrganisationID,OrganisationGUID,DWActive,UTCOffset,DBVersion,OrganisationName)
        VALUES
        ( stg.OrganisationID,stg.OrganisationGUID,stg.DWActive,0,'',@organisationName);

  END;

  IF @deactivateAllOther = 1 AND @organisationID <> -1
  BEGIN

    UPDATE [Control].OrganisationController
    SET DWActive = 0
    WHERE OrganisationID <> @organisationID;

  END;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprAllocateExtractDBToUser]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprAllocateExtractDBToUser]
(
  @Threaduser      NVARCHAR (50) = null,
  @batchKey        INT           = 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @organisationId                    INT;
  DECLARE @serverInstance                    NVARCHAR(256)  = 'x';
  DECLARE @databaseName                      VARCHAR(256)   = 'x';
  DECLARE @ConnectUid                        VARCHAR(256)   = 'x';
  DECLARE @connectPwd                        VARCHAR(256)   = 'x';
  DECLARE @errorcode                         VARCHAR(50)    = 'x';
  DECLARE @dbChangeTrackVersion              BIGINT         = -1;
  DECLARE @SourceDBPrevMinTableChangeVersion BIGINT         = -1;
  DECLARE @organisationGUID                  UNIQUEIDENTIFIER;
  DECLARE @organisationKey                   INT            = -1;
  DECLARE @result                            INT            = 1;    --The @result variable is used to check if the ETL should continue. 1 is stop, 0 is continue
  DECLARE @latestDBVersion                   VARCHAR(10)    = '';
  DECLARE @scheduleDateTime                  DATETIMEOFFSET(0);
  DECLARE @numberOfExtractAttempts           INT;
  DECLARE @isNewDatabase                     INT;

  DECLARE @futureDateTime       DATETIMEOFFSET(0) = '20501231';
  DECLARE @defaultDateTime      DATETIMEOFFSET(0) = '19000101';


  -- used to identify which UTCs still to run
  DECLARE @batchStartTime       DATETIMEOFFSET;
  DECLARE @runTime              DATETIMEOFFSET = SYSDATETIMEOFFSET();
  
  -- Get Thread number / compare with isPartOfGroupID
  DECLARE @ThreadNumber INT
  IF LEN(@Threaduser) <= 10
    SET @ThreadNumber = RIGHT(@Threaduser,1);
  ELSE
    SET @ThreadNumber = RIGHT(@Threaduser,2);

  DECLARE @selectedOrganisation table
  (
    OrganisationID       int           default -1 ,
    ServerInstance       nvarchar(256) default 'x',
    DatabaseName         varchar(256)  default 'x',
    ConnectUID           varchar(256)  default 'x',
    ConnectPWD           varchar(256)  default 'x',
    DBChangeTrackVersion bigint        default -1 ,
    OrganisationGUID     uniqueidentifier         ,
    OrganisationKey      int           default -1 ,
    ScheduleDateTime     datetimeoffset(0) default '19000101',
    NumberOfExtractAttempts int        default 0
  )

  DECLARE @OrgsToBeProcessed TABLE 
  (
    OrganisationID        int           default -1 ,
    ScheduleDateTime      datetimeoffset(0) default '19000101',
    UTCOffsetPriority     int,
    IsPartOfBatchID       int
  );


  -- Make sure there are no other orgs incorrectly marked as busy for this ThreadUser
  IF EXISTS (SELECT 1 FROM [Control].OrganisationController WITH (NOLOCK)
             WHERE CurrentThreadUser = @Threaduser
             AND bActive    = 1
             AND DWActive   = 1
             AND IsFinished = 0)
  BEGIN
    UPDATE [Control].OrganisationController
    SET IsFinished = 1
    WHERE CurrentThreadUser = @Threaduser
    AND bActive    = 1
    AND DWActive   = 1
    AND IsFinished = 0
  END;

  IF NOT EXISTS (SELECT 1 FROM [Control].BatchController
                 WHERE
                     BatchShouldStop = 1
                 AND BatchID         = @batchKey)
  BEGIN

    -- get the batch start time
    SELECT @batchStartTime = BatchStart
    FROM
      [Control].BatchController
    WHERE BatchID          = @batchKey;

    -- get the latest database version currently in use
    SELECT @latestDBVersion = MAX(DBVersion)
    FROM
      [Control].OrganisationController
    WHERE BActive = 1;

    UPDATE Control.OrganisationController
    SET ScheduleDateTime = dbo.fncGetNextSchedule(ISNULL(ProcessIntervalInSec,3600*24),ISNULL(UTCOffset,0))
    WHERE bActive = 1
    AND DWActive  = 1
    AND ScheduleDateTime IS NULL;

    ;WITH
    MyStageUser AS
    (
      SELECT TOP 1
        1 ThreadPriority,
        OrganisationID,
        ScheduleDateTime,
        UTCOffsetPriority,
        IsFinished
      FROM [Control].OrganisationController
      WHERE BActive       = 1 
      AND DWActive        = 1
      AND IsFinished      = 1
      AND IsPartOfGroupID = @ThreadNumber
      AND ScheduleDateTime <= @runTime
      ORDER BY ScheduleDateTime
    ),
    NullStageUser AS
    (
      SELECT TOP 1
        2 ThreadPriority,
        OrganisationID,
        ScheduleDateTime,
        UTCOffsetPriority,
        IsFinished
      FROM [Control].OrganisationController
      WHERE BActive  = 1 
      AND DWActive   = 1
      AND IsFinished = 1
      AND ISNULL(IsPartOfGroupID,0) = 0
      AND ScheduleDateTime <= @runTime
      ORDER BY ScheduleDateTime
    ),
    OtherStageUser AS
    (
      SELECT TOP 1
        3 ThreadPriority,
        OrganisationID,
        ScheduleDateTime,
        UTCOffsetPriority,
        IsFinished
      FROM Control.OrganisationController
      WHERE BActive  = 1
      AND DWActive   = 1
      AND IsFinished = 1
      AND IsPartOfGroupID  <> @ThreadNumber
      AND ScheduleDateTime <= @runTime
      ORDER BY ScheduleDateTime
    ),
    CombinedStageUsers AS
    (
      SELECT
        ThreadPriority,
        OrganisationID,
        ScheduleDateTime,
        UTCOffsetPriority,
        IsFinished
      FROM MyStageUser mu
      UNION ALL
      SELECT
        ThreadPriority,
        OrganisationID,
        ScheduleDateTime,
        UTCOffsetPriority,
        IsFinished
      FROM NullStageUser n
      UNION ALL
      SELECT
        ThreadPriority,
        OrganisationID,
        ScheduleDateTime,
        UTCOffsetPriority,
        IsFinished 
      FROM OtherStageUser o
    )
    INSERT INTO @selectedOrganisation
    (
      OrganisationID,
      ServerInstance,
      DatabaseName,
      ConnectUID,
      ConnectPWD,
      DBChangeTrackVersion,
      OrganisationGUID,
      OrganisationKey,
      ScheduleDateTime,
      NumberOfExtractAttempts
    )
    SELECT
      OrganisationID,
      ISNULL(ServerInstance,'x'),
      ISNULL(DatabaseName,'x'),
      ISNULL(ConnectUID,'x'),
      ISNULL(ConnectPWD,'x'),
      ISNULL(DBChangeTrackVersion,-1),
      OrganisationGUID,
      OrganisationKey,
      ISNULL(ScheduleDateTime,@defaultDateTime),
      NumberOfExtractAttempts
    FROM
     (UPDATE
        Control.OrganisationController WITH (TABLOCKX)
      SET
        CurrentThreaduser         = @Threaduser,
        CurrentBatch              = @batchKey,
        LastProcessingAttemptDate = SYSUTCDATETIME(),
        ErrorEncountered          = 0,
        IsFinished                = 0,
        OrganisationKey           = (SELECT MAX(OrganisationKey)
                                     FROM [MiXData].dbo.DIM_Organisations do WITH (NOLOCK)
                                     WHERE do.HostID = oc.OrganisationID)
      OUTPUT
        DELETED.OrganisationID,
        DELETED.ServerInstance,
        DELETED.DatabaseName,
        DELETED.ConnectUID,
        DELETED.ConnectPWD,
        DELETED.DBChangeTrackVersion,
        DELETED.OrganisationGUID,
        INSERTED.OrganisationKey,
        DELETED.ScheduleDateTime,
        DELETED.NumberOfExtractAttempts
      FROM Control.OrganisationController oc
      WHERE OrganisationID = (SELECT TOP 1 OrganisationID
                              FROM CombinedStageUsers
                              WHERE IsFinished =1 and ScheduleDateTime <=@runTime 
                              ORDER BY
                                ScheduleDateTime,
                                ThreadPriority,
                                UTCOffsetPriority DESC,
                                OrganisationID)
    ) AS upd;
  END
  ELSE
  BEGIN
    SELECT
      @errorcode = 'This user has records assigned already - END';
  END;

  SELECT
    @organisationId          = ISNULL(OrganisationID,@organisationId),
    @serverInstance          = ISNULL(ServerInstance,@serverInstance),
    @databaseName            = ISNULL(DatabaseName,@databaseName),
    @ConnectUid              = ISNULL(ConnectUID,@ConnectUid),
    @connectPwd              = ISNULL(ConnectPWD,@connectPwd),
    @dbChangeTrackVersion    = ISNULL(DBChangeTrackVersion,@dbChangeTrackVersion),
    @organisationGUID        = ISNULL(OrganisationGUID,@organisationGUID),
    @organisationKey         = ISNULL(OrganisationKey,@organisationKey),
    @result                  = CASE
                                 WHEN OrganisationId IS NOT NULL THEN 0 -- continue ETL
                                 ELSE @result                           -- dont continue ETL
                               END,
    @scheduleDateTime        = ISNULL(ScheduleDateTime,@defaultDateTime),
    @numberOfExtractAttempts = ISNULL(NumberOfExtractAttempts,0),
    @isNewDatabase           = CASE
                                 WHEN
                                   1 > ISNULL((SELECT MAX(ChangeVersion)
                                               FROM Control.OrganisationTableController otc WITH (NOLOCK)
                                               WHERE otc.OrganisationKey = so.OrganisationKey),0)
                                   THEN 1
                                 ELSE 0
                               END,
    @SourceDBPrevMinTableChangeVersion = ISNULL((SELECT MIN(ChangeVersion) -- select top 10 *
                                          FROM [Control].OrganisationTableController otc WITH (NOLOCK)
                                          WHERE otc.OrganisationKey > 0
                                          AND otc.OrganisationKey = so.OrganisationKey),-1)
  FROM @selectedOrganisation so;

  SELECT @errorcode               ErrorCode,
         @batchKey                BatchID,
         @organisationId          OrganisationID,
         @serverInstance          ServerInstance,
         @databaseName            DatabaseName,
         @ConnectUid              ConnectUID,
         @connectPwd              ConnectPWD,
         @result                  ContinueEtl,
         @dbChangeTrackVersion    DBChangeTrackVersion,
         @organisationKey         OrganisationKey,
         @scheduleDateTime        ScheduleDateTime,
         @numberOfExtractAttempts NumberOfExtractAttempts,
         @isNewDatabase           IsNewDatabase,
         @SourceDBPrevMinTableChangeVersion SourceDBPrevMinTableChangeVersion;

  RETURN 0;
END

GO
/****** Object:  StoredProcedure [Control].[sprAnalyser_AddActivation]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprAnalyser_AddActivation]
(
  @inOrganisationKeyList  nvarchar(100),
  @inMainOrganisationID   int,
  @inMainOrganisationName nvarchar(200),
  @inUTCOffset            int,
  @inPackageType          nvarchar(20) = 'Standard',   ------'Custom' or 'Internal'
  @inScheduleTypeKey      int = 8,
  @inModelSourceName      nvarchar(60) = null,
  @inModelDisplayName     nvarchar(60) = null
)
AS
BEGIN
  SET NOCOUNT ON;

  declare @insertedactivationkey int ;
  declare @inModelSourceFolder  nvarchar(40);
  declare @currentUTCTime datetimeoffset(7) ;

  select @currentUTCTime = GETUTCDATE();

-- Update the row if it exists.    
  UPDATE [Control].[AnalyserActivations]
  SET
    [MainOrganisationName] = @inMainOrganisationName,
    [UTCOffset]            = @inUTCOffset
  WHERE	[MainOrganisationID]	= @inMainOrganisationID;
    
-- Insert the row if the UPDATE statement updated nothing.	
	IF (@@ROWCOUNT = 0 )
	BEGIN
		INSERT INTO [Control].[AnalyserActivations]
				   ([MainOrganisationID]
				   ,[OrganisationKeyList]
				   ,[MainOrganisationName]
				   ,[UTCOffset]
				   ,[IsRunning])
				  
			 VALUES
				   (@inMainOrganisationID,
				   @inOrganisationKeyList,
				   @inMainOrganisationName
				   ,@inUTCOffset
				   ,0) ;
		    select @insertedactivationkey =@@Identity
	END;
	ELSE
	--Get the activationkey
	SELECT TOP (1) @insertedactivationkey = activationkey
	FROM		[Control].[AnalyserActivations]
	WHERE		[MainOrganisationID] = @inMainOrganisationID ;
	
IF @inPackageType = 'Standard'
BEGIN
		;WITH MergeData ( ActivationKey,ReloadOrder,
						ReloadAfter,ReloadType,
						analyserSourceFolder,AnalyserSourceModel,
						AnalyserDisplayName,AnalyserOrgType,
						AnalyserOrgList,ScheduleTypeKey) 
		 AS
		  --Now Insert the relevant records into analyseractivations
		(SELECT				@insertedactivationkey, 0, 0,
		 N'Full', N'Models_Standard\', N'Make_QVDs.qvw', N'Make_QVDs.qvw', N'Key', @inOrganisationKeyList,@inScheduleTypeKey
		UNION ALL SELECT	@insertedactivationkey, 1, 0,
		 N'Full', N'Models_Standard\', N'Scoring.qvw', @inMainOrganisationName + ' - Scoring.qvw', N'Key', @inOrganisationKeyList,@inScheduleTypeKey
		UNION ALL SELECT	@insertedactivationkey, 1, 0,
		 N'Full', N'Models_Standard\', N'Events.qvw',  @inMainOrganisationName + ' - Events.qvw', N'Key', @inOrganisationKeyList,@inScheduleTypeKey
		UNION ALL SELECT	@insertedactivationkey, 1, 0,
		 N'Full', N'Models_Standard\', N'Movements.qvw',@inMainOrganisationName + ' - Movements.qvw', N'Key', @inOrganisationKeyList,@inScheduleTypeKey
		UNION ALL SELECT	@insertedactivationkey, 1, 0, 
		N'Full', N'Models_Standard\', N'Fuel.qvw', @inMainOrganisationName +' - Fuel.qvw', N'Key',@inOrganisationKeyList,@inScheduleTypeKey)

		MERGE INTO [Control].AnalyserModelAssignments dim
			 USING MergeData md
		ON
		  dim.ActivationKey					= md.ActivationKey
		  AND dim.analyserSourceFolder      = md.analyserSourceFolder
		  AND dim.AnalyserSourceModel		= md.AnalyserSourceModel
		  AND dim.ScheduleTypeKey			= md.ScheduleTypeKey
		WHEN MATCHED THEN
		  UPDATE SET
			ReloadOrder     = md.ReloadOrder,
			ReloadAfter		= md.ReloadAfter,
			ReloadType		= md.ReloadType,
			AnalyserOrgList	= md.AnalyserOrgList,
			ScheduleTypeKey	= md.ScheduleTypeKey
		WHEN NOT MATCHED BY TARGET THEN
		  INSERT (	ActivationKey,ReloadOrder,
					ReloadAfter,ReloadType,
					analyserSourceFolder,AnalyserSourceModel,
					AnalyserDisplayName,AnalyserOrgType,
					AnalyserOrgList,ScheduleTypeKey,NextReloadDateTime)
		  VALUES	(md.ActivationKey,md.ReloadOrder,
					md.ReloadAfter,md.ReloadType,md.analyserSourceFolder,
					md.AnalyserSourceModel,md.AnalyserDisplayName,
					md.AnalyserOrgType,md.AnalyserOrgList,md.ScheduleTypeKey,@currentUTCTime) ;
END;

ELSE --must be a custom or internal model	  
	BEGIN
	 select @inModelSourceFolder = 'Models_'+@inPackageType+'\' 
	 INSERT INTO [Control].AnalyserModelAssignments
			(ActivationKey,
			ReloadOrder,
			ReloadAfter,
			ReloadType,
			analyserSourceFolder,
			AnalyserSourceModel,
			AnalyserDisplayName,
			AnalyserOrgType,
			AnalyserOrgList,
			ScheduleTypeKey,
			NextReloadDateTime)
	 VALUES (@insertedactivationkey,
			1,
			0,
			'Full',
			@inModelSourceFolder,
			@inModelSourceName,
			@inModelDisplayName,
			'Key',
			@inOrganisationKeyList,
			@inScheduleTypeKey,
			@currentUTCTime)
	END;		
END;

GO
/****** Object:  StoredProcedure [Control].[sprAnalyser_RemoveActivationByOrgID]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprAnalyser_RemoveActivationByOrgID]
(
  @inOrganisationID int = 0
)
AS
BEGIN
  BEGIN TRY
    BEGIN TRANSACTION

    ---First delete all the models
    DELETE [Control].AnalyserModelAssignments
    WHERE Activationkey IN (SELECT ActivationKey
                            FROM [Control].AnalyserActivations
                            WHERE MainOrganisationID = @inOrganisationID);

    ---Then delete all the main activation records
    DELETE [Control].AnalyserActivations
    WHERE MainOrganisationID = @inOrganisationID;

    COMMIT TRANSACTION
  END TRY
  BEGIN CATCH
    ROLLBACK TRANSACTION
  END CATCH

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprArchiveMonitoringToHistory]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprArchiveMonitoringToHistory]
(
  @batchKey            int,
  @BatchDate		   DATE = NULL
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @MaxMonitorID BIGINT;
  DECLARE @MaxRID       BIGINT;
  DECLARE @DriveSpaceDriveLetters NVARCHAR(MAX);

  SELECT @MaxMonitorID = MAX(MonitorID)
  FROM [Control].PerformanceMonitor pm;

  SELECT @MaxRID = MAX(RID)
  FROM [Control].ProcProgressMonitor ppm;

  -- 0. Move to new ETL Performance structures
  SELECT @DriveSpaceDriveLetters = ConfiguredValue
  FROM [Control].SSIS_Configurations
  WHERE PackagePath = '\Package.Variables[User::DriveSpaceDriveLetters].Properties[Value]';

  EXEC [Control].sprFACT_DriveSpace_Transform @DriveLetters = @DriveSpaceDriveLetters;

  EXEC [Control].sprDIM_Tasks_Transform @ToMonitorID = @MaxMonitorID;
  EXEC [Control].sprDIM_Steps_Transform @ToRID = @MaxRID;

  EXEC [Control].sprFACT_TaskPerformance_Transform @ToMonitorID = @MaxMonitorID;
  EXEC [Control].sprFACT_StepPerformance_Transform @ToRID = @MaxRID;
  EXEC [Control].[sprFACT_BatchInfo_Transform] @BatchDate;

/*
  -- 1. Move PerformanceMonitor
  INSERT INTO [Control].PerformanceMonitorHistory
  (
    [MonitorID]            ,
    [BatchID]              ,
    [OrganisationKey]      ,
    [ThreadUser]           ,
    [ActionType]           ,
    [ActionObjectName]     ,
    [StepDescription]      ,
    [StepStartTime]        ,
    [StepEndTime]          ,
    [Errors]               ,
    [Issues]               ,
    [Alerts]               ,
    [RecordsInserted]      ,
    [RecordsType2Inserted] ,
    [RecordsUpdated]       ,
    [RecordsDeleted]       ,
    [RecordsRead]
  )
  SELECT 
    [MonitorID]            ,
    [BatchID]              ,
    [OrganisationKey]      ,
    [ThreadUser]           ,
    [ActionType]           ,
    [ActionObjectName]     ,
    [StepDescription]      ,
    [StepStartTime]        ,
    [StepEndTime]          ,
    [Errors]               ,
    [Issues]               ,
    [Alerts]               ,
    [RecordsInserted]      ,
    [RecordsType2Inserted] ,
    [RecordsUpdated]       ,
    [RecordsDeleted]       ,
    [RecordsRead]
  FROM [Control].PerformanceMonitor pm
  WHERE MonitorID <= @MaxMonitorID
  AND NOT EXISTS (SELECT 1
                  FROM [Control].PerformanceMonitorHistory pmh
                  WHERE pmh.[MonitorID] = pm.[MonitorID]);
*/

  DELETE [Control].PerformanceMonitor
  WHERE MonitorID <= @MaxMonitorID;

/*
  -- 2. Move ProcProgressMonitor
    SELECT
      RID            ,
      BatchID        ,
      OrganisationKey,
      ProcName       ,
      Flag           ,
      IsStartFlag    ,
      FlagSeq        = ROW_NUMBER() OVER (PARTITION BY ProcName,BatchID,OrganisationKey ORDER BY RID),
      FlagStartTime  ,
      FlagEndTime    ,
      DurationSeconds,
      DurationMinutes,
      NrOfRecordsAffected
    INTO #TmpProcProgressMonitor
    FROM [Control].ProcProgressMonitor WITH (NOLOCK)
    WHERE RID <= @MaxRID;

  CREATE INDEX IX_TmpProcProgressMonitor_BatchID_OrganisationKey_ProcName_FlagSeq ON #TmpProcProgressMonitor(BatchID,OrganisationKey,ProcName,FlagSeq);

  UPDATE
    pm1
  SET
    FlagStartTime      = CASE
                          WHEN pm1.IsStartFlag = 0 THEN pm2.FlagEndTime
                          ELSE pm1.FlagStartTime
                        END,
    DurationSeconds    = CASE
                           WHEN pm1.IsStartFlag = 1 THEN 0
                           ELSE
                             DATEDIFF(s,pm2.FlagEndTime,pm1.FlagEndTime)
                         END
                            ,
    DurationMinutes    = CASE
                           WHEN pm1.IsStartFlag = 1 THEN 0
                           ELSE
                             DATEDIFF(minute,pm2.FlagEndTime,pm1.FlagEndTime)
                         END
  FROM
    #TmpProcProgressMonitor pm1
      INNER JOIN
    #TmpProcProgressMonitor pm2 ON pm1.BatchID         = pm2.BatchID        
                               AND pm1.OrganisationKey = pm2.OrganisationKey
                               AND pm1.ProcName        = pm2.ProcName       
                               AND pm1.FlagSeq         = pm2.FlagSeq + 1;

  CREATE INDEX IX_TmpProcProgressMonitor_RID ON #TmpProcProgressMonitor(RID);

  INSERT INTO [Control].ProcProgressMonitorHistory
  ( 
    RID            ,
    BatchID        ,
    OrganisationKey,
    ProcName       ,
    Flag           ,
    IsStartFlag    ,
    FlagSeq        ,
    FlagStartTime  ,
    FlagEndTime    ,
    DurationSeconds,
    DurationMinutes,
    NrOfRecordsAffected
  )
  SELECT 
    RID            ,
    BatchID        ,
    OrganisationKey,
    ProcName       ,
    Flag           ,
    IsStartFlag    ,
    FlagSeq        ,
    FlagStartTime  ,
    FlagEndTime    ,
    DurationSeconds,
    DurationMinutes,
    NrOfRecordsAffected
  FROM
    #TmpProcProgressMonitor pf
  WHERE
    NOT EXISTS (SELECT 1
                FROM [Control].ProcProgressMonitorHistory pmh
                WHERE pmh.RID = pf.RID);
*/

  DELETE pm
  FROM
    [Control].ProcProgressMonitor pm
  WHERE pm.RID <= @MaxRID;

--  DROP TABLE #TmpProcProgressMonitor;

  RETURN 0;

END; -- end proc

GO
/****** Object:  StoredProcedure [Control].[sprBatch_ControllerChangeTrackVersion_Set]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==========================================================================================
-- Updates table Control.OrganisationTableController value for ExtractTableName = 'Organisation_CT'
--   to snapshot of Controller database ChangeTrackVersion
-- ==========================================================================================
CREATE PROCEDURE [Control].[sprBatch_ControllerChangeTrackVersion_Set]
(
  @controllerChangeTrackVersion bigint = -1
)
AS
BEGIN

  UPDATE
    [Control].OrganisationTableController
  SET
    ChangeVersion = @controllerChangeTrackVersion, 
    FullLoadFlag  = 0
  WHERE
      OrganisationKey  = -1
  AND ExtractTableName = 'Organisation_CT';

  RETURN 0;

END; -- end proc

GO
/****** Object:  StoredProcedure [Control].[sprBatch_ProcessOrganisations]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprBatch_ProcessOrganisations]  
  
AS  
SET NOCOUNT ON;  
  
DECLARE @removedOrganisations table  
( OrganisationID INT );  
  
INSERT INTO @removedOrganisations  
( OrganisationID )  
SELECT  
  OrganisationID  
FROM  
  ( MERGE Control.OrganisationController AS OC  
    USING  
    (  
      SELECT  
        liOrgID  
        ,sOrganisationName  
        ,CompanyGUID  
        ,sLanguage  
        ,sConnectServer  
        ,sConnectDatabase  
        ,sConnectUID  
        ,sConnectPWD  
        ,liGMTOffset  
        ,sDBVersion  
        ,bActive  
      FROM [StageControl].[Organisation]) as OrigOrg  ON oc.OrganisationID = OrigOrg.liOrgID  
      WHEN NOT MATCHED   
       AND OrigOrg.liOrgID > 0 and OrigOrg.bActive = 1  
        THEN  
          INSERT  
          (  
            OrganisationID,  
            OrganisationName,  
            OrganisationGUID,  
            ServerInstance,  
            DatabaseName,  
            ConnectUID,  
            ConnectPWD,  
            UTCOffset,  
            DBVersion,  
            bActive,  
            DWActive,  
            IsRemoved,
            ScheduleDateTime 
          )  
          VALUES  
          (  
            OrigOrg.liOrgID,  
            OrigOrg.sOrganisationName,  
            OrigOrg.CompanyGUID,  
            OrigOrg.sConnectServer,  
            OrigOrg.sConnectDatabase,  
            OrigOrg.sConnectUID,  
            OrigOrg.sConnectPWD,  
            OrigOrg.liGMTOffset,  
            OrigOrg.sDBVersion,  
            OrigOrg.bActive,  
            1,  
            0,
            dbo.fncGetNextSchedule(86400,OrigOrg.liGMTOffset)
          )  
      WHEN MATCHED THEN  
        UPDATE  
        SET  
          oc.OrganisationName = OrigOrg.sOrganisationName,   
          oc.ServerInstance   = OrigOrg.sConnectServer,  
          oc.DatabaseName     = OrigOrg.sConnectDatabase,  
          oc.ConnectUID       = OrigOrg.sConnectUID,  
          oc.ConnectPWD       = OrigOrg.sConnectPWD,  
          oc.UTCOffset        = OrigOrg.liGMTOffset,  
          oc.DBVersion        = OrigOrg.sDBVersion,  
          oc.bActive          = OrigOrg.bActive,  
          oc.OrganisationGUID = OrigOrg.CompanyGUID,  
          oc.IsRemoved        = 0  
      WHEN NOT MATCHED BY SOURCE   
       AND IsRemoved = 0 THEN  
        UPDATE  
        SET  
          oc.BActive   = 0,  
          oc.IsRemoved = 1  
        OUTPUT  
          $Action AS Operation,  
          DELETED.OrganisationID,  
          INSERTED.IsRemoved) removed  
WHERE  
    Operation = 'UPDATE'  
AND IsRemoved = 1;  
  
  
  INSERT INTO Control.WarehouseNotifications  
  (  
    NotificationType           ,  
    NotificationDateTime       ,  
    OrganisationID             ,  
    DatabaseName               ,  
    CurrentDBChangeTrackVersion,  
    ProcessingSlotHour         ,  
    NotificationUser           ,  
    IsBusyProcessing  
  )  
  SELECT  
    NotificationType     = 'Removed Database',  
    NotificationDateTime = SYSUTCDATETIME() ,  
    oc.OrganisationID,  
    oc.DatabaseName  ,  
    oc.DBChangeTrackVersion,  
    ProcessingSlotHour   = CASE   
                             WHEN oc.UTCOffset >= 0   
                               THEN 23-(oc.UTCOffset/(60*60))  
                             ELSE (-oc.UTCOffset/(60*60)) - 1  
                           END,  
    NotificationUser     = 'Automated',  
    IsBusyProcessing     = 0  
  FROM  
    @removedOrganisations          rmv  
      INNER JOIN  
    Control.OrganisationController oc  WITH (NOLOCK) ON oc.OrganisationID = rmv.OrganisationID;

GO
/****** Object:  StoredProcedure [Control].[sprBatchFinalize_Set]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==========================================================================================
-- Updates table Control.BatchController when last ThreadUser completes
-- ==========================================================================================
CREATE PROCEDURE [Control].[sprBatchFinalize_Set]
( 
  @batchKey        INT,
  @debugMode       INT = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON

  DECLARE @nrOfRecordsAffected int = 0;

  BEGIN TRY

    -- If BatchShouldStop is activated for this batch, then only need to look for active threads
    IF EXISTS (SELECT 1 
               FROM Control.BatchController
               WHERE 
                   BatchShouldStop = 1
               AND BatchID         = @batchKey )
    BEGIN
      
      UPDATE
        [Control].BatchController WITH (TABLOCKX)
      SET
        BatchEnd         = SYSUTCDATETIME(),
        BatchBusy        = 0
      WHERE
          BatchID = @batchKey
      AND NOT EXISTS (SELECT 1 -- All Organisations started with this BatchID and not yet finished
                      FROM Control.OrganisationController oc
                      WHERE
                          oc.bActive         = 1
                      AND oc.DWActive        = 1
                      AND oc.CurrentBatch    = @batchKey
                      AND oc.IsFinished      = 0);

      SELECT @nrOfRecordsAffected = @@ROWCOUNT;
      
      IF @debugMode = 1
        PRINT 'BatchShouldStop IS activated on this Batch. Records Affected: ' + CONVERT(NVARCHAR(5),@nrOfRecordsAffected);

    END
    ELSE
    BEGIN
      
      -- update if there is no active processes running for this batch anymore
      UPDATE
        [Control].BatchController WITH (TABLOCKX)
      SET
        BatchEnd         = SYSUTCDATETIME(),
        BatchBusy        = 0
      WHERE
          BatchID = @batchKey
      AND NOT EXISTS (SELECT 1 -- Organisations not yet started/done by this batch
                      FROM Control.OrganisationController oc
                      WHERE
                          oc.bActive       = 1
                      AND oc.DWActive      = 1
                      AND ISNULL(oc.CurrentBatch,0)  < @batchKey
                      UNION
                      SELECT 1 -- Organisations currently active/running for this batch
                      FROM Control.OrganisationController oc
                      WHERE
                          oc.bActive       = 1
                      AND oc.DWActive      = 1
                      AND oc.CurrentBatch  = @batchKey
                      AND oc.IsFinished    = 0);

      SELECT @nrOfRecordsAffected = @@ROWCOUNT;

      IF @debugMode = 1
        PRINT 'BatchShouldStop is NOT activated on this Batch. Records Affected: ' + CONVERT(NVARCHAR(5),@nrOfRecordsAffected);
      
      IF @nrOfRecordsAffected > 0
      BEGIN
        EXEC [Control].sprArchiveMonitoringToHistory @batchKey;
      END;
      
    END;
                    
  END TRY
  -- CATCH ERROR
  BEGIN CATCH
    EXEC Control.sprLogError;
    RETURN -1;
  END CATCH;

  RETURN 0
END -- end proc

GO
/****** Object:  StoredProcedure [Control].[sprCheckJobsEnabled]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprCheckJobsEnabled]
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @can_see_all_running_jobs INT             = ISNULL(IS_SRVROLEMEMBER(N'sysadmin'), 0);
  DECLARE @job_owner                SYSNAME         = SUSER_SNAME();
  DECLARE @job_id                   UNIQUEIDENTIFIER;

  DECLARE @xp_results TABLE
  ( 
    job_id                UNIQUEIDENTIFIER NOT NULL,  
    last_run_date         INT              NOT NULL,  
    last_run_time         INT              NOT NULL,  
    next_run_date         INT              NOT NULL,  
    next_run_time         INT              NOT NULL,  
    next_run_schedule_id  INT              NOT NULL,  
    requested_to_run      INT              NOT NULL, -- BOOL  
    request_source        INT              NOT NULL,  
    request_source_id     SYSNAME          COLLATE database_default NULL,  
    running               INT              NOT NULL, -- BOOL  
    current_step          INT              NOT NULL,  
    current_retry_attempt INT              NOT NULL,  
    job_state             INT              NOT NULL
  );

  DECLARE @job_statuses TABLE
  (
    job_id    UNIQUEIDENTIFIER NOT NULL,
    job_state INT,
    Processed INT
  );

  -- job_state
  -- Value Description
  -- 1  Executing.
  -- 2  Waiting for thread.
  -- 3  Between retries.
  -- 4  Idle.
  -- 5  Suspended.
  -- 7  Performing completion actions.

  -- get StageUser job list
  INSERT INTO @job_statuses
  SELECT
    job_id,
    -1,
    0
  FROM
    msdb.dbo.sysjobs_view
  WHERE
    name like 'StageUser%';

  -- loop through StageUser job list and get job status
  WHILE EXISTS (SELECT 1 FROM @job_statuses WHERE Processed = 0)
  BEGIN
    SELECT TOP 1 
      @job_id = job_id
    FROM @job_statuses
    WHERE Processed = 0;
    
    DELETE @xp_results;

    INSERT INTO @xp_results  
    EXECUTE master.dbo.xp_sqlagent_enum_jobs @can_see_all_running_jobs, @job_owner, @job_id;

    UPDATE
      @job_statuses
    SET
      Processed = 1,
      job_state = (SELECT MIN(job_state) FROM @xp_results)
    WHERE
      job_id = @job_id;

  END; -- end while

  ;WITH JobDetails AS
  (
    SELECT
      j.job_id,
      JobName               = j.name,
      j.Enabled,
      LastJobRunDateTime    = MAX(CASE
                                    WHEN jh.run_status IN (1,4) -- successful
                                      THEN
                                        CAST(
                                        STUFF(STUFF(CAST(jh.run_date as varchar),7,0,'-'),5,0,'-') + ' ' +
                                        STUFF(STUFF(REPLACE(STR(jh.run_time,6,0),' ','0'),5,0,':'),3,0,':') as datetime)
                                    ELSE NULL
                                  END)
    FROM
      msdb.dbo.sysjobs       j  WITH (NOLOCK)
        LEFT JOIN
      msdb.dbo.sysjobhistory jh WITH (NOLOCK) ON jh.job_id     = j.job_id
                                             AND jh.step_id    = 0
        LEFT JOIN
      msdb.dbo.syscategories sc WITH (NOLOCK) ON j.category_id = sc.category_id
    WHERE
        j.name        LIKE 'StageUser%'
    GROUP BY
      j.job_id,j.[name],j.Enabled
  ),
  LastJobActivity AS
  (
    SELECT
      a.job_id,
      MaxSessionID = MAX(a.session_id)
    FROM
      msdb.dbo.sysjobactivity a WITH (NOLOCK)
        INNER JOIN
      msdb.dbo.sysjobs        j WITH (NOLOCK) ON j.job_id = a.job_id
    WHERE j.name LIKE 'StageUser%'
    GROUP BY
      a.job_id
  )
  SELECT
    NumberOfJobsEnabled    = ISNULL(SUM(CONVERT(INT,jd.[Enabled])),0),
    LastJobRunDateTime     = ISNULL(MAX(jd.LastJobRunDateTime),'19000101'),
    MinutesSinceLastJobRun = ISNULL(DATEDIFF(s,MAX(jd.LastJobRunDateTime),GETDATE())/60,10000),
    NumberOfJobsInProgress = (SELECT COUNT(1)
                              FROM
                                @job_statuses
                              WHERE
                                job_state in (1,2,3,7)), -- In Progress
    MaxMinutesInProgress   = MAX(CASE
                                   WHEN js.job_state in (1,2,3,7) THEN DATEDIFF(s,a.start_execution_date,GETDATE())/60
                                   ELSE 0
                                 END),
    CurrentDateTime        = GETDATE()
--    a.run_requested_date,a.start_execution_date,a.stop_execution_date,jd.*,js.*
  FROM
    JobDetails      jd
      LEFT JOIN
    @job_statuses   js ON js.job_id = jd.job_id
      LEFT JOIN
    LastJobActivity ja ON ja.job_id = jd.job_id
      INNER JOIN
    msdb.dbo.sysjobactivity a WITH (NOLOCK) ON a.job_id = ja.job_id AND a.session_id = ja.MaxSessionID;

  RETURN 0;

END; -- end proc

GO
/****** Object:  StoredProcedure [Control].[sprCreateNewBatch]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprCreateNewBatch]
(
  @isInitialRun    BIT           = 0
)
AS
SET NOCOUNT ON;

-- States:  0 = unknown, 1 = New Batch, 2 = Existing Batch, 3 = Last Batch Failed!, 4 = Existing Batch Requested to Stop
DECLARE @batchState           int = 0;
DECLARE @batchKey             int = 0;
DECLARE @deltaBatchStartRange int = 1000000; -- after initial run, delta batches should start from this range onwards

BEGIN TRANSACTION;

SELECT TOP (1)
  @batchKey    = BatchID,
  @batchState = CASE
                  WHEN HasFailed = 1 THEN
                    3
                  WHEN BatchBusy = 1 AND BatchShouldStop = 1 AND BatchEnd IS NOT NULL THEN
                    4
                  WHEN BatchBusy = 1 and BatchEnd IS NULL THEN
                    2
                  ELSE
                    1
                END
FROM
  Control.BatchController WITH (TABLOCKX)
ORDER BY
  BatchID DESC;
    
  IF @@ROWCOUNT = 0 -- This is the first batch ever
  BEGIN
    SET @batchKey = 0;
    SET @batchState = 1;
  END;

IF @batchState < 2 
  BEGIN
  
    -- if it is the initial run, just increment the batchid, else if delta run then start off with @deltaBatchStartRange if last batchid < @deltaBatchStartRange
    IF @isInitialRun = 0 AND @batchKey < @deltaBatchStartRange
    BEGIN
      SET @batchKey = @deltaBatchStartRange;
    END
    ELSE
    BEGIN
      SET @batchKey += 1;
    END -- end if
    
    INSERT INTO Control.BatchController
            (BatchID,  BatchBusy, BatchStart,   BatchEnd, BatchDBToComplete, BatchDBCompleted, BatchShouldStop, WaitForIOUserImport, WaitForIOUserWrite, HasFailed)
      SELECT @batchKey, 1,         SYSUTCDATETIME(), NULL,     COUNT(*),          NULL,             0,               NULL,                NULL,               0
      FROM
        Control.OrganisationController;
     
  END

COMMIT TRANSACTION;

SELECT
  @batchState BatchState,  @batchKey    BatchID;

GO
/****** Object:  StoredProcedure [Control].[sprDeleteAllUserSchemaIndexes]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprDeleteAllUserSchemaIndexes]
@ownername NVARCHAR (50)='XXX'
AS
IF NOT @ownername LIKE 'StageUser%'
  BEGIN
    RAISERROR ('Invalid schema name supplied for parameter', 16, 1) WITH SETERROR
    RETURN
  END

DECLARE @tablename SYSNAME 
DECLARE @indexname SYSNAME 
DECLARE @sql NVARCHAR(4000) 
DECLARE dropindexes CURSOR FOR 

SELECT sys.indexes.name, sys.objects.name, sys.schemas.name 
FROM sys.indexes 
JOIN sys.objects ON sys.indexes.object_id = sys.objects.object_id 
JOIN sys.schemas ON sys.objects.schema_id = sys.schemas.schema_id 
WHERE sys.objects.TYPE = N'U' 
  and sys.schemas.name = @ownername
  and sys.objects.name not like '%ROLLBACK%'
  and sys.objects.name not like '%STAGE_%'
  and sys.indexes.name is not null
  and sys.indexes.is_primary_key =0
  ORDER BY sys.indexes.index_id DESC 
  

OPEN dropindexes 
FETCH NEXT FROM dropindexes INTO @indexname, @tablename, @ownername 
WHILE @@fetch_status = 0 
BEGIN 
  SET @sql = N'DROP INDEX '+QUOTENAME(@indexname)+'ON '+ QUOTENAME(@ownername)+'.'+QUOTENAME(@tablename) 
  PRINT @sql 
  EXEC sp_executesql @sql   
  FETCH NEXT FROM dropindexes INTO @indexname, @tablename, @ownername 
END 
CLOSE dropindexes 
DEALLOCATE dropindexes

GO
/****** Object:  StoredProcedure [Control].[sprDIM_Steps_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprDIM_Steps_Transform]
(
  @ToRID BIGINT
)
AS
BEGIN
  SET NOCOUNT ON;

  ;WITH
  StepsList AS
  (
    SELECT
      ProcName,
      Flag,
      Sequance     = DENSE_RANK() OVER (PARTITION BY ProcName, Flag ORDER BY RID),
      StepSequence = DENSE_RANK() OVER (PARTITION BY BatchID,OrganisationKey,ProcName ORDER BY RID)
    FROM [Control].ProcProgressMonitor ppm WITH (NOLOCK)
    WHERE RID <= @ToRID
  ),
  UniqueStepsList AS
  (
    SELECT
      StepName     = ppm.Flag,
      ppm.ProcName,
      StepSequence = MAX(ppm.StepSequence),
      TaskKey      = ISNULL(dts.TaskKey,-1)
    FROM
      StepsList           ppm
        LEFT JOIN
      [Control].DIM_Tasks dts WITH (NOLOCK) ON dts.TaskName = SUBSTRING(ppm.ProcName,4,LEN(ppm.ProcName)-13)
                                           AND dts.TaskType = 'Transform'
    WHERE ppm.StepSequence = 1 -- only use first task instance
    GROUP BY
      ppm.Flag,
      ppm.ProcName,
      dts.TaskKey
  )
  MERGE INTO [Control].[DIM_Steps] tar
  USING UniqueStepsList stg
     ON tar.StepName = stg.StepName
    AND tar.ProcName = stg.ProcName
  WHEN MATCHED THEN
    UPDATE
    SET
      tar.StepSequence = stg.StepSequence,
      tar.TaskKey      = stg.TaskKey
  WHEN NOT MATCHED THEN
    INSERT
    (
      StepName    ,
      ProcName    ,
      StepSequence,
      TaskKey
    )
    VALUES
    (
      stg.StepName    ,
      stg.ProcName    ,
      stg.StepSequence,
      stg.TaskKey
    );

  SELECT NrOfRecordsAffected = @@ROWCOUNT;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprDIM_Steps_Transform_Historic]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprDIM_Steps_Transform_Historic]
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @MaxBatchID INT;
  SELECT @MaxBatchID = MAX(BatchID)
  FROM [Control].ProcProgressMonitorHistory ppm WITH (NOLOCK);
  
  ;WITH
  StepsList AS
  (
    SELECT
      ProcName,
      Flag,
      StepSequence = MAX(FlagSeq)
    FROM [Control].ProcProgressMonitorHistory ppm WITH (NOLOCK)
    WHERE ppm.BatchID <= @MaxBatchID
    GROUP BY
      ProcName,
      Flag
  ),
  UniqueStepsList AS
  (
    SELECT
      StepName     = ppm.Flag,
      ppm.ProcName,
      StepSequence = ppm.StepSequence,
      TaskKey      = ISNULL(dts.TaskKey,-1)
    FROM
      StepsList           ppm
        LEFT JOIN
      [Control].DIM_Tasks dts WITH (NOLOCK) ON dts.TaskName = SUBSTRING(ppm.ProcName,4,LEN(ppm.ProcName)-13)
                                           AND dts.TaskType = 'Transform'
  )
  MERGE INTO [Control].[DIM_Steps] tar
  USING UniqueStepsList stg
     ON tar.StepName = stg.StepName
    AND tar.ProcName = stg.ProcName
  WHEN MATCHED THEN
    UPDATE
    SET
      tar.StepSequence = stg.StepSequence,
      tar.TaskKey      = stg.TaskKey
  WHEN NOT MATCHED THEN
    INSERT
    (
      StepName    ,
      ProcName    ,
      StepSequence,
      TaskKey
    )
    VALUES
    (
      stg.StepName    ,
      stg.ProcName    ,
      stg.StepSequence,
      stg.TaskKey
    );

  SELECT NrOfRecordsAffected = @@ROWCOUNT;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprDIM_Tasks_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprDIM_Tasks_Transform]
(
  @ToMonitorID BIGINT
)
AS
BEGIN
  SET NOCOUNT ON;

  ;WITH
  UniqueTasksList AS
  (
    SELECT DISTINCT
      ActionObjectName,
      ActionType
    FROM [Control].PerformanceMonitor WITH (NOLOCK)
    WHERE MonitorID <= @ToMonitorID
  )
  MERGE INTO [Control].[DIM_Tasks] tar
  USING UniqueTasksList stg
     ON tar.TaskName = stg.ActionObjectName
    AND tar.TaskType = stg.ActionType
  WHEN NOT MATCHED THEN
    INSERT
    (
      TaskName,
      TaskType
    )
    VALUES
    (
      stg.ActionObjectName,
      stg.ActionType
    );

  SELECT NrOfRecordsAffected = @@ROWCOUNT;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprDIM_Tasks_Transform_Historic]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprDIM_Tasks_Transform_Historic]
AS
BEGIN
  SET NOCOUNT ON;

  ;WITH
  UniqueTasksList AS
  (
    SELECT DISTINCT
      ActionObjectName,
      ActionType
    FROM [Control].PerformanceMonitorHistory WITH (NOLOCK)
  )
  MERGE INTO [Control].[DIM_Tasks] tar
  USING UniqueTasksList stg
     ON tar.TaskName = stg.ActionObjectName
    AND tar.TaskType = stg.ActionType
  WHEN NOT MATCHED THEN
    INSERT
    (
      TaskName,
      TaskType
    )
    VALUES
    (
      stg.ActionObjectName,
      stg.ActionType
    );

  SELECT NrOfRecordsAffected = @@ROWCOUNT;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprDriverApp_GetRegisteredDriverOrganisations]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprDriverApp_GetRegisteredDriverOrganisations]
AS
BEGIN
  SET NOCOUNT ON;
  
  SELECT OrganisationKey,OrganisationID
  FROM [Control].DriverAppCache
  WHERE ScheduleDateTime < DATEADD(HOUR,1+DATEPART(HOUR,SYSUTCDATETIME()),CONVERT(DATETIMEOFFSET(0),CONVERT(DATE,SYSUTCDATETIME())))
  AND ISNULL(NumberOfAttempts,0) < 3
  ORDER BY OrganisationID;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprDriverApp_OrganisationFail]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprDriverApp_OrganisationFail]
( 
  @organistionID    INT,
  @ErrorDescription NVARCHAR(MAX)
)
AS
BEGIN
  SET NOCOUNT ON;
  
  DECLARE @scheduleDateTime DATETIMEOFFSET(0) = (SELECT LastProcessingCompleteDate FROM [Control].OrganisationController WITH (NOLOCK)
                                                 WHERE OrganisationID = @organistionID);
  
  SELECT @scheduleDateTime = DATEADD(HOUR,2,DATEADD(DAY,1,@scheduleDateTime));

  UPDATE dac
  SET
    ScheduleDateTime = DATEADD(MINUTE,5,SYSUTCDATETIME()),
    NumberOfAttempts = NumberOfAttempts + 1,
    ErrorDescription = @ErrorDescription
  FROM [Control].DriverAppCache dac
  WHERE OrganisationID = @organistionID

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprDriverApp_OrganisationSuccess]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprDriverApp_OrganisationSuccess]
( @organistionID INT )
AS
BEGIN
  SET NOCOUNT ON;
  
  DECLARE @scheduleDateTime DATETIMEOFFSET(0) = (SELECT LastProcessingCompleteDate FROM [Control].OrganisationController WITH (NOLOCK)
                                                 WHERE OrganisationID = @organistionID);
  
  SELECT @scheduleDateTime = DATEADD(HOUR,2,DATEADD(DAY,1,@scheduleDateTime));

  UPDATE dac
  SET
    LastProcessingCompleteDate = SYSUTCDATETIME(),
    ScheduleDateTime           = @scheduleDateTime,
    NumberOfAttempts           = 0,
    ErrorDescription           = ''
  FROM [Control].DriverAppCache dac
  WHERE OrganisationID = @organistionID

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprDropAllUserSchemaObjects]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE procedure [Control].[sprDropAllUserSchemaObjects]
@stageuser nvarchar(50) = 'XXX'
as

IF NOT @stageuser LIKE 'StageUser%'
  BEGIN
    RAISERROR ('Invalid schema name supplied for parameter', 16, 1) WITH SETERROR
    RETURN
  END

declare @name  varchar(100)
declare @xtype char(1)
declare @sqlstring nvarchar(1000)

declare AllSPViews_cursor cursor for
  select @stageuser + '.'+ o.name,o.type
  from [sys].[objects] o, [sys].[schemas] s
  where o.schema_id = s.schema_id
  and s.name = @stageuser

open AllSPViews_cursor

fetch next from AllSPViews_cursor into @name, @xtype

while @@fetch_status = 0
  begin
-- obtain object type if it is a stored procedure or view
   if @xtype = 'P'
      begin
        set @sqlstring = 'drop procedure ' + @name
        exec sp_executesql @sqlstring
        set @sqlstring = ' '
      end
-- obtain object type if it is a view or stored procedure
   if @xtype = 'V'
      begin
         set @sqlstring = 'drop view ' + @name
         exec sp_executesql @sqlstring
         set @sqlstring = ' '
      end
-- obtain object type if it is a table
   if @xtype = 'U'
      begin
         set @sqlstring = 'drop table ' + @name
         exec sp_executesql @sqlstring
         set @sqlstring = ' '
      end      

    fetch next from AllSPViews_cursor into @name, @xtype
  end

close AllSPViews_cursor
deallocate AllSPViews_cursor

GO
/****** Object:  StoredProcedure [Control].[sprFACT_BatchInfo_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprFACT_BatchInfo_Transform]
(
  @BatchDate DATE = NULL
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @ServerTimeZoneInMinutes INT = DATEDIFF(minute, GETUTCDATE(), GETDATE());
  DECLARE @StartDateTime DATETIME;
  DECLARE @EndDateTime   DATETIME;
  DECLARE @BatchKey      DATE;

  SET @BatchDate = coalesce(@BatchDate, CONVERT(DATE,GETDATE()))
  SELECT 
    @BatchKey      = DATEADD(DAY,-1,CONVERT(DATE,@BatchDate)),
    @StartDateTime = DATEADD(HOUR,-12,TODATETIMEOFFSET(CONVERT(DATETIMEOFFSET(0),CONVERT(DATE,@BatchDate)),@ServerTimeZoneInMinutes)),
    @EndDateTime   = DATEADD(HOUR, 12,TODATETIMEOFFSET(CONVERT(DATETIMEOFFSET(0),CONVERT(DATE,@BatchDate)),@ServerTimeZoneInMinutes));

  CREATE TABLE #Retries
  (
    OrganisationKey  INT NOT NULL PRIMARY KEY CLUSTERED,
    RetryCount       INT NULL
  );

  ;WITH
  Retries AS
  (
    SELECT
      OrganisationKey,
      ActionType,
      ActionObjectName,
      COUNT(1) AS RetryCount
    FROM [Control].PerformanceMonitor WITH (NOLOCK)
    GROUP BY
      OrganisationKey,
      ActionType,
      ActionObjectName
    HAVING COUNT(1) > 1 
  )
  INSERT INTO #Retries
  (
    OrganisationKey,
    RetryCount
  )
  SELECT
    OrganisationKey,
    MAX(RetryCount)
  FROM Retries
  GROUP BY
    OrganisationKey;

  --Return Data  
  ;WITH 
  DriveSpace(ID,DiskSpaceTotalGb,DiskSpaceAvailableGb) AS
  (
    SELECT
      1,
      DiskSpaceTotalGb     = SUM(CapacityGB),
      DiskSpaceAvailableGb = SUM(FreeSpaceGB)
    FROM [Control].FACT_DriveSpace WITH (NOLOCK)
    WHERE BatchKey = @BatchKey
  ),
  -- Nr of retries will be MAX(count(1))
  NrOfErrors AS
  (
    SELECT
      OrganisationKey,
      NrOfErrors = ISNULL(COUNT(1),0)
    FROM [Control].ErrorLog WITH (NOLOCK)
    WHERE ErrorTime BETWEEN @StartDateTime AND @EndDateTime
    GROUP BY OrganisationKey
  ),
  MergeResults AS
  (
    SELECT 
      BatchKey     = @BatchKey,
      oc.OrganisationKey,

      StartDateKey = CONVERT(DATE,SWITCHOFFSET(oc.LastProcessingAttemptDate, @ServerTimeZoneInMinutes)),
      StartTimeKey = DATEDIFF(s,CONVERT(DATE,SWITCHOFFSET(oc.LastProcessingAttemptDate, @ServerTimeZoneInMinutes)),CONVERT(DATETIME,SWITCHOFFSET(oc.LastProcessingAttemptDate, @ServerTimeZoneInMinutes))),
      EndDateKey   = CONVERT(DATE,SWITCHOFFSET(oc.LastProcessingCompleteDate, @ServerTimeZoneInMinutes)),
      EndTimeKey   = DATEDIFF(s,CONVERT(DATE,SWITCHOFFSET(oc.LastProcessingCompleteDate, @ServerTimeZoneInMinutes)),CONVERT(DATETIME,SWITCHOFFSET(oc.LastProcessingCompleteDate, @ServerTimeZoneInMinutes))),

      DurationInSeconds = DATEDIFF(s,oc.LastProcessingAttemptDate,oc.LastProcessingCompleteDate),
      
      RunStatus         = CASE
                            WHEN oc.LastProcessingCompleteDate > oc.LastProcessingAttemptDate 
                              THEN 0
                            ELSE 1
                          END,
      IsFirstRun        = CASE
                            WHEN
                              1   > ISNULL((SELECT MAX(ChangeVersion)
                                            FROM [Control].OrganisationTableController so WITH (NOLOCK)
                                            WHERE so.OrganisationKey = oc.OrganisationKey),0)
                            AND NOT EXISTS (SELECT 1
                                            FROM [Control].OrganisationControllerHistory otc WITH (NOLOCK)
                                            WHERE otc.OrganisationKey = oc.OrganisationKey)

                              THEN 1
                            ELSE 0
                          END,
       IsRestoredDB     = CASE
                            WHEN
                             (1 > ISNULL((SELECT MAX(ChangeVersion)
                                         FROM [Control].OrganisationTableController   otc WITH (NOLOCK)
                                         WHERE otc.OrganisationKey = oc.OrganisationKey),0))
                            AND EXISTS  (SELECT 1
                                         FROM [Control].OrganisationControllerHistory otc WITH (NOLOCK)
                                         WHERE otc.OrganisationKey = oc.OrganisationKey)
                              THEN 1
                            ELSE 0
                          END,
        NrOfRetries  = ISNULL(r.RetryCount,0),
        NrOfErrors   = e.NrOfErrors,
        ActiveThread = RIGHT(oc.CurrentThreaduser,1),
        d.DiskSpaceAvailableGb,
        d.DiskSpaceTotalGb
     FROM
       [Control].OrganisationController oc
         CROSS JOIN
       DriveSpace                       d
         LEFT JOIN
       NrOfErrors                       e ON e.OrganisationKey = oc.OrganisationKey
         LEFT JOIN
       #Retries                         r ON r.OrganisationKey = oc.OrganisationKey
     WHERE oc.OrganisationKey > 0
  )
  MERGE INTO [Control].FACT_BatchInfo tar
  USING MergeResults stg
     ON tar.BatchKey        = stg.BatchKey
    AND tar.OrganisationKey = stg.OrganisationKey
    WHEN NOT MATCHED THEN
      INSERT
      (
        BatchKey,
        OrganisationKey,
        StartDateKey,
        StartTimeKey,
        EndDateKey,
        EndTimeKey,
        DurationInSeconds,
        RunStatus,
        NrOfErrors,
        NrOfRetries,
        DiskSpaceAvailableGb,
        DiskSpaceTotalGb,   
        IsFirstRun,     
        IsRestoredDB,
        ActiveThread
      )  
      VALUES 
      (
        stg.BatchKey,
        stg.OrganisationKey,
        stg.StartDateKey,
        stg.StartTimeKey,
        stg.EndDateKey,
        stg.EndTimeKey,
        stg.DurationInSeconds,
        stg.RunStatus,
        stg.NrOfErrors,     
        stg.NrOfRetries,
        stg.DiskSpaceAvailableGb,
        stg.DiskSpaceTotalGb,
        stg.IsFirstRun,
        stg.IsRestoredDB,
        stg.ActiveThread
      );

  SELECT NrOfRecordsAffected = @@ROWCOUNT;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprFACT_BatchInfo_Transform_Historic]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprFACT_BatchInfo_Transform_Historic]
(
  @fromDate DATE = '20110101',
  @toDate DATE = NULL
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @ServerTimeZoneInMinutes INT = DATEDIFF(minute, GETUTCDATE(), GETDATE());
  DECLARE @StartDateTime DATETIME;
  DECLARE @EndDateTime   DATETIME;
  DECLARE @BatchKey      DATE;
  DECLARE @LoopDate      DATE;

  SET @toDate = coalesce(@toDate, CONVERT(DATE,GETDATE()))

  SELECT
    @LoopDate      = @fromDate,
    @BatchKey      = DATEADD(DAY,-1,CONVERT(DATE,@fromDate)),
    @StartDateTime = DATEADD(HOUR,-12,TODATETIMEOFFSET(CONVERT(DATETIMEOFFSET(0),CONVERT(DATE,@fromDate)),@ServerTimeZoneInMinutes)),
    @EndDateTime   = DATEADD(HOUR, 12,TODATETIMEOFFSET(CONVERT(DATETIMEOFFSET(0),CONVERT(DATE,@fromDate)),@ServerTimeZoneInMinutes));

  CREATE TABLE #Retries
  (
    OrganisationKey  INT NOT NULL PRIMARY KEY CLUSTERED,
    RetryCount       INT NULL
  );

  CREATE TABLE #OrganisationController
  (
    OrganisationKey            INT NOT NULL PRIMARY KEY CLUSTERED,
    CurrentThreadUser          INT NULL,
    LastProcessingAttemptDate  DATETIMEOFFSET(7),
    LastProcessingCompleteDate DATETIMEOFFSET(7)
  );

  WHILE (@LoopDate <= @toDate)
  BEGIN
    TRUNCATE TABLE #Retries;
    TRUNCATE TABLE #OrganisationController;
    
    ;WITH
    Retries AS
    (
      SELECT
        OrganisationKey,
        ActionType,
        ActionObjectName,
        COUNT(1) AS RetryCount
      FROM [Control].PerformanceMonitorHistory WITH (NOLOCK)
      WHERE StepStartTime BETWEEN @StartDateTime AND @EndDateTime
      GROUP BY
        OrganisationKey,
        ActionType,
        ActionObjectName
      HAVING COUNT(1) > 1 
    )
    INSERT INTO #Retries
    (
      OrganisationKey,
      RetryCount
    )
    SELECT
      OrganisationKey,
      MAX(RetryCount)
    FROM Retries
    GROUP BY
      OrganisationKey;

    ;WITH
    LastOrgData AS
    (
      SELECT
        OrganisationKey,
        MaxRID = MAX(RID)
      FROM [Control].OrganisationControllerHistory WITH (NOLOCK)
      WHERE ChangeDate < @EndDateTime
      AND OrganisationKey IS NOT NULL
      GROUP BY OrganisationKey
    )
    INSERT INTO #OrganisationController
    (
      OrganisationKey,
      CurrentThreaduser,
      LastProcessingAttemptDate,
      LastProcessingCompleteDate
    )
    SELECT
      och.OrganisationKey,
      RIGHT(och.CurrentThreaduser,1),
      och.LastProcessingAttemptDate,
      och.LastProcessingCompleteDate
    FROM
      LastOrgData lod
        INNER JOIN
      [Control].OrganisationControllerHistory och WITH (NOLOCK) ON och.RID = lod.MaxRID;

    --Return Data  
    ;WITH 
    DriveSpace(DiskSpaceTotalGb,DiskSpaceAvailableGb) AS
    (
      SELECT
        DiskSpaceTotalGb     = 0.0,
        DiskSpaceAvailableGb = 0.0
    ),
    -- Nr of retries will be MAX(count(1))
    NrOfErrors AS
    (
      SELECT
        OrganisationKey,
        NrOfErrors = ISNULL(COUNT(1),0)
      FROM [Control].ErrorLog WITH (NOLOCK)
      WHERE ErrorTime BETWEEN @StartDateTime AND @EndDateTime
      GROUP BY OrganisationKey
    ),
    MergeResults AS
    (
      SELECT 
        BatchKey     = @BatchKey,
        oc.OrganisationKey,

        StartDateKey = CONVERT(DATE,SWITCHOFFSET(oc.LastProcessingAttemptDate, @ServerTimeZoneInMinutes)),
        StartTimeKey = DATEDIFF(s,CONVERT(DATE,SWITCHOFFSET(oc.LastProcessingAttemptDate, @ServerTimeZoneInMinutes)),CONVERT(DATETIME,SWITCHOFFSET(oc.LastProcessingAttemptDate, @ServerTimeZoneInMinutes))),
        EndDateKey   = CONVERT(DATE,SWITCHOFFSET(oc.LastProcessingCompleteDate, @ServerTimeZoneInMinutes)),
        EndTimeKey   = DATEDIFF(s,CONVERT(DATE,SWITCHOFFSET(oc.LastProcessingCompleteDate, @ServerTimeZoneInMinutes)),CONVERT(DATETIME,SWITCHOFFSET(oc.LastProcessingCompleteDate, @ServerTimeZoneInMinutes))),

        DurationInSeconds = DATEDIFF(s,oc.LastProcessingAttemptDate,oc.LastProcessingCompleteDate),
        
        RunStatus         = CASE
                              WHEN oc.LastProcessingCompleteDate > oc.LastProcessingAttemptDate 
                                THEN 0
                              ELSE 1
                            END,
        IsFirstRun        = CASE
                              WHEN
                                1   > ISNULL((SELECT MAX(ChangeVersion)
                                              FROM [Control].OrganisationTableControllerHistory so WITH (NOLOCK)
                                              WHERE so.OrganisationKey  = oc.OrganisationKey
                                              AND so.ChangeDate         < @EndDateTime),0)
                              AND NOT EXISTS (SELECT 1
                                              FROM [Control].OrganisationControllerHistory oth WITH (NOLOCK)
                                              WHERE oth.OrganisationKey = oc.OrganisationKey
                                              AND oth.ChangeDate        < @EndDateTime)

                                THEN 1
                              ELSE 0
                            END,
         IsRestoredDB     = CASE
                              WHEN
                               (1 > ISNULL((SELECT MAX(ChangeVersion)
                                           FROM [Control].OrganisationTableControllerHistory so WITH (NOLOCK)
                                           WHERE so.OrganisationKey  = oc.OrganisationKey
                                           AND so.ChangeDate         < @EndDateTime),0))
                              AND EXISTS  (SELECT 1
                                           FROM [Control].OrganisationControllerHistory oth WITH (NOLOCK)
                                           WHERE oth.OrganisationKey = oc.OrganisationKey
                                           AND oth.ChangeDate        < @EndDateTime)
                                THEN 1
                              ELSE 0
                            END,
          NrOfRetries  = ISNULL(r.RetryCount,0),
          NrOfErrors   = e.NrOfErrors,
          ActiveThread = CONVERT(INT,RIGHT(oc.CurrentThreaduser,1)),
          d.DiskSpaceAvailableGb,
          d.DiskSpaceTotalGb
       FROM
         #OrganisationController oc
           CROSS JOIN
         DriveSpace              d
           LEFT JOIN
         NrOfErrors              e ON e.OrganisationKey = oc.OrganisationKey
           LEFT JOIN
         #Retries                r ON r.OrganisationKey = oc.OrganisationKey
    )
    MERGE INTO [Control].FACT_BatchInfo tar
    USING MergeResults stg
       ON tar.BatchKey        = stg.BatchKey
      AND tar.OrganisationKey = stg.OrganisationKey
      WHEN NOT MATCHED THEN
        INSERT
        (
          BatchKey,
          OrganisationKey,
          StartDateKey,
          StartTimeKey,
          EndDateKey,
          EndTimeKey,
          DurationInSeconds,
          RunStatus,
          NrOfErrors,
          NrOfRetries,
          DiskSpaceAvailableGb,
          DiskSpaceTotalGb,   
          IsFirstRun,     
          IsRestoredDB,
          ActiveThread
        )  
        VALUES 
        (
          stg.BatchKey,
          stg.OrganisationKey,
          stg.StartDateKey,
          stg.StartTimeKey,
          stg.EndDateKey,
          stg.EndTimeKey,
          stg.DurationInSeconds,
          stg.RunStatus,
          stg.NrOfErrors,     
          stg.NrOfRetries,
          stg.DiskSpaceAvailableGb,
          stg.DiskSpaceTotalGb,
          stg.IsFirstRun,
          stg.IsRestoredDB,
          stg.ActiveThread
        );

    SET @LoopDate = DATEADD(DAY,1,CONVERT(DATE,@LoopDate))
    SELECT
      @BatchKey      = DATEADD(DAY,-1,CONVERT(DATE,@LoopDate)),
      @StartDateTime = DATEADD(HOUR,-12,TODATETIMEOFFSET(CONVERT(DATETIMEOFFSET(0),CONVERT(DATE,@LoopDate)),@ServerTimeZoneInMinutes)),
      @EndDateTime   = DATEADD(HOUR, 12,TODATETIMEOFFSET(CONVERT(DATETIMEOFFSET(0),CONVERT(DATE,@LoopDate)),@ServerTimeZoneInMinutes));
  END;

  SELECT NrOfRecordsAffected = @@ROWCOUNT;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprFACT_DriveSpace_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprFACT_DriveSpace_Transform]
(
  @DriveLetters varchar(50),
  @BatchDate DATE = NULL
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @ServerTimeZoneInMinutes INT = 120;
  DECLARE @BatchKey                DATE;
  DECLARE @serverName NVARCHAR(200) = CASE
                                        WHEN CHARINDEX('\',@@SERVERNAME) > 0
                                          THEN LEFT(@@SERVERNAME,CHARINDEX('\',@@SERVERNAME)-1)
                                        ELSE @@SERVERNAME
                                      END;

  DECLARE @DriveSpace TABLE
  (
    DriveLetter       varchar(100),
    CapacityGB        Decimal(10,2),
    UsedSpaceGB       Decimal(10,2),
    FreeSpaceGB       Decimal(10,2),
    PercentFreeSpace  Decimal(10,2)
  );

  SET @BatchKey = coalesce(DATEADD(DAY,-1,@BatchDate), DATEADD(DAY,-1,CONVERT(DATE,GETDATE())));

  --Populate Variables
  INSERT INTO @DriveSpace
  EXEC dbo.sprDriveSpace @serverName=@serverName;
      
  ;WITH
  PerformanceData AS
  (     
    SELECT
      @BatchKey AS BatchKey,
      d.DriveLetter     ,
      d.CapacityGB      ,
      d.UsedSpaceGB     ,
      d.FreeSpaceGB     ,
      d.PercentFreeSpace
    FROM
      @DriveSpace d 
        INNER JOIN
      dbo.UnpackText(@DriveLetters) i ON i.TextColumn = d.DriveLetter
  )
  MERGE INTO [Control].[FACT_DriveSpace] tar
  USING PerformanceData stg
     ON tar.BatchKey  = stg.BatchKey
    AND tar.DriveName = stg.DriveLetter
    WHEN NOT MATCHED THEN
      INSERT
      (
        BatchKey         ,
        DriveName        ,
        CapacityGB       ,
        UsedSpaceGB      ,
        FreeSpaceGB      ,
        PercentFreeSpace
      )
      VALUES
      (
        stg.BatchKey         ,
        stg.DriveLetter      ,
        stg.CapacityGB       ,
        stg.UsedSpaceGB      ,
        stg.FreeSpaceGB      ,
        stg.PercentFreeSpace
      );

  SELECT NrOfRecordsAffected = @@ROWCOUNT;
  
  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprFACT_StepPerformance_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprFACT_StepPerformance_Transform] 
(
  @ToRID INT = 0   --0 value would process all records.
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @ServerTimeZoneInMinutes  INT = DATEDIFF(minute, GETUTCDATE(), GETDATE());
  DECLARE @LastStepPerformanceKey   INT = 0

  SELECT @LastStepPerformanceKey  = ISNULL(MAX(StepPerformanceKey),0)
    FROM [Control].[FACT_StepPerformance] WITH (NOLOCK);

  SELECT @ToRID = MAX(p.RID) 
    FROM [Control].ProcProgressMonitor  p  WITH (NOLOCK);

  --Some Procedures do not correctly SET the IsStartFlag for first step and as a result would show incorrect start end times and duration.
  UPDATE MiXStaging.Control.ProcProgressMonitor
  SET IsStartFlag = 1
  WHERE Flag = '5.1 Merge Existing Records' 
    AND ProcName = 'sprFACT_VehicleCosts_Transform'
    AND IsStartFlag = 0;

  -- old proc monitoring
  ;WITH 
  TaskSteps AS 
  (
    SELECT T.TaskKey, T.TaskName, T.TaskType, S.StepKey, S.StepName
    FROM [Control].DIM_Tasks T INNER JOIN [Control].DIM_Steps S
    ON T.TaskKey = S.TaskKey
  ),
  PerformanceData AS
  (
    SELECT
      RID            ,
      BatchID        ,
      OrganisationKey,
      ProcName       ,
      Flag           ,
      IsStartFlag    ,
      BatchDate      = CASE
                       WHEN DATEPART(HOUR,CONVERT(DATETIME,SWITCHOFFSET(FlagStartTime, @ServerTimeZoneInMinutes))) < 12
                         THEN CONVERT(DATE,(DATEADD(DAY,-1,SWITCHOFFSET(FlagEndTime, @ServerTimeZoneInMinutes))))
                       ELSE CONVERT(DATE,SWITCHOFFSET(FlagStartTime, @ServerTimeZoneInMinutes))
                       END,
      FlagSeq        = ROW_NUMBER() OVER (PARTITION BY BatchID,OrganisationKey, ProcName ORDER BY RID),
      FlagStartTime  = SWITCHOFFSET(FlagStartTime, @ServerTimeZoneInMinutes),
      FlagEndTime    = SWITCHOFFSET(FlagEndTime  , @ServerTimeZoneInMinutes),
      NrOfRecordsAffected
    FROM
      [Control].ProcProgressMonitor WITH (NOLOCK)
    WHERE RID >= @LastStepPerformanceKey +1 
      AND RID <= (CASE WHEN @ToRID=0 THEN RID ELSE @ToRID END)  --0 value would process all records.
      AND FlagSeq <= 0
  )
  ,
  MergeResults_base AS 
  (
    SELECT
    pm1.IsStartFlag,
    PM1.RID,
    PM1.FlagSeq,
    BatchKey          = CONVERT(VARCHAR(8), pm1.BatchDate, 112),
    FlagStartTime     = CASE
                          WHEN pm1.IsStartFlag = 0 THEN ISNULL(pm2.FlagEndTime,pm1.FlagStartTime)
                          ELSE pm1.FlagStartTime
                        END,
    PM1.FlagEndTime  ,
    DurationSeconds    = CASE
                           WHEN pm1.IsStartFlag = 1 THEN 0
                           ELSE
                             DATEDIFF(s,ISNULL(pm2.FlagEndTime,pm1.FlagEndTime),pm1.FlagEndTime)
                         END
                            ,
    DurationMinutes    = CASE
                           WHEN pm1.IsStartFlag = 1 THEN 0
                           ELSE
                             DATEDIFF(MINUTE,ISNULL(pm2.FlagEndTime,pm1.FlagEndTime),pm1.FlagEndTime)                             
                         END
  FROM
    PerformanceData pm1
      LEFT JOIN
    PerformanceData pm2 ON pm1.BatchID         = pm2.BatchID
                       AND pm1.OrganisationKey = pm2.OrganisationKey
                       AND pm1.ProcName        = pm2.ProcName       
                       AND pm2.FlagSeq         = pm1.FlagSeq - 1
  )
  ,
  MergeResults AS
  (
    SELECT 
      StepPerformanceKey    = p1.RID,
      FlagSeq               = p1.FlagSeq,
      seq2                  = p2.FlagSeq,
      StepKey               = ISNULL(t.StepKey,-1), 
      OrganisationKey       = p1.OrganisationKey,
      StartDateKey          = CONVERT(DATE,p2.FlagStartTime),
      StartTimeKey          = DATEDIFF(s, CONVERT(DATE,p2.FlagStartTime), CONVERT(DATETIME,p2.FlagStartTime)),
      BatchKey               = p2.BatchKey,
      FlagEndTime           = CONVERT(DATE, p1.FlagEndTime),    
      FlagStartTime         = p2.FlagStartTime, 
      DurationSeconds       = p2.DurationSeconds,
      NrOfRecordsAffected   = p1.NrOfRecordsAffected
    FROM
      PerformanceData p1
        INNER JOIN 
      MergeResults_base p2  ON p1.FlagSeq = p2.FlagSeq 
                           AND p1.RID = p2.RID 
        LEFT JOIN 
      TaskSteps t           ON  t.TaskName = SUBSTRING(p1.ProcName,4,LEN(p1.ProcName)-13)
                           AND  t.TaskType = 'Transform'
                           AND  t.StepName = p1.Flag 
  )  
  MERGE INTO [Control].[FACT_StepPerformance] tar
   USING MergeResults stg
      ON tar.StepPerformanceKey = stg.StepPerformanceKey
   WHEN NOT MATCHED THEN
     INSERT
     (
       StepPerformanceKey, 
       StepKey, 
       StepSequence,
       OrganisationKey, 
       StartDateKey, 
       StartTimeKey, 
       BatchKey, 
       StepStartDateTime,
       StepEndDateTime, 
       DurationInSeconds, 
       NrOfRecordsAffected
     )  
     VALUES 
     (
       stg.StepPerformanceKey,
       stg.StepKey, 
       stg.FlagSeq,
       stg.OrganisationKey ,
       stg.StartDateKey,
       stg.StartTimeKey,
       stg.BatchKey,
       stg.FlagStartTime,
       stg.FlagEndTime,
       stg.DurationSeconds,
       stg.NrOfRecordsAffected
     );

  -- new proc monitoring
  ;WITH
  TaskSteps AS 
  (
    SELECT T.TaskKey, T.TaskName, T.TaskType, S.StepKey, S.StepName
    FROM [Control].DIM_Tasks T INNER JOIN [Control].DIM_Steps S
    ON T.TaskKey = S.TaskKey
  ),
  MergeResults AS
  (
    SELECT 
      StepPerformanceKey    = p.RID,
      StepKey               = ISNULL(t.StepKey,-1), 
      FlagSeq               = p.FlagSeq,
      OrganisationKey       = p.OrganisationKey,
      StartDateKey          = CONVERT(DATE,SWITCHOFFSET(p.FlagStartTime, @ServerTimeZoneInMinutes)),
      StartTimeKey          = DATEDIFF(s, CONVERT(DATE,SWITCHOFFSET(p.FlagStartTime, @ServerTimeZoneInMinutes)), CONVERT(DATETIME,SWITCHOFFSET(p.FlagStartTime, @ServerTimeZoneInMinutes))),
      BatchKey              = CASE
                                WHEN DATEPART(HOUR,CONVERT(DATETIME,SWITCHOFFSET(FlagStartTime, @ServerTimeZoneInMinutes))) < 12
                                  THEN CONVERT(VARCHAR(8),CONVERT(DATE,(DATEADD(DAY,-1,SWITCHOFFSET(FlagEndTime, @ServerTimeZoneInMinutes)))), 112)
                                ELSE CONVERT(VARCHAR(8),CONVERT(DATE,SWITCHOFFSET(FlagStartTime, @ServerTimeZoneInMinutes)), 112)
                              END,
      FlagStartTime         = SWITCHOFFSET(p.FlagStartTime, @ServerTimeZoneInMinutes), 
      FlagEndTime           = SWITCHOFFSET(p.FlagEndTime  , @ServerTimeZoneInMinutes),
      DurationSeconds       = p.DurationSeconds,
      NrOfRecordsAffected   = p.NrOfRecordsAffected
    FROM
      [Control].ProcProgressMonitor p WITH (NOLOCK)
        LEFT JOIN 
      TaskSteps t           ON  t.TaskName = SUBSTRING(p.ProcName,4,LEN(p.ProcName)-13)
                           AND  t.TaskType = 'Transform'
                           AND  t.StepName = p.Flag 
    WHERE RID >= @LastStepPerformanceKey +1 
    AND RID <= (CASE WHEN @ToRID=0 THEN RID ELSE @ToRID END)  --0 value would process all records.
    AND p.FlagSeq > 0
  )
  MERGE INTO [Control].[FACT_StepPerformance] tar
   USING MergeResults stg
      ON tar.StepPerformanceKey = stg.StepPerformanceKey
   WHEN NOT MATCHED THEN
     INSERT
     (
       StepPerformanceKey, 
       StepKey, 
       StepSequence,
       OrganisationKey, 
       StartDateKey, 
       StartTimeKey, 
       BatchKey, 
       StepStartDateTime,
       StepEndDateTime, 
       DurationInSeconds, 
       NrOfRecordsAffected
     )  
     VALUES 
     (
       stg.StepPerformanceKey,
       stg.StepKey, 
       stg.FlagSeq,
       stg.OrganisationKey ,
       stg.StartDateKey,
       stg.StartTimeKey,
       stg.BatchKey,
       stg.FlagStartTime,
       stg.FlagEndTime,
       stg.DurationSeconds,
       stg.NrOfRecordsAffected
     );

  SELECT NrOfRecordsAffected = @@ROWCOUNT;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprFACT_StepPerformance_Transform_Historic]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprFACT_StepPerformance_Transform_Historic] 
AS
BEGIN
  SET NOCOUNT ON;
  DECLARE @MinRID BIGINT;
  DECLARE @MaxRID BIGINT;
  DECLARE @LoopID       BIGINT;
  DECLARE @BatchSize    BIGINT = 100000;
  DECLARE @NrOfRecordsAffected BIGINT = 0;

  DECLARE @ServerTimeZoneInMinutes  INT = DATEDIFF(minute, GETUTCDATE(), GETDATE());

  SELECT
    @MinRID = MIN(RID),
    @MaxRID = MAX(RID)
  FROM [Control].ProcProgressMonitorHistory pm WITH (NOLOCK);

  SET @LoopID = @MinRID;

  WHILE (@LoopID < @MaxRID)
  BEGIN

    ;WITH
    MergeResults AS
    (
      SELECT
        StepPerformanceKey = pph.RID,
        pph.OrganisationKey,
        pph.NrOfRecordsAffected,
        pph.DurationSeconds,
        pph.DurationMinutes,
        StepKey        = ISNULL(ds.StepKey,-1),
        TaskKey        = ISNULL(ds.TaskKey,-1),
        StepSequence   = pph.FlagSeq,
        FlagStartTime  = SWITCHOFFSET(pph.FlagStartTime, @ServerTimeZoneInMinutes),
        FlagEndTime    = SWITCHOFFSET(pph.FlagEndTime  , @ServerTimeZoneInMinutes),
        StartTimeKey   = DATEDIFF(SECOND,CONVERT(DATE,SWITCHOFFSET(pph.FlagStartTime, @ServerTimeZoneInMinutes)),CONVERT(DATETIME,SWITCHOFFSET(pph.FlagStartTime, @ServerTimeZoneInMinutes))),
        StartDateKey   =  CONVERT(DATE, SWITCHOFFSET(pph.FlagStartTime, @ServerTimeZoneInMinutes)),
        BatchKey       = CASE
                           WHEN DATEPART(HOUR,CONVERT(DATETIME,SWITCHOFFSET(pph.FlagStartTime, @ServerTimeZoneInMinutes))) < 12
                             THEN CONVERT(DATE,(DATEADD(DAY,-1,SWITCHOFFSET(pph.FlagEndTime, @ServerTimeZoneInMinutes))))
                           ELSE CONVERT(DATE,SWITCHOFFSET(pph.FlagStartTime, @ServerTimeZoneInMinutes))
                         END
      FROM
        [Control].ProcProgressMonitorHistory pph WITH (NOLOCK)
          LEFT JOIN
        [Control].DIM_Steps                  ds  WITH (NOLOCK) ON ds.ProcName = pph.ProcName
                                                              AND ds.StepName = pph.Flag
      WHERE pph.RID BETWEEN @LoopID AND @LoopID + @BatchSize
    )
    MERGE INTO [Control].[FACT_StepPerformance] tar
     USING MergeResults stg
        ON tar.StepPerformanceKey = stg.StepPerformanceKey
     WHEN NOT MATCHED THEN
       INSERT
       (
         StepPerformanceKey, 
         StepKey, 
         StepSequence,
         OrganisationKey, 
         StartDateKey, 
         StartTimeKey, 
         BatchKey, 
         StepStartDateTime,
         StepEndDateTime, 
         DurationInSeconds, 
         NrOfRecordsAffected
       )  
       VALUES 
       (
         stg.StepPerformanceKey,
         stg.StepKey, 
         stg.StepSequence,
         stg.OrganisationKey ,
         stg.StartDateKey,
         stg.StartTimeKey,
         stg.BatchKey,
         stg.FlagStartTime,
         stg.FlagEndTime,
         stg.DurationSeconds,
         stg.NrOfRecordsAffected
       );

    SET @NrOfRecordsAffected = @NrOfRecordsAffected + @@ROWCOUNT;

    SET @LoopID = @LoopID + @BatchSize + 1;
    PRINT CONVERT(NVARCHAR(20),@LoopID);
  END; -- end while

  SELECT NrOfRecordsAffected = @NrOfRecordsAffected;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprFACT_TaskPerformance_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprFACT_TaskPerformance_Transform]
(
  @ToMonitorID BIGINT
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @ServerTimeZoneInMinutes INT = DATEDIFF(minute, GETUTCDATE(), GETDATE());

  ;WITH
  BatchData AS
  (
    SELECT
      BatchID,
      OrganisationKey,
      BatchKey = CASE
                   WHEN DATEPART(HOUR,CONVERT(DATETIME,SWITCHOFFSET(MIN(pm.StepStartTime), @ServerTimeZoneInMinutes))) < 12
                     THEN CONVERT(DATE,SWITCHOFFSET(DATEADD(DAY,-1,MIN(pm.StepStartTime)), @ServerTimeZoneInMinutes))
                   ELSE CONVERT(DATE,SWITCHOFFSET(MIN(pm.StepStartTime), @ServerTimeZoneInMinutes))
                 END
    FROM [Control].PerformanceMonitor pm WITH (NOLOCK)
    WHERE MonitorID <= @ToMonitorID
    GROUP BY
      BatchID,
      OrganisationKey
  ),
  PerformanceData AS
  (
    SELECT
      TaskPerformanceKey   = pm.MonitorID,
      TaskKey              = ISNULL(dt.TaskKey,-1), -- select 
      pm.OrganisationKey,
      ThreadUserKey        = CONVERT(INT,RIGHT(pm.ThreadUser,1)),
      StartDateKey         = CONVERT(DATE,SWITCHOFFSET(pm.StepStartTime, @ServerTimeZoneInMinutes)),
      StartTimeKey         = DATEDIFF(s,CONVERT(DATE,SWITCHOFFSET(pm.StepStartTime, @ServerTimeZoneInMinutes)),CONVERT(DATETIME,SWITCHOFFSET(pm.StepStartTime, @ServerTimeZoneInMinutes))),
      BatchKey              = bd.BatchKey,
      TaskStartDateTime    = SWITCHOFFSET(pm.StepStartTime, @ServerTimeZoneInMinutes),
      TaskEndDateTime      = SWITCHOFFSET(pm.StepEndTime, @ServerTimeZoneInMinutes),
      DurationInSeconds    = DATEDIFF(s,CAST(StepStartTime as datetimeoffset(0)),CAST(StepEndTime as datetimeoffset(0))),
      Errors               = ISNULL(pm.Errors,0),
      RecordsInserted      = ISNULL(pm.RecordsInserted,0),
      RecordsType2Inserted = ISNULL(pm.RecordsType2Inserted,0),
      RecordsUpdated       = ISNULL(pm.RecordsUpdated,0),
      RecordsDeleted       = ISNULL(pm.RecordsDeleted,0)
    FROM
      [Control].PerformanceMonitor pm WITH (NOLOCK)
        LEFT JOIN
      [Control].DIM_Tasks          dt WITH (NOLOCK) ON dt.TaskName = pm.ActionObjectName
                                                   AND dt.TaskType = pm.ActionType
        LEFT JOIN
      BatchData                    bd               ON bd.BatchID         = pm.BatchID
                                                   AND bd.OrganisationKey = pm.OrganisationKey
    WHERE MonitorID <= @ToMonitorID
  )
  MERGE INTO [Control].[FACT_TaskPerformance] tar
  USING PerformanceData stg
     ON tar.TaskPerformanceKey = stg.TaskPerformanceKey
  WHEN NOT MATCHED THEN
    INSERT
    (
      TaskPerformanceKey   ,
      TaskKey              ,
      OrganisationKey      ,
      ThreadUserKey        ,
      StartDateKey         ,
      StartTimeKey         ,
      BatchKey             ,
      TaskStartDateTime    ,
      TaskEndDateTime      ,
      DurationInSeconds    ,
      Errors               ,
      RecordsInserted      ,
      RecordsType2Inserted ,
      RecordsUpdated       ,
      RecordsDeleted
    )
    VALUES
    (
      stg.TaskPerformanceKey   ,
      stg.TaskKey              ,
      stg.OrganisationKey      ,
      stg.ThreadUserKey        ,
      stg.StartDateKey         ,
      stg.StartTimeKey         ,
      stg.BatchKey             ,
      stg.TaskStartDateTime    ,
      stg.TaskEndDateTime      ,
      stg.DurationInSeconds    ,
      stg.Errors               ,
      stg.RecordsInserted      ,
      stg.RecordsType2Inserted ,
      stg.RecordsUpdated       ,
      stg.RecordsDeleted
    );

  SELECT NrOfRecordsAffected = @@ROWCOUNT;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprFACT_TaskPerformance_Transform_Historic]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprFACT_TaskPerformance_Transform_Historic]
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @ServerTimeZoneInMinutes INT = DATEDIFF(minute, GETUTCDATE(), GETDATE());
  DECLARE @NrOfRecordsAffected BIGINT = 0;
  DECLARE @MinMonitorID BIGINT;
  DECLARE @MaxMonitorID BIGINT;
  DECLARE @LoopID       BIGINT;
  DECLARE @BatchSize    BIGINT = 100000;

  CREATE TABLE #BatchData
  (
    BatchID         INT NOT NULL,
    OrganisationKey INT NOT NULL,
    BatchKey        DATE NULL
  );

  INSERT INTO #BatchData
  (
    BatchID        ,
    OrganisationKey,
    BatchKey
  )
  SELECT
    BatchID,
    OrganisationKey,
    BatchKey = CASE
                 WHEN DATEPART(HOUR,CONVERT(DATETIME,SWITCHOFFSET(MIN(pm.StepStartTime), @ServerTimeZoneInMinutes))) < 12
                   THEN CONVERT(DATE,SWITCHOFFSET(DATEADD(DAY,-1,MIN(pm.StepStartTime)), @ServerTimeZoneInMinutes))
                 ELSE CONVERT(DATE,SWITCHOFFSET(MIN(pm.StepStartTime), @ServerTimeZoneInMinutes))
               END
  FROM [Control].PerformanceMonitorHistory pm WITH (NOLOCK)
  GROUP BY
    BatchID,
    OrganisationKey;

  CREATE CLUSTERED INDEX IX_BatchData ON #BatchData(BatchID, OrganisationKey);

  SELECT
    @MinMonitorID = MIN(MonitorID),
    @MaxMonitorID = MAX(MonitorID)
  FROM [Control].PerformanceMonitorHistory pm WITH (NOLOCK);
  
  SET @LoopID = @MinMonitorID;

  WHILE (@LoopID < @MaxMonitorID)
  BEGIN
    ;WITH
    PerformanceData AS
    (
      SELECT
        TaskPerformanceKey   = pm.MonitorID,
        TaskKey              = ISNULL(dt.TaskKey,-1), -- select 
        pm.OrganisationKey,
        ThreadUserKey        = CONVERT(INT,RIGHT(pm.ThreadUser,1)),
        StartDateKey         = CONVERT(DATE,SWITCHOFFSET(pm.StepStartTime, @ServerTimeZoneInMinutes)),
        StartTimeKey         = DATEDIFF(s,CONVERT(DATE,SWITCHOFFSET(pm.StepStartTime, @ServerTimeZoneInMinutes)),CONVERT(DATETIME,SWITCHOFFSET(pm.StepStartTime, @ServerTimeZoneInMinutes))),
        BatchKey             = bd.BatchKey,
        TaskStartDateTime    = SWITCHOFFSET(pm.StepStartTime, @ServerTimeZoneInMinutes),
        TaskEndDateTime      = SWITCHOFFSET(pm.StepEndTime, @ServerTimeZoneInMinutes),
        DurationInSeconds    = DATEDIFF(s,CAST(StepStartTime as datetimeoffset(0)),CAST(StepEndTime as datetimeoffset(0))),
        Errors               = ISNULL(pm.Errors,0),
        RecordsInserted      = ISNULL(pm.RecordsInserted,0),
        RecordsType2Inserted = ISNULL(pm.RecordsType2Inserted,0),
        RecordsUpdated       = ISNULL(pm.RecordsUpdated,0),
        RecordsDeleted       = ISNULL(pm.RecordsDeleted,0)
      FROM -- select count(1) from
        [Control].PerformanceMonitorHistory pm WITH (NOLOCK)
          LEFT JOIN
        [Control].DIM_Tasks                 dt WITH (NOLOCK) ON dt.TaskName        = pm.ActionObjectName
                                                            AND dt.TaskType        = pm.ActionType
          LEFT JOIN
        #BatchData                          bd               ON bd.BatchID         = pm.BatchID
                                                            AND bd.OrganisationKey = pm.OrganisationKey
      WHERE pm.MonitorID BETWEEN @LoopID AND @LoopID + @BatchSize
    )
    MERGE INTO [Control].[FACT_TaskPerformance] tar
    USING PerformanceData stg
       ON tar.TaskPerformanceKey = stg.TaskPerformanceKey
    WHEN NOT MATCHED THEN
      INSERT
      (
        TaskPerformanceKey   ,
        TaskKey              ,
        OrganisationKey      ,
        ThreadUserKey        ,
        StartDateKey         ,
        StartTimeKey         ,
        BatchKey             ,
        TaskStartDateTime    ,
        TaskEndDateTime      ,
        DurationInSeconds    ,
        Errors               ,
        RecordsInserted      ,
        RecordsType2Inserted ,
        RecordsUpdated       ,
        RecordsDeleted
      )
      VALUES
      (
        stg.TaskPerformanceKey   ,
        stg.TaskKey              ,
        stg.OrganisationKey      ,
        stg.ThreadUserKey        ,
        stg.StartDateKey         ,
        stg.StartTimeKey         ,
        stg.BatchKey             ,
        stg.TaskStartDateTime    ,
        stg.TaskEndDateTime      ,
        stg.DurationInSeconds    ,
        stg.Errors               ,
        stg.RecordsInserted      ,
        stg.RecordsType2Inserted ,
        stg.RecordsUpdated       ,
        stg.RecordsDeleted
      );

    SET @NrOfRecordsAffected = @NrOfRecordsAffected + @@ROWCOUNT;

    SET @LoopID = @LoopID + @BatchSize + 1;
    PRINT CONVERT(NVARCHAR(20),@LoopID);
  END; -- end while

  SELECT NrOfRecordsAffected = @NrOfRecordsAffected;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprLogError]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- uspLogError logs error information in the ErrorLog table about the 
-- error that caused execution to jump to the CATCH block of a 
-- TRY...CATCH construct. This should be executed from within the scope 
-- of a CATCH block otherwise it will return without inserting error 
-- information. 
CREATE PROCEDURE [Control].[sprLogError] 
(
  @organisationKey  int = -1,       -- specifies the organisation for which the error was logged
  @errorLogID       int = 0 OUTPUT, -- contains the ErrorLogID of the row inserted
  @reRaiserror      bit = 1,         -- 1 = raise the error again after write to log table, 0 = don't
  @nrOfErrors       int = 1
) 
AS                               -- by uspLogError in the ErrorLog table
BEGIN
  SET NOCOUNT ON;

  DECLARE @number    int            = ERROR_NUMBER();
  DECLARE @procedure nvarchar (132) = ERROR_PROCEDURE();
  DECLARE @line      int            = ERROR_LINE();
  DECLARE @severity  tinyint        = ERROR_SEVERITY();
  DECLARE @state     tinyint        = ERROR_STATE();
  DECLARE @message   nvarchar (max) = ERROR_MESSAGE();

  -- Output parameter value of 0 indicates that error 
  -- information was not logged
  SET @ErrorLogID = 0;

  BEGIN TRY
    -- Return if there is no error information to log
    IF @number IS NULL
      BEGIN
        RETURN;
      END;

    -- Return if inside an uncommittable transaction. Data insertion/modification is not allowed when
    --   a transaction is in an uncommittable state.
    IF XACT_STATE() = -1
      BEGIN
        PRINT 'Cannot log error since the current transaction is in an uncommittable state. ' 
            + 'Rollback the transaction before executing sprLogError in order to successfully log error information.';
        RETURN;
      END;

    INSERT INTO [Control].[ErrorLog] 
    ( OrganisationKey,
      UserName,
      ErrorNumber,
      ErrorSeverity,
      ErrorState,
      ErrorProcedure,
      ErrorLine, 
      ErrorMessage,
      NrOfErrors )
    VALUES
    ( @organisationKey,
      CONVERT(sysname, CURRENT_USER),
      @number,
      @severity,
      @state,
      @procedure,
      @line,
      @message,
      @nrOfErrors );

    SET @errorLogID = SCOPE_IDENTITY();
  END TRY
  BEGIN CATCH
    PRINT 'An error occurred in stored procedure sprLogError: ';
    EXECUTE [Control].[sprPrintError];
    RETURN -1;
  END CATCH

  IF @reRaiserror = 1
    RAISERROR(N'Error %d in Procedure %s, line %d: %s. Please check [Control].ErrorLog where ErrorLogID = %d for details.', @severity, @state, @number, @procedure, @line, @message, @ErrorLogID);

END -- end proc

GO
/****** Object:  StoredProcedure [Control].[sprMaintenance_GetIndexStats]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprMaintenance_GetIndexStats]
(
  @DBName                           NVARCHAR(255),
  @ApplyLogging                     BIT = 1,
  @SchemaList                       NVARCHAR(255) = '''dbo''', -- remember quotes around schema list for now
  @TableName                        NVARCHAR(255) = NULL,
  @IndexName                        NVARCHAR(255) = NULL,
  @ReturnResults                    BIT = 1
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @sql           NVARCHAR(MAX);
  DECLARE @DB_ID         INT;
  DECLARE @RID           INT;
  DECLARE @startDateTime DATETIMEOFFSET = SYSUTCDATETIME();

  CREATE TABLE #IndexStatsSnapshot  
  (  
    RID                         INT IDENTITY(1,1) PRIMARY KEY CLUSTERED NOT NULL,  
    SnapShotDateTime            DATETIMEOFFSET(0) NOT NULL,  
    SnapShotEndDateTime         DATETIMEOFFSET(0) NULL,
    SchemaName                  NVARCHAR(255) COLLATE DATABASE_DEFAULT NOT NULL,
    TableName                   NVARCHAR(255) COLLATE DATABASE_DEFAULT NOT NULL,
    IndexName                   NVARCHAR(255) COLLATE DATABASE_DEFAULT NOT NULL,
    IndexType                   NVARCHAR(50)  COLLATE DATABASE_DEFAULT NULL,
    IndexAllocUnitType          NVARCHAR(50)  COLLATE DATABASE_DEFAULT NULL,
    PartitionNumber             INT NULL,
    PartitionMonthKey           INT NULL,
    AvgFragmentationPerc        FLOAT NULL,
    AvgFragmentationSizeInPages FLOAT NULL,
    PartitionPageCount          BIGINT NULL,
    PartitionRows               BIGINT NULL
  );  

  SELECT @DBName = CASE
                     WHEN CHARINDEX('.',@DBName) > 0 
                     AND  CHARINDEX('[',@DBName) = 0
                       THEN '[' + @DBName + ']'
                     ELSE @DBName
                   END;

  -- get DB id
  SELECT @DB_ID = DB_ID(REPLACE(REPLACE(@DBName,'[',''),']',''));
  
  IF (@TableName IS NOT NULL AND @IndexName IS NOT NULL)  -- specific index on table
  BEGIN
    SET @sql =
    'SELECT
      SYSUTCDATETIME(),
      SchemaName = OBJECT_SCHEMA_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + ')
      TableName  = OBJECT_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + '),
      IndexName  = si.name,  
      dps.index_type_desc,  
      IndexAllocUnitType = dps.alloc_unit_type_desc,
      dps.partition_number,  
      dps.avg_fragmentation_in_percent,  
      dps.avg_fragment_size_in_pages,  
      dps.page_count,  
      p.rows  
    FROM 
       ' + @DBName + '.sys.dm_db_index_physical_stats(' + CONVERT(NVARCHAR(10),@DB_ID) + ', NULL, NULL , NULL, N''LIMITED'') dps  
        INNER JOIN
       ' + @DBName + '.sys.sysindexes si ON dps.OBJECT_ID = si.ID   
                   AND dps.INDEX_ID  = si.INDID  
        INNER JOIN
      ' + @DBName + '.sys.partitions p  ON p.object_id = si.id  
                       AND p.index_id  = si.indid  
                       AND p.partition_number = dps.partition_number  
    WHERE  
        OBJECT_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + ') = ''' + @tableName + '''' + '
    AND OBJECT_SCHEMA_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + ') IN (' + @SchemaList + ')
    AND si.name                                   = ''' + @indexName + '''' + '
    UNION
    SELECT
      SYSUTCDATETIME(),
      SchemaName = OBJECT_SCHEMA_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + ')
      TableName  = OBJECT_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + '),
      IndexName  = si.name,
      dps.index_type_desc,
      IndexAllocUnitType = dps.alloc_unit_type_desc,
      dps.partition_number,
      dps.avg_fragmentation_in_percent,  
      dps.avg_fragment_size_in_pages,  
      dps.page_count,  
      NumberOfRows = null  
    FROM  
      ' + @DBName + '.sys.dm_db_index_physical_stats(' + CONVERT(NVARCHAR(10),@DB_ID) + ', NULL, NULL , NULL, N''LIMITED'') dps  
        INNER JOIN  
      ' + @DBName + '.sys.spatial_indexes si WITH (NOLOCK) ON dps.object_id      = si.object_id  
                                          AND dps.index_id       = si.index_id  
    WHERE  
        OBJECT_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + ') = ''' + @tableName + '''' + '
    AND OBJECT_SCHEMA_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + ') IN (' + @SchemaList + ')
    AND si.name                                   = ''' + @indexName + ''';'

    INSERT INTO #IndexStatsSnapshot  
    (  
      SnapShotDateTime           ,
      SchemaName                 ,
      TableName                  ,
      IndexName                  ,
      IndexType                  ,
      IndexAllocUnitType         ,
      PartitionNumber            ,
      AvgFragmentationPerc       ,
      AvgFragmentationSizeInPages,
      PartitionPageCount,  
      PartitionRows  
    )
    EXEC (@sql);

    UPDATE #IndexStatsSnapshot  
    SET SnapShotEndDateTime = SYSUTCDATETIME()  
    WHERE  
        TableName = @tableName  
    AND IndexName = @indexName;  
  END
  ELSE IF (@tableName IS NOT NULL)  -- all indexes on specific table
  BEGIN
    SET @sql =
    'SELECT
      SYSUTCDATETIME(),
      SchemaName = OBJECT_SCHEMA_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + '),
      TableName  = OBJECT_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + '),
      IndexName  = si.name,  
      dps.index_type_desc,  
      IndexAllocUnitType = dps.alloc_unit_type_desc,
      dps.partition_number,  
      dps.avg_fragmentation_in_percent,  
      dps.avg_fragment_size_in_pages,  
      dps.page_count,  
      p.rows  
    FROM  
      ' + @DBName + '.sys.dm_db_index_physical_stats(' + CONVERT(NVARCHAR(10),@DB_ID) + ', NULL, NULL , NULL, N''LIMITED'') dps
        INNER JOIN
      ' + @DBName + '.sys.sysindexes si ON dps.OBJECT_ID = si.ID
                   AND dps.INDEX_ID  = si.INDID
        INNER JOIN
      ' + @DBName + '.sys.partitions p  ON p.object_id = si.id 
                       AND p.index_id  = si.indid
                       AND p.partition_number = dps.partition_number
    WHERE OBJECT_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + ') = ''' + @tableName + '''' + '
    AND OBJECT_SCHEMA_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + ') IN (' + @SchemaList + ')
    AND si.name IS NOT NULL
    UNION
    SELECT
      SYSUTCDATETIME(),
      SchemaName = OBJECT_SCHEMA_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + '),
      TableName  = OBJECT_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + '),
      IndexName  = si.name,
      dps.index_type_desc,
      IndexAllocUnitType = dps.alloc_unit_type_desc,
      dps.partition_number,
      dps.avg_fragmentation_in_percent,
      dps.avg_fragment_size_in_pages,
      dps.page_count,
      NumberOfRows = null
    FROM
      ' + @DBName + '.sys.dm_db_index_physical_stats(' + CONVERT(NVARCHAR(10),@DB_ID) + ', NULL, NULL , NULL, N''LIMITED'') dps
        INNER JOIN
      ' + @DBName + '.sys.spatial_indexes si WITH (NOLOCK) ON dps.object_id      = si.object_id
                                          AND dps.index_id       = si.index_id
    WHERE OBJECT_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + ') = ''' + @tableName + '''' + '
    AND OBJECT_SCHEMA_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + ') IN (' + @SchemaList + ')
    AND si.name IS NOT NULL;'

    INSERT INTO #IndexStatsSnapshot
    (
      SnapShotDateTime           ,
      SchemaName                 ,
      TableName                  ,
      IndexName                  ,
      IndexType                  ,
      IndexAllocUnitType         ,
      PartitionNumber            ,
      AvgFragmentationPerc       ,
      AvgFragmentationSizeInPages,
      PartitionPageCount,
      PartitionRows
    )
    EXEC (@sql);

    UPDATE #IndexStatsSnapshot
    SET SnapShotEndDateTime = SYSUTCDATETIME()
    WHERE TableName = @tableName;
  END
  ELSE
  BEGIN
    SET @sql =
    'SELECT
      SYSUTCDATETIME(),
      SchemaName = OBJECT_SCHEMA_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + '),
      TableName  = OBJECT_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + '),
      IndexName  = si.name,
      dps.index_type_desc,  
      IndexAllocUnitType = dps.alloc_unit_type_desc,
      dps.partition_number,  
      dps.avg_fragmentation_in_percent,  
      dps.avg_fragment_size_in_pages,  
      dps.page_count,  
      p.rows  
    FROM  
      ' + @DBName + '.sys.dm_db_index_physical_stats(' + CONVERT(NVARCHAR(10),@DB_ID) + ', NULL, NULL , NULL, N''LIMITED'') dps  
        inner join  
      ' + @DBName + '.sys.sysindexes si ON dps.OBJECT_ID = si.ID   
                   AND dps.INDEX_ID  = si.INDID  
        inner join  
      ' + @DBName + '.sys.partitions p  ON p.object_id        = si.id
                       AND p.index_id         = si.indid
                       AND p.partition_number = dps.partition_number
    WHERE OBJECT_SCHEMA_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + ') IN (' + @SchemaList + ')
    AND si.name IS NOT NULL
    UNION  
    SELECT  
      SYSUTCDATETIME(),
      SchemaName = OBJECT_SCHEMA_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + '),
      TableName  = OBJECT_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + '),
      IndexName  = si.name,
      dps.index_type_desc,  
      IndexAllocUnitType = dps.alloc_unit_type_desc,
      dps.partition_number,  
      dps.avg_fragmentation_in_percent,  
      dps.avg_fragment_size_in_pages,  
      dps.page_count,  
      NumberOfRows = null  
    FROM  
      ' + @DBName + '.sys.dm_db_index_physical_stats(DB_ID(), NULL, NULL , NULL, N''LIMITED'') dps
        inner join
      ' + @DBName + '.sys.spatial_indexes si WITH (NOLOCK) ON dps.object_id      = si.object_id
                                          AND dps.index_id       = si.index_id' + '
    WHERE OBJECT_SCHEMA_NAME(dps.object_id,' + CONVERT(NVARCHAR(10),@DB_ID) + ') IN (' + @SchemaList + ')
    AND si.name IS NOT NULL;'

    INSERT INTO #IndexStatsSnapshot  
    (  
      SnapShotDateTime           ,
      SchemaName                 ,
      TableName                  ,
      IndexName                  ,
      IndexType                  ,
      IndexAllocUnitType         ,
      PartitionNumber            ,
      AvgFragmentationPerc       ,
      AvgFragmentationSizeInPages,
      PartitionPageCount,
      PartitionRows
    )  
    EXEC (@sql);

    UPDATE i
    SET SnapShotEndDateTime = SYSUTCDATETIME()
    FROM #IndexStatsSnapshot i;
  END;

  IF (@ApplyLogging = 1)
  BEGIN
    ;WITH
    WorstAvgTableFragmentation AS
    (
      SELECT  
        SchemaName,
        TableName,
        AvgTableFragmentation = AVG(AvgFragmentationPerc)
      FROM #IndexStatsSnapshot
      GROUP BY
        SchemaName,
        TableName
    ),
    WorstAvgIndexFragmentation AS  
    (  
      SELECT  
        SchemaName,  
        TableName,  
        IndexName,  
        IndexType,  
        AvgIndexFragmentation = AVG(AvgFragmentationPerc),  
        NumberOfPartitions    = COUNT(1)  
      FROM #IndexStatsSnapshot  
      GROUP BY  
        SchemaName,  
        TableName,  
        IndexName,  
        IndexType  
    )  
    INSERT INTO [Control].[MaintenanceIndexStatsHistory]
    (
	    SnapShotDateTime,
	    SnapShotEndDateTime,
	    DBName,
	    SchemaName,
	    TableName,
	    IndexName,
	    IndexType,
	    IndexAllocUnitType,
	    PartitionNumber,
	    PartitionMonthKey,
	    AvgFragmentationPerc,
	    AvgFragmentationSizeInPages,
	    PartitionPageCount,
	    PartitionRows
    )
    SELECT
      i.SnapShotDateTime           ,
      i.SnapShotEndDateTime        ,
      @DBName                      ,
      i.SchemaName                 ,
      i.TableName                  ,
      i.IndexName                  ,
      i.IndexType                  ,
      i.IndexAllocUnitType         ,
      i.PartitionNumber            ,
      i.PartitionMonthKey          ,
      i.AvgFragmentationPerc       ,
      i.AvgFragmentationSizeInPages,
      i.PartitionPageCount         ,
      i.PartitionRows
    FROM
      #IndexStatsSnapshot        i
        INNER JOIN
      WorstAvgTableFragmentation wt ON wt.SchemaName = i.SchemaName
                                   AND wt.TableName  = i.TableName
        INNER JOIN
      WorstAvgIndexFragmentation wi ON wt.SchemaName = i.SchemaName
                                   AND wi.TableName  = i.TableName
                                   AND wi.IndexName  = i.IndexName
    ORDER BY  
      wt.AvgTableFragmentation DESC,
      CASE WHEN wi.IndexType = 'CLUSTERED INDEX' THEN 200.0 ELSE wi.AvgIndexFragmentation END DESC,
      wi.AvgIndexFragmentation DESC,
      i.PartitionNumber DESC;

    MERGE INTO [Control].[MaintenanceIndexStats] ics
    USING #IndexStatsSnapshot i ON ics.DBName             = @DBName
                               AND ics.SchemaName         = i.SchemaName
                               AND ics.TableName          = i.TableName
                               AND ics.IndexName          = i.IndexName
                               AND ics.PartitionNumber    = i.PartitionNumber
                               AND ics.IndexType          = i.IndexType
                               AND ics.IndexAllocUnitType = i.IndexAllocUnitType
    WHEN MATCHED THEN
      UPDATE SET
        LastSnapShotDateTime        = i.SnapShotDateTime,
        AvgFragmentationPerc        = i.AvgFragmentationPerc,
        AvgFragmentationSizeInPages = i.AvgFragmentationSizeInPages,
        PartitionPageCount          = i.PartitionPageCount,
        PartitionRows               = i.PartitionRows
    WHEN NOT MATCHED BY TARGET THEN  
      INSERT  
      ( 
	      DBName,
	      SchemaName,
	      TableName,
	      IndexName,
	      IndexType,
	      IndexAllocUnitType,
	      PartitionNumber,
	      PartitionMonthKey,
        AvgFragmentationPerc,
        AvgFragmentationSizeInPages,
        PartitionPageCount,
        PartitionRows,
        LastSnapShotDateTime
      )
      VALUES  
      (
        @DBName,
	      i.SchemaName,
	      i.TableName,
	      i.IndexName,
	      i.IndexType,
	      i.IndexAllocUnitType,
	      i.PartitionNumber,
	      i.PartitionMonthKey,
	      i.AvgFragmentationPerc,
	      i.AvgFragmentationSizeInPages,
	      i.PartitionPageCount,
	      i.PartitionRows,
        i.SnapShotDateTime
      );

    ;WITH
    IndexStats AS  
    (  
      SELECT
        SchemaName,
        TableName,
        IndexName,
        IndexType,
        AvgFragmentationPerc          = AVG(AvgFragmentationPerc),  
        MaxFragmentationPerc          = MAX(AvgFragmentationPerc),  
        NumberOfPartitionsAbove30Perc = SUM(CASE WHEN AvgFragmentationPerc > 0.3 THEN 1 ELSE 0 END),  
        IndexPageCount                = SUM(PartitionPageCount),  
        NumberOfRows                  = SUM(PartitionRows)  
      FROM  
        #IndexStatsSnapshot  
      GROUP BY
        SchemaName,
        TableName,  
        IndexName,  
        IndexType  
    )  
    MERGE INTO [Control].[MaintenanceIndexStatsSummary] ics
    USING IndexStats i ON ics.DBName     = @DBName
                      AND ics.SchemaName = i.SchemaName
                      AND ics.TableName  = i.TableName
                      AND ics.IndexName  = i.IndexName
                      AND ics.IndexType  = i.IndexType
    WHEN MATCHED THEN
      UPDATE SET
        LastCheckStatsDateTime        = SYSUTCDATETIME(),  
        AvgFragmentationPerc          = i.AvgFragmentationPerc,  
        MaxFragmentationPerc          = i.MaxFragmentationPerc,  
        NumberOfPartitionsAbove30Perc = i.NumberOfPartitionsAbove30Perc,  
        NumberOfRows                  = i.NumberOfRows,  
        IndexPageCount                = i.IndexPageCount
    WHEN NOT MATCHED BY TARGET THEN  
      INSERT  
      ( 
        DBName                       ,
        SchemaName                   ,
        TableName                    ,  
        IndexName                    ,  
        IndexType                    ,  
        NumberOfRows                 ,  
        LastCheckStatsDateTime       ,  
        AvgFragmentationPerc         ,  
        MaxFragmentationPerc         ,  
        NumberOfPartitionsAbove30Perc,  
        IndexPageCount  
      )  
      VALUES  
      (
        @DBName,
        i.SchemaName,
        i.TableName,
        i.IndexName,
        i.IndexType,
        i.NumberOfRows,
        SYSUTCDATETIME(),
        i.AvgFragmentationPerc,
        i.MaxFragmentationPerc,
        i.NumberOfPartitionsAbove30Perc,
        i.IndexPageCount
      );
  END;
  
  IF (@ReturnResults = 1)
  BEGIN
    SELECT  
      SnapShotDateTime           ,
      SnapShotEndDateTime        ,
      @DBName                    ,
      SchemaName                 ,
      TableName                  ,
      IndexName                  ,
      IndexType                  ,
      PartitionNumber            ,
      PartitionMonthKey          ,
      AvgFragmentationPerc       ,
      AvgFragmentationSizeInPages,
      PartitionPageCount,
      PartitionRows
    FROM #IndexStatsSnapshot
    ORDER BY TableName,IndexName;
  END;

  RETURN 0;  
END;

GO
/****** Object:  StoredProcedure [Control].[sprMaintenance_RebuildIndexes]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprMaintenance_RebuildIndexes]
(  
  @DBName                           NVARCHAR(255),
  @DurationLimitMinutes             INT = 250,

  @RebuildFragmentationThreshold    FLOAT = 30.0,
  @ReOrganiseFragmentationThreshold FLOAT = 15.0,
  @CreateScriptOnly                 BIT = 0,
  @ApplyLogging                     BIT = 1,

  @SchemaList                       NVARCHAR(255) = '''dbo''',
  @TableName                        NVARCHAR(255) = NULL,
  @IndexName                        NVARCHAR(255) = NULL,
  @PartitionPageCountThreshold      BIGINT        = 0,
  @ExcludeTableList                 NVARCHAR(MAX) = '',
  @GetLatestIndexStats              BIT = 1
)
AS  
BEGIN  
  SET NOCOUNT ON;  
    
  DECLARE @RID INT;  
  DECLARE @AvgFragmentationPerc FLOAT;  
  DECLARE @PartitionNumber INT;  
  DECLARE @SQL NVARCHAR(MAX);  
  DECLARE @OperationStartDateTime DATETIMEOFFSET = SYSUTCDATETIME();
  DECLARE @LoopSchemaName NVARCHAR(255);
  DECLARE @LoopTableName  NVARCHAR(255);
  DECLARE @LoopIndexName  NVARCHAR(255);
  DECLARE @RebuildOperation NVARCHAR(5);

  SELECT @DBName = CASE
                     WHEN CHARINDEX('.',@DBName) > 0 
                     AND  CHARINDEX('[',@DBName) = 0
                       THEN '[' + @DBName + ']'
                     ELSE @DBName
                   END;

  IF (@GetLatestIndexStats =1)
  BEGIN
    EXEC [Control].sprMaintenance_GetIndexStats
      @DBName        = @DBName,
      @ApplyLogging  = 1,
      @SchemaList    = @SchemaList,
      @TableName     = @TableName,
      @IndexName     = @IndexName,
      @ReturnResults = 0;
  END;
  
  CREATE TABLE #IndexStatsSnapshot
  (
    RID                         INT IDENTITY(1,1) PRIMARY KEY CLUSTERED NOT NULL,
    SchemaName                  NVARCHAR(255) COLLATE database_default NOT NULL,
    TableName                   NVARCHAR(255) COLLATE database_default NOT NULL,
    IndexName                   NVARCHAR(255) COLLATE database_default NOT NULL,
    IndexType                   NVARCHAR(50)  COLLATE database_default NULL,
    PartitionNumber             INT NULL,
    AvgFragmentationPerc        FLOAT NULL,
    AvgFragmentationSizeInPages FLOAT NULL,
    Processed                   BIT NOT NULL,
    ErrorEncountered            BIT NOT NULL,
    AvgTableFragmentation       FLOAT NULL,
    AvgIndexFragmentation       FLOAT NULL,
    OrderByFragmentation        FLOAT NULL,
    NumberOfPartitions          INT NULL,
    ReloadOperation             NVARCHAR(5) NULL
  );

  -- Get index stats
  ;WITH
  LatestSnapshot AS
  (
    SELECT MAX([SnapShotDateTime]) SnapShotDateTime
    FROM [Control].[MaintenanceIndexStatsHistory] WITH (NOLOCK)
    WHERE DBName = @DBName
  )
  INSERT INTO #IndexStatsSnapshot
  (
    SchemaName                 ,
    TableName                  ,
    IndexName                  ,
    IndexType                  ,
    PartitionNumber            ,
    AvgFragmentationPerc       ,
    AvgFragmentationSizeInPages,
    Processed                  ,
    ErrorEncountered
  )
  SELECT
    iss.SchemaName                 ,
    iss.TableName                  ,
    iss.IndexName                  ,
    iss.IndexType                  ,
    iss.PartitionNumber            ,
    iss.AvgFragmentationPerc       ,
    iss.AvgFragmentationSizeInPages,
    0,0
  FROM
    LatestSnapshot ls
    INNER JOIN
    [Control].[MaintenanceIndexStatsHistory] iss WITH (NOLOCK) ON ls.SnapShotDateTime = iss.SnapShotDateTime
                                                              AND iss.DBName = @DBName
  WHERE
    iss.AvgFragmentationPerc >= ISNULL(@ReOrganiseFragmentationThreshold,@RebuildFragmentationThreshold);

  CREATE INDEX IX_IndexStatsSnapshot ON #IndexStatsSnapshot(SchemaName,TableName,IndexName);

  ;WITH
  WorstAvgTableFragmentation AS
  (
    SELECT  
      SchemaName,
      TableName,
      AvgTableFragmentation = AVG(AvgFragmentationPerc)
    FROM #IndexStatsSnapshot
    GROUP BY
      SchemaName,
      TableName
  ),
  WorstAvgIndexFragmentation AS  
  (  
    SELECT  
      SchemaName,  
      TableName,  
      IndexName,  
      IndexType,  
      AvgIndexFragmentation = AVG(AvgFragmentationPerc),  
      NumberOfPartitions    = MAX(PartitionNumber)  
    FROM #IndexStatsSnapshot  
    GROUP BY  
      SchemaName,  
      TableName,  
      IndexName,  
      IndexType  
  )  
  UPDATE i
  SET
    AvgTableFragmentation = wt.AvgTableFragmentation,
    AvgIndexFragmentation = wi.AvgIndexFragmentation,
    OrderByFragmentation  = CASE WHEN wi.IndexType = 'CLUSTERED INDEX' THEN 200.0 ELSE wi.AvgIndexFragmentation END,
    NumberOfPartitions    = wi.NumberOfPartitions
  FROM
    #IndexStatsSnapshot i
      INNER JOIN
    WorstAvgTableFragmentation wt ON wt.SchemaName = i.SchemaName
                                 AND wt.TableName  = i.TableName
      INNER JOIN
    WorstAvgIndexFragmentation wi ON wt.SchemaName = i.SchemaName
                                 AND wi.TableName  = i.TableName
                                 AND wi.IndexName  = i.IndexName;

  WHILE EXISTS (SELECT 1 FROM #IndexStatsSnapshot WHERE Processed = 0)
  AND (DATEDIFF(s,@OperationStartDateTime,SYSUTCDATETIME())/60.0 < @DurationLimitMinutes)
  BEGIN
    
    PRINT '-- Duration: ' + CONVERT(NVARCHAR(20),DATEDIFF(s,@OperationStartDateTime,SYSUTCDATETIME())/60.0);

    SELECT TOP 1  
      @RID                  = iss.RID,  
      @AvgFragmentationPerc = iss.AvgFragmentationPerc,  
      @PartitionNumber      = iss.PartitionNumber,
      @LoopSchemaName       = iss.SchemaName,
      @LoopTableName        = iss.TableName,
      @LoopIndexName        = iss.IndexName,
      @RebuildOperation     =
             CASE
               WHEN iss.AvgFragmentationPerc >= @RebuildFragmentationThreshold    THEN
                 'REBLD'
               WHEN iss.AvgFragmentationPerc >= @ReOrganiseFragmentationThreshold THEN
                 'REORG'
               ELSE ''
             END,
      @SQL = CASE  
               WHEN iss.AvgFragmentationPerc >= @RebuildFragmentationThreshold THEN  
                 CASE  
                   WHEN iss.NumberOfPartitions > 1 THEN  
                     'ALTER INDEX ' + iss.IndexName + ' ON ' + @DBName + '.' + iss.SchemaName + '.' + iss.TableName  
                   + ' REBUILD PARTITION = ' + CONVERT(NVARCHAR(10),iss.PartitionNumber)  
                   + ' WITH (SORT_IN_TEMPDB = ON)'  
                   ELSE  
                     'ALTER INDEX ' + iss.IndexName + ' ON ' + @DBName + '.' + iss.SchemaName + '.' + iss.TableName  
                   + ' REBUILD'  
                   + ' WITH (SORT_IN_TEMPDB = ON)'  
                 END  
               WHEN iss.AvgFragmentationPerc >= @ReOrganiseFragmentationThreshold THEN  
                 CASE  
                   WHEN iss.NumberOfPartitions > 1 THEN  
                     'ALTER INDEX ' + iss.IndexName + ' ON ' + @DBName + '.' + iss.SchemaName + '.' + iss.TableName   
                   + ' REORGANIZE PARTITION = ' + CONVERT(NVARCHAR(10),iss.PartitionNumber)  
                   ELSE  
                     'ALTER INDEX ' + iss.IndexName + ' ON ' + @DBName + '.' + iss.SchemaName + '.' + iss.TableName   
                   + ' REORGANIZE'  
                 END  
  
               ELSE ''  
             END  
    FROM #IndexStatsSnapshot iss  
    WHERE iss.Processed = 0  
    AND iss.TableName <> 'DIM_GeoLocations' 
    ORDER BY  
      CASE
        WHEN iss.partitionNumber = 1 then 
          999
        ELSE iss.partitionNumber
      END DESC,  
      iss.NumberOfPartitions, 
      iss.PartitionNumber DESC,
      iss.OrderByFragmentation DESC,  
      iss.AvgIndexFragmentation DESC
      
    PRINT '-- Fragmentation %: ' + CONVERT(NVARCHAR(10),@AvgFragmentationPerc) + ' PartitionNumber: ' + CONVERT(NVARCHAR(10),@PartitionNumber);  
    PRINT @SQL;  
    PRINT 'GO';  
      
    IF (@CreateScriptOnly = 0)  
    BEGIN  
      BEGIN TRY  
        EXECUTE (@SQL);
      END TRY  
      BEGIN CATCH
        IF (@ApplyLogging = 1)
        BEGIN
          UPDATE ics
          SET
            LastStatsFailedDateTime = SYSUTCDATETIME(),
            LastRebuildOperation    = @RebuildOperation
          FROM
            #IndexStatsSnapshot      iss
              INNER JOIN
            [Control].[MaintenanceIndexStatsSummary] ics ON iss.RID        = @RID
                                                   AND ics.SchemaName = iss.SchemaName
                                                   AND ics.TableName  = iss.TableName
                                                   AND ics.IndexName  = iss.IndexName;
        END;
        PRINT ERROR_MESSAGE();
      END CATCH
    END;

    IF (@ApplyLogging = 1)
    BEGIN
      UPDATE ics
      SET
        LastRebuildDateTime  = SYSUTCDATETIME(),
        LastRebuildOperation = @RebuildOperation
      FROM
        #IndexStatsSnapshot      iss
          INNER JOIN
        [Control].[MaintenanceIndexStatsSummary] ics ON iss.RID        = @RID
                                               AND ics.SchemaName = iss.SchemaName
                                               AND ics.TableName  = iss.TableName
                                               AND ics.IndexName  = iss.IndexName;

      UPDATE ics
      SET
        LastRebuildDateTime      = SYSUTCDATETIME(),
        LastRebuildOperation     = @RebuildOperation,
        PrevAvgFragmentationPerc = ics.AvgFragmentationPerc
      FROM
        #IndexStatsSnapshot      iss
          INNER JOIN
        [Control].[MaintenanceIndexStats] ics ON iss.RID             = @RID
                                             AND ics.SchemaName      = iss.SchemaName
                                             AND ics.TableName       = iss.TableName
                                             AND ics.IndexName       = iss.IndexName
                                             AND ics.PartitionNumber = iss.PartitionNumber
                                             AND ics.IndexType       = iss.IndexType;
    END;

    UPDATE #IndexStatsSnapshot
    SET
      Processed       = 1,
      ReloadOperation = @RebuildOperation
    WHERE RID = @RID;
    
    IF NOT EXISTS (SELECT 1 FROM #IndexStatsSnapshot ics
                   WHERE ics.SchemaName = @LoopSchemaName AND ics.TableName = @LoopTableName AND ics.IndexName = @LoopIndexName
                   AND ics.Processed = 0)
    AND    EXISTS (SELECT 1 FROM #IndexStatsSnapshot ics
                   WHERE ics.SchemaName = @LoopSchemaName AND ics.TableName = @LoopTableName AND ics.IndexName = @LoopIndexName
                   AND ics.ReloadOperation = 'REORG')
    BEGIN
      SELECT @SQL = 'UPDATE STATISTICS ' + @DBName + '.' + @LoopSchemaName + '.' + @LoopTableName + ' ' + @LoopIndexName + ';';

      PRINT @SQL;
      IF (@CreateScriptOnly = 0)  
      BEGIN
        EXECUTE (@SQL);
      END;

      PRINT 'GO';
    END;
  END;

  IF  EXISTS (SELECT 1 FROM #IndexStatsSnapshot ics
              WHERE ics.SchemaName = @LoopSchemaName AND ics.TableName = @LoopTableName AND ics.IndexName = @LoopIndexName
              AND ics.Processed = 0)
  AND EXISTS (SELECT 1 FROM #IndexStatsSnapshot ics
              WHERE ics.SchemaName = @LoopSchemaName AND ics.TableName = @LoopTableName AND ics.IndexName = @LoopIndexName
              AND ics.ReloadOperation = 'REORG')
  BEGIN
    SELECT @SQL = 'UPDATE STATISTICS ' + @DBName + '.' + @LoopSchemaName + '.' + @LoopTableName + ' ' + @LoopIndexName + ';';

    PRINT @SQL;
    IF (@CreateScriptOnly = 0)  
    BEGIN
      EXECUTE (@SQL);
    END;

    PRINT 'GO';
  END;

  IF (@GetLatestIndexStats =1)
  BEGIN
    EXEC [Control].sprMaintenance_GetIndexStats
      @DBName        = @DBName,
      @ApplyLogging  = 1,
      @SchemaList    = @SchemaList,
      @TableName     = @TableName,
      @IndexName     = @IndexName,
      @ReturnResults = 0;
  END;
  
  SELECT Processed, COUNT(1) NrOfIndexes
  FROM #IndexStatsSnapshot
  GROUP BY Processed;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [Control].[sprOrganisation_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move Organisation records to audit schema
-- =============================================
CREATE PROCEDURE [Control].[sprOrganisation_MoveToAudit]
(
  @batchKey        int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  
  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      UPDATE
        [StageControl].Organisation_CT
      SET
        OrganisationKey = dorg.OrganisationKey
      FROM
        [StageControl].Organisation_CT  stg
          INNER JOIN
        [MiXData].dbo.DIM_Organisations dorg WITH (NOLOCK) ON dorg.HostID = stg.liOrgID;
      
      MERGE [audit].Organisation_CT        AS tar
      USING [StageControl].Organisation_CT AS stg
         ON tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate               = stg.ChangeDate         ,
            tar.Operation                = stg.Operation          ,
            tar.UpdateMask               = stg.UpdateMask         ,
            tar.ChangeVersion            = stg.ChangeVersion      ,
            tar.liOrgID                  = stg.liOrgID            ,
            tar.CompanyGUID              = stg.CompanyGUID        ,
            tar.iCompanyID               = stg.iCompanyID         ,
            tar.sOrganisationName        = stg.sOrganisationName  ,
            tar.sConnectServer           = stg.sConnectServer     ,
            tar.sConnectDatabase         = stg.sConnectDatabase   ,
            tar.bActive                  = stg.bActive            ,
            tar.sLanguage                = stg.sLanguage          ,
            tar.bDaylightEnabled         = stg.bDaylightEnabled   ,
            tar.dtDaylightStart          = stg.dtDaylightStart    ,
            tar.dtDaylightEnd            = stg.dtDaylightEnd      ,
            tar.liDaylightAdjust         = stg.liDaylightAdjust   ,
            tar.bReverseGeoAllowed       = stg.bReverseGeoAllowed ,
            tar.MapProviderID            = stg.MapProviderID      ,
            tar.liGMTOffset              = stg.liGMTOffset        ,
            tar.iDealerID                = stg.iDealerID          ,
            tar.sDBVersion               = stg.sDBVersion         ,
            tar.bBillable                = stg.bBillable          ,
            tar.ucBillingCode            = stg.ucBillingCode      ,
            tar.ucBillingContract        = stg.ucBillingContract  ,
            tar.sCountryCode             = stg.sCountryCode       ,
            tar.MapProviderConfiguration = stg.MapProviderConfiguration,
            tar.DutchTaxEventID          = stg.DutchTaxEventID
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey   ,
            HostRID           ,
            ChangeDate         ,
            Operation          ,
            UpdateMask         ,
            ChangeVersion      ,
            liOrgID            ,
            CompanyGUID        ,
            iCompanyID         ,
            sOrganisationName  ,
            sConnectServer     ,
            sConnectDatabase   ,
            bActive            ,
            sLanguage          ,
            bDaylightEnabled   ,
            dtDaylightStart    ,
            dtDaylightEnd      ,
            liDaylightAdjust   ,
            bReverseGeoAllowed ,
            MapProviderID      ,
            liGMTOffset        ,
            iDealerID          ,
            sDBVersion         ,
            bBillable          ,
            ucBillingCode      ,
            ucBillingContract  ,
            sCountryCode       ,
            MapProviderConfiguration,
            DutchTaxEventID
          )
          VALUES
          (
            ISNULL(stg.OrganisationKey,-1),
            stg.RID                ,
            stg.ChangeDate         ,
            stg.Operation          ,
            stg.UpdateMask         ,
            stg.ChangeVersion      ,
            stg.liOrgID            ,
            stg.CompanyGUID        ,
            stg.iCompanyID         ,
            stg.sOrganisationName  ,
            stg.sConnectServer     ,
            stg.sConnectDatabase   ,
            stg.bActive            ,
            stg.sLanguage          ,
            stg.bDaylightEnabled   ,
            stg.dtDaylightStart    ,
            stg.dtDaylightEnd      ,
            stg.liDaylightAdjust   ,
            stg.bReverseGeoAllowed ,
            stg.MapProviderID      ,
            stg.liGMTOffset        ,
            stg.iDealerID          ,
            stg.sDBVersion         ,
            stg.bBillable          ,
            stg.ucBillingCode      ,
            stg.ucBillingContract  ,
            stg.sCountryCode       ,
            stg.MapProviderConfiguration,
            stg.DutchTaxEventID
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = -1, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=-1, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = -1;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [Control].[sprOrganisationController_ResetDeadLinks]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==========================================================================================
-- Updates table Control.OrganisationController  on Batch success
-- ==========================================================================================
CREATE PROCEDURE [Control].[sprOrganisationController_ResetDeadLinks]
(
  @threadUser NVARCHAR(50)
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @can_see_all_running_jobs INT;
  DECLARE @job_owner                SYSNAME;
  DECLARE @job_id                   UNIQUEIDENTIFIER;

  DECLARE @nrOfActiveStageUsers INT               = 0;
  DECLARE @currentDate          DATETIMEOFFSET(0) = SYSUTCDATETIME();

  DECLARE @organisations_busy_running TABLE
  (
    OrganisationID           INT,
    CurrentThreadUser        NCHAR(15)
  );

  DECLARE @job_statuses TABLE
  (
    job_id    UNIQUEIDENTIFIER NOT NULL,
    job_state INT,
    Processed INT
  );
  
  DECLARE @xp_results TABLE
  ( 
    job_id                UNIQUEIDENTIFIER NOT NULL,  
    last_run_date         INT              NOT NULL,  
    last_run_time         INT              NOT NULL,  
    next_run_date         INT              NOT NULL,  
    next_run_time         INT              NOT NULL,  
    next_run_schedule_id  INT              NOT NULL,  
    requested_to_run      INT              NOT NULL, -- BOOL  
    request_source        INT              NOT NULL,  
    request_source_id     SYSNAME          COLLATE database_default NULL,  
    running               INT              NOT NULL, -- BOOL  
    current_step          INT              NOT NULL,  
    current_retry_attempt INT              NOT NULL,  
    job_state             INT              NOT NULL
  );

	-- job_state
	-- Value Description
	-- 1  Executing.
	-- 2  Waiting for thread.
	-- 3  Between retries.
	-- 4  Idle.
	-- 5  Suspended.
	-- 7  Performing completion actions.

  -------------------------------------------------
  -- 1. Identify currently running StageUser jobs
  -------------------------------------------------
  SELECT @can_see_all_running_jobs = ISNULL(IS_SRVROLEMEMBER(N'sysadmin'), 0)  
  SELECT @job_owner                = SUSER_SNAME()  

  -- get StageUser job list
  INSERT INTO @job_statuses
  SELECT
    job_id,
    -1,
    0
  FROM
    msdb.dbo.sysjobs_view
  WHERE
    name like 'StageUser%';

  -- loop through StageUser job list and get job status
  WHILE EXISTS (SELECT 1 FROM @job_statuses WHERE Processed = 0)
  BEGIN
    SELECT TOP 1 
      @job_id = job_id
    FROM @job_statuses
    WHERE Processed = 0;
    
    DELETE @xp_results;

    INSERT INTO @xp_results  
    EXECUTE master.dbo.xp_sqlagent_enum_jobs @can_see_all_running_jobs, @job_owner, @job_id  

    UPDATE
      @job_statuses
    SET
      Processed = 1,
      job_state = (SELECT MIN(job_state) FROM @xp_results)
    WHERE
      job_id = @job_id;

  END; -- end while

  -- identify how many StageUsers are active/executing (all except current threaduser)
  SELECT
    @nrOfActiveStageUsers = ISNULL(COUNT(DISTINCT js.job_id),0)
  FROM
    @job_statuses         js
      INNER JOIN
    msdb.dbo.sysjobs_view jv ON jv.job_id = js.job_id
  WHERE
      js.job_state IN (1)
  AND jv.name      <> @threadUser;

  -------------------------------------------------
  -- 2. Identify currently running Organisations and reset their status in Control.OrganisationController
  -------------------------------------------------

  -- if no active StageUsers then set Orgs who's status is set as busy running to finished and log error
  IF @nrOfActiveStageUsers = 0
  BEGIN

    -- get list of organisations that is currently busy running
    INSERT INTO @organisations_busy_running
    SELECT
      OrganisationID   ,
      CurrentThreadUser
    FROM
      [Control].OrganisationController
    WHERE
        DWActive   = 1
    AND BActive    = 1
    AND IsFinished = 0;

    -- Reset IsFinished flag on OrganisationController for Organisations without any activity
    UPDATE
      [Control].OrganisationController
    SET
      IsFinished              = 1,
      ErrorEncountered        = ISNULL(ErrorEncountered,0) + 1,
      NumberOfExtractAttempts = 0
    FROM
      @organisations_busy_running      r
        INNER JOIN
      [Control].OrganisationController oc ON oc.OrganisationID = r.OrganisationID;

    -- Add to ErrorLogging
    INSERT INTO [Control].[ErrorLogging]
    ( 
      [BatchID],
      [OrganisationKey],
      [ThreadUser],
      [ActionType],
      [ActionObjectName],
      [StepDescription],
      [StepStartDateTime],
      [ErrorDateTime],
      [ErrorCode],
      [ErrorDescription],
      [SourceDBCatalog],
      [SourceDBServer],
      [SourceDBCurrChangeVersion],
      [SourceDBPrevChangeVersion]
    )
    SELECT
      oc.CurrentBatch,
      oc.OrganisationKey,
      oc.CurrentThreadUser,
      [ActionType]        = 'Identify Dead Links',
      [ActionObjectName]  = 'Identify Dead Links',
      [StepDescription]   = 'Identify Dead Links',
      [StepStartDateTime] = @currentDate,
      [ErrorDateTime]     = @currentDate,
      [ErrorCode]         = 0,
      [ErrorDescription]  = 'In table Control.OrganisationController the organisation is indicated as being busy, but no active processing could be found on the database',
      [SourceDBCatalog]           = oc.DatabaseName,
      [SourceDBServer]            = oc.ServerInstance,
      [SourceDBCurrChangeVersion] = -1,
      [SourceDBPrevChangeVersion] = oc.DBChangeTrackVersion
    FROM
      @organisations_busy_running      r
        INNER JOIN
      [Control].OrganisationController oc ON oc.OrganisationID = r.OrganisationID
    WHERE oc.IsRemoved = 0;
  
  END; -- end if

  RETURN 0;

END; -- end proc

GO
/****** Object:  StoredProcedure [Control].[sprOrganisationControlSuccess_Set]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprOrganisationControlSuccess_Set]  
(   
  @batchKey                 INT,  
  @organisationKey          INT,  
  @DBChangeTrackVersion     BIGINT  
)  
AS  
BEGIN  
  SET NOCOUNT ON;  
    
    
    
  BEGIN TRY  
    BEGIN TRANSACTION;  
  
    UPDATE  
      [Control].OrganisationTableController  
    SET  
      ChangeVersion = @DBChangeTrackVersion,  
      FullLoadFlag  = 0  
    WHERE  
      OrganisationKey  = @organisationKey;  
      
    UPDATE Control.OrganisationController  
    SET   
      IsFinished                 = 1,  
      LastUpdateSuccess          = 'True',  
      LastSuccessbatch           = CurrentBatch,  
      DBChangeTrackVersion       = @DBChangeTrackVersion,  
      DBChangeTrackVersionDate   = SYSUTCDATETIME(),  
      LastProcessingCompleteDate = SYSUTCDATETIME(),  
      ScheduleDateTime           = dbo.fncGetNextSchedule(ProcessIntervalInSec,UTCOffset),  
      NumberOfExtractAttempts    = 0     
    WHERE  
        OrganisationKey  = @organisationKey  
    AND CurrentBatch     = @batchKey  
    AND IsFinished       = 0;  
  
    UPDATE Control.WarehouseNotifications  
    SET   
      IsBusyProcessing           = 0,  
      ProcessedDateTime          = SYSUTCDATETIME()  
    WHERE  
        OrganisationID   = (SELECT MIN(OrganisationID)  
                            FROM Control.OrganisationController WITH (NOLOCK)  
                            WHERE OrganisationKey = @organisationKey)  
    AND ProcessedDateTime IS NULL  
    AND NotificationType  IN ('New Database','Restored Database');  
  
    COMMIT TRANSACTION;  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    ROLLBACK TRANSACTION;  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
    RETURN -1;  
  END CATCH;  
  
  RETURN 0;  
  
END; -- end proc  

GO
/****** Object:  StoredProcedure [Control].[sprOrganisationTableController_Get]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==========================================================================================
-- Gets the variables per organisation table to check if table should be fully loaded
-- ==========================================================================================
CREATE PROCEDURE [Control].[sprOrganisationTableController_Get]
(
  @organisationKey  int,
  @extractTableName nvarchar(50)
)
AS
BEGIN

  BEGIN TRY
    IF NOT EXISTS (SELECT 1
                   FROM [Control].OrganisationTableController
                   WHERE
                     OrganisationKey  = @organisationKey
                   AND ExtractTableName = @extractTableName)
    BEGIN
      INSERT INTO [Control].OrganisationTableController
      (
        OrganisationKey ,
        ExtractTableName,
        ChangeVersion   ,
        FullLoadFlag
      )
      SELECT
        @organisationKey ,
        @extractTableName,
        -1               ,  -- return all rows if not exist
        1                   -- return all rows if not exist
    END; -- end if

    SELECT
      ChangeVersion,
      FullLoadFlag   
    FROM [Control].OrganisationTableController
    WHERE
        OrganisationKey  = @organisationKey
    AND ExtractTableName = @extractTableName;
    
    RETURN 0
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

END;

GO
/****** Object:  StoredProcedure [Control].[sprOrganisationTableController_Set]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==========================================================================================
-- Updates table OrganisationTableController on either success or reload
-- ==========================================================================================
CREATE PROCEDURE [Control].[sprOrganisationTableController_Set]
(
  @organisationKey  int,
  @extractTableName nvarchar(50),
  @fullLoadFlag     bit    = 1,
  @changeVersion    bigint = -1
)
AS
BEGIN

  BEGIN TRY
    IF NOT EXISTS (SELECT 1
                   FROM [Control].OrganisationTableController
                   WHERE
                       OrganisationKey  = @organisationKey
                   AND ExtractTableName = @extractTableName)
    BEGIN
      INSERT INTO [Control].OrganisationTableController
      (
        OrganisationKey ,
        ExtractTableName,
        ChangeVersion   ,
        FullLoadFlag
      )
      SELECT
        @organisationKey ,
        @extractTableName,
        @changeVersion   , -- return all rows if not exist
        @fullLoadFlag      -- return all rows if not exist
    END
    ELSE
    BEGIN
      UPDATE
        [Control].OrganisationTableController
      SET
        ChangeVersion = @changeVersion,
        FullLoadFlag  = @fullLoadFlag
      WHERE
          OrganisationKey  = @organisationKey
      AND ExtractTableName = @extractTableName         ;

    END; -- end if
    
    RETURN 0
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

END;

GO
/****** Object:  StoredProcedure [Control].[sprOrganisationToDestinationDatabase]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==========================================================================================
-- This procedure will move data from the MiXData dbo schema to the destination database
--  for the given Organisation specified
-- ==========================================================================================
CREATE PROCEDURE [Control].[sprOrganisationToDestinationDatabase]
(
  @organisationKey         int,
  @destinationDatabaseName nvarchar(500),
  @debugMode               bit = 0
)
AS
BEGIN
   SET NOCOUNT ON;
  
  DECLARE @miXDataTableName       nvarchar(100);
  DECLARE @rollbackColumnList     nvarchar(max);
  DECLARE @primaryKey             nvarchar(100);
  DECLARE @strSQL                 nvarchar(max);
  DECLARE @strSQLExists VARCHAR(MAX);
  DECLARE @hasOrganisationKey     bit = 0;
  DECLARE @nrOfRecordsAffected    int;
  DECLARE @nrOfRecordsLeft        int;
  DECLARE @NewLineChar AS CHAR(2) = CHAR(13) + CHAR(10)
  DECLARE @columnString           nvarchar(max);
  DECLARE @strIdentityInsertOn    nvarchar(max);
  DECLARE @strIdentityInsertOff   nvarchar(max);
  
  DECLARE @tableList table
  (
    MiXDataTableName       nvarchar(100),
    HasOrganisationKey     bit,
    Processed              bit
  );
  
  DECLARE @columnList table
  (
    ColumnID    INT,
    ColumnName  NVARCHAR(100),
    IsIdentity  BIT
  );

  BEGIN TRY

    INSERT INTO @tableList
    ( MiXDataTableName, HasOrganisationKey,Processed )
    SELECT
      t.name,
      1,
      0
    FROM
        [MiXData].sys.objects o
          inner join -- select * from
        [MiXData].sys.tables  t on o.object_id = t.object_id
          inner join -- select * from
        [MiXData].sys.columns c on o.object_id = c.object_id      
    WHERE
        c.name = 'OrganisationKey'
    AND t.schema_id = 1
    ORDER BY t.name;

    INSERT INTO @tableList
    ( MiXDataTableName, HasOrganisationKey,Processed )
    SELECT
      t.name,
      0,
      0
    FROM
        [MiXData].sys.objects o
          inner join -- select * from
        [MiXData].sys.tables  t on o.object_id = t.object_id
    WHERE
        t.name not in ('DIM_GeoLocations')
    AND t.schema_id = 1
    AND NOT EXISTS (SELECT 1
                    FROM @tableList tl
                    WHERE tl.MiXDataTableName = t.Name)
    ORDER BY t.name;

    WHILE EXISTS (SELECT 1 FROM @tableList WHERE Processed = 0)
    BEGIN
      
      SELECT
        @miXDataTableName       = MIN(MiXDataTableName)
      FROM
        @tableList
      WHERE
        Processed = 0;

      SELECT
        @hasOrganisationKey = ISNULL(HasOrganisationKey,0)
      FROM
        @tableList
      WHERE
        MiXDataTableName = @miXDataTableName;
        
      DELETE @columnList;
      INSERT INTO @columnList
      ( ColumnID,ColumnName,IsIdentity )
      SELECT
        c.column_id,
        c.name,
        c.is_identity
      FROM
          [MiXData].sys.objects o
            inner join -- select * from
          [MiXData].sys.tables  t on o.object_id = t.object_id
            inner join -- select * from
          [MiXData].sys.columns c on o.object_id = c.object_id      
      WHERE
          t.name      = @miXDataTableName
      AND t.schema_id = 1
      ORDER BY c.column_id;

      SELECT
        @columnString = STUFF((SELECT ',' + ColumnName
                               FROM @columnList
                               ORDER BY ColumnID
                               FOR XML PATH('')
                               ), 1, 1, '');

      IF EXISTS (SELECT 1 FROM @columnList WHERE IsIdentity = 1)
      BEGIN
        SELECT
          @strIdentityInsertOn  = ' SET IDENTITY_INSERT [' + @destinationDatabaseName + '].dbo.' + @mixDataTableName + ' ON;' + @NewLineChar,
          @strIdentityInsertOff = ' SET IDENTITY_INSERT [' + @destinationDatabaseName + '].dbo.' + @mixDataTableName + ' OFF;'
      END
      ELSE
      BEGIN
        SELECT
          @strIdentityInsertOn  = '',
          @strIdentityInsertOff = ''
      END;

      -- inserted records
      IF (@mixDataTableName = 'DIM_GeoLocations')
      BEGIN

        SELECT @strSQL = ' SET IDENTITY_INSERT [' + @destinationDatabaseName + '].dbo.DIM_GeoLocations ON' + @NewLineChar
                       + ' INSERT INTO [' + @destinationDatabaseName + '].dbo.DIM_GeoLocations'
                       + ' (GeoLocationKey,OrganisationKey,LocationPoint,Longitude,Latitude,StreetLevelName,GeographyKey,CreateBatchKey,UpdateBatchKey)'
                       + ' SELECT dgl.GeoLocationKey,dgl.OrganisationKey,dgl.LocationPoint,dgl.Longitude,dgl.Latitude,dgl.StreetLevelName,dgl.GeographyKey,dgl.CreateBatchKey,dgl.UpdateBatchKey'
                       + ' FROM [MiXData].dbo.DIM_GeoLocations dgl WITH (NOLOCK)'
                       + ' WHERE dgl.OrganisationKey IN (' + CONVERT(NVARCHAR(20),@organisationKey)
                       + ',-1);' + @NewLineChar
                       + ' SET IDENTITY_INSERT [' + @destinationDatabaseName + '].dbo.DIM_GeoLocations OFF;';

      
        EXECUTE (@strSQL);
        SELECT @nrOfRecordsAffected = @nrOfRecordsAffected + @@ROWCOUNT;

        IF @debugMode = 1
        BEGIN
          PRINT CONVERT(NCHAR(15),@nrOfRecordsAffected) + ': ' + @strSQL;
          PRINT '';
        END

      END
      ELSE IF (@mixDataTableName = 'DIM_GeoLocationsToShapes')
      BEGIN
        SELECT @strSQL = @strIdentityInsertOn
                       + ' INSERT INTO [' + @destinationDatabaseName + '].dbo.' + @mixDataTableName
                       + ' (' + @columnString + ')'
                       + ' SELECT ' + REPLACE(@columnString,',',',d.') + ' FROM [MiXData].dbo.DIM_Shapes dsh WITH (NOLOCK)'
                       + ' INNER JOIN [MiXData].dbo.' + @mixDataTableName 
                       + ' d WITH (NOLOCK) ON dsh.OrganisationKey IN (' + CONVERT(NVARCHAR(20),@organisationKey)
                       + ',-1) AND dsh.ShapeKey = d.ShapeKey;' + @NewLineChar 
                       + @strIdentityInsertOff;
      
        EXECUTE (@strSQL);
        SELECT @nrOfRecordsAffected = @@ROWCOUNT;

        IF @debugMode = 1
        BEGIN
          PRINT CONVERT(NCHAR(15),@nrOfRecordsAffected) + ': ' + @strSQL;
          PRINT '';
        END
      END
      ELSE IF (@hasOrganisationKey = 1)  -- FACT tables with VehicleKey column, because of index extract should run faster
          AND @mixDataTableName LIKE 'FACT_%'
          AND EXISTS (SELECT 1 FROM @columnList WHERE ColumnName = 'VehicleKey')
      BEGIN
        SELECT @strSQL = @strIdentityInsertOn
                       + ' INSERT INTO [' + @destinationDatabaseName + '].dbo.' + @mixDataTableName
                       + ' (' + @columnString + ')'
                       + ' SELECT ' + REPLACE(@columnString,',',',d.')
                       + ' FROM [MiXData].dbo.DIM_Vehicles dvh WITH (NOLOCK) INNER JOIN '
                       + ' [MiXData].dbo.' + @mixDataTableName
                       + ' d WITH (NOLOCK) ON dvh.OrganisationKey IN (' + CONVERT(NVARCHAR(20),@organisationKey) 
                       + ',-1) AND dvh.VehicleKey = d.VehicleKey;' + @NewLineChar
                       + @strIdentityInsertOff;
      
        EXECUTE (@strSQL);
        SELECT @nrOfRecordsAffected = @@ROWCOUNT;

        IF @debugMode = 1
        BEGIN
          PRINT CONVERT(NCHAR(15),@nrOfRecordsAffected) + ': ' + @strSQL;
          PRINT '';
        END

      END
      ELSE IF (@hasOrganisationKey = 1)
      BEGIN
        SELECT @strSQL = @strIdentityInsertOn
                       + ' INSERT INTO [' + @destinationDatabaseName + '].dbo.' + @mixDataTableName
                       + ' (' + @columnString + ')'
                       + ' SELECT ' + @columnString + ' FROM [MiXData].dbo.' + @mixDataTableName
                       + ' WITH (NOLOCK) WHERE OrganisationKey IN (' + CONVERT(NVARCHAR(20),@organisationKey) + ',-1);' + @NewLineChar
                       + @strIdentityInsertOff;
      
        EXECUTE (@strSQL);
        SELECT @nrOfRecordsAffected = @@ROWCOUNT;

        IF @debugMode = 1
        BEGIN
          PRINT CONVERT(NCHAR(15),@nrOfRecordsAffected) + ': ' + @strSQL;
          PRINT '';
        END

      END
      ELSE  -- all other tables without OrganisationKeys (eg. DIM_Currencies etc)
      BEGIN
        SELECT @strSQL = @strIdentityInsertOn
                       + ' INSERT INTO [' + @destinationDatabaseName + '].dbo.' + @mixDataTableName
                       + ' (' + @columnString + ')'
                       + ' SELECT ' + @columnString + ' FROM [MiXData].dbo.' + @mixDataTableName + ' WITH (NOLOCK);' + @NewLineChar
                       + @strIdentityInsertOff;
      
        EXECUTE (@strSQL);
        SELECT @nrOfRecordsAffected = @@ROWCOUNT;

        IF @debugMode = 1
        BEGIN
          PRINT CONVERT(NCHAR(15),@nrOfRecordsAffected) + ': ' + @strSQL;
          PRINT '';
        END

      END;
      

      UPDATE @tableList
      SET Processed = 1
      WHERE MiXDataTableName = @miXDataTableName;

    END -- end while

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [Control].[sprPartitionCreate]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprPartitionCreate]
(
	@Dbname nvarchar(128),
	@PartitionScheme nvarchar(128),
	@PartitionFunction nvarchar(128),
	@PartitionSize varchar(6)
)
AS

Declare @Stmt nvarchar(max);
Declare @CurrDate Date
Declare @NextMonth nchar(2);
Declare @NextYear nchar(4);
Declare @FileGroup nvarchar(10);

set @CurrDate = GETUTCDATE()
set @NextMonth = REPLICATE('0',2-LEN(RTRIM(CONVERT(varchar(20),DATEPART(month,DATEADD(month,1,@CurrDate))))))+CONVERT(varchar(20),DATEPART(month,DATEADD(month,1,@CurrDate)))
set @NextYear = DATEPART(year,DATEADD(month,1,@CurrDate))
set @FileGroup = @NextYear + '-' + @NextMonth

select @Stmt = 'Use [' + @Dbname + '];' + char(13);

select @Stmt = @Stmt + 'Alter Database [' + @Dbname + '] Add Filegroup [' + @FileGroup + '];' + char(13);

select @Stmt  = @Stmt +  'Alter Database [' + @Dbname + '] Add File (Name = [' + @FileGroup + '_' + FileNum + '],' + 'Filename = N''' + Drive + DPath + @Dbname + '_' + @FileGroup + '_' + FileNum + '.ndf'',Size = ' + @PartitionSize + 'MB,FILEGROWTH = 256MB)' + 'To FileGroup [' + @FileGroup + '];' + char(13)
				  from MixStaging.Control.PartitionInfo where MonNum = @NextMonth; 
 
select @Stmt  = @Stmt +   'Alter Partition Scheme [' + @PartitionScheme + '] Next Used [' + @FileGroup + '];' + char(13); 
 
select @Stmt  = @Stmt +   'Alter Partition Function [' + @PartitionFunction + '] () Split Range (''' + @FileGroup + '-' + '01'');' + char(13);
exec (@Stmt);
--print @Stmt;

RETURN 0;
GO
/****** Object:  StoredProcedure [Control].[sprPopulateRollbackTableList]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==========================================================================================
-- This procedure will provide the list of tables as well as their column lists to be used
--   to rollback an organisation that encountered and error
-- NB!!! Currently a manual text exclusion list provided in the procedure that will have to
--       get maintained
-- ==========================================================================================
CREATE PROCEDURE [Control].[sprPopulateRollbackTableList]
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @TmpColumn TABLE
  (
    column_id int,
    ColumnName nvarchar(100),
    Processed  bit default 0
  )

  DECLARE @tableName          NVARCHAR(100);
  DECLARE @columnList         NVARCHAR(MAX);
  DECLARE @columnReInsertList NVARCHAR(MAX);
  DECLARE @primaryKey         NVARCHAR(100);  
  DECLARE @columnID           INT;
  DECLARE @OrgKeyFlag         BIT = 0;

  -- Populate table list, ordering so that FACT tables are first
  TRUNCATE TABLE [Control].RollbackTableList;
  INSERT INTO [Control].RollbackTableList
  ( MiXDataTableName )
  SELECT t.name
  FROM
      [MiXData].sys.objects o
        INNER JOIN
      [MiXData].sys.tables  t ON o.object_id = t.object_id
        INNER JOIN
      [MiXData].sys.schemas s ON s.name      = 'dbo'
                                AND s.schema_id = t.schema_id
  WHERE
    t.name not in
    (
      'DIM_Currencies',
      'DIM_Dates',
      'DIM_Geography',
      'DIM_GeoLocations',
      'DIM_GeoLocationsToShapes',
      'DIM_Organisations',
      'DIM_OrganisationsToGeoLocations',
      'DIM_RegionalSettings',
      'DIM_ReportingGroups',
      'DIM_TableColumnLookups',
      'DIM_TerminalScript',
      'DIM_Users',
      'DIM_UserSecurity',
      'DIM_UTCOffsets',
      'DIM_VehicleParts',
      'FACT_PassengerActivities',
      'FACT_ShapeActivity',
      'DIM_MapProviderDetails',
      'FACT_PositionDetails'
      )
    ORDER BY t.name DESC;

  WHILE EXISTS (SELECT 1 FROM [Control].RollbackTableList WHERE Processed = 0)
  BEGIN
    
    SELECT TOP 1
      @tableName = MiXDataTableName
    FROM
      [Control].RollbackTableList 
    WHERE Processed = 0
    ORDER BY RID;

    DELETE @TmpColumn;
    SELECT @OrgKeyFlag = 0;

    INSERT INTO @TmpColumn
    SELECT
      c.column_id,
      ColumnName = c.name,
      Processed  = 0
    FROM
      [MiXData].sys.objects o
        inner join
      [MiXData].sys.tables  t on o.object_id = t.object_id
        inner join
      [MiXData].sys.columns c on t.object_id = c.object_id
    WHERE
        o.type = 'U'
    AND t.name = @tableName
    ORDER BY c.column_id;

    SELECT @columnList = '';
    WHILE EXISTS (SELECT 1 FROM @TmpColumn WHERE Processed = 0)
    BEGIN

      SELECT TOP 1 
        @primaryKey         = CASE
                                WHEN c.column_id = 1
                                  THEN c.ColumnName
                                ELSE @primaryKey
                              END,
        @columnList         = CASE
                                WHEN c.column_id = 1
                                  THEN ''
                                WHEN @columnList = '' and c.ColumnName <> 'OrganisationKey'
                                  THEN c.ColumnName + ' = r.' + c.ColumnName
                                WHEN @columnList <> '' and c.ColumnName <> 'OrganisationKey'
                                  THEN @columnList + ', ' + c.ColumnName + ' = r.' + c.ColumnName
                                ELSE ''
                              END,
        @columnReInsertList = CASE
                                WHEN c.column_id = 1
                                  THEN ''
                                WHEN @columnReInsertList = ''  and c.column_id > 1
                                  THEN c.ColumnName
                                WHEN @columnReInsertList <> '' and c.column_id > 1
                                  THEN @columnReInsertList + ', ' + c.ColumnName
                                ELSE ''
                              END,
        @columnID           = c.column_id,
        @OrgKeyFlag         = CASE
                                WHEN @OrgKeyFlag = 0 and c.ColumnName = 'OrganisationKey'
                                  THEN 1
                                ELSE @OrgKeyFlag
                              END
      FROM @TmpColumn c
      WHERE Processed = 0;

      UPDATE @TmpColumn
      SET Processed = 1
      WHERE column_id = @columnID;

    END; -- end while

    UPDATE [Control].RollbackTableList
    SET
      RollbackColumnList     = @columnList,
      ReInsertColumnList     = @columnReInsertList,
      PrimaryKey             = @primaryKey,
      HasOrganisationKeyFlag = @OrgKeyFlag,
      IsSummaryTableFlag     = CASE
                                 WHEN MiXDataTableName like '%Daily%' 
                                   THEN 1
                                 WHEN MiXDataTableName in ('FACT_EventSummary','FACT_ShapeVisits')
                                   THEN 1
                                 ELSE 0
                               END,
      Processed              = 1
    WHERE
      MiXDataTableName = @tableName;

  END; -- end while

  -- set ReInsertColumnList to '' where it is not a summary table
  UPDATE
    [Control].RollbackTableList
  SET
    ReInsertColumnList = ''
  WHERE IsSummaryTableFlag = 0;

  RETURN 0;
  
END; -- end proc

GO
/****** Object:  StoredProcedure [Control].[sprPrintError]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- sprPrintError prints error information about the error that caused 
-- execution to jump to the CATCH block of a TRY...CATCH construct. 
-- Should be executed from within the scope of a CATCH block otherwise 
-- it will return without printing any error information.
CREATE PROCEDURE [Control].[sprPrintError] 
AS
BEGIN
    SET NOCOUNT ON;

    -- Print error information. 
    PRINT 'Error '     + CONVERT(varchar(50), ERROR_NUMBER()) +
        ', Severity '  + CONVERT(varchar(5),  ERROR_SEVERITY()) +
        ', State '     + CONVERT(varchar(5),  ERROR_STATE()) + 
        ', Procedure ' + ISNULL(ERROR_PROCEDURE(), '-') + 
        ', Line '      + CONVERT(varchar(5), ERROR_LINE());
    PRINT ERROR_MESSAGE();
END;

GO
/****** Object:  StoredProcedure [Control].[sprRemoveOrganisation]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprRemoveOrganisation]
(
  @organisationKey int,
  @debugMode       bit = 0
)
AS
BEGIN
   SET NOCOUNT ON;
  
  DECLARE @miXDataTableName       nvarchar(100);
  DECLARE @rollbackColumnList     nvarchar(max);
  DECLARE @primaryKey             nvarchar(100);
  DECLARE @strSQL                 nvarchar(max);
  DECLARE @strSQLExists VARCHAR(MAX);
  DECLARE @hasOrganisationKeyFlag bit = 0;
  DECLARE @nrOfRecordsAffected    int;
  DECLARE @nrOfRecordsLeft        int
  
  DECLARE @tableList table
  (
    MiXDataTableName       nvarchar(100),
    Processed              bit
  );

  DECLARE @recordsLeft table
  (
    NrOfRecordsLeft int
  );

  BEGIN TRY

    INSERT INTO @tableList
    ( MiXDataTableName, Processed )
    SELECT t.name,0
    FROM
        [MiXData].sys.objects o
          inner join -- select * from
        [MiXData].sys.tables  t on o.object_id = t.object_id
          inner join -- select * from
        [MiXData].sys.columns c on o.object_id = c.object_id      
    WHERE
        c.name = 'OrganisationKey'
    AND t.name not in ('DIM_Organisations','DIM_UTCOffsets')
    AND t.schema_id = 1
    ORDER BY t.name;

    WHILE EXISTS (SELECT 1 FROM @tableList WHERE Processed = 0)
    BEGIN
      
      SELECT TOP 1
        @miXDataTableName       = MiXDataTableName
      FROM
        @tableList
      WHERE
        Processed = 0;

      -- remove inserted records
      SELECT @strSQL = 'DELETE TOP (5000000) FROM [MiXData].dbo.' + @mixDataTableName 
                     + ' WHERE OrganisationKey = ' + CONVERT(NVARCHAR(20),@organisationKey) + ';';
      
      SELECT @strSQLExists = 'SELECT NrOfRecordsLeft = ISNULL(COUNT(1),0) FROM [MiXData].dbo.' + @mixDataTableName 
                           + ' WHERE OrganisationKey = ' + CONVERT(NVARCHAR(20),@organisationKey) + ';';

      SELECT @nrOfRecordsAffected = 0;
      
      INSERT INTO @recordsLeft
      SELECT 1;
      WHILE EXISTS(SELECT 1 FROM @recordsLeft WHERE NrOfRecordsLeft > 0)
      BEGIN
        EXECUTE (@strSQL);
        SELECT @nrOfRecordsAffected = @nrOfRecordsAffected + @@ROWCOUNT;

        DELETE @recordsLeft;
        INSERT INTO @recordsLeft (NrOfRecordsLeft)
        EXECUTE (@strSQLExists);
      END;
      
      -- SELECT @nrOfRecordsAffected = @@ROWCOUNT;

      IF @debugMode = 1
        PRINT CONVERT(NCHAR(15),@nrOfRecordsAffected) + ': ' + @strSQL;

      UPDATE @tableList
      SET Processed = 1
      WHERE MiXDataTableName = @miXDataTableName;

    END -- end while

    DELETE [Control].OrganisationTableController
    WHERE OrganisationKey = @organisationKey;

    UPDATE -- select * from
      Control.OrganisationController
    SET
      IsFinished        = 1,
      LastSuccessbatch  = null,
      CurrentThreaduser = null, 
      CurrentBatch      = null,
      LastUpdateSuccess = 0,
      LastProcessingAttemptDate  = null,
      LastProcessingCompleteDate = null,
      DBChangeTrackVersionDate   = null,
      DBChangeTrackVersion       = null,
      ErrorEncountered = 0,
      ScheduleDateTime = NULL,
      NumberOfExtractAttempts = 0
    WHERE OrganisationKey = @organisationKey;
  
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_CurrentBatchDetails]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_CurrentBatchDetails]
AS
BEGIN

  DECLARE @currentBatchKey INT = NULL;
  DECLARE @currentDateTime DATETIMEOFFSET(0) = SYSUTCDATETIME();
  DECLARE @lastXBathces    INT = 3;
  DECLARE @averageBatchDurationXOrgsS INT;

  DECLARE @organisationController TABLE
  (
    OrganisationID                  INT PRIMARY KEY,
    OrganisationKey                 INT NULL,
    IsFinished                      BIT NULL,
    BActive                         BIT NULL,
    DWActive                        BIT NULL,
    UTCOffset                       INT NULL,
    LastSuccessbatch                INT NULL,
    CurrentBatch                    INT NULL,
    LastProcessingAttemptDate       DATETIMEOFFSET (7) NULL,
    LastProcessingCompleteDate      DATETIMEOFFSET (7) NULL,
    ErrorEncountered                INT NULL,
    
    ProcessingSlotHour              INT NULL,
    FinishedHour                    INT NULL,
    HoursSinceLastProcessed         INT NULL,
    HoursSinceLastShouldBeProcessed INT NULL
  );

  DECLARE @performanceMonitor TABLE
  (
    MonitorID             INT PRIMARY KEY,
    BatchID               INT,
    OrganisationKey       INT,
    ActionType            NCHAR    (20) NULL,
    ActionObjectName      NVARCHAR (50) NULL,
    StepStartTime         DATETIMEOFFSET (7) NULL,
    StepEndTime           DATETIMEOFFSET (7) NULL,
    RecordsInserted       INT NULL,
    RecordsUpdated        INT NULL,
    RecordsDeleted        INT NULL,
    DurationS             INT NULL
  );

  SELECT @currentBatchKey = ISNULL(@currentBatchKey,MAX(BatchID))
  FROM [Control].BatchController;

  ;WITH OrganisationPreCalculations AS
  (
    SELECT
      oc.OrganisationID,
      ProcessingSlotHour        = CASE 
                                    WHEN UTCOffset >= 0 
                                      THEN 23-(UTCOffset/(60*60))
                                    ELSE (-UTCOffset/(60*60)) - 1
                                  END,
      FinishedHour              = CASE
                                    WHEN oc.LastProcessingAttemptDate < oc.LastProcessingCompleteDate
                                      THEN DATEPART(hour,oc.LastProcessingCompleteDate)
                                    ELSE -1
                                  END,
      HoursSinceLastProcessed   = DATEDIFF(hour,oc.LastProcessingAttemptDate,@currentDateTime)
    FROM
      [Control].OrganisationController oc WITH (NOLOCK)
  )
  INSERT INTO @organisationController
  (
    OrganisationID                 ,
    OrganisationKey                ,
    IsFinished                     ,
    BActive                        ,
    DWActive                       ,
    UTCOffset                      ,
    LastSuccessbatch               ,
    CurrentBatch                   ,
    LastProcessingAttemptDate      ,
    LastProcessingCompleteDate     ,
    ErrorEncountered               ,
    ProcessingSlotHour             ,
    FinishedHour                   ,
    HoursSinceLastProcessed        ,
    HoursSinceLastShouldBeProcessed
  )
  SELECT
    oc.OrganisationID            ,
    oc.OrganisationKey           ,
    oc.IsFinished                ,
    oc.BActive                   ,
    oc.DWActive                  ,
    oc.UTCOffset                 ,
    oc.LastSuccessbatch          ,
    oc.CurrentBatch              ,
    oc.LastProcessingAttemptDate ,
    oc.LastProcessingCompleteDate,
    oc.ErrorEncountered          ,
    opc.ProcessingSlotHour       ,
    opc.FinishedHour             ,
    opc.HoursSinceLastProcessed  ,
    HoursSinceLastShouldBeProcessed = CASE 
                                        WHEN opc.ProcessingSlotHour < DATEPART(HOUR,@currentDateTime) 
                                          THEN DATEPART(HOUR,@currentDateTime) - opc.ProcessingSlotHour
                                        ELSE (24 - opc.ProcessingSlotHour + DATEPART(HOUR,@currentDateTime))
                                      END
  FROM
    OrganisationPreCalculations      opc
      INNER JOIN
    [Control].OrganisationController oc WITH (NOLOCK) ON oc.OrganisationID = opc.OrganisationID;

  INSERT INTO @performanceMonitor
  (
    MonitorID       ,
    BatchID         ,
    OrganisationKey ,
    ActionType      ,
    ActionObjectName,
    StepStartTime   ,
    StepEndTime     ,
    RecordsInserted ,
    RecordsUpdated  ,
    RecordsDeleted  ,
    DurationS
  )
  SELECT
    MonitorID       ,
    BatchID         ,
    OrganisationKey ,
    ActionType      ,
    ActionObjectName,
    StepStartTime   ,
    StepEndTime     ,
    RecordsInserted ,
    RecordsUpdated  ,
    RecordsDeleted  ,
    DurationS       = CASE
                        WHEN StepStartTime < StepEndTime
                          THEN DATEDIFF(s,StepStartTime,StepEndTime)
                        ELSE 0
                      END
  FROM
    [Control].PerformanceMonitor pm WITH (NOLOCK)
  WHERE
    pm.BatchID = @currentBatchKey
  UNION
  SELECT
    MonitorID       ,
    BatchID         ,
    OrganisationKey ,
    ActionType      ,
    ActionObjectName,
    StepStartTime   ,
    StepEndTime     ,
    RecordsInserted ,
    RecordsUpdated  ,
    RecordsDeleted  ,
    DurationS       = CASE
                        WHEN StepStartTime < StepEndTime
                          THEN DATEDIFF(s,StepStartTime,StepEndTime)
                        ELSE 0
                      END
  FROM
    [Control].PerformanceMonitorHistory pmh WITH (NOLOCK)
  WHERE
    pmh.BatchID = @currentBatchKey;

  ;WITH BatchOrgsRank AS
  (
    SELECT
      CurrentBatch,
      OrganisationID,
      LastProcessingAttemptDate,
      LastProcessingCompleteDate,
      CompletedRank = ROW_NUMBER() OVER (PARTITION BY CurrentBatch ORDER BY LastProcessingCompleteDate)
      -- select top 10 *
    FROM
      [Control].OrganisationControllerHistory och
    WHERE
      CurrentBatch >= @currentBatchKey - @lastXBathces
    UNION
    SELECT
      CurrentBatch,
      OrganisationID,
      LastProcessingAttemptDate,
      LastProcessingCompleteDate,
      CompletedRank = ROW_NUMBER() OVER (PARTITION BY CurrentBatch ORDER BY LastProcessingCompleteDate)
      -- select top 10 *
    FROM
      [Control].OrganisationController oc
    WHERE
      CurrentBatch >= @currentBatchKey - @lastXBathces
  ),
  BatchStatsForLastXOrgs AS
  (
    SELECT
      bc.BatchID,
      BatchDurationXOrgsS = DATEDIFF(s,MIN(bc.BatchStart),MAX(LastProcessingCompleteDate))
    FROM
      [Control].BatchController bc
        INNER JOIN
      BatchOrgsRank             bor ON bc.BatchID = bor.CurrentBatch
    WHERE
      bc.BatchID BETWEEN @currentBatchKey - @lastXBathces AND @currentBatchKey -1
    AND bor.CompletedRank = (SELECT COUNT(1) FROM @organisationController WHERE CurrentBatch = @currentBatchKey)
    GROUP BY
      bc.BatchID
  )
  SELECT
    @averageBatchDurationXOrgsS = AVG(BatchDurationXOrgsS)
  FROM
    BatchStatsForLastXOrgs;

  ;WITH PerformanceMonitoring AS
  (
    SELECT
      NrOfRecExtracted  = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Extract'   THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLIns     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLUpd     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsUpdated  ELSE 0 END),0),
      NrOfRecETLDel     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsDeleted  ELSE 0 END),0),
      NrOfRecNoteworthy = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Extract'   AND pm.ActionObjectName = 'GPSData'          THEN pm.RecordsInserted  ELSE 0 END),0),
      NrOfRecGeoIns     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' AND pm.ActionObjectName = 'DIM_GeoLocations' THEN pm.RecordsInserted  ELSE 0 END),0),
      DurationExtractS  = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Extract'   THEN pm.DurationS ELSE 0 END),0),
      DurationETLS      = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.DurationS ELSE 0 END),0)
    FROM
      @performanceMonitor pm
  )
  SELECT
    BatchID,
    BatchStart,
    BatchEnd,
    CurrentDurationSeconds = DATEDIFF(second,BatchStart,ISNULL(BatchEnd,@currentDateTime)),
    CurrentDuration        = CONVERT(CHAR(3),DATEDIFF(hour  ,BatchStart,ISNULL(BatchEnd,@currentDateTime)))    + 'h ' +
                             CONVERT(CHAR(2),DATEDIFF(minute,BatchStart,ISNULL(BatchEnd,@currentDateTime))%60) + 'm ' +
                             CONVERT(CHAR(2),DATEDIFF(second,BatchStart,ISNULL(BatchEnd,@currentDateTime))%60) + 's'
                             ,
    CurrentDateTime        = @currentDateTime,
    BatchStatus            = CASE 
                               WHEN BatchShouldStop = 1 THEN 'Batch in Manual Stop Status'
                               WHEN HasFailed       = 1 THEN 'Batch has Failed'
                               WHEN BatchBusy       = 1 THEN 'Batch is Busy'
                               ELSE 'Batch is Complete' 
                             END,
    BatchTotalDBToComplete = (SELECT COUNT(1)
                              FROM @organisationController
                              WHERE DWActive = 1 AND BActive = 1),
    BatchDBCompleted       = (SELECT COUNT(1)
                              FROM @organisationController oc1
                              WHERE 
                                  oc1.DWActive     = 1 
                              AND oc1.BActive      = 1
                              AND oc1.IsFinished   = 1
                              AND oc1.CurrentBatch = bc.BatchID),
    BatchDBBusy            = (SELECT COUNT(1)
                              FROM @organisationController oc2
                              WHERE 
                                  oc2.DWActive     = 1 
                              AND oc2.BActive      = 1
                              AND oc2.IsFinished   = 0
                              AND oc2.CurrentBatch = bc.BatchID),
    BatchDBStillToComplete = (SELECT COUNT(1)
                              FROM @organisationController oc2
                              WHERE 
                                  oc2.DWActive     = 1 
                              AND oc2.BActive      = 1
                              AND oc2.IsFinished   = 1
                              AND oc2.CurrentBatch < bc.BatchID),
    BatchDBCurrentlyToBeProcessed = (SELECT COUNT(1)
                                     FROM @organisationController oc2
                                     WHERE 
                                         oc2.DWActive     = 1 
                                     AND oc2.BActive      = 1
                                     AND oc2.HoursSinceLastShouldBeProcessed < oc2.HoursSinceLastProcessed),
    BatchDBSuccessful      = (SELECT COUNT(1)
                              FROM @organisationController oc3
                              WHERE 
                                  oc3.DWActive     = 1 
                              AND oc3.BActive      = 1
                              AND oc3.IsFinished   = 1
                              AND oc3.CurrentBatch = bc.BatchID
                              AND oc3.CurrentBatch = oc3.LastSuccessBatch),
    BatchDBFailed          = (SELECT COUNT(1)
                              FROM @organisationController oc4
                              WHERE 
                                  oc4.DWActive     = 1 
                              AND oc4.BActive      = 1
                              AND oc4.IsFinished   = 1
                              AND oc4.CurrentBatch = bc.BatchID
                              AND oc4.CurrentBatch <> oc4.LastSuccessBatch),
    NrOfRecExtracted       = (SELECT SUM(1)
                              FROM @performanceMonitor pm
                              WHERE 
                                  pm.ActionType    = 'Extract'),
    pm.NrOfRecETLIns,
    pm.NrOfRecETLUpd,
    pm.NrOfRecETLDel,
    pm.NrOfRecNoteworthy,
    pm.NrOfRecGeoIns,
    pm.DurationExtractS,
    pm.DurationETLS,
    PreviousBatchDurationS = (SELECT DATEDIFF(second,BatchStart,ISNULL(BatchEnd,@currentDateTime))
                              FROM
                                [Control].BatchController bcp WITH (NOLOCK)
                              WHERE
                                bcp.BatchID = @currentBatchKey - 1),
    AverageBatchDurationXOrgsS = @averageBatchDurationXOrgsS
  FROM
    PerformanceMonitoring     pm
      CROSS JOIN
    [Control].BatchController bc WITH (NOLOCK)
  WHERE
    bc.BatchID = @currentBatchKey;
  
  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_CurrentlyProcessingOrganisations]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_CurrentlyProcessingOrganisations]
AS
BEGIN

  DECLARE @currentBatchKey INT = NULL;
  DECLARE @currentDateTime DATETIMEOFFSET(0) = SYSUTCDATETIME();
  DECLARE @lastXBathces    INT = 3;

  DECLARE @organisationController TABLE
  (
    OrganisationID                  INT PRIMARY KEY,
    OrganisationKey                 INT NULL,
    OrganisationName                NVARCHAR (200),
    DatabaseName                    NVARCHAR (256),

    ThreadUser                      NVARCHAR (100),
    LastSuccessbatch                INT NULL,
    CurrentBatch                    INT NULL,

    CurrentDurationS                INT NULL,
    PreviousDurationS               INT NULL,
    AverageDurationS                INT NULL,
    
    LastProcessingAttemptDate       DATETIMEOFFSET (7) NULL,
    LastProcessingCompleteDate      DATETIMEOFFSET (7) NULL,
    ErrorEncountered                INT NULL,
    
    ProcessingSlotHour              INT NULL,
    HoursSinceLastProcessed         INT NULL,
    HoursSinceLastShouldBeProcessed INT NULL
  );

  ;WITH OrganisationPreCalcs AS
  (
    SELECT
      oc.OrganisationID,
      oc.CurrentBatch,
      CurrentDurationS          = DATEDIFF(s,oc.LastProcessingAttemptDate,@currentDateTime),
      ProcessingSlotHour        = CASE 
                                    WHEN UTCOffset >= 0 
                                      THEN 23-(UTCOffset/(60*60))
                                    ELSE (-UTCOffset/(60*60)) - 1
                                  END,
      FinishedHour              = CASE
                                    WHEN oc.LastProcessingAttemptDate < oc.LastProcessingCompleteDate
                                      THEN DATEPART(hour,oc.LastProcessingCompleteDate)
                                    ELSE -1
                                  END,
      HoursSinceLastProcessed   = DATEDIFF(hour,oc.LastProcessingAttemptDate,@currentDateTime),
      PreviousBatchID           = (SELECT MAX(CurrentBatch) 
                                   FROM [Control].OrganisationControllerHistory WITH (NOLOCK))
    FROM
      [Control].OrganisationController oc WITH (NOLOCK)
    WHERE
        oc.IsFinished = 0 -- currently busy
    AND oc.DWActive   = 1
    AND oc.BActive    = 1
  ),
  PreviousBatchOrgCalcs AS
  (
    SELECT
      opc.OrganisationID,
      PreviousDurationS = (SELECT AVG(CASE
                                        WHEN och.LastProcessingAttemptDate <= och.LastProcessingCompleteDate
                                          THEN
                                            DATEDIFF(s,och.LastProcessingAttemptDate,och.LastProcessingCompleteDate)
                                        ELSE NULL
                                      END)
                           FROM [Control].OrganisationControllerHistory och WITH (NOLOCK)
                           WHERE
                               och.OrganisationID = opc.OrganisationID
                           AND och.CurrentBatch   = opc.PreviousBatchID),
      AverageDurationS  = (SELECT AVG(CASE
                                        WHEN och.LastProcessingAttemptDate <= och.LastProcessingCompleteDate
                                          THEN
                                            DATEDIFF(s,och.LastProcessingAttemptDate,och.LastProcessingCompleteDate)
                                        ELSE NULL
                                      END)
                           FROM [Control].OrganisationControllerHistory och WITH (NOLOCK)
                           WHERE 
                               och.OrganisationID = opc.OrganisationID
                           AND och.CurrentBatch   BETWEEN opc.CurrentBatch - @lastXBathces AND opc.PreviousBatchID)
    FROM
      OrganisationPreCalcs opc
  )
  INSERT INTO @organisationController
  (
    OrganisationID              ,
    OrganisationKey             ,
    OrganisationName            ,
    DatabaseName                ,
    ThreadUser                  ,
    LastSuccessbatch            ,
    CurrentBatch                ,
    LastProcessingAttemptDate   ,
    LastProcessingCompleteDate  ,
    ErrorEncountered            ,
    CurrentDurationS            ,
    PreviousDurationS           ,
    AverageDurationS            ,
    ProcessingSlotHour          ,
    HoursSinceLastProcessed     ,
    HoursSinceLastShouldBeProcessed
  )
  SELECT
    oc.OrganisationID              ,
    oc.OrganisationKey             ,
    oc.OrganisationName            ,
    oc.DatabaseName                ,
    oc.CurrentThreaduser           ,
    oc.LastSuccessbatch            ,
    oc.CurrentBatch                ,
    oc.LastProcessingAttemptDate   ,
    oc.LastProcessingCompleteDate  ,
    oc.ErrorEncountered            ,
    opc.CurrentDurationS           ,
    pop.PreviousDurationS          ,
    pop.AverageDurationS           ,
    opc.ProcessingSlotHour         ,
    opc.HoursSinceLastProcessed    ,
    HoursSinceLastShouldBeProcessed = CASE 
                                        WHEN opc.ProcessingSlotHour < DATEPART(HOUR,@currentDateTime) 
                                          THEN DATEPART(HOUR,@currentDateTime) - opc.ProcessingSlotHour
                                        ELSE (24 - opc.ProcessingSlotHour + DATEPART(HOUR,@currentDateTime))
                                      END
  FROM
    PreviousBatchOrgCalcs            pop
      INNER JOIN
    OrganisationPreCalcs             opc               ON opc.OrganisationID = pop.OrganisationID
      INNER JOIN
    [Control].OrganisationController oc  WITH (NOLOCK) ON oc.OrganisationID  = opc.OrganisationID;

  ;WITH PerformanceMonitoringCalcs AS
  (
    SELECT
      pm.OrganisationKey,
      NrOfRecExtracted  = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Extract'   THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLIns     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLUpd     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsUpdated  ELSE 0 END),0),
      NrOfRecETLDel     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsDeleted  ELSE 0 END),0),
      LastProcessingID  = MAX(pm.MonitorID) 
    FROM
      @organisationController oc
        INNER JOIN -- select top 10 * from
      [Control].PerformanceMonitor pm WITH (NOLOCK) ON pm.OrganisationKey = oc.OrganisationKey
    GROUP BY
      pm.OrganisationKey
  )
  SELECT
    oc.OrganisationID              ,
    oc.OrganisationKey             ,
    oc.OrganisationName            ,
    oc.DatabaseName                ,
    oc.ThreadUser                  ,
    oc.LastSuccessbatch            ,
    oc.CurrentBatch                ,
    oc.LastProcessingAttemptDate   ,
    oc.LastProcessingCompleteDate  ,
    oc.ErrorEncountered            ,
    oc.CurrentDurationS            ,
    oc.PreviousDurationS           ,
    oc.AverageDurationS            ,
    oc.ProcessingSlotHour          ,
    oc.HoursSinceLastProcessed     ,
    oc.HoursSinceLastShouldBeProcessed,
    pmc.NrOfRecExtracted           ,
    pmc.NrOfRecETLIns              ,
    pmc.NrOfRecETLUpd              ,
    pmc.NrOfRecETLDel              ,
    LastProcessingActionType       = (SELECT pm.ActionType
                                      FROM [Control].PerformanceMonitor pm WITH (NOLOCK)
                                      WHERE pm.MonitorID = pmc.LastProcessingID),
    LastProcessingActionObject     = (SELECT pm.ActionObjectName
                                      FROM [Control].PerformanceMonitor pm WITH (NOLOCK)
                                      WHERE pm.MonitorID = pmc.LastProcessingID)
  FROM
    @organisationController    oc
      LEFT JOIN
    PerformanceMonitoringCalcs pmc ON pmc.OrganisationKey = oc.OrganisationKey;

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_HourlyBatchComparison]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_HourlyBatchComparison]
AS
BEGIN

  DECLARE @currentBatchKey     INT = NULL;
  DECLARE @currentDateTime     DATETIMEOFFSET(0) = SYSUTCDATETIME();
  DECLARE @statsForLastXDays   INT = 3;
  DECLARE @loopCounter         INT = 0;
  DECLARE @loopDateTime        DATETIME;

  DECLARE @lastXDaysHourlyStats TABLE
  (
    DateKey    DATE,
    HourlySlot INT,  -- 0 to 23
    NrOfOrgsToProcess INT NULL,
    NrOfOrgsProcessed INT NULL
    PRIMARY KEY (DateKey,HourlySlot)
  );

  SELECT @loopDateTime = DATEADD(day,-@statsForLastXDays+1,CONVERT(DATE,@currentDateTime))
  
  WHILE @loopCounter < (@statsForLastXDays*24)
  BEGIN

    INSERT INTO @lastXDaysHourlyStats
    ( DateKey, HourlySlot )
    SELECT
      CONVERT(DATE,@loopDateTime),
      DATEPART(HOUR,@loopDateTime);

    SELECT @loopDateTime = DATEADD(hour,1,@loopDateTime);
    SELECT @loopCounter = @loopCounter + 1;
  END;

  ;WITH OrganisationHistory AS
  (
    SELECT
      OrganisationID,
      LastProcessingAttemptDate,
      LastProcessingCompleteDate,
      AttemptedDateKey    = CONVERT(DATE,LastProcessingAttemptDate),
      CompletedDateKey    = CONVERT(DATE,LastProcessingCompleteDate),
      AttemptedHourlySlot = DATEPART(HOUR,LastProcessingAttemptDate),
      CompletedHourlySlot = DATEPART(HOUR,LastProcessingCompleteDate),
      ProcessingSlotHour  = CASE 
                              WHEN UTCOffset >= 0 
                                THEN 23-(UTCOffset/(60*60))
                              ELSE (-UTCOffset/(60*60)) - 1
                            END
    FROM
      [Control].OrganisationControllerHistory och WITH (NOLOCK)
    WHERE 
        och.DWActive = 1
    AND och.BActive  = 1
    AND och.LastProcessingAttemptDate >= DATEADD(day,-@statsForLastXDays+1,CONVERT(DATE,@currentDateTime))
    UNION
    SELECT
      OrganisationID,
      LastProcessingAttemptDate,
      LastProcessingCompleteDate,
      AttemptedDateKey    = CONVERT(DATE,LastProcessingAttemptDate),
      CompletedDateKey    = CONVERT(DATE,LastProcessingCompleteDate),
      AttemptedHourlySlot = DATEPART(HOUR,LastProcessingAttemptDate),
      CompletedHourlySlot = DATEPART(HOUR,LastProcessingCompleteDate),
      ProcessingSlotHour  = CASE 
                              WHEN UTCOffset >= 0 
                                THEN 23-(UTCOffset/(60*60))
                              ELSE (-UTCOffset/(60*60)) - 1
                            END
    FROM
      [Control].OrganisationController oc WITH (NOLOCK)
    WHERE 
        oc.DWActive = 1
    AND oc.BActive  = 1
    AND oc.LastProcessingAttemptDate >= DATEADD(day,-@statsForLastXDays+1,CONVERT(DATE,@currentDateTime))
    
  ),
  CurrentOrganisations AS
  (
    SELECT
      OrganisationID,
      ProcessingSlotHour  = CASE 
                              WHEN UTCOffset >= 0 
                                THEN 23-(UTCOffset/(60*60))
                              ELSE (-UTCOffset/(60*60)) - 1
                            END
    FROM
      [Control].OrganisationController oc WITH (NOLOCK)
    WHERE 
        oc.DWActive = 1
    AND oc.BActive  = 1
  )
  UPDATE
    hs
  SET
    NrOfOrgsToProcess = (SELECT COUNT(DISTINCT OrganisationID)
                         FROM CurrentOrganisations oh
                         WHERE
                             oh.ProcessingSlotHour = hs.HourlySlot),
    NrOfOrgsProcessed = (SELECT COUNT(DISTINCT OrganisationID)
                         FROM OrganisationHistory oh
                         WHERE
                             oh.CompletedDateKey    = hs.DateKey
                         AND oh.CompletedHourlySlot = hs.HourlySlot)
  FROM
    @lastXDaysHourlyStats hs;

  SELECT *
  FROM @lastXDaysHourlyStats
  WHERE
      NrOfOrgsToProcess > 0
  OR NrOfOrgsProcessed > 0
  ORDER BY
    DateKey,
    HourlySlot;

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_MonitorDataTransmittedPerDay]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_MonitorDataTransmittedPerDay]
(
  @numberOfDaysBack INT
)
AS
BEGIN 
  SET NOCOUNT ON;

  DECLARE @ExtractData TABLE
  (
    ExecutionID     NVARCHAR(64),
    TimeStart       DATETIME, 
    OrganisationID  INT NULL,	
    ByteCount       INT
  )
  INSERT INTO @ExtractData
  (
    ExecutionID     ,
    TimeStart       , 	
    OrganisationID  , 
    ByteCount	
  )
  SELECT DISTINCT 
    ExecutionID                 ,
    MAX(CONVERT(DATE,Timestart)),  	
    dbo.fncGetListItem( REPLACE(CONVERT(NVARCHAR(MAX),Parameters) ,'&',';'),'ParamOrganisationListFM',-1),  
    MAX(ByteCount)
  FROM 
    [ReportServer].[dbo].ExecutionLog2 WITH (NOLOCK)
  WHERE 
      TimeStart   > convert(date,GETDATE()-@numberOfDaysBack+1)
  AND	STATUS  = 'rsSuccess'
  GROUP BY 
    ExecutionID, 
    dbo.fncGetListItem( REPLACE(CONVERT(NVARCHAR(MAX),Parameters) ,'&',';'),'ParamOrganisationListFM',-1);

  ;WITH ReturnBytesTransferred AS
  (
    SELECT
      TimeStart                               ,
      ISNULL(O.CountryCode ,'') CountryCode   ,
      SUM(ByteCount) ByteCount
    FROM
      @ExtractData ED
        LEFT JOIN 
      [MiXData].dbo.DIM_Organisations O WITH (NOLOCK) ON ED.OrganisationID = O.HostID
    GROUP BY
      TimeStart, 
      CountryCode
  )
  SELECT
    TimeStart       ,
    CountryCode	    , 
    ByteCount 	    
  FROM
    ReturnBytesTransferred    
  ORDER BY
    TimeStart DESC;

  RETURN 0;		
	    
END;

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_MonitorReportErrors]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_MonitorReportErrors] 
(
	@numberOfDaysBack INT
 )
 AS


BEGIN 

DECLARE @ExtractData TABLE
(
UserName          NVARCHAR(260),
ExecutionID       NVARCHAR(64),
TimeStart         DATETIME, 
ReportPath        NVARCHAR(425),
ReportName        NVARCHAR(425),
TimeDataRetrieval BIGINT,
TimeProcessing    BIGINT,
TimeRendering     BIGINT,
Parameters        NVARCHAR(max),
ByteCount         BIGINT,
[RowCount]        BIGINT,
OrganizationID    INT NULL,
RequestType       VARCHAR(12),
Status            NVARCHAR(40)
)


;INSERT INTO @ExtractData
(
  Username        , 
  ExecutionID     , 
  Timestart       , 
  reportPath      ,
  ReportName      , 
  TimeDataRetrieval, 
  TimeProcessing  , 
  TimeRendering   , 
  Parameters      , 
  Bytecount       , 
  [Rowcount]      , 
  RequestType     , 
  status
)
Select 
  Username        , 
  ExecutionID     , 
  Timestart       , 
  reportPath      , 
  reportPath      ,  
  TimeDataRetrieval, 
  TimeProcessing  , 
  TimeRendering   , 
  Parameters      , 
  Bytecount       , 
  [Rowcount]      , 
  RequestType     , 
  status
FROM	 
  [ReportServer].[dbo].ExecutionLog2 (NOLOCK)
WHERE 
  TimeStart > convert(date,GETDATE()-(@numberOfDaysBack+1));


;SELECT 
  ReportName      , 
  Status          , 
  TimeStart       ,
  TotalRunTime=(TimeDataRetrieval+TimeProcessing+TimeRendering) , 
  OrganisationName, 
  O.CountryCode   , 
  UserName 
FROM 
  @ExtractData ED 
    LEFT JOIN [MiXData].dbo.DIM_Organisations O (NOLOCK)
      on ED.OrganizationID = O.hostID
WHERE 
  Status NOT IN ('rsSuccess','rsProcessingAborted') --,'rsAccessDenied');

		
	RETURN 0;		
	    
END

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_MonitorRowsTransmittedPerDay]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_MonitorRowsTransmittedPerDay]
(
	@numberOfDaysBack INT
 )
 AS

BEGIN 
	DECLARE @ExtractData Table
	(
	  ExecutionID NVARCHAR(64)    ,
	  TimeStart DATETIME          , 
	  OrganizationID INT NULL     ,	
	  ReportRowCount INT
	)
	
	;INSERT INTO @ExtractData
		(
		  ExecutionID,
		  TimeStart, 	
		  OrganizationID, 
		  ReportRowCount	
		)	
	SELECT DISTINCT 
		ExecutionID                     ,
		MAX(CONVERT(DATE,Timestart))    ,  	
		dbo.fncGetListItem( REPLACE(CONVERT(NVARCHAR(MAX),Parameters) ,'&',';'),'ParamOrganisationListFM',-1),  
		MAX([RowCount])
	FROM 
	  [ReportServer].dbo.ExecutionLog2 WITH (NOLOCK)
	WHERE 
	  TimeStart  > convert(date,GETDATE()-@numberOfDaysBack+1)
	  AND	STATUS = 'rsSuccess'
	GROUP BY 
	  ExecutionID, 
	  dbo.fncGetListItem( REPLACE(CONVERT(NVARCHAR(MAX),Parameters) ,'&',';'),'ParamOrganisationListFM',-1);

	;WITH ReturnRowsTransferred AS
		(
		
		SELECT
		TimeStart,
		CountryCode=ISNULL(O.CountryCode,'') ,
		ReportRowCount=SUM(ReportRowCount) 
		FROM @ExtractData ED
				LEFT JOIN [MiXData].dbo.DIM_Organisations O (NOLOCK)
				ON ED.OrganizationID = O.hostID
		GROUP BY 
		TimeStart,
		CountryCode
	  )
	  SELECT
		  TimeStart  ,
		  CountryCode,
		  ReportRowCount 
	    
	  FROM
		  ReturnRowsTransferred    
	  ORDER BY
		  TimeStart DESC;

	RETURN 0;		

END

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_MonitorSubscriptionFailures]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_MonitorSubscriptionFailures]
(
	@numberOfDaysBack INT
 )
 AS

BEGIN 

;SELECT 
  ModifiedDate, 
  Description, 
  LastStatus
FROM 
  [ReportServer].[dbo].Subscriptions (nolock)
WHERE 
  LastStatus                      like '%Failure%'
  AND convert(date,ModifiedDate ) < Convert(date,(GETDATE()-@numberOfDaysBack));

	Return 0;		
	    
END

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_MonitorTopXActiveOrganisations]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [Control].[sprReportDashboard_MonitorTopXActiveOrganisations]
(
  @numberOfDaysBack INT, 
  @TopQuantity INT)
AS


BEGIN

	DECLARE @ExtractData TABLE
	(
	  ExecutionID NVARCHAR(64)  ,
	  UserName NVARCHAR(260)    ,
	  ReportName NVARCHAR(425)  ,
	  TimeStart DATETIME        , 	
	  OrganizationID INT NULL   ,	
	  ByteCount INT             ,
	  [RowCount] INT            ,
	  TimeDataRetrieval INT     ,
	  TimeProcessing INT        ,
	  TimeRendering INT
	)
	

	;INSERT INTO @ExtractData
	(
	  ExecutionID			  ,
	  UserName			    ,
	  ReportName			  ,	 
	  OrganizationID		,
	  TimeStart			    ,
	  TimeDataRetrieval	, 
	  TimeProcessing		, 
	  TimeRendering		  ,
	  ByteCount			    , 
	  [RowCount]
	)
	SELECT DISTINCT 
		ExecutionID								              ,
		UserName								                ,
		ReportPath								              ,				
		dbo.fncGetListItem( REPLACE(CONVERT(NVARCHAR(MAX),Parameters) ,'&',';'),'ParamOrganisationListFM',-1),
		MAX(CONVERT(DATE,Timestart))			      , 
		SUM(TimeDataRetrieval) TimeDataRetrieval,
		SUM(TimeProcessing) TimeProcessing		  ,
		SUM(TimeRendering) TimeRendering		    ,
		MAX(ByteCount)							            ,
		MAX([ROWCOUNT])		 
	FROM	
	  [ReportServer].dbo.ExecutionLog2 (NOLOCK)
	WHERE	
	  TimeStart   > convert(date,GETDATE()-(@numberOfDaysBack+1))
	  AND	STATUS  = 'rsSuccess'
	GROUP BY 
			ExecutionID,
			UserName, 
			ReportPath,
			dbo.fncGetListItem( REPLACE(CONVERT(NVARCHAR(MAX),Parameters) ,'&',';'),'ParamOrganisationListFM',-1)

		
	;WITH ReturnTOPActiveOrganisations AS
		(		
		SELECT 
			OrganisationName= ISNULL(O.OrganisationName,'Not Defined')				,
			CountryCode		  = ISNULL(O.CountryCode,'N/A')							,
			RequestsCount 	= COUNT(DISTINCT ExecutionID)									,
			MaxRunTime		  = MAX(TimeDataRetrieval+TimeProcessing+TimeRendering)	,			
			ByteCount		    = SUM(ByteCount)										,
			[RowCount]		  = SUM([RowCount])										,
			AveRunTime		  = CASE 
								          WHEN SUM(TimeDataRetrieval+TimeProcessing+TimeRendering)<>0 and COUNT(ExecutionID)<>0 
								            THEN (SUM(TimeDataRetrieval+TimeProcessing+TimeRendering)/COUNT(ExecutionID))
								          ELSE 0 
								        END,	
			AveRecordCount	= CASE 
								          WHEN SUM([RowCount])<>0 and COUNT(ExecutionID)<>0 
								           THEN (SUM([RowCount])/COUNT(ExecutionID))
								          ELSE 0 END,	
			MaxRecordCount	= MAX([RowCount]),
			AveByteCount	  = CASE 
								          WHEN SUM(ByteCount)<>0 and COUNT(ExecutionID)<>0 
								            THEN (SUM(ByteCount)/COUNT(ExecutionID))
								          ELSE 0 
								        END,			
			MaxByteCount	  = MAX(ByteCount),														
			DurationRank	  = ROW_NUMBER() OVER (ORDER BY COUNT(DISTINCT ExecutionID) DESC)
		FROM
			@ExtractData ED
			  LEFT JOIN 
			  [MiXData].dbo.DIM_Organisations O (NOLOCK)
				  ON ED.OrganizationID = O.hostID
		GROUP BY 
			O.OrganisationName,
			O.CountryCode
		
	  )	  
	  SELECT 
		  OrganisationName	            ,		
		  CountryCode			              ,
		  TotalRequests = RequestsCount ,
		  MaxRunTime			              ,
		  AveRunTime			              ,
		  AveRecordCount		            ,
		  MaxRecordCount	            	,
		  AveByteCount		              ,
		  MaxByteCount	                ,
		  DurationRank
	  FROM
		  ReturnTOPActiveOrganisations
    WHERE 
      DurationRank <= @TopQuantity
	  ORDER BY
		  TotalRequests DESC;
		

RETURN 0;


END

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_MonitorTopXLongRunningReports]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_MonitorTopXLongRunningReports]
(
  @numberOfDaysBack INT, 
  @TopQuantity INT
)
AS



BEGIN
  SET NOCOUNT ON

	DECLARE @ExtractData Table
	(
	  ExecutionID     NVARCHAR(64),
	  UserName        NVARCHAR(260),
	  ReportName      NVARCHAR(425),
	  TimeStart       DATETIME, 	
	  OrganizationID  INT NULL,	
	  ByteCount       INT,
	  [RowCount]      INT,
	  TimeDataRetrieval INT,
	  TimeProcessing  INT,
	  TimeRendering   INT
	)

	;INSERT INTO @ExtractData
	(
	  ExecutionID			,
	  UserName			  ,
	  ReportName			,	 
	  OrganizationID	,
	  TimeStart			  ,
	  TimeDataRetrieval, 
	  TimeProcessing	, 
	  TimeRendering		,
	  ByteCount			  ,  
	  [RowCount]
	)
	SELECT DISTINCT 
		ExecutionID								  ,
		UserName								    ,
		ReportPath								  ,				
		dbo.fncGetListItem( REPLACE(CONVERT(NVARCHAR(MAX),Parameters) ,'&',';'),'ParamOrganisationListFM',-1),
		Max(Convert(date,Timestart)), 
		SUM(TimeDataRetrieval)      ,
		SUM(TimeProcessing) 		    ,
		SUM(TimeRendering) 		      ,
		MAX(ByteCount)							,
		MAX([ROWCOUNT])		 
	FROM	
	  [ReportServer].dbo.ExecutionLog2 (NOLOCK)
	WHERE	
	  TimeStart   > convert(date,GETDATE()-(@numberOfDaysBack+1))
	  AND	STATUS  = 'rsSuccess'
	GROUP BY 
			ExecutionID,
			UserName, 
			ReportPath,
			dbo.fncGetListItem( REPLACE(CONVERT(NVARCHAR(MAX),Parameters) ,'&',';'),'ParamOrganisationListFM',-1);
	
	
	;WITH ReturnTOPLongRunningReports AS
		(		
		SELECT 
			ReportName, 
			--RunTime			= SUM(TimeDataRetrieval+TimeProcessing+TimeRendering) ,
			MaxRunTime		= MAX(TimeDataRetrieval+TimeProcessing+TimeRendering) ,
			RequestsCount	= COUNT(ExecutionID) ,
			ByteCount		= SUM(ByteCount) ,
			[RowCount]		= SUM([RowCount]) ,
			AveRunTime		= CASE 
								      WHEN SUM(TimeDataRetrieval+TimeProcessing+TimeRendering)<>0 and COUNT(ExecutionID)<>0 THEN 
										      (SUM(TimeDataRetrieval+TimeProcessing+TimeRendering)/COUNT(ExecutionID))
								      ELSE 0 END,	
			AveRecordCount	= CASE 
								        WHEN SUM([RowCount])<>0 and COUNT(ExecutionID)<>0 THEN 
										        (SUM([RowCount])/COUNT(ExecutionID))
								        ELSE 0 END,	
			MaxRecordCount	= MAX([RowCount]),
			AveByteCount	= CASE 
							        WHEN SUM(ByteCount)<>0 and COUNT(ExecutionID)<>0 THEN 
									        (SUM(ByteCount)/COUNT(ExecutionID))
							        ELSE 0 END,			
			MaxByteCount	= MAX(ByteCount),														
			DurationRank	= ROW_NUMBER() OVER (ORDER BY MAX(TimeDataRetrieval+TimeProcessing+TimeRendering) DESC)
		FROM
			@ExtractData ED
			LEFT JOIN  [MiXData].dbo.DIM_Organisations O (NOLOCK)
				ON ED.OrganizationID = O.hostID
		GROUP BY ReportName 	
	  )	  
	  SELECT 
		  ReportName  ,		
		  TotalRequests = RequestsCount,
		  MaxRunTime	,
		  AveRunTime	,
		  AveRecordCount,
		  MaxRecordCount,
		  AveByteCount,
		  MaxByteCount	    
	  FROM
		  ReturnTOPLongRunningReports
    WHERE 
      DurationRank <= @TopQuantity
	  ORDER BY
		  MaxRunTime DESC
		
RETURN 0

SET NOCOUNT OFF
END

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_MonitorTopXReportsAccessed]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_MonitorTopXReportsAccessed]
(
  @numberOfDaysBack INT, 
  @TopQuantity INT
)
AS

	
BEGIN

DECLARE @ExtractData Table
	(
	  ExecutionID     NVARCHAR(64),
	  UserName        NVARCHAR(260),
	  ReportName      NVARCHAR(425),
	  TimeStart       DATETIME, 	
	  OrganizationID  INT null,	
	  ByteCount       INT,
	  [RowCount]      INT,
	  TimeDataRetrieval INT,
	  TimeProcessing  INT,
	  TimeRendering   INT
	)
	
	;INSERT INTO @ExtractData
	(
	  ExecutionID			  ,
	  UserName			    ,
	  ReportName			  ,	 
	  OrganizationID		,
	  TimeStart			    ,
	  TimeDataRetrieval	, 
	  TimeProcessing		, 
	  TimeRendering		  ,
	  ByteCount			    , 
	  [RowCount]
	)
	SELECT DISTINCT 
		ExecutionID								  ,
		UserName								    ,
		ReportPath								  ,				
		dbo.fncGetListItem( REPLACE(CONVERT(NVARCHAR(MAX),Parameters) ,'&',';'),'ParamOrganisationListFM',-1),
		Max(Convert(date,Timestart)), 
		SUM(TimeDataRetrieval)      ,
		SUM(TimeProcessing) 		    ,
		SUM(TimeRendering) 	      	,
		MAX(ByteCount)							,
		MAX([ROWCOUNT])		 
	FROM	
	  [ReportServer].dbo.ExecutionLog2 (NOLOCK)
	WHERE	
	  TimeStart   > convert(date,GETDATE()-(@numberOfDaysBack+1))
	  AND STATUS  = 'rsSuccess'
	GROUP BY 
			ExecutionID,
			UserName, 
			ReportPath,
			dbo.fncGetListItem( REPLACE(CONVERT(NVARCHAR(MAX),Parameters) ,'&',';'),'ParamOrganisationListFM',-1);
	
	
	;WITH ReturnTOPReportsAccessed AS
		(		
		SELECT 
			ReportName																,
			RequestsCount	        = COUNT(ExecutionID)									,
			NumberOfOrganisations = COUNT(DISTINCT OrganizationID),			
			MaxRunTime		        = MAX(TimeDataRetrieval+TimeProcessing+TimeRendering)	,			
			ByteCount		          = SUM(ByteCount)										,
			[RowCount]		        = SUM([RowCount])										,
			AveRunTime		        = CASE 
								              WHEN SUM(TimeDataRetrieval+TimeProcessing+TimeRendering)<>0 and COUNT(ExecutionID)<>0 THEN 
										              (SUM(TimeDataRetrieval+TimeProcessing+TimeRendering)/COUNT(ExecutionID))
								              ELSE 0 END,	
			AveRecordCount	      = CASE 
								              WHEN SUM([RowCount])<>0 and COUNT(ExecutionID)<>0 THEN 
										              (SUM([RowCount])/COUNT(ExecutionID))
								              ELSE 0 END,	
			MaxRecordCount	      = MAX([RowCount]),
			AveByteCount	        = CASE 
								              WHEN SUM(ByteCount)<>0 and COUNT(ExecutionID)<>0 THEN 
										              (SUM(ByteCount)/COUNT(ExecutionID))
								              ELSE 0 END,			
			MaxByteCount	        = MAX(ByteCount),														
			DurationRank	        = ROW_NUMBER() OVER (ORDER BY COUNT(ExecutionID) DESC)
		FROM
			@ExtractData ED
		GROUP BY 
			ReportName				
	  )	  
	  SELECT 
		  ReportName			              ,			
		  TotalRequests = RequestsCount ,
		  NumberOfOrganisations	        ,
		  MaxRunTime			              ,
		  AveRunTime			              ,
		  AveRecordCount		            ,
		  MaxRecordCount		            ,
		  AveByteCount		              ,
		  MaxByteCount	                ,
		  DurationRank                  ,
		  @TopQuantity
	  FROM
		  ReturnTOPReportsAccessed
    WHERE 
      DurationRank <= @TopQuantity
	  ORDER BY
		  TotalRequests DESC, 
		  ReportName ASC;
		

RETURN 0

END

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_MonitorTopXReportSubscriptions]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_MonitorTopXReportSubscriptions] 
(@numberOfDaysBack INT, 
 @TopQuantity INT)
AS


BEGIN
SET NOCOUNT ON


	DECLARE @ExtractData Table
	(
	  SubscriptionID    NVARCHAR(64),
	  ReportName        NVARCHAR(425),
	  LastRunTime       DATETIME, 
	  OrganizationID    INT null,
	  ErrorCount        INT
	)
	
	;INSERT INTO @ExtractData
	(
	  SubscriptionID			,
	  ReportName			    ,
	  LastRunTime			    ,	 
	  OrganizationID		  ,
	  ErrorCount	
	)
	SELECT 
	  SubscriptionID      , 
	  Description         , 
	  LastRunTime         , 
	  (Case when LastStatus like '%Failure%' then 1 else 0 end) ErrorCount, 
	  0
	FROM 
	  [ReportServer].dbo.Subscriptions (NOLOCK)
	WHERE 
		convert(date,LastRunTime) > (GETDATE()-(@numberOfDaysBack+1));

	
	;WITH ReturnTOPReportSubscriptions AS
		(		
		SELECT 
			ReportName									,
			RequestsCount	= COUNT(SubscriptionID)		,
			ErrorCount		= SUM(ErrorCount)			,
			DurationRank	= ROW_NUMBER() OVER (ORDER BY COUNT(SubscriptionID) DESC)
		FROM
			@ExtractData ED
		GROUP BY 
			ReportName			
	  )	  
	  SELECT 
		  ReportName			                ,			
		  TotalRequests = RequestsCount   ,
		  ErrorCount		                  ,
		  DurationRank
	  FROM
		  ReturnTOPReportSubscriptions
    WHERE 
      DurationRank <= @TopQuantity
	  ORDER BY
		  TotalRequests DESC, 
		  ReportName ASC;
		

RETURN 0

SET NOCOUNT OFF
END

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_MonitorUserAdoptionRate]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_MonitorUserAdoptionRate]
(@numberOfDaysBack INT
 )
AS


BEGIN
SET NOCOUNT ON

	DECLARE @ExtractData TABLE
	(	
	  UserName        NVARCHAR(260),	
	  TimeStart       DATE, 	
	  OrganizationID  INT NULL,
	  CountryCode     NVARCHAR(4) NULL	
	)

	;INSERT INTO @ExtractData
	(	
	  UserName			    ,	
	  OrganizationID		,
	  CountryCode			  , 
	  TimeStart				
	)
	SELECT DISTINCT 									
		UserName          ,			
		dbo.fncGetListItem( REPLACE(CONVERT(NVARCHAR(MAX),Parameters) ,'&',';'),'ParamOrganisationListFM',-1) OrganisationID,		
		'' CountryCode    ,
		MIN(CONVERT(DATE,Timestart))		 
	FROM	
		[ReportServer].dbo.ExecutionLog2 EL2 (NOLOCK)				
	WHERE	
		TimeStart     > convert(date,GETDATE()-(@numberOfDaysBack+1))
		AND		STATUS  = 'rsSuccess'
		AND		EXISTS(SELECT 
		                EL2_b.UserName 
							    FROM	
							      Reportserver.dbo.ExecutionLog2 EL2_b (NOLOCK)
							    WHERE	
							      EL2_b.UserName              = EL2.UserName
							      AND CONVERT(date,TimeStart) <  (convert(date,(GETDATE()-@numberOfDaysBack))))
	GROUP BY 
		UserName,
		dbo.fncGetListItem( REPLACE(CONVERT(NVARCHAR(MAX),Parameters) ,'&',';'),'ParamOrganisationListFM',-1);
	
	;UPDATE 
	  @ExtractData 
	SET 
	  CountryCode=ISNULL(O.CountryCode,'')
	FROM
	  [MiXData].dbo.DIM_Organisations O (NOLOCK)
	WHERE
	  OrganizationID  = O.hostID;

	
	;WITH ReturnUserAdoptionRate AS
		(		
		SELECT 
			TimeStart		    ,
			CountryCode		  ,
			NumberOfUsers	= Count(distinct UserName)	
		FROM
			@ExtractData ED		
		GROUP BY 
			TimeStart, CountryCode	
	  )	  
	  SELECT 
		  TimeStart	,	
		  Countrycode,	
		  NumberOfUsers	
	  FROM
		  ReturnUserAdoptionRate      
	  ORDER BY
		  TimeStart ASC;
		

RETURN 0

SET NOCOUNT OFF
END

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_OrganisationController]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_OrganisationController]
AS
BEGIN

  DECLARE @currentBatchKey       INT;
  DECLARE @currentBatchStartDate DATETIMEOFFSET(0);  
  DECLARE @currentDateTime       DATETIMEOFFSET(0) = SYSUTCDATETIME();
  DECLARE @lastXBathces          INT               = 5;

  SELECT
    @currentBatchKey       = ISNULL(@currentBatchKey,MAX(BatchID)),
    @currentBatchStartDate = MAX(BatchStart)
  FROM [Control].BatchController;
  
  ;WITH OrganisationPreCalcs AS
  (
    SELECT
      oc.OrganisationID,
      oc.CurrentBatch,
      CurrentDurationS          = CASE
                                    WHEN oc.LastProcessingAttemptDate >= @currentBatchStartDate
                                     AND oc.LastProcessingAttemptDate <= oc.LastProcessingCompleteDate
                                      THEN
                                        DATEDIFF(s,oc.LastProcessingAttemptDate,oc.LastProcessingCompleteDate)
                                    ELSE NULL
                                  END,
      ProcessingSlotHour        = CASE 
                                    WHEN UTCOffset >= 0 
                                      THEN 23-(UTCOffset/(60*60))
                                    ELSE (-UTCOffset/(60*60)) - 1
                                  END,
      FinishedHour              = CASE
                                    WHEN oc.LastProcessingAttemptDate < oc.LastProcessingCompleteDate
                                      THEN DATEPART(hour,oc.LastProcessingCompleteDate)
                                    ELSE -1
                                  END,
      HoursSinceLastProcessed   = DATEDIFF(hour,oc.LastProcessingAttemptDate,@currentDateTime),
      PreviousBatchID           = (SELECT MAX(CurrentBatch) 
                                   FROM [Control].OrganisationControllerHistory WITH (NOLOCK))
    FROM
      [Control].OrganisationController oc WITH (NOLOCK)
    WHERE
        oc.DWActive   = 1
    AND oc.BActive    = 1
  ),
  PreviousBatchOrgCalcs AS
  (
    SELECT
      opc.OrganisationID,
      PreviousDurationS = (SELECT AVG(CASE
                                        WHEN och.LastProcessingAttemptDate <= och.LastProcessingCompleteDate
                                          THEN
                                            DATEDIFF(s,och.LastProcessingAttemptDate,och.LastProcessingCompleteDate)
                                        ELSE NULL
                                      END)
                           FROM [Control].OrganisationControllerHistory och WITH (NOLOCK)
                           WHERE
                               och.OrganisationID = opc.OrganisationID
                           AND och.CurrentBatch   = opc.PreviousBatchID),
      AverageDurationS  = (SELECT AVG(CASE
                                        WHEN och.LastProcessingAttemptDate <= och.LastProcessingCompleteDate
                                          THEN
                                            DATEDIFF(s,och.LastProcessingAttemptDate,och.LastProcessingCompleteDate)
                                        ELSE NULL
                                      END)
                           FROM [Control].OrganisationControllerHistory och WITH (NOLOCK)
                           WHERE 
                               och.OrganisationID = opc.OrganisationID
                           AND och.CurrentBatch   BETWEEN opc.CurrentBatch - @lastXBathces AND opc.PreviousBatchID)
    FROM
      OrganisationPreCalcs opc
  ),
  PerformanceMonitoringCalcs AS
  (
    SELECT
      pm.OrganisationKey,
      NrOfRecExtracted  = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Extract'   THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLIns     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLUpd     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsUpdated  ELSE 0 END),0),
      NrOfRecETLDel     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsDeleted  ELSE 0 END),0),
      LastProcessingID  = MAX(pm.MonitorID) 
    FROM
      [Control].OrganisationController oc
        INNER JOIN
      [Control].PerformanceMonitor pm WITH (NOLOCK) ON pm.OrganisationKey = oc.OrganisationKey
    GROUP BY
      pm.OrganisationKey
  )
  SELECT
    CurrentOrgStatus = CASE
                         WHEN ISNULL(oc.CurrentBatch,-1) < @currentBatchKey
                           THEN 'Still to Run'
                         WHEN oc.IsFinished = 0 AND oc.CurrentBatch  = @currentBatchKey
                           THEN 'Busy Running'
                         WHEN oc.IsFinished = 1 AND oc.CurrentBatch  = oc.LastSuccessBatch
                           THEN 'Completed Successfully'
                         WHEN oc.IsFinished = 1 AND oc.CurrentBatch  <> ISNULL(oc.LastSuccessBatch,0) AND oc.CurrentBatch  = @currentBatchKey
                           THEN 'Failed'
                         ELSE 'Still to Run'
                       END,
    oc.OrganisationID              ,
    oc.OrganisationKey             ,
    oc.OrganisationName            ,
    oc.DatabaseName                ,
    oc.LastSuccessbatch            ,
    oc.CurrentBatch                ,
    oc.LastProcessingAttemptDate   ,
    oc.LastProcessingCompleteDate  ,
    oc.ErrorEncountered            ,
    opc.CurrentDurationS           ,
    pop.PreviousDurationS          ,
    pop.AverageDurationS           ,
    opc.ProcessingSlotHour         ,
    opc.HoursSinceLastProcessed    ,
    HoursSinceLastShouldBeProcessed = CASE 
                                        WHEN opc.ProcessingSlotHour < DATEPART(HOUR,@currentDateTime) 
                                          THEN DATEPART(HOUR,@currentDateTime) - opc.ProcessingSlotHour
                                        ELSE (24 - opc.ProcessingSlotHour + DATEPART(HOUR,@currentDateTime))
                                      END,
    pm.NrOfRecExtracted            ,
    pm.NrOfRecETLIns               ,
    pm.NrOfRecETLUpd               ,
    pm.NrOfRecETLDel
  FROM
    PreviousBatchOrgCalcs            pop
      INNER JOIN
    OrganisationPreCalcs             opc               ON opc.OrganisationID = pop.OrganisationID
      INNER JOIN
    [Control].OrganisationController oc  WITH (NOLOCK) ON oc.OrganisationID  = opc.OrganisationID
      LEFT JOIN
    PerformanceMonitoringCalcs       pm                ON pm.OrganisationKey = oc.OrganisationKey;

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_TopXExtractOrganisations]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_TopXExtractOrganisations]
AS
BEGIN

  DECLARE @currentBatchKey INT;
  DECLARE @topXRecords     INT = 10;
  DECLARE @lastXBathces    INT = 3;
  
  SELECT
    @currentBatchKey       = ISNULL(@currentBatchKey,MAX(BatchID))
  FROM [Control].BatchController;

  ;WITH LastXBatchProcesses AS
  (
    SELECT
      pm.BatchID,
      pm.OrganisationKey,
      oc.DatabaseName,
      NrOfRecExtracted  = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Extract'   THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLIns     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLUpd     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsUpdated  ELSE 0 END),0),
      NrOfRecETLDel     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsDeleted  ELSE 0 END),0),
      DurationS         = DATEDIFF(s,MIN(StepStartTime),MAX(StepEndTime)),
      DurationRank      = ROW_NUMBER() OVER (PARTITION BY BatchID ORDER BY SUM(CASE WHEN pm.ActionType = 'Extract' THEN pm.RecordsInserted ELSE 0 END) DESC)
    FROM
      [Control].OrganisationController oc WITH (NOLOCK)
        INNER JOIN
      [Control].PerformanceMonitor     pm WITH (NOLOCK) ON pm.OrganisationKey = oc.OrganisationKey
    GROUP BY
      pm.BatchID,
      pm.OrganisationKey,
      oc.DatabaseName
    UNION
    SELECT
      pm.BatchID,
      pm.OrganisationKey,
      oc.DatabaseName,
      NrOfRecExtracted  = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Extract'   THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLIns     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLUpd     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsUpdated  ELSE 0 END),0),
      NrOfRecETLDel     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsDeleted  ELSE 0 END),0),
      DurationS         = DATEDIFF(s,MIN(StepStartTime),MAX(StepEndTime)),
      DurationRank      = ROW_NUMBER() OVER (PARTITION BY BatchID ORDER BY SUM(CASE WHEN pm.ActionType = 'Extract' THEN pm.RecordsInserted ELSE 0 END) DESC)
    FROM
      [Control].OrganisationController    oc WITH (NOLOCK)
        INNER JOIN
      [Control].PerformanceMonitorHistory pm WITH (NOLOCK) ON pm.OrganisationKey = oc.OrganisationKey
    WHERE
      BatchID > @currentBatchKey -@lastXBathces
    GROUP BY
      pm.BatchID,
      pm.OrganisationKey,
      oc.DatabaseName
  )
  SELECT
    BatchID         ,
    OrganisationKey ,
    DatabaseName    ,
    NrOfRecExtracted,
    NrOfRecETLIns   ,
    NrOfRecETLUpd   ,
    NrOfRecETLDel   ,
    DurationS
  FROM
    LastXBatchProcesses
  WHERE 
    DurationRank <= 10
  ORDER BY
    BatchID DESC,
    DurationRank;

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_TopXLongRunningOrganisations]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_TopXLongRunningOrganisations]
AS
BEGIN

  DECLARE @currentBatchKey INT;
  DECLARE @topXRecords     INT = 10;
  DECLARE @lastXBathces    INT = 3;
  
  SELECT
    @currentBatchKey       = ISNULL(@currentBatchKey,MAX(BatchID))
  FROM [Control].BatchController;

  ;WITH LastXBatchProcesses AS
  (
    SELECT
      pm.BatchID,
      pm.OrganisationKey,
      oc.DatabaseName,
      NrOfRecExtracted  = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Extract'   THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLIns     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLUpd     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsUpdated  ELSE 0 END),0),
      NrOfRecETLDel     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsDeleted  ELSE 0 END),0),
      DurationS         = DATEDIFF(s,MIN(StepStartTime),MAX(StepEndTime)),
      DurationRank      = ROW_NUMBER() OVER (PARTITION BY BatchID ORDER BY DATEDIFF(s,MIN(StepStartTime),MAX(StepEndTime)) DESC)
    FROM
      [Control].OrganisationController oc WITH (NOLOCK)
        INNER JOIN
      [Control].PerformanceMonitor     pm WITH (NOLOCK) ON pm.OrganisationKey = oc.OrganisationKey
    GROUP BY
      pm.BatchID,
      pm.OrganisationKey,
      oc.DatabaseName
    UNION
    SELECT
      pm.BatchID,
      pm.OrganisationKey,
      oc.DatabaseName,
      NrOfRecExtracted  = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Extract'   THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLIns     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsInserted ELSE 0 END),0),
      NrOfRecETLUpd     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsUpdated  ELSE 0 END),0),
      NrOfRecETLDel     = ISNULL(SUM(CASE WHEN pm.ActionType    = 'Transform' THEN pm.RecordsDeleted  ELSE 0 END),0),
      DurationS         = DATEDIFF(s,MIN(StepStartTime),MAX(StepEndTime)),
      DurationRank      = ROW_NUMBER() OVER (PARTITION BY BatchID ORDER BY DATEDIFF(s,MIN(StepStartTime),MAX(StepEndTime)) DESC)
    FROM
      [Control].OrganisationController    oc WITH (NOLOCK)
        INNER JOIN
      [Control].PerformanceMonitorHistory pm WITH (NOLOCK) ON pm.OrganisationKey = oc.OrganisationKey
    WHERE
      BatchID > @currentBatchKey -@lastXBathces
    GROUP BY
      pm.BatchID,
      pm.OrganisationKey,
      oc.DatabaseName
  )
  SELECT
    BatchID         ,
    OrganisationKey ,
    DatabaseName    ,
    NrOfRecExtracted,
    NrOfRecETLIns   ,
    NrOfRecETLUpd   ,
    NrOfRecETLDel   ,
    DurationS
  FROM
    LastXBatchProcesses
  WHERE 
    DurationRank <= 10
  ORDER BY
    BatchID DESC,
    DurationRank;

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [Control].[sprReportDashboard_TopXLongRunningProcesses]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportDashboard_TopXLongRunningProcesses]
AS
BEGIN

  DECLARE @currentBatchKey INT;
  DECLARE @topXRecords     INT = 10;
  DECLARE @lastXBathces    INT = 3;
  
  SELECT
    @currentBatchKey       = ISNULL(@currentBatchKey,MAX(BatchID))
  FROM [Control].BatchController;

  ;WITH LastXBatchProcesses AS
  (
    SELECT
      BatchID,
      ActionType,
      ActionObjectName,
      TotalInserted = SUM(RecordsInserted),
      TotalUpdated  = SUM(RecordsUpdated),
      TotalDeleted  = SUM(RecordsDeleted),
      DurationS     = SUM(DATEDIFF(s,StepStartTime,StepEndTime)),
      DurationRank  = ROW_NUMBER() OVER (PARTITION BY BatchID ORDER BY SUM(DATEDIFF(s,StepStartTime,StepEndTime)) DESC)
    FROM
      [Control].PerformanceMonitor
    GROUP BY
      BatchID,
      ActionType,
      ActionObjectName
    UNION
    SELECT
      BatchID,
      ActionType,
      ActionObjectName,
      TotalInserted = SUM(RecordsInserted),
      TotalUpdated  = SUM(RecordsUpdated),
      TotalDeleted  = SUM(RecordsDeleted),
      DurationS     = SUM(DATEDIFF(s,StepStartTime,StepEndTime)),
      DurationRank  = ROW_NUMBER() OVER (PARTITION BY BatchID ORDER BY SUM(DATEDIFF(s,StepStartTime,StepEndTime)) DESC)
    FROM
      [Control].PerformanceMonitorHistory
    WHERE
      BatchID > @currentBatchKey -@lastXBathces
    GROUP BY
      BatchID,
      ActionType,
      ActionObjectName
  )
  SELECT
    BatchID         ,
    ActionType      ,
    ActionObjectName,
    TotalInserted   ,
    TotalUpdated    ,
    TotalDeleted    ,
    DurationS
  FROM
    LastXBatchProcesses
  WHERE 
    DurationRank <= 10
  ORDER BY
    BatchID DESC,
    DurationRank;

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [Control].[sprReportReverseGeoServiceBatchHistory]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportReverseGeoServiceBatchHistory]
(
  @reportFrom datetimeoffset = NULL,
  @reportTo   datetimeoffset = NULL
) AS

SET NOCOUNT ON;

DECLARE @from datetimeoffset = ISNULL(@reportFrom, '20091201');
DECLARE @to   datetimeoffset = ISNULL(@reportTo,   SYSDATETIMEOFFSET());

WITH 
BatchDetails AS
(
  SELECT
    bc1.BatchID,
    bc1.BatchStart,
    bc1.BatchEnd,
    NextBatchStart = DATEADD(s,-1,ISNULL(bc2.BatchStart, SYSDATETIMEOFFSET()))

  FROM
    [Control].BatchController          bc1 WITH (NOLOCK)
      LEFT JOIN
    [Control].BatchController          bc2 WITH (NOLOCK) ON bc2.BatchID = bc1.BatchID + 1
   WHERE bc1.BatchID > 1000000
),
summarisedData (BatchID, GeoLocationsProcessed, GeoLocationsIgnored, NewGeographyRecods, LastRecordDateTime) AS
(
  SELECT
    bc.BatchID,
    SUM(rg.GeoLocationProcessedDelta),
    SUM(rg.GeoLocationIgnoredDelta),
    SUM(rg.GeographyNewDelta),
    LastRecordDateTime = MAX(rg.RecordDate)
  FROM
    BatchDetails                       bc WITH (NOLOCK)
      INNER JOIN
    [Control].ReverseGeoServiceHistory rg WITH (NOLOCK) ON rg.RecordDate BETWEEN bc.BatchStart AND ISNULL(bc.NextBatchStart, SYSDATETIMEOFFSET())
  WHERE
    rg.RecordDate BETWEEN @from AND @to
  GROUP BY
    bc.BatchID
)
SELECT
  sd.BatchID,
  bc.BatchStart,
  bc.BatchEnd,
  bc.NextBatchStart,
  sd.GeoLocationsProcessed,
  sd.GeoLocationsIgnored,
  sd.NewGeographyRecods,
  LastInvalidMapProviders     = rg.InvalidMapProviders,
  LastUnavailableMapProviders = rg.UnavailableMapProviders,
  LastServerState             = rg.ServerState,
  LastServerStatus            = CASE
                                  WHEN rg.ServerState = 0 THEN 'Terminated Gracefully'
                                  WHEN rg.ServerState = 1 THEN 'Starting Service'
                                  WHEN rg.ServerState = 2 THEN 'Busy Processing'
                                  WHEN rg.ServerState = 3 THEN 'Idling'
                                  ELSE ''
                                END,
  LastReportingDateTime       = rg.RecordDate
FROM
  summarisedData sd
    INNER JOIN
  BatchDetails                       bc WITH (NOLOCK) ON sd.BatchID = bc.BatchID
    INNER JOIN
  [Control].ReverseGeoServiceHistory rg WITH (NOLOCK) ON sd.LastRecordDateTime = rg.RecordDate;

GO
/****** Object:  StoredProcedure [Control].[sprReportReverseGeoServiceHistory]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReportReverseGeoServiceHistory]
(
  @reportFrom datetimeoffset = NULL,
  @reportTo   datetimeoffset = NULL
) AS

SET NOCOUNT ON;

DECLARE @from datetimeoffset = ISNULL(@reportFrom, '20091201');
DECLARE @to   datetimeoffset = ISNULL(@reportTo,   SYSDATETIMEOFFSET());

WITH LastRecord (ServerName, RID, GeoLocationsProcessed, GeoLocationsIgnored, NewGeographyRecods) AS
(
  SELECT
    ServerName,
    MAX(RID),
    SUM(GeoLocationProcessedDelta),
    SUM(GeoLocationIgnoredDelta),
    SUM(GeographyNewDelta)
  FROM
    [Control].ReverseGeoServiceHistory
  WHERE
    RecordDate BETWEEN @from AND @to
  GROUP BY
    ServerName
)
SELECT
  l.ServerName,
  CurrentState                    = hist.ServerState,
  CurrentInvalidMapProviders      = hist.InvalidMapProviders,
  CurrentUnavailableMapProviders  = hist.UnavailableMapProviders,
  l.GeoLocationsProcessed,
  l.GeoLocationsIgnored,
  l.NewGeographyRecods
FROM
  LastRecord l
    INNER JOIN
  [Control].ReverseGeoServiceHistory hist ON l.RID = hist.RID;

GO
/****** Object:  StoredProcedure [Control].[sprRestrictTracer]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprRestrictTracer]
(
  @OrganisationID     int,
  @ReportTracerFlag   bit = 0
)
AS
BEGIN
  IF @ReportTracerFlag = 1
    BEGIN
      SELECT RestrictTracerFlag = CONVERT(int, ISNULL(RestrictTracerFlag,@ReportTracerFlag))
      FROM 
        [MiXStaging].Control.OrganisationController 
      WHERE 
        OrganisationID=@OrganisationID;
    END
  ELSE
    BEGIN
      SELECT @ReportTracerFlag as RestrictTracerFlag
    END
END

GO
/****** Object:  StoredProcedure [Control].[sprReversGeoSerivceHistory_Add]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprReversGeoSerivceHistory_Add]
(
  @serverName                      nvarchar(132),
  @serverState                     tinyint,
  @invalidMapProviders             int,
  @unavailableMapProviders         int,
  @geoLocationProcessedDelta       int,
  @geoLocationIgnoredDelta         int,
  @geographyNewDelta               int
) AS

INSERT INTO ReverseGeoServiceHistory
      (ServerName,  ServerState,  InvalidMapProviders,  UnavailableMapProviders,  GeoLocationProcessedDelta,  GeoLocationIgnoredDelta,  GeographyNewDelta,  RecordDate)
VALUES(@serverName, @serverState, @invalidMapProviders, @unavailableMapProviders, @geoLocationProcessedDelta, @geoLocationIgnoredDelta, @geographyNewDelta, SYSDATETIMEOFFSET())

RETURN 0;

GO
/****** Object:  StoredProcedure [Control].[sprRollbackBatchStart]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprRollbackBatchStart]
(
  @batchKey INT
)
AS
BEGIN
  SET NOCOUNT ON;
  
  DELETE [Control].BatchController
  WHERE BatchID = @batchKey;
  
  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [Control].[sprRollbackOrganisation]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==========================================================================================
-- If an error on a organisation is encountered the rollback procedure will return the data
--   for that organisation to it's original state
-- ==========================================================================================
CREATE PROCEDURE [Control].[sprRollbackOrganisation]
(
  @batchKey        int,
  @organisationKey int,
  @stageUser       varchar(30),
  @debugMode       tinyint = 0 -- 0:No Debugging, 1:Performance Debugging, 2:Perf + Text Output Debugging
)
AS
BEGIN
   SET NOCOUNT ON;
  
  DECLARE @miXDataTableName       nvarchar(100);
  DECLARE @rollbackColumnList     nvarchar(max);
  DECLARE @reInsertColumnList     nvarchar(max);
  DECLARE @primaryKey             nvarchar(100);
  DECLARE @strSQL                 nvarchar(max);
  DECLARE @hasOrganisationKeyFlag bit = 0;
  DECLARE @isSummaryTableFlag     bit = 0;

  DECLARE @recordsInserted      int;
  DECLARE @recordsUpdated       int;
  DECLARE @recordsDeleted       int;
  DECLARE @nrOfrecordsAffected  int   = 0;
  DECLARE @progressLabel        nvarchar(255);

  DECLARE @tableList table
  (
    RID                    int,
    MiXDataTableName       nvarchar(100),
    RollbackColumnList     nvarchar(max),
    ReInsertColumnList     nvarchar(max),
    PrimaryKey             nvarchar(100),
    HasOrganisationKeyFlag bit,
    IsSummaryTableFlag     bit,
    Processed              bit
  );

  BEGIN TRY

    IF @debugMode > 0  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    END;

    INSERT INTO @tableList
    ( RID, MiXDataTableName, RollbackColumnList, ReInsertColumnList, PrimaryKey, HasOrganisationKeyFlag, IsSummaryTableFlag, Processed )
    SELECT
      RID                   ,
      MiXDataTableName      ,
      RollbackColumnList    ,
      ReInsertColumnList    ,
      PrimaryKey            ,
      HasOrganisationKeyFlag,
      IsSummaryTableFlag    ,
      0
    FROM
      [Control].RollbackTableList
    ORDER BY
      RID;

    WHILE EXISTS (SELECT 1 FROM @tableList WHERE Processed = 0)
    BEGIN
      
      SELECT TOP 1
        @miXDataTableName       = MiXDataTableName      ,
        @rollbackColumnList     = RollbackColumnList    ,
        @reInsertColumnList     = ReInsertColumnList    ,
        @primaryKey             = PrimaryKey            ,
        @hasOrganisationKeyFlag = HasOrganisationKeyFlag,
        @isSummaryTableFlag     = IsSummaryTableFlag
      FROM
        @tableList
      WHERE
        Processed = 0
      ORDER BY RID;

      -- remove inserted records
      IF @hasOrganisationKeyFlag = 1
        SELECT @strSQL = 'DELETE [MiXData].dbo.' + @mixDataTableName 
                       + ' WHERE OrganisationKey = ' + CONVERT(NVARCHAR(20),@organisationKey)
                       + ' AND CreateBatchKey = '    + CONVERT(NVARCHAR(20),@batchKey) + ';';
      
      EXECUTE (@strSQL);
      SELECT @recordsDeleted = @@ROWCOUNT;

      IF @debugMode = 2
        PRINT @strSQL;

      -- reset updated records from rollback backups
      SELECT @strSQL = 'UPDATE [MiXData].dbo.' + @mixDataTableName 
                     + ' SET ' + @rollbackColumnList
                     + ' FROM ' + @stageUser + '.ROLLBACK_' + @mixDataTableName 
                     + ' r INNER JOIN [MiXData].dbo.' + @mixDataTableName  
                     + ' d ON r.' + @primaryKey + ' = d.' + @primaryKey + ';';

      EXECUTE (@strSQL);
      SELECT @recordsUpdated = @@ROWCOUNT;

      IF @debugMode = 2
        PRINT @strSQL;

      IF @isSummaryTableFlag = 1
      BEGIN
        -- re-insert deleted records using rollback backups
        SELECT @strSQL = 'INSERT INTO [MiXData].dbo.' + @mixDataTableName 
                       + ' (' + @reInsertColumnList + ')'
                       + ' SELECT ' + @reInsertColumnList
                       + ' FROM '   + @stageUser + '.ROLLBACK_' + @mixDataTableName 
                       + ' WHERE IsDeleted = 1;';

        EXECUTE (@strSQL);
        SELECT @recordsInserted = @@ROWCOUNT;

        IF @debugMode = 2
          PRINT @strSQL;

        IF @debugMode > 0  -- DebugMode is true
        BEGIN
          SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated + @recordsDeleted;
          SELECT @progressLabel       = '1. Rollback Records: ' + @mixDataTableName;
          EXEC [Control].strProcProgressMonitor_Set
            @flag=@progressLabel, @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
        END;

      END;

      UPDATE @tableList
      SET Processed = 1
      WHERE MiXDataTableName = @miXDataTableName;

    END; -- end while
  
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  IF @debugMode > 0  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated + @recordsDeleted;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
  END;

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [Control].[sprStartBatchOperation]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprStartBatchOperation]

AS
SET NOCOUNT ON;

-- States:  0 = unknown, 1 = New Batch, 2 = Existing Batch, 3 = Last Batch Failed!, 4 = Existing Batch Requested to Stop
DECLARE @batchState   int = 0;
DECLARE @batchKey      int = 0;

SELECT TOP (1)
  @batchKey    = BatchID,
  @batchState = CASE
                  WHEN HasFailed = 1 THEN
                    3
                  WHEN BatchBusy = 1 AND BatchShouldStop = 1 AND BatchEnd IS NOT NULL THEN
                    4
                  WHEN BatchBusy = 1 and BatchEnd IS NULL THEN
                    2
                  ELSE
                    1
                END
FROM
  Control.BatchController
ORDER BY
  BatchID DESC;

IF @@ROWCOUNT = 0
  BEGIN
    SET @batchKey = 1;
    SET @batchState = 1;
  END;

SELECT
  @batchState BatchState,@batchKey BatchID;

GO
/****** Object:  StoredProcedure [Control].[sprTruncateAllUserSchemaTables]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE procedure [Control].[sprTruncateAllUserSchemaTables]
@stageuser nvarchar(50) = 'XXX'
as

IF NOT @stageuser LIKE 'StageUser%'
  BEGIN
    RAISERROR ('Invalid schema name supplied for parameter', 16, 1) WITH SETERROR
    RETURN
  END

declare @name  varchar(100)
declare @xtype char(1)
declare @sqlstring nvarchar(1000)

declare AllSPViews_cursor cursor for
  select @stageuser + '.'+ o.name,o.type
  from [sys].[objects] o, [sys].[schemas] s
  where o.schema_id = s.schema_id
  and s.name = @stageuser
  and o.type = 'U'

open AllSPViews_cursor

fetch next from AllSPViews_cursor into @name, @xtype

while @@fetch_status = 0
  begin
-- obtain object type if it is a table
   if @xtype = 'U'
      begin
         set @sqlstring = 'truncate table ' + @name
         exec sp_executesql @sqlstring
         set @sqlstring = ' '
      end      

    fetch next from AllSPViews_cursor into @name, @xtype
  end

close AllSPViews_cursor
deallocate AllSPViews_cursor

GO
/****** Object:  StoredProcedure [Control].[sprWarehouseNotifications_Action]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprWarehouseNotifications_Action]
(
  @NotificationKey              INT,
  @organisationID               INT,
  @ActionScheduleOption         INT = 0,
  @ActionTakenOption            INT = 0,
  @ActionTakenUser              NVARCHAR(50) = NULL
)
AS
BEGIN
/*

  NotificationType:
  
  1. 'New Database'
    @ActionTakenOption
      1 - Process
      2 - Do Not Process
      3 - Re-Activate
    
    @ActionScheduleOption
      1 - Process Imediately
      2 - Schedule for this evening in its own time slot
      3 - Schedule for Saturday evening run

  2. 'Removed Database'
    @ActionTakenOption
      1 - Acknowledged
      2 - Acknowledged All

  3. 'Restored Database'
    @ActionTakenOption
      1 - Process
      2 - Do Not Process
      3 - Re-Activate
  
    @ActionScheduleOption
      1 - Process Imediately
      2 - Schedule for this evening in its own time slot
      3 - Schedule for Saturday evening run
  
  4. 'Do not Process'
    @ActionTakenOption
      1 - Acknowledged
      3 - Re-Activate

    @ActionScheduleOption
      1 - Process Imediately
      2 - Schedule for this evening in its own time slot
      3 - Schedule for Saturday evening run

*/
  SET NOCOUNT ON;
  
  DECLARE @NotificationType      NVARCHAR(25);
  DECLARE @CurrentActionTaken    NVARCHAR(25);
  DECLARE @ScheduleDateTime      DATETIMEOFFSET(0);
  DECLARE @UTCOffset             INT;
  DECLARE @organisationKey       INT;
  DECLARE @ProcessingSlotHour    INT;
  DECLARE @RunHour               INT;
  DECLARE @FirstSaturdayDateTime DATETIMEOFFSET(0);

  
  SELECT
    @organisationKey    = oc.OrganisationKey,
    @NotificationType   = wn.NotificationType,
    @CurrentActionTaken = wn.ActionTaken,
    @UTCOffset          = oc.UTCOffset,
    @ProcessingSlotHour = CASE 
                            WHEN UTCOffset >= 0 
                              THEN 23-(UTCOffset/(60*60))
                            ELSE (-UTCOffset/(60*60)) - 1
                          END,
    @RunHour            = DATEPART(HOUR,SYSUTCDATETIME()),
    @FirstSaturdayDateTime = CONVERT(DATETIMEOFFSET(0),(SELECT MIN(DateKey)
                                                        FROM [MiXData].dbo.DIM_Dates
                                                        WHERE DateKey >= CONVERT(DATE,SYSUTCDATETIME())
                                                        AND DayOfWeek  = 7))
  FROM
    [Control].WarehouseNotifications wn WITH (NOLOCK)
      INNER JOIN
    [Control].OrganisationController oc WITH (NOLOCK) ON oc.OrganisationID = wn.OrganisationID
  WHERE wn.NotificationKey = @NotificationKey;

  IF (@NotificationType = 'New Database')
  BEGIN
    
    -- either @ActionScheduleOption or @ActionTakenOption will be drilled through, based on these values
    --   populate the other option
    IF @CurrentActionTaken IS NULL AND @ActionScheduleOption > 0
    BEGIN
      SELECT
        @ActionTakenOption    = 1;
    END
    ELSE IF @CurrentActionTaken IS NOT NULL AND @ActionScheduleOption > 0
    BEGIN
      SELECT
        @ActionTakenOption    = 3;
    END
    ELSE
    BEGIN
      SELECT
        @ActionScheduleOption = 2;
    END;

    -- Process or Re-Activate
    IF (@ActionTakenOption IN (1,3))
    BEGIN

      BEGIN TRY
        BEGIN TRANSACTION

        UPDATE
          [Control].WarehouseNotifications
        SET
          ActionTakenDateTime = SYSUTCDATETIME(),
          ScheduleDateTime    = CASE
                                  -- no scheduled date
                                  WHEN @ActionScheduleOption = 0 THEN NULL
                                  -- Process Imediately
                                  WHEN @ActionScheduleOption = 1
                                    THEN SYSUTCDATETIME()
                                  -- Process this evening
                                  WHEN @ActionScheduleOption = 2
                                   AND @RunHour              < @ProcessingSlotHour
                                    THEN DATEADD(HOUR,@ProcessingSlotHour,CONVERT(DATETIMEOFFSET(0),CONVERT(DATE,SYSUTCDATETIME())))
                                  WHEN @ActionScheduleOption = 2
                                   AND @RunHour              >= @ProcessingSlotHour
                                    THEN DATEADD(DAY,1,DATEADD(HOUR,@ProcessingSlotHour,CONVERT(DATETIMEOFFSET(0),CONVERT(DATE,SYSUTCDATETIME()))))
                                  -- Process first coming Saturday
                                  WHEN @ActionScheduleOption = 3
                                   AND @ProcessingSlotHour   > 12
                                    THEN DATEADD(HOUR,@ProcessingSlotHour,@FirstSaturdayDateTime)
                                  WHEN @ActionScheduleOption = 3
                                   AND @ProcessingSlotHour   > 12
                                    THEN DATEADD(DAY,1,DATEADD(HOUR,@ProcessingSlotHour,@FirstSaturdayDateTime))
                                  ELSE NULL
                                END,
          ActionTaken         = CASE
                                  WHEN @ActionTakenOption = 1 THEN 'Process'
                                  WHEN @ActionTakenOption = 3 THEN 'Re-Activate'                                
                                  ELSE NULL
                                END,
          ActionTakenUser     = ISNULL(@ActionTakenUser,SYSTEM_USER)
        WHERE
          NotificationKey = @NotificationKey;

        UPDATE
          [Control].OrganisationController
        SET
          DWActive         = 1,
          IsFinished       = 1,
          ScheduleDateTime = wn.ScheduleDateTime
        FROM
          [Control].WarehouseNotifications wn WITH (NOLOCK)
            INNER JOIN
          [Control].OrganisationController oc WITH (NOLOCK) ON oc.OrganisationID = wn.OrganisationID
        WHERE
            oc.OrganisationID  = @organisationID
        AND wn.NotificationKey = @NotificationKey;

        COMMIT TRANSACTION;
      END TRY
      -- CATCH Errors
      BEGIN CATCH
        ROLLBACK TRANSACTION;
        EXEC [Control].sprLogError @organisationKey = @organisationKey;  
        RETURN -1;  
      END CATCH;  

    END  -- end New DB - Process/Re-Activate
    ELSE
    -- Do Not Process
    BEGIN

      BEGIN TRY
        BEGIN TRANSACTION
    
        UPDATE
          [Control].WarehouseNotifications
        SET
          ActionTakenDateTime = SYSUTCDATETIME(),
          ScheduleDateTime    = NULL,
          ActionTaken         = CASE
                                  WHEN @ActionTakenOption = 2 THEN 'Do Not Process'
                                  ELSE NULL
                                END,
          ActionTakenUser     = ISNULL(@ActionTakenUser,SYSTEM_USER)
        WHERE
          NotificationKey = @NotificationKey;

        UPDATE
          [Control].OrganisationController
        SET
          DWActive     = 0,
          CurrentBatch = NULL,
          IsFinished   = 1,
          LastProcessingAttemptDate = NULL
        WHERE
          OrganisationID = @organisationID;

        COMMIT TRANSACTION;
      END TRY
      -- CATCH Errors
      BEGIN CATCH
        ROLLBACK TRANSACTION;
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;
    END;  -- end New DB - Do Not Process

  END  -- end New DB
  ELSE IF @NotificationType = 'Removed Database'
  BEGIN

    -- Acknowledged
    IF (@ActionTakenOption = 1)
    BEGIN
      UPDATE
        [Control].WarehouseNotifications
      SET
        ActionTakenDateTime = SYSUTCDATETIME(),
        ActionTaken         = CASE
                                WHEN @ActionTakenOption = 1 THEN 'Acknowledged'
                                ELSE NULL
                              END,
        ActionTakenUser     = ISNULL(@ActionTakenUser,SYSTEM_USER)
      WHERE
        NotificationKey = @NotificationKey;
    END
    -- Acknowledged All
    ELSE IF (@ActionTakenOption = 2)
    BEGIN
      UPDATE
        [Control].WarehouseNotifications
      SET
        ActionTakenDateTime = SYSUTCDATETIME(),
        ActionTaken         = CASE
                                WHEN @ActionTakenOption > 0 THEN 'Acknowledged All'
                                ELSE NULL
                              END,
        ActionTakenUser     = ISNULL(@ActionTakenUser,SYSTEM_USER)
      WHERE
          NotificationType = 'Removed Database'
      AND ActionTaken      IS NULL;
    END;
  
  END
  ELSE IF @NotificationType = 'Restored Database'
  BEGIN

    -- either @ActionScheduleOption or @ActionTakenOption will be drilled through, based on these values
    --   populate the other option
    IF @CurrentActionTaken IS NULL AND @ActionScheduleOption > 0
    BEGIN
      SELECT
        @ActionTakenOption    = 1;
    END
    ELSE IF @CurrentActionTaken IS NOT NULL AND @ActionScheduleOption > 0
    BEGIN
      SELECT
        @ActionTakenOption    = 3;
    END
    ELSE
    BEGIN
      SELECT
        @ActionScheduleOption = 2;
    END;
  
    -- Process or Re-Activate
    IF (@ActionTakenOption IN (1,3))
    BEGIN

      BEGIN TRY
        BEGIN TRANSACTION

        UPDATE
          [Control].WarehouseNotifications
        SET
          ActionTakenDateTime = SYSUTCDATETIME(),
          ScheduleDateTime    = CASE
                                  -- no scheduled date
                                  WHEN @ActionScheduleOption = 0 THEN NULL
                                  -- Process Imediately
                                  WHEN @ActionScheduleOption = 1
                                    THEN SYSUTCDATETIME()
                                  -- Process this evening
                                  WHEN @ActionScheduleOption = 2
                                   AND @RunHour              < @ProcessingSlotHour
                                    THEN DATEADD(HOUR,@ProcessingSlotHour,CONVERT(DATETIMEOFFSET(0),CONVERT(DATE,SYSUTCDATETIME())))
                                  WHEN @ActionScheduleOption = 2
                                   AND @RunHour              >= @ProcessingSlotHour
                                    THEN DATEADD(DAY,1,DATEADD(HOUR,@ProcessingSlotHour,CONVERT(DATETIMEOFFSET(0),CONVERT(DATE,SYSUTCDATETIME()))))
                                  -- Process first coming Saturday (2hrs before processingslot hour)
                                  WHEN @ActionScheduleOption = 3
                                   AND @ProcessingSlotHour-2 > 12
                                    THEN DATEADD(HOUR,@ProcessingSlotHour,@FirstSaturdayDateTime)
                                  WHEN @ActionScheduleOption = 3
                                   AND @ProcessingSlotHour-2 <= 12
                                    THEN DATEADD(DAY,1,DATEADD(HOUR,@ProcessingSlotHour-2,@FirstSaturdayDateTime))
                                  ELSE NULL
                                END,
          ActionTaken         = CASE
                                  WHEN @ActionTakenOption = 1 THEN 'Process'
                                  WHEN @ActionTakenOption = 3 THEN 'Re-Activate'                                
                                  ELSE NULL
                                END,
          ActionTakenUser     = ISNULL(@ActionTakenUser,SYSTEM_USER)
        WHERE
          NotificationKey = @NotificationKey;

        UPDATE
          [Control].OrganisationController
        SET
          DWActive         = 1,
          IsFinished       = 1,
          ScheduleDateTime = wn.ScheduleDateTime
        FROM
          [Control].WarehouseNotifications wn WITH (NOLOCK)
            INNER JOIN
          [Control].OrganisationController oc WITH (NOLOCK) ON oc.OrganisationID = wn.OrganisationID
        WHERE
            oc.OrganisationID  = @organisationID
        AND wn.NotificationKey = @NotificationKey;

        COMMIT TRANSACTION;
      END TRY
      -- CATCH Errors
      BEGIN CATCH
        ROLLBACK TRANSACTION;
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

    END  -- end Restored DB - Process/Re-Activate
    ELSE
    -- Do Not Process
    BEGIN

      BEGIN TRY
        BEGIN TRANSACTION

        UPDATE
          [Control].WarehouseNotifications
        SET
          ActionTakenDateTime = SYSUTCDATETIME(),
          ScheduleDateTime    = NULL,
          ActionTaken         = CASE
                                  WHEN @ActionTakenOption = 2 THEN 'Do Not Process'
                                  ELSE NULL
                                END,
          ActionTakenUser     = ISNULL(@ActionTakenUser,SYSTEM_USER)
        WHERE
          NotificationKey = @NotificationKey;

        UPDATE
          [Control].OrganisationController
        SET
          DWActive     = 0,
          CurrentBatch = NULL,
          IsFinished   = 1,
          LastProcessingAttemptDate = NULL
        WHERE
          OrganisationID = @organisationID;

        COMMIT TRANSACTION;
      END TRY
      -- CATCH Errors
      BEGIN CATCH
        ROLLBACK TRANSACTION;
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

    END;  -- end Restored DB - Do Not Process

  END
  ELSE IF @NotificationType = 'Do not Process'
  BEGIN

    -- either @ActionScheduleOption or @ActionTakenOption will be drilled through, based on these values
    --   populate the other option
    IF @CurrentActionTaken IS NULL AND @ActionScheduleOption > 0
    BEGIN
      SELECT
        @ActionTakenOption    = 1;
    END
    ELSE IF @CurrentActionTaken IS NOT NULL AND @ActionScheduleOption > 0
    BEGIN
      SELECT
        @ActionTakenOption    = 3;
    END
    ELSE
    BEGIN
      SELECT
        @ActionScheduleOption = 2;
    END;

    -- Acknowledged
    IF (@ActionTakenOption = 1)
    BEGIN
      UPDATE
        [Control].WarehouseNotifications
      SET
        ActionTakenDateTime = SYSUTCDATETIME(),
        ActionTaken         = CASE
                                WHEN @ActionTakenOption = 1 THEN 'Acknowledged'
                                ELSE NULL
                              END,
        ActionTakenUser     = ISNULL(@ActionTakenUser,SYSTEM_USER)
      WHERE
        NotificationKey = @NotificationKey;
    END
    -- Re-Activate
    ELSE IF (@ActionTakenOption = 3)
    BEGIN

      BEGIN TRY
        BEGIN TRANSACTION

        UPDATE
          [Control].WarehouseNotifications
        SET
          ActionTakenDateTime = SYSUTCDATETIME(),
          ScheduleDateTime    = CASE
                                  -- no scheduled date
                                  WHEN @ActionScheduleOption = 0 THEN NULL
                                  -- Process Imediately
                                  WHEN @ActionScheduleOption = 1
                                    THEN SYSUTCDATETIME()
                                  -- Process this evening
                                  WHEN @ActionScheduleOption = 2
                                   AND @RunHour              < @ProcessingSlotHour
                                    THEN DATEADD(HOUR,@ProcessingSlotHour,CONVERT(DATETIMEOFFSET(0),CONVERT(DATE,SYSUTCDATETIME())))
                                  WHEN @ActionScheduleOption = 2
                                   AND @RunHour              >= @ProcessingSlotHour
                                    THEN DATEADD(DAY,1,DATEADD(HOUR,@ProcessingSlotHour,CONVERT(DATETIMEOFFSET(0),CONVERT(DATE,SYSUTCDATETIME()))))
                                  -- Process first coming Saturday
                                  WHEN @ActionScheduleOption = 3
                                   AND @ProcessingSlotHour   > 12
                                    THEN DATEADD(HOUR,@ProcessingSlotHour,@FirstSaturdayDateTime)
                                  WHEN @ActionScheduleOption = 3
                                   AND @ProcessingSlotHour   > 12
                                    THEN DATEADD(DAY,1,DATEADD(HOUR,@ProcessingSlotHour,@FirstSaturdayDateTime))
                                  ELSE NULL
                                END,
          ActionTaken         = CASE
                                  WHEN @ActionTakenOption = 3 THEN 'Re-Activate'                                
                                  ELSE NULL
                                END,
          ActionTakenUser     = ISNULL(@ActionTakenUser,SYSTEM_USER)
        WHERE
          NotificationKey = @NotificationKey;

        UPDATE
          [Control].OrganisationController
        SET
          DWActive         = 1,
          IsFinished       = 1,
          ScheduleDateTime = wn.ScheduleDateTime
        FROM
          [Control].WarehouseNotifications wn WITH (NOLOCK)
            INNER JOIN
          [Control].OrganisationController oc WITH (NOLOCK) ON oc.OrganisationID = wn.OrganisationID
        WHERE
            oc.OrganisationID  = @organisationID
        AND wn.NotificationKey = @NotificationKey;

        COMMIT TRANSACTION;
      END TRY
      -- CATCH Errors
      BEGIN CATCH
        ROLLBACK TRANSACTION;
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

    END;  -- end Do not Process - Re-Activate
  END;

  RETURN 0;

END;  -- end proc

GO
/****** Object:  StoredProcedure [Control].[sprWarehouseNotifications_ActionableList]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprWarehouseNotifications_ActionableList]
AS
BEGIN
  SET NOCOUNT ON;

  SELECT
    NotificationKey,
    NotificationType,
    NotificationDateTime,
    OrganisationID,
    DatabaseName,
    DatabaseSizeMB,
    ProcessingSlotHour,
    CurrentActionTaken = ISNULL(ActionTaken,''),
    ActionOption1      = CASE
                           WHEN NotificationType = 'New Database'
                            AND ActionTaken      IS NULL          THEN 'Process'
                           WHEN NotificationType = 'Removed Database'
                            AND ActionTaken      IS NULL          THEN 'Acknowledged'
                           WHEN NotificationType = 'Restored Database'
                            AND ActionTaken      IS NULL          THEN 'Process'
                           ELSE ''
                         END,
    ActionOption2      = CASE
                           WHEN NotificationType = 'New Database'
                            AND ActionTaken      IS NULL          THEN 'Do Not Process'
                           WHEN NotificationType = 'Removed Database'
                            AND ActionTaken      IS NULL          THEN 'Acknowledged All'
                           WHEN NotificationType = 'Restored Database'
                            AND ActionTaken      IS NULL          THEN 'Do Not Process'
                           ELSE ''
                         END,
    ActionOption3      = CASE
                           WHEN NotificationType = 'New Database'
                            AND ActionTaken      IS NOT NULL      THEN 'Re-Activate'
                           WHEN NotificationType = 'Restored Database'
                            AND ActionTaken      IS NOT NULL      THEN 'Re-Activate'
                           ELSE ''
                         END,
    ScheduleOption1    = CASE
                           WHEN NotificationType IN ('New Database','Restored Database')
                                                                  THEN 'Process Imediately'
                           ELSE ''
                         END,
    ScheduleOption2    = CASE
                           WHEN NotificationType IN ('New Database','Restored Database')
                                                                  THEN 'Schedule for First UTCOffset slot'
                           ELSE ''
                         END,
    ScheduleOption3    = CASE
                           WHEN NotificationType IN ('New Database','Restored Database')
                                                                  THEN 'Schedule for First Saturday'
                           ELSE ''
                         END
  FROM
    Control.WarehouseNotifications wn WITH (NOLOCK)
  WHERE
     ActionTaken IS NULL
  OR ActionTaken = 'Do Not Process'
  ORDER BY
    NotificationType,
    NotificationDateTime desc,
    DatabaseName;

  RETURN 0;

END; -- end proc

GO
/****** Object:  StoredProcedure [Control].[sprWarehouseNotifications_AddNotification]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprWarehouseNotifications_AddNotification]
(
  @NotificationType             NVARCHAR(25),
  @organisationID               INT,
  @NotificationUser             NVARCHAR(50) = NULL,
  @DatabaseSizeMB               INT          = 0,
  @CurrentDBChangeTrackVersion  BIGINT       = NULL,
  @RestoredDBChangeTrackVersion BIGINT       = NULL
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @organisationKey INT = -1;
  DECLARE @FirstSaturdayDateTime DATETIMEOFFSET(0);

  SELECT
    @FirstSaturdayDateTime = CONVERT(DATETIMEOFFSET(0),(SELECT MIN(DateKey)
                                                        FROM [MiXData].dbo.DIM_Dates WITH (NOLOCK)
                                                        WHERE DateKey >= CONVERT(DATE,SYSUTCDATETIME())
                                                        AND DayOfWeek  = 7));

  SELECT
    @organisationKey = ISNULL(MIN(OrganisationKey),-1)
  FROM
    [Control].OrganisationController WITH (NOLOCK)
  WHERE OrganisationID = @organisationID;

  BEGIN TRY
  
    BEGIN TRANSACTION
    ;WITH
    OrgData AS
    (
      SELECT
        NotificationType     = @NotificationType,
        NotificationDateTime = SYSUTCDATETIME() ,
        oc.OrganisationID,
        oc.DatabaseName  ,
        DatabaseSizeMB       = @databaseSizeMB ,
        CurrentDBChangeTrackVersion = @CurrentDBChangeTrackVersion,
        ProcessingSlotHour   = CASE
                                 WHEN UTCOffset >= 0 
                                   THEN 23-(UTCOffset/(60*60))
                                 ELSE (-UTCOffset/(60*60)) - 1
                               END,
        NotificationUser     = ISNULL(@NotificationUser,SYSTEM_USER),
        IsBusyProcessing     = 0
      FROM
        [Control].OrganisationController oc WITH (NOLOCK)
      WHERE
        oc.OrganisationID = @organisationID
      AND NOT EXISTS (SELECT 1
                      FROM [Control].WarehouseNotifications wn WITH (NOLOCK)
                      WHERE wn.OrganisationID = oc.OrganisationID
                      AND ProcessedDateTime   IS NULL
                      AND NotificationType    IN ('New Database','Restored Database'))
    )
    INSERT INTO [Control].WarehouseNotifications
    (
      NotificationType           ,
      NotificationDateTime       ,
      OrganisationID             ,
      DatabaseName               ,
      DatabaseSizeMB             ,
      CurrentDBChangeTrackVersion,
      ProcessingSlotHour         ,
      NotificationUser           ,
      IsBusyProcessing           ,
      ScheduleDateTime
    )
    SELECT
      NotificationType    ,
      NotificationDateTime,
      OrganisationID      ,
      DatabaseName        ,
      DatabaseSizeMB      ,
      CurrentDBChangeTrackVersion,
      ProcessingSlotHour,
      NotificationUser  ,
      IsBusyProcessing  ,
      ScheduleDateTime     = CASE
                               -- Process first coming Saturday (2hrs before processingslot hour)
                               WHEN od.ProcessingSlotHour-2   > 12
                                 THEN DATEADD(HOUR,od.ProcessingSlotHour-2,@FirstSaturdayDateTime)
                               WHEN od.ProcessingSlotHour-2   <= 12
                                 THEN DATEADD(DAY,1,DATEADD(HOUR,od.ProcessingSlotHour,@FirstSaturdayDateTime))
                               ELSE NULL
                             END
    FROM OrgData od;
    
    IF @NotificationType IN ('Restored Database','New Database')
    BEGIN
      ;WITH
      OrgData AS
      (
        SELECT
          OrganisationID,
          ProcessingSlotHour  = CASE 
                                  WHEN UTCOffset >= 0 
                                    THEN 23-(UTCOffset/(60*60))
                                  ELSE (-UTCOffset/(60*60)) - 1
                                END
        FROM [Control].OrganisationController
        WHERE OrganisationID = @organisationID
      )
      UPDATE
        oc
      SET
        DWActive = 1,
        IsFinished = 1,
        ScheduleDateTime    = CASE
                                -- Process first coming Saturday (2hrs before processingslot hour)
                                WHEN od.ProcessingSlotHour-2   > 12
                                  THEN DATEADD(HOUR,od.ProcessingSlotHour,@FirstSaturdayDateTime)
                                WHEN od.ProcessingSlotHour-2  <= 12
                                  THEN DATEADD(DAY,1,DATEADD(HOUR,od.ProcessingSlotHour-2,@FirstSaturdayDateTime))
                                ELSE NULL
                              END
      FROM
        OrgData od
          INNER JOIN
        [Control].OrganisationController oc ON oc.OrganisationID = od.OrganisationID;
    END
    ELSE IF @NotificationType IN ('Do not Process')
    BEGIN
      UPDATE
        [Control].OrganisationController
      SET
        DWActive = 0
      WHERE
        OrganisationID = @organisationID;
    END;

    COMMIT TRANSACTION;
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    ROLLBACK TRANSACTION;
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;  
  END CATCH;  

  RETURN 0;

END;  -- end proc

GO
/****** Object:  StoredProcedure [Control].[sprWarehouseNotifications_List]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprWarehouseNotifications_List]
(
  @fromDateTime DATETIMEOFFSET(0) = NULL,
  @toDateTime   DATETIMEOFFSET(0) = NULL
)
AS
BEGIN
  SET NOCOUNT ON;

  SELECT
    @fromDateTime = ISNULL(@fromDateTime,'19000101'),
    @toDateTime   = ISNULL(@toDateTime,SYSDATETIMEOFFSET());

  SELECT
    NotificationKey,
    NotificationType,
    NotificationDateTime,
    NotificationUser,
    OrganisationID,
    DatabaseName,
    DatabaseSizeMB,
    ProcessingSlotHour,
    CurrentActionTaken = ISNULL(ActionTaken,''),
    ActionTakenDateTime,
    ActionTakenUser,
    ProcessedDateTime
  FROM
    Control.WarehouseNotifications wn WITH (NOLOCK)
  WHERE
    NotificationDateTime BETWEEN @fromDateTime AND @toDateTime
  ORDER BY
    NotificationType,
    NotificationDateTime desc,
    DatabaseName;

  RETURN 0;

END; -- end proc

GO
/****** Object:  StoredProcedure [Control].[sprWriteErrorLog]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprWriteErrorLog]
( 
  @batchKey                       int,
  @OrganisationKey                int,
  @Threaduser                     nvarchar (50),
  @ActionType                     nvarchar (50), --Allowed Action Types: Extract,Load
  @ActionObjectName               nvarchar (50), --The table that is being actioned
  @StepDescription                nvarchar (50),
  @StepStartTime                  datetimeoffset,
  @StependTime                    datetimeoffset,
  @ErrorCode                      int,
  @ErrorDescription               nvarchar (max),
  @SourceDbCatalog                nvarchar (256),
  @SourceDbServer                 nvarchar (256),
  @SourceDBCurrChangeVersion      bigint,
  @SourceDBPrevChangeVersion      bigint
)
AS
BEGIN
  SET NOCOUNT ON;
  
  BEGIN TRY
    ----------------------------------------------------
    -- Insert into ErrorLogging
    INSERT INTO [Control].[ErrorLogging]
    ( [BatchID]
     ,[OrganisationKey]
     ,[ThreadUser]
     ,[ActionType]
     ,[ActionObjectName]
     ,[StepDescription]
     ,[StepStartDateTime]
     ,[ErrorDateTime]
     ,[ErrorCode]
     ,[ErrorDescription]
     ,[SourceDBCatalog]
     ,[SourceDBServer]
     ,[SourceDBCurrChangeVersion]
     ,[SourceDBPrevChangeVersion] )
     VALUES
     ( @batchKey,         
       @OrganisationKey,  
       @Threaduser,      
       @ActionType,      
       @ActionObjectName,
       @StepDescription, 
       @StepStartTime,   
       SYSUTCDATETIME(),     
       @ErrorCode,
       @ErrorDescription,     
       @SourceDbCatalog, 
       @SourceDbServer,
       @SourceDBCurrChangeVersion,
       @SourceDBPrevChangeVersion );

    ----------------------------------------------------
    -- Indicate Error in Controler tables
    IF     (@ActionType       = 'ExtractAttempt'
        OR  @ErrorDescription LIKE '%deadlock victim%')
       AND (3 > ISNULL((SELECT NumberOfExtractAttempts
                        FROM Control.OrganisationController
                        WHERE OrganisationKey = @OrganisationKey),0))
    BEGIN
      UPDATE
        Control.OrganisationController
      SET 
        IsFinished                = 1,
        ErrorEncountered          = 1,
        LastUpdateSuccess         = 0,
        CurrentBatch              = CurrentBatch - 1,
        LastProcessingAttemptDate = NULL,
        ScheduleDateTime          = DATEADD(s,300,ScheduleDateTime),   -- retry extract in 5m by using schedule
        NumberOfExtractAttempts   = ISNULL(NumberOfExtractAttempts,0) + 1
      WHERE OrganisationKey = @OrganisationKey;
    END
    ELSE
    BEGIN
      UPDATE
        Control.OrganisationController
      SET 
        IsFinished              = 1,
        ErrorEncountered        = 1,
        LastUpdateSuccess       = 0,
        LastSuccessbatch        = CurrentBatch,
        ScheduleDateTime        = dbo.fncGetNextSchedule(ProcessIntervalInSec, UTCOffset),
        NumberOfExtractAttempts = CASE
                                    WHEN @ActionType = 'Extract'
                                    OR @ActionObjectName = 'GetCurrentDatabaseDetails' THEN NumberOfExtractAttempts
                                    ELSE 0
                                  END
      WHERE OrganisationKey   = @OrganisationKey
        AND CurrentThreaduser = @Threaduser
        AND CurrentBatch      = @batchKey;
    END;
  
  END TRY
  -- Catch ERROR
  BEGIN CATCH
    EXEC Control.sprLogError
    RETURN -1;
  END CATCH;

  RETURN 0;
END -- end proc

GO
/****** Object:  StoredProcedure [Control].[sprWritePerformanceLog]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[sprWritePerformanceLog]  
(
  @batchKey             INT, 
  @OrganisationKey      INT, 
  @Threaduser           NVARCHAR (50), 
  @ActionType           NVARCHAR (50), 
  @ActionObjectName     NVARCHAR (50), 
  @StepDescription      NVARCHAR (50), 
  @StepStartTime        DATETIME, 
  @errors               INT, 
  @issues               INT, 
  @alerts               INT, 
  @recordsinserted      INT, 
  @recordsupdated       INT, 
  @RecordsDeleted       INT, 
  @recordsRead          INT,
  @RecordsType2Inserted INT = 0
)
AS  
BEGIN  
  SET NOCOUNT ON;  
  
  BEGIN TRY  
    INSERT INTO [Control].[PerformanceMonitor]  
    ( [BatchID]  
     ,[OrganisationKey]  
     ,[ThreadUser]  
     ,[ActionType]  
     ,[ActionObjectName]  
     ,[StepDescription]  
     ,[StepStartTime]  
     ,[StepEndTime]  
     ,[Errors]  
     ,[Issues]  
     ,[Alerts]  
     ,[RecordsInserted]  
     ,RecordsType2Inserted
     ,[RecordsUpdated]  
     ,[RecordsDeleted]  
     ,[RecordsRead] )  
    VALUES  
    ( @batchKey,           
      @OrganisationKey,    
      @Threaduser,        
      @ActionType,        
      @ActionObjectName,  
      @StepDescription,   
      @StepStartTime,     
      SYSUTCDATETIME(),       
      @errors,            
      @issues,            
      @alerts,            
      @recordsinserted,   
      @RecordsType2Inserted,
      @recordsupdated,    
      @RecordsDeleted,    
      @recordsRead );  
  
  END TRY  
  -- CATCH ERROR  
  BEGIN CATCH  
    EXEC [Control].sprLogError;  
    RETURN -1;  
  END CATCH;  
  
  RETURN 0;  
END

GO
/****** Object:  StoredProcedure [Control].[strProcProgressMonitor_Set]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Control].[strProcProgressMonitor_Set]
(
  @batchKey            int,
  @organisationKey     int,
  @procID              int,
  @flag                char(100),
  @nrOfRecordsAffected int,
  @isStartFlag         bit = 0,
  @flagStartTime       datetime = null,
  @flagSeq             smallint = null
)
AS
BEGIN

  DECLARE @procName VARCHAR(100);
  DECLARE @currentDateTime DATETIMEOFFSET(0) = SYSUTCDATETIME();
  
  SELECT @procName = OBJECT_NAME(@procID);

  IF @isStartFlag = 1
  BEGIN
    INSERT INTO [Control].ProcProgressMonitor
    (
      BatchID,
      OrganisationKey,
      ProcName       ,
      Flag           ,
      IsStartFlag    ,
      FlagSeq        ,
      FlagStartTime  ,
      FlagEndTime    ,
      DurationSeconds,
      DurationMinutes,
      NrOfRecordsAffected
    )
    SELECT
      @batchKey           ,
      @organisationKey    ,
      @procName           ,
      @flag               ,
      @isStartFlag        ,
      ISNULL(@flagSeq,1),
      ISNULL(@flagStartTime,@currentDateTime),
      @currentDateTime    ,
      0                   ,
      0                   ,
      0;
  END
  ELSE
  BEGIN
    INSERT INTO [Control].ProcProgressMonitor
    (
      BatchID,
      OrganisationKey,
      ProcName       ,
      Flag           ,
      IsStartFlag    ,
      FlagSeq        ,
      FlagStartTime  ,
      FlagEndTime    ,
      DurationSeconds,
      DurationMinutes,
      NrOfRecordsAffected
    )
    SELECT
      @batchKey       ,
      @organisationKey,
      @procName       ,
      @flag           ,
      @isStartFlag    ,
      ISNULL(@flagSeq,-1),
      ISNULL(@flagStartTime,@currentDateTime),
      @currentDateTime,
      DATEDIFF(s,ISNULL(@flagStartTime,@currentDateTime),@currentDateTime),
      DATEDIFF(minute,ISNULL(@flagStartTime,@currentDateTime),@currentDateTime),
      @nrOfRecordsAffected;

  END; -- end if
  
  RETURN 0;
END

GO
/****** Object:  StoredProcedure [dbo].[sprDriveSpace]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE PROCEDURE [dbo].[sprDriveSpace]
	@serverName [nvarchar](4000)
WITH EXECUTE AS CALLER
AS
EXTERNAL NAME [MiX.Insight.Staging].[StoredProcedures].[isp_DriveSpace]
GO
/****** Object:  StoredProcedure [StageControl].[sprDIM_MapProviderDetails_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageControl].[sprDIM_MapProviderDetails_Transform]
(
  @batchKey  int,
  @debugMode int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value    int = 0;
  DECLARE @recordsInserted int = 0;
  DECLARE @recordsUpdated  int = 0;
  DECLARE @recordsDeleted  int = 0;
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageControl].STAGE_DIM_MapProviderDetails;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------
  --BEGIN TRY

    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'1. Source Data Validation';
    
  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -------------------------------
    -- Get distinct MapProviderID|MapProviderConfiguration pairs:
    ;WITH Latest (RID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageControl].Organisation_CT
      WHERE
        Operation != 'D'
        AND CompanyGUID IS NOT NULL
      GROUP BY
        CompanyGUID
    )
    INSERT INTO [StageControl].STAGE_DIM_MapProviderDetails
    (
      MapProviderName,
      MapProviderConfiguration
    )
    SELECT DISTINCT
      MapProviderID,
      CAST(MapProviderConfiguration AS nvarchar(max))
    FROM
      [StageControl].Organisation_CT s WITH (NOLOCK)
      INNER JOIN Latest l ON s.RID = l.RID
    WHERE
      MapProviderID IS NOT NULL;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns on STG
  --------------------------------------------------------------------
  --BEGIN TRY


    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'3. Update calculated columns on STG';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError;
    
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  
  --BEGIN TRY

    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'4. Validation before Loading to DW';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 5. Add new records, no updates/deletes so no rollback
  --------------------------------------------------------------------
  BEGIN TRY

    INSERT INTO [MiXData].dbo.DIM_MapProviderDetails
    ( 
      MapProviderName,
      MapProviderConfiguration,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      MapProviderName,
      MapProviderConfiguration,
      @batchKey,
      @batchKey
    FROM
      [StageControl].STAGE_DIM_MapProviderDetails AS stg
    WHERE
      NOT EXISTS (SELECT *
                  FROM
                    [MiXData].dbo.DIM_MapProviderDetails trg
                  WHERE
                    trg.MapProviderName = stg.MapProviderName
                    AND ISNULL(CAST(trg.MapProviderConfiguration AS nvarchar(max)), '') = ISNULL(CAST(stg.MapProviderConfiguration AS nvarchar(max)), ''));
    SET @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageControl].STAGE_DIM_MapProviderDetails;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT RecordsInserted = @recordsInserted,
         RecordsUpdated  = @recordsUpdated,
         RecordsDeleted  = @recordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageControl].[sprDIM_Organisations_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =================================================================
-- Populates DIM_Organisation on DW (details of organisations)
-- =================================================================
CREATE PROCEDURE [StageControl].[sprDIM_Organisations_Transform]
(
  @batchKey  int,
  @debugMode int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageControl].STAGE_DIM_Organisations;
  TRUNCATE TABLE [StageControl].ROLLBACK_DIM_Organisations;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------
  BEGIN TRY
    -- Check 1 - Make sure that there are no empty GUIDs
    --IF EXISTS (SELECT 1
               --FROM   
                 --[Control].Organisation
               --WHERE
                 --CompanyGUID IS NULL
               --AND
                 --liOrgID     <> -1)
    --BEGIN
      --RAISERROR(N'Empty GUID values on Organisation table',16,1);
    --END;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'1. Source Data Validation';
    
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -------------------------------
    -- Organisation
    ;WITH Lastest (RID) AS
    (
      SELECT MAX(RID)
      FROM
        [StageControl].Organisation_CT
      WHERE
        CompanyGUID IS NOT NULL
      GROUP BY
        liOrgID
    )
    INSERT INTO [StageControl].STAGE_DIM_Organisations
    ( 
      [OrganisationKey]           ,
      [HostID]                    ,
      [OrganisationName]          ,
      [OrganisationGUID]          ,
      [MemberOfOrganisationKey]   ,  -- use OrganisationKey for now
      [CountryCode]               ,
      [Language]                  ,
      [IsActive]                  ,
      [DBVersion]                 ,
      [UTCOffsetKey]              ,
      [MapProviderKey]            ,
      [DutchTaxEventID]
      
    )
    SELECT 
      [OrganisationKey]           = -1,
      [HostID]                    = s.liOrgID,
      [OrganisationName]          = s.sOrganisationName,
      [OrganisationGUID]          = s.CompanyGUID,
      [MemberOfOrganisationKey]   = 0,    -- still to be defined
      [CountryCode]               = s.sCountryCode,
      [Language]                  = s.sLanguage,
      [IsActive]                  = s.bActive,
      [DBVersion]                 = s.sDBVersion,
      [UTCOffsetKey]              = -1,
      [MapProviderKey]            = mp.MapProviderKey,
      [DutchTaxEventID]           = s.DutchTaxEventID
    FROM
      [StageControl].Organisation_CT          s WITH (NOLOCK)
        INNER JOIN
      Lastest                                 l  ON l.RID = s.RID
        LEFT JOIN
      [MiXData].dbo.DIM_MapProviderDetails mp ON s.MapProviderID            = mp.MapProviderName
                                                AND ISNULL(CAST(s.MapProviderConfiguration AS nvarchar(max)), '') = ISNULL(CAST(mp.MapProviderConfiguration AS nvarchar(max)), '')
    WHERE
      s.CompanyGUID IS NOT NULL;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns on STG
  --------------------------------------------------------------------
  BEGIN TRY


    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns on STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    INSERT INTO [StageControl].ROLLBACK_DIM_Organisations
    ( 
      [OrganisationKey]           ,
      [HostID]                    ,
      [OrganisationName]          ,
      [DealerName]                ,
      [DealerTelNo]               ,
      [OrganisationGUID]          ,
      [MemberOfOrganisationKey]   ,
      [CountryCode]               ,
      [Language]                  ,
      [IsActive]                  ,
      [MapProviderKey]            ,
      [DBVersion]                 ,
      [DutchTaxEventID]           ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    )
    SELECT
      [OrganisationKey]           ,
      [HostID]                    ,
      [OrganisationName]          ,
      [DealerName]                ,
      [DealerTelNo]               ,
      [OrganisationGUID]          ,
      [MemberOfOrganisationKey]   ,
      [CountryCode]               ,
      [Language]                  ,
      [IsActive]                  ,
      [MapProviderKey]            ,
      [DBVersion]                 ,
      [DutchTaxEventID]           ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    FROM 
     (MERGE [MiXData].dbo.DIM_Organisations   AS tar
      USING [StageControl].STAGE_DIM_Organisations AS stg
       ON  tar.HostID           = stg.HostID
      WHEN MATCHED 
       THEN 
        UPDATE 
        SET tar.[OrganisationName]          = stg.[OrganisationName]        ,
            tar.[MemberOfOrganisationKey]   = stg.[MemberOfOrganisationKey] ,
            tar.[CountryCode]               = stg.[CountryCode]             ,
            tar.[Language]                  = stg.[Language]                ,
            tar.[IsActive]                  = stg.[IsActive]                ,
            tar.[MapProviderKey]            = ISNULL(stg.[MapProviderKey]   ,tar.[MapProviderKey]),
            tar.[DBVersion]                 = stg.[DBVersion]               ,
            tar.[DutchTaxEventID]           = ISNULL(stg.[DutchTaxEventID]  ,tar.[DutchTaxEventID]),
            tar.[UTCOffsetKey]              = stg.[UTCOffsetKey]            ,
            tar.OrganisationGUID            = stg.OrganisationGUID,
            tar.UpdateBatchKey              = @batchKey
      WHEN NOT MATCHED THEN 
        INSERT 
        ( 
          [HostID]                    ,
          [OrganisationName]          ,
          [DealerName]                ,
          [DealerTelNo]               ,
          [OrganisationGUID]          ,
          [MemberOfOrganisationKey]   ,
          [CountryCode]               ,
          [Language]                  ,
          [IsActive]                  ,
          [MapProviderKey]            ,
          [DBVersion]                 ,
          [DutchTaxEventID]           ,
          [UTCOffsetKey]              ,
          [CreateBatchKey]            ,
          [UpdateBatchKey]
        ) 
        VALUES 
        ( 
          stg.[HostID]                    ,
          stg.[OrganisationName]          ,
          stg.[DealerName]                ,
          stg.[DealerTelNo]               ,
          stg.[OrganisationGUID]          ,
          stg.[MemberOfOrganisationKey]   ,
          stg.[CountryCode]               ,
          stg.[Language]                  ,
          stg.[IsActive]                  ,
          stg.[MapProviderKey]            ,
          stg.[DBVersion]                 ,
          stg.[DutchTaxEventID]           ,
          stg.[UTCOffsetKey]              ,
          @batchKey,
          @batchKey )
      OUTPUT 
        $action   AS Operation,
        DELETED.[HostID]                    ,
        DELETED.[OrganisationKey]           ,
        DELETED.[OrganisationName]          ,
        DELETED.[DealerName]                ,
        DELETED.[DealerTelNo]               ,
        DELETED.[OrganisationGUID]          ,
        DELETED.[MemberOfOrganisationKey]   ,
        DELETED.[CountryCode]               ,
        DELETED.[Language]                  ,
        DELETED.[IsActive]                  ,
        DELETED.[MapProviderKey]            ,
        DELETED.[DBVersion]                 ,
        DELETED.[DutchTaxEventID]           ,
        DELETED.[UTCOffsetKey]              ,
        DELETED.[CreateBatchKey]            ,
        DELETED.[UpdateBatchKey]  -- end merge
      ) AS RollBck
    WHERE Operation = 'UPDATE'; -- end insert

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageControl].STAGE_DIM_Organisations;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT @recordsUpdated = count(1)
  FROM   [MiXData].dbo.DIM_Organisations WITH (NOLOCK)
  WHERE  UpdateBatchKey = @batchKey;

  SELECT @recordsInserted = count(1)
  FROM   [MiXData].dbo.DIM_Organisations WITH (NOLOCK)
  WHERE  CreateBatchKey = @batchKey;
  
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = (isnull(@recordsUpdated,0) - isnull(@recordsInserted,0)),  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageControl].[sprDIM_UTCOffsets_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =================================================================
-- Populates DIM_Organisation on DW (details of organisations
-- =================================================================
CREATE PROCEDURE [StageControl].[sprDIM_UTCOffsets_Transform]
(
  @batchKey  int,
  @debugMode int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @currentDate     datetimeoffset;
  DECLARE @currentYear     int;
  DECLARE @startDateKey    date;
  DECLARE @endDateKey      date;

  DECLARE @endDateDefault       date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)
  DECLARE @startDateFirstInsert date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)

  DECLARE @type2Changes table
  ( OrganisationKey int primary key );
  
  SELECT @currentDate  = SYSUTCDATETIME(),
         @currentYear  = YEAR(SYSUTCDATETIME()),
         @startDateKey = CONVERT(DATE,SYSUTCDATETIME()),
         @endDateKey   = CONVERT(DATE,DATEADD(DAY,-1,SYSUTCDATETIME()));

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageControl].STAGE_DIM_UTCOffsets;
  TRUNCATE TABLE [StageControl].ROLLBACK_DIM_UTCOffsets;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------
  BEGIN TRY
    -- Check 1 - Make sure that there are no empty GUIDs


    IF @debugMode = 1  -- DebugMode is true
      PRINT N'1. Source Data Validation';
    
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError;
    
    RETURN -1;
  END CATCH;
  
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

	  INSERT INTO [StageControl].STAGE_DIM_UTCOffsets
	  (
      [OrganisationKey]   ,
      [AdjustmentType]    ,
      [UTCOffset]         ,
      [DaylightAdjustment],
      [UTCOffsetMinutes]  ,
      [DaylightStart]     ,
      [DaylightEnd]
	  )
	  SELECT DISTINCT
      dorg.[OrganisationKey]     ,
      'Standard'                 ,
      s.liGMTOffset              ,
      0                          ,
      ISNULL(s.liGMTOffset,0)/60 ,
      s.[dtDaylightStart]        ,
      s.[dtDaylightEnd]
	  FROM
	    [StageControl].Organisation        s    WITH (NOLOCK)
	      INNER JOIN
	    [MiXData].dbo.DIM_Organisations dorg WITH (NOLOCK)
	      ON s.liOrgID = dorg.HostID;

	  INSERT INTO [StageControl].STAGE_DIM_UTCOffsets
	  (
      [OrganisationKey]   ,
      [AdjustmentType]    ,
      [UTCOffset]         ,
      [DaylightAdjustment],
      [UTCOffsetMinutes]  ,
      [DaylightStart]     ,
      [DaylightEnd]
	  )
	  SELECT DISTINCT
      dorg.[OrganisationKey]                              ,
      [AdjustmentType]       = 'Adjustment'               ,
      [UTCOffset]            = s.liGMTOffset              ,
      [DayLightAdjustment]   = s.liDaylightAdjust         ,
      [UTCOffsetMinutes]     = (ISNULL(s.liGMTOffset,0) + ISNULL(s.liDaylightAdjust,0))/60,
      [DayLightStart]        = s.[dtDaylightStart]        ,
      [DaylightEnd]          = s.[dtDaylightEnd]
	  FROM
	    [StageControl].Organisation        s    WITH (NOLOCK)
	      INNER JOIN
	    [MiXData].dbo.DIM_Organisations dorg WITH (NOLOCK) ON s.liOrgID = dorg.HostID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Validation before Loading to DW
  --------------------------------------------------------------------
 BEGIN TRY


    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. MERGE to DW (Load) and add to RollBck (Type 2)
  --------------------------------------------------------------------
  BEGIN TRY

    INSERT INTO [StageControl].ROLLBACK_DIM_UTCOffsets
    (
      [UTCOffsetKey]      ,
      [StartDateKey]      ,
      [EndDateKey]        ,
      [IsCurrentRecord]   ,
      [OrganisationKey]   ,
      [AdjustmentType]    ,
      [UTCOffset]         ,
      [DaylightAdjustment],
      [UTCOffsetMinutes]  ,
      [DaylightStart]     , 
      [DaylightEnd]       , 
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    )
    SELECT
      [UTCOffsetKey]      ,
      [StartDateKey]      ,
      [EndDateKey]        ,
      [IsCurrentRecord]   ,
      [OrganisationKey]   ,
      [AdjustmentType]    ,
      [UTCOffset]         ,
      [DaylightAdjustment],
      [UTCOffsetMinutes]  ,
      [DaylightStart]     , 
      [DaylightEnd]       , 
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    FROM 
     (MERGE [MiXData].dbo.DIM_UTCOffsets   AS tar
      USING [StageControl].STAGE_DIM_UTCOffsets AS stg
       ON  tar.IsCurrentRecord = 1                     -- the most recent record
       AND tar.OrganisationKey = stg.OrganisationKey
       AND tar.AdjustmentType  = stg.AdjustmentType

      -- Matched and DW StartDateKey = StartDate (then just update)
      WHEN MATCHED
       AND  tar.StartDateKey = @startDateKey
       AND  tar.EndDateKey   = @endDateDefault
       AND (isnull(tar.UTCOffset,0)                <> isnull(stg.UTCOffset,0)
        OR  isnull(tar.DaylightStart,'1900-01-01') <> isnull(stg.DaylightStart,'1900-01-01')
        OR  isnull(tar.DaylightEnd  ,'1900-01-01') <> isnull(stg.DaylightEnd  ,'1900-01-01')
        OR  isnull(tar.DaylightAdjustment,0)       <> isnull(stg.DaylightAdjustment,0))
      THEN
        UPDATE 
        SET
          tar.UTCOffset          = isnull(stg.UTCOffset,0)     ,
          tar.DaylightStart      = stg.DaylightStart           ,
          tar.DaylightEnd        = stg.DaylightEnd             ,
          tar.DaylightAdjustment = isnull(stg.DaylightAdjustment,0),
          tar.[UpdateBatchKey]   = @batchKey

      -- Not Matched
      WHEN NOT MATCHED THEN 
        INSERT 
        ( 
          [StartDateKey]      ,
          [EndDateKey]        ,
          [IsCurrentRecord]   ,
          [OrganisationKey]   ,
          [AdjustmentType]    ,
          [UTCOffset]         ,
          [DaylightAdjustment],
          [UTCOffsetMinutes]  ,
          [DaylightStart]     , 
          [DaylightEnd]       , 
          [CreateBatchKey]    ,
          [UpdateBatchKey]
        )
        VALUES 
        ( 
          @startDateFirstInsert,
          @endDateDefault      ,
          1                    ,
          stg.[OrganisationKey]    ,
          stg.[AdjustmentType]     ,
          stg.[UTCOffset]          ,
          stg.[DaylightAdjustment] ,
          stg.[UTCOffsetMinutes]   ,
          stg.[DaylightStart]      , 
          stg.[DaylightEnd]        , 
          @batchKey             ,
          @batchKey 
        )        
      OUTPUT 
        $action   AS Operation, 
        DELETED.[UTCOffsetKey]      ,
        DELETED.[StartDateKey]      ,
        DELETED.[EndDateKey]        ,
        DELETED.[IsCurrentRecord]   ,
        DELETED.[OrganisationKey]   ,
        DELETED.[AdjustmentType]    ,
        DELETED.[UTCOffset]         ,
        DELETED.[DaylightAdjustment],
        DELETED.[UTCOffsetMinutes]  ,
        DELETED.[DaylightStart]     , 
        DELETED.[DaylightEnd]       , 
        DELETED.[CreateBatchKey]    ,
        DELETED.[UpdateBatchKey]
      ) AS RollBck
    WHERE 
      Operation = 'UPDATE'
    AND
      [UpdateBatchKey] < @batchKey; -- end insert

    -- identify if there is a type 2 change on either AdjustmentTypes and update/insert accordingly
    INSERT INTO @type2Changes
    ( OrganisationKey )
    SELECT DISTINCT stg.OrganisationKey
    FROM
      [MiXData].dbo.DIM_UTCOffsets        tar WITH (NOLOCK)
        INNER JOIN
      [StageControl].STAGE_DIM_UTCOffsets stg WITH (NOLOCK) ON tar.IsCurrentRecord = 1
                                                           AND tar.OrganisationKey = stg.OrganisationKey
                                                           AND tar.AdjustmentType  = stg.AdjustmentType
    WHERE  tar.StartDateKey     < @StartDateKey
      AND  tar.EndDateKey       = @endDateDefault
      AND  tar.[UpdateBatchKey] < @batchKey
      AND (isnull(tar.UTCOffset,0)                <> isnull(stg.UTCOffset,0)
       OR  isnull(tar.DaylightStart,'1900-01-01') <> isnull(stg.DaylightStart,'1900-01-01')
       OR  isnull(tar.DaylightEnd  ,'1900-01-01') <> isnull(stg.DaylightEnd  ,'1900-01-01')
       OR  isnull(tar.DaylightAdjustment,0)       <> isnull(stg.DaylightAdjustment,0));
    
    -- Matched and DW StartDateKey < StartDate (set EndDateKey/IsCurrentRecord)    
    INSERT INTO [StageControl].ROLLBACK_DIM_UTCOffsets
    ( 
      [UTCOffsetKey]      ,
      [StartDateKey]      ,
      [EndDateKey]        ,
      [IsCurrentRecord]   ,
      [OrganisationKey]   ,
      [AdjustmentType]    ,
      [UTCOffset]         ,
      [DaylightAdjustment],
      [UTCOffsetMinutes]  ,
      [DaylightStart]     , 
      [DaylightEnd]       , 
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    )
    SELECT
      [UTCOffsetKey]      ,
      [StartDateKey]      ,
      [EndDateKey]        ,
      [IsCurrentRecord]   ,
      [OrganisationKey]   ,
      [AdjustmentType]    ,
      [UTCOffset]         ,
      [DaylightAdjustment],
      [UTCOffsetMinutes]  ,
      [DaylightStart]     , 
      [DaylightEnd]       , 
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    FROM 
     (UPDATE
        tar
      SET
        tar.EndDateKey      = @endDateKey,
        tar.IsCurrentRecord = 0          ,
        tar.UpdateBatchKey  = @batchKey
      OUTPUT 
        DELETED.[UTCOffsetKey]      ,
        DELETED.[StartDateKey]      ,
        DELETED.[EndDateKey]        ,
        DELETED.[IsCurrentRecord]   ,
        DELETED.[OrganisationKey]   ,
        DELETED.[AdjustmentType]    ,
        DELETED.[UTCOffset]         ,
        DELETED.[DaylightAdjustment],
        DELETED.[UTCOffsetMinutes]  ,
        DELETED.[DaylightStart]     , 
        DELETED.[DaylightEnd]       , 
        DELETED.[CreateBatchKey]    ,
        DELETED.[UpdateBatchKey]
      FROM
        @type2Changes                       t2c
          INNER JOIN
        [MiXData].dbo.DIM_UTCOffsets        tar WITH (NOLOCK) ON tar.OrganisationKey = t2c.OrganisationKey
          INNER JOIN
        [StageControl].STAGE_DIM_UTCOffsets stg WITH (NOLOCK) ON tar.IsCurrentRecord = 1
                                                             AND tar.OrganisationKey = stg.OrganisationKey
                                                             AND tar.AdjustmentType  = stg.AdjustmentType
      ) AS RollBck              -- end merge
    WHERE
      [UpdateBatchKey] < @batchKey; -- end insert

    -- Insert new Records for Type 2 changes
    INSERT INTO [MiXData].dbo.DIM_UTCOffsets
    (
      [StartDateKey]      ,
      [EndDateKey]        ,
      [IsCurrentRecord]   ,
      [OrganisationKey]   ,
      [AdjustmentType]    ,
      [UTCOffset]         ,
      [DaylightAdjustment],
      [UTCOffsetMinutes]  ,
      [DaylightStart]     , 
      [DaylightEnd]       , 
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    )
    SELECT
      @startDateKey            ,
      @endDateDefault          ,
      1                        ,
      stg.[OrganisationKey]    ,
      stg.[AdjustmentType]     ,
      stg.[UTCOffset]          ,
      stg.[DaylightAdjustment] ,
      stg.[UTCOffsetMinutes]   ,
      stg.[DaylightStart]      , 
      stg.[DaylightEnd]        , 
      @batchKey                ,
      @batchKey -- select *
    FROM
      @type2Changes                       t2c
        INNER JOIN
      [StageControl].STAGE_DIM_UTCOffsets stg WITH (NOLOCK) ON stg.OrganisationKey = t2c.OrganisationKey;

    ------------------------------------------
    -- Update DIM_Organisation UTCOffsetKey
    UPDATE
      [MiXData].dbo.DIM_Organisations
    SET
      UTCOffsetKey = dutc.UTCOffsetKey
    FROM
      [MiXData].dbo.DIM_Organisations tar
        INNER JOIN
      [MiXData].dbo.DIM_UTCOffsets    dutc WITH (NOLOCK) ON tar.OrganisationKey = dutc.OrganisationKey
    WHERE
        dutc.IsCurrentRecord = 1
    AND dutc.AdjustmentType  = 'Standard';

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageControl].STAGE_DIM_UTCOffsets;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'5. Cleanup work tables';

  --------------------------------------------------------------------
  -- 6. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT @recordsUpdated = count(1)
  FROM   [MiXData].dbo.DIM_UTCOffsets WITH (NOLOCK)
  WHERE  UpdateBatchKey = @batchKey;

  SELECT @recordsInserted = count(1)
  FROM   [MiXData].dbo.DIM_UTCOffsets WITH (NOLOCK)
  WHERE  CreateBatchKey = @batchKey;
  
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = (isnull(@recordsUpdated,0) - isnull(@recordsInserted,0)),  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageControl].[sprDriverApp_MergeRegisteredDriversOrganisations]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageControl].[sprDriverApp_MergeRegisteredDriversOrganisations]
AS
BEGIN
  SET NOCOUNT ON;
  
  MERGE [MiXData].cache.DriverApp_RegisteredDrivers tar
  USING [StageControl].DriverApp_RegisteredUsers stg
     ON tar.OrganisationID = stg.OrganisationID
    AND tar.DriverID       = stg.DriverID
  WHEN NOT MATCHED BY TARGET THEN
    INSERT
    (
      OrganisationID  ,
      DriverID
    )
    VALUES
    (
      stg.OrganisationID  ,
      stg.DriverID
    )
  WHEN NOT MATCHED BY SOURCE THEN DELETE;

  ;WITH
  RegisteredDriverOrganisations AS
  (
    SELECT
      oc.OrganisationID,
      oc.OrganisationKey
    FROM [Control].OrganisationController oc WITH (NOLOCK)
    WHERE EXISTS (SELECT 1 FROM [MiXData].cache.DriverApp_RegisteredDrivers rd WITH (NOLOCK)
                  WHERE rd.OrganisationID = oc.OrganisationID)
  )
  MERGE [Control].DriverAppCache tar
  USING RegisteredDriverOrganisations stg
     ON tar.OrganisationID = stg.OrganisationID
  WHEN MATCHED THEN
    UPDATE SET
      tar.OrganisationKey = stg.OrganisationKey
  WHEN NOT MATCHED BY TARGET THEN
    INSERT
    (
      OrganisationID,
      OrganisationKey,
      ScheduleDateTime
    )
    VALUES
    (
      stg.OrganisationID,
      stg.OrganisationKey,
      SYSUTCDATETIME()
    )
  WHEN NOT MATCHED BY SOURCE THEN DELETE;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageControl].[sprFACT_EventSummaryInitial_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_EventSummary on DW
-- ==============================================================================
/*
  Dependencies:

   FACT_ActivityDetails
   
   STAGE_FACT_ActivityDetails

*/
CREATE PROCEDURE [StageControl].[sprFACT_EventSummaryInitial_Transform]
(
  @batchKey         int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;
  DECLARE @maxDuration         bigint = 2147483647; -- this is the max int data type value
  DECLARE @maxFuelLimit        int  = 99999.0; -- anything bigger than 68 causes overflow of int datatype    
  DECLARE	@currentDate         datetimeoffset = SYSUTCDATETIME(); -- used for validation

  -- used to loop through organisations
  DECLARE @organisationKey int = -1;
  DECLARE @loopCounter     int = 0;

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE  [StageControl].[STAGE_FACT_EventSummary_Processed]

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' START INITIAL - FACT_EventSummary';
  END;

  -- populate list of organistions to be processed
  INSERT INTO [StageControl].[STAGE_FACT_EventSummary_Processed]
  ( OrganisationKey, NrOfRecords, Processed )
  SELECT DISTINCT
    OrganisationKey,COUNT(1),0
  FROM
    [MiXData].dbo.FACT_EventDetails fad WITH (NOLOCK)
  GROUP BY OrganisationKey
  ORDER BY OrganisationKey;

  -- loop through list to be processed
  BEGIN TRY

    WHILE EXISTS (SELECT 1 FROM [StageControl].[STAGE_FACT_EventSummary_Processed]
                  WHERE Processed = 0)
          AND (@loopCounter < 10000) -- make sure loop does end
    BEGIN

      SELECT @recordsInserted = 0,
             @recordsUpdated  = 0;
    
      -- get next Organisation to process
      SELECT
        @organisationKey = MIN(OrganisationKey)
      FROM
        [StageControl].[STAGE_FACT_EventSummary_Processed]
      WHERE
        Processed = 0;

      --------------------------------------------------------------------
      -- 0. Make sure work tables are cleared
      --------------------------------------------------------------------
      TRUNCATE TABLE [StageControl].[STAGE_FACT_EventSummary];

      IF @debugMode = 1  -- DebugMode is true
      BEGIN
        PRINT N'';
        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' ------------------------ OrganisationKey: ' + CONVERT(NVARCHAR(10),@organisationKey);
        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
      END;

      --------------------------------------------------------------------
      -- 1. Source Data Validation
      --------------------------------------------------------------------

      --------------------------------------------------------------------
      -- 2. Add to STG
      --------------------------------------------------------------------

        -- drop STAGE indexes before insert
        IF EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageControl].[STAGE_FACT_EventSummary]') AND name = N'IX_STAGE_FACT_EventSummary_VehicleKey')
          DROP INDEX IX_STAGE_FACT_EventSummary_VehicleKey ON [StageControl].[STAGE_FACT_EventSummary];

        IF EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageControl].[STAGE_FACT_EventSummary]') AND name = N'IX_STAGE_FACT_EventSummary_IsDeleted')
          DROP INDEX IX_STAGE_FACT_EventSummary_IsDeleted ON [StageControl].[STAGE_FACT_EventSummary];

        -- insert Organisation's records into STG
        INSERT INTO [StageControl].STAGE_FACT_EventSummary
        (
          [EventDescriptionKey],
          [VehicleKey]         ,
          [DriverKey]          ,
          [EventStartDateKey]  ,
          [TrailerKey]         ,
          [UTCOffsetKey]       ,
          [IsDeleted]          ,
          [NumberOfEvents]     ,
          [MaxEventValue]      ,
          [MinEventValue]      ,
          [AvgEventValue]      ,
          [TotalEventValue]    ,
          [TotalOccurs]        ,
          [TotalTime]          ,
          [TotalLitres]
        )
        SELECT
          fed.EventDescriptionKey,
          fed.VehicleKey,
          fed.DriverKey,
          fed.EventStartDateKey,
          fed.TrailerKey,
          fed.UTCOffsetKey,
          fed.IsDeleted,
          [NumberOfEvents]  = COUNT(1)            ,
          [MaxEventValue]   = MAX(fed.EventValue) ,
          [MinEventValue]   = MIN(fed.EventValue) ,
          [AvgEventValue]   = AVG(fed.EventValue) ,
          [TotalEventValue] = SUM(fed.EventValue) ,
          [TotalOccurs]     = SUM(fed.TotalOccurs),
          [TotalTime]       = CASE
                                WHEN ABS(SUM(CONVERT(BIGINT,fed.TotalTime))) >= @maxDuration
                                  THEN -2
                                ELSE
                                  SUM(CONVERT(BIGINT,fed.TotalTime))
                              END,
          [TotalLitres]     = SUM(CONVERT(decimal(19,4), fed.Litres))
        FROM
          [MiXData].dbo.DIM_EventDescriptions ded WITH (NOLOCK)
            INNER JOIN
          [MiXData].dbo.FACT_EventDetails     fed WITH (NOLOCK) ON ded.OrganisationKey     = @organisationKey
                                                               AND fed.EventDescriptionKey = ded.EventDescriptionKey
        GROUP BY
          fed.EventDescriptionKey,
          fed.VehicleKey,
          fed.DriverKey,
          fed.EventStartDateKey,
          fed.TrailerKey,
          fed.UTCOffsetKey,
          fed.IsDeleted;

        -- remove IsDeleted records
        CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventSummary_IsDeleted
          ON [StageControl].[STAGE_FACT_EventSummary](IsDeleted);

        DELETE
          [StageControl].STAGE_FACT_EventSummary
        WHERE
          IsDeleted = 1;

        DROP INDEX IX_STAGE_FACT_EventSummary_IsDeleted
          ON [StageControl].[STAGE_FACT_EventSummary];

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
        END;

      --------------------------------------------------------------------
      -- 3. Update calculated columns onto STG
      --------------------------------------------------------------------

        CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventSummary_VehicleKey
          ON [StageControl].[STAGE_FACT_EventSummary](VehicleKey);

        ------------------------------------------
        -- VehicleSiteKey
        UPDATE stg
        SET
          VehicleSiteKey = ds.SiteKey
        FROM
          [StageControl].STAGE_FACT_EventSummary stg
            INNER JOIN
          [MiXData].dbo.DIM_Vehicles              dvh WITH (NOLOCK) ON stg.VehicleKey = dvh.VehicleKey
            INNER JOIN
          [MiXData].dbo.DIM_Sites                 ds  WITH (NOLOCK) ON ds.OrganisationKey = dvh.OrganisationKey
                                                                      AND ds.SiteGUID        = dvh.SiteGUID;

        SELECT @nrOfrecordsAffected = @@ROWCOUNT;

      --------------------------------------------------------------------
      -- 4. Validation before Loading to DW
      --------------------------------------------------------------------
     
        IF @debugMode = 1  -- DebugMode is true
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

      --------------------------------------------------------------------
      -- 5. MERGE to DW (Load) and add to RollBck
      --------------------------------------------------------------------
       
        -- just make sure that there are no existing records for this organisation
        IF EXISTS (SELECT 1 FROM [MiXData].dbo.FACT_EventSummary
                   WHERE OrganisationKey = @organisationKey)
          DELETE [MiXData].dbo.FACT_EventSummary
          WHERE OrganisationKey = @organisationKey;

        -- No Changed records, so no calculations necesarry

        -- insert new records to FACT
        INSERT INTO [MiXData].dbo.FACT_EventSummary
        (
          [OrganisationKey]    ,
          [VehicleSiteKey]     ,
          [DriverKey]          ,
          [VehicleKey]         ,
          [TrailerKey]         ,
          [EventDescriptionKey],
          [EventStartDateKey]  ,
          [NumberOfEvents]     ,
          [MaxEventValue]      ,
          [MinEventValue]      ,
          [AvgEventValue]      ,
          [TotalEventValue]    ,
          [TotalOccurs]        ,
          [TotalTime]          ,
          [TotalLitres]        ,
          [UTCOffsetKey]       ,
          [CreateBatchKey]     ,
          [UpdateBatchKey]
        )
        SELECT
          @organisationKey     ,
          ISNULL([VehicleSiteKey] ,-1),
          [DriverKey]          ,
          [VehicleKey]         ,
          [TrailerKey]         ,
          [EventDescriptionKey],
          [EventStartDateKey]  ,
          ISNULL([NumberOfEvents] ,0),
          [MaxEventValue]      ,
          [MinEventValue]      ,
          [AvgEventValue]      ,
          ISNULL([TotalEventValue],0.0),
          ISNULL([TotalOccurs]    ,0),
          ISNULL([TotalTime]      ,0),
          ISNULL([TotalLitres]    ,0.0),
          [UTCOffsetKey]       ,
          @batchKey            ,
          @batchKey
        FROM
          [StageControl].STAGE_FACT_EventSummary;        

        -- record number of records inserted
        SELECT @recordsInserted = @@ROWCOUNT;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
        END;

      --------------------------------------------------------------------
      -- 6. Cleanup work tables
      --------------------------------------------------------------------

      --------------------------------------------------------------------
      -- 7. Return values for Performance Monitoring
      --------------------------------------------------------------------

      IF @debugMode = 1  -- DebugMode is true
      BEGIN
        SELECT @nrOfRecordsAffected = ISNULL(@recordsInserted,0) + ISNULL(@recordsUpdated,0);
        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
      END;
      
      UPDATE [StageControl].[STAGE_FACT_EventSummary_Processed]
      SET Processed = 1, NrOfRecordsAffected = @nrOfRecordsAffected
      WHERE OrganisationKey = @organisationKey;
      
      SELECT @loopCounter = @loopCounter + 1;

    END; -- end while

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' END INITIAL - FACT_EventSummary';
      PRINT N'';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageControl].[sprFACT_ShapeVisitsInitial_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_ShapeVisits on DW
-- ==============================================================================
/*
  Dependencies:

   FACT_ActivityDetails
   
   STAGE_FACT_ActivityDetails

*/
CREATE PROCEDURE [StageControl].[sprFACT_ShapeVisitsInitial_Transform]
(
  @batchKey         int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;
  DECLARE @unknownDateDefault  date   = '00010101';
  DECLARE @maxDuration         bigint = 2147483647; -- this is the max int data type value
  DECLARE @maxDurationYears    int  = 68; -- anything bigger than 68 causes overflow of int datatype
  DECLARE @maxFuelLimit        int  = 99999.0; -- anything bigger than 68 causes overflow of int datatype    
  DECLARE	@currentDate         datetimeoffset = SYSUTCDATETIME(); -- used for validation

  -- used to loop through organisations
  DECLARE @organisationKey int = -1;
  DECLARE @loopCounter     int = 0;


  -- used for temporary storage
  CREATE TABLE #activityEndGeoLocation
  (
    EndGeoLocationKey  bigint,
    EndShapeKey        int
  );
  
  CREATE TABLE #VehiclesLookup
  (
    VehicleKey INT NOT NULL,
    HostID     INT NOT NULL
  );

  CREATE TABLE #ShapesLookup
  (
    ShapeKey INT NOT NULL
  );

  CREATE TABLE #DuplicateActivityShapes
  (
    VehicleKey                    int,
    DriverKey                     int,
    ActivityStartDateKey          date,
    ActivityDetailKey             bigint,
    NextMovementActivityDetailKey bigint,
    EndShapeKey                   int,
    NMEndShapeKey                 int
  );

  CREATE TABLE #DeDuplicatedActivityShapes
  (
    VehicleKey                    int,
    DriverKey                     int,
    ActivityStartDateKey          date,
    ActivityDetailKey             bigint,
    NextMovementActivityDetailKey bigint,
    EndShapeKey                   int,
    NMEndShapeKey                 int
  );

  CREATE CLUSTERED INDEX IX_VehiclesLookup ON #VehiclesLookup(VehicleKey);
  CREATE CLUSTERED INDEX IX_ShapesLookup   ON #ShapesLookup(ShapeKey);

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE  [StageControl].[STAGE_FACT_ShapeVisits_Processed]

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' START INITIAL - FACT_ShapeVisits';
  END;

  -- populate list of organistions to be processed
  INSERT INTO [StageControl].[STAGE_FACT_ShapeVisits_Processed]
  ( OrganisationKey, NrOfRecords, Processed )
  SELECT
    OrganisationKey, COUNT(1), 0
  FROM
    [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK)
  GROUP BY OrganisationKey
  ORDER BY OrganisationKey;

  -- loop through list to be processed
  BEGIN TRY

    WHILE EXISTS (SELECT 1 FROM [StageControl].[STAGE_FACT_ShapeVisits_Processed]
                  WHERE Processed = 0)
          AND (@loopCounter < 10000) -- make sure loop does end
    BEGIN

      SELECT @recordsInserted = 0,
             @recordsUpdated  = 0;
    
      -- get next Organisation to process
      SELECT
        @organisationKey = MIN(OrganisationKey)
      FROM
        [StageControl].[STAGE_FACT_ShapeVisits_Processed]
      WHERE
        Processed = 0;

      --------------------------------------------------------------------
      -- 0. Make sure work tables are cleared
      --------------------------------------------------------------------
      TRUNCATE TABLE [StageControl].[STAGE_FACT_ShapeVisits];
      TRUNCATE TABLE #VehiclesLookup;
      TRUNCATE TABLE #ShapesLookup;
      TRUNCATE TABLE #activityEndGeoLocation;
      TRUNCATE TABLE #DuplicateActivityShapes;
      TRUNCATE TABLE #DeDuplicatedActivityShapes;
      
      IF @debugMode = 1  -- DebugMode is true
      BEGIN
        PRINT N'';
        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' ------------------------ OrganisationKey: ' + CONVERT(NVARCHAR(10),@organisationKey);
        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
      END;

      --------------------------------------------------------------------
      -- 1. Source Data Validation
      --------------------------------------------------------------------

      --------------------------------------------------------------------
      -- 2. Add to STG
      --------------------------------------------------------------------

      -- drop temp table indexes
      IF EXISTS(SELECT 1
                FROM
                  tempdb.sys.indexes    i
                    INNER JOIN
                  tempdb.sys.sysobjects o ON o.[id] = i.[object_id]
                WHERE 
                    i.name like '%IX_activityEndGeoLocation%'
                AND o.name LIKE '%activityEndGeoLocation%')
        DROP INDEX IX_activityEndGeoLocation ON #activityEndGeoLocation;

      IF EXISTS(SELECT 1
                FROM
                  tempdb.sys.indexes    i
                    INNER JOIN
                  tempdb.sys.sysobjects o ON o.[id] = i.[object_id]
                WHERE 
                    i.name like '%IX_DuplicatedActivityShapes%'
                AND o.name LIKE '%DuplicateActivityShapes%')
        DROP INDEX IX_DuplicatedActivityShapes ON #DuplicateActivityShapes;

      IF EXISTS(SELECT 1
                FROM
                  tempdb.sys.indexes    i
                    INNER JOIN
                  tempdb.sys.sysobjects o ON o.[id] = i.[object_id]
                WHERE 
                    i.name like '%IX_DeDuplicatedActivityShapes%'
                AND o.name LIKE '%DeDuplicatedActivityShapes%')
        DROP INDEX IX_DeDuplicatedActivityShapes ON #DeDuplicatedActivityShapes;

        -- drop STAGE indexes before insert
        IF EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageControl].[STAGE_FACT_ShapeVisits]') AND name = N'IX_STAGE_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey')
          DROP INDEX IX_STAGE_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey ON [StageControl].[STAGE_FACT_ShapeVisits];
        IF EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageControl].[STAGE_FACT_ShapeVisits]') AND name = N'IX_STAGE_FACT_ShapeVisits_IsDeleted')
          DROP INDEX IX_STAGE_FACT_ShapeVisits_IsDeleted ON [StageControl].[STAGE_FACT_ShapeVisits];

        INSERT INTO #VehiclesLookup
        ( VehicleKey, HostID )
        SELECT
          dvh.VehicleKey,
          dvh.HostID
        FROM
          [MiXData].dbo.DIM_Vehicles dvh  WITH (NOLOCK)
        WHERE dvh.OrganisationKey = @organisationKey;

        INSERT INTO #ShapesLookup
        ( ShapeKey )
        SELECT
          ds.ShapeKey
        FROM
          [MiXData].dbo.DIM_Shapes ds  WITH (NOLOCK)
        WHERE
            ds.OrganisationKey = @organisationKey
        AND ds.IsDeleted       = 0;

        -- get GeoLocations for new Shapes
        INSERT INTO #activityEndGeoLocation
        ( EndGeoLocationKey, EndShapeKey )
        SELECT DISTINCT
          dgls.GeoLocationKey,
          dgls.ShapeKey
        FROM
	        #ShapesLookup                          s
            INNER JOIN
          [MiXData].dbo.DIM_GeoLocationsToShapes dgls WITH (NOLOCK) ON dgls.ShapeKey = s.ShapeKey;

        CREATE CLUSTERED INDEX IX_activityEndGeoLocation ON #activityEndGeoLocation(EndGeoLocationKey,EndShapeKey);

        -- insert Organisation's records into STG
        INSERT INTO [StageControl].STAGE_FACT_ShapeVisits
        (
          VisitDateKey      ,
          ShapeKey          ,
          VehicleKey        ,
          DriverKey         ,
          UTCOffsetKey      ,
          IsDeleted         ,
          DurationAtLocation,
          NumberOfVisits
        )
        SELECT
          fad.ActivityStartDateKey,
          dsh.ShapeKey,
          fad.VehicleKey,
          fad.DriverKey,
          fad.UTCOffsetKey,
          fad.IsDeleted,
          DurationAtLocation = SUM(CASE 
                                     WHEN ABS(DATEDIFF(year,fad.MovementEndDateTime,fad.NextMovementStartDateTime)) < @maxDurationYears
                                      AND fad.MovementEndDateTime < fad.NextMovementStartDateTime
                                       THEN DATEDIFF(s,fad.MovementEndDateTime,fad.NextMovementStartDateTime)
                                     ELSE 0
                                   END),
          NumberOfVisits     = COUNT(DISTINCT fad.ActivityDetailKey)
        FROM
          #VehiclesLookup                           dvh
            INNER JOIN
          [MiXData].dbo.FACT_ActivityDetails     fad  WITH (NOLOCK) ON fad.VehicleKey           = dvh.VehicleKey
            INNER JOIN
          #activityEndGeoLocation                   dgls               ON dgls.EndGeoLocationKey   = fad.EndGeoLocationKey
            INNER JOIN
          #ShapesLookup                             dsh                ON dgls.EndShapeKey         = dsh.ShapeKey
        WHERE fad.HostID > 0
        GROUP BY
          fad.ActivityStartDateKey,
          dsh.ShapeKey,
          fad.VehicleKey,
          fad.DriverKey,
          fad.UTCOffsetKey,
          fad.[IsDeleted];

        -- remove IsDeleted records
        CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ShapeVisits_IsDeleted
          ON [StageControl].STAGE_FACT_ShapeVisits(IsDeleted);

        DELETE
          [StageControl].STAGE_FACT_ShapeVisits
        WHERE
          IsDeleted = 1;

        DROP INDEX IX_STAGE_FACT_ShapeVisits_IsDeleted
          ON [StageControl].STAGE_FACT_ShapeVisits;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
        END;

      --------------------------------------------------------------------
      -- 3. Update calculated columns onto STG
      --------------------------------------------------------------------

        CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey
          ON [StageControl].[STAGE_FACT_ShapeVisits](ShapeKey,VehicleKey,VisitDateKey);

      -------------------------------------
      -- 3.5 Calculate Unique Visits
      -- 3.5.1 Identify Duplicate ActivityShape rows
      INSERT INTO #DuplicateActivityShapes
      (
        VehicleKey                   ,
        DriverKey                    ,
        ActivityStartDateKey         ,
        ActivityDetailKey            ,
        NextMovementActivityDetailKey,
        EndShapeKey                  ,
        NMEndShapeKey
      )
      SELECT
        m.VehicleKey,
        m.DriverKey,
        m.ActivityStartDateKey,
        m.ActivityDetailKey,
        m.NextMovementActivityDetailKey,
        ge.EndShapeKey,
        NMEndShapeKey = gen.EndShapeKey
      FROM
        #VehiclesLookup                           dvh
          INNER JOIN
        [MiXData].dbo.FACT_ActivityDetails        m   WITH (NOLOCK) ON m.VehicleKey             = dvh.VehicleKey
          INNER JOIN
        #activityEndGeoLocation                   ge                ON m.EndGeoLocationKey      = ge.EndGeoLocationKey
          LEFT JOIN
        [MiXData].dbo.FACT_ActivityDetails        nm  WITH (NOLOCK) ON nm.VehicleKey                   = dvh.VehicleKey
                                                                   AND m.NextMovementActivityDetailKey = nm.ActivityDetailKey
                                                                   AND m.VehicleKey                    = nm.VehicleKey
                                                                   AND m.DriverKey                     = nm.DriverKey
          LEFT JOIN
        #activityEndGeoLocation gen                                 ON nm.EndGeoLocationKey            = gen.EndGeoLocationKey
      WHERE
        ge.EndShapeKey = gen.EndShapeKey;

      CREATE CLUSTERED INDEX IX_DuplicatedActivityShapes ON #DuplicateActivityShapes(ActivityDetailKey,EndShapeKey,ActivityStartDateKey);

      -- 3.5.2 De-duplicate ActivityShape rows
      INSERT INTO #DeDuplicatedActivityShapes
      (
        VehicleKey                   ,
        DriverKey                    ,
        ActivityStartDateKey         ,
        ActivityDetailKey            ,
        NextMovementActivityDetailKey,
        EndShapeKey                  ,
        NMEndShapeKey
      )
      SELECT
        VehicleKey                   ,
        DriverKey                    ,
        ActivityStartDateKey         ,
        ActivityDetailKey            ,
        NextMovementActivityDetailKey,
        EndShapeKey                  ,
        NMEndShapeKey
      FROM #DuplicateActivityShapes;

      CREATE CLUSTERED INDEX IX_DeDuplicatedActivityShapes ON #DeDuplicatedActivityShapes(ActivityDetailKey,EndShapeKey,ActivityStartDateKey);

      DELETE dd
      FROM
        #DeDuplicatedActivityShapes dd
      WHERE
        EXISTS (SELECT 1
                FROM #DeDuplicatedActivityShapes dd2
                WHERE
                    dd2.ActivityDetailKey    = dd.NextMovementActivityDetailKey
                AND dd2.EndShapeKey          = dd.EndShapeKey
                AND dd2.ActivityStartDateKey = dd.ActivityStartDateKey
                AND dd2.VehicleKey           = dd.VehicleKey
                AND dd2.DriverKey            = dd.DriverKey);

      -- 3.5.3 Identify Single ActivityShapeVisits
      INSERT INTO #DeDuplicatedActivityShapes
      (
        VehicleKey                   ,
        DriverKey                    ,
        ActivityStartDateKey         ,
        ActivityDetailKey            ,
        NextMovementActivityDetailKey,
        EndShapeKey
      )
      SELECT
        m.VehicleKey,
        m.DriverKey,
        m.ActivityStartDateKey,
        m.ActivityDetailKey,
        m.NextMovementActivityDetailKey,
        ge.EndShapeKey
      FROM
        #VehiclesLookup                           dvh
          INNER JOIN
        [MiXData].dbo.FACT_ActivityDetails        m   WITH (NOLOCK) ON m.VehicleKey             = dvh.VehicleKey
          INNER JOIN
        #activityEndGeoLocation                   ge                ON m.EndGeoLocationKey      = ge.EndGeoLocationKey
      WHERE
        NOT EXISTS (SELECT 1
                    FROM #DuplicateActivityShapes d
                    where 
                        d.VehicleKey           = m.VehicleKey
                    AND d.VehicleKey           = m.VehicleKey
                    AND d.ActivityStartDateKey = m.ActivityStartDateKey
                    AND d.EndShapeKey          = ge.EndShapeKey
                    AND d.ActivityDetailKey    = m.ActivityDetailKey)
      AND
        NOT EXISTS (SELECT 1
                    FROM #DuplicateActivityShapes d
                    WHERE
                        d.VehicleKey                    = m.VehicleKey
                    AND d.DriverKey                     = m.DriverKey
                    AND d.ActivityStartDateKey          = m.ActivityStartDateKey
                    AND d.NMEndShapeKey                 = ge.EndShapeKey
                    AND d.NextMovementActivityDetailKey = m.ActivityDetailKey);

      -- 3.5.4 Update Unique ShapeVisits
      ;WITH
      UniqueShapeVisits AS
      (
        SELECT
          dd.VehicleKey,
          dd.DriverKey,
          dd.ActivityStartDateKey,
          dd.EndShapeKey,
          NumberOfUniqueVisits = COUNT(1)
        FROM
          #DeDuplicatedActivityShapes dd
        GROUP BY
          dd.VehicleKey,
          dd.DriverKey,
          dd.ActivityStartDateKey,
          dd.EndShapeKey
      )
      UPDATE
        stg
      SET
        NumberOfUniqueVisits = CASE WHEN usv.NumberOfUniqueVisits > stg.NumberOfVisits THEN stg.NumberOfVisits ELSE usv.NumberOfUniqueVisits END
      FROM
        [StageControl].[STAGE_FACT_ShapeVisits] stg
          INNER JOIN
        UniqueShapeVisits                    usv ON usv.VehicleKey           = stg.VehicleKey
                                                AND usv.DriverKey            = stg.DriverKey
                                                AND usv.ActivityStartDateKey = stg.VisitDateKey
                                                AND usv.EndShapeKey          = stg.ShapeKey;

      --------------------------------------------------------------------
      -- 4. Validation before Loading to DW
      --------------------------------------------------------------------
     
        IF @debugMode = 1  -- DebugMode is true
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

      --------------------------------------------------------------------
      -- 5. MERGE to DW (Load) and add to RollBck
      --------------------------------------------------------------------
       
        -- just make sure that there are no existing records for this organisation
        IF EXISTS (SELECT 1 FROM [MiXData].dbo.FACT_ShapeVisits
                   WHERE OrganisationKey = @organisationKey)
          DELETE [MiXData].dbo.FACT_ShapeVisits
          WHERE OrganisationKey = @organisationKey;

        -- No Changed records, so no calculations necesarry

        -- insert new records to FACT
        INSERT INTO [MiXData].dbo.FACT_ShapeVisits
        (
          [OrganisationKey]   ,
          [VisitDateKey]      ,
          [ShapeKey]          ,
          [VehicleKey]        ,
          [DriverKey]         ,
          [DurationAtLocation],
          [NumberOfVisits]    ,
          NumberOfUniqueVisits,
          [UTCOffsetKey]      ,
          [CreateBatchKey]    ,
          [UpdateBatchKey]
        )
        SELECT
          @organisationKey    ,
          [VisitDateKey]      ,
          [ShapeKey]          ,
          [VehicleKey]        ,
          [DriverKey]         ,
          ISNULL([DurationAtLocation],0),
          ISNULL([NumberOfVisits]    ,0),
          ISNULL(NumberOfUniqueVisits,0),
          [UTCOffsetKey]      ,
          @batchKey           ,
          @batchKey
        FROM
          [StageControl].STAGE_FACT_ShapeVisits;        

        -- record number of records inserted
        SELECT @recordsInserted = @@ROWCOUNT;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
        END;

      --------------------------------------------------------------------
      -- 6. Cleanup work tables
      --------------------------------------------------------------------

      --------------------------------------------------------------------
      -- 7. Return values for Performance Monitoring
      --------------------------------------------------------------------

      IF @debugMode = 1  -- DebugMode is true
      BEGIN
        SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
      END;
      
      UPDATE [StageControl].[STAGE_FACT_ShapeVisits_Processed]
      SET Processed = 1, NrOfRecordsAffected = @nrOfRecordsAffected
      WHERE OrganisationKey = @organisationKey;
      
      SELECT @loopCounter = @loopCounter + 1;

    END; -- end while

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' END INITIAL - FACT_ShapeVisits';
      PRINT N'';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageControl].[sprFACT_SimpleScoreDailyInitial_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_SimpleScoreDaily on DW
-- ==============================================================================
/*
  Dependencies:

   DIM_SimpleScoreCriteria
   FACT_SimpleScoreDetails
   
   STAGE_FACT_SimpleScoreDetails

*/
CREATE PROCEDURE [StageControl].[sprFACT_SimpleScoreDailyInitial_Transform]
(
  @batchKey         int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int    = 0;
  DECLARE @maxDuration         bigint = 2147483647; -- this is the max int data type value

  -- used to loop through organisations
  DECLARE @organisationKey int = -1;
  DECLARE @loopCounter     int = 0;
  
  DECLARE	@currentDate     datetimeoffset = SYSUTCDATETIME(); -- used for validation

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE  [StageControl].[STAGE_FACT_SimpleScoreDaily_Processed]

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' START INITIAL - FACT_SimpleScoreDaily';
  END;

  -- populate list of organistions to be processed
  INSERT INTO [StageControl].[STAGE_FACT_SimpleScoreDaily_Processed]
  ( OrganisationKey, NrOfRecords, Processed )
  SELECT
    OrganisationKey, COUNT(1), 0
  FROM
    [MiXData].dbo.FACT_SimpleScoreDetails fad WITH (NOLOCK)
  GROUP BY OrganisationKey
  ORDER BY OrganisationKey;

  -- loop through list to be processed
  BEGIN TRY

    WHILE EXISTS (SELECT 1 FROM [StageControl].[STAGE_FACT_SimpleScoreDaily_Processed]
                  WHERE Processed = 0)
          AND (@loopCounter < 10000) -- make sure loop does end
    BEGIN

      SELECT @recordsInserted = 0,
             @recordsUpdated  = 0;
    
      -- get next Organisation to process
      SELECT
        @organisationKey = MIN(OrganisationKey)
      FROM
        [StageControl].[STAGE_FACT_SimpleScoreDaily_Processed]
      WHERE
        Processed = 0;

      --------------------------------------------------------------------
      -- 0. Make sure work tables are cleared
      --------------------------------------------------------------------
      TRUNCATE TABLE [StageControl].[STAGE_FACT_SimpleScoreDaily];

      IF @debugMode = 1  -- DebugMode is true
      BEGIN
        PRINT N'';
        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' ------------------------ OrganisationKey: ' + CONVERT(NVARCHAR(10),@organisationKey);
        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
      END;

      --------------------------------------------------------------------
      -- 1. Source Data Validation
      --------------------------------------------------------------------

      --------------------------------------------------------------------
      -- 2. Add to STG
      --------------------------------------------------------------------

        -- drop STAGE indexes before insert
        IF EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageControl].[STAGE_FACT_SimpleScoreDaily]') AND name = N'IX_STAGE_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey')
          DROP INDEX IX_STAGE_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey ON [StageControl].[STAGE_FACT_SimpleScoreDaily];

        IF EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageControl].[STAGE_FACT_SimpleScoreDaily]') AND name = N'IX_STAGE_FACT_SimpleScoreDaily_IsDeleted')
          DROP INDEX IX_STAGE_FACT_SimpleScoreDaily_IsDeleted ON [StageControl].[STAGE_FACT_SimpleScoreDaily];


        -- insert changed records into STG
	      INSERT INTO [StageControl].[STAGE_FACT_SimpleScoreDaily]
	      (
          [SnapShotDateKey]              ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [IsDeleted]                    ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScoreByDuration]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScoreByDuration]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScoreByDuration]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScoreByDuration]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScoreByDuration],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScoreByDuration]
	      )
	      SELECT
          fsd.[ActivityStartDateKey]          ,
          fsd.[DriverKey]                     ,
          fsd.[VehicleKey]                    ,
          fsd.[IsDeleted]                     ,
          SUM([DistanceTravelled])            ,
          SUM([DrivingTime])                  ,
          CASE
            WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
              THEN -1
            ELSE SUM(CONVERT(BIGINT,[Duration]))
          END,
          MAX([MaxSpeed])                     ,
          SUM([SpeedTime])                    ,
          SUM([SpeedOccurs])                  ,
          CASE 
            WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
              THEN 0
            WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
              THEN NULL
            ELSE SUM([SpeedScore]          * Duration)
          END,
          MAX([MaxBrake])                     ,
          SUM([BrakeTime])                    ,
          SUM([BrakeOccurs])                  ,
          CASE 
            WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
              THEN 0
            WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
              THEN NULL
            ELSE SUM([BrakeScore]          * Duration)
          END,
          MAX([MaxAccel])                     ,
          SUM([AccelTime])                    ,
          SUM([AccelOccurs])                  ,
          CASE 
            WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
              THEN 0
            WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
              THEN NULL
            ELSE SUM([AccelScore]          * Duration)
          END,
          MAX([MaxRPM])                       ,
          SUM([RPMTime])                      ,
          SUM([RPMOccurs])                    ,
          CASE 
            WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
              THEN 0
            WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
              THEN NULL
            ELSE SUM([RPMScore]            * Duration)
          END,
          SUM([OutOfGreenBandTime])           ,
          CASE 
            WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
              THEN 0
            WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
              THEN NULL
            ELSE SUM([OutOfGreenBandScore] * Duration)
          END,
          SUM([ExcessiveIdleOccurs])          ,
          SUM([ExcessiveIdleTime])            ,
          CASE 
            WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
              THEN 0
            WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
              THEN NULL
            ELSE SUM([ExcessiveIdleScore]  * Duration)
          END
	      FROM
	        [MiXData].dbo.DIM_Vehicles            dvh WITH (NOLOCK)
	          INNER JOIN
	        [MiXData].dbo.FACT_SimpleScoreDetails fsd WITH (NOLOCK) ON dvh.OrganisationKey = @organisationKey
	                                                                  AND fsd.VehicleKey      = dvh.VehicleKey
	      GROUP BY
	        fsd.[ActivityStartDateKey]         ,
          fsd.[DriverKey]                    ,
          fsd.[VehicleKey]                   ,
          fsd.[IsDeleted];

        -- remove IsDeleted records
        CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SimpleScoreDaily_IsDeleted
          ON [StageControl].STAGE_FACT_SimpleScoreDaily(IsDeleted);

        DELETE
          [StageControl].STAGE_FACT_SimpleScoreDaily
        WHERE
          IsDeleted = 1;

        DROP INDEX IX_STAGE_FACT_SimpleScoreDaily_IsDeleted
          ON [StageControl].STAGE_FACT_SimpleScoreDaily;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
        END;

      --------------------------------------------------------------------
      -- 3. Update calculated columns onto STG
      --------------------------------------------------------------------

        CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey
          ON [StageControl].[STAGE_FACT_SimpleScoreDaily](VehicleKey,DriverKey,SnapShotDateKey);

      --------------------------------------------------------------------
      -- 4. Validation before Loading to DW
      --------------------------------------------------------------------
     
      --------------------------------------------------------------------
      -- 5. MERGE to DW (Load) and add to RollBck
      --------------------------------------------------------------------

        -- just make sure that there are no existing records for this organisation
        IF EXISTS (SELECT 1 FROM [MiXData].dbo.FACT_SimpleScoreDaily
                   WHERE OrganisationKey = @organisationKey)
          DELETE [MiXData].dbo.FACT_SimpleScoreDaily
          WHERE OrganisationKey = @organisationKey;

        -- No Changed records, so no calculations necesarry


        -- insert new records to FACT
        INSERT INTO [MiXData].dbo.FACT_SimpleScoreDaily
        ( 
          [OrganisationKey]              ,
          [SnapShotDateKey]              ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScoreByDuration]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScoreByDuration]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScoreByDuration]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScoreByDuration]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScoreByDuration],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScoreByDuration] ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        )
        SELECT
          @organisationKey            ,
          [SnapShotDateKey]              ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScoreByDuration]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScoreByDuration]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScoreByDuration]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScoreByDuration]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScoreByDuration],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScoreByDuration] ,
          @batchKey                      ,
          @batchKey
        FROM
          [StageControl].[STAGE_FACT_SimpleScoreDaily]    AS stg;

        -- record number of records inserted
        SELECT @recordsInserted = @@ROWCOUNT;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
        END;
          
      --------------------------------------------------------------------
      -- 6. Cleanup work tables
      --------------------------------------------------------------------

      --------------------------------------------------------------------
      -- 7. Return values for Performance Monitoring
      --------------------------------------------------------------------

      IF @debugMode = 1  -- DebugMode is true
      BEGIN
        SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
      END;

      UPDATE [StageControl].[STAGE_FACT_SimpleScoreDaily_Processed]
      SET Processed = 1, NrOfRecordsAffected = @nrOfRecordsAffected
      WHERE OrganisationKey = @organisationKey;
      
      SELECT @loopCounter = @loopCounter + 1;

    END; -- end while

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' END INITIAL - FACT_SimpleScoreDaily';
      PRINT N'';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageControl].[sprFACT_SiteSnapshotDailyInitial_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_SiteSnapshotDaily on DW
-- ==============================================================================
/*
  Dependencies:

   FACT_ActivityDetails
   
   STAGE_FACT_ActivityDetails

*/
CREATE PROCEDURE [StageControl].[sprFACT_SiteSnapshotDailyInitial_Transform]
(
  @batchKey         int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;
  DECLARE @maxDuration         bigint = 2147483647; -- this is the max int data type value
  
  -- used to loop through organisations
  DECLARE @organisationKey int = -1;
  DECLARE @loopCounter     int = 0;

  DECLARE	@currentDate     datetimeoffset = SYSUTCDATETIME(); -- used for validation

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE  [StageControl].[STAGE_FACT_SiteSnapshotDaily_Processed]

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' START INITIAL - FACT_SiteSnapshotDaily';
  END;

  -- populate list of organistions to be processed
  INSERT INTO [StageControl].[STAGE_FACT_SiteSnapshotDaily_Processed]
  ( OrganisationKey, NrOfRecords, Processed )
  SELECT
    OrganisationKey, COUNT(1), 0
  FROM
    [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK)  
  GROUP BY OrganisationKey
  ORDER BY OrganisationKey;

  -- loop through list to be processed
  BEGIN TRY

    WHILE EXISTS (SELECT 1 FROM [StageControl].[STAGE_FACT_SiteSnapshotDaily_Processed]
                  WHERE Processed = 0)
          AND (@loopCounter < 10000) -- make sure loop does end
    BEGIN

      SELECT @recordsInserted = 0,
             @recordsUpdated  = 0;
    
      -- get next Organisation to process
      SELECT
        @organisationKey = MIN(OrganisationKey)
      FROM
        [StageControl].[STAGE_FACT_SiteSnapshotDaily_Processed]
      WHERE
        Processed = 0;

      --------------------------------------------------------------------
      -- 0. Make sure work tables are cleared
      --------------------------------------------------------------------
      TRUNCATE TABLE [StageControl].[STAGE_FACT_SiteSnapshotDaily];

      IF @debugMode = 1  -- DebugMode is true
      BEGIN
        PRINT N'';
        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' ------------------------ OrganisationKey: ' + CONVERT(NVARCHAR(10),@organisationKey);
        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
      END;

      --------------------------------------------------------------------
      -- 1. Source Data Validation
      --------------------------------------------------------------------

      --------------------------------------------------------------------
      -- 2. Add to STG
      --------------------------------------------------------------------

        -- drop STAGE indexes before insert
        IF EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageControl].[STAGE_FACT_SiteSnapshotDaily]') AND name = N'IX_STAGE_FACT_SiteSnapshotDaily_VehicleSiteKey_SnapShotDateKey')
          DROP INDEX IX_STAGE_FACT_SiteSnapshotDaily_VehicleSiteKey_SnapShotDateKey ON [StageControl].[STAGE_FACT_SiteSnapshotDaily];

        IF EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageControl].[STAGE_FACT_SiteSnapshotDaily]') AND name = N'IX_STAGE_FACT_SiteSnapshotDaily_IsDeleted')
          DROP INDEX IX_STAGE_FACT_SiteSnapshotDaily_IsDeleted ON [StageControl].[STAGE_FACT_SiteSnapshotDaily];

        -- insert Organisation's records into STG
	      INSERT INTO [StageControl].[STAGE_FACT_SiteSnapshotDaily]
	      (
          SnapShotDateKey   ,
          VehicleSiteKey    ,
          UTCOffsetKey      ,
          IsDeleted         ,

          VehiclesWithTrips ,
          DriversWithTrips  ,
          NumberOfTrips     ,
          NumberOfKMs       ,
          NumberOfHours     ,
          FuelUsedMeasured  ,
          FuelUsedCalculated,
          TotalIdlingTime
	      )
	      SELECT
          fad.ActivityStartDateKey  ,
          fad.VehicleSiteKey        ,
          fad.UTCOffsetKey          ,
          fad.IsDeleted             ,

          COUNT(DISTINCT fad.VehicleKey),
          COUNT(DISTINCT fad.DriverKey) ,
          COUNT(1)                      ,
          SUM(fad.DistanceTravelled)    ,
          CASE WHEN ABS(SUM(CONVERT(BIGINT,fad.DrivingTime))) > @maxDuration THEN -2 ELSE SUM(CONVERT(BIGINT,fad.DrivingTime)) END,

          CASE WHEN SUM(FuelUsedMeasured)   > 99999.0 THEN 99999.0 ELSE SUM(FuelUsedMeasured)   END,
          CASE WHEN SUM(FuelUsedCalculated) > 99999.0 THEN 99999.0 ELSE SUM(FuelUsedCalculated) END,
          CASE WHEN ABS(SUM(CONVERT(BIGINT,fad.IdleTime)))    > @maxDuration THEN -2 ELSE SUM(CONVERT(BIGINT,fad.IdleTime))    END
	      FROM
	        [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK)
	      WHERE
	        fad.OrganisationKey = @organisationKey
	      GROUP BY
          fad.ActivityStartDateKey,
          fad.VehicleSiteKey      ,
          fad.UTCOffsetKey        ,
          fad.IsDeleted;

        -- remove IsDeleted records
        CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SiteSnapshotDaily_IsDeleted
          ON [StageControl].[STAGE_FACT_SiteSnapshotDaily](IsDeleted);

        DELETE
          [StageControl].[STAGE_FACT_SiteSnapshotDaily]
        WHERE
          IsDeleted = 1;

        DROP INDEX IX_STAGE_FACT_SiteSnapshotDaily_IsDeleted
          ON [StageControl].[STAGE_FACT_SiteSnapshotDaily];

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
        END;

      --------------------------------------------------------------------
      -- 3. Update calculated columns onto STG
      --------------------------------------------------------------------

        CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SiteSnapshotDaily_VehicleSiteKey_SnapShotDateKey
          ON [StageControl].[STAGE_FACT_SiteSnapshotDaily](VehicleSiteKey,SnapShotDateKey);

        ------------------------------------------
        -- NumberOfCollisions
        UPDATE stg
        SET NumberOfCollisions = (SELECT COUNT(* )
                                  FROM [MiXData].dbo.DIM_Sites ds WITH (NOLOCK)
                                         INNER JOIN
                                       [MiXData].dbo.DIM_Vehicles          dvh WITH (NOLOCK) ON ds.SiteGUID         = dvh.SiteGUID
                                                                                            AND ds.OrganisationKey  = @organisationKey
                                         INNER JOIN
                                       [MiXData].dbo.DIM_EventDescriptions ded WITH (NOLOCK) ON ded.OrganisationKey = ds.OrganisationKey
                                                                                            AND ded.HostID BETWEEN 49 AND 50
                                         INNER JOIN
                                       [MiXData].dbo.FACT_EventDetails     fed WITH (NOLOCK) ON ded.EventDescriptionKey = fed.EventDescriptionKey
                                                                                            AND dvh.VehicleKey          = fed.VehicleKey
                                  WHERE  
                                      ds.SiteKey            = stg.VehicleSiteKey
                                  AND fed.EventStartDateKey = stg.SnapShotDateKey)
        FROM [StageControl].STAGE_FACT_SiteSnapshotDaily stg;

        ------------------------------------------
        -- NumberOfActiveVehicles/NumberOfActiveDrivers
        UPDATE [StageControl].STAGE_FACT_SiteSnapshotDaily
        SET
          NumberOfActiveVehicles = (SELECT COUNT(DISTINCT dvh.VehicleKey)
                                    FROM 
                                      [MiXData].dbo.DIM_Vehicles dvh WITH (NOLOCK)
                                        INNER JOIN
                                      [MiXData].dbo.DIM_Sites    ds  WITH (NOLOCK) ON dvh.OrganisationKey = @organisationKey
                                                                                     AND dvh.SiteGUID        = ds.SiteGUID
                                    WHERE 
                                        dvh.IsActive        = 1
                                    AND stg.VehicleSiteKey  = ds.SiteKey
                                    AND stg.SnapShotDateKey BETWEEN dvh.StartDateKey AND dvh.EndDateKey),
          NumberOfActiveDrivers  = (SELECT COUNT(DISTINCT dd.DriverKey)
                                    FROM 
                                      [MiXData].dbo.DIM_Drivers dd WITH (NOLOCK)
                                        INNER JOIN
                                      [MiXData].dbo.DIM_Sites   ds WITH (NOLOCK) ON dd.OrganisationKey = @organisationKey
                                                                                   AND dd.SiteGUID        = ds.SiteGUID
                                    WHERE 
                                        dd.IsActive         = 1
                                    AND stg.VehicleSiteKey  = ds.SiteKey
                                    AND stg.SnapShotDateKey BETWEEN dd.StartDateKey AND dd.EndDateKey)
        FROM
          [StageControl].STAGE_FACT_SiteSnapshotDaily stg;

        ------------------------------------------
        -- VehicleUtilization/DriverUtilization
        UPDATE [StageControl].STAGE_FACT_SiteSnapshotDaily
        SET
          VehicleUtilization = CASE
                                 WHEN NumberOfActiveVehicles > 0
                                   THEN VehiclesWithTrips/CONVERT(FLOAT,NumberOfActiveVehicles)
                                 ELSE 0.0
                               END,
          DriverUtilization  =  CASE
                                 WHEN NumberOfActiveDrivers  > 0
                                   THEN VehiclesWithTrips/CONVERT(FLOAT,NumberOfActiveDrivers)
                                 ELSE 0.0
                               END;

        SELECT @nrOfrecordsAffected = @@ROWCOUNT;

      --------------------------------------------------------------------
      -- 4. Validation before Loading to DW
      --------------------------------------------------------------------
     

      --------------------------------------------------------------------
      -- 5. MERGE to DW (Load) and add to RollBck
      --------------------------------------------------------------------
       
        -- just make sure that there are no existing records for this organisation
        IF EXISTS (SELECT 1 FROM [MiXData].dbo.FACT_SiteSnapshotDaily
                   WHERE OrganisationKey = @organisationKey)
          DELETE [MiXData].dbo.FACT_SiteSnapshotDaily
          WHERE OrganisationKey = @organisationKey;

        -- No Changed records, so no calculations necesarry

        -- insert new records to FACT
        INSERT INTO [MiXData].dbo.FACT_SiteSnapshotDaily
        ( 
          OrganisationKey   ,
          SnapShotDateKey   ,
          VehicleSiteKey    ,
          VehiclesWithTrips ,
          DriversWithTrips  ,
          NumberOfTrips     ,
          NumberOfCollisions ,
          NumberOfKMs       ,
          NumberOfHours     ,
          FuelUsedMeasured  ,
          FuelUsedCalculated,
          TotalIdlingTime   ,
          NumberOfActiveVehicles,
          NumberOfActiveDrivers, 
          VehicleUtilization,    
          DriverUtilization ,    
          UTCOffsetKey      ,
          CreateBatchKey    ,
          UpdateBatchKey
        )
        SELECT
          @organisationKey  ,
          SnapShotDateKey   ,
          VehicleSiteKey    ,
          VehiclesWithTrips ,
          DriversWithTrips  ,
          NumberOfTrips     ,
          ISNULL(NumberOfCollisions,0),
          NumberOfKMs       ,
          NumberOfHours     ,
          FuelUsedMeasured  ,
          FuelUsedCalculated,
          TotalIdlingTime   ,
          ISNULL(NumberOfActiveVehicles,0),
          ISNULL(NumberOfActiveDrivers,0),
          VehicleUtilization,    
          DriverUtilization ,    
          UTCOffsetKey      ,
          @batchKey         ,
          @batchKey
        FROM
          [StageControl].[STAGE_FACT_SiteSnapshotDaily];

        -- record number of records inserted
        SELECT @recordsInserted = @@ROWCOUNT;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
        END;

      --------------------------------------------------------------------
      -- 6. Cleanup work tables
      --------------------------------------------------------------------

      --------------------------------------------------------------------
      -- 7. Return values for Performance Monitoring
      --------------------------------------------------------------------

      IF @debugMode = 1  -- DebugMode is true
      BEGIN
        SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
      END;
      
      UPDATE [StageControl].[STAGE_FACT_SiteSnapshotDaily_Processed]
      SET Processed = 1, NrOfRecordsAffected = @nrOfRecordsAffected
      WHERE OrganisationKey = @organisationKey;
      
      SELECT @loopCounter = @loopCounter + 1;

    END; -- end while

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' END INITIAL - FACT_SiteSnapshotDaily';
      PRINT N'';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageControl].[sprInitialRun_UpateKeys]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageControl].[sprInitialRun_UpateKeys]
(
  @batchKey int,
  @debugMode bit = 0
) AS
BEGIN

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE @endDateDefault     date = '20501231';

  DECLARE @nrOfrecordsAffected int; 
  DECLARE @organisationKey     int = -1;
  DECLARE @loopCounter         int = 10000; -- restricted to this many iterations before exiting the loop


--  TRUNCATE TABLE [StageControl].STAGE_InitialRun_UpdateKeys_Processed;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;
  
  --INSERT INTO [StageControl].STAGE_InitialRun_UpdateKeys_Processed
  --( OrganisationKey, Processed )
  --SELECT DISTINCT
  --  OrganisationKey,
  --  0
  --FROM
  --  [$(MiXData)].dbo.[FACT_EventDetails];
  
  BEGIN TRY
    WHILE EXISTS (SELECT 1 FROM [StageControl].STAGE_InitialRun_UpdateKeys_Processed
                  WHERE Processed = 0)
          AND @loopCounter > 0
    BEGIN

      -- get next available organisation to process
      SELECT
        @organisationKey = MAX(OrganisationKey)
      FROM [StageControl].STAGE_InitialRun_UpdateKeys_Processed
      WHERE Processed = 0;

      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 1. Start UpdateKeys Organisation: ' + CONVERT(NVARCHAR(20),@organisationKey);

      -- FACT_TerminalDetails
      ------------------------------------------
      -- ActivityDetailKey/DriverKey
      -- disabled for initial run
      UPDATE
        [MiXData].dbo.[FACT_TerminalDetails]
      SET
        ActivityDetailKey   = fad.[ActivityDetailKey],
        DriverKey           = fad.[DriverKey]
      FROM
        [MiXData].dbo.DIM_Vehicles           dvht WITH (NOLOCK)
          INNER JOIN
        [MiXData].dbo.[FACT_TerminalDetails] stg  WITH (NOLOCK) ON dvht.OrganisationKey = @organisationKey
                                                               AND stg.VehicleKey       = dvht.VehicleKey
          INNER JOIN
        [MiXData].dbo.DIM_Vehicles           dvha WITH (NOLOCK) ON dvha.OrganisationKey = @organisationKey
                                                               AND dvha.HostID          = dvht.HostID
          INNER JOIN
        [MiXData].dbo.FACT_ActivityDetails    fad WITH (NOLOCK) ON fad.VehicleKey       = dvha.VehicleKey
      WHERE
        stg.[TerminalDateTime] BETWEEN fad.ActivityStartDateTime AND fad.ActivityEndDateTime;

      SELECT @nrOfrecordsAffected = @@ROWCOUNT;
      IF @debugMode = 1  -- DebugMode is true
      BEGIN
        EXEC [Control].strProcProgressMonitor_Set
          @flag='1.1 Update FACT_TerminalDetails.ActivityDetailKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;

        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.1 Update FACT_TerminalDetails for Organisation: ' + CONVERT(NVARCHAR(20),@organisationKey);
      END;

      -- FACT_EventDetails
      ------------------------------------------
      -- ActivityDetailKey 
      -- enable after initial run
      UPDATE [MiXData].dbo.[FACT_EventDetails]
      SET
        [ActivityDetailKey] = fad.[ActivityDetailKey]
      FROM
        [MiXData].dbo.DIM_Vehicles         dvha WITH (NOLOCK)
          INNER JOIN
        [MiXData].dbo.FACT_ActivityDetails fad  WITH (NOLOCK) ON dvha.OrganisationKey = @organisationKey
                                                             AND fad.VehicleKey       = dvha.VehicleKey
          INNER JOIN
        [MiXData].dbo.DIM_Vehicles         dvhe WITH (NOLOCK) ON dvhe.OrganisationKey = @organisationKey
                                                             AND dvhe.HostID          = dvha.HostID
          INNER JOIN
        [MiXData].dbo.[FACT_EventDetails]  stg                ON stg.VehicleKey       = dvhe.VehicleKey
      WHERE
          stg.EventStartDateTime IS NOT NULL
      AND stg.EventStartDateTime BETWEEN fad.ActivityStartDateTime AND fad.ActivityEndDateTime;

      SELECT @nrOfrecordsAffected = @@ROWCOUNT;
      IF @debugMode = 1  -- DebugMode is true
      BEGIN
        EXEC [Control].strProcProgressMonitor_Set
          @flag='1.2 Update FACT_EventDetails.ActivityDetailKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
        PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.2 Update FACT_EventDetails for Organisation: ' + CONVERT(NVARCHAR(20),@organisationKey);
      END;

      UPDATE [StageControl].STAGE_InitialRun_UpdateKeys_Processed
      SET Processed = 1
      WHERE OrganisationKey = @organisationKey;

      SELECT @loopCounter = @loopCounter - 1
      
    END; -- end while

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser].[sprDeviceParam_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move DeviceParam records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprDeviceParam_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  
  
  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].DeviceParam_CT  AS tar
      USING [StageUser].DeviceParam AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate        = stg.ChangeDate       ,
            tar.Operation         = stg.Operation        ,
            tar.UpdateMask        = stg.UpdateMask       ,
            tar.ChangeVersion     = stg.ChangeVersion    ,
            tar.liDeviceID        = stg.liDeviceID       ,
            tar.iParameterID      = stg.iParameterID     ,
            tar.bDeviceDefault    = stg.bDeviceDefault   ,
            tar.bParamDefault     = stg.bParamDefault    ,
            tar.ucCalibrationType = stg.ucCalibrationType,
            tar.lfCalibration1    = stg.lfCalibration1   ,
            tar.lfValue1          = stg.lfValue1         ,
            tar.lfCalibration2    = stg.lfCalibration2   ,
            tar.lfValue2          = stg.lfValue2         ,
            tar.UpdateBatchKey    = @batchKey,
            tar.sUserName         = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey   ,
            HostRID          ,
            ChangeDate       ,
            Operation        ,
            UpdateMask       ,
            ChangeVersion    ,
            liDeviceID       ,
            iParameterID     ,
            bDeviceDefault   ,
            bParamDefault    ,
            ucCalibrationType,
            lfCalibration1   ,
            lfValue1         ,
            lfCalibration2   ,
            lfValue2         ,
            CreateBatchKey   ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey     ,
            stg.RID              ,
            stg.ChangeDate       ,
            stg.Operation        ,
            stg.UpdateMask       ,
            stg.ChangeVersion    ,
            stg.liDeviceID       ,
            stg.iParameterID     ,
            stg.bDeviceDefault   ,
            stg.bParamDefault    ,
            stg.ucCalibrationType,
            stg.lfCalibration1   ,
            stg.lfValue1         ,
            stg.lfCalibration2   ,
            stg.lfValue2         ,
            @batchKey            ,
            @batchKey,
            stg.sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDevices_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move Devices records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprDevices_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Devices_CT  AS tar
      USING [StageUser].Devices AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate         = stg.ChangeDate        ,
            tar.Operation          = stg.Operation         ,
            tar.UpdateMask         = stg.UpdateMask        ,
            tar.ChangeVersion      = stg.ChangeVersion     ,
            tar.liDeviceID         = stg.liDeviceID        ,
            tar.sDescription       = stg.sDescription      ,
            tar.sSystemName        = stg.sSystemName       ,
            tar.ucDeviceType       = stg.ucDeviceType      ,
            tar.bCanRecordInterval = stg.bCanRecordInterval,
            tar.sReportProgID      = stg.sReportProgID     ,
            tar.UpdateBatchKey     = @batchKey,
            tar.sUserName          = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey   ,
            HostRID           ,
            ChangeDate        ,
            Operation         ,
            UpdateMask        ,
            ChangeVersion     ,
            liDeviceID        ,
            sDescription      ,
            sSystemName       ,
            ucDeviceType      ,
            bCanRecordInterval,
            sReportProgID     ,
            CreateBatchKey    ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey      ,
            stg.RID               ,
            stg.ChangeDate        ,
            stg.Operation         ,
            stg.UpdateMask        ,
            stg.ChangeVersion     ,
            stg.liDeviceID        ,
            stg.sDescription      ,
            stg.sSystemName       ,
            stg.ucDeviceType      ,
            stg.bCanRecordInterval,
            stg.sReportProgID     ,
            @batchKey             ,
            @batchKey,
            stg.sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_CalibrationParameters_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_CalibrationParameters on DW (details of Parameters)
--
--  Dependencies:
--    none
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_CalibrationParameters_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
) AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  int = 0;
  DECLARE @recordsUpdated   int = 0;
  DECLARE @recordsDeleted   int = 0;

  DECLARE @merge            table
  (
    Operation                     char (6)          NOT NULL,
    ParameterKey                  int               NOT NULL,
    OrganisationKey               int               NULL,
    HostID                        smallint          NOT NULL,
    Description                   nvarchar (200)    NULL,
    Units                         nvarchar (20)     NULL,
    ValueFormat                   tinyint           NULL,
    IsFuelCounter                 bit               NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].STAGE_DIM_CalibrationParameters;
  TRUNCATE TABLE [StageUser].[ROLLBACK_DIM_CalibrationParameters];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY
    
    ;WITH LatestParams (RID) AS
    (
      SELECT
        MAX(RID)
      FROM [StageUser].Param d WITH (NOLOCK)
      GROUP BY
        iParameterID
    )
    INSERT INTO [StageUser].STAGE_DIM_CalibrationParameters
    (
      HostID,
      Description,
      Units,
      ValueFormat,
      IsFuelCounter
    )
    SELECT
      d.iParameterID,
      d.sDescription,
      d.sUnits,
      CASE
        WHEN d.iParameterID IN (1, 31047, 31301) THEN  -- Speed
          200
        WHEN d.iParameterID IN (10003, 10004, 21001, 31198, 31199, 31252, 31253) THEN -- Distance (Km)
          201
        WHEN d.iParameterID IN (31049, 31100) THEN -- Distance (m)
          202
        WHEN d.bFuelCounter = 1 THEN -- Fuel Quantity (l)
          203
        WHEN d.iParameterID IN (5, 14, 21003, 21004, 31173, 31174, 31175, 31176, 31177) THEN -- Temperature (C)
          204
        WHEN d.iParameterID IN (31205, 31206, 31207, 31208, 31209, 31210, 31211, 31212, 31213, 31214, 31215, 31216) THEN -- Weight (tonnes)
          205
        WHEN d.iParameterID IN (31258) THEN -- Weight (Kg)
          206
        WHEN d.iParameterID IN (31017, 31018) THEN  -- Acceleration/Deceleration
          207
        ELSE
          d.ucValueFormat
      END,
      d.bFuelCounter
    FROM
      LatestParams      l
        INNER JOIN
      [StageUser].Param d WITH (NOLOCK) ON d.RID = l.RID
    WHERE
      d.bSystem = 0;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  --BEGIN TRY

    --------------------------------------------

    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'3. Update calculated columns onto STG';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError @organisationKey = @organisationKey;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  --BEGIN TRY


    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'4. Validation before Loading to DW';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError @organisationKey = @organisationKey;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    MERGE [MiXData].[dbo].DIM_CalibrationParameters tar
      USING [StageUser].STAGE_DIM_CalibrationParameters stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostID          = stg.HostID
      WHEN MATCHED THEN
        UPDATE
        SET tar.Description   = stg.Description,
            tar.Units         = stg.Units,
            tar.ValueFormat   = stg.ValueFormat,
            tar.IsFuelCounter = stg.IsFuelCounter
      WHEN NOT MATCHED THEN
        INSERT
        (
          OrganisationKey,
          HostID,
          Description,
          Units,
          ValueFormat,
          IsFuelCounter,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.HostID,
          stg.Description,
          stg.Units,
          stg.ValueFormat,
          stg.IsFuelCounter,
          @batchKey,
          @batchKey
        )
      OUTPUT
        $action Operation,
        ISNULL(DELETED.ParameterKey, INSERTED.ParameterKey),
        DELETED.OrganisationKey,
        ISNULL(DELETED.HostID, INSERTED.HostID),
        DELETED.Description,
        DELETED.Units,
        DELETED.ValueFormat,
        DELETED.IsFuelCounter,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
        INTO @merge;

    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merge
    WHERE
      Operation = 'INSERT';

    -- Add to RollBck table
    INSERT INTO [StageUser].ROLLBACK_DIM_CalibrationParameters
    (
      ParameterKey,
      OrganisationKey,
      HostID,
      Description,
      Units,
      ValueFormat,
      IsFuelCounter
    )
    SELECT
      ParameterKey,
      OrganisationKey,
      HostID,
      Description,
      Units,
      ValueFormat,
      IsFuelCounter
    FROM
     @merge
    WHERE
      Operation = 'UPDATE';
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].STAGE_DIM_CalibrationParameters;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    0                     RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_Certifications_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_Certifications on DW (details of sites)
--
--  Dependencies:
--
--    DIM_TableColumnLookups
--    DIM_Drivers
--
--    DriverLicences
--    DriverCertifications
--    Drivers
--    Vehicles
--    DriverCertifications
--    Certifications
--
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_Certifications_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int = 0;
  DECLARE @recordsUpdated  int = 0;
  DECLARE @recordsDeleted  int = 0;
  DECLARE @nrOfrecordsAffected int = 0;
  
  DECLARE @driverCertificatesLookupRID int; -- special merge for this type of certification required (combination of liCertificationID and iDriverID)

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_DIM_Certifications];
  TRUNCATE TABLE [StageUser].[ROLLBACK_DIM_Certifications];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_DIM_Certifications]') AND name = N'IX_STAGE_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID')
      DROP INDEX IX_STAGE_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID ON [StageUser].[STAGE_DIM_Certifications];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_DIM_Certifications]') AND name = N'IX_ROLLBACK_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID')  
      DROP INDEX IX_ROLLBACK_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID ON [StageUser].[ROLLBACK_DIM_Certifications];  

    -- get for later use
    SELECT @driverCertificatesLookupRID = l.LookupRID
    FROM
      [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	      l.LookupTable  = 'DIM_Certifications'
	  AND l.LookupColumn = 'CertificationTypeLookupKey'
	  AND l.LookupKey    = 6; -- Driver Certificates

    -- insert into STAGE table
	  ;WITH 
	    LatestDriverLicences (MaxRID) AS
	      (SELECT
	         MaxRID = MAX(RID)
	       FROM
	         [StageUser].DriverLicences
	       GROUP BY
	         iDriverID,
	         liLicenceID),
	    LatestDriverCertifications (MaxRID) AS
	      (SELECT
	         MaxRID = MAX(RID)
	       FROM
	         [StageUser].DriverCertifications
	       GROUP BY
	         iDriverID,
	         liCertificationID),
	    LatestDrivers (MaxRID) AS
	      (SELECT
	         MaxRID = MAX(RID)
	       FROM
	         [StageUser].Drivers
	       GROUP BY
	         iDriverID),
	    LatestVehicles (MaxRID) AS
	      (SELECT
	         MaxRID = MAX(RID)
	       FROM
	         [StageUser].Vehicles
	       GROUP BY
	         iVehicleID)  -- end WITH
	  INSERT INTO [StageUser].[STAGE_DIM_Certifications]
	  (
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays]
	  )
    SELECT
      [ChangeDate]                 = d.ChangeDate            ,
      [HostID]                     = d.iDriverID             ,
      [DriverGUID]                 = d.DriverGUID            ,
      [TrailerGUID]                = NULL                    ,
      [VehicleGUID]                = NULL                    ,
      [CertificationTypeLookupKey] = l.LookupRID             , -- Driver License
      [CertificationDescription]   = NULL                    ,
      [ExpirationDateKey]          = d.dtNextLicense         ,
      [ObtainedDateKey]            = d.dtLastLicense         ,
      [LastRenewalDateKey]         = NULL                    ,
      [CertificationDurationDays]  = d.ucLicenseInterval * 30,
      [CertificationReminderDays]  = d.ucLicenseRemind   * 30
    FROM
      LatestDrivers       lstd
        INNER JOIN
      [StageUser].Drivers d   ON d.RID = lstd.MaxRID
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	      l.LookupTable  = 'DIM_Certifications'
	  AND l.LookupColumn = 'CertificationTypeLookupKey'
	  AND l.LookupKey    = 1 -- Driver License
    UNION
    SELECT
      [ChangeDate]                 = vl.ChangeDate            ,
      [HostID]                     = vl.iVehicleID            ,
      [DriverGUID]                 = NULL                     ,
      [TrailerGUID]                = NULL                     ,
      [VehicleGUID]                = vl.VehicleGUID           ,
      [CertificationTypeLookupKey] = l.LookupRID              , -- Vehicle License
      [CertificationDescription]   = NULL                     ,
      [ExpirationDateKey]          = vl.dtNextLicense         ,
      [ObtainedDateKey]            = vl.dtLastLicense         ,
      [LastRenewalDateKey]         = NULL                     ,
      [CertificationDurationDays]  = vl.ucLicenseInterval * 30,
      [CertificationReminderDays]  = vl.ucLicenseRemind   * 30
    FROM
      LatestVehicles       lstv
        INNER JOIN
      [StageUser].Vehicles vl  ON vl.RID = lstv.MaxRID
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	      l.LookupTable  = 'DIM_Certifications'
	  AND l.LookupColumn = 'CertificationTypeLookupKey'
	  AND l.LookupKey    = 2 -- Vehicle License
    UNION
    SELECT
      [ChangeDate]                 = vrc.ChangeDate        ,
      [HostID]                     = vrc.iVehicleID        ,
      [DriverGUID]                 = NULL                  ,
      [TrailerGUID]                = NULL                  ,
      [VehicleGUID]                = vrc.VehicleGUID       ,
      [CertificationTypeLookupKey] = l.LookupRID           , -- Roadworthy Certificate
      [CertificationDescription]   = NULL                  ,
      [ExpirationDateKey]          = vrc.dtNextCOR         ,
      [ObtainedDateKey]            = vrc.dtLastCOR         ,
      [LastRenewalDateKey]         = NULL                  ,
      [CertificationDurationDays]  = vrc.ucCORInterval * 30,
      [CertificationReminderDays]  = vrc.ucCORRemind   * 30
    FROM
      LatestVehicles       lstrc
        INNER JOIN
      [StageUser].Vehicles vrc ON vrc.RID = lstrc.MaxRID
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	      l.LookupTable  = 'DIM_Certifications'
	  AND l.LookupColumn = 'CertificationTypeLookupKey'
	  AND l.LookupKey    = 3 -- Roadworthy Certificate
    UNION
    SELECT
      dl.ChangeDate                                        ,
      [HostID]                     = dl.RID                ,
      dd.DriverGUID                                        ,
      [TrailerGUID]                = NULL                  ,
      [VehicleGUID]                = NULL                  ,
      [CertificationTypeLookupKey] = l.LookupRID           , -- Driver License Codes
      [CertificationDescription]   = dlc.sLicenceCode      ,
      [ExpirationDateKey]          = dl.dtExpires          ,
      [ObtainedDateKey]            = dl.dtObtained         ,
      [LastRenewalDateKey]         = NULL                  ,
      [CertificationDurationDays]  = dlc.iExpiryMonths * 30,
      [CertificationReminderDays]  = dlc.iRemindWeeks  * 7
    FROM
      LatestDriverLicences           lstdl
        INNER JOIN
      [StageUser].DriverLicences     dl                 ON dl.RID              = lstdl.MaxRID
        LEFT OUTER JOIN
      [StageUser].DriverLicenceCodes dlc                ON dl.liLicenceID      = dlc.liLicenceID
        LEFT OUTER JOIN
      [MiXData].dbo.DIM_Drivers     dd WITH (NOLOCK) ON dd.OrganisationKey = @organisationKey
                                                       AND dl.iDriverID       = dd.HostID
                                                       AND dd.IsCurrentRecord = 1
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	      l.LookupTable  = 'DIM_Certifications'
	  AND l.LookupColumn = 'CertificationTypeLookupKey'
	  AND l.LookupKey    = 5 -- Driver License Codes
    UNION
    SELECT
      [ChangeDate]                 = dc.ChangeDate         ,
      [HostID]                     = dc.liCertificationID  ,
      [DriverGUID]                 = dd.DriverGUID         ,
      [TrailerGUID]                = NULL                  ,
      [VehicleGUID]                = NULL                  ,
      [CertificationTypeLookupKey] = l.LookupRID           , -- Driver Certificates
      [CertificationDescription]   = c.sDescription        ,
      [ExpirationDateKey]          = DATEADD(MONTH,c.iValidMonths,dc.dtObtained),
      [ObtainedDateKey]            = dc.dtObtained         ,
      [LastRenewalDateKey]         = NULL                  ,
      [CertificationDurationDays]  = c.iValidMonths    * 30,
      [CertificationReminderDays]  = 0
    FROM
      LatestDriverCertifications       lstdc
        INNER JOIN
      [StageUser].DriverCertifications dc               ON dc.RID               = lstdc.MaxRID
        LEFT OUTER JOIN
      [StageUser].Certifications       c                ON dc.liCertificationID = c.liCertificationID
        LEFT OUTER JOIN
      [MiXData].dbo.DIM_Drivers     dd WITH (NOLOCK) ON dd.OrganisationKey   = @organisationKey
                                                       AND dc.iDriverID         = dd.HostID
                                                       AND dd.IsCurrentRecord   = 1
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	      l.LookupTable  = 'DIM_Certifications'
	  AND l.LookupColumn = 'CertificationTypeLookupKey'
	  AND l.LookupKey    = 6; -- Driver Certificates

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create STAGE indexes
    CREATE INDEX IX_STAGE_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID
      ON [StageUser].[STAGE_DIM_Certifications](HostID,CertificationTypeLookupKey,DriverGUID)
      INCLUDE(ExpirationDateKey,ObtainedDateKey);

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- update DriverCertifications only
    --   requires special merge because combination of liCertificationID and iDriverID makes record unique
    INSERT INTO [StageUser].[ROLLBACK_DIM_Certifications]
    ( 
      [CertificationKey]          ,
      [OrganisationKey]           ,
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays] ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    )
    SELECT
      [CertificationKey]          ,
      [OrganisationKey]           ,
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays] ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET tar.[CertificationDescription]  = stg.[CertificationDescription] ,
          tar.[ExpirationDateKey]         = stg.[ExpirationDateKey]        ,
          tar.[ObtainedDateKey]           = stg.[ObtainedDateKey]          ,
          tar.[LastRenewalDateKey]        = stg.[LastRenewalDateKey]       ,
          tar.[CertificationDurationDays] = stg.[CertificationDurationDays],
          tar.[CertificationReminderDays] = stg.[CertificationReminderDays],
          tar.[UTCOffsetKey]              = stg.[UTCOffsetKey]             ,
          tar.UpdateBatchKey              = @batchKey
      OUTPUT
        DELETED.[CertificationKey]          ,
        DELETED.[OrganisationKey]           ,
        DELETED.[ChangeDate]                ,
        DELETED.[HostID]                    ,
        DELETED.[DriverGUID]                ,
        DELETED.[TrailerGUID]               ,
        DELETED.[VehicleGUID]               ,
        DELETED.[CertificationTypeLookupKey],
        DELETED.[CertificationDescription]  ,
        DELETED.[ExpirationDateKey]         ,
        DELETED.[ObtainedDateKey]           ,
        DELETED.[LastRenewalDateKey]        ,
        DELETED.[CertificationDurationDays] ,
        DELETED.[CertificationReminderDays] ,
        DELETED.[UTCOffsetKey]              ,
        DELETED.[CreateBatchKey]            ,
        DELETED.[UpdateBatchKey]
      FROM
        [StageUser].[STAGE_DIM_Certifications] AS stg
          INNER JOIN
        [MiXData].dbo.DIM_Certifications    AS tar ON tar.OrganisationKey              = @organisationKey
                                                     AND tar.[HostID]                     = stg.[HostID]
                                                     AND tar.DriverGUID                   = stg.DriverGUID   -- additional lookup column
                                                     AND tar.[CertificationTypeLookupKey] = stg.[CertificationTypeLookupKey]
      WHERE
           stg.[CertificationTypeLookupKey] = @driverCertificatesLookupRID
      AND  (tar.[ExpirationDateKey]         = stg.[ExpirationDateKey]
       OR   tar.[ObtainedDateKey]           = stg.[ObtainedDateKey])
      ) AS upd;

    SELECT @recordsUpdated = ISNULL(@@ROWCOUNT,0);

    -- update all but DriverCertifications
    INSERT INTO [StageUser].[ROLLBACK_DIM_Certifications]
    ( 
      [CertificationKey]          ,
      [OrganisationKey]           ,
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays] ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    )
    SELECT
      [CertificationKey]          ,
      [OrganisationKey]           ,
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays] ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET tar.[CertificationDescription]  = stg.[CertificationDescription] ,
          tar.[ExpirationDateKey]         = stg.[ExpirationDateKey]        ,
          tar.[ObtainedDateKey]           = stg.[ObtainedDateKey]          ,
          tar.[LastRenewalDateKey]        = stg.[LastRenewalDateKey]       ,
          tar.[CertificationDurationDays] = stg.[CertificationDurationDays],
          tar.[CertificationReminderDays] = stg.[CertificationReminderDays],
          tar.[UTCOffsetKey]              = stg.[UTCOffsetKey]             ,
          tar.UpdateBatchKey              = @batchKey
      OUTPUT
        DELETED.[CertificationKey]          ,
        DELETED.[OrganisationKey]           ,
        DELETED.[ChangeDate]                ,
        DELETED.[HostID]                    ,
        DELETED.[DriverGUID]                ,
        DELETED.[TrailerGUID]               ,
        DELETED.[VehicleGUID]               ,
        DELETED.[CertificationTypeLookupKey],
        DELETED.[CertificationDescription]  ,
        DELETED.[ExpirationDateKey]         ,
        DELETED.[ObtainedDateKey]           ,
        DELETED.[LastRenewalDateKey]        ,
        DELETED.[CertificationDurationDays] ,
        DELETED.[CertificationReminderDays] ,
        DELETED.[UTCOffsetKey]              ,
        DELETED.[CreateBatchKey]            ,
        DELETED.[UpdateBatchKey]
      FROM
        [StageUser].[STAGE_DIM_Certifications] AS stg
          INNER JOIN
        [MiXData].dbo.DIM_Certifications    AS tar ON tar.OrganisationKey              = @organisationKey
                                                     AND tar.[HostID]                     = stg.[HostID]
                                                     AND tar.[CertificationTypeLookupKey] = stg.[CertificationTypeLookupKey]
      WHERE
           stg.[CertificationTypeLookupKey] <> @driverCertificatesLookupRID
      AND  (tar.[ExpirationDateKey]         = stg.[ExpirationDateKey]
       OR   tar.[ObtainedDateKey]           = stg.[ObtainedDateKey])
      ) AS upd;

    SELECT @recordsUpdated = @recordsUpdated + ISNULL(@@ROWCOUNT,0);

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;  
    END;  

    -- drop ROLLBACK indexes before insert
    CREATE INDEX IX_ROLLBACK_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID
      ON [StageUser].[ROLLBACK_DIM_Certifications](HostID,CertificationTypeLookupKey,DriverGUID)
      INCLUDE(ExpirationDateKey,ObtainedDateKey);

    -- insert brand new records
    INSERT INTO [MiXData].dbo.DIM_Certifications
    ( 
      [OrganisationKey]           ,
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays] ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey                ,
      stg.[ChangeDate]                ,
      stg.[HostID]                    ,
      stg.[DriverGUID]                ,
      stg.[TrailerGUID]               ,
      stg.[VehicleGUID]               ,
      stg.[CertificationTypeLookupKey],
      stg.[CertificationDescription]  ,
      stg.[ExpirationDateKey]         ,
      stg.[ObtainedDateKey]           ,
      stg.[LastRenewalDateKey]        ,
      stg.[CertificationDurationDays] ,
      stg.[CertificationReminderDays] ,
      stg.[UTCOffsetKey]              ,
      @batchKey                 ,
      @batchKey
    FROM
      [StageUser].[STAGE_DIM_Certifications] AS stg
    WHERE
      NOT EXISTS (SELECT 1
                  FROM
                    [StageUser].[STAGE_DIM_Certifications] AS roll WITH (NOLOCK)
                  WHERE
                     (stg.[CertificationTypeLookupKey] <> @driverCertificatesLookupRID
                  AND stg.HostID                       = roll.HostID)
                  OR (stg.[CertificationTypeLookupKey] = @driverCertificatesLookupRID
                  AND stg.HostID                       = roll.HostID
                  AND stg.DriverGUID                   = roll.DriverGUID));

    SELECT @recordsInserted = ISNULL(@@ROWCOUNT,0);

    -- insert changed values
    INSERT INTO [MiXData].dbo.DIM_Certifications
    ( 
      [OrganisationKey]           ,
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays] ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey                ,
      stg.[ChangeDate]                ,
      stg.[HostID]                    ,
      stg.[DriverGUID]                ,
      stg.[TrailerGUID]               ,
      stg.[VehicleGUID]               ,
      stg.[CertificationTypeLookupKey],
      stg.[CertificationDescription]  ,
      stg.[ExpirationDateKey]         ,
      stg.[ObtainedDateKey]           ,
      stg.[LastRenewalDateKey]        ,
      stg.[CertificationDurationDays] ,
      stg.[CertificationReminderDays] ,
      stg.[UTCOffsetKey]              ,
      @batchKey                        ,
      @batchKey
    FROM
      [StageUser].[STAGE_DIM_Certifications] AS stg
        INNER JOIN
      [MiXData].dbo.DIM_Certifications     AS tar ON  tar.OrganisationKey              = @organisationKey
                                                     AND tar.[HostID]                     = stg.[HostID]
                                                     AND tar.[CertificationTypeLookupKey] = stg.[CertificationTypeLookupKey]
    WHERE 
        (stg.[CertificationTypeLookupKey] <> @driverCertificatesLookupRID
    OR   stg.[CertificationTypeLookupKey] =  @driverCertificatesLookupRID 
    AND  tar.DriverGUID = stg.DriverGUID)
    AND NOT
        (tar.[ExpirationDateKey] = stg.[ExpirationDateKey] 
    OR   tar.[ObtainedDateKey]   = stg.[ObtainedDateKey]);
    
    SELECT @recordsInserted = @recordsInserted + ISNULL(@@ROWCOUNT,0);
    
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.2 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_DIM_Certifications];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated + @recordsDeleted;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_Devices_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_Devices on DW (details of Devices)
--
--  Dependencies:
--    none
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_Devices_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
) AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  int = 0;
  DECLARE @recordsUpdated   int = 0;
  DECLARE @recordsDeleted   int = 0;

  DECLARE @merge            table
  (
    Operation                     char (6)          NOT NULL,
    DeviceKey                     int               NOT NULL,
    OrganisationKey               int               NULL,
    HostID                        int               NOT NULL,
    DeviceType                    nvarchar (50)     NULL,
    DeviceName                    nvarchar (200)    NULL,
    SystemName                    nvarchar (255)    NULL,
    ReportProgID                  nvarchar (200)    NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].STAGE_DIM_Devices;
  TRUNCATE TABLE [StageUser].ROLLBACK_DIM_Devices;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    ;WITH LatestDevice (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser].Devices WITH (NOLOCK)
      GROUP BY
        liDeviceID
    )
    INSERT INTO [StageUser].STAGE_DIM_Devices
    (
      HostID,
      DeviceType,
      DeviceName,
      SystemName,
      ReportProgID
    )
    SELECT
      d.liDeviceID,
      d.ucDeviceType,
      d.sDescription,
      d.sSystemName,
      d.sReportProgID
    FROM
      [StageUser].Devices d WITH (NOLOCK)
      INNER JOIN LatestDevice l ON d.RID = l.MaxRID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  --BEGIN TRY

    --------------------------------------------

    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'3. Update calculated columns onto STG';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError @organisationKey = @organisationKey;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  --BEGIN TRY


    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'4. Validation before Loading to DW';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError @organisationKey = @organisationKey;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    MERGE [MiXData].[dbo].DIM_Devices tar
      USING [StageUser].STAGE_DIM_Devices stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostID          = stg.HostID
      WHEN MATCHED THEN
        UPDATE
        SET
          tar.DeviceType      = stg.DeviceType,
          tar.DeviceName      = stg.DeviceName,
          tar.SystemName      = stg.SystemName,
          tar.ReportProgID    = stg.ReportProgID,
          tar.UpdateBatchKey  = @batchKey
      WHEN NOT MATCHED THEN
        INSERT
        (
          OrganisationKey,
          HostID,
          DeviceType,
          DeviceName,
          SystemName,
          ReportProgID,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.HostID,
          stg.DeviceType,
          stg.DeviceName,
          stg.SystemName,
          stg.ReportProgID,
          @batchKey,
          @batchKey
        )
      OUTPUT
        $action   AS Operation,
        ISNULL(DELETED.DeviceKey, INSERTED.DeviceKey),
        DELETED.OrganisationKey,
        ISNULL(DELETED.HostID, INSERTED.HostID),
        DELETED.DeviceType,
        DELETED.DeviceName,
        DELETED.SystemName,
        DELETED.ReportProgID,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
        INTO @merge;

    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merge
    WHERE
      Operation = 'INSERT';

    -- Add to RollBck table
    INSERT INTO [StageUser].ROLLBACK_DIM_Devices
    (
      DeviceKey,
      OrganisationKey,
      HostID,
      DeviceType,
      DeviceName,
      SystemName,
      ReportProgID,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      DeviceKey,
      OrganisationKey,
      HostID,
      DeviceType,
      DeviceName,
      SystemName,
      ReportProgID,
      CreateBatchKey,
      UpdateBatchKey
    FROM
      @merge
    WHERE
      Operation = 'UPDATE';
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].STAGE_DIM_Devices;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    0                     RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_Drivers_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_Drivers on DW (details of drivers)
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_Drivers_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
) AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey           int;
  DECLARE @UTCOffsetMinutes       smallint;
  DECLARE @maxAuditDate           datetimeoffset (0);
  DECLARE @startDate              datetimeoffset (0);
  DECLARE @tmpDate                datetimeoffset (0);
  DECLARE @endDate                datetimeoffset (0);
  DECLARE @startDateKey           date;
  DECLARE @previousEndDateKey     date;

  -- Default values
  DECLARE @startDateFirstInsert   date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @endDateDefault         date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)

  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                     nvarchar (10)     NOT NULL,
    DriverKey                     int               NOT NULL,
    StartDateKey                  date              NULL,
    EndDateKey                    date              NULL,
    IsCurrentRecord               bit               NULL,
    OrganisationKey               int               NULL,
    HostID                        int               NULL,
    DriverGUID                    uniqueidentifier  NULL,
    IsActive                      bit               NULL,
    SiteGUID                      uniqueidentifier  NULL,
    SiteKey                       int               NULL,
    DriverName                    nvarchar (255)    NULL,
    DriverEmployeeNumber          nvarchar (255)    NULL,
    DriverExtendedID              varchar (32)      NULL,
    ConfigurationGroupName        nvarchar (255)    NULL,
    UTCOffsetKey                  int               NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );
  DECLARE @type2Keys table
  (
    DriverKey                     int NOT NULL,
    HostID                        int NOT NULL
  );

  -- Get range for which SCD should be calculated
  SELECT
    @startDate     = MIN(ChangeDate),
    @maxAuditDate  = MAX(ChangeDate)
  FROM
    [StageUser].Drivers;

  TRUNCATE TABLE [StageUser].ROLLBACK_DIM_Drivers;

  -- Loop through calculation a day at a time and Load to DW
  WHILE @StartDate <= @MaxAuditDate
    BEGIN
    -- get timezone infomation
      SELECT
        @UTCOffsetKey     = UTCOffsetKey,
        @UTCOffsetMinutes = UTCOffsetMinutes,
        @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
      FROM
        [StageUser].STAGE_DIM_UTCOffsetsLookUp
      WHERE
        @startDate     BETWEEN StartDateTime       AND EndDateTime
        AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

      SET @startDateKey       = CONVERT(date, @tmpDate);
    -- get the UTC time for the start of the next day in organisation's timezone
      SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
      SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
      TRUNCATE TABLE [StageUser].STAGE_DIM_Drivers;

      IF @debugMode = 1  -- DebugMode is true
        PRINT N'0. Make sure work tables are cleared for processing from ' + CONVERT(nvarchar, @startDate, 0) + ' to ' + CONVERT(nvarchar, @endDate, 0);

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------


  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
      BEGIN TRY

        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser].Drivers WITH (NOLOCK)
          WHERE
            ChangeDate      >= @startDate
            AND ChangeDate  <  @endDate
          GROUP BY
            iDriverID
        )
        INSERT INTO [StageUser].STAGE_DIM_Drivers
        (
          DriverHostID,
          DriverGUID,
          DriverName,
          DriverEmployeeNumber,
          DriverExtendedID,
          SiteHostID,
          ConfigurationGroupName,
          IsActive
        )
        SELECT
          s.iDriverID,
          s.DriverGUID,
          s.sName,
          s.sEmployeeNumber,
          s.sExtendedID,
          s.liSiteID,
          g.sName,
          IsActive = CASE
                       WHEN s.Operation = 'D' THEN
                         0
                       ELSE
                         1
                     END
        FROM
          Latest l
          INNER JOIN [StageUser].Drivers s      WITH (NOLOCK) ON l.RID       = s.RID
          LEFT  JOIN [StageUser].DriverConfig g WITH (NOLOCK) ON s.liGroupID = g.liGroupID;
        SET @rowcount = @@ROWCOUNT;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
      BEGIN TRY

    ------------------------------------------
    -- SiteGUID
        UPDATE
          [StageUser].STAGE_DIM_Drivers
        SET
          SiteGUID = ds.SiteGUID,
          SiteKey  = ds.SiteKey
        FROM
          [StageUser].STAGE_DIM_Drivers stg
          INNER JOIN [MiXData].[dbo].DIM_Sites ds WITH (NOLOCK) ON @organisationKey = ds.OrganisationKey
                                                                  AND stg.SiteHostID    = ds.HostID;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'3. Update calculated columns onto STG';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
      --BEGIN TRY

        --IF @debugMode = 1  -- DebugMode is true
          --PRINT N'4. Validation before Loading to DW';

      --END TRY
      ---- CATCH Errors
      --BEGIN CATCH
        --EXEC [Control].sprLogError @organisationKey = @organisationKey;
        --RETURN -1;
      --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBack (Type 2)
  --------------------------------------------------------------------
      BEGIN TRY

        DELETE @merged;
        MERGE INTO [MiXData].[dbo].DIM_Drivers tar
          USING [StageUser].STAGE_DIM_Drivers stg
             ON tar.OrganisationKey = @organisationKey
            AND tar.HostID          = stg.DriverHostID
        -- Matched and DW IsCurrent record (then just update)
          WHEN MATCHED
            AND tar.StartDateKey = @StartDateKey
            AND tar.EndDateKey   = @endDateDefault
            THEN UPDATE
            SET
              tar.IsActive             = stg.IsActive,
              tar.SiteGUID             = ISNULL(stg.SiteGUID,'00000000-0000-0000-0000-000000000000'),
              tar.SiteKey              = ISNULL(stg.SiteKey,-1),
              tar.DriverName           = stg.DriverName,
              tar.DriverEmployeeNumber = stg.DriverEmployeeNumber,
              tar.DriverExtendedID     = stg.DriverExtendedID,
              tar.DriverGUID           = stg.DriverGUID,
              tar.UpdateBatchKey       = @batchKey
        -- Not Matched -> insert new record into DW
          WHEN NOT MATCHED
            THEN INSERT
            (
              StartDateKey,
              EndDateKey,
              IsCurrentRecord,
              HostID,
              IsActive,
              DriverGUID,
              OrganisationKey,
              SiteGUID,
              SiteKey,
              DriverName,
              DriverEmployeeNumber,
              DriverExtendedID,
              ConfigurationGroupName,
              UTCOffsetKey,
              CreateBatchKey,
              UpdateBatchKey
            )
            VALUES
            (
              @startDateFirstInsert,
              @endDateDefault,
              1,
              stg.DriverHostID,
              stg.IsActive,
              stg.DriverGUID,
              @organisationKey,
              ISNULL(stg.SiteGUID,'00000000-0000-0000-0000-000000000000'),
              ISNULL(stg.SiteKey,-1),
              stg.DriverName,
              stg.DriverEmployeeNumber,
              stg.DriverExtendedID,
              stg.ConfigurationGroupName,
              @UTCOffsetKey,
              @batchKey,
              @batchKey
            )
          OUTPUT
            $action   AS Operation,
            ISNULL(DELETED.DriverKey, INSERTED.DriverKey),
            DELETED.StartDateKey,
            DELETED.EndDateKey,
            DELETED.IsCurrentRecord,
            ISNULL(DELETED.HostID, INSERTED.HostID),
            DELETED.IsActive,
            ISNULL(DELETED.DriverGUID, INSERTED.DriverGUID),
            DELETED.OrganisationKey,
            DELETED.SiteGUID,
            DELETED.SiteKey,
            DELETED.DriverName,
            DELETED.DriverEmployeeNumber,
            DELETED.DriverExtendedID,
            DELETED.ConfigurationGroupName,
            DELETED.UTCOffsetKey,
            DELETED.CreateBatchKey,
            DELETED.UpdateBatchKey
            INTO @merged;
        SET @rowcount = @@ROWCOUNT;
        SELECT
          @recordsInserted += COUNT(*)
        FROM
          @merged
        WHERE
          Operation = 'INSERT'
        
        INSERT INTO [StageUser].ROLLBACK_DIM_Drivers
        (
          DriverKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          HostID,
          IsActive,
          DriverGUID,
          OrganisationKey,
          SiteGUID,
          SiteKey,
          DriverName,
          DriverEmployeeNumber,
          DriverExtendedID,
          ConfigurationGroupName,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        SELECT
          DriverKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          HostID,
          IsActive,
          DriverGUID,
          OrganisationKey,
          SiteGUID,
          SiteKey,
          DriverName,
          DriverEmployeeNumber,
          DriverExtendedID,
          ConfigurationGroupName,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        FROM
          @merged
        WHERE
          Operation          = 'UPDATE'
          AND UpdateBatchKey < @batchKey;
        SET @recordsUpdated += @@ROWCOUNT;
        
       IF @debugMode = 1
          PRINT '    after merge: rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

  --------------------------------------------------------------------
      -- type 2 changes -> first expire current
        DELETE @type2Keys;
        INSERT INTO @type2Keys
        SELECT
          tar.DriverKey,
          tar.HostID
        FROM
          [MiXData].[dbo].DIM_Drivers tar
          INNER JOIN [StageUser].STAGE_DIM_Drivers stg ON tar.OrganisationKey = @organisationKey
                                                      AND tar.HostID          = stg.DriverHostID
        WHERE
          tar.StartDateKey      < @StartDateKey
          AND  tar.EndDateKey   = @endDateDefault
          AND CHECKSUM
              (
                tar.SiteGUID            ,
                tar.DriverName          ,
                tar.DriverEmployeeNumber,
                tar.DriverExtendedID    ,
                tar.IsActive            ,
                tar.DriverGUID
              )
              <>
              CHECKSUM
              (
                CONVERT(uniqueidentifier,ISNULL(stg.SiteGUID,'00000000-0000-0000-0000-000000000000')),
                stg.DriverName,
                stg.DriverEmployeeNumber,
                stg.DriverExtendedID,
                stg.IsActive,
                stg.DriverGUID
              );
        SET @rowcount = @@ROWCOUNT;

        INSERT INTO [StageUser].ROLLBACK_DIM_Drivers
        (
          DriverKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          HostID,
          IsActive,
          DriverGUID,
          OrganisationKey,
          SiteGUID,
          SiteKey,
          DriverName,
          DriverEmployeeNumber,
          DriverExtendedID,
          ConfigurationGroupName,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        SELECT
          DriverKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          HostID,
          IsActive,
          DriverGUID,
          OrganisationKey,
          SiteGUID,
          SiteKey,
          DriverName,
          DriverEmployeeNumber,
          DriverExtendedID,
          ConfigurationGroupName,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        FROM
         (UPDATE
            [MiXData].[dbo].DIM_Drivers
          SET
            EndDateKey      = @previousEndDateKey,
            IsCurrentRecord = 0,
            UpdateBatchKey  = @batchKey
          OUTPUT
            DELETED.DriverKey,
            DELETED.StartDateKey,
            DELETED.EndDateKey,
            DELETED.IsCurrentRecord,
            DELETED.HostID,
            DELETED.IsActive,
            DELETED.DriverGUID,
            DELETED.OrganisationKey,
            DELETED.SiteGUID,
            DELETED.SiteKey,
            DELETED.DriverName,
            DELETED.DriverEmployeeNumber,
            DELETED.DriverExtendedID,
            DELETED.ConfigurationGroupName,
            DELETED.UTCOffsetKey,
            DELETED.CreateBatchKey,
            DELETED.UpdateBatchKey
          FROM
            [MiXData].[dbo].DIM_Drivers tar
            INNER JOIN @type2Keys k ON tar.DriverKey = k.DriverKey
          ) AS RollBck              -- end update
        WHERE
          UpdateBatchKey < @batchKey; -- end insert

        -- Insert new Records for Type 2 changes
        INSERT INTO [MiXData].[dbo].DIM_Drivers
        (
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          HostID,
          IsActive,
          DriverGUID,
          OrganisationKey,
          SiteGUID,
          SiteKey,
          DriverName,
          DriverEmployeeNumber,
          DriverExtendedID,
          ConfigurationGroupName,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        SELECT
          @startDateKey,
          @endDateDefault,
          1,
          stg.DriverHostID,
          stg.IsActive,
          stg.DriverGUID,
          @organisationKey,
          ISNULL(stg.SiteGUID,'00000000-0000-0000-0000-000000000000'),
          ISNULL(stg.SiteKey,-1),
          stg.DriverName,
          stg.DriverEmployeeNumber,
          stg.DriverExtendedID,
          stg.ConfigurationGroupName,
          @UTCOffsetKey,
          @batchKey,
          @batchKey
        FROM
          [StageUser].STAGE_DIM_Drivers stg
          INNER JOIN @type2Keys k ON stg.DriverHostID = k.HostID;
        SET @recordsType2Inserted += @@ROWCOUNT;

        IF @debugMode = 1
          PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  -- next day to process:
      SELECT
        @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
      FROM
        [StageUser].Drivers
      WHERE
        ChangeDate >= @endDate;

    END -- END WHILE

  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------
  BEGIN TRY

    -- only need to stage keys and type1 columns
    TRUNCATE TABLE [StageUser].STAGE_DIM_Drivers;
    ;WITH Latest (RID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser].Drivers WITH (NOLOCK)
      GROUP BY
        iDriverID
    )
    INSERT INTO [StageUser].STAGE_DIM_Drivers
    (
      DriverHostID,
      ConfigurationGroupName
    )
    SELECT
      s.iDriverID,
      g.sName
    FROM
      Latest l
      INNER JOIN [StageUser].Drivers s      WITH (NOLOCK) ON l.RID       = s.RID
      LEFT  JOIN [StageUser].DriverConfig g WITH (NOLOCK) ON s.liGroupID = g.liGroupID;

    INSERT INTO [StageUser].ROLLBACK_DIM_Drivers
    (
      DriverKey,
      StartDateKey,
      EndDateKey,
      IsCurrentRecord,
      HostID,
      IsActive,
      DriverGUID,
      OrganisationKey,
      SiteGUID,
      SiteKey,
      DriverName,
      DriverEmployeeNumber,
      DriverExtendedID,
      ConfigurationGroupName,
      UTCOffsetKey,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      DriverKey,
      StartDateKey,
      EndDateKey,
      IsCurrentRecord,
      HostID,
      IsActive,
      DriverGUID,
      OrganisationKey,
      SiteGUID,
      SiteKey,
      DriverName,
      DriverEmployeeNumber,
      DriverExtendedID,
      ConfigurationGroupName,
      UTCOffsetKey,
      CreateBatchKey,
      UpdateBatchKey
    FROM
     (
      UPDATE
        [MiXData].[dbo].DIM_Drivers
      SET
        ConfigurationGroupName = stg.ConfigurationGroupName
      OUTPUT
        DELETED.DriverKey,
        DELETED.StartDateKey,
        DELETED.EndDateKey,
        DELETED.IsCurrentRecord,
        DELETED.HostID,
        DELETED.IsActive,
        DELETED.DriverGUID,
        DELETED.OrganisationKey,
        DELETED.SiteGUID,
        DELETED.SiteKey,
        DELETED.DriverName,
        DELETED.DriverEmployeeNumber,
        DELETED.DriverExtendedID,
        DELETED.ConfigurationGroupName,
        DELETED.UTCOffsetKey,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
      FROM
        [MiXData].[dbo].DIM_Drivers tar
        INNER JOIN [StageUser].STAGE_DIM_Drivers stg ON tar.OrganisationKey = @organisationKey
                                                    AND tar.HostID          = stg.DriverHostID
      WHERE
        tar.ConfigurationGroupName <> stg.ConfigurationGroupName
     ) rllbck
    WHERE
      UpdateBatchKey < @batchKey;
    SET @recordsUpdated += @@ROWCOUNT;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Update Type 1 columns on DW';

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    BEGIN
      TRUNCATE TABLE [StageUser].STAGE_DIM_Drivers;
    END;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_EventDescriptions_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_EventDescriptions on DW (contains all the event descriptions)
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_EventDescriptions_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
) AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  int = 0;
  DECLARE @recordsUpdated   int = 0;
  DECLARE @recordsDeleted   int = 0;
  
  DECLARE @summaryMinLookupKey     int;
  DECLARE @summaryMaxLookupKey     int;
  DECLARE @summaryAverageLookupKey int;
  DECLARE @summaryLastLookupKey    int;
  
  DECLARE @merge            table
  (
    Operation                     char (6)          NOT NULL,
    EventDescriptionKey           int               NOT NULL,
    OrganisationKey               int               NULL,
    HostID                        int               NOT NULL,
    EventName                     nvarchar (255)    NULL,
    ParameterKey                  int               NULL,
    SummaryTypeLookupKey          int               NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  )
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].STAGE_DIM_EventDescriptions;
  TRUNCATE TABLE [StageUser].ROLLBACK_DIM_EventDescriptions;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY
  
    SELECT
      @summaryMinLookupKey     = tcl1.LookupRID,
      @summaryMaxLookupKey     = tcl2.LookupRID,
      @summaryAverageLookupKey = tcl3.LookupRID,
      @summaryLastLookupKey    = tcl4.LookupRID
    FROM
      [MiXData].dbo.DIM_TableColumnLookups tcl1 WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups tcl2 WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups tcl3 WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups tcl4 WITH (NOLOCK)
	  WHERE
	      tcl1.LookupTable  = 'DIM_EventDescriptions'
	  AND tcl1.LookupColumn = 'SummaryTypeLookupKey'
	  AND tcl1.LookupKey    = 1  -- Summary Min
	  AND tcl2.LookupTable  = 'DIM_EventDescriptions'
	  AND tcl2.LookupColumn = 'SummaryTypeLookupKey'
	  AND tcl2.LookupKey    = 2  -- Summary Max
	  AND tcl3.LookupTable  = 'DIM_EventDescriptions'
	  AND tcl3.LookupColumn = 'SummaryTypeLookupKey'
	  AND tcl3.LookupKey    = 3  -- Summary Average
	  AND tcl4.LookupTable  = 'DIM_EventDescriptions'
	  AND tcl4.LookupColumn = 'SummaryTypeLookupKey'
	  AND tcl4.LookupKey    = 4; -- Summary Last Reading

    -- insert existing event groups
    ;WITH LastRID (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser].EventDescription WITH (NOLOCK)
      GROUP BY
        iEventID
    )
    INSERT INTO [StageUser].STAGE_DIM_EventDescriptions
    (
      HostID,
      EventName,
      SummaryTypeLookupKey,
      SummaryID
    )
    SELECT
      s.iEventID,
      s.sDescription,
      CASE
        WHEN s.ucSummaryType = 0 THEN @summaryMinLookupKey
        WHEN s.ucSummaryType = 1 THEN @summaryMaxLookupKey
        WHEN s.ucSummaryType = 2 THEN @summaryAverageLookupKey
        WHEN s.ucSummaryType = 3 THEN @summaryLastLookupKey
        ELSE -1
      END,
      s.iSummaryID
    FROM
      [StageUser].EventDescription s WITH (NOLOCK)
      INNER JOIN LastRID lr ON s.RID = lr.MaxRID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- ParameterKey
    UPDATE
      [StageUser].STAGE_DIM_EventDescriptions
    SET
      ParameterKey = dcp.ParameterKey
    FROM
      [StageUser].STAGE_DIM_EventDescriptions    stg
        INNER JOIN
      [MiXData].dbo.DIM_CalibrationParameters dcp WITH (NOLOCK) ON dcp.OrganisationKey = @organisationKey
                                                                  AND dcp.HostID          = stg.SummaryID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  --BEGIN TRY

    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'4. Validation before Loading to DW';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError @organisationKey = @organisationKey;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    MERGE [MiXData].[dbo].DIM_EventDescriptions tar
      USING [StageUser].STAGE_DIM_EventDescriptions stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostID          = stg.HostID
      WHEN MATCHED THEN
        UPDATE
        SET
          tar.EventName            = stg.EventName           ,
          tar.ParameterKey         = ISNULL(stg.ParameterKey ,-1),
          tar.SummaryTypeLookupKey = stg.SummaryTypeLookupKey
      WHEN NOT MATCHED THEN
        INSERT
        ( 
          OrganisationKey,
          HostID,
          EventName,
          ParameterKey,
          SummaryTypeLookupKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.HostID,
          stg.EventName,
          ISNULL(stg.ParameterKey,-1),
          stg.SummaryTypeLookupKey,
          @batchKey,
          @batchKey
        )
      OUTPUT 
        $action   AS Operation, 
        ISNULL(DELETED.EventDescriptionKey, INSERTED.EventDescriptionKey),
        ISNULL(DELETED.OrganisationKey,INSERTED.OrganisationKey),
        ISNULL(DELETED.HostID, INSERTED.HostID),
        DELETED.EventName,
        DELETED.ParameterKey,
        DELETED.SummaryTypeLookupKey,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
      INTO @merge;

    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merge
    WHERE
      Operation = 'INSERT';

    -- Add to RollBck table
    INSERT INTO [StageUser].ROLLBACK_DIM_EventDescriptions
    ( 
      EventDescriptionKey,
      OrganisationKey,
      HostID,
      EventName,
      ParameterKey,
      SummaryTypeLookupKey,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      EventDescriptionKey,
      OrganisationKey,
      HostID,
      EventName,
      ParameterKey,
      SummaryTypeLookupKey,
      CreateBatchKey,
      UpdateBatchKey
    FROM
      @merge
    WHERE
      Operation = 'UPDATE'; -- end insert
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_DIM_EventDescriptions];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  
  SELECT
    @recordsInserted      RecordsInserted,
    0                     RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_EventGroups_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_EventGroups on DW (contains all the events and the groups they belong to)
--
--  Dependencies
--
--    DIM_EventDescriptions
--
-- ==============================================================================
CREATE PROC [StageUser].[sprDIM_EventGroups_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_DIM_EventGroups];
  TRUNCATE TABLE [StageUser].[ROLLBACK_DIM_EventGroups];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- insert existing event groups
    ;WITH
    LatestEventDescription AS
    (
      SELECT
        MaxRID = MAX(RID)
      FROM [StageUser].EventDescription s WITH (NOLOCK)
      GROUP BY
        iEventID
    )
	  INSERT INTO [StageUser].[STAGE_DIM_EventGroups]
	  (
	    EventID,
	    EventGroupnameLookupKey
	  )
	  SELECT
      s.iEventID,
      l.LookupRID
	  FROM
	    LatestEventDescription               lst
	      INNER JOIN
	    [StageUser].EventDescription         s WITH (NOLOCK) ON s.RID = lst.MaxRID
	      CROSS JOIN
	    [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	    s.iEventID    BETWEEN -32000 AND -30000
	  AND
	    l.LookupTable  = 'DIM_EventGroups'
	  AND
	    l.LookupColumn = 'EventGroupnameLookupKey'
	  AND
	    l.LookupKey     = 2 -- System
    UNION
	  SELECT
      s.iEventID,
      l.LookupRID
	  FROM
	    LatestEventDescription               lst
	      INNER JOIN
	    [StageUser].EventDescription         s WITH (NOLOCK) ON s.RID = lst.MaxRID
	      CROSS JOIN
	    [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	    s.iEventID    BETWEEN -29999 AND -1
	  AND
	    l.LookupTable  = 'DIM_EventGroups'
	  AND
	    l.LookupColumn = 'EventGroupnameLookupKey'
	  AND
	    l.LookupKey    = 3 -- User Defined
    UNION
	  SELECT
      s.iEventID,
      l.LookupRID
	  FROM
	    LatestEventDescription               lst
	      INNER JOIN
	    [StageUser].EventDescription         s WITH (NOLOCK) ON s.RID = lst.MaxRID
	      INNER JOIN
	    [Control].EventGroupLookups          g WITH (NOLOCK)
	      ON s.iEventID  = g.iEventID
	      INNER JOIN
	    [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	      ON l.LookupKey = g.EventGroupnameLookupKey
	  WHERE
	    l.LookupTable = 'DIM_EventGroups'
	  AND
	    LookupColumn  = 'EventGroupnameLookupKey';

    -- insert Undefined event groups
    ;WITH
    LatestEventDescription AS
    (
      SELECT
        MaxRID = MAX(RID)
      FROM [StageUser].EventDescription s WITH (NOLOCK)
      GROUP BY
        iEventID
    )
	  INSERT INTO [StageUser].[STAGE_DIM_EventGroups]
	  (
	    EventID,
	    EventGroupnameLookupKey
	  )
	  SELECT
      s.iEventID,
      l.LookupKey
	  FROM
	    LatestEventDescription               lst
	      INNER JOIN
	    [StageUser].EventDescription         s WITH (NOLOCK) ON s.RID = lst.MaxRID
	      CROSS JOIN
	    [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	    l.LookupTable  = 'DIM_EventGroups'
	  AND
	    l.LookupColumn = 'EventGroupnameLookupKey'
	  AND
	    l.LookupKey    = 1 -- Undefined
    AND
      NOT EXISTS (SELECT 1
                  FROM
                    [StageUser].[STAGE_DIM_EventGroups] stg
                  WHERE
                    stg.EventID = s.iEventID)


    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    UPDATE
      [StageUser].[STAGE_DIM_EventGroups]
    SET
      EventDescriptionKey = ded.EventDescriptionKey
    FROM
      [StageUser].STAGE_DIM_EventGroups  stg
        INNER JOIN
      [MiXData].dbo.DIM_EventDescriptions ded WITH (NOLOCK) 
        ON ded.OrganisationKey = @organisationKey
       AND ded.HostID          = stg.EventID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Add to RollBck table
    INSERT INTO [StageUser].[ROLLBACK_DIM_EventGroups]
    ( [EventGroupKey]          ,
      [OrganisationKey]        ,
      [EventGroupnameLookupKey],
      [EventDescriptionKey]    ,
      [CreateBatchKey]         ,
      [UpdateBatchKey]    )
    SELECT
      [EventGroupKey]          ,
      [OrganisationKey]        ,
      [EventGroupnameLookupKey],
      [EventDescriptionKey]    ,
      [CreateBatchKey]         ,
      [UpdateBatchKey]
    FROM 
     (MERGE [MiXData].dbo.DIM_EventGroups     AS tar
      USING [StageUser].[STAGE_DIM_EventGroups] AS stg
       ON  tar.OrganisationKey           = @organisationKey
       AND tar.[EventDescriptionKey]     = stg.[EventDescriptionKey]
       AND tar.[EventGroupnameLookupKey] = stg.[EventGroupnameLookupKey]
      --WHEN MATCHED
      --THEN
      -- Not Matched
      WHEN NOT MATCHED THEN
        INSERT
        ( 
          [OrganisationKey]        ,
          [EventGroupnameLookupKey],
          [EventDescriptionKey]    ,
          [CreateBatchKey]         ,
          [UpdateBatchKey]
        )
        VALUES
        (
          @organisationKey             ,
          stg.[EventGroupnameLookupKey],
          stg.[EventDescriptionKey]    ,
          @batchKey                     ,
          @batchKey
        )
      OUTPUT 
        $action   AS Operation, 
        DELETED.[EventGroupKey]          ,
        DELETED.[OrganisationKey]        ,
        DELETED.[EventGroupnameLookupKey],
        DELETED.[EventDescriptionKey]    ,
        DELETED.[CreateBatchKey]         ,
        DELETED.[UpdateBatchKey]
      ) AS RollBck              -- end merge
    WHERE
      Operation        = 'UPDATE'; -- end insert

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_DIM_EventGroups];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsUpdated = count(1)
  FROM
    [MiXData].dbo.DIM_EventGroups WITH (NOLOCK)
  WHERE
    OrganisationKey = @organisationKey
  AND
    UpdateBatchKey  = @batchKey;

  SELECT
    @recordsInserted = count(1)
  FROM
    [MiXData].dbo.DIM_EventGroups WITH (NOLOCK)
  WHERE
    OrganisationKey = @organisationKey
  AND
    CreateBatchKey  = @batchKey;
  
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = (isnull(@recordsUpdated,0) - isnull(@recordsInserted,0)),  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_GeoLocations_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_GeoLocations on DW (built from selected GPSData positions)
--
--  Dependencies:
--    none
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_GeoLocations_Transform]
(
  @batchKey           int,
  @organisationKey    int,
  @debugMode          int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
) AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted int = 0;
  DECLARE @recordsAffected int = 0;

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------

  TRUNCATE TABLE [StageUser].STAGE_DIM_GeoLocations;
  TRUNCATE TABLE [StageUser].STAGE_DIM_OrganisationsToGeoLocations

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfrecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create index on source
    IF NOT EXISTS(SELECT *
                  FROM [sys].indexes
                  WHERE object_id = OBJECT_ID(N'[StageUser].GPSData', 'U') AND name = 'IX_GPSData_fLongitude_fLatitude')
      BEGIN
        CREATE INDEX IX_GPSData_fLongitude_fLatitude ON [StageUser].GPSData
        (
          fLongitude,
          fLatitude
        ) WITH (FILLFACTOR = 100);
      END;

    -- drop indexes on STAGE
    IF EXISTS(SELECT *
              FROM [sys].indexes
              WHERE object_id = OBJECT_ID(N'[StageUser].STAGE_DIM_GeoLocations', N'U') AND name = 'IX_STAGE_DIM_GeoLocations_GeoLocationKey')
      BEGIN
        DROP INDEX IX_STAGE_DIM_GeoLocations_GeoLocationKey ON [StageUser].STAGE_DIM_GeoLocations;
      END;

    IF EXISTS(SELECT *
              FROM [sys].indexes
              WHERE object_id = OBJECT_ID(N'[StageUser].STAGE_DIM_GeoLocations', N'U') AND name = 'IX_STAGE_DIM_GeoLocations_Longitude_Latitude')
      BEGIN
        DROP INDEX IX_STAGE_DIM_GeoLocations_Longitude_Latitude ON [StageUser].STAGE_DIM_GeoLocations;
      END;

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].STAGE_DIM_OrganisationsToGeoLocations') AND name = N'IX_STAGE_DIM_OrganisationsToGeoLocations_LocationPoint')
      BEGIN
        DROP INDEX IX_STAGE_DIM_OrganisationsToGeoLocations_LocationPoint ON [StageUser].STAGE_DIM_OrganisationsToGeoLocations;
      END;

    -- insert into STAGE
    ;WITH NoteworthyPoints (HostID, Longitude, Latitude) AS
    (
      SELECT
        g.liGPSID,
        ROUND(g.fLongitude, 5),
        ROUND(g.fLatitude, 5)
      FROM
        [StageUser].[GPSData] g WITH (NOLOCK)
    )
    INSERT INTO [StageUser].STAGE_DIM_GeoLocations
    (HostID,   Longitude,   Latitude)
    SELECT
      n.HostID,
      n.Longitude,
      n.Latitude
    FROM
      NoteworthyPoints n;
    SELECT @recordsAffected = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
      BEGIN  
        EXEC [Control].strProcProgressMonitor_Set  
          @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfrecordsAffected=@recordsAffected;  
        PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2. Add to STG';  
      END;  

    DROP INDEX IX_GPSData_fLongitude_fLatitude ON [StageUser].GPSData;

    CREATE INDEX IX_STAGE_DIM_GeoLocations_Longitude_Latitude ON [StageUser].STAGE_DIM_GeoLocations
    (
      Longitude,
      Latitude
    ) WITH (FILLFACTOR = 100);

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.9 created indexes';  

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;

    SELECT
      @recordsInserted      RecordsInserted,
      0                     RecordsType2Inserted,
      0                     RecordsUpdated,
      0                     RecordsDeleted,
      ERROR_NUMBER()        ErrorCode;

    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. Insert to DW (Load)
  --------------------------------------------------------------------
  BEGIN TRY

    ;WITH
    distinctPoints (Longitude,Latitude) AS
    (
      SELECT DISTINCT
        stg.Longitude,
        stg.Latitude
      FROM
        [StageUser].STAGE_DIM_GeoLocations stg
    )
    INSERT INTO [MiXData].[dbo].DIM_GeoLocations
    (
      OrganisationKey,
      LocationPoint,
      Longitude,
      Latitude,
      StreetLevelName,
      GeographyKey,
      CreateBatchKey,
      UpdateBatchKey
    )
    OUTPUT
      INSERTED.GeoLocationKey,INSERTED.LocationPoint
    INTO [StageUser].STAGE_DIM_OrganisationsToGeoLocations
    SELECT
      @organisationKey,
      geography::Point(stg.Latitude, stg.Longitude, 4326),
      stg.Longitude,
      stg.Latitude,
      '',
      -1,
      @batchKey,
      @batchKey
    FROM
      distinctPoints stg
    WHERE
      NOT EXISTS (SELECT *
                  FROM
                    [MiXData].[dbo].DIM_GeoLocations tar
                  WHERE
                      tar.OrganisationKey = @organisationKey
                  AND tar.Longitude       = stg.Longitude
                  AND tar.Latitude        = stg.Latitude);
    SET @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfrecordsAffected=@recordsInserted;  
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 5.2 Inserted ' + CAST(@recordsInserted AS nvarchar)  + ' new geolocations';
    END;  

    UPDATE
      [StageUser].STAGE_DIM_GeoLocations
    SET
      GeoLocationKey = dim.GeoLocationKey
    FROM
      [StageUser].STAGE_DIM_GeoLocations  stg
        INNER JOIN
      [MiXData].[dbo].DIM_GeoLocations dim WITH (NOLOCK) ON dim.OrganisationKey = @organisationKey
                                                           AND stg.Longitude       = dim.Longitude
                                                           AND stg.Latitude        = dim.Latitude;
    SELECT @recordsAffected = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.3 Return GeoLocationKeys', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfrecordsAffected=@recordsAffected;  
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N': 5.3 Return GeoLocationKeys';
    END;

    CREATE NONCLUSTERED INDEX IX_STAGE_DIM_GeoLocations_GeoLocationKey
       ON [StageUser].STAGE_DIM_GeoLocations( GeoLocationKey ) WITH (FILLFACTOR = 100);

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;

    SELECT
      @recordsInserted      RecordsInserted,
      0                     RecordsType2Inserted,
      0                     RecordsUpdated,
      0                     RecordsDeleted,
      ERROR_NUMBER()        ErrorCode;

    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    0                     RecordsType2Inserted,
    0                     RecordsUpdated,
    0                     RecordsDeleted,
    0                     ErrorCode;

  IF @debugMode = 1  -- DebugMode is true  
  BEGIN  
    SELECT @recordsAffected = @recordsInserted;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfrecordsAffected=@recordsAffected;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 7. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_GeoLocationsToShapes_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_GeoLocations on DW (built from selected GPSData positions)
--
--  Dependencies:
--    STAGE_DIM_OrganisationsToGeoLocations
--    STAGE_DIM_Shapes
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_GeoLocationsToShapes_Transform]
(
  @batchKey           int,
  @organisationKey    int,
  @debugMode          int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
) AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  int = 0;
  DECLARE @recordsDeleted   int = 0;
  DECLARE @nrOfrecordsAffected int = 0;
  DECLARE @minBatchKey      int; -- used to identify if existing GeoLocations existed before inserting as new shapes

  CREATE TABLE #inserting 
  (
    GeoLocationKey                int               NOT NULL,
    ShapeKey                      int               NOT NULL
  );

  CREATE TABLE #inserting_changed
  (
    GeoLocationKey                int               NOT NULL,
    ShapeKey                      int               NOT NULL
  );

  CREATE TABLE #deleting         
  (
    GeoLocationToShapeKey         bigint            NOT NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    TRUNCATE TABLE [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes;

    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes') AND name = N'IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes')
      DROP INDEX IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes ON [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes;

    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser].STAGE_DIM_OrganisationsToGeoLocations') AND name = N'IX_STAGE_DIM_OrganisationsToGeoLocations_LocationPoint')
      CREATE SPATIAL INDEX IX_STAGE_DIM_OrganisationsToGeoLocations_LocationPoint ON [StageUser].STAGE_DIM_OrganisationsToGeoLocations(LocationPoint)
        USING GEOGRAPHY_GRID WITH
        ( CELLS_PER_OBJECT = 6,GRIDS = (LEVEL_1 = HIGH, LEVEL_2 = HIGH, LEVEL_3 = HIGH, LEVEL_4 = HIGH),ONLINE = OFF );

    INSERT INTO [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes
    (
      ShapeKey,
      ShapeBoundary
    )
    SELECT
      ds.ShapeKey,
      ds.ShapeBoundary
    FROM
      [MiXData].[dbo].DIM_Shapes ds WITH (NOLOCK)
    WHERE
        ds.OrganisationKey = @organisationKey
    AND ds.IsDeleted       = 0;

    CREATE SPATIAL INDEX IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes ON [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes(ShapeBoundary)
      USING GEOGRAPHY_GRID WITH
      ( CELLS_PER_OBJECT = 32, GRIDS = (LEVEL_1 = MEDIUM, LEVEL_2 = MEDIUM, LEVEL_3 = HIGH, LEVEL_4 = HIGH), ONLINE = OFF );

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.0 Initial Insert - Shapes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.0 Add to STG - Shapes ' + CAST(@nrOfrecordsAffected AS nvarchar);
    END;

    -- Add all new GeoLocation points in an existing Shape for the organisation:
    INSERT INTO #inserting
    (
      GeoLocationKey,
      ShapeKey
    )
    SELECT
      og.GeoLocationKey,
      s.ShapeKey
    FROM
      [StageUser].STAGE_DIM_OrganisationsToGeoLocations        og WITH (NOLOCK) --,INDEX (IX_STAGE_DIM_OrganisationsToGeoLocations_LocationPoint))
        INNER JOIN
      [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes s  WITH (NOLOCK)
        ON s.ShapeBoundary.STIntersects(og.LocationPoint) = 1;

    CREATE INDEX IX_inserting ON #inserting(GeoLocationKey,ShapeKey);

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.1 Initial Insert - new Geo points', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.1 Add to STG - new Geo points ' + CAST(@nrOfrecordsAffected AS nvarchar);
    END;

    TRUNCATE TABLE [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes;
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes') AND name = N'IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes')
      DROP INDEX IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes ON [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes;

    -- Find all Shapes with new boundaries for the organisation:
    INSERT INTO [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes
    (
      ShapeKey,
      ShapeBoundary
    )
    SELECT
      ds.ShapeKey,
      ds.ShapeBoundary
    FROM
      [MiXData].[dbo].DIM_Shapes ds WITH (NOLOCK)
        INNER JOIN
      [StageUser].ROLLBACK_DIM_Shapes rbds ON ds.ShapeKey = rbds.ShapeKey
    WHERE
        ds.IsDeleted = 0
    AND (ISNULL(rbds.ShapeBoundary.STEquals(ds.ShapeBoundary), 0) = 0
    OR rbds.IsDeleted <> ds.IsDeleted);
    SELECT @nrOfrecordsAffected = @@ROWCOUNT;

    -- brand new shapes

    -- only add to [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes if existing points already exists
    --   (dont want to run this for initial insert since we have already added these in step 2.1)
    SELECT @minBatchKey = MIN(CreateBatchKey)
    FROM [MiXData].[dbo].DIM_Vehicles WITH (NOLOCK)
    WHERE OrganisationKey = @organisationKey;

    SELECT @nrOfrecordsAffected = 0;
    IF (@batchKey > ISNULL(@minBatchKey,0))
    BEGIN
      INSERT INTO [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes
      (
        ShapeKey,
        ShapeBoundary
      )
      SELECT
        ds.ShapeKey,
        ds.ShapeBoundary
      FROM
        [MiXData].[dbo].DIM_Shapes ds WITH (NOLOCK)
      WHERE
          ds.OrganisationKey = @organisationKey
      AND ds.CreateBatchKey  = @batchKey
      AND ds.IsDeleted       = 0
      AND NOT EXISTS (SELECT 1
                      FROM [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes cs
                      WHERE cs.ShapeKey = ds.ShapeKey);
      SELECT @nrOfrecordsAffected = @nrOfrecordsAffected + @@ROWCOUNT;
    END;
    
    CREATE SPATIAL INDEX IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes ON [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes(ShapeBoundary)
      USING GEOGRAPHY_GRID WITH
      ( CELLS_PER_OBJECT = 32, GRIDS = (LEVEL_1 = MEDIUM, LEVEL_2 = MEDIUM, LEVEL_3 = HIGH, LEVEL_4 = HIGH), ONLINE = OFF );

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.2 Initial Insert - changed Shapes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.2 Add to STG - changed Shapes ' + CAST(@nrOfrecordsAffected AS nvarchar);
    END;

  --Save all locations that fall into these changed shapes:
    SELECT @nrOfrecordsAffected = 0;
    IF (ISNULL((SELECT COUNT(1) FROM [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes),0) > 0) -- only exec if changed shapes exists
    BEGIN
      INSERT INTO #inserting_changed
      (
        GeoLocationKey,
        ShapeKey
      )
      SELECT
        g.GeoLocationKey,
        s.ShapeKey
      FROM
        [MiXData].[dbo].DIM_GeoLocations g  WITH (NOLOCK,INDEX (IX_DIM_GeoLocations_LocationPoint))
          INNER JOIN
        [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes s WITH (NOLOCK)
                                                                 ON g.OrganisationKey = @organisationKey
                                                                AND s.ShapeBoundary.STIntersects(g.LocationPoint) = 1;

      CREATE INDEX IX_inserting_changed ON #inserting_changed(GeoLocationKey,ShapeKey);

      DELETE c
      FROM       
        #inserting_changed c
          INNER JOIN
        [MiXData].[dbo].DIM_GeoLocationsToShapes gs WITH (NOLOCK) ON gs.GeoLocationKey = c.GeoLocationKey
                                                                 AND gs.ShapeKey       = c.ShapeKey;

      INSERT INTO #inserting
      (
        GeoLocationKey,
        ShapeKey
      )
      SELECT
        c.GeoLocationKey,
        c.ShapeKey
      FROM #inserting_changed c
      WHERE
          NOT EXISTS (SELECT *
                      FROM
                        #inserting i
                      WHERE
                          i.GeoLocationKey = c.GeoLocationKey
                      AND i.ShapeKey       = c.ShapeKey);

      SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    END; -- end if only execute if changed shapes exists

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.3 Initial Insert - changed Shape points', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.3 Add to STG - changed Shape points';
    END;

  -- Now detect any locations no longer in the changed shapes
    -- only need to remove records for changed shapes only and not new shapes
    DELETE
      ds
    FROM
      [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes ds
    WHERE NOT EXISTS (SELECT 1
                      FROM [StageUser].ROLLBACK_DIM_Shapes rbds 
                      WHERE ds.ShapeKey = rbds.ShapeKey);

    SELECT @nrOfrecordsAffected = 0;
    IF (ISNULL((SELECT COUNT(1) FROM [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes),0) > 0) -- only exec if changed shapes exists
    BEGIN
      ;WITH
      ExistingGeoLocationsToShapes AS
      (
        SELECT
          gs.GeoLocationToShapeKey,
          gs.GeoLocationKey
        FROM
          [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes s  WITH (NOLOCK)
            INNER JOIN
          [MiXData].[dbo].DIM_GeoLocationsToShapes                  gs WITH (NOLOCK) ON s.ShapeKey = gs.ShapeKey
      )
      INSERT INTO #deleting
      (
        GeoLocationToShapeKey
      )
      SELECT
        gs.GeoLocationToShapeKey
      FROM
        ExistingGeoLocationsToShapes     gs
          INNER JOIN
        [MiXData].[dbo].DIM_GeoLocations g   WITH (NOLOCK) ON gs.GeoLocationKey = g.GeoLocationKey
          INNER JOIN
        [StageUser].STAGE_DIM_GeoLocationsToShapes_ChangedShapes s WITH (NOLOCK)
                                                           ON s.ShapeBoundary.STIntersects(g.LocationPoint) = 0; -- NOT in shape!

      CREATE INDEX IX_deleting ON #deleting(GeoLocationToShapeKey);

      SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    END;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.4 Initial Insert - changed Shape deleted points', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.4 Add to STG - changed Shape deleted points';
    END;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. Insert/Delete against DW (Load)
  --------------------------------------------------------------------
  BEGIN TRY

    INSERT INTO [MiXData].[dbo].DIM_GeoLocationsToShapes
    (
      GeoLocationKey,
      ShapeKey,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      GeoLocationKey,
      ShapeKey,
      @batchKey,
      @batchKey
    FROM
      #inserting
    SET @recordsInserted += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
    END;

    INSERT INTO [StageUser].ROLLBACK_DIM_GeoLocationsToShapes
    (
      GeoLocationToShapeKey,
      GeoLocationKey,
      ShapeKey,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      GeoLocationToShapeKey,
      GeoLocationKey,
      ShapeKey,
      CreateBatchKey,
      UpdateBatchKey
    FROM
     (DELETE
        gs
      OUTPUT
        DELETED.GeoLocationToShapeKey,
        DELETED.GeoLocationKey,
        DELETED.ShapeKey,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
      FROM
        [MiXData].[dbo].DIM_GeoLocationsToShapes gs
          INNER JOIN
        #deleting d ON gs.GeoLocationToShapeKey = d.GeoLocationToShapeKey
     ) as RollBck
    SET @recordsDeleted = @@ROWCOUNT;

    -- removal for Removed Shapes
    INSERT INTO [StageUser].ROLLBACK_DIM_GeoLocationsToShapes
    (
      GeoLocationToShapeKey,
      GeoLocationKey,
      ShapeKey,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      GeoLocationToShapeKey,
      GeoLocationKey,
      ShapeKey,
      CreateBatchKey,
      UpdateBatchKey
    FROM
     (DELETE
        gs
      OUTPUT
        DELETED.GeoLocationToShapeKey,
        DELETED.GeoLocationKey,
        DELETED.ShapeKey,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
      FROM
        [StageUser].STAGE_DIM_Shapes                d
          INNER JOIN
        [MiXData].[dbo].DIM_Shapes               ds WITH (NOLOCK) ON ds.OrganisationKey = @organisationKey
                                                                    AND ds.HostID          = d.HostID
                                                                    AND d.IsDeleted        = 1
          INNER JOIN
        [MiXData].[dbo].DIM_GeoLocationsToShapes gs               ON gs.ShapeKey        = ds.ShapeKey
     ) as RollBck
    SET @recordsDeleted = @recordsDeleted + @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.2 Merge Delete Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 5. Insert/Delete against DW (Load)';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    0                     RecordsType2Inserted,
    0                     RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsDeleted;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 7. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_Organisations_Late_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_Organisation on DW (details of organisations, late transform)
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_Organisations_Late_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_DIM_Organisations_Late];
  TRUNCATE TABLE [StageUser].[ROLLBACK_DIM_Organisations_Late];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -------------------------------
    -- Organisation
    ;WITH Latest (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser].OrgOptions WITH (NOLOCK)
    )
	  INSERT INTO [StageUser].[STAGE_DIM_Organisations_Late]
	  (
      DealerName      ,
      DealerTelNo
	  )
	  SELECT 
      s.sLPDealerName ,
      s.sLPDealerTelNo
	  FROM -- select * from
	    [StageUser].OrgOptions s WITH (NOLOCK)
        INNER JOIN
      Latest l ON s.RID = l.MaxRID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Validation before Loading to DW
  --------------------------------------------------------------------
 BEGIN TRY
    -- Check 1 - Make sure there are no duplicate GuidIDs
    --IF NOT EXISTS (SELECT 1
                     --FROM [StageUser].[STAGE_DIM_Organisations_Late])
    --BEGIN
      --RAISERROR(N'No OrgOptions available (possibly empty CompanyGUID)',16,1);
    --END

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    INSERT INTO [StageUser].[ROLLBACK_DIM_Organisations_Late]
    (
      OrganisationKey ,
      OrganisationGUID,
      DealerName      ,
      DealerTelNo     ,
      CreateBatchKey  ,
      UpdateBatchKey
    )
    SELECT
      tar.OrganisationKey ,
      tar.OrganisationGUID,
      tar.DealerName      ,
      tar.DealerTelNo     ,
      tar.CreateBatchKey  ,
      tar.UpdateBatchKey
    FROM
      [MiXData].dbo.DIM_Organisations             AS tar
        CROSS JOIN
      [StageUser].[STAGE_DIM_Organisations_Late] AS stg
    WHERE
      tar.OrganisationKey  = @organisationKey
    AND
      (ISNULL(tar.DealerName,'')  <> ISNULL(stg.DealerName,'')
    OR  
       ISNULL(tar.DealerTelNo,'') <> ISNULL(stg.DealerTelNo,''));

    UPDATE
      [MiXData].dbo.DIM_Organisations
    SET
      DealerName  = ISNULL(stg.DealerName, ''),
      DealerTelNo = ISNULL(stg.DealerTelNo,'')
    FROM
      [MiXData].dbo.DIM_Organisations             AS tar
        CROSS JOIN
      [StageUser].[STAGE_DIM_Organisations_Late] AS stg
    WHERE
      tar.OrganisationKey  = @organisationKey
    AND
      (ISNULL(tar.DealerName,'')  <> ISNULL(stg.DealerName,'')
    OR  
       ISNULL(tar.DealerTelNo,'') <> ISNULL(stg.DealerTelNo,''));
    
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_DIM_Organisations_Late];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'5. Cleanup work tables';

  --------------------------------------------------------------------
  -- 6. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = 0,
         RecordsUpdated  = ISNULL(@recordsUpdated,0),
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_Passengers_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_Passengers on DW (details of Passengers)
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_Passengers_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey         int;
  DECLARE @UTCOffsetMinutes     smallint;
  DECLARE @minAuditDate         datetimeoffset(0);  
  DECLARE @maxAuditDate         datetimeoffset(0);
  DECLARE @startDate            datetimeoffset(0);
  DECLARE @tmpDate              datetimeoffset(0);
  DECLARE @endDate              datetimeoffset(0);
  DECLARE @startDateKey         date;
  DECLARE @endDateKey           date;
  DECLARE @previousEndDateKey   date;

  -- Default values
  DECLARE @endDateDefault       date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)
  DECLARE @startDateFirstInsert date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @defaultIdentifierValue uniqueidentifier = '00000000-0000-0000-0000-000000000000'; -- used with GUID comparison for null values

  -- Get range for which SCD should be calculated
  SELECT
    @startDate    = MIN(ChangeDate),
    @maxAuditDate = MAX(ChangeDate)
  FROM
    [StageUser].Passengers;

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[ROLLBACK_DIM_Passengers];

  --------------------------------------------------------------------
  -- Loop through calculation a day at a time and Load to DW
  WHILE @StartDate <= @MaxAuditDate
  BEGIN

  -- get timezone infomation
  SELECT
    @UTCOffsetKey     = UTCOffsetKey,
    @UTCOffsetMinutes = UTCOffsetMinutes,
    @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
  FROM
    [StageUser].STAGE_DIM_UTCOffsetsLookUp
  WHERE
    @startDate     BETWEEN StartDateTime       AND EndDateTime
    AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

  SET @startDateKey       = CONVERT(date, @tmpDate);

  -- get the UTC time for the start of the next day in organisation's timezone
  SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
  SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_DIM_Passengers];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

  ;WITH
  Latest (MaxRID) AS
  (
    SELECT MAX(RID)
    FROM [StageUser].Passengers WITH (NOLOCK)
    WHERE
        ChangeDate >= @startDate
    AND ChangeDate  < @endDate
    GROUP BY iPassengerID
  )
  INSERT INTO [StageUser].[STAGE_DIM_Passengers]
  (
    HostID,
    PassengerName,
    PassengerGUID,
    MaxRID
  )
  SELECT
    s.iPassengerID ,
    s.sName,
    s.PassengerGUID,
    l.MaxRID
  FROM
    Latest l
      INNER JOIN
    [StageUser].Passengers s WITH (NOLOCK) ON s.RID = l.MaxRID
  WHERE
      s.ChangeDate >= @startDate
  AND s.ChangeDate  < @endDate;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------


  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck (Type 2)
  --------------------------------------------------------------------
  BEGIN TRY

    INSERT INTO [StageUser].[ROLLBACK_DIM_Passengers]
    ( 
      [PassengerKey]   ,
      [OrganisationKey],
      [StartDateKey]   ,
      [EndDateKey]     ,
      [IsCurrentRecord],
      [HostID]         ,
      [PassengerGUID]  ,
      [PassengerName]  ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      [PassengerKey]   ,
      [OrganisationKey],
      [StartDateKey]   ,
      [EndDateKey]     ,
      [IsCurrentRecord],
      [HostID]         ,
      [PassengerGUID]  ,
      [PassengerName]  ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    FROM 
     (MERGE [MiXData].dbo.DIM_Passengers     AS tar
      USING [StageUser].[STAGE_DIM_Passengers] AS stg
       ON  tar.OrganisationKey = @organisationKey
       AND tar.HostID          = stg.HostID

      -- Matched and DW StartDateKey = StartDate (then just update)
      WHEN MATCHED
       AND  tar.StartDateKey   = @StartDateKey
       AND  tar.EndDateKey     = @endDateDefault
       AND  (tar.PassengerName <> stg.PassengerName
        OR   tar.PassengerGUID <> stg.PassengerGUID)
      THEN
        UPDATE 
        SET
          tar.[PassengerName]  = stg.[PassengerName],
          tar.[PassengerGUID]  = stg.[PassengerGUID],
          tar.[UpdateBatchKey] = @batchKey

      -- Not Matched
      WHEN NOT MATCHED THEN
        INSERT
        (
          [OrganisationKey],
          [StartDateKey]   ,
          [EndDateKey]     ,
          [IsCurrentRecord],
          [HostID]         ,
          [PassengerGUID]  ,
          [PassengerName]  ,
          [CreateBatchKey] ,
          [UpdateBatchKey]
        )
        VALUES
        (
          @OrganisationKey     ,
          @startDateFirstInsert,
          @endDateDefault      ,
          1                    ,
          stg.[HostID]         ,
          stg.[PassengerGUID]  ,
          stg.[PassengerName]  ,
          @batchKey             ,
          @batchKey
        )
      OUTPUT 
        $action   AS Operation   , 
        DELETED.[PassengerKey]   ,
        DELETED.[OrganisationKey],
        DELETED.[StartDateKey]   ,
        DELETED.[EndDateKey]     ,
        DELETED.[IsCurrentRecord],
        DELETED.[HostID]         ,
        DELETED.[PassengerGUID]  ,
        DELETED.[PassengerName]  ,
        DELETED.[CreateBatchKey] ,
        DELETED.[UpdateBatchKey]
      ) AS RollBck              -- end merge
    WHERE
      Operation        = 'UPDATE'
    AND
      [UpdateBatchKey] < @batchKey; -- end insert

    -- Matched and DW StartDateKey < StartDate (set EndDateKey/IsCurrentRecord)    
    INSERT INTO [StageUser].[ROLLBACK_DIM_Passengers]
    ( 
      [PassengerKey]   ,
      [OrganisationKey],
      [StartDateKey]   ,
      [EndDateKey]     ,
      [IsCurrentRecord],
      [HostID]         ,
      [PassengerGUID]  ,
      [PassengerName]  ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      [PassengerKey]   ,
      [OrganisationKey],
      [StartDateKey]   ,
      [EndDateKey]     ,
      [IsCurrentRecord],
      [HostID]         ,
      [PassengerGUID]  ,
      [PassengerName]  ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    FROM 
     (MERGE [MiXData].dbo.DIM_Passengers     AS tar
      USING [StageUser].[STAGE_DIM_Passengers] AS stg
       ON  tar.OrganisationKey = @organisationKey
       AND tar.HostID          = stg.HostID

      WHEN MATCHED
      AND  tar.StartDateKey   < @StartDateKey
      AND  tar.EndDateKey     = @endDateDefault
      AND  (tar.PassengerName <> stg.PassengerName
       OR   tar.PassengerGUID <> stg.PassengerGUID)
      THEN 
        UPDATE
        SET
          tar.EndDateKey      = @previousEndDateKey,
          tar.IsCurrentRecord = 0,
          tar.UpdateBatchKey  = @batchKey
        
      OUTPUT 
        $action   AS Operation   ,
        DELETED.[PassengerKey]   ,
        DELETED.[OrganisationKey],
        DELETED.[StartDateKey]   ,
        DELETED.[EndDateKey]     ,
        DELETED.[IsCurrentRecord],
        DELETED.[HostID]         ,
        DELETED.[PassengerGUID]  ,
        DELETED.[PassengerName]  ,
        DELETED.[CreateBatchKey] ,
        DELETED.[UpdateBatchKey]
      ) AS RollBck              -- end merge
    WHERE
      Operation        = 'UPDATE'
    AND
      [UpdateBatchKey] < @batchKey; -- end insert

    -- Insert new Records for Type 2 changes
    INSERT INTO [MiXData].dbo.DIM_Passengers
    (
      [OrganisationKey],
      [StartDateKey]   ,
      [EndDateKey]     ,
      [IsCurrentRecord],
      [HostID]         ,
      [PassengerGUID]  ,
      [PassengerName]  ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      @OrganisationKey   ,
      @startDateKey      ,
      @endDateDefault    ,
      1                  ,
      stg.[HostID]       ,
      stg.[PassengerGUID],
      stg.[PassengerName],
      @batchKey           ,
      @batchKey
    FROM
      [MiXData].dbo.DIM_Passengers     AS tar
        INNER JOIN
      [StageUser].[STAGE_DIM_Passengers] AS stg
        ON tar.OrganisationKey = @organisationKey
       AND tar.HostID          = stg.HostID
    WHERE
        tar.StartDateKey     < @StartDateKey
    AND tar.EndDateKey       = @previousEndDateKey
    AND (tar.[PassengerName] <> stg.[PassengerName]
     OR  tar.PassengerGUID   <> stg.PassengerGUID);

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  SELECT @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
  FROM [StageUser].Passengers
  WHERE ChangeDate >= @endDate;
    
  END -- END WHILE

  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------


  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Update Type 1 columns on DW';

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_DIM_Passengers];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsUpdated = count(1)
  FROM
    [MiXData].dbo.DIM_Passengers WITH (NOLOCK)
  WHERE
    OrganisationKey = @organisationKey
  AND
    UpdateBatchKey  = @batchKey;

  SELECT
    @recordsInserted = count(1)
  FROM
    [MiXData].dbo.DIM_Passengers WITH (NOLOCK)
  WHERE
    OrganisationKey = @organisationKey
  AND
    CreateBatchKey = @batchKey;
  
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = (isnull(@recordsUpdated,0) - isnull(@recordsInserted,0)),  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsType2Inserted = 0,
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_ReportingGroups_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_ReportingGroups on DW (details of reporting groups)
--
--   Dependencies
--
--     DIM_Drivers
--     DIM_Vehicles
--
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_ReportingGroups_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value     int;
  DECLARE @recordsInserted  int;
  DECLARE @recordsUpdated   int;
  DECLARE @recordsDeleted   int;

  DECLARE @driverLookupKey  int;
  DECLARE @vehicleLookupKey int;

  DECLARE @ROLLBACK_DIM_ReportingGroups TABLE 
  (
    ReportingGroupKey           int               NOT NULL PRIMARY KEY,
    OrganisationKey             int               NOT NULL,
    ReportingGroupTypeLookupKey int               NULL,
    HostID                      int               NULL,
    ReportingGroupGUID          uniqueidentifier  NULL,
    ReportingGroupName          nvarchar (510)     NULL,
    MemberGUID                  uniqueidentifier  NULL,
    ReportingGroupParentKey     int               NULL,
    CreateBatchKey              int               NULL,
    UpdateBatchKey              int               NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_DIM_ReportingGroups];
  TRUNCATE TABLE [StageUser].[ROLLBACK_DIM_ReportingGroups];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    SELECT
      @driverLookupKey = tcl.LookupRID
	  FROM
      [MiXData].dbo.DIM_TableColumnLookups tcl WITH (NOLOCK)
    WHERE
      tcl.LookupTable  = 'DIM_ReportingGroups'
    AND
      tcl.LookupColumn = 'ReportingGroupTypeLookupKey'
    AND
      tcl.LookupKey    = 1; -- Drivers

    SELECT
      @vehicleLookupKey = tcl.LookupRID
    FROM
      [MiXData].dbo.DIM_TableColumnLookups tcl WITH (NOLOCK)
    WHERE
      tcl.LookupTable  = 'DIM_ReportingGroups'
    AND
      tcl.LookupColumn = 'ReportingGroupTypeLookupKey'
    AND
      tcl.LookupKey    = 2; -- Vehicles

	  INSERT INTO [StageUser].[STAGE_DIM_ReportingGroups]
	  (
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberID]                   ,
      [ReportingGroupParentKey]
	  )
	  SELECT
	    @driverLookupKey  ,
      dr.liGroupID      ,
      dr.GroupGUID      ,
      dr.sName          ,
      drg.iDriverID     ,
      0         -- default of 0 for now
	  FROM
	    [StageUser].[DriverReporting]       dr
	      INNER JOIN
	    [StageUser].[DriverReportingGroups] drg
	      ON dr.liGroupID = drg.liGroupID
	  WHERE
	    drg.[Operation] <> 'D';

	  INSERT INTO [StageUser].[STAGE_DIM_ReportingGroups]
	  (
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberID]                   ,
      [ReportingGroupParentKey]
	  )
	  SELECT
	    @vehicleLookupKey  ,
      vr.liGroupID       ,
      vr.GroupGUID       ,
      vr.sName           ,
      vrg.iVehicleID     ,
      0         -- default of 0 for now
	  FROM
	    [StageUser].[VehicleReporting]       vr
	      INNER JOIN
	    [StageUser].[VehicleReportingGroups] vrg
	      ON vr.liGroupID = vrg.liGroupID
	  WHERE
	    vrg.[Operation] <> 'D';

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    ------------------------------------------
    -- MemberGUID (Driver)
    UPDATE
      [StageUser].[STAGE_DIM_ReportingGroups]
    SET
      MemberGUID = s.DriverGUID
    FROM
      [StageUser].[STAGE_DIM_ReportingGroups] stg
        INNER JOIN
      [MiXData].dbo.DIM_Drivers s WITH (NOLOCK)
        ON  s.OrganisationKey               = @organisationKey
        AND stg.MemberID                    = s.HostID
    WHERE
      stg.ReportingGroupTypeLookupKey = @driverLookupKey;

    ------------------------------------------
    -- MemberGUID (Vehicle)
    UPDATE
      [StageUser].[STAGE_DIM_ReportingGroups]
    SET
      MemberGUID = s.VehicleGUID
    FROM
      [StageUser].[STAGE_DIM_ReportingGroups] stg
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles s WITH (NOLOCK)
        ON  s.OrganisationKey               = @organisationKey
        AND stg.MemberID                    = s.HostID
    WHERE
      stg.ReportingGroupTypeLookupKey = @vehicleLookupKey;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5.1 MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- backup deleted records to Rollback tbl
    INSERT INTO [StageUser].[ROLLBACK_DIM_ReportingGroups]
    ( 
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    )
    SELECT
      tar.[ReportingGroupKey]          ,
      tar.[OrganisationKey]            ,
      tar.[ReportingGroupTypeLookupKey],
      tar.[HostID]                     ,
      tar.[ReportingGroupGUID]         ,
      tar.[ReportingGroupName]         ,
      tar.[MemberGUID]                 ,
      tar.[ReportingGroupParentKey]    ,
      tar.[CreateBatchKey]             ,
      tar.[UpdateBatchKey]
    FROM
      [MiXData].dbo.DIM_ReportingGroups tar WITH (NOLOCK)
        INNER JOIN
      [MiXData].dbo.DIM_Drivers         drv WITH (NOLOCK) ON tar.OrganisationKey             = @organisationKey
                                                            AND tar.ReportingGroupTypeLookupKey = @driverLookupKey
                                                            AND drv.OrganisationKey             = tar.OrganisationKey
                                                            AND drv.DriverGUID                  = tar.MemberGUID
                                                            AND drv.IsCurrentRecord             = 1
        INNER JOIN
      [StageUser].[DriverReportingGroups]  drg               ON drg.liGroupID = tar.HostID
                                                            AND drg.iDriverID = drv.HostID
    WHERE drg.[Operation] = 'D'
    UNION
    SELECT
      tar.[ReportingGroupKey]          ,
      tar.[OrganisationKey]            ,
      tar.[ReportingGroupTypeLookupKey],
      tar.[HostID]                     ,
      tar.[ReportingGroupGUID]         ,
      tar.[ReportingGroupName]         ,
      tar.[MemberGUID]                 ,
      tar.[ReportingGroupParentKey]    ,
      tar.[CreateBatchKey]             ,
      tar.[UpdateBatchKey]
    FROM
      [MiXData].dbo.DIM_ReportingGroups tar WITH (NOLOCK)
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles       vhc  WITH (NOLOCK) ON tar.OrganisationKey             = @organisationKey
                                                            AND tar.ReportingGroupTypeLookupKey = @vehicleLookupKey
                                                            AND vhc.OrganisationKey             = tar.OrganisationKey
                                                            AND vhc.VehicleGUID                 = tar.MemberGUID
                                                            AND vhc.IsCurrentRecord             = 1
        INNER JOIN
      [StageUser].[VehicleReportingGroups]  vrg              ON vrg.liGroupID  = tar.HostID
                                                            AND vrg.iVehicleID = vhc.HostID
    WHERE vrg.[Operation]                 = 'D';
	  
    DELETE [MiXData].dbo.DIM_ReportingGroups
    FROM
      [MiXData].dbo.DIM_ReportingGroups tar
        INNER JOIN
      [StageUser].[ROLLBACK_DIM_ReportingGroups] r ON tar.[ReportingGroupKey] = r.[ReportingGroupKey]
     WHERE
       tar.OrganisationKey         = @organisationKey;

    -- Add to RollBck table
    INSERT INTO [StageUser].[ROLLBACK_DIM_ReportingGroups]
    (
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    )
    SELECT
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    FROM 
     (MERGE [MiXData].dbo.DIM_ReportingGroups     AS tar
      USING [StageUser].[STAGE_DIM_ReportingGroups] AS stg
       ON  tar.OrganisationKey             = @organisationKey
       AND tar.ReportingGroupTypeLookupKey = stg.ReportingGroupTypeLookupKey
       AND tar.HostID                      = stg.HostID
--       AND tar.ReportingGroupGUID          = stg.ReportingGroupGUID
       AND tar.MemberGUID                  = stg.MemberGUID
      WHEN MATCHED
       AND  (tar.[ReportingGroupName]      <> stg.[ReportingGroupName]
        OR   tar.[ReportingGroupParentKey] <> stg.[ReportingGroupParentKey]
        OR   tar.ReportingGroupGUID        <> stg.ReportingGroupGUID)
      THEN
        UPDATE 
        SET tar.[ReportingGroupName]      = stg.[ReportingGroupName]     ,
            tar.[ReportingGroupParentKey] = stg.[ReportingGroupParentKey],
            tar.ReportingGroupGUID        = stg.ReportingGroupGUID,
            tar.UpdateBatchKey            = @batchKey
      -- Not Matched
      WHEN NOT MATCHED THEN
        INSERT
        ( 
          [OrganisationKey]            ,
          [ReportingGroupTypeLookupKey],
          [HostID]                     ,
          [ReportingGroupGUID]         ,
          [ReportingGroupName]         ,
          [MemberGUID]                 ,
          [ReportingGroupParentKey]    ,
          [CreateBatchKey]             ,
          [UpdateBatchKey]
        )
        VALUES
        (
          @organisationKey                 ,
          stg.[ReportingGroupTypeLookupKey],
          stg.[HostID]                     ,
          stg.[ReportingGroupGUID]         ,
          stg.[ReportingGroupName]         ,
          stg.[MemberGUID]                 ,
          stg.[ReportingGroupParentKey]    ,
          @batchKey                         ,
          @batchKey
        )
      OUTPUT 
        $action   AS Operation, 
        DELETED.[ReportingGroupKey]          ,
        DELETED.[OrganisationKey]            ,
        DELETED.[ReportingGroupTypeLookupKey],
        DELETED.[HostID]                     ,
        DELETED.[ReportingGroupGUID]         ,
        DELETED.[ReportingGroupName]         ,
        DELETED.[MemberGUID]                 ,
        DELETED.[ReportingGroupParentKey]    ,
        DELETED.[CreateBatchKey]             ,
        DELETED.[UpdateBatchKey]
      ) AS RollBck              -- end merge
    WHERE
      Operation        = 'UPDATE'; -- end insert

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5.1 MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5.2 Update Type 1 changes
  --------------------------------------------------------------------
  BEGIN TRY

    -- VehicleReportingGroup
    INSERT INTO @ROLLBACK_DIM_ReportingGroups
    (
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    )
    SELECT
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    FROM 
     (UPDATE
        tar
      SET
        [ReportingGroupName] = stg.sName,
        [ReportingGroupGUID] = stg.GroupGUID
      OUTPUT 
        DELETED.[ReportingGroupKey]          ,
        DELETED.[OrganisationKey]            ,
        DELETED.[ReportingGroupTypeLookupKey],
        DELETED.[HostID]                     ,
        DELETED.[ReportingGroupGUID]         ,
        DELETED.[ReportingGroupName]         ,
        DELETED.[MemberGUID]                 ,
        DELETED.[ReportingGroupParentKey]    ,
        DELETED.[CreateBatchKey]             ,
        DELETED.[UpdateBatchKey]
      FROM
       [StageUser].[VehicleReporting]       stg
         INNER JOIN
       [MiXData].dbo.DIM_ReportingGroups tar ON tar.OrganisationKey             = @organisationKey
                                               AND tar.ReportingGroupTypeLookupKey = @vehicleLookupKey
                                               AND tar.HostID                      = stg.liGroupID
      WHERE
         tar.[ReportingGroupName] <> stg.sName
      OR tar.[ReportingGroupGUID] <> stg.GroupGUID) upd;
      
    SELECT @recordsUpdated = @@ROWCOUNT;
    
    INSERT INTO [StageUser].ROLLBACK_DIM_ReportingGroups
    (
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    )
    SELECT
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    FROM
      @ROLLBACK_DIM_ReportingGroups rb
    WHERE
      NOT EXISTS (SELECT 1 
                  FROM [StageUser].[ROLLBACK_DIM_ReportingGroups] roll
                  WHERE roll.[ReportingGroupKey] = rb.[ReportingGroupKey]);
    DELETE @ROLLBACK_DIM_ReportingGroups;

    -- DriverReportingGroup
    INSERT INTO @ROLLBACK_DIM_ReportingGroups
    (
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    )
    SELECT
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    FROM 
     (UPDATE
        tar
      SET
        [ReportingGroupName] = stg.sName,
        [ReportingGroupGUID] = stg.GroupGUID
      OUTPUT 
        DELETED.[ReportingGroupKey]          ,
        DELETED.[OrganisationKey]            ,
        DELETED.[ReportingGroupTypeLookupKey],
        DELETED.[HostID]                     ,
        DELETED.[ReportingGroupGUID]         ,
        DELETED.[ReportingGroupName]         ,
        DELETED.[MemberGUID]                 ,
        DELETED.[ReportingGroupParentKey]    ,
        DELETED.[CreateBatchKey]             ,
        DELETED.[UpdateBatchKey]
      FROM
       [StageUser].[DriverReporting]       stg
         INNER JOIN
       [MiXData].dbo.DIM_ReportingGroups tar ON tar.OrganisationKey             = @organisationKey
                                               AND tar.ReportingGroupTypeLookupKey = @driverLookupKey
                                               AND tar.HostID                      = stg.liGroupID
      WHERE
         tar.[ReportingGroupName] <> stg.sName
      OR tar.[ReportingGroupGUID] <> stg.GroupGUID) upd;

    SELECT @recordsUpdated = ISNULL(@recordsUpdated,0) + @@ROWCOUNT;

    INSERT INTO [StageUser].ROLLBACK_DIM_ReportingGroups
    (
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    )
    SELECT
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    FROM
      @ROLLBACK_DIM_ReportingGroups rb
    WHERE
      NOT EXISTS (SELECT 1 
                  FROM [StageUser].[ROLLBACK_DIM_ReportingGroups] roll
                  WHERE roll.[ReportingGroupKey] = rb.[ReportingGroupKey]);

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5.2 MERGE to DW (Load) and add to RollBck';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_DIM_ReportingGroups];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsInserted = count(1)
  FROM
    [MiXData].dbo.DIM_ReportingGroups WITH (NOLOCK)
  WHERE
      OrganisationKey = @organisationKey
  AND CreateBatchKey  = @batchKey;
  
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated,0),  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_Shapes_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_Shapes on DW (built from selected MapLocations positions)
--
--  Dependencies:
--    DIM_Sites
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_Shapes_Transform]
(
  @batchKey         int,
  @organisationKey  int,
  @debugMode        int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
) AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  int = 0;
  DECLARE @recordsUpdated   int = 0;
  DECLARE @recordsDeleted   int = 0;
  DECLARE @taxBusinessLookupKey  int;
  DECLARE @taxPrivateLookupKey   int;

  DECLARE @merged           table
  (
    Operation                     char (6)          NOT NULL,
    ShapeKey                      int               NOT NULL,
    OrganisationKey               int               NULL,
    HostID                        int               NULL,
    SiteKey                       int               NULL,
    ShapeType                     tinyint           NULL,
    ShapeName                     nvarchar (100)    NULL,
    ShapeBoundaryType             tinyint           NULL,
    ShapeBoundary                 geography         NULL,
    ShapeTaxTypeLookupKey         int               NULL,
    IsDeleted                     bit               NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_DIM_Shapes];
  TRUNCATE TABLE [StageUser].[ROLLBACK_DIM_Shapes];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    SELECT
      @taxBusinessLookupKey = tcl.LookupRID
	  FROM
      [MiXData].dbo.DIM_TableColumnLookups tcl WITH (NOLOCK)
    WHERE
        tcl.LookupTable  = 'DIM_Shapes'
    AND tcl.LookupColumn = 'ShapeTaxTypeLookupKey'
    AND tcl.LookupKey    = 1; -- Business

    SELECT
      @taxPrivateLookupKey = tcl.LookupRID
	  FROM
      [MiXData].dbo.DIM_TableColumnLookups tcl WITH (NOLOCK)
    WHERE
        tcl.LookupTable  = 'DIM_Shapes'
    AND tcl.LookupColumn = 'ShapeTaxTypeLookupKey'
    AND tcl.LookupKey    = 2; -- Private

    INSERT INTO [StageUser].[STAGE_DIM_Shapes]
    (
      HostID,
      Operation,
      SiteHostID,
      ShapeType,
      ShapeName,
      ShapeBoundaryType,
      ShapeBoundary,
      ShapeTaxTypeLookupKey,
      IsDeleted
    )
    SELECT
      liLocationID,
      Operation,
      liSiteID,
      ucLocationType,
      sLocationName,
      ucShapeType,
      CASE ucShapeType
        WHEN 0 THEN
          dbo.fncBuildCircle(fPointLongitude, fPointLatitude, liPointRadius)
        WHEN 1 THEN
          dbo.fncBuildPolygonFromMapLocationPolygonPoints('[StageUser]', liLocationID)
        WHEN 2 THEN
          dbo.fncBuildRectangle(fUpperLeftLongitude, fUpperLeftLatitude, fLowerRightLongitude, fLowerRightLatitude)
        WHEN 3 THEN
          dbo.fncBuildLineFromMapLocationPolygonPoints('[StageUser]', liLocationID)
        ELSE
          NULL
      END,
      CASE ucTaxType
        WHEN 0 THEN @taxBusinessLookupKey
        WHEN 1 THEN @taxPrivateLookupKey
        ELSE -1
      END,
      CASE WHEN bDeleted IS NULL AND Operation = 'D' THEN 1 ELSE bDeleted END
    FROM
      [StageUser].MapLocations WITH (NOLOCK)
    WHERE
       ucLocationSource = 1
    OR Operation        = 'D';

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    --------------------------------------------

    -- SiteKey
    UPDATE
      [StageUser].[STAGE_DIM_Shapes]
    SET
      SiteKey     = ds.SiteKey
    FROM
      [StageUser].[STAGE_DIM_Shapes] stg
      INNER JOIN [MiXData].dbo.DIM_Sites ds WITH (NOLOCK) ON ds.OrganisationKey  = @organisationKey
                                                            AND stg.SiteHostID      = ds.HostID
    WHERE
      stg.SiteHostID IS NOT NULL;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  --BEGIN TRY


    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'4. Validation before Loading to DW';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError @organisationKey = @organisationKey;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    MERGE [MiXData].[dbo].DIM_Shapes tar
      USING [StageUser].STAGE_DIM_Shapes stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostID          = stg.HostID
      WHEN MATCHED 
        AND Operation != 'D' THEN
        UPDATE SET
          tar.SiteKey               = ISNULL(stg.SiteKey,-1),
          tar.ShapeType             = stg.ShapeType,
          tar.ShapeName             = stg.ShapeName,
          tar.ShapeBoundaryType     = stg.ShapeBoundaryType,
          tar.ShapeBoundary         = stg.ShapeBoundary,
          tar.ShapeTaxTypeLookupKey = stg.ShapeTaxTypeLookupKey,
          tar.IsDeleted             = stg.IsDeleted,
          tar.UpdateBatchKey        = @batchKey
      -- Not Matched
      WHEN NOT MATCHED
        AND Operation != 'D' THEN
        INSERT
        (
          OrganisationKey,
          HostID,
          SiteKey,
          ShapeType,
          ShapeName,
          ShapeBoundaryType,
          ShapeBoundary,
          ShapeTaxTypeLookupKey,
          IsDeleted,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.HostID,
          ISNULL(stg.SiteKey,-1),
          stg.ShapeType,
          stg.ShapeName,
          stg.ShapeBoundaryType,
          stg.ShapeBoundary,
          stg.ShapeTaxTypeLookupKey,
          stg.IsDeleted,
          @batchKey,
          @batchKey
        )
      OUTPUT
        $action   AS Operation,
        ISNULL(DELETED.ShapeKey, INSERTED.ShapeKey),
        DELETED.OrganisationKey,
        DELETED.HostID,
        DELETED.SiteKey,
        DELETED.ShapeType,
        DELETED.ShapeName,
        DELETED.ShapeBoundaryType,
        DELETED.ShapeBoundary,
        DELETED.ShapeTaxTypeLookupKey,
        DELETED.IsDeleted,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
        INTO @merged;

    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merged
    WHERE
      Operation = 'INSERT';

    UPDATE
      [MiXData].[dbo].DIM_Shapes
    SET
      IsDeleted = 1
    OUTPUT
      'UPDATE' AS Operation,
      DELETED.ShapeKey,
      DELETED.OrganisationKey,
      DELETED.HostID,
      DELETED.SiteKey,
      DELETED.ShapeType,
      DELETED.ShapeName,
      DELETED.ShapeBoundaryType,
      DELETED.ShapeBoundary,
      DELETED.ShapeTaxTypeLookupKey,
      DELETED.IsDeleted,
      DELETED.CreateBatchKey,
      DELETED.UpdateBatchKey
      INTO @merged
    FROM
      [MiXData].[dbo].DIM_Shapes tar
      INNER JOIN [StageUser].STAGE_DIM_Shapes stg ON tar.OrganisationKey = @organisationKey
                                                 AND tar.HostID          = stg.HostID
    WHERE
      stg.Operation = 'D'

    -- Add to RollBack table: 
    INSERT INTO [StageUser].[ROLLBACK_DIM_Shapes]
    (
      ShapeKey,
      OrganisationKey,
      HostID,
      SiteKey,
      ShapeType,
      ShapeName,
      ShapeBoundaryType,
      ShapeBoundary,
      ShapeTaxTypeLookupKey,
      IsDeleted,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      ShapeKey,
      OrganisationKey,
      HostID,
      SiteKey,
      ShapeType,
      ShapeName,
      ShapeBoundaryType,
      ShapeBoundary,
      ShapeTaxTypeLookupKey,
      IsDeleted,
      CreateBatchKey,
      UpdateBatchKey
    FROM
      @merged
    WHERE
      Operation != 'INSERT';
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------

  -- do not clear STAGE_DIM_Shapes as it is needed by other transforms!

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    0                     RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_SimpleScoreCriteria_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_SimpleScoreCriteria on DW SCD (details of simple scores)
--
--  Dependencies
--
--    DIM_EventDescriptions
--
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_SimpleScoreCriteria_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey           int;
  DECLARE @UTCOffsetMinutes       smallint;
  DECLARE @maxAuditDate           datetimeoffset (0);
  DECLARE @startDate              datetimeoffset (0);
  DECLARE @tmpDate                datetimeoffset (0);
  DECLARE @endDate                datetimeoffset (0);
  DECLARE @startDateKey           date;
  DECLARE @previousEndDateKey     date;

  -- Default values
  DECLARE @startDateFirstInsert   date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @endDateDefault         date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)

  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                   nvarchar (10)     NOT NULL,
    ScoreCriteriaKey            int               NOT NULL,
    StartDateKey                date              NULL,
    EndDateKey                  date              NULL,
    IsCurrentRecord             bit               NULL,
    IsActive                    bit               NULL,
    OrganisationKey             int               NULL,
    HostID                      int               NULL,
    EventDescriptionKey         int               NULL,
    TriggerID                   int               NULL,
    ScoreDuration               float             NULL,
    ScoreSeverity               float             NULL,
    ScoreWeight                 int               NULL,
    UTCOffsetKey                int               NULL,
    CreateBatchKey              int               NULL,
    UpdateBatchKey              int               NULL
  );
  DECLARE @type2Keys table
  (
    ScoreCriteriaKey          int  NOT NULL,
    HostID                    int  NOT NULL
  );
  
  -- Get range for which SCD should be calculated
  SELECT 
    @startDate    = MIN(ChangeDate),
    @maxAuditDate = MAX(ChangeDate)
  FROM
    [StageUser].ScoredEvents;

  TRUNCATE TABLE [StageUser].ROLLBACK_DIM_SimpleScoreCriteria;

  -- Loop through calculation a day at a time and Load to DW
  WHILE @startDate <= @MaxAuditDate
    BEGIN
    -- get timezone infomation
      SELECT
        @UTCOffsetKey     = UTCOffsetKey,
        @UTCOffsetMinutes = UTCOffsetMinutes,
        @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
      FROM
        [StageUser].STAGE_DIM_UTCOffsetsLookUp
      WHERE
        @startDate     BETWEEN StartDateTime       AND EndDateTime
        AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

      SET @startDateKey       = CONVERT(date, @tmpDate);
    -- get the UTC time for the start of the next day in organisation's timezone
      SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
      SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
      TRUNCATE TABLE [StageUser].[STAGE_DIM_SimpleScoreCriteria];

      IF @debugMode = 1  -- DebugMode is true
        PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
      BEGIN TRY
        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser].ScoredEvents WITH (NOLOCK)
          WHERE
            ChangeDate      >= @startDate
            AND ChangeDate  <  @endDate
          GROUP BY
            iEventID
        )
	      INSERT INTO [StageUser].[STAGE_DIM_SimpleScoreCriteria]
	      (
	        HostID       ,
	        TriggerID    ,
	        ScoreDuration,
          ScoreSeverity,
          ScoreWeight  ,
          IsActive
	      )
	      SELECT
          s.iEventID        ,
          s.ucScoreTriggerID,
          s.lfScoreDuration ,
          s.lfScoreSeverity ,
          s.ucScoreWeight   ,
          IsActive = CASE
                       WHEN s.Operation = 'D' THEN
                         0
                       ELSE
                         1
                     END
	      FROM
          Latest l
            INNER JOIN
	        [StageUser].ScoredEvents s WITH (NOLOCK) ON l.RID = s.RID;

        SET @rowcount = @@ROWCOUNT;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
      BEGIN TRY
      
        ---------------------------------
        -- EventDescriptionKey
        UPDATE
          [StageUser].[STAGE_DIM_SimpleScoreCriteria]
        SET
          EventDescriptionKey = ded.EventDescriptionKey
        FROM
          [StageUser].[STAGE_DIM_SimpleScoreCriteria] stg
            INNER JOIN
          [MiXData].dbo.[DIM_EventDescriptions]     ded WITH (NOLOCK)
            ON stg.HostID = ded.HostID;

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
      BEGIN TRY

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'4. Validation before Loading to DW';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck (Type 2)
  --------------------------------------------------------------------
      BEGIN TRY

        DELETE @merged;

        MERGE INTO [MiXData].[dbo].DIM_SimpleScoreCriteria tar
          USING [StageUser].STAGE_DIM_SimpleScoreCriteria stg
             ON tar.OrganisationKey = @organisationKey
            AND tar.HostID          = stg.HostID
        -- Matched and DW IsCurrent record (then just update)
          WHEN MATCHED
            AND tar.StartDateKey = @StartDateKey
            AND tar.EndDateKey   = @endDateDefault
            THEN UPDATE
            SET
              tar.IsActive            = stg.IsActive           ,
              tar.EventDescriptionKey = stg.EventDescriptionKey,
              tar.TriggerID           = stg.TriggerID          ,
              tar.ScoreDuration       = stg.ScoreDuration      ,
              tar.ScoreSeverity       = stg.ScoreSeverity      ,
              tar.ScoreWeight         = stg.ScoreWeight        ,
              tar.UTCOffsetKey        = @UTCOffsetKey          ,
              tar.UpdateBatchKey      = @batchKey
        -- Not Matched -> insert new record into DW
          WHEN NOT MATCHED
            THEN INSERT
            (
              StartDateKey       ,
              EndDateKey         ,
              IsCurrentRecord    ,
              IsActive           ,
              OrganisationKey    ,
              HostID             ,
              EventDescriptionKey,
              TriggerID          ,
              ScoreDuration      ,
              ScoreSeverity      ,
              ScoreWeight        ,
              UTCOffsetKey       ,
              CreateBatchKey     ,
              UpdateBatchKey
            )
            VALUES
            (
              @startDateFirstInsert  ,
              @endDateDefault        ,
              1                      ,
              stg.IsActive           ,
              @organisationKey       ,
              stg.HostID             ,
              stg.EventDescriptionKey,
              stg.TriggerID          ,
              stg.ScoreDuration      ,
              stg.ScoreSeverity      ,
              stg.ScoreWeight        ,
              @UTCOffsetKey,
              @batchKey,
              @batchKey
            )
          OUTPUT
            $action   AS Operation                 ,
            ISNULL(DELETED.ScoreCriteriaKey, -1)   ,
            DELETED.StartDateKey                   ,
            DELETED.EndDateKey                     ,
            DELETED.IsCurrentRecord                ,
            DELETED.IsActive                       ,
            DELETED.OrganisationKey                ,
            ISNULL(DELETED.HostID, INSERTED.HostID),
            DELETED.EventDescriptionKey            ,
            DELETED.TriggerID                      ,
            DELETED.ScoreDuration                  ,
            DELETED.ScoreSeverity                  ,
            DELETED.ScoreWeight                    ,
            DELETED.UTCOffsetKey                   ,
            DELETED.CreateBatchKey                 ,
            DELETED.UpdateBatchKey
            INTO @merged;
        SET @rowcount = @@ROWCOUNT;
        SELECT
          @recordsInserted += COUNT(*)
        FROM
          @merged
        WHERE
          Operation = 'INSERT';

        INSERT INTO [StageUser].ROLLBACK_DIM_SimpleScoreCriteria
        (
          ScoreCriteriaKey   ,
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          EventDescriptionKey,
          TriggerID          ,
          ScoreDuration      ,
          ScoreSeverity      ,
          ScoreWeight        ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        )
        SELECT
          ScoreCriteriaKey   ,
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          EventDescriptionKey,
          TriggerID          ,
          ScoreDuration      ,
          ScoreSeverity      ,
          ScoreWeight        ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        FROM
          @merged
        WHERE
          Operation        = 'UPDATE'
          AND UpdateBatchKey < @batchKey; -- end insert
        SET @recordsUpdated += @@ROWCOUNT;
        
       IF @debugMode = 1
          PRINT '    after merge: rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

  --------------------------------------------------------------------
      -- type 2 changes -> first expire current
        DELETE @type2Keys;
        INSERT INTO @type2Keys
        SELECT
          tar.ScoreCriteriaKey,
          tar.HostID
        FROM
          [MiXData].[dbo].DIM_SimpleScoreCriteria tar
          INNER JOIN [StageUser].STAGE_DIM_SimpleScoreCriteria stg ON  tar.OrganisationKey = @organisationKey
                                                                   AND tar.HostID          = stg.HostID
        WHERE
          tar.StartDateKey      < @StartDateKey
          AND  tar.EndDateKey   = @endDateDefault
          AND (tar.TriggerID     <> stg.TriggerID
            OR tar.ScoreDuration <> stg.ScoreDuration
            OR tar.ScoreSeverity <> stg.ScoreSeverity
            OR tar.ScoreWeight   <> stg.ScoreWeight
            OR tar.IsActive      <> stg.IsActive
              );
        SET @rowcount = @@ROWCOUNT;

        INSERT INTO [StageUser].ROLLBACK_DIM_SimpleScoreCriteria
        (
          ScoreCriteriaKey   ,
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          EventDescriptionKey,
          TriggerID          ,
          ScoreDuration      ,
          ScoreSeverity      ,
          ScoreWeight        ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        )
        SELECT
          ScoreCriteriaKey   ,
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          EventDescriptionKey,
          TriggerID          ,
          ScoreDuration      ,
          ScoreSeverity      ,
          ScoreWeight        ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        FROM
         (
          UPDATE
            [MiXData].[dbo].DIM_SimpleScoreCriteria
          SET
            EndDateKey      = @previousEndDateKey,
            IsCurrentRecord = 0,
            UpdateBatchKey  = @batchKey
          OUTPUT
            DELETED.ScoreCriteriaKey   ,
            DELETED.StartDateKey       ,
            DELETED.EndDateKey         ,
            DELETED.IsCurrentRecord    ,
            DELETED.IsActive           ,
            DELETED.OrganisationKey    ,
            DELETED.HostID             ,
            DELETED.EventDescriptionKey,
            DELETED.TriggerID          ,
            DELETED.ScoreDuration      ,
            DELETED.ScoreSeverity      ,
            DELETED.ScoreWeight        ,
            DELETED.UTCOffsetKey       ,
            DELETED.CreateBatchKey     ,
            DELETED.UpdateBatchKey
          FROM
            [MiXData].[dbo].DIM_SimpleScoreCriteria tar
            INNER JOIN @type2Keys k ON tar.ScoreCriteriaKey = k.ScoreCriteriaKey
          ) AS RollBck              -- end update
        WHERE
          UpdateBatchKey < @batchKey; -- end insert

        -- Insert new Records for Type 2 changes
        INSERT INTO [MiXData].[dbo].DIM_SimpleScoreCriteria
        (
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          EventDescriptionKey,
          TriggerID          ,
          ScoreDuration      ,
          ScoreSeverity      ,
          ScoreWeight        ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        )
        SELECT
          @startDateFirstInsert  ,
          @endDateDefault        ,
          1                      ,
          stg.IsActive           ,
          @organisationKey       ,
          stg.HostID             ,
          stg.EventDescriptionKey,
          stg.TriggerID          ,
          stg.ScoreDuration      ,
          stg.ScoreSeverity      ,
          stg.ScoreWeight        ,
          @UTCOffsetKey          ,
          @batchKey              ,
          @batchKey
        FROM
          [StageUser].STAGE_DIM_SimpleScoreCriteria stg
          INNER JOIN @type2Keys k ON stg.HostID = k.HostID;
        SET @recordsType2Inserted += @@ROWCOUNT;

        IF @debugMode = 1
          PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

      SELECT
        @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
      FROM
        [StageUser].ScoredEvents
      WHERE
        ChangeDate >= @endDate;
    
    END -- END WHILE

  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------
  BEGIN TRY
    -- only need to stage keys and type1 columns
    TRUNCATE TABLE [StageUser].STAGE_DIM_SimpleScoreCriteria;

    ;WITH Latest (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser].ScoredEvents WITH (NOLOCK)
      GROUP BY
        iEventID
    )
    INSERT INTO [StageUser].STAGE_DIM_SimpleScoreCriteria
    (
      HostID,
      EventDescriptionKey
    )
    SELECT
      s.iEventID,
      ded.EventDescriptionKey
    FROM
      Latest l
      INNER JOIN [StageUser].ScoredEvents           s   WITH (NOLOCK) ON l.MaxRID            = s.RID
      LEFT  JOIN [MiXData].dbo.DIM_EventDescriptions ded WITH (NOLOCK) ON s.iEventID          = ded.HostID
                                                                      AND ded.OrganisationKey = @organisationKey;

    INSERT INTO [StageUser].ROLLBACK_DIM_SimpleScoreCriteria
    (
      ScoreCriteriaKey   ,
      StartDateKey       ,
      EndDateKey         ,
      IsCurrentRecord    ,
      IsActive           ,
      OrganisationKey    ,
      HostID             ,
      EventDescriptionKey,
      TriggerID          ,
      ScoreDuration      ,
      ScoreSeverity      ,
      ScoreWeight        ,
      UTCOffsetKey       ,
      CreateBatchKey     ,
      UpdateBatchKey
    )
    SELECT
      ScoreCriteriaKey   ,
      StartDateKey       ,
      EndDateKey         ,
      IsCurrentRecord    ,
      IsActive           ,
      OrganisationKey    ,
      HostID             ,
      EventDescriptionKey,
      TriggerID          ,
      ScoreDuration      ,
      ScoreSeverity      ,
      ScoreWeight        ,
      UTCOffsetKey       ,
      CreateBatchKey     ,
      UpdateBatchKey
    FROM
     (
      UPDATE
        [MiXData].[dbo].DIM_SimpleScoreCriteria
      SET
        EventDescriptionKey = stg.EventDescriptionKey
      OUTPUT
        DELETED.ScoreCriteriaKey   ,
        DELETED.StartDateKey       ,
        DELETED.EndDateKey         ,
        DELETED.IsCurrentRecord    ,
        DELETED.IsActive           ,
        DELETED.OrganisationKey    ,
        DELETED.HostID             ,
        DELETED.EventDescriptionKey,
        DELETED.TriggerID          ,
        DELETED.ScoreDuration      ,
        DELETED.ScoreSeverity      ,
        DELETED.ScoreWeight        ,
        DELETED.UTCOffsetKey       ,
        DELETED.CreateBatchKey     ,
        DELETED.UpdateBatchKey
      FROM
        [MiXData].[dbo].DIM_SimpleScoreCriteria tar
        INNER JOIN [StageUser].STAGE_DIM_SimpleScoreCriteria stg ON tar.OrganisationKey = @organisationKey
                                                                AND tar.HostID          = stg.HostID
      WHERE
        tar.EventDescriptionKey <> stg.EventDescriptionKey
     ) rllbck
    WHERE
      UpdateBatchKey < @batchKey;
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'6. Update Type 1 columns on DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_DIM_SimpleScoreCriteria];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;
  
  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_Sites_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_Sites on DW (details of sites)
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_Sites_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_DIM_Sites];
  TRUNCATE TABLE [StageUser].[ROLLBACK_DIM_Sites];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    ;WITH Latest (HostID,SiteGUID,MaxRID) AS
    (
      SELECT
        liSiteID,
        SiteGUID,
        MAX(RID)
      FROM
        [StageUser].Sites WITH (NOLOCK)
      GROUP BY
        liSiteID,
        SiteGUID
    )
	  INSERT INTO [StageUser].[STAGE_DIM_Sites]
	  (
	    HostID          ,
	    SiteName        ,
	    SiteGUID        ,
      MemberOfSiteGUID
	  )
	  SELECT
      s.liSiteID,
      ISNULL(s.sName,''),
      s.SiteGUID,
      s.SiteGUID
	  FROM
	    [StageUser].Sites s WITH (NOLOCK)
        INNER JOIN
      Latest l 
        ON  s.RID      = l.MaxRID
        AND s.liSiteID = l.HostID
        AND s.SiteGUID = l.SiteGUID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY


    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF EXISTS (SELECT 1
               FROM
                 [StageUser].[STAGE_DIM_Sites]
               WHERE
                 SiteGUID         IS NULL)
    BEGIN
      RAISERROR(N'Missing Keys (possibly no values in DIM_GUIDToKeys)',16,1);
    END
 
    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Add to RollBck table
    INSERT INTO [StageUser].[ROLLBACK_DIM_Sites]
    ( 
      [SiteKey]              ,
      [SiteGUID]             ,
      [OrganisationKey]      ,
      [HostID]               ,
      [SiteName]             ,
      [MemberOfSiteGUID]  ,
      [CreateBatchKey]       ,
      [UpdateBatchKey]
    )
    SELECT
      [SiteKey]              ,
      [SiteGUID]             ,
      [OrganisationKey]      ,
      [HostID]               ,
      [SiteName]             ,
      [SiteGUID]             ,
      [CreateBatchKey]       ,
      [UpdateBatchKey]       
    FROM 
     (MERGE [MiXData].dbo.DIM_Sites     AS tar
      USING [StageUser].[STAGE_DIM_Sites] AS stg
       ON  tar.OrganisationKey = @organisationKey
       AND tar.SiteGUID        = stg.SiteGUID
      WHEN MATCHED
       AND  (tar.SiteName              <> stg.SiteName
        OR   tar.[MemberOfSiteGUID] <> stg.[MemberOfSiteGUID])
      THEN
        UPDATE 
        SET tar.SiteName            = stg.SiteName,
            tar.MemberOfSiteGUID = stg.MemberOfSiteGUID,
            tar.UpdateBatchKey  = @batchKey
      -- Not Matched
      WHEN NOT MATCHED THEN
        INSERT
        ( 
          [OrganisationKey]      ,
          [HostID]               ,
          [SiteName]             ,
          [SiteGUID]             ,
          [MemberOfSiteGUID]     ,
          [CreateBatchKey]       ,
          [UpdateBatchKey]       
        )
        VALUES
        (
          @organisationKey         ,
          stg.[HostID]             ,
          stg.[SiteName]           ,
          stg.[SiteGUID]           ,
          stg.[SiteGUID]           ,
          @batchKey                 ,
          @batchKey
        )
      OUTPUT 
        $action   AS Operation, 
        DELETED.[SiteKey]              ,
        DELETED.[SiteGUID]             ,
        DELETED.[OrganisationKey]      ,
        DELETED.[HostID]               ,
        DELETED.[SiteName]             ,
        DELETED.[MemberOfSiteGUID]     ,
        DELETED.[CreateBatchKey]       ,
        DELETED.[UpdateBatchKey]       
      ) AS RollBck              -- end merge
    WHERE
      Operation        = 'UPDATE'; -- end insert

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_DIM_Sites];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT @recordsUpdated = count(1)
  FROM   [MiXData].dbo.DIM_Sites WITH (NOLOCK)
  WHERE
    OrganisationKey = @organisationKey
  AND
    UpdateBatchKey  = @batchKey;

  SELECT @recordsInserted = count(1)
  FROM   [MiXData].dbo.DIM_Sites WITH (NOLOCK)
  WHERE
    OrganisationKey = @organisationKey
  AND
    CreateBatchKey  = @batchKey;
  
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = (isnull(@recordsUpdated,0) - isnull(@recordsInserted,0)),  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_Trailers_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_Trailers on DW (details of trailers)
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_Trailers_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey           int;
  DECLARE @UTCOffsetMinutes       smallint;
  DECLARE @maxAuditDate           datetimeoffset (0);
  DECLARE @startDate              datetimeoffset (0);
  DECLARE @tmpDate                datetimeoffset (0);
  DECLARE @endDate                datetimeoffset (0);
  DECLARE @startDateKey           date;
  DECLARE @previousEndDateKey     date;

  -- Default values
  DECLARE @startDateFirstInsert   date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @endDateDefault         date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)

  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                       nvarchar (10)     NOT NULL,
    TrailerKey                      int               NOT NULL,
    StartDateKey                    date              NULL,
    EndDateKey                      date              NULL,
    IsCurrentRecord                 bit               NULL,
    IsActive                        bit               NULL,
    OrganisationKey                 int               NULL,
    HostID                          int               NULL,
    TrailerGUID                     uniqueidentifier  NULL,
    TrailerAssetNumber              nvarchar (255)    NULL,
    TrailerRegNumber                nvarchar (15)     NULL,
    TrailerDescription              nvarchar (255)    NULL,
    TrailerUnitID                   int               NULL,
    SiteGUID                        uniqueidentifier  NULL,
    UnitTypeLookupKey               int               NULL,
    UTCOffsetKey                    int               NULL,
    CreateBatchKey                  int               NULL,
    UpdateBatchKey                  int               NULL
  );
  DECLARE @type2Keys table
  (
    TrailerKey          int  NOT NULL,
    HostID              int  NOT NULL
  );
  
  -- Get range for which SCD should be calculated
  SELECT 
    @startDate    = MIN(ChangeDate),
    @maxAuditDate = MAX(ChangeDate)
  FROM
    [StageUser].Trailers;

  TRUNCATE TABLE [StageUser].ROLLBACK_DIM_Trailers;

  -- Loop through calculation a day at a time and Load to DW
  WHILE @startDate <= @MaxAuditDate
    BEGIN
    -- get timezone infomation
      SELECT
        @UTCOffsetKey     = UTCOffsetKey,
        @UTCOffsetMinutes = UTCOffsetMinutes,
        @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
      FROM
        [StageUser].STAGE_DIM_UTCOffsetsLookUp
      WHERE
        @startDate     BETWEEN StartDateTime       AND EndDateTime
        AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

      SET @startDateKey       = CONVERT(date, @tmpDate);
    -- get the UTC time for the start of the next day in organisation's timezone
      SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
      SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
      TRUNCATE TABLE [StageUser].[STAGE_DIM_Trailers];

      IF @debugMode = 1  -- DebugMode is true
        PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
      BEGIN TRY
        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser].Trailers WITH (NOLOCK)
          WHERE
            ChangeDate      >= @startDate
            AND ChangeDate  <  @endDate
          GROUP BY
            liTrailerID,
            TrailerGUID
        )
        INSERT INTO [StageUser].[STAGE_DIM_Trailers]
        (
          HostID            ,
          TrailerGUID       ,
          TrailerAssetNumber,
          TrailerRegNumber  ,
          TrailerDescription,
          IsActive
        )
        SELECT
              s.liTrailerID ,
              s.TrailerGUID ,
              s.sAssetNumber,
              s.sRegNo      ,
              s.sDescription,
              IsActive = CASE
                           WHEN s.Operation = 'D' THEN
                             0
                           ELSE
                             1
                         END
        FROM
          Latest l
            INNER JOIN
	        [StageUser].Trailers s WITH (NOLOCK) ON l.RID = s.RID;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'2. Add to STG';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
      BEGIN TRY

        ------------------------------------------
        -- TrailerUnitID (will need to relook at using this calculation as source tbl usage might change)
        ;WITH Latest (TrailerID,MaxDateAttached) AS
        (
          SELECT
            liTrailerID,
            MAX(dtAttached)
          FROM
            [StageUser].TrailerUnitIDs
          GROUP BY
            liTrailerID
        )
        UPDATE
          [StageUser].[STAGE_DIM_Trailers]
        SET
          TrailerUnitID = s.liUnitID
        FROM
          [StageUser].[STAGE_DIM_Trailers] stg
            INNER JOIN
          [StageUser].[TrailerUnitIDs]     s WITH (NOLOCK) ON stg.HostID   = s.liTrailerID
            INNER JOIN
          Latest                           l               ON s.liTrailerID = l.TrailerID
                                                          AND s.dtAttached  = l.MaxDateAttached;
        
        ------------------------------------------
        -- SiteGUID (Currently nothing that associates a Trailer with a site)

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'3. Update calculated columns onto STG';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
      BEGIN TRY
        IF EXISTS (SELECT 1
                   FROM
                     [StageUser].[STAGE_DIM_Trailers]
                   WHERE
                     TrailerGUID IS NULL)
          RAISERROR(N'NULL value on TrailerGUID (check Trailer.TrailerGUID on source data)',16,1);

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'4. Validation before Loading to DW';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck (Type 2)
  --------------------------------------------------------------------
      BEGIN TRY

        DELETE @merged;

        MERGE INTO [MiXData].[dbo].DIM_Trailers tar
          USING [StageUser].STAGE_DIM_Trailers stg
             ON tar.OrganisationKey = @organisationKey
            AND tar.HostID          = stg.HostID
        -- Matched and DW IsCurrent record (then just update)
          WHEN MATCHED
            AND tar.StartDateKey = @StartDateKey
            AND tar.EndDateKey   = @endDateDefault
            THEN UPDATE
            SET
              tar.IsActive           = stg.IsActive          ,
              tar.TrailerAssetNumber = stg.TrailerAssetNumber,
              tar.TrailerRegNumber   = stg.TrailerRegNumber  ,
              tar.TrailerDescription = stg.TrailerDescription,
              tar.TrailerUnitID      = stg.TrailerUnitID     ,
              tar.SiteGUID           = ISNULL(stg.SiteGUID          ,'00000000-0000-0000-0000-000000000000'),
              tar.UnitTypeLookupKey  = ISNULL(stg.UnitTypeLookupKey ,tar.UnitTypeLookupKey),
              tar.UTCOffsetKey       = @UTCOffsetKey         ,
              tar.UpdateBatchKey     = @batchKey
        -- Not Matched -> insert new record into DW
          WHEN NOT MATCHED
            THEN INSERT
            (
              StartDateKey       ,
              EndDateKey         ,
              IsCurrentRecord    ,
              IsActive           ,
              OrganisationKey    ,
              HostID             ,
              TrailerGUID        ,
              TrailerAssetNumber ,
              TrailerRegNumber   ,
              TrailerDescription ,
              TrailerUnitID      ,
              SiteGUID           ,
              UnitTypeLookupKey  ,
              UTCOffsetKey       ,
              CreateBatchKey     ,
              UpdateBatchKey
            )
            VALUES
            (
              @startDateFirstInsert  ,
              @endDateDefault        ,
              1                      ,
              stg.IsActive           ,
              @organisationKey       ,
              stg.HostID             ,
              stg.TrailerGUID        ,
              stg.TrailerAssetNumber ,
              stg.TrailerRegNumber   ,
              stg.TrailerDescription ,
              stg.TrailerUnitID      ,
              ISNULL(stg.SiteGUID           ,'00000000-0000-0000-0000-000000000000'),
              stg.UnitTypeLookupKey  ,
              @UTCOffsetKey          ,
              @batchKey              ,
              @batchKey
            )
          OUTPUT
            $action   AS Operation                 ,
            ISNULL(DELETED.TrailerKey, -1)         ,
            DELETED.StartDateKey                   ,
            DELETED.EndDateKey                     ,
            DELETED.IsCurrentRecord                ,
            DELETED.IsActive                       ,
            DELETED.OrganisationKey                ,
            ISNULL(DELETED.HostID, INSERTED.HostID),
            DELETED.TrailerGUID                    ,
            DELETED.TrailerAssetNumber             ,
            DELETED.TrailerRegNumber               ,
            DELETED.TrailerDescription             ,
            DELETED.TrailerUnitID                  ,
            DELETED.SiteGUID                       ,
            DELETED.UnitTypeLookupKey              ,
            DELETED.UTCOffsetKey                   ,
            DELETED.CreateBatchKey                 ,
            DELETED.UpdateBatchKey
            INTO @merged;
        SET @rowcount = @@ROWCOUNT;
        SELECT
          @recordsInserted += COUNT(*)
        FROM
          @merged
        WHERE
          Operation = 'INSERT';

        INSERT INTO [StageUser].ROLLBACK_DIM_Trailers
        (
          TrailerKey        ,
          StartDateKey      ,
          EndDateKey        ,
          IsCurrentRecord   ,
          IsActive          ,
          OrganisationKey   ,
          HostID            ,
          TrailerGUID       ,
          TrailerAssetNumber,
          TrailerRegNumber  ,
          TrailerDescription,
          TrailerUnitID     ,
          SiteGUID          ,
          UnitTypeLookupKey ,
          UTCOffsetKey      ,
          CreateBatchKey    ,
          UpdateBatchKey
        )
        SELECT
          TrailerKey        ,
          StartDateKey      ,
          EndDateKey        ,
          IsCurrentRecord   ,
          IsActive          ,
          OrganisationKey   ,
          HostID            ,
          TrailerGUID       ,
          TrailerAssetNumber,
          TrailerRegNumber  ,
          TrailerDescription,
          TrailerUnitID     ,
          SiteGUID          ,
          UnitTypeLookupKey ,
          UTCOffsetKey      ,
          CreateBatchKey    ,
          UpdateBatchKey
        FROM
          @merged
        WHERE
          Operation        = 'UPDATE'
          AND UpdateBatchKey < @batchKey; -- end insert
        SET @recordsUpdated += @@ROWCOUNT;
        
       IF @debugMode = 1
          PRINT '    after merge: rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

  --------------------------------------------------------------------
      -- type 2 changes -> first expire current
        DELETE @type2Keys;
        INSERT INTO @type2Keys
        SELECT
          tar.TrailerKey,
          tar.HostID
        FROM
          [MiXData].[dbo].DIM_Trailers tar
          INNER JOIN [StageUser].STAGE_DIM_Trailers stg ON tar.OrganisationKey = @organisationKey
                                                       AND tar.HostID          = stg.HostID
        WHERE
          tar.StartDateKey      < @StartDateKey
          AND  tar.EndDateKey   = @endDateDefault
          AND (tar.TrailerAssetNumber <> stg.TrailerAssetNumber
            OR tar.TrailerRegNumber   <> stg.TrailerRegNumber
            OR tar.TrailerDescription <> stg.TrailerDescription
            OR tar.TrailerUnitID      <> stg.TrailerUnitID
            OR tar.IsActive           <> stg.IsActive
            OR tar.UnitTypeLookupKey  <> ISNULL(stg.UnitTypeLookupKey,-1)
              );
        SET @rowcount = @@ROWCOUNT;

        INSERT INTO [StageUser].ROLLBACK_DIM_Trailers
        (
          TrailerKey         ,
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          TrailerGUID        ,
          TrailerAssetNumber ,
          TrailerRegNumber   ,
          TrailerDescription ,
          TrailerUnitID      ,
          SiteGUID           ,
          UnitTypeLookupKey  ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        )
        SELECT
          TrailerKey         ,
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          TrailerGUID        ,
          TrailerAssetNumber ,
          TrailerRegNumber   ,
          TrailerDescription ,
          TrailerUnitID      ,
          SiteGUID           ,
          UnitTypeLookupKey  ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        FROM
         (
          UPDATE
            [MiXData].[dbo].DIM_Trailers
          SET
            EndDateKey      = @previousEndDateKey,
            IsCurrentRecord = 0,
            UpdateBatchKey  = @batchKey
          OUTPUT
            DELETED.TrailerKey         ,
            DELETED.StartDateKey       ,
            DELETED.EndDateKey         ,
            DELETED.IsCurrentRecord    ,
            DELETED.IsActive           ,
            DELETED.OrganisationKey    ,
            DELETED.HostID             ,
            DELETED.TrailerGUID        ,
            DELETED.TrailerAssetNumber ,
            DELETED.TrailerRegNumber   ,
            DELETED.TrailerDescription ,
            DELETED.TrailerUnitID      ,
            DELETED.SiteGUID           ,
            DELETED.UnitTypeLookupKey  ,
            DELETED.UTCOffsetKey       ,
            DELETED.CreateBatchKey     ,
            DELETED.UpdateBatchKey
          FROM
            [MiXData].[dbo].DIM_Trailers tar
            INNER JOIN @type2Keys k ON tar.TrailerKey = k.TrailerKey
          ) AS RollBck              -- end update
        WHERE
          UpdateBatchKey < @batchKey; -- end insert

        -- Insert new Records for Type 2 changes
        INSERT INTO [MiXData].[dbo].DIM_Trailers
        (
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          TrailerGUID        ,
          TrailerAssetNumber ,
          TrailerRegNumber   ,
          TrailerDescription ,
          TrailerUnitID      ,
          SiteGUID           ,
          UnitTypeLookupKey  ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        )
        SELECT
          @startDateFirstInsert  ,
          @endDateDefault        ,
          1                      ,
          stg.IsActive           ,
          @organisationKey       ,
          stg.HostID             ,
          stg.TrailerGUID        ,
          stg.TrailerAssetNumber ,
          stg.TrailerRegNumber   ,
          stg.TrailerDescription ,
          stg.TrailerUnitID      ,
          ISNULL(stg.SiteGUID           ,'00000000-0000-0000-0000-000000000000'),
          ISNULL(stg.UnitTypeLookupKey  ,-1),
          @UTCOffsetKey          ,
          @batchKey              ,
          @batchKey
        FROM
          [StageUser].STAGE_DIM_Trailers stg
          INNER JOIN @type2Keys k ON stg.HostID = k.HostID;
        SET @recordsType2Inserted += @@ROWCOUNT;

        IF @debugMode = 1
          PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

      SELECT
        @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
      FROM
        [StageUser].ScoredEvents
      WHERE
        ChangeDate >= @endDate;
    
    END -- END WHILE

  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Update Type 1 columns on DW';

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_DIM_Trailers];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_Units_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_Units on DW SCD (details of simple scores)
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_Units_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey           int;
  DECLARE @UTCOffsetMinutes       smallint;
  DECLARE @maxAuditDate           datetimeoffset (0);
  DECLARE @startDate              datetimeoffset (0);
  DECLARE @tmpDate                datetimeoffset (0);
  DECLARE @endDate                datetimeoffset (0);
  DECLARE @startDateKey           date;
  DECLARE @previousEndDateKey     date;

  -- Default values
  DECLARE @startDateFirstInsert   date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @endDateDefault         date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)

  -- Used for AssetTypeLookups
  DECLARE @notConnectedLookupKey  int;
  DECLARE @vehiclesLookupKey      int;
  DECLARE @trailersLookupKey      int;

  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                       nvarchar (10)     NOT NULL,
    UnitKey                         int               NOT NULL,
    StartDateKey                    date              NOT NULL,
    EndDateKey                      date              NOT NULL,
    IsCurrentRecord                 bit               NOT NULL,
    IsActive                        bit               NOT NULL,
    OrganisationKey                 int               NOT NULL,
    AssetHostID                     int               NOT NULL,
    AssetTypeLookupKey              int               NOT NULL,
    UnitSerial                      nvarchar (50)     NULL,
    AssetGUID                       uniqueidentifier  NULL,
    UnitTypeLookupKey               int               NULL,
    SiteGUID                        uniqueidentifier  NULL,
    OSVersion                       nvarchar (50)     NULL,
    FirmwareVersion                 nvarchar (50)     NULL,
    FirmwareLoadedDateKey           date              NULL,
    UTCOffsetKey                    int               NULL,
    CreateBatchKey                  int               NULL,
    UpdateBatchKey                  int               NULL
  );
  DECLARE @type2Keys table
  (
    UnitKey          int               NOT NULL,
    AssetHostID      int               NOT NULL,
    UnitSerial       nvarchar (50)     NULL
  );
  -- used to hold list of change dates of all source tables to cycle through
  DECLARE @sourceChangeDates table
  (
    ChangeDate       datetime NOT NULL
  );
  -- used to hold list of change dates of all source tables to cycle through
  DECLARE @sourceChangesRIDs table
  (
    SourceTable      char(25) NOT NULL,
    RID              int      NOT NULL
  );

  -- Get AssetTypeLookupKeys
  SELECT
    @notConnectedLookupKey = tl1.LookupRID,
    @vehiclesLookupKey     = tl2.LookupRID,
    @trailersLookupKey     = tl3.LookupRID
  FROM
    [MiXData].dbo.DIM_TableColumnLookups tl1
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tl2
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tl3
  WHERE
      tl1.LookupTable  = 'DIM_Units'
  AND tl1.LookupColumn = 'AssetTypeLookupKey'
  AND tl1.LookupKey    = 1 -- Not Connected
  AND tl2.LookupTable  = 'DIM_Units'
  AND tl2.LookupColumn = 'AssetTypeLookupKey'
  AND tl2.LookupKey    = 2 -- Vehicles
  AND tl3.LookupTable  = 'DIM_Units'
  AND tl3.LookupColumn = 'AssetTypeLookupKey'
  AND tl3.LookupKey    = 3; -- Trailers
  
  -- Get range for which SCD should be calculated
  INSERT INTO @sourceChangeDates (ChangeDate)
  SELECT DISTINCT
    ChangeDate
  FROM
    [StageUser].Vehicles
  UNION ALL
  SELECT DISTINCT
    ChangeDate = dtAttached
  FROM
    [StageUser].TrailerUnitIDs
  UNION ALL
  SELECT DISTINCT
    ChangeDate
  FROM
    [StageUser].VehicleDeviceProperties
  WHERE
      liDeviceID = 0
  AND sProperty  in ('FMGUID','DriverSetVersion','DriverSetLoadDate','OSVersion');

  SELECT 
    @startDate    = MIN(ChangeDate),
    @maxAuditDate = MAX(ChangeDate)
  FROM
    @sourceChangeDates;

  TRUNCATE TABLE [StageUser].ROLLBACK_DIM_Units;

  -- Loop through calculation a day at a time and Load to DW
  WHILE @StartDate <= @MaxAuditDate
    BEGIN
    -- get timezone infomation
      SELECT
        @UTCOffsetKey     = UTCOffsetKey,
        @UTCOffsetMinutes = UTCOffsetMinutes,
        @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
      FROM
        [StageUser].STAGE_DIM_UTCOffsetsLookUp
      WHERE
          @startDate BETWEEN StartDateTime       AND EndDateTime
      AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

      SET @startDateKey       = CONVERT(date, @tmpDate);
    -- get the UTC time for the start of the next day in organisation's timezone
      SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
      SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
      TRUNCATE TABLE [StageUser].[STAGE_DIM_Units];
      DELETE @sourceChangesRIDs;
      
      IF @debugMode = 1  -- DebugMode is true
        PRINT N'0. Make sure work tables are cleared for processing from ' + CONVERT(nvarchar, @startDate, 0) + ' to ' + CONVERT(nvarchar, @endDate, 0);

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
      BEGIN TRY
        
        ;WITH 
          LatestVehicles (RID) AS
            (
              SELECT
                MAX(RID)
              FROM
                [StageUser].Vehicles WITH (NOLOCK)
              WHERE
                ChangeDate      >= @startDate
                AND ChangeDate  <  @endDate
              GROUP BY
                iVehicleID
            )
	      INSERT INTO [StageUser].[STAGE_DIM_Units]
	      ( 
	        Operation         ,
	        AssetHostID       ,
	        AssetTypeLookupKey,
	        IsActive
	      )
	      SELECT
	        s.Operation       ,
          s.iVehicleID      ,
          @vehiclesLookupKey,
          IsActive = CASE
                       WHEN s.Operation = 'D' THEN
                         0
                       ELSE
                         1
                     END
	      FROM
          LatestVehicles       c
            INNER JOIN
	        [StageUser].Vehicles s WITH (NOLOCK) ON c.RID = s.RID;

        ;WITH
          LatestVehicleDeviceProperties (RID) AS
            (
              SELECT
                MAX(RID)
              FROM
                [StageUser].VehicleDeviceProperties WITH (NOLOCK)
              WHERE
                ChangeDate      >= @startDate
                AND ChangeDate  <  @endDate
                AND liDeviceID  = 0
                AND sProperty   in ('FMGUID','DriverSetVersion','DriverSetLoadDate','OSVersion')
              GROUP BY
                iVehicleID
            )
	      INSERT INTO [StageUser].[STAGE_DIM_Units]
	      (
	        Operation         ,
	        AssetHostID       ,
	        AssetTypeLookupKey,
	        IsActive
	      )
	      SELECT
          s.Operation       ,
          s.iVehicleID      ,
          @vehiclesLookupKey,
          1
	      FROM
          LatestVehicleDeviceProperties       c
            INNER JOIN
	        [StageUser].VehicleDeviceProperties s   WITH (NOLOCK) ON c.RID    = s.RID
	      WHERE
	        NOT EXISTS (SELECT 1
	                    FROM
	                      [StageUser].[STAGE_DIM_Units] stg
	                    WHERE
	                      stg.AssetHostID = s.iVehicleID);

        SET @rowcount = @@ROWCOUNT;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
      BEGIN TRY


        ---------------------------------
        -- UnitSerial
        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser].VehicleDeviceProperties WITH (NOLOCK)
          WHERE
                ChangeDate  >= @startDate
            AND ChangeDate  <  @endDate
            AND liDeviceID   = 0
            AND sProperty    = 'FMGUID'
          GROUP BY
            iVehicleID
        )
        UPDATE
          [StageUser].[STAGE_DIM_Units]
        SET
          UnitSerial = CASE
                         WHEN s.Operation = 'D' 
                           THEN 'D'
                         ELSE
                           s.sValue
                       END
        FROM
          [StageUser].[STAGE_DIM_Units]       stg
            INNER JOIN
          [StageUser].VehicleDeviceProperties s  ON stg.AssetHostID = s.iVehicleID
            INNER JOIN
          Latest                               l  ON l.RID           = s.RID;

        ---------------------------------
        -- OSVersion
        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser].VehicleDeviceProperties WITH (NOLOCK)
          WHERE
                ChangeDate  >= @startDate
            AND ChangeDate  <  @endDate
            AND liDeviceID   = 0
            AND sProperty    = 'OSVersion'
          GROUP BY
            iVehicleID
        )
        UPDATE
          [StageUser].[STAGE_DIM_Units]
        SET
          UnitSerial = CASE
                         WHEN s.Operation = 'D' 
                           THEN 'D'
                         ELSE
                           s.sValue
                       END
        FROM
          [StageUser].[STAGE_DIM_Units]       stg
            INNER JOIN
          [StageUser].VehicleDeviceProperties s  ON stg.AssetHostID = s.iVehicleID
            INNER JOIN
          Latest                               l  ON l.RID           = s.RID;


        ---------------------------------
        -- FirmwareVersion
        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser].VehicleDeviceProperties WITH (NOLOCK)
          WHERE
                ChangeDate  >= @startDate
            AND ChangeDate  <  @endDate
            AND liDeviceID   = 0
            AND sProperty    = 'DriverSetVersion'
          GROUP BY
            iVehicleID
        )
        UPDATE
          [StageUser].[STAGE_DIM_Units]
        SET
          UnitSerial = CASE
                         WHEN s.Operation = 'D' 
                           THEN 'D'
                         ELSE
                           s.sValue
                       END
        FROM
          [StageUser].[STAGE_DIM_Units]       stg
            INNER JOIN
          [StageUser].VehicleDeviceProperties s  ON stg.AssetHostID = s.iVehicleID
            INNER JOIN
          Latest                               l  ON l.RID           = s.RID;


        ---------------------------------
        -- FirmwareLoadedDateKey
        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser].VehicleDeviceProperties WITH (NOLOCK)
          WHERE
                ChangeDate  >= @startDate
            AND ChangeDate  <  @endDate
            AND liDeviceID   = 0
            AND sProperty    = 'DriverSetLoadDate'
          GROUP BY
            iVehicleID
        )
        UPDATE
          [StageUser].[STAGE_DIM_Units]
        SET
          UnitSerial = CASE
                         WHEN s.Operation = 'D' 
                           THEN 'D'
                         ELSE
                           s.sValue
                       END
        FROM
          [StageUser].[STAGE_DIM_Units]       stg
            INNER JOIN
          [StageUser].VehicleDeviceProperties s  ON stg.AssetHostID = s.iVehicleID
            INNER JOIN
          Latest                               l  ON l.RID           = s.RID;

        ---------------------------------
        -- AssetGUID/SiteGUID/UnitTypeLookupKey
        ;WITH
          Latest (RID) AS
            (
              SELECT
                MAX(RID)
              FROM
                [StageUser].Vehicles WITH (NOLOCK)
              WHERE
                ChangeDate      >= @startDate
                AND ChangeDate  <  @endDate
              GROUP BY
                iVehicleID
            )
        UPDATE
          [StageUser].[STAGE_DIM_Units]
        SET
          AssetGUID         = dvh.VehicleGUID,
          SiteGUID          = dvh.SiteGUID   ,
          UnitTypeLookupKey = dl.LookupRID
        FROM
          [StageUser].[STAGE_DIM_Units]           stg
            INNER JOIN
          [StageUser].Vehicles                    v   WITH (NOLOCK) ON stg.AssetHostID     = v.iVehicleID
            INNER JOIN
          Latest                                  l                 ON v.RID               = l.RID
            INNER JOIN
          [Control].UnitTypeLookups               utl WITH (NOLOCK) ON v.ucUnitType        = utl.UnitTypeID
            INNER JOIN
          [MiXData].dbo.DIM_TableColumnLookups dl  WITH (NOLOCK) ON dl.LookupKey        = utl.UnitTypeLookupKey
            INNER JOIN
          [MiXData].dbo.[DIM_Vehicles]         dvh WITH (NOLOCK) ON dvh.OrganisationKey = @organisationKey
                                                                   AND dvh.HostID          = stg.AssetHostID
        WHERE
            dl.LookupTable  = 'DIM_Units'
        AND dl.LookupColumn = 'UnitTypeLookupKey';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
      BEGIN TRY

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'4. Validation before Loading to DW';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck (Type 2)
  --------------------------------------------------------------------
      BEGIN TRY

        DELETE @merged;


        -- Update DW values that currently DOES have a UnitSerial (<> Not Available)
        INSERT INTO @merged
        (
          Operation            ,
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        )
        SELECT
          Operation            ,
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        FROM
          ( UPDATE
              [MiXData].[dbo].DIM_Units
            SET
              AssetHostID           = stg.AssetHostID          ,
              AssetGUID             = stg.AssetGUID            ,
              UnitTypeLookupKey     = stg.UnitTypeLookupKey    ,
              SiteGUID              = stg.SiteGUID             ,
              OSVersion             = CASE WHEN stg.OSVersion       = 'D' THEN ''              ELSE ISNULL(stg.OSVersion,'')       END,
              FirmwareVersion       = CASE WHEN stg.FirmwareVersion = 'D' THEN ''              ELSE ISNULL(stg.FirmwareVersion,'') END,
              FirmwareLoadedDateKey = ISNULL(stg.FirmwareLoadedDateKey,'00010101'),
              UTCOffsetKey          = @UTCOffsetKey            ,
              UpdateBatchKey        = @batchKey
            OUTPUT
              'UPDATE'  AS Operation       ,
              DELETED.UnitKey              ,
              DELETED.StartDateKey         ,
              DELETED.EndDateKey           ,
              DELETED.IsCurrentRecord      ,
              DELETED.IsActive             ,
              DELETED.OrganisationKey      ,
              DELETED.AssetHostID          ,
              DELETED.AssetTypeLookupKey   ,
              DELETED.UnitSerial           ,
              DELETED.AssetGUID            ,
              DELETED.UnitTypeLookupKey    ,
              DELETED.SiteGUID             ,
              DELETED.OSVersion            ,
              DELETED.FirmwareVersion      ,
              DELETED.FirmwareLoadedDateKey,
              DELETED.UTCOffsetKey         ,
              DELETED.CreateBatchKey       ,
              DELETED.UpdateBatchKey
            FROM
              [MiXData].[dbo].DIM_Units tar
                INNER JOIN
              [StageUser].STAGE_DIM_Units  stg ON tar.OrganisationKey = @organisationKey
                                              AND tar.UnitSerial      = ISNULL(stg.UnitSerial,'Not Available')
            WHERE
                tar.StartDateKey       = @StartDateKey
            AND tar.EndDateKey         = @endDateDefault
            AND tar.UnitSerial         <> 'Not Available'
            AND tar.AssetTypeLookupKey = @vehiclesLookupKey
          ) upd; 
   
        -- Update DW values that currently does NOT have a UnitSerial (= Not Available)
        INSERT INTO @merged
        (
          Operation            ,
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        )
        SELECT
          Operation            ,
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        FROM
          ( UPDATE
              [MiXData].[dbo].DIM_Units
            SET
              UnitSerial            = CASE WHEN stg.UnitSerial      = 'D' THEN 'Not Available' ELSE ISNULL(stg.UnitSerial,'Not Available') END,
              AssetGUID             = stg.AssetGUID            ,
              UnitTypeLookupKey     = stg.UnitTypeLookupKey    ,
              SiteGUID              = stg.SiteGUID             ,
              OSVersion             = CASE WHEN stg.OSVersion       = 'D' THEN ''              ELSE ISNULL(stg.OSVersion,'')       END,
              FirmwareVersion       = CASE WHEN stg.FirmwareVersion = 'D' THEN ''              ELSE ISNULL(stg.FirmwareVersion,'') END,
              FirmwareLoadedDateKey = ISNULL(stg.FirmwareLoadedDateKey,'00010101'),
              UTCOffsetKey          = @UTCOffsetKey            ,
              UpdateBatchKey        = @batchKey
            OUTPUT
              'UPDATE'  AS Operation       ,
              DELETED.UnitKey              ,
              DELETED.StartDateKey         ,
              DELETED.EndDateKey           ,
              DELETED.IsCurrentRecord      ,
              DELETED.IsActive             ,
              DELETED.OrganisationKey      ,
              DELETED.AssetHostID          ,
              DELETED.AssetTypeLookupKey   ,
              DELETED.UnitSerial           ,
              DELETED.AssetGUID            ,
              DELETED.UnitTypeLookupKey    ,
              DELETED.SiteGUID             ,
              DELETED.OSVersion            ,
              DELETED.FirmwareVersion      ,
              DELETED.FirmwareLoadedDateKey,
              DELETED.UTCOffsetKey         ,
              DELETED.CreateBatchKey       ,
              DELETED.UpdateBatchKey
            FROM
              [MiXData].[dbo].DIM_Units tar
                INNER JOIN
              [StageUser].STAGE_DIM_Units  stg ON tar.OrganisationKey = @organisationKey
                                              AND tar.AssetHostID     = stg.AssetHostID
            WHERE
                tar.StartDateKey       = @StartDateKey
            AND tar.EndDateKey         = @endDateDefault
            AND tar.UnitSerial         = 'Not Available'
            AND tar.AssetTypeLookupKey = @vehiclesLookupKey
            AND NOT EXISTS (SELECT 1
                            FROM
                              @merged m
                            WHERE m.AssetHostID = stg.AssetHostID)
          ) upd; 


        -- INSERT new Units
        INSERT INTO [MiXData].[dbo].DIM_Units
        (
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        )
        SELECT
          @startDateFirstInsert    ,
          @endDateDefault          ,
          1                        ,
          stg.IsActive             ,
          @organisationKey         ,
          stg.AssetHostID          ,
          stg.AssetTypeLookupKey   ,
          ISNULL(stg.UnitSerial    ,'Not Available'),
          stg.AssetGUID            ,
          stg.UnitTypeLookupKey    ,
          stg.SiteGUID             ,
          ISNULL(stg.OSVersion      ,''),
          ISNULL(stg.FirmwareVersion,''),
          ISNULL(stg.FirmwareLoadedDateKey,'00010101'),
          @UTCOffsetKey            ,
          @batchKey                ,
          @batchKey
        FROM
          [StageUser].STAGE_DIM_Units  stg
        WHERE
          NOT EXISTS (SELECT 1
                      FROM @merged m
                      WHERE m.AssetHostID = stg.AssetHostID)
        AND
          NOT EXISTS (SELECT 1
                      FROM @merged m
                      WHERE ISNULL(m.UnitSerial,'Not Available')  = ISNULL(stg.UnitSerial,'Not Available'));

        SELECT @recordsInserted += @@ROWCOUNT;
        
        INSERT INTO [StageUser].ROLLBACK_DIM_Units
        (
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        )
        SELECT
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          ISNULL(UnitSerial    ,'Not Available'),
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          ISNULL(OSVersion      ,''),
          ISNULL(FirmwareVersion,''),
          ISNULL(FirmwareLoadedDateKey,'00010101'),
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        FROM
          @merged
        WHERE
          Operation        = 'UPDATE'
          AND UpdateBatchKey < @batchKey; -- end insert
        SET @recordsUpdated += @@ROWCOUNT;
        
       IF @debugMode = 1
          PRINT '    after merge: rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

  --------------------------------------------------------------------
      -- type 2 changes -> first expire current
        DELETE @type2Keys;

        -- insert based on UnitSerial
        INSERT INTO @type2Keys
        SELECT
          tar.UnitKey     ,
          tar.AssetHostID ,
          tar.UnitSerial
        FROM
          [MiXData].[dbo].DIM_Units tar
            INNER JOIN
          [StageUser].STAGE_DIM_Units stg ON tar.OrganisationKey = @organisationKey
                                         AND tar.UnitSerial      = ISNULL(stg.UnitSerial,'Not Available')
        WHERE
               tar.UnitSerial             <> 'Not Available'
          AND  tar.StartDateKey           < @StartDateKey
          AND  tar.EndDateKey             = @endDateDefault
          AND  tar.AssetTypeLookupKey     = @vehiclesLookupKey
          AND (tar.AssetHostID            <> stg.AssetHostID
            OR ISNULL(tar.AssetGUID,'')   <> ISNULL(stg.AssetGUID,'')
            OR ISNULL(tar.SiteGUID,'')    <> ISNULL(stg.SiteGUID,'')
            OR tar.OSVersion              <> ISNULL(stg.OSVersion,'')
            OR tar.FirmwareVersion        <> ISNULL(stg.FirmwareVersion,'')
            OR tar.FirmwareLoadedDateKey  <> ISNULL(stg.FirmwareLoadedDateKey,'00010101')
            OR tar.IsActive               <> stg.IsActive
              );

        SET @rowcount = @@ROWCOUNT;

        -- insert based on AssetHostID
        INSERT INTO @type2Keys
        SELECT
          tar.UnitKey     ,
          tar.AssetHostID ,
          tar.UnitSerial
        FROM
          [MiXData].[dbo].DIM_Units tar
            INNER JOIN
          [StageUser].STAGE_DIM_Units stg ON tar.OrganisationKey = @organisationKey
                                         AND tar.AssetHostID     = stg.AssetHostID
        WHERE
               tar.UnitSerial            = 'Not Available'
          AND  tar.StartDateKey          < @StartDateKey
          AND  tar.EndDateKey            = @endDateDefault
          AND  tar.AssetTypeLookupKey    = @vehiclesLookupKey
          AND (tar.UnitSerial            <> ISNULL(stg.UnitSerial,'Not Available')
            OR ISNULL(tar.AssetGUID,'')  <> ISNULL(stg.AssetGUID,'')
            OR ISNULL(tar.SiteGUID,'')   <> ISNULL(stg.SiteGUID,'')
            OR tar.OSVersion             <> ISNULL(stg.OSVersion,'')
            OR tar.FirmwareVersion       <> ISNULL(stg.FirmwareVersion,'')
            OR tar.FirmwareLoadedDateKey <> ISNULL(stg.FirmwareLoadedDateKey,'00010101')
            OR tar.IsActive              <> stg.IsActive
              );

        SET @rowcount += @@ROWCOUNT;

        INSERT INTO [StageUser].ROLLBACK_DIM_Units
        (
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        )
        SELECT
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        FROM
         (
          UPDATE
            [MiXData].[dbo].DIM_Units
          SET
            EndDateKey      = @previousEndDateKey,
            IsCurrentRecord = 0,
            UpdateBatchKey  = @batchKey
          OUTPUT
            DELETED.UnitKey              ,
            DELETED.StartDateKey         ,
            DELETED.EndDateKey           ,
            DELETED.IsCurrentRecord      ,
            DELETED.IsActive             ,
            DELETED.OrganisationKey      ,
            DELETED.AssetHostID          ,
            DELETED.AssetTypeLookupKey   ,
            DELETED.UnitSerial           ,
            DELETED.AssetGUID            ,
            DELETED.UnitTypeLookupKey    ,
            DELETED.SiteGUID             ,
            DELETED.OSVersion            ,
            DELETED.FirmwareVersion      ,
            DELETED.FirmwareLoadedDateKey,
            DELETED.UTCOffsetKey         ,
            DELETED.CreateBatchKey       ,
            DELETED.UpdateBatchKey
          FROM
            [MiXData].[dbo].DIM_Units tar
              INNER JOIN 
            @type2Keys                   k ON tar.UnitKey = k.UnitKey
          ) AS RollBck              -- end update
        WHERE
          UpdateBatchKey < @batchKey; -- end insert

        -- Insert new Records for Type 2 changes
        INSERT INTO [MiXData].[dbo].DIM_Units
        (
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        )
        SELECT
          @startDateFirstInsert    ,
          @endDateDefault          ,
          1                        ,
          stg.IsActive             ,
          @organisationKey         ,
          stg.AssetHostID          ,
          stg.AssetTypeLookupKey   ,
          ISNULL(stg.UnitSerial    ,'Not Available'),
          stg.AssetGUID            ,
          stg.UnitTypeLookupKey    ,
          stg.SiteGUID             ,
          ISNULL(stg.OSVersion            ,''),
          ISNULL(stg.FirmwareVersion      ,''),
          ISNULL(stg.FirmwareLoadedDateKey,'00010101'),
          @UTCOffsetKey            ,
          @batchKey                ,
          @batchKey
        FROM
          [StageUser].STAGE_DIM_Units stg
            INNER JOIN 
          @type2Keys                  k ON stg.AssetHostID = k.AssetHostID;
        SET @recordsType2Inserted += @@ROWCOUNT;

        IF @debugMode = 1
          PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

      SELECT
        @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
      FROM
        @sourceChangeDates
      WHERE
        ChangeDate >= @endDate;

    IF @debugMode = 1  -- DebugMode is true
      PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'
    
    END -- END WHILE


  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------
  BEGIN TRY


    IF @debugMode = 1  -- DebugMode is true
      PRINT N'6. Update Type 1 columns on DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_DIM_Units];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;
  
  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_UTCOffsetsLookup_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates STAGE_DIM_UTCOffsetsLookup - Purely used for UTC lookups in FACT tables
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_UTCOffsetsLookup_Transform]
( 
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int = 0;
  DECLARE @recordsUpdated  int = 0;
  DECLARE @recordsDeleted  int = 0;
  DECLARE @validationCount int = 0;

  DECLARE @defaultStartDateTime datetimeoffset(0) = '19000101';
  DECLARE @defaultTime          time(0)           = '00:00:00';

  DECLARE @startDateKey              date;
  DECLARE @endDateKey                date;
  DECLARE @UTCOffsetMinutes          int;
  DECLARE @prevEndDateTime           datetimeoffset(0);
  DECLARE @seasonYear                int;
  DECLARE @DayLightStartDateTime     datetimeoffset(0);
  DECLARE @DayLightStartTime         time(0);
  DECLARE @DayLightEndDateTime       datetimeoffset(0);
  DECLARE @DayLightEndTime           time(0);
  DECLARE @adjustementUTCOffsetKey   int;
  DECLARE @standardUTCOffsetMinutes  int;
  DECLARE @standardUTCOffsetKey      int;
  DECLARE @lpDate                    datetimeoffset(0);

  DECLARE @lpAdjustmentStartDateTime datetimeoffset(0);
  DECLARE @lpAdjustmentEndDateTime   datetimeoffset(0);
  DECLARE @lpStandardStartDateTime   datetimeoffset(0);
  DECLARE @lpStandardEndDateTime     datetimeoffset(0);

  DECLARE @TmpSCD table
  (
    RID                           int identity(1,1)   NOT NULL,
    UTCOffsetKey                  int                 NOT NULL,
    AdjustmentType                nvarchar (10)       NULL,
    StartDateKey                  date                NULL,
    EndDateKey                    date                NULL,
    StartDateTime                 datetimeoffset (0)  NULL,
    EndDateTime                   datetimeoffset (0)  NULL,
    DaylightStartDateTime         datetimeoffset (0)  NULL,
    DaylightEndDateTime           datetimeoffset (0)  NULL,
    UTCOffsetMinutes              smallint            NULL,
    Processed                     bit                 NOT NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].STAGE_DIM_UTCOffsetsLookUp;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_DIM_UTCOffsetsLookup]') AND name = N'IX_STAGE_DIM_UTCOffsetsLookup')
      DROP INDEX IX_STAGE_DIM_UTCOffsetsLookup ON [StageUser].STAGE_DIM_UTCOffsetsLookup;


    -- Get Organisations UTCOffset SCD records
    INSERT INTO @TmpSCD
    (
      UTCOffsetKey         ,
      AdjustmentType       ,
      StartDateKey         ,
      EndDateKey           ,
      DaylightStartDateTime,
      DaylightEndDateTime  ,
      UTCOffsetMinutes     ,
      Processed            
    )
    SELECT
      UTCOffsetKey  ,
      AdjustmentType,
      StartDateKey  ,
      EndDateKey    ,
      TODATETIMEOFFSET(DaylightStart,CONVERT(INT,ISNULL(UTCOffsetMinutes,0))),
      TODATETIMEOFFSET(DaylightEnd  ,CONVERT(INT,ISNULL(UTCOffsetMinutes,0))),
      UTCOffsetMinutes,
      Processed = 0
    FROM
      [MiXData].dbo.DIM_UTCOffsets
    WHERE
      OrganisationKey = @organisationKey
    ORDER BY
      StartDateKey,AdjustmentType;

    -- START Loop through SCD records (1 StartDateKey will be processed at a time)
    WHILE EXISTS (SELECT 1 FROM @TmpSCD WHERE Processed = 0)
    BEGIN

      -- get first StartDateKey to process
      SELECT @startDateKey = MIN(StartDateKey)
      FROM @TmpSCD
      WHERE Processed = 0;

      -------------------------------------
      -- get UTCOffset details

      -- Adjustment details
      SELECT
        @endDateKey              = EndDateKey,
        @UTCOffsetMinutes        = UTCOffsetMinutes,
        @DayLightStartDateTime   = DaylightStartDateTime,
        @DayLightStartTime       = CONVERT(time(0),DaylightStartDateTime),
        @DayLightEndDateTime     = DaylightEndDateTime,
        @DayLightEndTime         = CONVERT(time(0),DaylightEndDateTime),
        @adjustementUTCOffsetKey = UTCOffsetKey
      FROM @TmpSCD
      WHERE
          StartDateKey = @startDateKey
      AND AdjustmentType = 'Adjustment';
      
      -- Standard details
      SELECT
        @standardUTCOffsetMinutes = UTCOffsetMinutes,
        @standardUTCOffsetKey     = UTCOffsetKey
      FROM @TmpSCD
      WHERE
          StartDateKey = @startDateKey
      AND AdjustmentType = 'Standard';

      --  Calc PrevEndDateTime
      IF @startDateKey > '00010101'
      BEGIN
        SELECT
          @prevEndDateTime = EndDateTime
        FROM @TmpSCD
        WHERE
            EndDateKey = DATEADD(DAY,-1,@startDateKey)
        AND AdjustmentType = 'Adjustment';
      END;
  
      -- Populate StartDateTime/EndDateTime's
      UPDATE
        @TmpSCD
      SET
        StartDateTime =  CASE
                           WHEN StartDateKey = '00010101'
                             THEN '0001-01-01 00:00:00.0000000 +00:00'
                           ELSE
                             DATEADD(s,1,@prevEndDateTime)
                         END,
        EndDateTime   = CASE
                           WHEN EndDateKey = '00010101'
                             THEN '0001-01-01 00:00:00.0000000 +00:00'
                           ELSE
                             DATEADD(s,-1,DATEADD(day,1,TODATETIMEOFFSET(CONVERT(DATETIME,EndDateKey)+ ISNULL(@DayLightEndTime,@defaultTime),@UTCOffsetMinutes)))
                         END
      WHERE
        StartDateKey = @StartDateKey;


      -------------------------------------
      -- populate STAGE table


      -- if no daylight savings specified or OffsetMinutes for both are set the same, only insert standard offset
      IF ((@DayLightStartDateTime IS NULL) OR (ISNULL(@standardUTCOffsetMinutes,0) = ISNULL(@UTCOffsetMinutes,0)))
      BEGIN
        INSERT INTO [StageUser].STAGE_DIM_UTCOffsetsLookup
        (
          UTCOffsetKey,
          OffsetYear,
          StartDateKey,
          EndDateKey,
          StartDateTime,
          EndDateTime,
          SeasonStartDateTime,
          SeasonEndDateTime,
          UTCOffsetMinutes,
          AdjustmentType
        )
        SELECT
          @standardUTCOffsetKey,
          2050,
          StartDateKey,
          EndDateKey,
          StartDateTime,
          EndDateTime,
          StartDateTime,
          EndDateTime,
          @standardUTCOffsetMinutes,
          'Standard'
        FROM
          @TmpSCD
        WHERE
          UTCOffsetKey = @adjustementUTCOffsetKey;
      END  -- end if Standard Only
      ELSE
      BEGIN  -- Adjustments Enabled
        SELECT @seasonYear = 1980;
        
        -- Loop through Seasons
        WHILE (@seasonYear < 2051)
        BEGIN
          
          -- Northern Hemisphere
          IF ((MONTH(@DayLightStartDateTime)        < MONTH(@DayLightEndDateTime))
          OR (MONTH(@DayLightStartDateTime)         = MONTH(@DayLightEndDateTime) 
          AND DAY(@DayLightStartDateTime)          <= DAY(@DayLightEndDateTime)
          AND CONVERT(TIME,@DayLightStartDateTime) <= CONVERT(TIME,@DayLightStartDateTime)))
          BEGIN
            SELECT
              @lpAdjustmentStartDateTime = DATEADD(YEAR,-(YEAR(@DayLightStartDateTime) - @seasonYear),@DayLightStartDateTime),
              @lpAdjustmentEndDateTime   = DATEADD(YEAR,-(YEAR(@DayLightEndDateTime)   - @seasonYear),@DayLightEndDateTime);
              
          END
          -- Southern Hemisphere
          ELSE
          BEGIN
            SELECT
              @lpAdjustmentStartDateTime = DATEADD(YEAR,-(YEAR(@DayLightStartDateTime) - @seasonYear+1),@DayLightStartDateTime),
              @lpAdjustmentEndDateTime   = DATEADD(YEAR,-(YEAR(@DayLightEndDateTime)   - @seasonYear),@DayLightEndDateTime);
          END;

          SELECT
            @lpStandardStartDateTime = DATEADD(s, 1,DATEADD(YEAR,-1,@lpAdjustmentEndDateTime)),
            @lpStandardEndDateTime   = DATEADD(s,-1,@lpAdjustmentStartDateTime);

          IF ((@seasonYear = 1980) AND (@lpStandardEndDateTime > @startDateKey))
          BEGIN
            INSERT INTO [StageUser].STAGE_DIM_UTCOffsetsLookup
            (
              UTCOffsetKey,
              OffsetYear,
              StartDateKey,
              EndDateKey,
              StartDateTime,
              EndDateTime,
              SeasonStartDateTime,
              SeasonEndDateTime,
              UTCOffsetMinutes,
              AdjustmentType
            )
            SELECT
              @standardUTCOffsetKey,
              1980,
              StartDateKey,
              EndDateKey,
              StartDateTime,
              EndDateTime,
              StartDateTime,
              @lpAdjustmentEndDateTime,
              @standardUTCOffsetMinutes,
              'Standard'
            FROM
              @TmpSCD
            WHERE
              UTCOffsetKey = @adjustementUTCOffsetKey;

          END  -- end if @seasonYear = 1980
          ELSE
          BEGIN -- @seasonYear > 1980

            -- insert Standard
            INSERT INTO [StageUser].STAGE_DIM_UTCOffsetsLookup
            (
              UTCOffsetKey,
              OffsetYear,
              StartDateKey,
              EndDateKey,
              StartDateTime,
              EndDateTime,
              SeasonStartDateTime,
              SeasonEndDateTime,
              UTCOffsetMinutes,
              AdjustmentType
            )
            SELECT
              @standardUTCOffsetKey,
              @seasonYear,
              StartDateKey,
              EndDateKey,
              StartDateTime,
              EndDateTime,

              @lpStandardStartDateTime,
              @lpStandardEndDateTime,

              @standardUTCOffsetMinutes,
              'Standard'
            FROM
              @TmpSCD
            WHERE
              UTCOffsetKey = @adjustementUTCOffsetKey;

            -- insert Adjustment
            INSERT INTO [StageUser].STAGE_DIM_UTCOffsetsLookup
            (
              UTCOffsetKey,
              OffsetYear,
              StartDateKey,
              EndDateKey,
              StartDateTime,
              EndDateTime,
              SeasonStartDateTime,
              SeasonEndDateTime,
              UTCOffsetMinutes,
              AdjustmentType
            )
            SELECT
              @standardUTCOffsetKey,
              @seasonYear,
              StartDateKey,
              EndDateKey,
              StartDateTime,
              EndDateTime,

              @lpAdjustmentStartDateTime,
              @lpAdjustmentEndDateTime,

              @UTCOffsetMinutes,
              'Adjustment'
            FROM
              @TmpSCD
            WHERE
              UTCOffsetKey = @adjustementUTCOffsetKey;

          END; -- end if @seasonYear > 1980

          SELECT @seasonYear = @seasonYear + 1;
        END; -- end while SeasonYears Loop
      END; -- end if Adjustments Enabled


      --------------------------------------
      -- update Loop table
      UPDATE @TmpSCD
      SET Processed = 1
      WHERE StartDateKey = @startDateKey;

    END; -- end while SCD

    -----------------------------------
    -- remove out of boundary values
    DELETE [StageUser].STAGE_DIM_UTCOffsetsLookup
    WHERE
        (SeasonStartDateTime < StartDateTime 
    AND  SeasonEndDateTime   < StartDateTime)
    OR  (SeasonStartDateTime > EndDateTime 
    AND  SeasonEndDateTime   > EndDateTime);

    -- create index
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_DIM_UTCOffsetsLookup]') AND name = N'IX_STAGE_DIM_UTCOffsetsLookup')
      CREATE NONCLUSTERED INDEX IX_STAGE_DIM_UTCOffsetsLookup
        ON [StageUser].STAGE_DIM_UTCOffsetsLookup(StartDateTime,EndDateTime,SeasonStartDateTime,SeasonEndDateTime,StartDateKey,EndDateKey)
        INCLUDE (UTCOffsetKey,UTCOffsetMinutes);

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'2. Add to STG';

  --------------------------------------------------------------------
  -- 3. Cleanup work tables
  --------------------------------------------------------------------
  -- table gets used for lookups on all fact tables thus needs to be there till the end

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'3. Cleanup work tables'

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    -- Validation to ensure their is records populated
    SELECT
      @recordsInserted = ISNULL(COUNT(1),0)
    FROM
      [StageUser].STAGE_DIM_UTCOffsetsLookUp WITH (NOLOCK);

    IF ISNULL(@recordsInserted,0) < 1
    BEGIN
      RAISERROR(N'No DIM_UTCOffsetsLookup values populated',16,1);
    END

    -- Validation to ensure that at least the current date returns exactly one record
    SELECT
      @validationCount = ISNULL(COUNT(1),0)
    FROM
      [StageUser].STAGE_DIM_UTCOffsetsLookUp utc WITH (NOLOCK)
    WHERE
        SYSUTCDATETIME() BETWEEN utc.StartDateTime       AND utc.EndDateTime
    AND SYSUTCDATETIME() BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    IF ISNULL(@validationCount,0) <> 1
    BEGIN
      RAISERROR(N'Duplicate DIM_UTCOffsetsLookup values populated',16,1);
    END

    -- Validation to ensure a valid daylight savings is being setup
    SELECT
      @validationCount = ISNULL(COUNT(1),0)
    FROM
      [StageUser].STAGE_DIM_UTCOffsetsLookUp WITH (NOLOCK)
	WHERE SeasonStartDateTime = SeasonEndDateTime;

    IF ISNULL(@validationCount,0) > 0
    BEGIN
      RAISERROR(N'Invalid Daylight Savings values in DIM_UTCOffsetsLookup populated',16,1);
    END

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW:' + convert(nvarchar(15),@organisationKey);

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT @recordsUpdated = 0;

  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = 0,  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'5. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- end proc

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_VehicleCostCategories_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_VehicleCostCategories on DW (contains all the cost catogories)
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_VehicleCostCategories_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_DIM_VehicleCostCategories];
  TRUNCATE TABLE [StageUser].[ROLLBACK_DIM_VehicleCostCategories];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create source table indexes
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser].ExtensionProperties_DIM') AND name = N'IX_ExtensionProperties_DIM_sAppID_sProperty_liObjectType')
      CREATE NONCLUSTERED INDEX IX_ExtensionProperties_DIM_sAppID_sProperty_liObjectType
        ON [StageUser].ExtensionProperties_DIM(sAppID,sProperty,liObjectType)
        INCLUDE (liObjectID,sValue);

    -- insert existing event groups
     ;WITH LastCosting (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser].ExtensionProperties_DIM s WITH (NOLOCK)
          WHERE
                s.sAppID       = 'Costing'
            AND s.sProperty    = 'Name'
            AND s.liObjectType = 10000
          GROUP BY
            sAppID,
            sProperty,
            liObjectType,
            liObjectID 
          )
	  INSERT INTO [StageUser].[STAGE_DIM_VehicleCostCategories]
	  (
	    [Operation]   ,
	    [HostID]      ,
	    [CategoryName]
	  )
	  SELECT 
	    s.Operation ,
        s.liObjectID,
        s.sValue
	  FROM
	    [StageUser].ExtensionProperties_DIM s WITH (NOLOCK)
	    INNER JOIN LastCosting lc ON s.RID = lc.RID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -----------------------------------------
    -- CategoryNotes
    UPDATE
      [StageUser].[STAGE_DIM_VehicleCostCategories]
    SET
      CategoryNotes = s.sValue
    FROM
      [StageUser].[STAGE_DIM_VehicleCostCategories] stg
        INNER JOIN
	    [StageUser].ExtensionProperties_DIM s WITH (NOLOCK) ON  stg.HostID = s.liObjectID
    WHERE
        s.sAppID       = 'Costing'
    AND s.sProperty    = 'DefMemo'
    AND s.liObjectType = 10000;

    -----------------------------------------
    -- Type
    -- ?? ToDo: look at Type description, only storing int
    UPDATE
      [StageUser].[STAGE_DIM_VehicleCostCategories]
    SET
      Type = s.sValue
    FROM
      [StageUser].[STAGE_DIM_VehicleCostCategories] stg
        INNER JOIN
	    [StageUser].ExtensionProperties_DIM s WITH (NOLOCK) ON  stg.HostID = s.liObjectID
    WHERE
        s.sAppID       = 'Costing'
    AND s.sProperty    = 'Type'
    AND s.liObjectType = 10000;

    -----------------------------------------
    -- IsRecurring
    UPDATE
      [StageUser].[STAGE_DIM_VehicleCostCategories]
    SET
      IsRecurring = CONVERT(BIT,s.sValue)
    FROM
      [StageUser].[STAGE_DIM_VehicleCostCategories] stg
        INNER JOIN
	    [StageUser].ExtensionProperties_DIM s WITH (NOLOCK) ON  stg.HostID = s.liObjectID
    WHERE
        s.sAppID       = 'Costing'
    AND s.sProperty    = 'Recurring'
    AND s.liObjectType = 10000;

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Add to RollBck table
    INSERT INTO [StageUser].[ROLLBACK_DIM_VehicleCostCategories]
    ( 
      [VehicleCostCategoryKey],
      [OrganisationKey]       ,
      [HostID]                ,
      [CategoryName]          ,
      [CategoryNotes]         ,
      [Type]                  ,
      [IsRecurring]           ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    )
    SELECT
      [VehicleCostCategoryKey],
      [OrganisationKey]       ,
      [HostID]                ,
      [CategoryName]          ,
      [CategoryNotes]         ,
      [Type]                  ,
      [IsRecurring]           ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    FROM 
     (MERGE [MiXData].dbo.DIM_VehicleCostCategories     AS tar
      USING [StageUser].[STAGE_DIM_VehicleCostCategories] AS stg
       ON  tar.OrganisationKey   = @organisationKey
       AND tar.[HostID]          = stg.[HostID]
      WHEN MATCHED
      THEN
        UPDATE 
        SET tar.[CategoryName]   =  stg.[CategoryName] ,
            tar.[CategoryNotes]  =  stg.[CategoryNotes],
            tar.[Type]           =  stg.[Type]         ,
            tar.[IsRecurring]    =  stg.[IsRecurring]  ,
            tar.[UpdateBatchKey] =  @batchKey

      -- Not Matched
      WHEN NOT MATCHED THEN
        INSERT
        ( 
          [OrganisationKey]       ,
          [HostID]                ,
          [CategoryName]          ,
          [CategoryNotes]         ,
          [Type]                  ,
          [IsRecurring]           ,
          [CreateBatchKey]        ,
          [UpdateBatchKey]
        )
        VALUES
        (
          @organisationKey   ,
          stg.[HostID]       ,
          stg.[CategoryName] ,
          stg.[CategoryNotes],
          stg.[Type]         ,
          stg.[IsRecurring]  ,
          @batchKey          ,
          @batchKey
        )
      OUTPUT 
        $action   AS Operation          ,
        DELETED.[VehicleCostCategoryKey],
        DELETED.[OrganisationKey]       ,
        DELETED.[HostID]                ,
        DELETED.[CategoryName]          ,
        DELETED.[CategoryNotes]         ,
        DELETED.[Type]                  ,
        DELETED.[IsRecurring]           ,
        DELETED.[CreateBatchKey]        ,
        DELETED.[UpdateBatchKey]
      ) AS RollBck              -- end merge
    WHERE
      Operation        = 'UPDATE'; -- end insert

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_DIM_VehicleCostCategories];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsUpdated = count(1)
  FROM
    [MiXData].dbo.DIM_VehicleCostCategories WITH (NOLOCK)
  WHERE
      OrganisationKey = @organisationKey
  AND UpdateBatchKey  = @batchKey;

  SELECT
    @recordsInserted = count(1)
  FROM
    [MiXData].dbo.DIM_VehicleCostCategories WITH (NOLOCK)
  WHERE
      OrganisationKey = @organisationKey
  AND CreateBatchKey  = @batchKey;
  
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = (isnull(@recordsUpdated,0) - isnull(@recordsInserted,0)),  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_VehicleDeviceParameters_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_VehicleDeviceParameters on DW (details of VehicleDevices)
--
--  Dependencies:
--    DIM_CalibrationParameters
--    DIM_Devices
--    DIM_Vehicles
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_VehicleDeviceParameters_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
) AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;
  DECLARE @nrOfValidationErrors   int = 0;


  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                     nvarchar (10)       NOT NULL,
    VehicleDeviceParameterKey     int                 NOT NULL,
    OrganisationKey               int                 NOT NULL,
    VehicleGUID                   uniqueidentifier    NOT NULL,
    DeviceKey                     int                 NOT NULL,
    ParameterKey                  int                 NULL,
    IsDeviceDefault               bit                 NULL,
    IsParameterDefault            bit                 NULL,
    CalibrationType               tinyint             NULL,
    CalibrationProperties         xml                 NULL,
    CreateBatchKey                int                 NULL,
    UpdateBatchKey                int                 NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].ROLLBACK_DIM_VehicleDeviceParameters;
  TRUNCATE TABLE [StageUser].STAGE_DIM_VehicleDeviceParameters;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared for processing'

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------


  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

  --first all the VehicleDeviceParam records:
    INSERT INTO [StageUser].STAGE_DIM_VehicleDeviceParameters
    (
      VehicleHostID,
      DeviceHostID,
      ParameterHostID,
      IsDeviceDefault,
      IsParameterDefault,
      CalibrationType,
      CalibrationProperties
    )
    SELECT
      s.VehicleID,
      s.DeviceID,
      s.ParameterID,
      s.IsDeviceDefault,
      s.IsParameterDefault,
      s.CalibrationType,
      CASE
        WHEN Value1 IS NULL AND Value2 IS NULL THEN
          NULL
        ELSE
          '<calibration>' +
          CASE WHEN s.CalibrationType = 1 THEN -- Boolean:
            '<threshold>' + CONVERT(nvarchar, Calibration1, 0) + '</threshold><operator>' + CONVERT(nvarchar, Value1, 0) + '</operator>'
          ELSE
            ISNULL('<point1><calibration>' + CONVERT(nvarchar, s.Calibration1, 0) + '</calibration><value>' + CONVERT(nvarchar, s.Value1, 0) + '</value></point1>', '') +
            ISNULL('<point2><calibration>' + CONVERT(nvarchar, s.Calibration2, 0) + '</calibration><value>' + CONVERT(nvarchar, s.Value2, 0) + '</value></point2>', '')
          END +
          '</calibration>'
      END
    FROM
      [StageUser].DeviceParam_VehicleDeviceParam s WITH (NOLOCK)
    SET @rowcount += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

  ------------------------------------------
  -- VehicleGUID
    UPDATE
      [StageUser].STAGE_DIM_VehicleDeviceParameters
    SET
      VehicleGUID     = v.VehicleGUID
    FROM
      [StageUser].STAGE_DIM_VehicleDeviceParameters stg
      INNER JOIN [MiXData].[dbo].DIM_Vehicles v WITH (NOLOCK) ON @organisationKey  = v.OrganisationKey
                                                                AND stg.VehicleHostID = v.HostID
                                                                AND v.IsCurrentRecord = 1;

  ------------------------------------------
  -- DeviceKey
    UPDATE
      [StageUser].STAGE_DIM_VehicleDeviceParameters
    SET
      DeviceKey     = d.DeviceKey
    FROM
      [StageUser].STAGE_DIM_VehicleDeviceParameters stg
      INNER JOIN [MiXData].[dbo].DIM_Devices d WITH (NOLOCK) ON @organisationKey = d.OrganisationKey
                                                               AND stg.DeviceHostID = d.HostID;

  ------------------------------------------
  -- ParameterKey
    UPDATE
      [StageUser].STAGE_DIM_VehicleDeviceParameters
    SET
      ParameterKey  = p.ParameterKey
    FROM
      [StageUser].STAGE_DIM_VehicleDeviceParameters stg
      INNER JOIN [MiXData].[dbo].DIM_CalibrationParameters p WITH (NOLOCK) ON @organisationKey    = p.OrganisationKey
                                                                             AND stg.ParameterHostID = p.HostID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

--------------------------------------------------------------------
-- 4. Validation before Loading to DW
--------------------------------------------------------------------

  -- VehicleGUID is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser].STAGE_DIM_VehicleDeviceParameters  
    WHERE VehicleGUID IS NULL;
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some VehicleDeviceParameters does not have associated DIM_Vehicles records available',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.1 Validation before Loading to DW (VehicleGUID is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;  

  -- DeviceKey is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser].STAGE_DIM_VehicleDeviceParameters  
    WHERE DeviceKey IS NULL;
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some VehicleDeviceParameters does not have associated DIM_Devices records available',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.2 Validation before Loading to DW (DeviceKey is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;  

  -- Remove dirty data
  BEGIN TRY  

    DELETE
      [StageUser].STAGE_DIM_VehicleDeviceParameters
    WHERE
       VehicleGUID IS NULL
    OR DeviceKey   IS NULL;

  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
  END CATCH;

--------------------------------------------------------------------
    -- 5. MERGE to DW (Load) and add to RollBck
--------------------------------------------------------------------

  BEGIN TRY
    MERGE INTO [MiXData].[dbo].DIM_VehicleDeviceParameters tar
      USING [StageUser].STAGE_DIM_VehicleDeviceParameters stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.VehicleGUID     = stg.VehicleGUID
        AND tar.DeviceKey       = stg.DeviceKey
        AND tar.ParameterKey    = stg.ParameterKey
      WHEN MATCHED THEN
        UPDATE SET
          IsDeviceDefault       = stg.IsDeviceDefault,
          IsParameterDefault    = stg.IsParameterDefault,
          CalibrationType       = stg.CalibrationType,
          CalibrationProperties = stg.CalibrationProperties,
          UpdateBatchKey        = @batchKey
      WHEN NOT MATCHED THEN
        INSERT
        (
          OrganisationKey,
          VehicleGUID,
          DeviceKey,
          ParameterKey,
          IsDeviceDefault,
          IsParameterDefault,
          CalibrationType,
          CalibrationProperties,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.VehicleGUID,
          stg.DeviceKey,
          stg.ParameterKey,
          stg.IsDeviceDefault,
          stg.IsParameterDefault,
          stg.CalibrationType,
          stg.CalibrationProperties,
          @batchKey,
          @batchKey
        )
        OUTPUT
          $action   AS Operation,
          ISNULL(DELETED.VehicleDeviceParameterKey, INSERTED.VehicleDeviceParameterKey),
          ISNULL(DELETED.OrganisationKey,INSERTED.OrganisationKey),
          ISNULL(DELETED.VehicleGUID, INSERTED.VehicleGUID),
          ISNULL(DELETED.DeviceKey, INSERTED.DeviceKey),
          ISNULL(DELETED.ParameterKey, INSERTED.ParameterKey),
          ISNULL(DELETED.IsDeviceDefault, INSERTED.IsDeviceDefault),
          ISNULL(DELETED.IsParameterDefault, INSERTED.IsParameterDefault),
          ISNULL(DELETED.CalibrationType, INSERTED.CalibrationType),
          DELETED.CalibrationProperties,
          ISNULL(DELETED.CreateBatchKey,INSERTED.CreateBatchKey),
          ISNULL(DELETED.UpdateBatchKey,INSERTED.UpdateBatchKey)
        INTO
          @merged;

    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merged
    WHERE
      Operation = 'INSERT';

    -- Add to RollBck table
    INSERT INTO [StageUser].ROLLBACK_DIM_VehicleDeviceParameters
    (
      VehicleDeviceParameterKey,
      OrganisationKey,
      VehicleGUID,
      DeviceKey,
      ParameterKey,
      IsDeviceDefault,
      IsParameterDefault,
      CalibrationType,
      CalibrationProperties,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      VehicleDeviceParameterKey,
      OrganisationKey,
      VehicleGUID,
      DeviceKey,
      ParameterKey,
      IsDeviceDefault,
      IsParameterDefault,
      CalibrationType,
      CalibrationProperties,
      CreateBatchKey,
      UpdateBatchKey
    FROM
      @merged
    WHERE
      Operation = 'UPDATE';
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------

  --IF @debugMode = 1  -- DebugMode is true
    --PRINT N'6. Update Type 1 columns on DW';

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].STAGE_DIM_VehicleDeviceParameters;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';

  --------------------------------------------------------------------

  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_VehicleDevices_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_VehicleDevices on DW (details of VehicleDevices)
--
--  Dependencies:
--    DIM_Devices
--    DIM_Vehicles
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_VehicleDevices_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
) AS
BEGIN
  SET NOCOUNT ON;


  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;
  DECLARE @nrOfValidationErrors   int = 0;


  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                     nvarchar (10)     NOT NULL,
    VehicleDeviceKey              int               NOT NULL,
    OrganisationKey               int               NULL,
    VehicleGUID                   uniqueidentifier  NOT NULL,
    DeviceKey                     int               NOT NULL,
    InputLine                     char (2)          NULL,
    DeviceProperties              xml               NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].ROLLBACK_DIM_VehicleDevices;
  TRUNCATE TABLE [StageUser].STAGE_DIM_VehicleDevices;
  TRUNCATE TABLE [StageUser].STAGE_VehicleDeviceProperties;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    ;WITH LatestVehicleDevice (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser].VehicleDevices WITH (NOLOCK)
      GROUP BY
        iVehicleID,
        liDeviceID
    )
    INSERT INTO [StageUser].STAGE_DIM_VehicleDevices
    (
      VehicleHostID,
      DeviceHostID,
      PowerDeviceHostID,
      RecordInterval,
      InputLine
    )
    SELECT
      s.iVehicleID,
      s.liDeviceID,
      s.liPowerDeviceID,
      s.bRecordInterval,
      CASE
        WHEN s.bIsActive = 1 AND s.sInputID IS NOT NULL THEN
          s.sInputID
        ELSE
          NULL
      END
    FROM
      [StageUser].VehicleDevices s WITH (NOLOCK)
        INNER JOIN
      LatestVehicleDevice l ON s.RID = MaxRID;
    SET @rowcount = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

  ------------------------------------------
  -- VehicleGUID
    UPDATE
      [StageUser].STAGE_DIM_VehicleDevices
    SET
      VehicleGUID     = v.VehicleGUID
    FROM
      [StageUser].STAGE_DIM_VehicleDevices stg
        INNER JOIN
      [MiXData].[dbo].DIM_Vehicles v WITH (NOLOCK) ON @organisationKey  = v.OrganisationKey
                                                     AND stg.VehicleHostID = v.HostID
                                                     AND v.IsCurrentRecord = 1;

  ------------------------------------------
  -- DeviceKey
    UPDATE
      [StageUser].STAGE_DIM_VehicleDevices
    SET
      DeviceKey     = d.DeviceKey
    FROM
      [StageUser].STAGE_DIM_VehicleDevices stg
        INNER JOIN
      [MiXData].[dbo].DIM_Devices d WITH (NOLOCK) ON @organisationKey = d.OrganisationKey
                                                    AND stg.DeviceHostID = d.HostID;

  ------------------------------------------
  -- prepare the properties:
  
    ;WITH LatestProperties (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser].VehicleDeviceProperties prop WITH (NOLOCK)
      GROUP BY
        iVehicleID,
        liDeviceID,
        sProperty
    )
    , CombinedIntervals (VehicleHostID, DeviceHostID, PropertyName, Operation, PropertyValue) AS
    (
      SELECT
        s.iVehicleID,
        s.liDeviceID,
        s.sProperty,
        s.Operation,
        s.sValue
      FROM
        [StageUser].VehicleDeviceProperties s WITH (NOLOCK)
          INNER JOIN
        LatestProperties l ON s.RID = l.MaxRID
    UNION ALL
      SELECT
        stg.VehicleHostID,
        stg.DeviceHostID,
        'RecordInterval',
        '?',
        CONVERT(nvarchar(1), stg.RecordInterval)
      FROM
        [StageUser].STAGE_DIM_VehicleDevices stg
      WHERE
        stg.InputLine != 'U0'
    UNION ALL
      SELECT
        stg.VehicleHostID,
        stg.DeviceHostID,
        'PowerDeviceKey',
        '?',
        CONVERT(nvarchar, d.DeviceKey)
      FROM
        [StageUser].STAGE_DIM_VehicleDevices stg
          INNER JOIN
        [MiXData].[dbo].DIM_Devices d WITH (NOLOCK) ON @organisationKey      = d.OrganisationKey
                                                      AND stg.PowerDeviceHostID = d.HostID
    )
    INSERT INTO [StageUser].STAGE_VehicleDeviceProperties
    (
      VehicleHostID,
      DeviceHostID,
      PropertyName,
      Operation,
      PropertyValue
    )
    SELECT
      VehicleHostID,
      DeviceHostID,
      PropertyName,
      Operation,
      PropertyValue
    FROM
      CombinedIntervals;

  -- ensure that there is a staged VehicleDevice record for each Property changed
    IF EXISTS ( SELECT *
                FROM
                  [StageUser].STAGE_VehicleDeviceProperties p
                    LEFT JOIN
                  [StageUser].STAGE_DIM_VehicleDevices d ON p.VehicleHostID = d.VehicleHostID
                                                        AND p.DeviceHostID  = d.DeviceHostID
                WHERE
                  d.VehicleHostID IS NULL)
      BEGIN
        WITH missingVehicleDevices (VehicleHostID, DeviceHostID) AS
        (
          SELECT DISTINCT
            p.VehicleHostID,
            p.DeviceHostID
          FROM
            [StageUser].STAGE_VehicleDeviceProperties p
              LEFT JOIN
            [StageUser].STAGE_DIM_VehicleDevices d ON p.VehicleHostID = d.VehicleHostID
                                                  AND p.DeviceHostID  = d.DeviceHostID
          WHERE
            d.VehicleHostID IS NULL
        )
        INSERT INTO [StageUser].STAGE_DIM_VehicleDevices
        (
          VehicleHostID,
          DeviceHostID,
          VehicleGUID,
          DeviceKey,
          InputLine,
          DeviceProperties
        )
        SELECT
          v.HostID,
          d.HostID,
          v.VehicleGUID,
          d.DeviceKey,
          vd.InputLine,
          vd.DeviceProperties
        FROM
          [MiXData].[dbo].DIM_VehicleDevices vd WITH (NOLOCK)
            INNER JOIN
          [MiXData].[dbo].DIM_Vehicles v  WITH (NOLOCK) ON @organisationKey  = v.OrganisationKey
                                                          AND vd.VehicleGUID    = v.VehicleGUID
                                                          AND v.IsCurrentRecord = 1
            INNER JOIN
          [MiXData].[dbo].DIM_Devices d   WITH (NOLOCK) ON @organisationKey  = d.OrganisationKey
                                                          AND vd.DeviceKey      = d.DeviceKey
            INNER JOIN
          missingVehicleDevices m                          ON v.HostID          = m.VehicleHostID
                                                          AND d.HostID          = m.DeviceHostID;
      END;

  -- update the XML property bag:
    UPDATE
      [StageUser].STAGE_DIM_VehicleDevices
    SET
      DeviceProperties = dbo.fncTransformVehicleDeviceProperties('[StageUser]', stg.VehicleHostID, stg.DeviceHostID, vd.DeviceProperties)
    FROM
      [StageUser].STAGE_DIM_VehicleDevices stg
        LEFT JOIN
      [MiXData].[dbo].DIM_VehicleDevices vd ON @organisationKey = vd.OrganisationKey
                                              AND stg.VehicleGUID  = vd.VehicleGUID
                                              AND stg.DeviceKey    = vd.DeviceKey;

  ------------------------------------------

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

--------------------------------------------------------------------
-- 4. Validation before Loading to DW
--------------------------------------------------------------------

  -- VehicleGUID is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser].STAGE_DIM_VehicleDevices  
    WHERE VehicleGUID IS NULL;
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some VehicleDevices does not have associated DIM_Vehicles records available',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.1 Validation before Loading to DW (VehicleGUID is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;  

  -- DeviceKey is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser].STAGE_DIM_VehicleDevices  
    WHERE DeviceKey IS NULL;
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some VehicleDevices does not have associated DIM_Devices records available',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.2 Validation before Loading to DW (DeviceKey is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;  

  -- Remove dirty data
  BEGIN TRY  

    DELETE
      [StageUser].STAGE_DIM_VehicleDevices
    WHERE
       VehicleGUID IS NULL
    OR DeviceKey IS NULL;

  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
  END CATCH;  

--------------------------------------------------------------------
-- 5. MERGE to DW (Load, update) and add to RollBck
--------------------------------------------------------------------
  BEGIN TRY

    DELETE @merged;

    MERGE [MiXData].[dbo].DIM_VehicleDevices tar
      USING [StageUser].STAGE_DIM_VehicleDevices stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.VehicleGUID     = stg.VehicleGUID
        AND tar.DeviceKey       = stg.DeviceKey
      WHEN MATCHED
        THEN UPDATE SET
          tar.InputLine         = stg.InputLine,
          tar.DeviceProperties  = stg.DeviceProperties,
          tar.UpdateBatchKey    = @batchKey
      WHEN NOT MATCHED THEN
        INSERT
        (
          OrganisationKey,
          VehicleGUID,
          DeviceKey,
          InputLine,
          DeviceProperties,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.VehicleGUID,
          stg.DeviceKey,
          stg.InputLine,
          stg.DeviceProperties,
          @batchKey,
          @batchKey
        )
      OUTPUT
        $action   AS Operation,
        ISNULL(DELETED.VehicleDeviceKey,  INSERTED.VehicleDeviceKey),
        DELETED.OrganisationKey,
        ISNULL(DELETED.VehicleGUID,       INSERTED.VehicleGUID),
        ISNULL(DELETED.DeviceKey,         INSERTED.DeviceKey),
        DELETED.InputLine,
        DELETED.DeviceProperties,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
      INTO
        @merged;
    SET @rowcount = @@ROWCOUNT;
    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merged
    WHERE
      Operation = 'INSERT'

    INSERT INTO [StageUser].ROLLBACK_DIM_VehicleDevices
    (
      VehicleDeviceKey,
      OrganisationKey,
      VehicleGUID,
      DeviceKey,
      InputLine,
      DeviceProperties,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      VehicleDeviceKey,
      OrganisationKey,
      VehicleGUID,
      DeviceKey,
      InputLine,
      DeviceProperties,
      CreateBatchKey,
      UpdateBatchKey
    FROM
      @merged
    WHERE
      Operation = 'UPDATE'
      AND UpdateBatchKey < @batchKey;
    SET @recordsUpdated += @@ROWCOUNT;

   IF @debugMode = 1
      PRINT N'5. MERGE to DW (Load) and add to RollBck';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    BEGIN
      TRUNCATE TABLE [StageUser].STAGE_DIM_VehicleDevices;
      TRUNCATE TABLE [StageUser].STAGE_VehicleDeviceProperties;
    END;
  ELSE
    BEGIN  -- DebugMode is true
      PRINT N'7. Cleanup work tables';
    END;

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_VehicleEventDefinitions_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_VehicleEventDefinitionss on DW (details of VehicleEvent)
--
--  Dependencies:
--    DIM_EventDescriptions
--    DIM_UTCOffsets
--    DIM_Vehicles
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_VehicleEventDefinitions_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
) AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;
  DECLARE @nrOfrecordsAffected    int = 0;
  DECLARE @nrOfValidationErrors   int = 0;


  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                     nvarchar (10)     NOT NULL,
    VehicleEventKey               int               NOT NULL,
    OrganisationKey               int               NULL,
    VehicleGUID                   uniqueidentifier  NOT NULL,
    EventDescriptionKey           int               NOT NULL,
    
    EventType                     tinyint           NULL,
    InUse                         bit               NULL,
    RecordStartOdometer           bit               NULL,
    RecordStartPosition           bit               NULL,
    RecordEndOdometer             bit               NULL,
    RecordEndPosition             bit               NULL,
    RecordPulseCount              bit               NULL,
    SendActivePosition            bit               NULL,
    StartRecordDelay              smallint          NULL,
    StartAlarmDelay               smallint          NULL,
    StartExternalRelay1Delay      smallint          NULL,
    StartExternalRelay2Delay      smallint          NULL,
    StartCriticalDisplayDelay     smallint          NULL,
    ActiveSendDelay               smallint          NULL,
    ActiveEndSendDelay            smallint          NULL,
    StartActiveTrackDelay         smallint          NULL,
    ActiveTrackInterval           smallint          NULL,
    AlarmState                    tinyint           NULL,
    ExternalRelay1State           tinyint           NULL,
    ExternalRelay2State           tinyint           NULL,
    WarningMessage                nvarchar (255)    NULL,
    ActiveMessagePriority         tinyint           NULL,
    EventTriggerDefinition        xml               NULL,

    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------

  TRUNCATE TABLE [StageUser].ROLLBACK_DIM_VehicleEventDefinitions;
  TRUNCATE TABLE [StageUser].STAGE_DIM_VehicleEventDefinitions;
  TRUNCATE TABLE [StageUser].STAGE_VehicleTriggers;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_DIM_VehicleEventDefinitions]') AND name = N'IX_STAGE_DIM_VehicleEventDefinitions_VehicleHostID_EventHostID')
      DROP INDEX IX_STAGE_DIM_VehicleEventDefinitions_VehicleHostID_EventHostID ON [StageUser].STAGE_DIM_VehicleEventDefinitions;

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_DIM_VehicleEventDefinitions]') AND name = N'IX_STAGE_DIM_VehicleEventDefinitions_VehicleGUID_EventDescriptionKey')
      DROP INDEX IX_STAGE_DIM_VehicleEventDefinitions_VehicleGUID_EventDescriptionKey ON [StageUser].STAGE_DIM_VehicleEventDefinitions;

    ;WITH LatestVehicleEvents (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser].VehicleEvent WITH (NOLOCK)
      GROUP BY
        iVehicleID,
        iEventID
    )
    INSERT INTO [StageUser].STAGE_DIM_VehicleEventDefinitions
    (
      VehicleHostID,
      EventHostID,
      EventType,
      InUse,
      RecordStartOdometer,
      RecordStartPosition,
      RecordEndOdometer,
      RecordEndPosition,
      RecordPulseCount,
      SendActivePosition,
      StartRecordDelay,
      StartAlarmDelay,
      StartExternalRelay1Delay,
      StartExternalRelay2Delay,
      StartCriticalDisplayDelay,
      ActiveSendDelay,
      ActiveEndSendDelay,
      StartActiveTrackDelay,
      ActiveTrackInterval,
      AlarmState,
      ExternalRelay1State,
      ExternalRelay2State,
      WarningMessage,
      ActiveMessagePriority
    )
    SELECT
      s.iVehicleID,
      s.iEventID,
      s.ucEventType,
      s.bInUse,
      s.bStartOdo,
      s.bStartPosition,
      s.bEndOdo,
      s.bEndPosition,
      s.bRecordF3Count,
      s.bActivePosition,
      s.iRecordTime,
      s.iAlarmTime,
      s.iRelayTime,
      s.iRelay2Time,
      s.iCriticalTime,
      s.iActiveTime,
      s.iActiveEndTime,
      s.iTrackTime,
      s.iTrackInterval,
      s.ucAlarmState,
      s.ucRelayState,
      s.ucRelay2State,
      CASE s.bWarningMessage WHEN 0 THEN NULL ELSE s.sWarningMessage END,
      s.ucPriority
    FROM
      [StageUser].VehicleEvent s WITH (NOLOCK)
        INNER JOIN
      LatestVehicleEvents l ON s.RID = MaxRID;
    SET @rowcount = @@ROWCOUNT;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

  -- create indexes required for lookups
  CREATE NONCLUSTERED INDEX IX_STAGE_DIM_VehicleEventDefinitions_VehicleHostID_EventHostID
    ON [StageUser].STAGE_DIM_VehicleEventDefinitions(VehicleHostID,EventHostID);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
  END;

  ------------------------------------------
  -- VehicleGUID
    UPDATE
      [StageUser].STAGE_DIM_VehicleEventDefinitions
    SET
      VehicleGUID     = v.VehicleGUID
    FROM
      [StageUser].STAGE_DIM_VehicleEventDefinitions stg
        INNER JOIN
      [MiXData].[dbo].DIM_Vehicles v WITH (NOLOCK) ON @organisationKey  = v.OrganisationKey
                                                     AND stg.VehicleHostID = v.HostID
                                                     AND v.IsCurrentRecord = 1;

  ------------------------------------------
  -- EventDescriptionKey
    UPDATE
      [StageUser].STAGE_DIM_VehicleEventDefinitions
    SET
      EventDescriptionKey     = d.EventDescriptionKey
    FROM
      [StageUser].STAGE_DIM_VehicleEventDefinitions stg
        INNER JOIN
      [MiXData].[dbo].DIM_EventDescriptions d WITH (NOLOCK) ON @organisationKey = d.OrganisationKey
                                                              AND stg.EventHostID  = d.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update Keys', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

  ------------------------------------------

  IF NOT EXISTS(SELECT *
                FROM sys.indexes 
                WHERE object_id = OBJECT_ID(N'[StageUser].[GroupTriggers_VehicleTriggers]') AND name = N'IX_GroupTriggers_VehicleTriggers_iParameterID')
    CREATE INDEX IX_GroupTriggers_VehicleTriggers_iParameterID
      ON [StageUser].GroupTriggers_VehicleTriggers(iParameterID)
      INCLUDE
      (iVehicleID,iEventID,ucTriggerID,Operation,ucSeq,ucOperator,lfValue,bRequired,ucTOper);

  -- VehicleTriggers:
   -- a: prepare Staged triggers:
    INSERT INTO [StageUser].STAGE_VehicleTriggers
          (VehicleHostID,  EventHostID,  TriggerID,       Operation,     Sequence,  ParameterKey,   Operator,       ThresholdValue, Required,      JoinOperator)
    SELECT stg.iVehicleID, stg.iEventID, stg.ucTriggerID, stg.Operation, stg.ucSeq, p.ParameterKey, stg.ucOperator, stg.lfValue,    stg.bRequired, stg.ucTOper
    FROM
      [StageUser].GroupTriggers_VehicleTriggers stg
        INNER JOIN
      [MiXData].[dbo].DIM_CalibrationParameters p WITH (NOLOCK) ON @organisationKey = p.OrganisationKey
                                                                  AND stg.iParameterID = p.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3.a Update VehicleTriggers - prepare Staged triggers', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

   DROP INDEX IX_GroupTriggers_VehicleTriggers_iParameterID ON [StageUser].GroupTriggers_VehicleTriggers;

   -- b: cater for Trigger only change:
    IF EXISTS ( SELECT *
                FROM
                  [StageUser].STAGE_VehicleTriggers vt
                    LEFT JOIN
                  [StageUser].STAGE_DIM_VehicleEventDefinitions ve ON vt.VehicleHostID = ve.VehicleHostID
                                                                  AND vt.EventHostID   = ve.EventHostID
                WHERE
                  ve.VehicleHostID IS NULL)
      BEGIN
        WITH missingVehicleEvents(VehicleHostID, EventHostID) AS
        (
          SELECT DISTINCT
            vt.VehicleHostID,
            vt.EventHostID
          FROM
            [StageUser].STAGE_VehicleTriggers vt
              LEFT JOIN
            [StageUser].STAGE_DIM_VehicleEventDefinitions ve ON vt.VehicleHostID = ve.VehicleHostID
                                                            AND vt.EventHostID   = ve.EventHostID
          WHERE
            ve.VehicleHostID IS NULL
        )
        INSERT INTO [StageUser].STAGE_DIM_VehicleEventDefinitions
        (
          VehicleHostID,
          EventHostID,
          VehicleGUID,
          EventDescriptionKey,
          EventType,
          InUse,
          RecordStartOdometer,
          RecordStartPosition,
          RecordEndOdometer,
          RecordEndPosition,
          RecordPulseCount,
          SendActivePosition,
          StartRecordDelay,
          StartAlarmDelay,
          StartExternalRelay1Delay,
          StartExternalRelay2Delay,
          StartCriticalDisplayDelay,
          ActiveSendDelay,
          ActiveEndSendDelay,
          StartActiveTrackDelay,
          ActiveTrackInterval,
          AlarmState,
          ExternalRelay1State,
          ExternalRelay2State,
          WarningMessage,
          ActiveMessagePriority
        )
        SELECT
          v.HostID,
          ed.HostID,
          ved.VehicleGUID,
          ved.EventDescriptionKey,
          ved.EventType,
          ved.InUse,
          ved.RecordStartOdometer,
          ved.RecordStartPosition,
          ved.RecordEndOdometer,
          ved.RecordEndPosition,
          ved.RecordPulseCount,
          ved.SendActivePosition,
          ved.StartRecordDelay,
          ved.StartAlarmDelay,
          ved.StartExternalRelay1Delay,
          ved.StartExternalRelay2Delay,
          ved.StartCriticalDisplayDelay,
          ved.ActiveSendDelay,
          ved.ActiveEndSendDelay,
          ved.StartActiveTrackDelay,
          ved.ActiveTrackInterval,
          ved.AlarmState,
          ved.ExternalRelay1State,
          ved.ExternalRelay2State,
          ved.WarningMessage,
          ved.ActiveMessagePriority
        FROM
          [MiXData].[dbo].DIM_VehicleEventDefinitions ved  WITH (NOLOCK)
            INNER JOIN
          [MiXData].[dbo].DIM_Vehicles v           WITH (NOLOCK) ON @organisationKey         = v.OrganisationKey
                                                                   AND ved.VehicleGUID          = v.VehicleGUID
                                                                   AND v.IsCurrentRecord        = 1
            INNER JOIN
          [MiXData].[dbo].DIM_EventDescriptions ed WITH (NOLOCK) ON @organisationKey         = ed.OrganisationKey
                                                                   AND ved.EventDescriptionKey  = ed.EventDescriptionKey
            INNER JOIN
          missingVehicleEvents m                                    ON v.HostID                 = m.VehicleHostID
                                                                   AND ed.HostID                = m.EventHostID;
      END;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3.b Update VehicleTriggers - cater for Trigger only change', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

   -- c: update the XML property bag:
   CREATE INDEX IX_STAGE_DIM_VehicleEventDefinitions_VehicleGUID_EventDescriptionKey
     ON [StageUser].STAGE_DIM_VehicleEventDefinitions(VehicleGUID,EventDescriptionKey)
     INCLUDE (VehicleHostID,EventHostID);

    UPDATE
      [StageUser].STAGE_DIM_VehicleEventDefinitions
    SET
      EventTriggerDefinition = dbo.fncTransformVehicleTriggers('[StageUser]', stg.VehicleHostID, stg.EventHostID, ved.EventTriggerDefinition)
    FROM
      [StageUser].STAGE_DIM_VehicleEventDefinitions stg
        LEFT JOIN
      [MiXData].[dbo].DIM_VehicleEventDefinitions ved ON @organisationKey        = ved.OrganisationKey
                                                        AND stg.VehicleGUID         = ved.VehicleGUID
                                                        AND stg.EventDescriptionKey = ved.EventDescriptionKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3.c Update VehicleTriggers - update the XML property bag', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

  ------------------------------------------

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

--------------------------------------------------------------------
-- 4. Validation before Loading to DW
--------------------------------------------------------------------

  -- VehicleGUID is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser].STAGE_DIM_VehicleEventDefinitions  
    WHERE VehicleGUID IS NULL;
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some VehicleEventDefinitions does not have associated DIM_Vehicles records available',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.1 Validation before Loading to DW (VehicleGUID is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;  

  -- EventDescriptionKey is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser].STAGE_DIM_VehicleEventDefinitions  
    WHERE EventDescriptionKey IS NULL;
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some VehicleEventDefinitions does not have associated DIM_EventDescriptions records available',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.2 Validation before Loading to DW (EventDescriptionKey is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;  

  -- Remove dirty data
  BEGIN TRY  

    DELETE
      [StageUser].STAGE_DIM_VehicleEventDefinitions
    WHERE
       VehicleGUID         IS NULL
    OR EventDescriptionKey IS NULL;

  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
  END CATCH;

--------------------------------------------------------------------
-- 5. MERGE to DW (Load, update) and add to RollBck
--------------------------------------------------------------------
  BEGIN TRY

    MERGE [MiXData].[dbo].DIM_VehicleEventDefinitions tar
      USING [StageUser].STAGE_DIM_VehicleEventDefinitions stg
         ON tar.OrganisationKey         = @organisationKey
        AND tar.VehicleGUID             = stg.VehicleGUID
        AND tar.EventDescriptionKey     = stg.EventDescriptionKey
      WHEN MATCHED  
        THEN UPDATE SET
          tar.EventType                 = stg.EventType,
          tar.InUse                     = stg.InUse,
          tar.RecordStartOdometer       = stg.RecordStartOdometer,
          tar.RecordStartPosition       = stg.RecordStartPosition,
          tar.RecordEndOdometer         = stg.RecordEndOdometer,
          tar.RecordEndPosition         = stg.RecordEndPosition,
          tar.RecordPulseCount          = stg.RecordPulseCount,
          tar.SendActivePosition        = stg.SendActivePosition,
          tar.StartRecordDelay          = stg.StartRecordDelay,
          tar.StartAlarmDelay           = stg.StartAlarmDelay,
          tar.StartExternalRelay1Delay  = stg.StartExternalRelay1Delay,
          tar.StartExternalRelay2Delay  = stg.StartExternalRelay2Delay,
          tar.StartCriticalDisplayDelay = stg.StartCriticalDisplayDelay,
          tar.ActiveSendDelay           = stg.ActiveSendDelay,
          tar.ActiveEndSendDelay        = stg.ActiveEndSendDelay,
          tar.StartActiveTrackDelay     = stg.StartActiveTrackDelay,
          tar.ActiveTrackInterval       = stg.ActiveTrackInterval,
          tar.AlarmState                = stg.AlarmState,
          tar.ExternalRelay1State       = stg.ExternalRelay1State,
          tar.ExternalRelay2State       = stg.ExternalRelay2State,
          tar.WarningMessage            = stg.WarningMessage,
          tar.ActiveMessagePriority     = stg.ActiveMessagePriority,
          tar.EventTriggerDefinition    = stg.EventTriggerDefinition,
          tar.UpdateBatchKey            = @batchKey
      WHEN NOT MATCHED THEN
        INSERT
        (
          OrganisationKey,
          VehicleGUID,
          EventDescriptionKey,
          EventType,
          InUse,
          RecordStartOdometer,
          RecordStartPosition,
          RecordEndOdometer,
          RecordEndPosition,
          RecordPulseCount,
          SendActivePosition,
          StartRecordDelay,
          StartAlarmDelay,
          StartExternalRelay1Delay,
          StartExternalRelay2Delay,
          StartCriticalDisplayDelay,
          ActiveSendDelay,
          ActiveEndSendDelay,
          StartActiveTrackDelay,
          ActiveTrackInterval,
          AlarmState,
          ExternalRelay1State,
          ExternalRelay2State,
          WarningMessage,
          ActiveMessagePriority,
          EventTriggerDefinition,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.VehicleGUID,
          stg.EventDescriptionKey,
          stg.EventType,
          stg.InUse,
          stg.RecordStartOdometer,
          stg.RecordStartPosition,
          stg.RecordEndOdometer,
          stg.RecordEndPosition,
          stg.RecordPulseCount,
          stg.SendActivePosition,
          stg.StartRecordDelay,
          stg.StartAlarmDelay,
          stg.StartExternalRelay1Delay,
          stg.StartExternalRelay2Delay,
          stg.StartCriticalDisplayDelay,
          stg.ActiveSendDelay,
          stg.ActiveEndSendDelay,
          stg.StartActiveTrackDelay,
          stg.ActiveTrackInterval,
          stg.AlarmState,
          stg.ExternalRelay1State,
          stg.ExternalRelay2State,
          stg.WarningMessage,
          stg.ActiveMessagePriority,
          stg.EventTriggerDefinition,
          @batchKey,
          @batchKey
        )
      OUTPUT
        $action   AS Operation,
        ISNULL(deleted.VehicleEventKey,     inserted.VehicleEventKey),
        deleted.OrganisationKey,
        ISNULL(deleted.VehicleGUID,         inserted.VehicleGUID),
        ISNULL(deleted.EventDescriptionKey, inserted.EventDescriptionKey),
        deleted.EventType,
        deleted.InUse,
        deleted.RecordStartOdometer,
        deleted.RecordStartPosition,
        deleted.RecordEndOdometer,
        deleted.RecordEndPosition,
        deleted.RecordPulseCount,
        deleted.SendActivePosition,
        deleted.StartRecordDelay,
        deleted.StartAlarmDelay,
        deleted.StartExternalRelay1Delay,
        deleted.StartExternalRelay2Delay,
        deleted.StartCriticalDisplayDelay,
        deleted.ActiveSendDelay,
        deleted.ActiveEndSendDelay,
        deleted.StartActiveTrackDelay,
        deleted.ActiveTrackInterval,
        deleted.AlarmState,
        deleted.ExternalRelay1State,
        deleted.ExternalRelay2State,
        deleted.WarningMessage,
        deleted.ActiveMessagePriority,
        deleted.EventTriggerDefinition,
        deleted.CreateBatchKey,
        deleted.UpdateBatchKey
      INTO
        @merged;
    SET @rowcount = @@ROWCOUNT;
    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merged
    WHERE
      Operation = 'INSERT'

    INSERT INTO [StageUser].ROLLBACK_DIM_VehicleEventDefinitions
    (
      VehicleEventKey,
      OrganisationKey,
      VehicleGUID,
      EventDescriptionKey,
      EventType,
      InUse,
      RecordStartOdometer,
      RecordStartPosition,
      RecordEndOdometer,
      RecordEndPosition,
      RecordPulseCount,
      SendActivePosition,
      StartRecordDelay,
      StartAlarmDelay,
      StartExternalRelay1Delay,
      StartExternalRelay2Delay,
      StartCriticalDisplayDelay,
      ActiveSendDelay,
      ActiveEndSendDelay,
      StartActiveTrackDelay,
      ActiveTrackInterval,
      AlarmState,
      ExternalRelay1State,
      ExternalRelay2State,
      WarningMessage,
      ActiveMessagePriority,
      EventTriggerDefinition,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      VehicleEventKey,
      OrganisationKey,
      VehicleGUID,
      EventDescriptionKey,
      EventType,
      InUse,
      RecordStartOdometer,
      RecordStartPosition,
      RecordEndOdometer,
      RecordEndPosition,
      RecordPulseCount,
      SendActivePosition,
      StartRecordDelay,
      StartAlarmDelay,
      StartExternalRelay1Delay,
      StartExternalRelay2Delay,
      StartCriticalDisplayDelay,
      ActiveSendDelay,
      ActiveEndSendDelay,
      StartActiveTrackDelay,
      ActiveTrackInterval,
      AlarmState,
      ExternalRelay1State,
      ExternalRelay2State,
      WarningMessage,
      ActiveMessagePriority,
      EventTriggerDefinition,
      CreateBatchKey,
      UpdateBatchKey
    FROM
      @merged
    WHERE
      Operation = 'UPDATE'
      AND UpdateBatchKey < @batchKey;
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5. MERGE to DW (Load) and add to RollBck', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    BEGIN
      TRUNCATE TABLE [StageUser].STAGE_DIM_VehicleEventDefinitions;
    END;
  ELSE
    BEGIN
      PRINT N'7. Cleanup work tables';
    END;

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_VehicleProfiles_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_VehicleProfiles on DW (details of VehicleProfiles)
--
--  Dependencies:
--    DIM_CalibrationParameters
--    DIM_UTCOffsets
--    DIM_Vehicles
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_VehicleProfiles_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
) AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;
  DECLARE @nrOfValidationErrors   int = 0;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey           int;
  DECLARE @UTCOffsetMinutes       smallint;
  DECLARE @maxAuditDate           datetimeoffset (0);
  DECLARE @startDate              datetimeoffset (0);
  DECLARE @tmpDate                datetimeoffset (0);
  DECLARE @endDate                datetimeoffset (0);
  DECLARE @startDateKey           date;
  DECLARE @previousEndDateKey     date;

  -- Default values
  DECLARE @startDateFirstInsert date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @endDateDefault       date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)

  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                     nvarchar (10)     NOT NULL,
    VehicleProfileKey             int               NOT NULL,
    StartDateKey                  date              NULL,
    EndDateKey                    date              NULL,
    IsCurrentRecord               bit               NULL,
    OrganisationKey               int               NULL,
    VehicleGUID                   uniqueidentifier  NOT NULL,
    ParameterKey                  int               NOT NULL,
    RangeLowerValue1              float             SPARSE NULL,
    RangeLowerValue2              float             SPARSE NULL,
    RangeLowerValue3              float             SPARSE NULL,
    RangeLowerValue4              float             SPARSE NULL,
    RangeLowerValue5              float             SPARSE NULL,
    RangeLowerValue6              float             SPARSE NULL,
    RangeLowerValue7              float             SPARSE NULL,
    RangeLowerValue8              float             SPARSE NULL,
    RangeLowerValue9              float             SPARSE NULL,
    RangeLowerValue10             float             SPARSE NULL,
    RangeLowerValue11             float             SPARSE NULL,
    UTCOffsetKey                  smallint          NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );
  DECLARE @type2Keys table
  (
    VehicleProfileKey             int               NOT NULL,
    VehicleGUID                   uniqueidentifier  NOT NULL,
    ParameterKey                  int               NOT NULL
  );

  -- Get range for which SCD should be calculated
  SELECT
    @startDate    = MIN(ChangeDate),
    @maxAuditDate = MAX(ChangeDate)
  FROM
    [StageUser].VehicleProfile;

  TRUNCATE TABLE [StageUser].ROLLBACK_DIM_VehicleProfiles;

  -- Loop through calculation a day at a time and Load to DW
  WHILE @startDate <= @MaxAuditDate
    BEGIN
    -- get timezone infomation
      SELECT
        @UTCOffsetKey     = UTCOffsetKey,
        @UTCOffsetMinutes = UTCOffsetMinutes,
        @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
      FROM
        [StageUser].STAGE_DIM_UTCOffsetsLookUp
      WHERE
        @startDate     BETWEEN StartDateTime       AND EndDateTime
        AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

      SET @startDateKey       = CONVERT(date, @tmpDate);
    -- get the UTC time for the start of the next day in organisation's timezone
      SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
      SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

    --------------------------------------------------------------------
    -- 0. Make sure work tables are cleared
    --------------------------------------------------------------------
      TRUNCATE TABLE [StageUser].STAGE_DIM_VehicleProfiles;

      IF @debugMode = 1  -- DebugMode is true
        PRINT N'0. Make sure work tables are cleared for processing from ' + CONVERT(nvarchar, @startDate, 0) + ' to ' + CONVERT(nvarchar, @endDate, 0);

    --------------------------------------------------------------------
    -- 1. Source Data Validation
    --------------------------------------------------------------------


    --------------------------------------------------------------------
    -- 2. Add to STG
    --------------------------------------------------------------------
      BEGIN TRY

        ;WITH LastProfile (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser].VehicleProfile WITH (NOLOCK)
          WHERE
            ChangeDate >= @startDate
            AND ChangeDate < @endDate
          GROUP BY
            iVehicleID,
            iParameterID,
            ucSeq
        )
        , profiles (VehicleHostID, ParameterHostID, RangeLowerValue1, RangeOperation1, RangeLowerValue2, RangeOperation2, RangeLowerValue3, RangeOperation3, RangeLowerValue4, RangeOperation4, RangeLowerValue5, RangeOperation5, RangeLowerValue6, RangeOperation6, RangeLowerValue7, RangeOperation7, RangeLowerValue8, RangeOperation8, RangeLowerValue9, RangeOperation9, RangeLowerValue10, RangeOperation10, RangeLowerValue11, RangeOperation11) AS
        (
          SELECT
            iVehicleID,
            iParameterID,                           ---- Force NULL when deleted!
            MAX(CASE WHEN ucSeq = 1  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 1  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 2  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 2  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 3  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 3  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 4  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 4  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 5  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 5  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 6  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 6  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 7  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 7  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 8  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 8  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 9  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 9  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 10 THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 10 THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 11 THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 11 THEN Operation ELSE NULL END)
          FROM
            LastProfile l
            INNER JOIN [StageUser].VehicleProfile p WITH (NOLOCK) ON l.RID = p.RID
          GROUP BY
            iVehicleID,
            iParameterID
        )
        INSERT INTO [StageUser].STAGE_DIM_VehicleProfiles
        (
          VehicleHostID,
          ParameterHostID,
          RangeLowerValue1,
          RangeOperation1,
          RangeLowerValue2,
          RangeOperation2,
          RangeLowerValue3,
          RangeOperation3,
          RangeLowerValue4,
          RangeOperation4,
          RangeLowerValue5,
          RangeOperation5,
          RangeLowerValue6,
          RangeOperation6,
          RangeLowerValue7,
          RangeOperation7,
          RangeLowerValue8,
          RangeOperation8,
          RangeLowerValue9,
          RangeOperation9,
          RangeLowerValue10,
          RangeOperation10,
          RangeLowerValue11,
          RangeOperation11
        )
        SELECT * FROM profiles;
        SET @rowcount = @@ROWCOUNT;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

    --------------------------------------------------------------------
    -- 3. Update calculated columns onto STG
    --------------------------------------------------------------------
      BEGIN TRY

      ------------------------------------------
      -- VehicleGUID
        UPDATE
          [StageUser].STAGE_DIM_VehicleProfiles
        SET
          VehicleGUID     = v.VehicleGUID
        FROM
          [StageUser].STAGE_DIM_VehicleProfiles stg
          INNER JOIN [MiXData].[dbo].DIM_Vehicles v WITH (NOLOCK) ON @organisationKey  = v.OrganisationKey
                                                                    AND stg.VehicleHostID = v.HostID
        WHERE
          @startDateKey BETWEEN v.StartDateKey AND v.EndDateKey;

      ------------------------------------------
      -- ParameterKey
        UPDATE
          [StageUser].STAGE_DIM_VehicleProfiles
        SET
          ParameterKey    = p.ParameterKey
        FROM
          [StageUser].STAGE_DIM_VehicleProfiles stg
          INNER JOIN [MiXData].[dbo].DIM_CalibrationParameters p WITH (NOLOCK) ON @organisationKey    = p.OrganisationKey
                                                                                 AND stg.ParameterHostID = p.HostID;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'3. Update calculated columns onto STG';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

    --------------------------------------------------------------------
    -- 4. Validation before Loading to DW
    --------------------------------------------------------------------
      -- VehicleGUID is null
      BEGIN TRY  

        SELECT
          @nrOfValidationErrors = ISNULL(COUNT(1),0)
        FROM
          [StageUser].STAGE_DIM_VehicleProfiles  
        WHERE VehicleGUID IS NULL;
                     
        IF @nrOfValidationErrors > 0
        BEGIN  
          RAISERROR(N'Some VehicleProfiles does not have associated DIM_Vehicles records available',16,1);  
        END  
       
        IF @debugMode = 1  -- DebugMode is true  
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.1 Validation before Loading to DW (VehicleGUID is null)';  
      
      END TRY  
      -- CATCH Errors  
      BEGIN CATCH  
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
      END CATCH;  


      -- ParameterKey is null
      BEGIN TRY  

        SELECT
          @nrOfValidationErrors = ISNULL(COUNT(1),0)
        FROM
          [StageUser].STAGE_DIM_VehicleProfiles  
        WHERE ParameterKey IS NULL;
                     
        IF @nrOfValidationErrors > 0
        BEGIN  
          RAISERROR(N'Some VehicleProfiles does not have associated DIM_CalibrationParameters records available',16,1);  
        END  
       
        IF @debugMode = 1  -- DebugMode is true  
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.2 Validation before Loading to DW (ParameterKey is null)';  
      
      END TRY  
      -- CATCH Errors  
      BEGIN CATCH  
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
      END CATCH;  

      -- Remove dirty data
      BEGIN TRY  

        DELETE
          [StageUser].STAGE_DIM_VehicleProfiles
        WHERE
          ParameterKey IS NULL
        OR VehicleGUID IS NULL;

      END TRY  
      -- CATCH Errors  
      BEGIN CATCH  
        EXEC [Control].sprLogError @organisationKey = @organisationKey;  
      END CATCH;

    --------------------------------------------------------------------
    -- 5. MERGE to DW (Load) and add to RollBck (Type 2)
    --------------------------------------------------------------------
      BEGIN TRY

        DELETE @merged;
        MERGE [MiXData].[dbo].DIM_VehicleProfiles tar
          USING [StageUser].STAGE_DIM_VehicleProfiles stg
             ON tar.OrganisationKey = @organisationKey
            AND tar.VehicleGUID     = stg.VehicleGUID
            AND tar.ParameterKey    = stg.ParameterKey
          WHEN MATCHED  -- Matched and DW StartDateKey = StartDate (then just update)
           AND tar.StartDateKey    = @startDate
           AND tar.EndDateKey      = @endDateDefault
            THEN UPDATE
            SET
              tar.RangeLowerValue1  = CASE
                                        WHEN RangeOperation1 IS NULL THEN
                                          tar.RangeLowerValue1    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue1
                                       END,
              tar.RangeLowerValue2  = CASE
                                        WHEN RangeOperation2 IS NULL THEN
                                          tar.RangeLowerValue2    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue2
                                       END,
              tar.RangeLowerValue3  = CASE
                                        WHEN RangeOperation3 IS NULL THEN
                                          tar.RangeLowerValue3    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue3
                                       END,
              tar.RangeLowerValue4  = CASE
                                        WHEN RangeOperation4 IS NULL THEN
                                          tar.RangeLowerValue4    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue4
                                       END,
              tar.RangeLowerValue5  = CASE
                                        WHEN RangeOperation5 IS NULL THEN
                                          tar.RangeLowerValue5    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue5
                                       END,
              tar.RangeLowerValue6  = CASE
                                        WHEN RangeOperation6 IS NULL THEN
                                          tar.RangeLowerValue6    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue6
                                       END,
              tar.RangeLowerValue7  = CASE
                                        WHEN RangeOperation7 IS NULL THEN
                                          tar.RangeLowerValue7    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue7
                                       END,
              tar.RangeLowerValue8  = CASE
                                        WHEN RangeOperation8 IS NULL THEN
                                          tar.RangeLowerValue8    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue8
                                       END,
              tar.RangeLowerValue9  = CASE
                                        WHEN RangeOperation9 IS NULL THEN
                                          tar.RangeLowerValue9    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue9
                                       END,
              tar.RangeLowerValue10 = CASE
                                        WHEN RangeOperation10 IS NULL THEN
                                          tar.RangeLowerValue10   -- do not change!
                                        ELSE
                                          stg.RangeLowerValue10
                                       END,
              tar.RangeLowerValue11 = CASE
                                        WHEN RangeOperation11 IS NULL THEN
                                          tar.RangeLowerValue11   -- do not change!
                                        ELSE
                                          stg.RangeLowerValue11
                                       END,
              tar.UpdateBatchKey    = @batchKey
          WHEN NOT MATCHED THEN
            INSERT
            (
              StartDateKey,
              EndDateKey,
              IsCurrentRecord,
              OrganisationKey,
              VehicleGUID,
              ParameterKey,
              RangeLowerValue1,
              RangeLowerValue2,
              RangeLowerValue3,
              RangeLowerValue4,
              RangeLowerValue5,
              RangeLowerValue6,
              RangeLowerValue7,
              RangeLowerValue8,
              RangeLowerValue9,
              RangeLowerValue10,
              RangeLowerValue11,
              UTCOffsetKey,
              CreateBatchKey,
              UpdateBatchKey
            )
            VALUES
            (
              @startDateFirstInsert,
              @endDateDefault,
              1,
              @organisationKey,
              stg.VehicleGUID,
              stg.ParameterKey,
              stg.RangeLowerValue1,
              stg.RangeLowerValue2,
              stg.RangeLowerValue3,
              stg.RangeLowerValue4,
              stg.RangeLowerValue5,
              stg.RangeLowerValue6,
              stg.RangeLowerValue7,
              stg.RangeLowerValue8,
              stg.RangeLowerValue9,
              stg.RangeLowerValue10,
              stg.RangeLowerValue11,
              @UTCOffsetKey,
              @batchKey,
              @batchKey
            )
          OUTPUT
            $action   AS Operation,
            ISNULL(DELETED.VehicleProfileKey, INSERTED.VehicleProfileKey),
            DELETED.StartDateKey,
            DELETED.EndDateKey,
            DELETED.IsCurrentRecord,
            DELETED.OrganisationKey,
            ISNULL(DELETED.VehicleGUID,  INSERTED.VehicleGUID),
            ISNULL(DELETED.ParameterKey, INSERTED.ParameterKey),
            DELETED.RangeLowerValue1,
            DELETED.RangeLowerValue2,
            DELETED.RangeLowerValue3,
            DELETED.RangeLowerValue4,
            DELETED.RangeLowerValue5,
            DELETED.RangeLowerValue6,
            DELETED.RangeLowerValue7,
            DELETED.RangeLowerValue8,
            DELETED.RangeLowerValue9,
            DELETED.RangeLowerValue10,
            DELETED.RangeLowerValue11,
            DELETED.UTCOffsetKey,
            DELETED.CreateBatchKey,
            DELETED.UpdateBatchKey
            INTO @merged;
        SET @rowcount = @@ROWCOUNT;
        SELECT
          @recordsInserted += COUNT(*)
        FROM
          @merged
        WHERE
          Operation = 'INSERT'

        INSERT INTO [StageUser].ROLLBACK_DIM_VehicleProfiles
        (
          VehicleProfileKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          OrganisationKey,
          VehicleGUID,
          ParameterKey,
          RangeLowerValue1,
          RangeLowerValue2,
          RangeLowerValue3,
          RangeLowerValue4,
          RangeLowerValue5,
          RangeLowerValue6,
          RangeLowerValue7,
          RangeLowerValue8,
          RangeLowerValue9,
          RangeLowerValue10,
          RangeLowerValue11,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        SELECT
          VehicleProfileKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          OrganisationKey,
          VehicleGUID,
          ParameterKey,
          RangeLowerValue1,
          RangeLowerValue2,
          RangeLowerValue3,
          RangeLowerValue4,
          RangeLowerValue5,
          RangeLowerValue6,
          RangeLowerValue7,
          RangeLowerValue8,
          RangeLowerValue9,
          RangeLowerValue10,
          RangeLowerValue11,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        FROM
          @merged
        WHERE
          Operation          = 'UPDATE'
          AND UpdateBatchKey < @batchKey;
        SET @recordsUpdated += @@ROWCOUNT;

       IF @debugMode = 1
          PRINT '    after merge: rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

  --------------------------------------------------------------------
      -- type 2 changes -> first expire current
        DELETE @type2Keys;
        INSERT INTO @type2Keys
        SELECT
          tar.VehicleProfileKey,
          tar.VehicleGUID,
          tar.ParameterKey
        FROM
          [MiXData].[dbo].DIM_VehicleProfiles tar
          INNER JOIN [StageUser].STAGE_DIM_VehicleProfiles stg ON tar.OrganisationKey = @organisationKey
                                                              AND tar.VehicleGUID     = stg.VehicleGUID
                                                              AND tar.ParameterKey    = stg.ParameterKey
        WHERE
          NOT EXISTS (SELECT *
                      FROM
                        @merged m
                      WHERE
                        m.VehicleGUID      = tar.VehicleGUID
                        AND m.ParameterKey = tar.ParameterKey)
          AND tar.StartDateKey      < @startDate
          AND tar.EndDateKey        = @endDateDefault
          AND (
               stg.RangeOperation1  IS NOT NULL
            OR stg.RangeOperation2  IS NOT NULL
            OR stg.RangeOperation3  IS NOT NULL
            OR stg.RangeOperation4  IS NOT NULL
            OR stg.RangeOperation5  IS NOT NULL
            OR stg.RangeOperation6  IS NOT NULL
            OR stg.RangeOperation7  IS NOT NULL
            OR stg.RangeOperation8  IS NOT NULL
            OR stg.RangeOperation9  IS NOT NULL
            OR stg.RangeOperation10 IS NOT NULL
            OR stg.RangeOperation11 IS NOT NULL
              );
        SET @rowcount = @@ROWCOUNT;

        INSERT INTO [StageUser].ROLLBACK_DIM_VehicleProfiles
        (
          VehicleProfileKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          OrganisationKey,
          VehicleGUID,
          ParameterKey,
          RangeLowerValue1,
          RangeLowerValue2,
          RangeLowerValue3,
          RangeLowerValue4,
          RangeLowerValue5,
          RangeLowerValue6,
          RangeLowerValue7,
          RangeLowerValue8,
          RangeLowerValue9,
          RangeLowerValue10,
          RangeLowerValue11,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        SELECT
          VehicleProfileKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          OrganisationKey,
          VehicleGUID,
          ParameterKey,
          RangeLowerValue1,
          RangeLowerValue2,
          RangeLowerValue3,
          RangeLowerValue4,
          RangeLowerValue5,
          RangeLowerValue6,
          RangeLowerValue7,
          RangeLowerValue8,
          RangeLowerValue9,
          RangeLowerValue10,
          RangeLowerValue11,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        FROM
         (UPDATE
            tar
          SET
            tar.EndDateKey      = @previousEndDateKey,
            tar.IsCurrentRecord = 0,
            tar.UpdateBatchKey  = @batchKey
          OUTPUT
            DELETED.VehicleProfileKey,
            DELETED.StartDateKey,
            DELETED.EndDateKey,
            DELETED.IsCurrentRecord,
            DELETED.OrganisationKey,
            DELETED.VehicleGUID,
            DELETED.ParameterKey,
            DELETED.RangeLowerValue1,
            DELETED.RangeLowerValue2,
            DELETED.RangeLowerValue3,
            DELETED.RangeLowerValue4,
            DELETED.RangeLowerValue5,
            DELETED.RangeLowerValue6,
            DELETED.RangeLowerValue7,
            DELETED.RangeLowerValue8,
            DELETED.RangeLowerValue9,
            DELETED.RangeLowerValue10,
            DELETED.RangeLowerValue11,
            DELETED.UTCOffsetKey,
            DELETED.CreateBatchKey,
            DELETED.UpdateBatchKey
          FROM
            [MiXData].[dbo].DIM_VehicleProfiles tar
            INNER JOIN @type2Keys k ON tar.VehicleProfileKey = k.VehicleProfileKey
         ) rollbck  -- end Update
        WHERE
          UpdateBatchKey < @batchKey -- end rollback insert

        INSERT INTO [MiXData].[dbo].DIM_VehicleProfiles
        (
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          OrganisationKey,
          VehicleGUID,
          ParameterKey,
          RangeLowerValue1,
          RangeLowerValue2,
          RangeLowerValue3,
          RangeLowerValue4,
          RangeLowerValue5,
          RangeLowerValue6,
          RangeLowerValue7,
          RangeLowerValue8,
          RangeLowerValue9,
          RangeLowerValue10,
          RangeLowerValue11,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        SELECT
          @startDate,
          @endDateDefault,
          1,
          @organisationKey,
          stg.VehicleGUID,
          stg.ParameterKey,
          CASE
            WHEN RangeOperation1 IS NULL THEN
              tar.RangeLowerValue1    -- do not change!
            ELSE
              stg.RangeLowerValue1
          END,
          CASE
            WHEN RangeOperation2 IS NULL THEN
              tar.RangeLowerValue2    -- do not change!
            ELSE
              stg.RangeLowerValue2
          END,
          CASE
            WHEN RangeOperation3 IS NULL THEN
              tar.RangeLowerValue3    -- do not change!
            ELSE
              stg.RangeLowerValue3
          END,
          CASE
            WHEN RangeOperation4 IS NULL THEN
              tar.RangeLowerValue4    -- do not change!
            ELSE
              stg.RangeLowerValue4
          END,
          CASE
            WHEN RangeOperation5 IS NULL THEN
              tar.RangeLowerValue5    -- do not change!
            ELSE
              stg.RangeLowerValue5
          END,
          CASE
            WHEN RangeOperation6 IS NULL THEN
              tar.RangeLowerValue6    -- do not change!
            ELSE
              stg.RangeLowerValue6
          END,
          CASE
             WHEN RangeOperation7 IS NULL THEN
              tar.RangeLowerValue7    -- do not change!
            ELSE
              stg.RangeLowerValue7
          END,
          CASE
            WHEN RangeOperation8 IS NULL THEN
              tar.RangeLowerValue8    -- do not change!
            ELSE
              stg.RangeLowerValue8
          END,
          CASE
            WHEN RangeOperation9 IS NULL THEN
              tar.RangeLowerValue9    -- do not change!
            ELSE
              stg.RangeLowerValue9
          END,
          CASE
            WHEN RangeOperation10 IS NULL THEN
              tar.RangeLowerValue10   -- do not change!
            ELSE
              stg.RangeLowerValue10
          END,
          CASE
            WHEN RangeOperation11 IS NULL THEN
              tar.RangeLowerValue11   -- do not change!
            ELSE
              stg.RangeLowerValue11
          END,
          @UTCOffsetKey,
          @batchKey,
          @batchKey
        FROM
          [MiXData].[dbo].DIM_VehicleProfiles tar
          INNER JOIN [StageUser].STAGE_DIM_VehicleProfiles stg ON tar.OrganisationKey = @organisationKey
                                                              AND tar.VehicleGUID     = stg.VehicleGUID
                                                              AND tar.ParameterKey    = stg.ParameterKey
          INNER JOIN @type2Keys k ON tar.VehicleProfileKey = k.VehicleProfileKey;
        SET @recordsType2Inserted += @@ROWCOUNT;

        IF @debugMode = 1
          PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  -- next day to process:
      SELECT
        @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
      FROM
        [StageUser].VehicleProfile
      WHERE
        ChangeDate >= @endDate;

    END -- END WHILE

  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Update Type 1 columns on DW';

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].STAGE_DIM_VehicleProfiles;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDIM_Vehicles_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates DIM_Vehicles on DW (details of vehicles)
-- ==============================================================================
CREATE PROCEDURE [StageUser].[sprDIM_Vehicles_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;
  DECLARE @nrOfRecordsAffected    int = 0;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey           int;
  DECLARE @UTCOffsetMinutes       smallint;
  DECLARE @maxAuditDate           datetimeoffset (0);
  DECLARE @startDate              datetimeoffset (0);
  DECLARE @tmpDate                datetimeoffset (0);
  DECLARE @endDate                datetimeoffset (0);
  DECLARE @startDateKey           date;
  DECLARE @previousEndDateKey     date;

  -- Default values
  DECLARE @startDateFirstInsert   date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @endDateDefault         date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)
  DECLARE @defaultIdentifierValue uniqueidentifier = '00000000-0000-0000-0000-000000000000'; -- used with GUID comparison for null values

  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                            nvarchar (10)     NOT NULL,
    [VehicleKey]                         INT               NOT NULL,
    [OrganisationKey]                    INT               NULL,
    [StartDateKey]                       DATE              NULL,
    [EndDateKey]                         DATE              NULL,
    [IsCurrentRecord]                    BIT               NULL,
    [IsActive]                           BIT               NULL,
    [HostID]                             INT               NULL,
    [VehicleGUID]                        UNIQUEIDENTIFIER  NULL,
    [VehicleDescription]                 NVARCHAR (255)    NULL,
    [SiteGUID]                           UNIQUEIDENTIFIER  NULL,
    [SiteKey]                            INT               NULL,
    [LastServiceDateKey]                 DATE              NULL,
    [IsYellowEquip]                      BIT               NULL,
    [RegNumber]                          NVARCHAR (15)     NULL,
    [ServiceByDistance]                  DECIMAL (19, 4)   NULL,
    [ServiceByDate]                      TINYINT           NULL,
    [ServiceByEngineSeconds]             INT               NULL,
    [NextServiceDueDistance]             DECIMAL (19, 4)   NULL,
    [NextServiceDueDateKey]              DATE              NULL,
    [NextServiceDueEngineSeconds]        INT               NULL,
    [DefaultDriverGUID]                  UNIQUEIDENTIFIER  NULL,
    [TargetFuelConsumption]              REAL              NULL,
    [TargetFuelConsumptionHourly]        REAL              NULL,
    [ScoreTriggerOverspeeding]           FLOAT             NULL,
    [ScoreTriggerOverRevving]            FLOAT             NULL,
    [ScoreTriggerOverHarshDeceleration]  FLOAT             NULL,
    [ScoreTriggerOverHarshAccelleration] FLOAT             NULL,
    [TermScriptConfigGroup]              INT               NULL,
    [ConfigurationGroupNameID]           INT               NULL,
    [ConfigurationGroupName]             NVARCHAR(255)     NULL,
    [FuelTypeLookupKey]                  INT               NULL,
    [EstimateCO2EmissionGramsperKm]      INT               NULL,
    [UnitTypeLookupKey]                  INT               NULL,
    [BatteryVoltage]                     NUMERIC(19,6)     NULL,
    [CurrentDeviceDriverVersion]         NVARCHAR(25)      NULL,
    [LastDeviceDriverUploadDateTime]     DATETIMEOFFSET(0) NULL,
    [LastConfigurationUploadDateTime]    DATETIMEOFFSET(0) NULL,
    [LastDeviceChangeDateTime]           DATETIMEOFFSET(0) NULL,
    [LastEventChangeDateTime]            DATETIMEOFFSET(0) NULL,
    [CreateDateKey]                      DATE              NULL,
    [IsMeasuringFuel]                    BIT               NULL,
    [IsCofiguredForMeasuringFuel]        BIT               NULL,
    [UTCOffsetKey]                       INT               NULL,
    [CreateBatchKey]                     INT               NULL,
    [UpdateBatchKey]                     INT               NULL
  );

  DECLARE @type2Keys table
  (
    VehicleKey                           int   NOT NULL,
    HostID                               int   NOT NULL,
    [ScoreTriggerOverspeeding]           FLOAT NULL,
    [ScoreTriggerOverRevving]            FLOAT NULL,
    [ScoreTriggerOverHarshDeceleration]  FLOAT NULL,
    [ScoreTriggerOverHarshAccelleration] FLOAT NULL,
    VehicleGUID                          UNIQUEIDENTIFIER NULL
  );

  -- Get range for which SCD should be calculated
  SELECT 
    @startDate    = MIN(ChangeDate),
    @maxAuditDate = MAX(ChangeDate)
  FROM
    [StageUser].Vehicles;

  TRUNCATE TABLE [StageUser].ROLLBACK_DIM_Vehicles;

  IF @debugMode = 1  -- DebugMode is true  
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set  
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';  
  END;  

  -- Loop through calculation a day at a time and Load to DW
  WHILE @StartDate <= @MaxAuditDate
    BEGIN
    -- get timezone infomation
      SELECT
        @UTCOffsetKey     = UTCOffsetKey,
        @UTCOffsetMinutes = UTCOffsetMinutes,
        @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
      FROM
        [StageUser].STAGE_DIM_UTCOffsetsLookUp
      WHERE
        @startDate     BETWEEN StartDateTime       AND EndDateTime
        AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

      SET @startDateKey       = CONVERT(date, @tmpDate);
    -- get the UTC time for the start of the next day in organisation's timezone
      SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
      SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
      TRUNCATE TABLE [StageUser].[STAGE_DIM_Vehicles];

      IF @debugMode = 1  -- DebugMode is true
        PRINT N'0. Make sure work tables are cleared for processing from ' + CONVERT(nvarchar, @startDate, 0) + ' to ' + CONVERT(nvarchar, @endDate, 0);

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
      BEGIN TRY

        ;WITH Latest (MaxRID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser].Vehicles WITH (NOLOCK)
          WHERE
            ChangeDate >= @startDate
          AND
            ChangeDate  < @endDate
          GROUP BY
            iVehicleID
        )
        INSERT INTO [StageUser].[STAGE_DIM_Vehicles]
        (
          [HostID]                    ,
          [VehicleGUID]               ,
          [VehicleDescription]        , 
          [SiteID]                    , 
          [RegNumber]                 , 
          [ServiceByDistance]         , 
          [ServiceByDate]             , 
          [ServiceByEngineSeconds]      , 
          [NextServiceDueDistance]    , 
          [NextServiceDueDateKey]     , 
          [NextServiceDueEngineSeconds] , 
          [DefaultDriverID]           , 
          [TargetFuelConsumption]     , 
          [TargetFuelConsumptionHourly], 
          [ConfigurationGroupNameID]  , 
          [ConfigurationGroupName]    ,
          [TermScriptConfigGroup]     ,
          [IsActive]                  ,
          [ucUnitType]
        )
        SELECT
          s.iVehicleID                       ,
          s.VehicleGUID                      ,
          s.sDesc                            ,
          s.liSiteID                         ,
          s.sRegNo                           ,
          s.fServiceKm                       ,
          s.ucServiceMonths                  ,
          ISNULL(s.liServiceSeconds,0)       ,
          s.fNextServiceKm                   ,
          CONVERT(DATE,s.dtNextServiceDate)  ,
          ISNULL(s.liNextServiceSeconds,0)   ,
          s.iDefaultDriver                   ,
          s.fTargetConsumption               ,
          s.fTargetHourlyConsumption         ,
          s.liGroupID                        ,
          ISNULL(vc.sName,'')                ,
          1                                  ,  -- TermScriptConfigGroup default of 1
          IsActive = CASE
                       WHEN s.Operation = 'D' THEN
                         0
                       ELSE
                         s.bActive
                     END,
          s.ucUnitType
        FROM
          Latest l 
            INNER JOIN
          [StageUser].Vehicles      s  WITH (NOLOCK) ON s.RID       = l.MaxRID
            LEFT OUTER JOIN
          [StageUser].VehicleConfig vc WITH (NOLOCK) ON s.liGroupID = vc.liGroupID;

            SET @rowcount = @@ROWCOUNT;

            IF @debugMode = 1  -- DebugMode is true
              PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    ------------------------------------------
    -- SiteGUID
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET
      SiteGUID     = ds.SiteGUID,
      SiteKey      = ds.SiteKey
    FROM
      [StageUser].[STAGE_DIM_Vehicles] stg
        INNER JOIN
      [MiXData].dbo.DIM_Sites ds WITH (NOLOCK) ON ds.OrganisationKey  = @organisationKey
                                                 AND stg.SiteID          = ds.HostID;

    ------------------------------------------
    -- DefaultDriverGUID
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET
      DefaultDriverGUID = dd.DriverGUID
    FROM
      [StageUser].[STAGE_DIM_Vehicles] stg
        INNER JOIN
      [MiXData].dbo.DIM_Drivers dd WITH (NOLOCK) ON dd.OrganisationKey  = @organisationKey
                                                   AND stg.DefaultDriverID = dd.HostID;

    ------------------------------------------
    -- ScoreTrigger fields
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET -- select
      [ScoreTriggerOverspeeding]           = vt1.lfValue,
      [ScoreTriggerOverRevving]            = vt2.lfValue,
      [ScoreTriggerOverHarshDeceleration]  = vt3.lfValue,
      [ScoreTriggerOverHarshAccelleration] = vt4.lfValue
    FROM
      [StageUser].[STAGE_DIM_Vehicles] AS stg 
        LEFT OUTER JOIN
      [StageUser].VehicleTriggers  AS vt1 
        ON stg.HostID           = vt1.iVehicleID 
        INNER JOIN
      [StageUser].ScoredEvents     AS se1 
        ON se1.ucScoreTriggerID = vt1.ucTriggerID AND 
           vt1.iEventID         = se1.iEventID 
        LEFT OUTER JOIN
      [StageUser].ScoredEvents     AS se3 
        INNER JOIN
      [StageUser].VehicleTriggers  AS vt3 
        ON se3.iEventID         = vt3.iEventID AND 
           se3.ucScoreTriggerID = vt3.ucTriggerID 
        ON stg.HostID           = vt3.iVehicleID 
        LEFT OUTER JOIN
      [StageUser].ScoredEvents     AS se2 
        INNER JOIN
      [StageUser].VehicleTriggers  AS vt2 
        ON se2.iEventID         = vt2.iEventID AND 
           se2.ucScoreTriggerID = vt2.ucTriggerID 
        ON stg.HostID           = vt2.iVehicleID
        LEFT OUTER JOIN
      [StageUser].ScoredEvents     AS se4 
        INNER JOIN
      [StageUser].VehicleTriggers  AS vt4 
        ON se4.iEventID         = vt4.iEventID AND 
           se4.ucScoreTriggerID = vt4.ucTriggerID 
        ON stg.HostID           = vt4.iVehicleID
    WHERE
        vt1.iEventID = 1  -- HardCoded from EventDescription - OverSpeeding
    AND vt2.iEventID = 2  -- HardCoded from EventDescription - OverRevving
    AND vt3.iEventID = 3  -- HardCoded from EventDescription - HarshDeceleration
    AND vt4.iEventID = 7; -- HardCoded from EventDescription - HarshAcceleration

    ------------------------------------------
    -- FuelTypeLookupKey
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET
      FuelTypeLookupKey     = dcl.LookupRID
    FROM
      [MiXData].dbo.DIM_TableColumnLookups dcl WITH (NOLOCK)
    WHERE
        dcl.LookupTable  = 'DIM_Vehicles'
    AND dcl.LookupColumn = 'FuelTypeLookupKey'
    AND dcl.LookupKey    = 2;  -- Default of Diesel for now

    ------------------------------------------
    -- EstimateCO2EmissionGramsperKm
    --   A gallon of gasoline is assumed to produce 8.8 kilograms (or 19.4 pounds) of CO2, converted to 2.321 kg/litre
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET
      EstimateCO2EmissionGramsperKm = TargetFuelConsumption * 2321.0;

    ------------------------------------------
    -- UnitTypeLookupKey
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET
      UnitTypeLookupKey = dl.LookupRID
    FROM
      [StageUser].[STAGE_DIM_Vehicles]        stg
        INNER JOIN
      [Control].UnitTypeLookups               utl WITH (NOLOCK) ON stg.ucUnitType      = utl.UnitTypeID
        INNER JOIN
      [MiXData].dbo.DIM_TableColumnLookups dl  WITH (NOLOCK) ON dl.LookupKey        = utl.UnitTypeLookupKey
    WHERE
        dl.LookupTable  = 'DIM_Units'
    AND dl.LookupColumn = 'UnitTypeLookupKey';

    ------------------------------------------
    -- CreateDateKey
    ;WITH MinChangeDate AS
    (
      SELECT
        v.iVehicleID,
        v.VehicleGUID,
        MinChangeDate = MIN(v.ChangeDate)
      FROM
        [StageUser].Vehicles v
      GROUP BY
        v.iVehicleID,
        v.VehicleGUID
    )
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET
      CreateDateKey = CONVERT(DATE,mc.MinChangeDate)
    FROM
      [StageUser].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      MinChangeDate                       mc  WITH (NOLOCK) ON mc.iVehicleID  = stg.HostID
                                                           AND mc.VehicleGUID = stg.VehicleGUID;

    ------------------------------------------
    -- TermScriptConfigGroup (Still to be defined, current default to 1)
    ------------------------------------------
    -- AverageUtilization    (Still to be defined)
    ------------------------------------------
    -- LastEngineHourReading (Still to be defined)
    ------------------------------------------
    -- IsYellowEquip

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;

    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY
    IF EXISTS (SELECT 1
               FROM
                 [StageUser].[STAGE_DIM_Vehicles]
               WHERE
                 VehicleGUID IS NULL)
    BEGIN
      RAISERROR(N'Missing Keys (possibly no values in DIM_GUIDToKeys)',16,1);
    END

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW:' + convert(nvarchar(15),@organisationKey);

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck (Type 2)
  --------------------------------------------------------------------
      BEGIN TRY

        DELETE @merged;

        MERGE INTO [MiXData].[dbo].DIM_Vehicles tar
          USING [StageUser].STAGE_DIM_Vehicles     stg
             ON tar.OrganisationKey = @organisationKey
            AND tar.HostID          = stg.HostID
        -- Matched and DW IsCurrent record (then just update)
          WHEN MATCHED
            AND tar.StartDateKey = @StartDateKey
            AND tar.EndDateKey   = @endDateDefault
            THEN UPDATE
            SET
              tar.IsActive                           = stg.IsActive                          ,
              tar.VehicleGUID                        = stg.VehicleGUID                       ,
              tar.VehicleDescription                 = stg.VehicleDescription                ,
              tar.SiteGUID                           = stg.SiteGUID                          ,
              tar.SiteKey                            = stg.SiteKey                           ,
              tar.LastServiceDateKey                 = stg.LastServiceDateKey                ,
              tar.IsYellowEquip                      = stg.IsYellowEquip                     ,
              tar.RegNumber                          = stg.RegNumber                         ,
              tar.ServiceByDistance                  = stg.ServiceByDistance                 ,
              tar.ServiceByDate                      = stg.ServiceByDate                     ,
              tar.ServiceByEngineSeconds             = stg.ServiceByEngineSeconds            ,
              tar.NextServiceDueDistance             = stg.NextServiceDueDistance            ,
              tar.NextServiceDueDateKey              = stg.NextServiceDueDateKey             ,
              tar.NextServiceDueEngineSeconds        = stg.NextServiceDueEngineSeconds       ,
              tar.DefaultDriverGUID                  = stg.DefaultDriverGUID                 ,
              tar.TargetFuelConsumption              = stg.TargetFuelConsumption             ,
              tar.TargetFuelConsumptionHourly        = stg.TargetFuelConsumptionHourly       ,
              tar.ScoreTriggerOverspeeding           = ISNULL(stg.ScoreTriggerOverspeeding          ,tar.ScoreTriggerOverspeeding          ),
              tar.ScoreTriggerOverRevving            = ISNULL(stg.ScoreTriggerOverRevving           ,tar.ScoreTriggerOverRevving           ),
              tar.ScoreTriggerOverHarshDeceleration  = ISNULL(stg.ScoreTriggerOverHarshDeceleration ,tar.ScoreTriggerOverHarshDeceleration ),
              tar.ScoreTriggerOverHarshAccelleration = ISNULL(stg.ScoreTriggerOverHarshAccelleration,tar.ScoreTriggerOverHarshAccelleration),
              tar.TermScriptConfigGroup              = stg.TermScriptConfigGroup             ,
              tar.ConfigurationGroupNameID           = stg.ConfigurationGroupNameID          ,
              tar.ConfigurationGroupName             = stg.ConfigurationGroupName            ,
              tar.FuelTypeLookupKey                  = stg.FuelTypeLookupKey                 ,
              tar.EstimateCO2EmissionGramsperKm      = stg.EstimateCO2EmissionGramsperKm     ,
              tar.UnitTypeLookupKey                  = ISNULL(stg.UnitTypeLookupKey,-1)      ,
              tar.CreateDateKey                      = CASE
                                                         WHEN ISNULL(tar.CreateDateKey,'20500101') >= ISNULL(stg.CreateDateKey,'20500101')
                                                           THEN stg.CreateDateKey
                                                         ELSE tar.CreateDateKey
                                                       END,
              tar.UTCOffsetKey                       = @UTCOffsetKey                         ,
              tar.UpdateBatchKey                     = @batchKey
        -- Not Matched -> insert new record into DW
          WHEN NOT MATCHED
            THEN INSERT
            (
              StartDateKey                      ,
              EndDateKey                        ,
              IsCurrentRecord                   ,
              IsActive                          ,
              OrganisationKey                   ,
              HostID                            ,
              VehicleGUID                       ,
              VehicleDescription                ,
              SiteGUID                          ,
              SiteKey                           ,
              LastServiceDateKey                ,
              IsYellowEquip                     ,
              RegNumber                         ,
              ServiceByDistance                 ,
              ServiceByDate                     ,
              ServiceByEngineSeconds            ,
              NextServiceDueDistance            ,
              NextServiceDueDateKey             ,
              NextServiceDueEngineSeconds       ,
              DefaultDriverGUID                 ,
              TargetFuelConsumption             ,
              TargetFuelConsumptionHourly       ,
              ScoreTriggerOverspeeding          ,
              ScoreTriggerOverRevving           ,
              ScoreTriggerOverHarshDeceleration ,
              ScoreTriggerOverHarshAccelleration,
              TermScriptConfigGroup             ,
              ConfigurationGroupNameID          ,
              ConfigurationGroupName            ,
              FuelTypeLookupKey                 ,
              EstimateCO2EmissionGramsperKm     ,
              UnitTypeLookupKey                 ,
              CreateDateKey                     ,
              
              UTCOffsetKey                      ,
              CreateBatchKey                    ,
              UpdateBatchKey
            )
            VALUES
            (
              @startDateFirstInsert                 ,
              @endDateDefault                       ,
              1                                     ,
              stg.IsActive                          ,
              @organisationKey                      ,
              stg.HostID                            ,
              stg.VehicleGUID                       ,
              stg.VehicleDescription                ,
              stg.SiteGUID                          ,
              stg.SiteKey                           ,
              stg.LastServiceDateKey                ,
              stg.IsYellowEquip                     ,
              stg.RegNumber                         ,
              stg.ServiceByDistance                 ,
              stg.ServiceByDate                     ,
              stg.ServiceByEngineSeconds            ,
              stg.NextServiceDueDistance            ,
              stg.NextServiceDueDateKey             ,
              stg.NextServiceDueEngineSeconds       ,
              stg.DefaultDriverGUID                 ,
              stg.TargetFuelConsumption             ,
              stg.TargetFuelConsumptionHourly       ,
              stg.ScoreTriggerOverspeeding          ,
              stg.ScoreTriggerOverRevving           ,
              stg.ScoreTriggerOverHarshDeceleration ,
              stg.ScoreTriggerOverHarshAccelleration,
              stg.TermScriptConfigGroup             ,
              stg.ConfigurationGroupNameID          ,
              stg.ConfigurationGroupName            ,
              stg.FuelTypeLookupKey                 ,
              stg.EstimateCO2EmissionGramsperKm     ,
              ISNULL(stg.UnitTypeLookupKey          ,-1),
              stg.CreateDateKey                     ,
              @UTCOffsetKey                         ,
              @batchKey                             ,
              @batchKey
            )
          OUTPUT
            $action   AS Operation                    ,
            ISNULL(DELETED.VehicleKey, -1)            ,
            DELETED.OrganisationKey                   ,
            DELETED.StartDateKey                      ,
            DELETED.EndDateKey                        ,
            DELETED.IsCurrentRecord                   ,
            DELETED.IsActive                          ,
            ISNULL(DELETED.HostID, INSERTED.HostID)   ,
            DELETED.VehicleGUID                       ,
            DELETED.VehicleDescription                ,
            DELETED.SiteGUID                          ,
            DELETED.SiteKey                           ,
            DELETED.LastServiceDateKey                ,
            DELETED.IsYellowEquip                     ,
            DELETED.RegNumber                         ,
            DELETED.ServiceByDistance                 ,
            DELETED.ServiceByDate                     ,
            DELETED.ServiceByEngineSeconds            ,
            DELETED.NextServiceDueDistance            ,
            DELETED.NextServiceDueDateKey             ,
            DELETED.NextServiceDueEngineSeconds       ,
            DELETED.DefaultDriverGUID                 ,
            DELETED.TargetFuelConsumption             ,
            DELETED.TargetFuelConsumptionHourly       ,
            DELETED.ScoreTriggerOverspeeding          ,
            DELETED.ScoreTriggerOverRevving           ,
            DELETED.ScoreTriggerOverHarshDeceleration ,
            DELETED.ScoreTriggerOverHarshAccelleration,
            DELETED.TermScriptConfigGroup             ,
            DELETED.ConfigurationGroupNameID          ,
            DELETED.ConfigurationGroupName            ,
            DELETED.FuelTypeLookupKey                 ,
            DELETED.EstimateCO2EmissionGramsperKm     ,
            DELETED.UnitTypeLookupKey                 ,

            DELETED.BatteryVoltage                    ,
            DELETED.CurrentDeviceDriverVersion        ,
            DELETED.LastDeviceDriverUploadDateTime    ,
            DELETED.LastConfigurationUploadDateTime   ,
            DELETED.LastDeviceChangeDateTime          ,
            DELETED.LastEventChangeDateTime           ,
            DELETED.CreateDateKey                     ,
            DELETED.IsMeasuringFuel                   ,
            DELETED.IsCofiguredForMeasuringFuel       ,

            DELETED.UTCOffsetKey                      ,
            DELETED.CreateBatchKey                    ,
            DELETED.UpdateBatchKey
            INTO @merged;
        SET @rowcount = @@ROWCOUNT;
        SELECT
          @recordsInserted += COUNT(*)
        FROM
          @merged
        WHERE
          Operation = 'INSERT';

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5.1 Merge into DW';

        INSERT INTO [StageUser].ROLLBACK_DIM_Vehicles
        (
          VehicleKey                        ,
          StartDateKey                      ,
          EndDateKey                        ,
          IsCurrentRecord                   ,
          IsActive                          ,
          OrganisationKey                   ,
          HostID                            ,
          VehicleGUID                       ,
          VehicleDescription                ,
          SiteGUID                          ,
          SiteKey                           ,
          LastServiceDateKey                ,
          IsYellowEquip                     ,
          RegNumber                         ,
          ServiceByDistance                 ,
          ServiceByDate                     ,
          ServiceByEngineSeconds            ,
          NextServiceDueDistance            ,
          NextServiceDueDateKey             ,
          NextServiceDueEngineSeconds       ,
          DefaultDriverGUID                 ,
          TargetFuelConsumption             ,
          TargetFuelConsumptionHourly       ,
          ScoreTriggerOverspeeding          ,
          ScoreTriggerOverRevving           ,
          ScoreTriggerOverHarshDeceleration ,
          ScoreTriggerOverHarshAccelleration,
          TermScriptConfigGroup             ,
          ConfigurationGroupNameID          ,
          ConfigurationGroupName            ,
          FuelTypeLookupKey                 ,
          EstimateCO2EmissionGramsperKm     ,
          UnitTypeLookupKey                 ,
          BatteryVoltage                    ,
          CurrentDeviceDriverVersion        ,
          LastDeviceDriverUploadDateTime    ,
          LastConfigurationUploadDateTime   ,
          LastDeviceChangeDateTime          ,
          LastEventChangeDateTime           ,
          CreateDateKey                     ,
          IsMeasuringFuel                   ,
          IsCofiguredForMeasuringFuel       ,
          UTCOffsetKey                      ,
          CreateBatchKey                    ,
          UpdateBatchKey
        )
        SELECT
          VehicleKey                        ,
          StartDateKey                      ,
          EndDateKey                        ,
          IsCurrentRecord                   ,
          IsActive                          ,
          OrganisationKey                   ,
          HostID                            ,
          VehicleGUID                       ,
          VehicleDescription                ,
          SiteGUID                          ,
          SiteKey                           ,
          LastServiceDateKey                ,
          IsYellowEquip                     ,
          RegNumber                         ,
          ServiceByDistance                 ,
          ServiceByDate                     ,
          ServiceByEngineSeconds            ,
          NextServiceDueDistance            ,
          NextServiceDueDateKey             ,
          NextServiceDueEngineSeconds       ,
          DefaultDriverGUID                 ,
          TargetFuelConsumption             ,
          TargetFuelConsumptionHourly       ,
          ScoreTriggerOverspeeding          ,
          ScoreTriggerOverRevving           ,
          ScoreTriggerOverHarshDeceleration ,
          ScoreTriggerOverHarshAccelleration,
          TermScriptConfigGroup             ,
          ConfigurationGroupNameID          ,
          ConfigurationGroupName            ,
          FuelTypeLookupKey                 ,
          EstimateCO2EmissionGramsperKm     ,
          UnitTypeLookupKey                 ,
          BatteryVoltage                    ,
          CurrentDeviceDriverVersion        ,
          LastDeviceDriverUploadDateTime    ,
          LastConfigurationUploadDateTime   ,
          LastDeviceChangeDateTime          ,
          LastEventChangeDateTime           ,
          CreateDateKey                     ,
          IsMeasuringFuel                   ,
          IsCofiguredForMeasuringFuel       ,
          UTCOffsetKey                      ,
          CreateBatchKey                    ,
          UpdateBatchKey
        FROM
          @merged
        WHERE
          Operation        = 'UPDATE'
          AND UpdateBatchKey < @batchKey; -- end insert
        SET @recordsUpdated += @@ROWCOUNT;
        
       IF @debugMode = 1
          PRINT '    after merge: rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

  --------------------------------------------------------------------
      -- type 2 changes -> first expire current
        DELETE @type2Keys;
        INSERT INTO @type2Keys
        (
          VehicleKey                          ,
          HostID                              ,
          [ScoreTriggerOverspeeding]          ,
          [ScoreTriggerOverRevving]           ,
          [ScoreTriggerOverHarshDeceleration] ,
          [ScoreTriggerOverHarshAccelleration],
          VehicleGUID
        )
        SELECT
          tar.VehicleKey                          ,
          tar.HostID                              ,
          tar.[ScoreTriggerOverspeeding]          ,
          tar.[ScoreTriggerOverRevving]           ,
          tar.[ScoreTriggerOverHarshDeceleration] ,
          tar.[ScoreTriggerOverHarshAccelleration],
          tar.VehicleGUID
        FROM
          [MiXData].[dbo].DIM_Vehicles tar
          INNER JOIN [StageUser].STAGE_DIM_Vehicles stg ON tar.OrganisationKey = @organisationKey
                                                       AND tar.HostID          = stg.HostID
        WHERE
          tar.StartDateKey      < @StartDateKey
          AND  tar.EndDateKey   = @endDateDefault
          AND (ISNULL(tar.ScoreTriggerOverspeeding          ,0.0) <> ISNULL(stg.ScoreTriggerOverspeeding          ,tar.ScoreTriggerOverspeeding)
            OR ISNULL(tar.ScoreTriggerOverRevving           ,0.0) <> ISNULL(stg.ScoreTriggerOverRevving           ,tar.ScoreTriggerOverRevving)
            OR ISNULL(tar.ScoreTriggerOverHarshDeceleration ,0.0) <> ISNULL(stg.ScoreTriggerOverHarshDeceleration ,tar.ScoreTriggerOverHarshDeceleration)
            OR ISNULL(tar.ScoreTriggerOverHarshAccelleration,0.0) <> ISNULL(stg.ScoreTriggerOverHarshAccelleration,tar.ScoreTriggerOverHarshAccelleration)
            OR tar.IsActive                                       <> stg.IsActive
            OR ISNULL(tar.SiteGUID,@defaultIdentifierValue)       <> ISNULL(stg.SiteGUID,@defaultIdentifierValue)
            OR tar.UnitTypeLookupKey                              <> ISNULL(stg.UnitTypeLookupKey,-1)
            OR tar.VehicleGUID                                    <> stg.VehicleGUID
              );
        SET @rowcount = @@ROWCOUNT;

        INSERT INTO [StageUser].ROLLBACK_DIM_Vehicles
        (
          [VehicleKey]                        ,
          [OrganisationKey]                   ,
          [StartDateKey]                      ,
          [EndDateKey]                        ,
          [IsCurrentRecord]                   ,
          [IsActive]                          ,
          [HostID]                            ,
          [VehicleGUID]                       ,
          [VehicleDescription]                ,
          [SiteGUID]                          ,
          [SiteKey]                           ,
          [LastServiceDateKey]                ,
          [IsYellowEquip]                     ,
          [RegNumber]                         ,
          [ServiceByDistance]                 ,
          [ServiceByDate]                     ,
          [ServiceByEngineSeconds]            ,
          [NextServiceDueDistance]            ,
          [NextServiceDueDateKey]             ,
          [NextServiceDueEngineSeconds]       ,
          [DefaultDriverGUID]                 ,
          [TargetFuelConsumption]             ,
          [TargetFuelConsumptionHourly]       ,
          [ScoreTriggerOverspeeding]          ,
          [ScoreTriggerOverRevving]           ,
          [ScoreTriggerOverHarshDeceleration] ,
          [ScoreTriggerOverHarshAccelleration],
          [TermScriptConfigGroup]             ,
          [ConfigurationGroupNameID]          ,
          [ConfigurationGroupName]            ,
          [FuelTypeLookupKey]                 ,
          [EstimateCO2EmissionGramsperKm]     ,
          [UnitTypeLookupKey]                 ,
          BatteryVoltage                      ,
          CurrentDeviceDriverVersion          ,
          LastDeviceDriverUploadDateTime      ,
          LastConfigurationUploadDateTime     ,
          LastDeviceChangeDateTime            ,
          LastEventChangeDateTime             ,
          CreateDateKey                       ,
          IsMeasuringFuel                     ,
          IsCofiguredForMeasuringFuel         ,
          [UTCOffsetKey]                      ,
          [CreateBatchKey]                    ,
          [UpdateBatchKey]
        )
        SELECT
          [VehicleKey]                        ,
          [OrganisationKey]                   ,
          [StartDateKey]                      ,
          [EndDateKey]                        ,
          [IsCurrentRecord]                   ,
          [IsActive]                          ,
          [HostID]                            ,
          [VehicleGUID]                       ,
          [VehicleDescription]                ,
          [SiteGUID]                          ,
          [SiteKey]                           ,
          [LastServiceDateKey]                ,
          [IsYellowEquip]                     ,
          [RegNumber]                         ,
          [ServiceByDistance]                 ,
          [ServiceByDate]                     ,
          [ServiceByEngineSeconds]            ,
          [NextServiceDueDistance]            ,
          [NextServiceDueDateKey]             ,
          [NextServiceDueEngineSeconds]       ,
          [DefaultDriverGUID]                 ,
          [TargetFuelConsumption]             ,
          [TargetFuelConsumptionHourly]       ,
          [ScoreTriggerOverspeeding]          ,
          [ScoreTriggerOverRevving]           ,
          [ScoreTriggerOverHarshDeceleration] ,
          [ScoreTriggerOverHarshAccelleration],
          [TermScriptConfigGroup]             ,
          [ConfigurationGroupNameID]          ,
          [ConfigurationGroupName]            ,
          [FuelTypeLookupKey]                 ,
          [EstimateCO2EmissionGramsperKm]     ,
          [UnitTypeLookupKey]                 ,
          BatteryVoltage                      ,
          CurrentDeviceDriverVersion          ,
          LastDeviceDriverUploadDateTime      ,
          LastConfigurationUploadDateTime     ,
          LastDeviceChangeDateTime            ,
          LastEventChangeDateTime             ,
          CreateDateKey                       ,
          IsMeasuringFuel                     ,
          IsCofiguredForMeasuringFuel         ,
          [UTCOffsetKey]                      ,
          [CreateBatchKey]                    ,
          [UpdateBatchKey]
        FROM
         (
          UPDATE
            [MiXData].[dbo].DIM_Vehicles
          SET
            EndDateKey      = @previousEndDateKey,
            IsCurrentRecord = 0,
            UpdateBatchKey  = @batchKey
          OUTPUT
            DELETED.[VehicleKey]                        ,
            DELETED.[OrganisationKey]                   ,
            DELETED.[StartDateKey]                      ,
            DELETED.[EndDateKey]                        ,
            DELETED.[IsCurrentRecord]                   ,
            DELETED.[IsActive]                          ,
            DELETED.[HostID]                            ,
            DELETED.[VehicleGUID]                       ,
            DELETED.[VehicleDescription]                ,
            DELETED.[SiteGUID]                          ,
            DELETED.[SiteKey]                           ,
            DELETED.[LastServiceDateKey]                ,
            DELETED.[IsYellowEquip]                     ,
            DELETED.[RegNumber]                         ,
            DELETED.[ServiceByDistance]                 ,
            DELETED.[ServiceByDate]                     ,
            DELETED.[ServiceByEngineSeconds]            ,
            DELETED.[NextServiceDueDistance]            ,
            DELETED.[NextServiceDueDateKey]             ,
            DELETED.[NextServiceDueEngineSeconds]       ,
            DELETED.[DefaultDriverGUID]                 ,
            DELETED.[TargetFuelConsumption]             ,
            DELETED.[TargetFuelConsumptionHourly]       ,
            DELETED.[ScoreTriggerOverspeeding]          ,
            DELETED.[ScoreTriggerOverRevving]           ,
            DELETED.[ScoreTriggerOverHarshDeceleration] ,
            DELETED.[ScoreTriggerOverHarshAccelleration],
            DELETED.[TermScriptConfigGroup]             ,
            DELETED.[ConfigurationGroupNameID]          ,
            DELETED.[ConfigurationGroupName]            ,
            DELETED.[FuelTypeLookupKey]                 ,
            DELETED.[EstimateCO2EmissionGramsperKm]     ,
            DELETED.[UnitTypeLookupKey]                 ,

            DELETED.BatteryVoltage                      ,
            DELETED.CurrentDeviceDriverVersion          ,
            DELETED.LastDeviceDriverUploadDateTime      ,
            DELETED.LastConfigurationUploadDateTime     ,
            DELETED.LastDeviceChangeDateTime            ,
            DELETED.LastEventChangeDateTime             ,
            DELETED.CreateDateKey                       ,
            DELETED.IsMeasuringFuel                     ,
            DELETED.IsCofiguredForMeasuringFuel         ,

            DELETED.[UTCOffsetKey]                      ,
            DELETED.[CreateBatchKey]                    ,
            DELETED.[UpdateBatchKey]
          FROM
            [MiXData].[dbo].DIM_Vehicles tar
            INNER JOIN @type2Keys k ON tar.VehicleKey = k.VehicleKey
          ) AS RollBck              -- end update
        WHERE
          UpdateBatchKey < @batchKey; -- end insert

        -- Insert new Records for Type 2 changes
        INSERT INTO [MiXData].[dbo].DIM_Vehicles
        (
          StartDateKey                        ,
          EndDateKey                          ,
          IsCurrentRecord                     ,
          IsActive                            ,
          OrganisationKey                     ,
          HostID                              ,
          [VehicleGUID]                       ,
          [VehicleDescription]                ,
          [SiteGUID]                          ,
          [SiteKey]                           ,
          [LastServiceDateKey]                ,
          [IsYellowEquip]                     ,
          [RegNumber]                         ,
          [ServiceByDistance]                 ,
          [ServiceByDate]                     ,
          [ServiceByEngineSeconds]            ,
          [NextServiceDueDistance]            ,
          [NextServiceDueDateKey]             ,
          [NextServiceDueEngineSeconds]       ,
          [DefaultDriverGUID]                 ,
          [TargetFuelConsumption]             ,
          [TargetFuelConsumptionHourly]       ,
          [ScoreTriggerOverspeeding]          ,
          [ScoreTriggerOverRevving]           ,
          [ScoreTriggerOverHarshDeceleration] ,
          [ScoreTriggerOverHarshAccelleration],
          [TermScriptConfigGroup]             ,
          [ConfigurationGroupNameID]          ,
          [ConfigurationGroupName]            ,
          [FuelTypeLookupKey]                 ,
          [EstimateCO2EmissionGramsperKm]     ,
          [UnitTypeLookupKey]                 ,
          CreateDateKey                       ,
          UTCOffsetKey                        ,
          CreateBatchKey                      ,
          UpdateBatchKey
        )
        SELECT
          @startDateKey                           ,
          @endDateDefault                         ,
          1                                       ,
          stg.IsActive                            ,
          @organisationKey                        ,
          stg.HostID                              ,
          stg.[VehicleGUID]                       ,
          stg.[VehicleDescription]                ,
          stg.[SiteGUID]                          ,
          stg.[SiteKey]                           ,
          stg.[LastServiceDateKey]                ,
          stg.[IsYellowEquip]                     ,
          stg.[RegNumber]                         ,
          stg.[ServiceByDistance]                 ,
          stg.[ServiceByDate]                     ,
          stg.[ServiceByEngineSeconds]            ,
          stg.[NextServiceDueDistance]            ,
          stg.[NextServiceDueDateKey]             ,
          stg.[NextServiceDueEngineSeconds]       ,
          stg.[DefaultDriverGUID]                 ,
          stg.[TargetFuelConsumption]             ,
          stg.[TargetFuelConsumptionHourly]       ,
          ISNULL(stg.[ScoreTriggerOverspeeding]          ,k.[ScoreTriggerOverspeeding]          ),
          ISNULL(stg.[ScoreTriggerOverRevving]           ,k.[ScoreTriggerOverRevving]           ),
          ISNULL(stg.[ScoreTriggerOverHarshDeceleration] ,k.[ScoreTriggerOverHarshDeceleration] ),
          ISNULL(stg.[ScoreTriggerOverHarshAccelleration],k.[ScoreTriggerOverHarshAccelleration]),
          stg.[TermScriptConfigGroup]             ,
          stg.[ConfigurationGroupNameID]          ,
          stg.[ConfigurationGroupName]            ,
          stg.[FuelTypeLookupKey]                 ,
          stg.[EstimateCO2EmissionGramsperKm]     ,
          ISNULL(stg.[UnitTypeLookupKey]          ,-1),
          stg.CreateDateKey                       ,
          @UTCOffsetKey                           ,
          @batchKey                               ,
          @batchKey
        FROM
          [StageUser].STAGE_DIM_Vehicles stg
          INNER JOIN @type2Keys k ON stg.HostID = k.HostID;
        SET @recordsType2Inserted += @@ROWCOUNT;

        IF @debugMode = 1
          PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

      SELECT
        @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
      FROM
        [StageUser].Vehicles
      WHERE
        ChangeDate >= @endDate;
    
    END -- END WHILE

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='1. Loop through and apply latest changes + type 2 changes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 1. Loop through and apply latest changes + type 2 changes';
    END;

  --------------------------------------------------------------------
  -- 6.1 Update Type 1 columns on DW
  --------------------------------------------------------------------
  BEGIN TRY

    -- only need to stage keys and type1 columns
    TRUNCATE TABLE [StageUser].STAGE_DIM_Vehicles;
    ;WITH Latest (RID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser].Vehicles WITH (NOLOCK)
      GROUP BY
        iVehicleID,
        VehicleGUID
    )
    INSERT INTO [StageUser].[STAGE_DIM_Vehicles]
    (
      [HostID]                    ,
      [VehicleGUID]               ,
      [VehicleDescription]        , 
      [RegNumber]                 , 
      [ServiceByDistance]         , 
      [ServiceByDate]             , 
      [ServiceByEngineSeconds]    , 
      [NextServiceDueDistance]    , 
      [NextServiceDueDateKey]     , 
      [NextServiceDueEngineSeconds], 
      [TargetFuelConsumption]     ,
      [TargetFuelConsumptionHourly],
      [EstimateCO2EmissionGramsperKm],
      [ConfigurationGroupNameID]  , 
      [ConfigurationGroupName]    ,
      [IsActive]
    )
    SELECT
      s.iVehicleID                       ,
      s.VehicleGUID                      ,
      s.sDesc                            ,
      s.sRegNo                           ,
      s.fServiceKm                       ,
      s.ucServiceMonths                  ,
      ISNULL(s.liServiceSeconds,0)/60    ,
      s.fNextServiceKm                   ,
      CONVERT(DATE,s.dtNextServiceDate)  ,
      ISNULL(s.liNextServiceSeconds,0)/60,
      s.fTargetConsumption               ,
      s.fTargetHourlyConsumption         ,
      s.fTargetConsumption * 2321.0      ,  
      s.liGroupID                        ,
      ISNULL(vc.sName,'')                ,
      s.bActive
    FROM
      Latest l 
        INNER JOIN
      [StageUser].Vehicles      s  WITH (NOLOCK) ON s.RID       = l.RID
        LEFT OUTER JOIN
      [StageUser].VehicleConfig vc WITH (NOLOCK) ON s.liGroupID = vc.liGroupID;

    INSERT INTO [StageUser].[ROLLBACK_DIM_Vehicles]
    ( 
      [VehicleKey]                        ,
      [OrganisationKey]                   ,
      [StartDateKey]                      ,
      [EndDateKey]                        ,
      [IsCurrentRecord]                   ,
      [IsActive]                          ,
      [HostID]                            ,
      [VehicleGUID]                       ,
      [VehicleDescription]                ,
      [SiteGUID]                          ,
      [SiteKey]                           ,
      [LastServiceDateKey]                ,
      [IsYellowEquip]                     ,
      [RegNumber]                         ,
      [ServiceByDistance]                 ,
      [ServiceByDate]                     ,
      [ServiceByEngineSeconds]            ,
      [NextServiceDueDistance]            ,
      [NextServiceDueDateKey]             ,
      [NextServiceDueEngineSeconds]       ,
      [DefaultDriverGUID]                 ,
      [TargetFuelConsumption]             ,
      [TargetFuelConsumptionHourly]       ,
      [ScoreTriggerOverspeeding]          ,
      [ScoreTriggerOverRevving]           ,
      [ScoreTriggerOverHarshDeceleration] ,
      [ScoreTriggerOverHarshAccelleration],
      [TermScriptConfigGroup]             ,
      [ConfigurationGroupNameID]          ,
      [ConfigurationGroupName]            ,
      [FuelTypeLookupKey]                 ,
      [EstimateCO2EmissionGramsperKm]     ,
      [UnitTypeLookupKey]                 ,
      BatteryVoltage                      ,
      CurrentDeviceDriverVersion          ,
      LastDeviceDriverUploadDateTime      ,
      LastConfigurationUploadDateTime     ,
      LastDeviceChangeDateTime            ,
      LastEventChangeDateTime             ,
      CreateDateKey                       ,
      IsMeasuringFuel                     ,
      IsCofiguredForMeasuringFuel         ,
      [UTCOffsetKey]                      ,
      [CreateBatchKey]                    ,
      [UpdateBatchKey]
    )
    SELECT
      [VehicleKey]                        ,
      [OrganisationKey]                   ,
      [StartDateKey]                      ,
      [EndDateKey]                        ,
      [IsCurrentRecord]                   ,
      [IsActive]                          ,
      [HostID]                            ,
      [VehicleGUID]                       ,
      [VehicleDescription]                ,
      [SiteGUID]                          ,
      [SiteKey]                           ,
      [LastServiceDateKey]                ,
      [IsYellowEquip]                     ,
      [RegNumber]                         ,
      [ServiceByDistance]                 ,
      [ServiceByDate]                     ,
      [ServiceByEngineSeconds]            ,
      [NextServiceDueDistance]            ,
      [NextServiceDueDateKey]             ,
      [NextServiceDueEngineSeconds]       ,
      [DefaultDriverGUID]                 ,
      [TargetFuelConsumption]             ,
      [TargetFuelConsumptionHourly]       ,
      [ScoreTriggerOverspeeding]          ,
      [ScoreTriggerOverRevving]           ,
      [ScoreTriggerOverHarshDeceleration] ,
      [ScoreTriggerOverHarshAccelleration],
      [TermScriptConfigGroup]             ,
      [ConfigurationGroupNameID]          ,
      [ConfigurationGroupName]            ,
      [FuelTypeLookupKey]                 ,
      [EstimateCO2EmissionGramsperKm]     ,
      [UnitTypeLookupKey]                 ,
      BatteryVoltage                      ,
      CurrentDeviceDriverVersion          ,
      LastDeviceDriverUploadDateTime      ,
      LastConfigurationUploadDateTime     ,
      LastDeviceChangeDateTime            ,
      LastEventChangeDateTime             ,
      CreateDateKey                       ,
      IsMeasuringFuel                     ,
      IsCofiguredForMeasuringFuel         ,
      [UTCOffsetKey]                      ,
      [CreateBatchKey]                    ,
      [UpdateBatchKey]
    FROM 
     (UPDATE tar
      SET
        [VehicleDescription]         = stg.[VehicleDescription]       ,
        [RegNumber]                  = stg.[RegNumber]                ,
        [ServiceByDistance]          = stg.[ServiceByDistance]        ,
        [ServiceByDate]              = stg.[ServiceByDate]            ,
        [ServiceByEngineSeconds]     = stg.[ServiceByEngineSeconds]   ,
        [NextServiceDueDistance]     = stg.[NextServiceDueDistance]   ,
        [NextServiceDueDateKey]      = stg.[NextServiceDueDateKey]    ,
        [NextServiceDueEngineSeconds]= stg.[NextServiceDueEngineSeconds],
        [TargetFuelConsumption]      = stg.[TargetFuelConsumption]    ,
        [TargetFuelConsumptionHourly]= stg.[TargetFuelConsumptionHourly],
        [ConfigurationGroupNameID]   = stg.[ConfigurationGroupNameID] ,       
        [ConfigurationGroupName]     = stg.[ConfigurationGroupName]   ,       
        [EstimateCO2EmissionGramsperKm] = stg.[EstimateCO2EmissionGramsperKm],
        UpdateBatchKey               = @batchKey
      OUTPUT
        DELETED.[VehicleKey]                        ,
        DELETED.[OrganisationKey]                   ,
        DELETED.[StartDateKey]                      ,
        DELETED.[EndDateKey]                        ,
        DELETED.[IsCurrentRecord]                   ,
        DELETED.[IsActive]                          ,
        DELETED.[HostID]                            ,
        DELETED.[VehicleGUID]                       ,
        DELETED.[VehicleDescription]                ,
        DELETED.[SiteGUID]                          ,
        DELETED.[SiteKey]                           ,
        DELETED.[LastServiceDateKey]                ,
        DELETED.[IsYellowEquip]                     ,
        DELETED.[RegNumber]                         ,
        DELETED.[ServiceByDistance]                 ,
        DELETED.[ServiceByDate]                     ,
        DELETED.[ServiceByEngineSeconds]            ,
        DELETED.[NextServiceDueDistance]            ,
        DELETED.[NextServiceDueDateKey]             ,
        DELETED.[NextServiceDueEngineSeconds]       ,
        DELETED.[DefaultDriverGUID]                 ,
        DELETED.[TargetFuelConsumption]             ,
        DELETED.[TargetFuelConsumptionHourly]       ,
        DELETED.[ScoreTriggerOverspeeding]          ,
        DELETED.[ScoreTriggerOverRevving]           ,
        DELETED.[ScoreTriggerOverHarshDeceleration] ,
        DELETED.[ScoreTriggerOverHarshAccelleration],
        DELETED.[TermScriptConfigGroup]             ,
        DELETED.[ConfigurationGroupNameID]          ,
        DELETED.[ConfigurationGroupName]            ,
        DELETED.[FuelTypeLookupKey]                 ,
        DELETED.[EstimateCO2EmissionGramsperKm]     ,
        DELETED.[UnitTypeLookupKey]                 ,
        DELETED.BatteryVoltage                      ,
        DELETED.CurrentDeviceDriverVersion          ,
        DELETED.LastDeviceDriverUploadDateTime      ,
        DELETED.LastConfigurationUploadDateTime     ,
        DELETED.LastDeviceChangeDateTime            ,
        DELETED.LastEventChangeDateTime             ,
        DELETED.CreateDateKey                       ,
        DELETED.IsMeasuringFuel                     ,
        DELETED.IsCofiguredForMeasuringFuel         ,
        DELETED.[UTCOffsetKey]                      ,
        DELETED.[CreateBatchKey]                    ,
        DELETED.[UpdateBatchKey]
      FROM
        [MiXData].dbo.DIM_Vehicles tar
          INNER JOIN
        [StageUser].STAGE_DIM_Vehicles stg ON tar.OrganisationKey          = @organisationKey
                                          AND tar.HostID                   = stg.HostID
    ) rllbck
    WHERE
      UpdateBatchKey < @batchKey;

    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.1 Update Type 1 columns on DW', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.1 Update Type 1 columns on DW';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6.2 Update IsCurrentRecord columns on DW
  --------------------------------------------------------------------
  BEGIN TRY

    TRUNCATE TABLE [StageUser].STAGE_DIM_Vehicles;
    
    -- insert all records that would be affected
    INSERT INTO [StageUser].STAGE_DIM_Vehicles
    ( HostID )
    SELECT DISTINCT
      iVehicleID
    FROM
      [StageUser].Vehicles
    UNION
    SELECT DISTINCT
      iVehicleID         = s.liObjectID
    FROM
      [StageUser].[ExtensionProperties_FACT] s WITH (NOLOCK)
    WHERE 
        s.sAppID    = 'FMSchedulerPro'
    AND s.sProperty = 'VehicleStatus'
    UNION
    SELECT DISTINCT
      iVehicleID
    FROM
      [StageUser].VehicleDeviceProperties vdp WITH (NOLOCK)
    UNION
    SELECT DISTINCT
      iVehicleID
    FROM
      [StageUser].VehicleDevices vd
    UNION
    SELECT DISTINCT
      iVehicleID
    FROM
      [StageUser].VehicleDeviceParam vdm
    UNION
    SELECT DISTINCT
      iVehicleID
    FROM
      [StageUser].VehicleEvent ve
    UNION
    SELECT DISTINCT
      iVehicleID
    FROM
      [StageUser].VehicleTriggers vt
    UNION
    SELECT DISTINCT vd.iVehicleID
    FROM -- select top 20 * from
      [StageUser].[Param]        p
        INNER JOIN
      audit.VehicleDevices_CT     vd  ON vd.OrganisationKey  = @organisationKey
        INNER JOIN
      audit.VehicleDeviceParam_CT vdp ON vdp.OrganisationKey = vd.OrganisationKey
                                     AND vdp.iVehicleID      = vd.iVehicleID
                                     AND vdp.liDeviceID      = vd.liDeviceID
                                     AND vdp.iParameterID    = p.iParameterID
    WHERE p.bFuelCounter = 1;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.1 Update IsCurrentRecord columns on DW - Identification', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.1 Update IsCurrentRecord columns on DW - Identification';
    END;

    ------------------------------------------
    -- Update IsCurrent columns
    ------------------------------------------
    
    ------------------------------------------
    -- BatteryVoltage
    ;WITH VehicleStatus AS
    (
      SELECT
        VehicleID         = s.liObjectID,
        RetrievedDateTime = CONVERT(DATETIME,dbo.fncGetListItemFloat(ISNULL(s.sValue,''),'Retrieved',0)),
        BatteryVoltage    = dbo.fncGetListItemFloat(ISNULL(s.sValue,''),'BatVoltage',0)
      FROM
        [StageUser].[ExtensionProperties_FACT] s WITH (NOLOCK)
      WHERE 
          s.sAppID    = 'FMSchedulerPro'
      AND s.sProperty = 'VehicleStatus'
    ),
    LastVehicleStatus AS
    (
      SELECT
        VehicleID,
        LastRetrievedDateTime = MAX(RetrievedDateTime)
      FROM
        VehicleStatus
      GROUP BY
        VehicleID
    )
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET
      BatteryVoltage = CASE
                         WHEN vs.BatteryVoltage > 1000000.0  -- 1kV
                           THEN 1000000.0
                         ELSE
                           vs.BatteryVoltage
                       END
    FROM
      [StageUser].[STAGE_DIM_Vehicles] stg
        INNER JOIN
      LastVehicleStatus                lvs ON lvs.VehicleID = stg.HostID
        INNER JOIN
      VehicleStatus                    vs  ON vs.VehicleID         = lvs.VehicleID
                                          AND vs.RetrievedDateTime = LastRetrievedDateTime;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.2 Update IsCurrentRecord columns on DW - BatteryVoltage', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.2 Update IsCurrentRecord columns on DW - BatteryVoltage';
    END;

    ------------------------------------------
    -- CurrentDeviceDriverVersion
    ;WITH LastestVehicleDeviceProperties AS
    (
      SELECT
        MaxRID = MAX(RID)
      FROM
        [StageUser].VehicleDeviceProperties
      WHERE
          liDeviceID  = 0
      AND sProperty   = 'DriverSetVersion'
      GROUP BY
        iVehicleID    
    )
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET
      CurrentDeviceDriverVersion = ISNULL(vdp.sValue,'')
    FROM
      [StageUser].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      [StageUser].VehicleDeviceProperties vdp WITH (NOLOCK) ON vdp.iVehicleID  = stg.HostID
                                                           AND vdp.liDeviceID  = 0
                                                           AND vdp.sProperty   = 'DriverSetVersion'
        INNER JOIN
      LastestVehicleDeviceProperties       lvdp              ON lvdp.MaxRID    = vdp.RID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.3 Update IsCurrentRecord columns on DW - CurrentDeviceDriverVersion', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.3 Update IsCurrentRecord columns on DW - CurrentDeviceDriverVersion';
    END;

    ------------------------------------------
    -- LastDeviceDriverUploadDateTime
    ;WITH LastestVehicleDeviceProperties AS
    (
      SELECT
        MaxRID = MAX(RID)
      FROM
        [StageUser].VehicleDeviceProperties
      WHERE
          liDeviceID  = 0
      AND sProperty   = 'DriverSetLoadDate'
      GROUP BY
        iVehicleID    
    )
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET
      LastDeviceDriverUploadDateTime = DATEADD(s,CONVERT(INT,vdp.sValue),'19700101')
    FROM
      [StageUser].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      [StageUser].VehicleDeviceProperties vdp WITH (NOLOCK) ON vdp.iVehicleID  = stg.HostID
                                                           AND vdp.liDeviceID  = 0
                                                           AND vdp.sProperty   = 'DriverSetLoadDate'
        INNER JOIN
      LastestVehicleDeviceProperties       lvdp              ON lvdp.MaxRID    = vdp.RID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.4 Update IsCurrentRecord columns on DW - LastDeviceDriverUploadDateTime', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.4 Update IsCurrentRecord columns on DW - LastDeviceDriverUploadDateTime';
    END;

    ------------------------------------------
    -- LastConfigurationUploadDateTime
    ;WITH LastestVehicleDeviceProperties AS
    (
      SELECT
        MaxRID = MAX(RID)
      FROM
        [StageUser].VehicleDeviceProperties
      WHERE
          liDeviceID  = 0
      AND sProperty   = 'LastConfig'
      GROUP BY
        iVehicleID    
    )
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET
      LastConfigurationUploadDateTime = DATEADD(s,CONVERT(INT,vdp.sValue),'19700101')
    FROM
      [StageUser].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      [StageUser].VehicleDeviceProperties vdp WITH (NOLOCK) ON vdp.iVehicleID  = stg.HostID
                                                           AND vdp.liDeviceID  = 0
                                                           AND vdp.sProperty   = 'LastConfig'
        INNER JOIN
      LastestVehicleDeviceProperties       lvdp              ON lvdp.MaxRID    = vdp.RID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.5 Update IsCurrentRecord columns on DW - LastConfigurationUploadDateTime', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.5 Update IsCurrentRecord columns on DW - LastConfigurationUploadDateTime';
    END;

    ------------------------------------------
    -- LastDeviceChangeDateTime
    ;WITH AllLastDeviceChangeDates AS
    (
      SELECT
        vdp.iVehicleID,
        MaxChangeDate = MAX(vdp.ChangeDate)
      FROM
        [StageUser].VehicleDeviceProperties vdp
      WHERE 
        vdp.sProperty NOT IN ('LastConfig','DriverSetLoadDate','DriverSetVersion')
      GROUP BY
        vdp.iVehicleID
      UNION
      SELECT
        vd.iVehicleID,
        MaxChangeDate = MAX(vd.ChangeDate)
      FROM
        [StageUser].VehicleDevices vd
      GROUP BY
        vd.iVehicleID
      UNION
      SELECT
        vdm.iVehicleID,
        MaxChangeDate = MAX(vdm.ChangeDate)
      FROM
        [StageUser].VehicleDeviceParam vdm
      GROUP BY
        vdm.iVehicleID
    ),
    LastDeviceChangeDates AS
    (
      SELECT
        iVehicleID,
        MaxChangeDate = MAX(MaxChangeDate)
      FROM
        AllLastDeviceChangeDates
      GROUP BY
        iVehicleID
    )
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET
      LastDeviceChangeDateTime = ldc.MaxChangeDate
    FROM
      [StageUser].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      LastDeviceChangeDates               ldc WITH (NOLOCK) ON ldc.iVehicleID  = stg.HostID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.6 Update IsCurrentRecord columns on DW - LastDeviceChangeDateTime', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.6 Update IsCurrentRecord columns on DW - LastDeviceChangeDateTime';
    END;

    ------------------------------------------
    -- LastEventChangeDateTime
    ;WITH AllLastEventChangeDates AS
    (
      SELECT
        ve.iVehicleID,
        MaxChangeDate = MAX(ve.ChangeDate)
      FROM
        [StageUser].VehicleEvent ve
      GROUP BY
        ve.iVehicleID
      UNION
      SELECT
        vt.iVehicleID,
        MaxChangeDate = MAX(vt.ChangeDate)
      FROM
        [StageUser].VehicleTriggers vt
      GROUP BY
        vt.iVehicleID
    ),
    LastEventChangeDates AS
    (
      SELECT
        iVehicleID,
        MaxChangeDate = MAX(MaxChangeDate)
      FROM
        AllLastEventChangeDates
      GROUP BY
        iVehicleID
    )
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET
      LastEventChangeDateTime = lec.MaxChangeDate
    FROM
      [StageUser].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      LastEventChangeDates                lec WITH (NOLOCK) ON lec.iVehicleID  = stg.HostID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.7 Update IsCurrentRecord columns on DW - LastEventChangeDateTime', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.7 Update IsCurrentRecord columns on DW - LastEventChangeDateTime';
    END;

    ------------------------------------------
    -- IsMeasuringFuel
    ;WITH ActivityData AS
    (
      SELECT
        td.VehicleID,
        MaxLitres = MAX(std.Litres)
      FROM
        [StageUser].TripData    td  WITH (NOLOCK)
          INNER JOIN
        [StageUser].SubTripData std WITH (NOLOCK) ON std.TripID = td.TripID
      GROUP BY
        td.VehicleID
    )
    UPDATE
      [StageUser].[STAGE_DIM_Vehicles]
    SET
      IsMeasuringFuel = CASE
                          WHEN MaxLitres IS NULL
                            THEN 0
                          ELSE 1
                        END
    FROM
      [StageUser].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      ActivityData                        ad  ON ad.VehicleID  = stg.HostID;


    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.8 Update IsCurrentRecord columns on DW - IsMeasuringFuel', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.8 Update IsCurrentRecord columns on DW - IsMeasuringFuel';
    END;

    ------------------------------------------
    -- IsCofiguredForMeasuringFuel
    DECLARE @Param TABLE (iParameterID INT PRIMARY KEY);
    DECLARE @VehicleDeviceParam TABLE
    (iVehicleID INT,liDeviceID INT,iParameterID INT,
    PRIMARY KEY (iVehicleID,liDeviceID,iParameterID));

    ;WITH AllParams AS
    (
      SELECT
        RID = HostRID,
        iParameterID
      FROM
        audit.Param_CT WITH (NOLOCK)
      WHERE OrganisationKey = @organisationKey
      UNION
      SELECT
        RID,
        iParameterID
      FROM
        [StageUser].Param WITH (NOLOCK)
    ),
    LastestParams (RID) AS
    (
      SELECT
        MAX(RID)
      FROM AllParams
      GROUP BY
        iParameterID
    )
    INSERT INTO @Param
    SELECT
      p.iParameterID
    FROM
      audit.Param_CT p  WITH (NOLOCK)
        INNER JOIN
      LastestParams  lp ON p.OrganisationKey = @organisationKey
                       AND lp.RID            = p.HostRID
    WHERE
        p.bFuelCounter = 1
    AND p.Operation    <> 'D'
    UNION
    SELECT
      p.iParameterID
    FROM
      [StageUser].Param p  WITH (NOLOCK)
        INNER JOIN
      LastestParams  lp ON lp.RID = p.RID
    WHERE
        p.bFuelCounter = 1
    AND p.Operation    <> 'D';

    ;WITH AllVehicleDeviceParams AS
    (
      SELECT
        RID = vdp.HostRID,
        vdp.iVehicleID,
        vdp.liDeviceID,
        vdp.iParameterID
      FROM
        @Param                      p
          INNER JOIN
        audit.VehicleDeviceParam_CT vdp WITH (NOLOCK) ON vdp.OrganisationKey = @organisationKey
                                                     AND vdp.iParameterID    = p.iParameterID
      UNION
      SELECT
        vdp.RID,
        vdp.iVehicleID,
        vdp.liDeviceID,
        vdp.iParameterID
      FROM
        @Param                          p
          INNER JOIN
        [StageUser].VehicleDeviceParam vdp WITH (NOLOCK) ON vdp.iParameterID = p.iParameterID
    ),
    LastestVehicleDeviceParams (RID) AS
    (
      SELECT
        MAX(RID)
      FROM AllVehicleDeviceParams
      GROUP BY
        iVehicleID,
        liDeviceID,
        iParameterID
    )
    INSERT INTO @VehicleDeviceParam
    (iVehicleID, liDeviceID, iParameterID)
    SELECT vdp.iVehicleID, vdp.liDeviceID, vdp.iParameterID
    FROM
      LastestVehicleDeviceParams  lvdp
        inner join
      audit.VehicleDeviceParam_CT vdp WITH (NOLOCK) ON vdp.OrganisationKey = @organisationKey
                                                   AND vdp.HostRID         = lvdp.RID
    WHERE vdp.Operation <> 'D'
    UNION
    SELECT vdp.iVehicleID, vdp.liDeviceID, vdp.iParameterID
    FROM
      LastestVehicleDeviceParams  lvdp
        inner join
      [StageUser].VehicleDeviceParam vdp WITH (NOLOCK) ON vdp.RID         = lvdp.RID
    WHERE vdp.Operation <> 'D';

    ;WITH AllVehicleDevices AS
    (
      SELECT
        RID = vd.HostRID,
        vd.iVehicleID,
        vd.liDeviceID
      FROM
        @VehicleDeviceParam     vdp
          INNER JOIN
        audit.VehicleDevices_CT vd  WITH (NOLOCK) ON vd.OrganisationKey  = @organisationKey
                                                 AND vdp.iVehicleID      = vd.iVehicleID
                                                 AND vdp.liDeviceID      = vd.liDeviceID
      UNION
      SELECT
        vd.RID,
        vd.iVehicleID,
        vd.liDeviceID
      FROM
        @VehicleDeviceParam     vdp
          INNER JOIN
        [StageUser].VehicleDevices vd  WITH (NOLOCK) ON vdp.iVehicleID  = vd.iVehicleID
                                                     AND vdp.liDeviceID  = vd.liDeviceID
    ),
    LastestVehicleDevices (RID) AS
    (
      SELECT
        MAX(RID)
      FROM AllVehicleDevices
      GROUP BY
        iVehicleID,
        liDeviceID
    ),
    VehiclesWithConfiguredFuelDevices AS
    (
      SELECT vd.iVehicleID --, vd.liDeviceID, vd.sInputID,vd.bIsActive
      FROM
        LastestVehicleDevices   lvd
          inner join
        audit.VehicleDevices_CT vd  WITH (NOLOCK) ON vd.OrganisationKey = @organisationKey
                                                 AND vd.HostRID         = lvd.RID
      WHERE
          vd.Operation <> 'D'
      AND vd.bIsActive = 1
      AND vd.sInputID  IS NOT NULL
      UNION
      SELECT vd.iVehicleID --, vd.liDeviceID, vd.sInputID,vd.bIsActive
      FROM
        LastestVehicleDevices       lvd
          inner join
        [StageUser].VehicleDevices vd  WITH (NOLOCK) ON vd.RID   = lvd.RID
      WHERE
          vd.Operation <> 'D'
      AND vd.bIsActive = 1
      AND vd.sInputID  IS NOT NULL
    )
    UPDATE
      stg
    SET IsCofiguredForMeasuringFuel = 1
    FROM
      [StageUser].STAGE_DIM_Vehicles   stg
        INNER JOIN
      VehiclesWithConfiguredFuelDevices vfd ON vfd.iVehicleID = stg.HostID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.9 Update IsCurrentRecord columns on DW - IsCofiguredForMeasuringFuel', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.9 Update IsCurrentRecord columns on DW - IsCofiguredForMeasuringFuel';
    END;

    -- UPDATE IsCurrentRecords
    INSERT INTO [StageUser].[ROLLBACK_DIM_Vehicles]
    ( 
      [VehicleKey]                        ,
      [OrganisationKey]                   ,
      [StartDateKey]                      ,
      [EndDateKey]                        ,
      [IsCurrentRecord]                   ,
      [IsActive]                          ,
      [HostID]                            ,
      [VehicleGUID]                       ,
      [VehicleDescription]                ,
      [SiteGUID]                          ,
      [SiteKey]                           ,
      [LastServiceDateKey]                ,
      [IsYellowEquip]                     ,
      [RegNumber]                         ,
      [ServiceByDistance]                 ,
      [ServiceByDate]                     ,
      [ServiceByEngineSeconds]            ,
      [NextServiceDueDistance]            ,
      [NextServiceDueDateKey]             ,
      [NextServiceDueEngineSeconds]       ,
      [DefaultDriverGUID]                 ,
      [TargetFuelConsumption]             ,
      [TargetFuelConsumptionHourly]       ,
      [ScoreTriggerOverspeeding]          ,
      [ScoreTriggerOverRevving]           ,
      [ScoreTriggerOverHarshDeceleration] ,
      [ScoreTriggerOverHarshAccelleration],
      [TermScriptConfigGroup]             ,
      [ConfigurationGroupNameID]          ,
      [ConfigurationGroupName]            ,
      [FuelTypeLookupKey]                 ,
      [EstimateCO2EmissionGramsperKm]     ,
      [UnitTypeLookupKey]                 ,
      BatteryVoltage                      ,
      CurrentDeviceDriverVersion          ,
      LastDeviceDriverUploadDateTime      ,
      LastConfigurationUploadDateTime     ,
      LastDeviceChangeDateTime            ,
      LastEventChangeDateTime             ,
      CreateDateKey                       ,
      IsMeasuringFuel                     ,
      IsCofiguredForMeasuringFuel         ,
      [UTCOffsetKey]                      ,
      [CreateBatchKey]                    ,
      [UpdateBatchKey]
    )
    SELECT
      [VehicleKey]                        ,
      [OrganisationKey]                   ,
      [StartDateKey]                      ,
      [EndDateKey]                        ,
      [IsCurrentRecord]                   ,
      [IsActive]                          ,
      [HostID]                            ,
      [VehicleGUID]                       ,
      [VehicleDescription]                ,
      [SiteGUID]                          ,
      [SiteKey]                           ,
      [LastServiceDateKey]                ,
      [IsYellowEquip]                     ,
      [RegNumber]                         ,
      [ServiceByDistance]                 ,
      [ServiceByDate]                     ,
      [ServiceByEngineSeconds]            ,
      [NextServiceDueDistance]            ,
      [NextServiceDueDateKey]             ,
      [NextServiceDueEngineSeconds]       ,
      [DefaultDriverGUID]                 ,
      [TargetFuelConsumption]             ,
      [TargetFuelConsumptionHourly]       ,
      [ScoreTriggerOverspeeding]          ,
      [ScoreTriggerOverRevving]           ,
      [ScoreTriggerOverHarshDeceleration] ,
      [ScoreTriggerOverHarshAccelleration],
      [TermScriptConfigGroup]             ,
      [ConfigurationGroupNameID]          ,
      [ConfigurationGroupName]            ,
      [FuelTypeLookupKey]                 ,
      [EstimateCO2EmissionGramsperKm]     ,
      [UnitTypeLookupKey]                 ,
      BatteryVoltage                      ,
      CurrentDeviceDriverVersion          ,
      LastDeviceDriverUploadDateTime      ,
      LastConfigurationUploadDateTime     ,
      LastDeviceChangeDateTime            ,
      LastEventChangeDateTime             ,
      CreateDateKey                       ,
      IsMeasuringFuel                     ,
      IsCofiguredForMeasuringFuel         ,
      [UTCOffsetKey]                      ,
      [CreateBatchKey]                    ,
      [UpdateBatchKey]
    FROM 
     (UPDATE tar
      SET
        BatteryVoltage                  = ISNULL(stg.BatteryVoltage                 ,tar.BatteryVoltage                 ),
        CurrentDeviceDriverVersion      = ISNULL(stg.CurrentDeviceDriverVersion     ,tar.CurrentDeviceDriverVersion     ),
        LastDeviceDriverUploadDateTime  = ISNULL(stg.LastDeviceDriverUploadDateTime ,tar.LastDeviceDriverUploadDateTime ),
        LastConfigurationUploadDateTime = ISNULL(stg.LastConfigurationUploadDateTime,tar.LastConfigurationUploadDateTime),
        LastDeviceChangeDateTime        = ISNULL(stg.LastDeviceChangeDateTime       ,tar.LastDeviceChangeDateTime       ),
        LastEventChangeDateTime         = ISNULL(stg.LastEventChangeDateTime        ,tar.LastEventChangeDateTime        ),
        IsMeasuringFuel                 = ISNULL(stg.IsMeasuringFuel                ,ISNULL(tar.IsMeasuringFuel,0)      ),
        IsCofiguredForMeasuringFuel     = ISNULL(stg.IsCofiguredForMeasuringFuel    ,ISNULL(tar.IsCofiguredForMeasuringFuel,0)),
        UpdateBatchKey                  = @batchKey
      OUTPUT
        DELETED.[VehicleKey]                        ,
        DELETED.[OrganisationKey]                   ,
        DELETED.[StartDateKey]                      ,
        DELETED.[EndDateKey]                        ,
        DELETED.[IsCurrentRecord]                   ,
        DELETED.[IsActive]                          ,
        DELETED.[HostID]                            ,
        DELETED.[VehicleGUID]                       ,
        DELETED.[VehicleDescription]                ,
        DELETED.[SiteGUID]                          ,
        DELETED.[SiteKey]                           ,
        DELETED.[LastServiceDateKey]                ,
        DELETED.[IsYellowEquip]                     ,
        DELETED.[RegNumber]                         ,
        DELETED.[ServiceByDistance]                 ,
        DELETED.[ServiceByDate]                     ,
        DELETED.[ServiceByEngineSeconds]            ,
        DELETED.[NextServiceDueDistance]            ,
        DELETED.[NextServiceDueDateKey]             ,
        DELETED.[NextServiceDueEngineSeconds]       ,
        DELETED.[DefaultDriverGUID]                 ,
        DELETED.[TargetFuelConsumption]             ,
        DELETED.[TargetFuelConsumptionHourly]       ,
        DELETED.[ScoreTriggerOverspeeding]          ,
        DELETED.[ScoreTriggerOverRevving]           ,
        DELETED.[ScoreTriggerOverHarshDeceleration] ,
        DELETED.[ScoreTriggerOverHarshAccelleration],
        DELETED.[TermScriptConfigGroup]             ,
        DELETED.[ConfigurationGroupNameID]          ,
        DELETED.[ConfigurationGroupName]            ,
        DELETED.[FuelTypeLookupKey]                 ,
        DELETED.[EstimateCO2EmissionGramsperKm]     ,
        DELETED.[UnitTypeLookupKey]                 ,
        DELETED.BatteryVoltage                      ,
        DELETED.CurrentDeviceDriverVersion          ,
        DELETED.LastDeviceDriverUploadDateTime      ,
        DELETED.LastConfigurationUploadDateTime     ,
        DELETED.LastDeviceChangeDateTime            ,
        DELETED.LastEventChangeDateTime             ,
        DELETED.CreateDateKey                       ,
        DELETED.IsMeasuringFuel                     ,
        DELETED.IsCofiguredForMeasuringFuel         ,
        DELETED.[UTCOffsetKey]                      ,
        DELETED.[CreateBatchKey]                    ,
        DELETED.[UpdateBatchKey]
      FROM
        [MiXData].dbo.DIM_Vehicles tar
          INNER JOIN
        [StageUser].STAGE_DIM_Vehicles stg ON tar.OrganisationKey          = @organisationKey
                                          AND tar.HostID                   = stg.HostID
                                          AND tar.IsCurrentRecord          = 1
    ) rllbck
    WHERE
      UpdateBatchKey < @batchKey;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2 Update IsCurrentRecord columns on DW', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2 Update IsCurrentRecord columns on DW';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_DIM_Vehicles];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true  
  BEGIN  
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set  
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 8. Return values for Performance Monitoring';  
  END;  
   
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDriverCertifications_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move DriverCertifications records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprDriverCertifications_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].DriverCertifications_CT  AS tar
      USING [StageUser].DriverCertifications AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate           = stg.ChangeDate          ,
            tar.Operation            = stg.Operation           ,
            tar.UpdateMask           = stg.UpdateMask          ,
            tar.ChangeVersion        = stg.ChangeVersion       ,
            tar.iDriverID            = stg.iDriverID           ,
            tar.liCertificationID    = stg.liCertificationID   ,
            tar.dtObtained           = stg.dtObtained          ,
            tar.sInstructor          = stg.sInstructor         ,
            tar.bInstructorQualified = stg.bInstructorQualified,
            tar.sLocation            = stg.sLocation           ,
            tar.UpdateBatchKey       = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey     ,
            HostRID             ,
            ChangeDate          ,
            Operation           ,
            UpdateMask          ,
            ChangeVersion       ,
            iDriverID           ,
            liCertificationID   ,
            dtObtained          ,
            sInstructor         ,
            bInstructorQualified,
            sLocation           ,
            CreateBatchKey      ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey        ,
            stg.RID                 ,
            stg.ChangeDate          ,
            stg.Operation           ,
            stg.UpdateMask          ,
            stg.ChangeVersion       ,
            stg.iDriverID           ,
            stg.liCertificationID   ,
            stg.dtObtained          ,
            stg.sInstructor         ,
            stg.bInstructorQualified,
            stg.sLocation           ,
            @batchKey               ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDriverLicences_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move DriverLicences records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprDriverLicences_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].DriverLicences_CT  AS tar
      USING [StageUser].DriverLicences AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iDriverID      = stg.iDriverID    ,
            tar.liLicenceID    = stg.liLicenceID  ,
            tar.dtObtained     = stg.dtObtained   ,
            tar.dtExpires      = stg.dtExpires    ,
            tar.UpdateBatchKey = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iDriverID      ,
            liLicenceID    ,
            dtObtained     ,
            dtExpires      ,
            CreateBatchKey ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.iDriverID    ,
            stg.liLicenceID  ,
            stg.dtObtained   ,
            stg.dtExpires    ,
            @batchKey        ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprDrivers_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move Drivers records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprDrivers_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Drivers_CT  AS tar
      USING [StageUser].Drivers AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate         = stg.ChangeDate        ,
            tar.Operation          = stg.Operation         ,
            tar.UpdateMask         = stg.UpdateMask        ,
            tar.ChangeVersion      = stg.ChangeVersion     ,
            tar.DriverGUID         = stg.DriverGUID        ,
            tar.iDriverID          = stg.iDriverID         ,
            tar.liSiteID           = stg.liSiteID          ,
            tar.liGroupID          = stg.liGroupID         ,
            tar.sEmployeeNumber    = stg.sEmployeeNumber   ,
            tar.sName              = stg.sName             ,
            tar.bLicense           = stg.bLicense          ,
            tar.dtLastLicense      = stg.dtLastLicense     ,
            tar.dtNextLicense      = stg.dtNextLicense     ,
            tar.ucLicenseInterval  = stg.ucLicenseInterval ,
            tar.dtDistanceChecked  = stg.dtDistanceChecked ,
            tar.sExtendedID        = stg.sExtendedID       ,
            tar.UpdateBatchKey     = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey   ,
            HostRID           ,
            ChangeDate        ,
            Operation         ,
            UpdateMask        ,
            ChangeVersion     ,
            DriverGUID        ,
            iDriverID         ,
            liSiteID          ,
            liGroupID         ,
            sEmployeeNumber   ,
            sName             ,
            bLicense          ,
            dtLastLicense     ,
            dtNextLicense     ,
            ucLicenseInterval ,
            dtDistanceChecked ,
            sExtendedID       ,
            CreateBatchKey    ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey      ,
            stg.RID               ,
            stg.ChangeDate        ,
            stg.Operation         ,
            stg.UpdateMask        ,
            stg.ChangeVersion     ,
            stg.DriverGUID        ,
            stg.iDriverID         ,
            stg.liSiteID          ,
            stg.liGroupID         ,
            stg.sEmployeeNumber   ,
            stg.sName             ,
            stg.bLicense          ,
            stg.dtLastLicense     ,
            stg.dtNextLicense     ,
            stg.ucLicenseInterval ,
            stg.dtDistanceChecked ,
            stg.sExtendedID       ,
            @batchKey             ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprEventData_RemoveNonTrackedChanges]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Removes any non-tracked changes, i.e. Swap-Unit resequencing
-- ==============================================================================
/*
  Dependencies:

  EventData

*/
CREATE PROCEDURE [StageUser].[sprEventData_RemoveNonTrackedChanges]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
) 
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  DECLARE @unknownDateDefault date = '00010101';

  DECLARE @EventTypes TABLE
  (
    EventTypeLookupKey INT PRIMARY KEY CLUSTERED,
    EventType          TINYINT
  );

  CREATE TABLE #Vehicles
  ( 
    VehicleKey INT PRIMARY KEY CLUSTERED,
    HostID     SMALLINT 
  );

  CREATE TABLE #Drivers
  ( 
    DriverKey  INT PRIMARY KEY CLUSTERED,
    HostID     SMALLINT
  );

  CREATE TABLE #EventDescriptions
  ( 
    EventDescriptionKey INT PRIMARY KEY CLUSTERED,
    HostID              SMALLINT
  );

  CREATE TABLE #CalibrationParameters
  ( 
    ParameterKey INT PRIMARY KEY CLUSTERED,
    HostID       SMALLINT
  );

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Start';
  END;

  EXEC [Control].strProcProgressMonitor_Set
    @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;

  INSERT INTO @EventTypes
  (
    EventTypeLookupKey,
    EventType
  )
  SELECT
    LookupRID,
    LookupKey
  FROM
    [MiXData].dbo.DIM_TableColumnLookups
  WHERE
    LookupTable = 'FACT_EventDetails';

  INSERT INTO #Vehicles
  ( 
    VehicleKey,
    HostID    
  )
  SELECT
    dvh.VehicleKey,
    dvh.HostID
  FROM [MiXData].[dbo].DIM_Vehicles dvh  WITH (NOLOCK)
  WHERE dvh.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    dvh.VehicleKey,
    dvh.HostID
  FROM [MiXData].[dbo].DIM_Vehicles dvh  WITH (NOLOCK)
  WHERE dvh.VehicleKey = -1;

  INSERT INTO #Drivers
  ( 
    DriverKey,
    HostID    
  )
  SELECT
    dd.DriverKey,
    dd.HostID
  FROM [MiXData].[dbo].DIM_Drivers dd  WITH (NOLOCK)
  WHERE dd.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    dd.DriverKey,
    dd.HostID
  FROM [MiXData].[dbo].DIM_Drivers dd  WITH (NOLOCK)
  WHERE dd.DriverKey = -1;

  INSERT INTO #EventDescriptions
  ( 
    EventDescriptionKey,
    HostID    
  )
  SELECT
    ded.EventDescriptionKey,
    ded.HostID
  FROM [MiXData].[dbo].DIM_EventDescriptions ded  WITH (NOLOCK)
  WHERE ded.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    ded.EventDescriptionKey,
    ded.HostID
  FROM [MiXData].[dbo].DIM_EventDescriptions ded  WITH (NOLOCK)
  WHERE ded.EventDescriptionKey = -1;

  INSERT INTO #CalibrationParameters
  ( 
    ParameterKey,
    HostID    
  )
  SELECT
    prm.ParameterKey,
    prm.HostID
  FROM [MiXData].[dbo].DIM_CalibrationParameters prm  WITH (NOLOCK)
  WHERE prm.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    prm.ParameterKey,
    prm.HostID
  FROM [MiXData].[dbo].DIM_CalibrationParameters prm  WITH (NOLOCK)
  WHERE prm.ParameterKey = -1;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0.1 Get org DIM data';
  END;

  --------------------------------------------------------------------
  -- 1. Remove records from Stage source table
  --------------------------------------------------------------------

  --  ignore where Driver ID set to 0 (assume cause is driverID deleted)
  ;WITH
  UpdatedEventData AS
  (
    SELECT
      fact.EventDetailKey     ,
      fact.HostID             ,
      fact.DriverKey          ,
      fact.VehicleKey         ,
      fact.TrailerKey         ,
      fact.EventDescriptionKey,
      fact.EventTypeLookupKey ,
      fact.EventStartDateTime ,
      fact.EventEndDateTime   ,
      fact.StartOdometer      ,
      fact.EndOdometer        ,
      fact.EventValue         ,
      fact.TotalOccurs        ,
      fact.TotalTime          ,
      fact.ParameterKey       ,
      fact.Litres             ,
      fact.PulseParameterKey  ,
      fact.PulseValue         ,
      fact.IsDeleted
    FROM
      [StageUser].EventData             ed
        INNER JOIN
      [MiXData].[dbo].FACT_EventDetails fact WITH (NOLOCK) ON fact.OrganisationKey = @organisationKey
                                                          AND fact.HostID          = ed.EventKey
  )
  DELETE ed
  FROM
    [StageUser].EventData  ed
      INNER JOIN
    UpdatedEventData        fact ON fact.HostID              = ed.EventKey
      INNER JOIN
    #Vehicles               veh  ON fact.VehicleKey          = veh.VehicleKey
      INNER JOIN
    #EventDescriptions      evt  ON fact.EventDescriptionKey = evt.EventDescriptionKey
      INNER JOIN
    #Drivers                dd   ON fact.DriverKey           = dd.DriverKey
      LEFT JOIN
    #CalibrationParameters  prm  ON fact.PulseParameterKey   = prm.ParameterKey
      LEFT JOIN
    @EventTypes             et   ON fact.EventTypeLookupKey  = et.EventTypeLookupKey
  WHERE
    CHECKSUM
    (
      ed.VehicleID,
      ed.EventID,
      ed.EventType,
      CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),ed.StartDate)),
      ed.StartOdometer,
      CASE 
        WHEN ed.EndDate IS NULL AND ed.EventType = 3 -- Notifications
          THEN CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),ed.StartDate))
        ELSE CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),ed.EndDate))
      END,
      ed.EndOdometer,
      ed.TotalTime,
      ed.TotalOccurs,
      ed.Value,
      ed.Litres,
      ed.PulseParameterID,
      ed.PulseValue
    )
     =
    CHECKSUM
    (
      veh.HostID,
      evt.HostID,
      et.EventType,
      CONVERT(DATETIME,NULLIF(fact.EventStartDateTime,'0001-01-01 00:00:00 +00:00')),
      fact.StartOdometer,
      CONVERT(DATETIME,NULLIF(fact.EventEndDateTime,'0001-01-01 00:00:00 +00:00')),
      fact.EndOdometer,
      fact.TotalTime,
      fact.TotalOccurs,
      fact.EventValue,
      fact.Litres,
      prm.HostID,
      fact.PulseValue
    )
  AND (ed.DriverID = 0
  OR   ed.DriverID = dd.HostID);

  SELECT @recordsDeleted = @@ROWCOUNT;

  --------------------------------------------------------------------
  -- 2. Return values for Performance Monitoring
  --------------------------------------------------------------------
  EXEC [Control].strProcProgressMonitor_Set
    @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Return values for Performance Monitoring';
  END;

  SELECT RecordsDeleted  = isnull(@recordsDeleted ,0);

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser].[sprEventData_RemoveNonTrackedChanges_DataStream]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprEventData_RemoveNonTrackedChanges_DataStream]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
) 
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @unknownDateDefault date = '00010101';

  --------------------------------------------------------------------
  -- 1. Identify records from Stage source table
  --------------------------------------------------------------------

  ;WITH
  EventTypes AS
  (
    SELECT
      EventTypeLookupKey = LookupRID,
      EventType          = LookupKey
    FROM
      [MiXData].dbo.DIM_TableColumnLookups
    WHERE
      LookupTable = 'FACT_EventDetails'
  ),
  EventDescriptions AS
  (
    SELECT
      ded.EventDescriptionKey,
      EventID = ded.HostID
    FROM
      [MiXData].[dbo].DIM_EventDescriptions ded WITH (NOLOCK)
    WHERE ded.OrganisationKey  = @organisationKey
  ),
  Vehicles AS
  (
    SELECT
      dvh.VehicleKey,
      VehicleID = dvh.HostID
    FROM
      [MiXData].[dbo].DIM_Vehicles dvh WITH (NOLOCK)
    WHERE dvh.OrganisationKey  = @organisationKey
  ),
  Drivers AS
  (
    SELECT
      drv.DriverKey,
      DriverID = drv.HostID
    FROM
      [MiXData].[dbo].DIM_Drivers drv WITH (NOLOCK)
    WHERE drv.OrganisationKey  = @organisationKey
  ),
  PulseParameters AS
  (
    SELECT
      PulseParameterKey = dcp.ParameterKey,
      PulseParameterID  = dcp.HostID
    FROM
      [MiXData].dbo.DIM_CalibrationParameters dcp WITH (NOLOCK)
    WHERE dcp.OrganisationKey = @organisationKey
  )  
  SELECT
    ed.EventKey,
    DWDriverID              = d.DriverID              ,
    ed.DriverID,
    DWVehicleID             = v.VehicleID         ,
    ed.VehicleID,
    DWEventDescriptionKey   = fact.EventDescriptionKey,
    e.EventDescriptionKey,
    DWEventTypeLookupKey    = fact.EventTypeLookupKey ,
    EventTypeLookupKey      = ISNULL(et.EventTypeLookupKey,-1),
    DWEventStartDateTime    = CONVERT(DATETIME,NULLIF(fact.EventStartDateTime,'0001-01-01 00:00:00 +00:00')),
    StartDate               = ed.StartDate,
    DWEventEndDateTime      = CONVERT(DATETIME,NULLIF(fact.EventEndDateTime,'0001-01-01 00:00:00 +00:00')),
    EndDate                 = CASE WHEN ed.EndDate IS NULL AND ed.EventType = 3 THEN ed.StartDate ELSE ed.EndDate END,
    DWStartOdometer         = fact.StartOdometer      ,
    StartOdometer           = ed.StartOdometer,
    DWEndOdometer           = fact.EndOdometer        ,
    EndOdometer             = ed.EndOdometer,
    DWEventValue            = fact.EventValue         ,
    Value                   = ed.Value,
    DWTotalOccurs           = fact.TotalOccurs        ,
    TotalOccurs             = ed.TotalOccurs,
    DWTotalTime             = fact.TotalTime          ,
    TotalTime               = ed.TotalTime,
    DWLitres                = fact.Litres             ,
    Litres                  = ed.Litres,
    DWPulseParameterKey     = fact.PulseParameterKey  ,
    pp.PulseParameterKey,
    DWPulseValue            = fact.PulseValue         ,
    ed.PulseValue,
    DWIsDeleted             = fact.IsDeleted
  FROM
    [StageUser].EventData ed
      INNER JOIN
    [MiXData].[dbo].FACT_EventDetails fact         WITH (NOLOCK) ON fact.OrganisationKey  = @organisationKey
                                                                AND fact.HostID           = ed.EventKey
      INNER JOIN
    Vehicles                          v                          ON v.VehicleKey          = fact.VehicleKey
      INNER JOIN
    Drivers                           d                          ON d.DriverKey           = fact.DriverKey
      INNER JOIN
    EventDescriptions                 e                          ON e.EventID             = ed.EventID
      LEFT JOIN
    PulseParameters                   pp                         ON pp.PulseParameterID   = ed.PulseParameterID
      LEFT JOIN
    EventTypes                        et                         ON et.EventType          = ed.EventType
  WHERE
    ed.Operation = 'U';

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser].[sprEventData_RemoveNonTrackedChanges_Remove]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Removes any non-tracked changes, i.e. Swap-Unit resequencing
-- ==============================================================================
/*
  Dependencies:

  EventData

*/
CREATE PROCEDURE [StageUser].[sprEventData_RemoveNonTrackedChanges_Remove]
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @RecordsDeleted INT;

  DELETE ed
  FROM
    [StageUser].[EventData] ed
      INNER JOIN
    [StageUser].STAGE_FACT_EventDetails_NonTrackedChanges enc WITH (NOLOCK) ON enc.EventKey = ed.EventKey;
  
  SELECT RecordsDeleted = ISNULL(@@ROWCOUNT,0);

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser].[sprEventDescription_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move EventDescription records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprEventDescription_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].EventDescription_CT  AS tar
      USING [StageUser].EventDescription AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iEventID       = stg.iEventID     ,
            tar.sDescription   = stg.sDescription ,
            tar.sSystemName    = stg.sSystemName  ,
            tar.sCriticalID    = stg.sCriticalID  ,
            tar.ucSummaryType  = stg.ucSummaryType,
            tar.iSummaryID     = stg.iSummaryID   ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iEventID       ,
            sDescription   ,
            sSystemName    ,
            sCriticalID    ,
            ucSummaryType  ,
            iSummaryID     ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.iEventID     ,
            stg.sDescription ,
            stg.sSystemName  ,
            stg.sCriticalID  ,
            stg.ucSummaryType,
            stg.iSummaryID   ,
            @batchKey        ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprEventTriggers_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move EventTriggers records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprEventTriggers_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].EventTriggers_CT  AS tar
      USING [StageUser].EventTriggers AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iEventID       = stg.iEventID     ,
            tar.ucTriggerID    = stg.ucTriggerID  ,
            tar.ucSeq          = stg.ucSeq        ,
            tar.iParameterID   = stg.iParameterID ,
            tar.ucOperator     = stg.ucOperator   ,
            tar.lfValue        = stg.lfValue      ,
            tar.bRequired      = stg.bRequired    ,
            tar.ucTOper        = stg.ucTOper      ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iEventID       ,
            ucTriggerID    ,
            ucSeq          ,
            iParameterID   ,
            ucOperator     ,
            lfValue        ,
            bRequired      ,
            ucTOper        ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.iEventID     ,
            stg.ucTriggerID  ,
            stg.ucSeq        ,
            stg.iParameterID ,
            stg.ucOperator   ,
            stg.lfValue      ,
            stg.bRequired    ,
            stg.ucTOper      ,
            @batchKey        ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprEWS_FutureDates]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprEWS_FutureDates]
(
  @batchKey        INT,
  @organisationKey INT,
  @debugMode       INT = 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  INT;
  DECLARE @EWSValidationKey INT;
  DECLARE @EWSSourceKey     INT;
  DECLARE @currentDate      DATE = CONVERT(DATE,SYSUTCDATETIME());

  SELECT
    @EWSValidationKey = (SELECT EWSValidationKey   
                         FROM [MiXData].ews.DIM_Validations
                         WHERE Validation = 'FutureDates'),
    @EWSSourceKey     = (SELECT EWSSourceKey
                         FROM [MiXData].ews.DIM_Sources
                         WHERE Source = 'FACT_EventDetails');

  INSERT INTO [MiXData].ews.FACT_Occurrences
  (
    EWSValidationKey    ,
    EWSSourceKey        ,
    EWSDateTime         ,
    BatchID             ,
    OrganisationID      ,
    VehicleID           ,
    TransactionalDateKey,
    Occurrences
  )
  SELECT
    @EWSValidationKey,
    @EWSSourceKey,
    SYSUTCDATETIME(),
    @batchKey,
    OrganisationID = (SELECT oc.OrganisationID FROM Control.OrganisationController oc  WITH (NOLOCK) WHERE oc.OrganisationKey = @organisationKey),
    stg.VehicleID,
    stg.EventStartDateKey,
    NumberOfRecords = COUNT(1)
  FROM
    [StageUser].[STAGE_FACT_EventDetails] stg
  WHERE
    stg.EventStartDateKey > DATEADD(DAY,1,@currentDate)
  GROUP BY
    stg.VehicleID,
    stg.EventStartDateKey;

  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = 0,
         RecordsDeleted  = 0;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser].[sprEWS_InvalidDurations]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprEWS_InvalidDurations]
(
  @batchKey        INT,
  @organisationKey INT,
  @debugMode       INT = 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  INT;
  DECLARE @EWSValidationKey INT;
  DECLARE @EWSSourceKey     INT;
  DECLARE @currentDate      DATE = CONVERT(DATE,SYSUTCDATETIME());

  DECLARE @MaxSubTripDuration INT = 86400; -- 1 day, 3600seconds*24hours*1days

  SELECT
    @EWSValidationKey = (SELECT EWSValidationKey
                         FROM [MiXData].ews.DIM_Validations
                         WHERE Validation = 'InvalidDuration'),
    @EWSSourceKey     = (SELECT EWSSourceKey
                         FROM [MiXData].ews.DIM_Sources
                         WHERE Source = 'FACT_ActivityDetails');

  INSERT INTO [MiXData].ews.FACT_Occurrences
  (
    EWSValidationKey    ,
    EWSSourceKey        ,
    EWSDateTime         ,
    BatchID             ,
    OrganisationID      ,
    VehicleID           ,
    TransactionalDateKey,
    Occurrences
  )
  SELECT
    @EWSValidationKey,
    @EWSSourceKey,
    SYSUTCDATETIME(),
    @batchKey,
    OrganisationID = (SELECT oc.OrganisationID FROM Control.OrganisationController oc  WITH (NOLOCK) WHERE oc.OrganisationKey = @organisationKey),
    stg.VehicleID,
    stg.ActivityStartDateKey,
    COUNT(1)
  FROM
    [StageUser].STAGE_FACT_ActivityDetails stg
  WHERE
     stg.Duration < 0
  OR stg.Duration > @MaxSubTripDuration
  GROUP BY
    stg.VehicleID,
    stg.ActivityStartDateKey;

  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = 0,
         RecordsDeleted  = 0;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser].[sprEWS_InvalidEngineSeconds]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprEWS_InvalidEngineSeconds]
(
  @batchKey        INT,
  @organisationKey INT,
  @debugMode       INT = 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  INT;
  DECLARE @EWSValidationKey INT;
  DECLARE @EWSSourceKey     INT;
  DECLARE @currentDate      DATE = CONVERT(DATE,SYSUTCDATETIME());

  SELECT
    @EWSValidationKey = (SELECT EWSValidationKey   
                         FROM [MiXData].ews.DIM_Validations
                         WHERE Validation = 'InvalidEngineSeconds'),
    @EWSSourceKey     = (SELECT EWSSourceKey
                         FROM [MiXData].ews.DIM_Sources
                         WHERE Source = 'FACT_ActivityDetails');

  INSERT INTO [MiXData].ews.FACT_Occurrences
  (
    EWSValidationKey    ,
    EWSSourceKey        ,
    EWSDateTime         ,
    BatchID             ,
    OrganisationID      ,
    VehicleID           ,
    TransactionalDateKey,
    Occurrences
  )
  SELECT
    @EWSValidationKey,
    @EWSSourceKey,
    SYSUTCDATETIME(),
    @batchKey,
    OrganisationID = (SELECT oc.OrganisationID FROM Control.OrganisationController oc  WITH (NOLOCK) WHERE oc.OrganisationKey = @organisationKey),
    stg.VehicleID,
    stg.ActivityStartDateKey,
    COUNT(1)
  FROM
    [StageUser].STAGE_FACT_ActivityDetails stg
  WHERE
     stg.StartEngineSeconds > stg.EndEngineSeconds
  OR stg.StartEngineSeconds < 0
  OR stg.EndEngineSeconds   < 0
  GROUP BY
    stg.VehicleID,
    stg.ActivityStartDateKey;

  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = 0,
         RecordsDeleted  = 0;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser].[sprEWS_InvalidLitres]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprEWS_InvalidLitres]
(
  @batchKey        INT,
  @organisationKey INT,
  @debugMode       INT = 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  INT;
  DECLARE @EWSValidationKey INT;
  DECLARE @EWSSourceKey     INT;
  DECLARE @currentDate      DATE = CONVERT(DATE,SYSUTCDATETIME());

  DECLARE @MaxSubTripLitres DECIMAL(19,4) = 99999.9999; -- have to include boats that can use huge amount of Litres per sub-trip

  SELECT
    @EWSValidationKey = (SELECT EWSValidationKey   
                         FROM [MiXData].ews.DIM_Validations
                         WHERE Validation = 'InvalidLitres'),
    @EWSSourceKey     = (SELECT EWSSourceKey
                         FROM [MiXData].ews.DIM_Sources
                         WHERE Source = 'FACT_ActivityDetails');

  INSERT INTO [MiXData].ews.FACT_Occurrences
  (
    EWSValidationKey    ,
    EWSSourceKey        ,
    EWSDateTime         ,
    BatchID             ,
    OrganisationID      ,
    VehicleID           ,
    TransactionalDateKey,
    Occurrences
  )
  SELECT
    @EWSValidationKey,
    @EWSSourceKey,
    SYSUTCDATETIME(),
    @batchKey,
    OrganisationID = (SELECT oc.OrganisationID FROM Control.OrganisationController oc  WITH (NOLOCK) WHERE oc.OrganisationKey = @organisationKey),
    stg.VehicleID,
    stg.ActivityStartDateKey,
    COUNT(1)
  FROM
    [StageUser].STAGE_FACT_ActivityDetails stg
  WHERE
     stg.FuelUsedMeasured >= @MaxSubTripLitres
  GROUP BY
    stg.VehicleID,
    stg.ActivityStartDateKey;

  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = 0,
         RecordsDeleted  = 0;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser].[sprEWS_QuarantinedData]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprEWS_QuarantinedData]
(
  @batchKey        INT,
  @organisationKey INT,
  @debugMode       INT = 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  INT;
  DECLARE @EWSValidationKey INT;
  DECLARE @currentDate      DATE = CONVERT(DATE,SYSUTCDATETIME());

  SELECT
    @EWSValidationKey = (SELECT EWSValidationKey   
                         FROM [MiXData].ews.DIM_Validations
                         WHERE Validation = 'QuarantinedData')

  INSERT INTO [MiXData].ews.FACT_Occurrences
  (
    EWSValidationKey    ,
    EWSSourceKey        ,
    EWSDateTime         ,
    BatchID             ,
    OrganisationID      ,
    VehicleID           ,
    TransactionalDateKey,
    Occurrences
  )
  SELECT
    @EWSValidationKey,
    dss.EWSSourceKey,
    SYSUTCDATETIME(),
    @batchKey,
    oc.OrganisationID,
    stg.VehicleID,
    stg.ChangeDateKey,
    stg.Occurrences
    -- select top 10 *
  FROM
    [StageUser].QuarantinedDataSummary stg
      INNER JOIN
    Control.OrganisationController     oc  WITH (NOLOCK) ON oc.OrganisationKey = @organisationKey
      LEFT JOIN
    [MiXData].ews.DIM_Sources          dss WITH (NOLOCK) ON dss.Source         = stg.SourceTable;

  SELECT @recordsInserted = @@ROWCOUNT;

  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = 0,
         RecordsDeleted  = 0;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser].[sprExtensionProperties_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ======================================================
-- Move ExtensionProperties_DIM records to audit schema
-- ======================================================
CREATE PROCEDURE [StageUser].[sprExtensionProperties_MoveToAudit]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].ExtensionProperties_CT  AS tar
      USING [StageUser].ExtensionProperties_DIM AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate         = stg.ChangeDate,
            tar.Operation          = stg.Operation,
            tar.UpdateMask         = stg.UpdateMask,
            tar.ChangeVersion      = stg.ChangeVersion,
            tar.sAppID             = stg.sAppID,
            tar.liObjectType       = stg.liObjectType,
            tar.liObjectID         = stg.liObjectID,
            tar.sProperty          = stg.sProperty,
            tar.sValue             = stg.sValue,
            tar.UpdateBatchKey     = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID,
            ChangeDate,
            Operation,
            UpdateMask,
            ChangeVersion,
            sAppID,
            liObjectType,
            liObjectID,
            sProperty,
            sValue,
            CreateBatchKey,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey,
            stg.RID,
            stg.ChangeDate,
            stg.Operation,
            stg.UpdateMask,
            stg.ChangeVersion,
            stg.sAppID,
            stg.liObjectType,
            stg.liObjectID,
            stg.sProperty,
            stg.sValue,
            @batchKey,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_ActivityDetails_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_ActivityDetails on DW (details of organisations, late transform)
-- ==============================================================================
/*
  Dependencies:
  
  DIM_Vehicles
  FACT_ActivitySummary
  FACT_SimpleScoreDetails (only existing values at that point in time)
  FACT_FuelCapture

  STAGE_DIM_UTCOffsetsLookup
  STAGE_DIM_GeoLocations

  SubTripData

*/
CREATE PROCEDURE [StageUser].[sprFACT_ActivityDetails_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0 -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;

  DECLARE @maxDurationYears   int  = 68; -- anything bigger than 68 causes overflow of int datatype
  DECLARE @maxFuelLimit       int  = 99999.0; -- anything bigger than 68 causes overflow of int datatype  
  DECLARE @unknownDateDefault date = '00010101';  
  DECLARE @averageFuelConsumptionLightTruck float = 13.36;    --   13.36 (l/100km) average fuel consumption for light trucks
  DECLARE @validDateStartTime datetimeoffset(0) = '20000101';

  -- http://www.epa.gov/OMS/climate/420f05004.htm  and http://www.epa.gov/oms/climate/420f05001.htm
  -- In particular, 40 CFR 600.113-78 gives a carbon content value of 2,421 grams (g) of carbon per gallon of gasoline, 
  -- which produces 8,877 g of CO2. (The carbon content is multiplied by the ratio of the molecular weight of CO2 to the molecular weight of carbon: 44/12).
  -- This number is then multiplied by an oxidation factor of 0.99, which assumes that 1 percent of the carbon remains un-oxidized.[1.] 
  -- This produces a value of 8,788 g or 8.8 kg (19.4 lbs) of CO2.
  -- Gasoline carbon content per gallon: 2,421 grams
  -- Diesel carbon content per gallon:   2,778 grams
  -- Currently FM is using 2.65 kg/litre

  DECLARE @averageCarbonEmission            float = 0.733869; -- kilograms/litre
  DECLARE @averageCO2Emission               float = 2.65;     -- kilograms/litre

  DECLARE @currentDate   datetimeoffset(0) = SYSUTCDATETIME(); -- used for validation  
  DECLARE @flagStartTime datetimeoffset(0) = SYSUTCDATETIME();
  DECLARE @flagSeq       smallint = 1;

  -- used for NextMovement calc
  CREATE TABLE #lastMovementStartDateTime
  ( 
    VehicleID                 int,
    MinMovementStartDateTime  datetimeoffset(0),
    PrevMovementStartDateTime datetimeoffset(0) NULL
  );

  -- used for NextMovement calc
  CREATE TABLE #recordsForNextMovementCalc
  ( 
    VehicleKey                    int,
    VehicleID                     int,
    MovementStartDateTime         datetimeoffset(0),
    MovementEndDateTime           datetimeoffset(0),
    ActivityDetailKey             bigint,
    NextMovementStartDateTime     datetimeoffset(0) NULL,
    NextMovementActivityDetailKey bigint            NULL
  );

  CREATE TABLE #VehiclesLookup
  (
    VehicleKey    INT  NOT NULL,
    HostID        INT  NOT NULL,
    StartDateKey  DATE NOT NULL,
    EndDateKey    DATE NOT NULL,
    TargetFuelConsumption       REAL NULL,
    TargetFuelConsumptionHourly REAL NULL
  );

  --------------------------------------------------------------------  
  -- 0. Make sure work tables are cleared  
  --------------------------------------------------------------------  
  TRUNCATE TABLE [StageUser].[STAGE_FACT_ActivityDetails];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_ActivityDetails];
  TRUNCATE TABLE [StageUser].STAGE_FACT_EventRoadspeedLimitsScores;

  IF @debugMode = 1  -- DebugMode is true  
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set  
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
  END;  
  
  --------------------------------------------------------------------  
  -- 1. Source Data Validation  
  --------------------------------------------------------------------  
  
  --------------------------------------------------------------------  
  -- 2. Add to STG  
  --------------------------------------------------------------------  
  BEGIN TRY  
  
    IF NOT EXISTS(SELECT *  
                  FROM [sys].indexes   
                  WHERE object_id = OBJECT_ID(N'[StageUser].[SubTripData]') AND name = N'IX_SubTripData_Depart')  
      CREATE NONCLUSTERED INDEX IX_SubTripData_Depart ON [StageUser].[SubTripData](Depart)  
        INCLUDE(Halt);  
  
    -- drop STAGE indexes before insert  
    IF EXISTS(SELECT *  
              FROM [sys].indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_TripID_HostID')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_TripID_HostID ON [StageUser].[STAGE_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_StartGPSID')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_StartGPSID ON [StageUser].[STAGE_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_EndGPSID')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_EndGPSID ON [StageUser].[STAGE_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey ON [StageUser].[STAGE_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_VehicleKey')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_VehicleKey ON [StageUser].[STAGE_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_VehicleID_StartOdometer_EndOdometer')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_VehicleID_StartOdometer_EndOdometer ON [StageUser].[STAGE_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Operation')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Operation ON [StageUser].[STAGE_FACT_ActivityDetails];  

    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_VehicleID_ActivityStartDateTime')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_VehicleID_ActivityStartDateTime ON [StageUser].[STAGE_FACT_ActivityDetails];
  
    -- drop ROLLBACK indexes before insert  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_ActivityDetails]') AND name = N'IX_ROLLBACK_FACT_ActivityDetails_ActivitySummaryKey_HostID')  
      DROP INDEX IX_ROLLBACK_FACT_ActivityDetails_ActivitySummaryKey_HostID ON [StageUser].[ROLLBACK_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_ActivityStartDateTime_ActivityEndDateTime')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_ActivityStartDateTime_ActivityEndDateTime ON [StageUser].[STAGE_FACT_ActivityDetails];  
    
    -- insert changed records into STG  
   INSERT INTO [StageUser].[STAGE_FACT_ActivityDetails]  
   (  
     [Operation]          ,  
     [TripID]             ,  
     [HostID]             ,  
     [StartGPSID]         ,  
     [EndGPSID]           ,  
  
     [MovementStartDateKey]   ,  
     [MovementEndDateKey]     ,  
     [MovementStartTime]      ,  
     [MovementEndTime]        ,  
     [MovementStartDateTime]  ,  
     [MovementEndDateTime]    ,  
  
     [StartOdometer]      ,
     [EndOdometer]        ,
     [StartEngineSeconds] ,
     [EndEngineSeconds]   ,
     
     [DistanceTravelled]  ,
     [Duration]           ,  
     [DrivingTime]        ,  
     [StandingTime]       ,  
     [MaxSpeed]           ,  
     [SpeedTime]          ,  
     [SpeedOccurs]        ,  
     [SpeedScore]         ,  
     [MaxBrake]           ,  
     [BrakeTime]          ,  
     [BrakeOccurs]        ,  
     [BrakeScore]         ,  
     [MaxAccel]           ,  
     [AccelTime]          ,  
     [AccelOccurs]        ,  
     [AccelScore]         ,  
     [MaxRPM]             ,  
     [RPMTIme]            ,  
     [RPMOccurs]          ,  
     [RPMScore]           ,  
     [OutOfGreenBandTime] ,  
     [OutOfGreenBandScore],  
     [ExcessiveIdleTime]  ,  
     [ExcessiveIdleOccurs],  
     [ExcessiveIdleScore] ,  
     [IdleTime]           ,  
     [IdleOccurs]         ,  
     [EngineSeconds]      ,  
     [FuelUsedMeasured]   ,  
     [FuelUsedCalculated] ,  
     [FuelUsedHierarchy]  ,
     [PulseParameterID]   ,
     [PulseValue]
   )  
   SELECT  
     s.Operation                                   ,  
     [TripID]              = s.[TripID]            ,  
     [HostID]              = s.[Sequence]          ,  
     [StartGPSID]          = s.[StartGPSID]        ,  
     [EndGPSID]            = s.[EndGPSID]          ,  
  
     [MovementStartDateKey] = ISNULL(CONVERT(DATE,s.Depart) ,@unknownDateDefault),  
     [MovementEndDateKey]   = ISNULL(CONVERT(DATE,s.Halt  ) ,@unknownDateDefault),  
     [MovementStartTime]    = CONVERT(TIME(0),ISNULL(s.Depart ,0)),  
     [MovementEndTime]      = CONVERT(TIME(0),ISNULL(s.Halt   ,0)),  
     [MovementStartDateTime]= CASE   
                                WHEN s.Depart IS NULL  
                                  THEN @unknownDateDefault  
                                  ELSE TODATETIMEOFFSET(s.Depart,ISNULL(utc.UTCOffsetMinutes,0))  
                              END,  
     [MovementEndDateTime]  = CASE   
                                WHEN s.Halt IS NULL  
                                  THEN @unknownDateDefault  
                                  ELSE TODATETIMEOFFSET(s.Halt,ISNULL(utc.UTCOffsetMinutes,0))  
                              END,  
                            
     [StartOdometer]       = s.Odometer - ISNULL(s.TripDistance,0),  
     [EndOdometer]         = s.Odometer          ,
     [StartEngineSeconds]  = s.StartEngineSeconds,
     [EndEngineSeconds]    = s.EndEngineSeconds  ,
     
  
     [DistanceTravelled]   = s.TripDistance      ,
     [Duration]            = CASE  
                               WHEN ABS(DATEDIFF(YEAR,s.Depart,s.Halt)) + ISNULL(s.StandingTime,0)/31536000  > @maxDurationYears   -- if Duration is longer than 68 years than indicate with error value  
                                 THEN -2                                                 -- value used for indication erronous value  
                               ELSE  
                                 ISNULL(DATEDIFF(SECOND,s.Depart,s.Halt),0) + ISNULL(s.StandingTime,0)  
                             END,  
     [DrivingTime]         = CASE  
                               WHEN ABS(DATEDIFF(YEAR,s.Depart,s.Halt)) > @maxDurationYears -- if Duration is longer than 68 years than indicate with error value  
                                 THEN -2                                               -- value used for indication erronous value  
                               ELSE  
                                 DATEDIFF(SECOND,s.Depart,s.Halt)  
                             END,  
     [StandingTime]        = ISNULL(s.StandingTime,0),  
  
     [MaxSpeed]            = s.[MaxSpeed]          ,  
     [SpeedTime]           = s.[SpeedTime]         ,  
     [SpeedOccurs]         = s.[SpeedOccurs]       ,  
     [SpeedScore]          = s.[SpeedScore]        ,  
  
     [MaxBrake]            = s.[MaxBrake]          ,  
     [BrakeTime]           = s.[BrakeTime]         ,  
     [BrakeOccurs]         = s.[BrakeOccurs]       ,  
     [BrakeScore]          = s.[BrakeScore]        ,  
  
     [MaxAccel]            = s.[MaxAccel]          ,   
     [AccelTime]           = s.[AccelTime]         ,   
     [AccelOccurs]         = s.[AccelOccurs]       ,   
     [AccelScore]          = s.[AccelScore]        ,   
  
     [MaxRPM]              = s.[MaxRPM]            ,   
     [RPMTime]             = s.[RPMTime]           ,   
     [RPMOccurs]           = s.[RPMOccurs]         ,   
     [RPMScore]            = s.[RPMScore]          ,   
  
     [OutOfGreenBandTime]  = s.[GBTime]            ,  
     [OutOfGreenBandScore] = s.[GBScore]           ,  
  
     [ExcessiveIdleTime]   = s.[ExIdleTime]        ,  
     [ExcessiveIdleOccurs] = s.[ExIdleOccurs]      ,  
     [ExcessiveIdleScore]  = s.[ExIdleScore]       ,  
  
     [IdleTime]            = s.[NIdleTime]         ,  
     [IdleOccurs]          = s.[NIdleOccurs]       ,  
     [EngineSeconds]       = CASE
                              WHEN ISNULL(s.StartEngineSeconds,0) > ISNULL(s.EndEngineSeconds,0)
                                THEN -2
                              ELSE
                                ISNULL((s.EndEngineSeconds-s.StartEngineSeconds),0)
                             END,
     [FuelUsedMeasured]    = CASE WHEN s.[Litres] < 0.0 THEN 0.0 ELSE ISNULL(s.[Litres],0.0) END, -- handle negative values
     0                                             ,
     -1                                            ,
     s.[PulseParameterID]                          ,
     s.[PulseValue]
   FROM
     [StageUser].STAGE_FACT_ActivityChanges ac
       INNER JOIN
     [StageUser].SubTripData                s   WITH (NOLOCK) ON s.TripID = ac.TripID
       CROSS JOIN  
     [StageUser].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)  
   WHERE  
       ISNULL(CONVERT(DATETIMEOFFSET(0),s.Depart),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime  
   AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.Depart),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime
   AND (ac.IsMoreThanScoreChangeOnly = 1
   OR   ac.IsInTripSource            = 1
   OR   ac.IsInTaxClassification     = 1);
  
    -- insert Detailed records from changed Summary(TripData) into STG  
    --   we have to included all detailed records (SubTripData) from any changes in Summary(TripData) into the STG  
    --   to make sure their calculated values are updated correctly (volumes should be low)  
  
   INSERT INTO [StageUser].[STAGE_FACT_ActivityDetails]  
   (   
     [Operation]          ,  
     [TripID]             ,  
     [HostID]             ,  
     [StartGPSID]         ,  
     [EndGPSID]           ,  
     [VehicleSiteKey]     ,  
     [StartGeoLocationKey],  
     [EndGeoLocationKey]  ,  
  
     [MovementStartDateKey]   ,  
     [MovementEndDateKey]     ,  
     [MovementStartTime]      ,  
     [MovementEndTime]        ,  
     [MovementStartDateTime]  ,  
     [MovementEndDateTime]    ,  
  
     [StartOdometer]      ,  
     [EndOdometer]        ,  
     [StartEngineSeconds] ,
     [EndEngineSeconds]   ,
     
     [DistanceTravelled]  ,  
     [Duration]           ,  
     [DrivingTime]        ,  
     [StandingTime]       ,  
     [MaxSpeed]           ,  
     [SpeedTime]          ,  
     [SpeedOccurs]        ,  
     [SpeedScore]         ,  
     [MaxBrake]           ,  
     [BrakeTime]          ,  
     [BrakeOccurs]        ,  
     [BrakeScore]         ,  
     [MaxAccel]           ,  
     [AccelTime]          ,  
     [AccelOccurs]        ,  
     [AccelScore]         ,  
     [MaxRPM]             ,  
     [RPMTIme]            ,  
     [RPMOccurs]          ,  
     [RPMScore]           ,  
     [OutOfGreenBandTime] ,  
     [OutOfGreenBandScore],  
     [ExcessiveIdleTime]  ,  
     [ExcessiveIdleOccurs],  
     [ExcessiveIdleScore] ,  
     [IdleTime]           ,  
     [IdleOccurs]         ,  
     [EngineSeconds]      ,  
     [FuelUsedMeasured]   ,  
     [FuelUsedCalculated] ,  
     [FuelUsedHierarchy]  ,
     [PulseParameterKey]  ,
     [PulseValue]
   )  
   SELECT  
     'U'                      , -- update operation  
     s.[TripID]               ,  
     fad.[HostID]             ,  
     [StartGPSID] = -1        ,  
     [EndGPSID]   = -1        ,  
     fad.[VehicleSiteKey]     ,  
     fad.[StartGeoLocationKey],  
     fad.[EndGeoLocationKey]  ,  
       
     fad.[MovementStartDateKey]   ,  
     fad.[MovementEndDateKey]     ,  
     fad.[MovementStartTime]      ,  
     fad.[MovementEndTime]        ,  
     fad.[MovementStartDateTime]  ,  
     fad.[MovementEndDateTime]    ,  
  
     fad.[StartOdometer]      ,  
     fad.[EndOdometer]        ,  
     fad.[StartEngineSeconds] ,
     fad.[EndEngineSeconds]   ,

     fad.[DistanceTravelled]  ,  
     fad.[Duration]           ,  
     fad.[DrivingTime]        ,  
     fad.[StandingTime]       ,  
     fad.[MaxSpeed]           ,  
     fad.[SpeedTime]          ,  
     fad.[SpeedOccurs]        ,  
     fssd.[SpeedScore]         ,  
     fad.[MaxBrake]           ,  
     fad.[BrakeTime]          ,  
     fad.[BrakeOccurs]        ,  
     fssd.[BrakeScore]         ,  
     fad.[MaxAccel]           ,  
     fad.[AccelTime]          ,  
     fad.[AccelOccurs]        ,  
     fssd.[AccelScore]         ,  
     fad.[MaxRPM]             ,  
     fad.[RPMTIme]            ,  
     fad.[RPMOccurs]          ,  
     fssd.[RPMScore]           ,  
     fad.[OutOfGreenBandTime] ,  
     fssd.[OutOfGreenBandScore],  
     fad.[ExcessiveIdleTime]  ,  
     fad.[ExcessiveIdleOccurs],  
     fssd.[ExcessiveIdleScore] ,  
     fad.[IdleTime]           ,  
     fad.[IdleOccurs]         ,  
     fad.[EngineSeconds]      ,  
     fad.[FuelUsedMeasured]   ,  
     fad.[FuelUsedCalculated] ,  
     fad.[FuelUsedHierarchy]  ,
     fad.[PulseParameterKey]  ,
     fad.[PulseValue]
   FROM  
     [StageUser].[STAGE_FACT_ActivityChanges] s  
       INNER JOIN  
     [MiXData].dbo.FACT_ActivitySummary   fas   WITH (NOLOCK) ON fas.OrganisationKey = @organisationKey  
                                                                AND s.TripID            = fas.HostID  
       INNER JOIN  
     [MiXData].dbo.FACT_ActivityDetails   fad   WITH (NOLOCK) ON fad.OrganisationKey      = fas.OrganisationKey  
                                                                AND fad.[ActivitySummaryKey] = fas.[ActivitySummaryKey]  
       INNER JOIN  
     [MiXData].dbo.FACT_SimpleScoreDetails fssd WITH (NOLOCK) ON fssd.OrganisationKey   = fad.OrganisationKey  
                                                                AND fssd.ActivityDetailKey = fad.ActivityDetailKey  
   WHERE  
       s.IsInSubTripSource = 0  
   AND NOT EXISTS (SELECT 1  
                   FROM  
                     [StageUser].[STAGE_FACT_ActivityDetails] stg WITH (NOLOCK)  
                   WHERE  
                       stg.TripID = s.TripID  
                   AND stg.HostID = fad.HostID);  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
    RETURN -1;  
  END CATCH;  
  
  --------------------------------------------------------------------  
  -- 3. Update calculated columns onto STG  
  --------------------------------------------------------------------  
  BEGIN TRY  
  
    IF EXISTS(SELECT *  
              FROM [sys].indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser].[SubTripData]') AND name = N'IX_SubTripData_Depart')  
      DROP INDEX IX_SubTripData_Depart ON [StageUser].[SubTripData];  
  
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_TripID_HostID  
      ON [StageUser].[STAGE_FACT_ActivityDetails](TripID,HostID);  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
    INSERT INTO #VehiclesLookup
    (
      VehicleKey,
      HostID,
      StartDateKey,
      EndDateKey,
      TargetFuelConsumption,
      TargetFuelConsumptionHourly
    )
    SELECT
      dvh.VehicleKey,
      dvh.HostID,
      dvh.StartDateKey,
      dvh.EndDateKey,
      dvh.TargetFuelConsumption,
      dvh.TargetFuelConsumptionHourly
    FROM
      [MiXData].dbo.DIM_Vehicles dvh WITH (NOLOCK)
    WHERE dvh.OrganisationKey = @organisationKey;

    CREATE CLUSTERED INDEX IX_VehiclesLookup ON #VehiclesLookup(VehicleKey);

    ------------------------------------------  
    -- ActivitySummary Details  
    UPDATE  
      [StageUser].[STAGE_FACT_ActivityDetails]  
    SET  
      [ActivitySummaryKey]   = fas.[ActivitySummaryKey]    ,  
      [DriverKey]            = fas.[DriverKey]             ,  
      [VehicleKey]           = fas.[VehicleKey]            ,  
      [VehicleID]            = dvh.HostID                  ,  
      [VehicleSiteKey]       = fas.[OriginalVehicleSiteKey],  
      [UTCOffsetKey]         = fas.UTCOffsetKey            ,  
      [ActivityStartDateKey] = CASE  
                                 WHEN stg.HostID < 2  
                                   THEN fas.[ActivityStartDateKey]  
                                 ELSE   stg.[MovementStartDateKey]  
                                END,  
      [ActivityStartTime]    = CASE  
                                 WHEN stg.HostID < 2  
                                   THEN fas.[ActivityStartTime]  
                                 ELSE   stg.[MovementStartTime]  
                                END,  
      [ActivityStartDateTime]= CASE  
                                 WHEN stg.HostID < 2  
                                   THEN fas.[ActivityStartDateTime]  
                                 ELSE   stg.[MovementStartDateTime]  
                                END  
    FROM  
      [StageUser].[STAGE_FACT_ActivityDetails] stg  
        INNER JOIN  
      [MiXData].dbo.FACT_ActivitySummary   fas WITH (NOLOCK) ON stg.TripID          = fas.HostID
                                                            AND fas.OrganisationKey = @organisationKey
        LEFT JOIN  
      #VehiclesLookup                      dvh               ON fas.VehicleKey      = dvh.VehicleKey;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.2 Update ActivitySummary Details', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey  
      ON [StageUser].[STAGE_FACT_ActivityDetails](ActivityStartDateKey);  
  
    ------------------------------------------  
    -- Activity End   
      
    -- update with next records Depart/MovementStartDate  
    UPDATE stg1  
    SET  
      stg1.[ActivityEndDateKey]  = stg2.MovementStartDateKey,  
      stg1.[ActivityEndTime]     = stg2.MovementStartTime   ,  
      stg1.[ActivityEndDateTime] = stg2.MovementStartDateTime  
    FROM  
      [StageUser].[STAGE_FACT_ActivityDetails] stg1  
         INNER JOIN  
      [StageUser].[STAGE_FACT_ActivityDetails] stg2 ON stg2.TripID = stg1.TripID  
                                                   AND stg2.HostID = stg1.HostID + 1;  
  
    -- update with Trip/ActivitySummary's TripEndDate/ActivityEndDate for last ActivityDetail(SubTrip)  
    UPDATE [StageUser].[STAGE_FACT_ActivityDetails]  
    SET  
      [ActivityEndDateKey]  = fas.ActivityEndDateKey,  
      [ActivityEndTime]     = fas.ActivityEndTime   ,  
      [ActivityEndDateTime] = fas.ActivityEndDateTime  
    FROM  
      [StageUser].[STAGE_FACT_ActivityDetails] stg  
         INNER JOIN  
      [MiXData].dbo.FACT_ActivitySummary   fas WITH (NOLOCK) ON stg.TripID          = fas.HostID  
                                                               AND fas.OrganisationKey = @organisationKey  
    WHERE  
      stg.[ActivityEndDateKey] IS NULL;  
  
  
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_StartGPSID  
      ON [StageUser].[STAGE_FACT_ActivityDetails](StartGPSID);  
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_EndGPSID  
      ON [StageUser].[STAGE_FACT_ActivityDetails](EndGPSID);  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.3 Update Activity End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
    ------------------------------------------  
    -- StartGeoLocationKey  
    UPDATE [StageUser].[STAGE_FACT_ActivityDetails]  
    SET  
      StartGeoLocationKey = g.GeoLocationKey  
    FROM  
      [StageUser].[STAGE_FACT_ActivityDetails] stg  
        INNER JOIN  
      [StageUser].STAGE_DIM_GeoLocations       g WITH (NOLOCK) ON stg.StartGPSID = g.HostID;  
  
    ------------------------------------------  
    -- EndGeoLocationKey  
    UPDATE [StageUser].[STAGE_FACT_ActivityDetails]  
    SET  
      EndGeoLocationKey = g.GeoLocationKey  
    FROM  
      [StageUser].[STAGE_FACT_ActivityDetails] stg  
        INNER JOIN  
      [StageUser].STAGE_DIM_GeoLocations       g WITH (NOLOCK) ON stg.EndGPSID = g.HostID;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.4 Update GeoLocationKeys', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
    ------------------------------------------  
    -- NoGoZoneEntry  (need to find calculation)  
  
  
    ------------------------------------------  
    -- Passengers   (need to find calculation)  
  
  
    ------------------------------------------  
    -- FuelUsedCalculated  

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_VehicleKey  
      ON [StageUser].[STAGE_FACT_ActivityDetails](VehicleKey);  

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_VehicleID_ActivityStartDateTime
      ON [StageUser].[STAGE_FACT_ActivityDetails](VehicleID,ActivityStartDateTime);  
  
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Operation  
      ON [StageUser].[STAGE_FACT_ActivityDetails](ActivitySummaryKey,HostID,Operation);

  
    -- Hierarchy 1 - use TargetFuelConsumptionHourly if available,
    --           2 - use TargetFuelConsumption if available,
    --           3 - using AverageFuelConsumptionLightTruck otherwise
    UPDATE [StageUser].[STAGE_FACT_ActivityDetails]  
    SET  
      FuelUsedCalculated = CASE
                             WHEN stg.Duration > 0.0 THEN -- valid DrivingDuration
                               CASE
                                 WHEN stg.DistanceTravelled/(stg.Duration*3600.0) > stg.MaxSpeed AND stg.DistanceTravelled > 1.0   -- Avg Speed (based on Duration as driving time contains nulls) > MaxSpeed where Distance > 1km
                                   THEN -1
                                 WHEN fvh.TargetFuelConsumptionHourly > 0.0 AND ISNULL(stg.EngineSeconds,0.0) > 0.0 AND (fvh.TargetFuelConsumptionHourly * stg.EngineSeconds)/3600.0 < @maxFuelLimit
                                   THEN (fvh.TargetFuelConsumptionHourly * stg.EngineSeconds)/3600.0                 -- TargetFuelConsumptionHourly saved as l/hr
                                 WHEN fvh.TargetFuelConsumption       > 0.0 AND (fvh.TargetFuelConsumption * stg.DistanceTravelled)/100.0 < @maxFuelLimit
                                   THEN (fvh.TargetFuelConsumption       * stg.DistanceTravelled)/100.0              -- TargetFuelConsumption saved as l/100km
                                 ELSE (@averageFuelConsumptionLightTruck * ISNULL(stg.DistanceTravelled,0.0))/100.0  -- @averageFuelConsumptionLightTruck used as l/100km
                               END
                             ELSE
                               CASE
                                 WHEN fvh.TargetFuelConsumptionHourly > 0.0 AND ISNULL(stg.EngineSeconds,0.0) > 0.0 AND (fvh.TargetFuelConsumptionHourly * stg.EngineSeconds)/3600.0 < @maxFuelLimit
                                   THEN (fvh.TargetFuelConsumptionHourly * stg.EngineSeconds)/3600.0                 -- TargetFuelConsumptionHourly saved as l/hr
                                 WHEN fvh.TargetFuelConsumption       > 0.0 AND (fvh.TargetFuelConsumption * stg.DistanceTravelled)/100.0 < @maxFuelLimit
                                   THEN (fvh.TargetFuelConsumption       * stg.DistanceTravelled)/100.0              -- TargetFuelConsumption saved as l/100km
                                 ELSE (@averageFuelConsumptionLightTruck * ISNULL(stg.DistanceTravelled,0.0))/100.0  -- @averageFuelConsumptionLightTruck used as l/100km
                               END
                           END,  
      FuelUsedHierarchy  = CASE  
                             WHEN fvh.TargetFuelConsumptionHourly > 0.0 AND ISNULL(stg.EngineSeconds,0.0) > 0.0 AND (fvh.TargetFuelConsumptionHourly * stg.EngineSeconds)/3600.0 < @maxFuelLimit
                               THEN 1
                             WHEN fvh.TargetFuelConsumption       > 0.0 AND (fvh.TargetFuelConsumption * stg.DistanceTravelled)/100.0 < @maxFuelLimit
                               THEN 2
                             ELSE   3
                           END
    FROM
      [StageUser].[STAGE_FACT_ActivityDetails] stg  
        LEFT JOIN  
      #VehiclesLookup                           fvh ON fvh.VehicleKey = stg.VehicleKey;
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.5 Update FuelUsed', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    ------------------------------------------  
    -- NightDuration (from CLR function)  
    -- removed for now  
    WITH AvgActivityData AS
    (
      SELECT
        stg.ActivitySummaryKey,
        stg.HostID            ,
        AvgLatitude   = CASE
                          WHEN stg.StartGeoLocationKey > 0 
                           AND stg.EndGeoLocationKey   > 0 THEN (dgls.Latitude + dgle.Latitude)/2.0
                          WHEN stg.StartGeoLocationKey > 0 THEN  dgls.Latitude
                          WHEN stg.EndGeoLocationKey   > 0 THEN  dgle.Latitude
                          ELSE 0.0
                        END,
        AvgLongitude  = CASE
                          WHEN stg.StartGeoLocationKey > 0 
                           AND stg.EndGeoLocationKey   > 0 THEN (dgls.Longitude + dgle.Longitude)/2.0
                          WHEN stg.StartGeoLocationKey > 0 THEN  dgls.Longitude
                          WHEN stg.EndGeoLocationKey   > 0 THEN  dgle.Longitude
                          ELSE 0.0
                        END
      FROM
        [StageUser].[STAGE_FACT_ActivityDetails] stg
          LEFT JOIN
        [MiXData].dbo.DIM_GeoLocations dgls WITH (NOLOCK) ON dgls.GeoLocationKey = stg.StartGeoLocationKey
          LEFT JOIN
        [MiXData].dbo.DIM_GeoLocations dgle WITH (NOLOCK) ON dgle.GeoLocationKey = stg.EndGeoLocationKey
    )
    UPDATE
      stg
    SET
      NightDuration = dbo.fncNightTimeDuration(aad.AvgLatitude,aad.AvgLongitude,stg.ActivityStartDateTime,stg.ActivityEndDateTime)
    FROM
      [StageUser].[STAGE_FACT_ActivityDetails] stg
        INNER JOIN
      AvgActivityData                          aad ON aad.ActivitySummaryKey = stg.ActivitySummaryKey
                                                  AND aad.HostID             = stg.HostID;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.6 Update NightDuration', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    ------------------------------------------  
    -- AfterHoursDuration (still to be defined)  
  
  
    ------------------------------------------  
    -- TotalCarbonEmission/TotalCO2Emission
    UPDATE [StageUser].[STAGE_FACT_ActivityDetails]  
    SET  
      TotalCarbonEmission = FuelUsedMeasured * @averageCarbonEmission,
      TotalCO2Emission    = FuelUsedMeasured * @averageCO2Emission
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.7 Update TotalCarbonEmission/TotalCO2Emission', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
    ------------------------------------------  
    -- IsLastMovement  
    ;WITH LastMovement AS  
    (  
      SELECT  
        TripID,  
        LastMovement = MAX(HostID)  
      FROM  
        [StageUser].[STAGE_FACT_ActivityDetails]  
      GROUP BY  
        TripID  
    )  
    UPDATE  
      [StageUser].[STAGE_FACT_ActivityDetails]  
    SET  
      IsLastMovement = 1  
    FROM  
      [StageUser].[STAGE_FACT_ActivityDetails] stg  
        INNER JOIN  
      LastMovement                             m   ON stg.TripID = m.TripID   
                                                  AND stg.HostID = m.LastMovement;  

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.8 Update IsLastMovement', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    ------------------------------------------
    -- ParameterKey
    UPDATE
      [StageUser].[STAGE_FACT_ActivityDetails]
    SET
      [PulseParameterKey] = dcp.ParameterKey
    FROM
      [StageUser].[STAGE_FACT_ActivityDetails]   stg
        INNER JOIN
      [MiXData].dbo.DIM_CalibrationParameters dcp WITH (NOLOCK) ON dcp.OrganisationKey = @organisationKey
                                                                  AND dcp.HostID          = stg.PulseParameterID;
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.9 Update ParameterKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    ------------------------------------------
    -- RoadSpeedScoring values
    ;WITH
    OverSpeedingScoreCriteria AS
    (
      SELECT
        dsc.ScoreDuration,          -- @OverSpeedDurationLimit
        dsc.ScoreSeverity           -- @OverSpeedScoreSeverity
      FROM [MiXData].dbo.DIM_SimpleScoreCriteria dsc WITH (NOLOCK)
      WHERE dsc.OrganisationKey = @organisationKey
      AND dsc.HostID            = 1 -- Over Speeding event
      AND dsc.IsCurrentRecord   = 1 -- only use latest ScoreCriteria record
    ),
    IndividualEventScores AS
    (
      SELECT
        ed.VehicleID,
        ed.StartDate,
        ed.TotalOccurs,
        ed.TotalTime,
        SeverityScore = CASE
                          WHEN ed.Value IS NOT NULL THEN
                            dbo.fncCalculateRoadSpeedOverspeedingSeverityScore
                              (
                                dsc.ScoreSeverity,          -- @OverSpeedSeverityFactor
                                ISNULL(el.SpeedLimit,0.0),  -- @EventSpeedLimit
                                ISNULL(ed.Value,0.0)        -- @EventSpeed
                              )
                          ELSE 100.0
                        END
      FROM
        [StageUser].STAGE_FACT_EventRoadspeedLimits el  WITH (NOLOCK)
          INNER JOIN
        [StageUser].EventData                       ed  WITH (NOLOCK) ON el.EventKey = ed.EventKey
          CROSS JOIN
        OverSpeedingScoreCriteria                   dsc
      WHERE ed.Operation IN ('I','U')
    )
    INSERT INTO [StageUser].STAGE_FACT_EventRoadspeedLimitsScores
    (
      TripID,
      HostID,
      RoadSpeedOccurs,
      RoadSpeedTime,
      SeverityScore,
      DurationScore
    )
    SELECT
      std.TripID,
      std.HostID,
      RoadSpeedOccurs = SUM(ies.TotalOccurs),
      RoadSpeedTime   = SUM(ies.TotalTime),
      SeverityScore   = MIN(ies.SeverityScore),
      DurationScore   = dbo.fncCalculateRoadSpeedOverspeedingDurationScore
                          (
                            dsc.ScoreDuration,               --@OverSpeedDurationFactor,
                            ISNULL(SUM(ies.TotalTime),0.0),  --@EventTotalTime,
                            ISNULL(std.DrivingTime,0.0) --@SubTripDuration
                          )
    FROM
      IndividualEventScores     ies
        INNER JOIN
      [StageUser].STAGE_FACT_ActivityDetails std ON std.VehicleID = ies.VehicleID
                                                AND ies.StartDate BETWEEN CONVERT(DATETIME,std.MovementStartDateTime) AND CONVERT(DATETIME,std.MovementEndDateTime)
        CROSS JOIN
      OverSpeedingScoreCriteria dsc
    WHERE std.Operation IN ('I','U')
    AND std.MovementStartDateTime > '19000101'
    GROUP BY
      std.TripID,
      std.HostID,
      std.DrivingTime,
      dsc.ScoreDuration;

    -- update SubTripData
    UPDATE std
    SET
      RoadSpeedTime   = srs.RoadSpeedTime,
      RoadSpeedOccurs = srs.RoadSpeedOccurs,
      RoadSpeedScore  = (ISNULL(srs.DurationScore,0.0)+ISNULL(srs.SeverityScore,0.0))/2.0
    FROM
      [StageUser].STAGE_FACT_EventRoadspeedLimitsScores srs
        INNER JOIN
      [StageUser].SubTripData                           std ON std.TripID   = srs.TripID
                                                           AND std.Sequence = srs.HostID;

    -- update STAGE
    UPDATE std
    SET
      RoadSpeedTime   = srs.RoadSpeedTime,
      RoadSpeedOccurs = srs.RoadSpeedOccurs,
      RoadSpeedScore  = (ISNULL(srs.DurationScore,0.0)+ISNULL(srs.SeverityScore,0.0))/2.0
    FROM
      [StageUser].STAGE_FACT_EventRoadspeedLimitsScores srs
        INNER JOIN
      [StageUser].[STAGE_FACT_ActivityDetails]          std ON std.TripID = srs.TripID
                                                           AND std.HostID = srs.HostID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.10 update RoadSpeedScoring values', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------  
  -- 4. Validation before Loading to DW  
  --------------------------------------------------------------------  
  BEGIN TRY  
  
    IF EXISTS (SELECT 1  
               FROM  
                 [StageUser].[STAGE_FACT_ActivityDetails]  
               WHERE  
                 ActivityStartDateKey > DATEADD(DAY,1,@currentDate))  
    BEGIN  
      RAISERROR(N'Some Units internal clock seem to be out of sync',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;  
  END CATCH;  
  
  --------------------------------------------------------------------  
  -- 5. MERGE to DW (Load) and add to RollBck  
  --------------------------------------------------------------------  
  BEGIN TRY  
  
    -- Remove ActivityDetails where no summary values exists (proir to 2006 data)  
    DELETE [StageUser].[STAGE_FACT_ActivityDetails]  
    WHERE ActivitySummaryKey IS NULL;  
      
    -- Add existing records to RollBck table  
    -- update records existing in DW  
    INSERT INTO [StageUser].[ROLLBACK_FACT_ActivityDetails]  
    (   
      [ActivityDetailKey]   ,  
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
                              
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],  
      [MovementEndDateTime]  ,  
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]    ,  
  
      [StartOdometer]       ,  
      [EndOdometer]         ,  
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,  
      [AccelTime]           ,  
      [AccelOccurs]         ,  
  
      [MaxRPM]              ,  
      [RPMTIme]             ,  
      [RPMOccurs]           ,  
                              
      [OutOfGreenBandTime]  ,  
  
      [ExcessiveIdleTime]   ,  
      [ExcessiveIdleOccurs] ,  
  
      [IdleTime]            ,  
      [IdleOccurs]          ,  
  
      [EngineSeconds]         ,  
  
      -- calculated fields  
      [NoGoZoneEntry]       ,  
      [Passengers]          ,  
  
      [FuelUsedMeasured]    ,  
      [FuelUsedCalculated]  ,  
      [FuelUsedHierarchy]   ,  
        
      [NightDuration]       ,
      [AfterHoursDuration]  ,
      [TotalCarbonEmission] ,
      [TotalCO2Emission]    ,
  
      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,
      [UpdateBatchKey]
    )  
    SELECT  
      [ActivityDetailKey]   ,  
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
  
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],  
      [MovementEndDateTime]  ,  
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]    ,  
  
      [StartOdometer]       ,  
      [EndOdometer]         ,  
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,
      [AccelTime]           ,
      [AccelOccurs]         ,
  
      [MaxRPM]              ,
      [RPMTIme]             ,
      [RPMOccurs]           ,
  
      [OutOfGreenBandTime]  ,
  
      [ExcessiveIdleTime]   ,
      [ExcessiveIdleOccurs] ,
  
      [IdleTime]            ,
      [IdleOccurs]          ,
  
      [EngineSeconds]       ,
  
      -- calculated fields  
      [NoGoZoneEntry]       ,
      [Passengers]          ,
  
      [FuelUsedMeasured]    ,
      [FuelUsedCalculated]  ,
      [FuelUsedHierarchy]   ,
  
      [NightDuration]       ,
      [AfterHoursDuration]  ,
      [TotalCarbonEmission] ,
      [TotalCO2Emission]    ,

      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,
      [UpdateBatchKey]
    FROM  
     (UPDATE [MiXData].dbo.FACT_ActivityDetails  
      SET   
        [VehicleSiteKey]        = ISNULL(stg.[VehicleSiteKey]       ,-1),  
--        [ActivityStartDateKey]  = stg.[ActivityStartDateKey] ,  
        [ActivityEndDateKey]    = stg.[ActivityEndDateKey]   ,  
        [ActivityStartTime]     = stg.[ActivityStartTime]    ,  
        [ActivityEndTime]       = stg.[ActivityEndTime]      ,  
        [ActivityStartDateTime] = stg.[ActivityStartDateTime],  
        [ActivityEndDateTime]   = stg.[ActivityEndDateTime]  ,  
        [MovementStartDateKey]  = stg.[MovementStartDateKey] ,  
        [MovementEndDateKey]    = stg.[MovementEndDateKey]   ,  
        [MovementStartTime]     = stg.[MovementStartTime]    ,  
        [MovementEndTime]       = stg.[MovementEndTime]      ,  
        [MovementStartDateTime] = stg.[MovementStartDateTime],  
        [MovementEndDateTime]   = stg.[MovementEndDateTime]  ,  
        [IsLastMovement]        = ISNULL(stg.[IsLastMovement],0),
  
        [StartOdometer]         = stg.[StartOdometer]        ,  
        [EndOdometer]           = stg.[EndOdometer]          ,  
        [StartEngineSeconds]    = stg.[StartEngineSeconds]   ,
        [EndEngineSeconds]      = stg.[EndEngineSeconds]     ,

        [StartGeoLocationKey]   = ISNULL(stg.[StartGeoLocationKey]  ,tar.[StartGeoLocationKey]),  
        [EndGeoLocationKey]     = ISNULL(stg.[EndGeoLocationKey]    ,tar.[EndGeoLocationKey]),  
        [DistanceTravelled]     = stg.[DistanceTravelled]    ,  
        [Duration]              = stg.[Duration]             ,  
        [DrivingTime]           = stg.[DrivingTime]          ,  
        [StandingTime]          = stg.[StandingTime]         ,  
  
        [DriverKey]             = ISNULL(stg.[DriverKey]            ,-1),  
        [VehicleKey]            = ISNULL(stg.[VehicleKey]           ,-1),  
  
        [MaxSpeed]              = stg.[MaxSpeed]             ,  
        [SpeedTime]             = stg.[SpeedTime]            ,  
        [SpeedOccurs]           = stg.[SpeedOccurs]          ,  
  
        [MaxBrake]              = stg.[MaxBrake]             ,  
        [BrakeTime]             = stg.[BrakeTime]            ,  
        [BrakeOccurs]           = stg.[BrakeOccurs]          ,  
  
        [MaxAccel]              = stg.[MaxAccel]             ,  
        [AccelTime]             = stg.[AccelTime]            ,  
        [AccelOccurs]           = stg.[AccelOccurs]          ,  
  
        [MaxRPM]                = stg.[MaxRPM]               ,  
        [RPMTIme]               = stg.[RPMTIme]              ,  
        [RPMOccurs]             = stg.[RPMOccurs]            ,  
  
        [OutOfGreenBandTime]    = stg.[OutOfGreenBandTime]   ,  
  
        [ExcessiveIdleTime]     = stg.[ExcessiveIdleTime]    ,  
        [ExcessiveIdleOccurs]   = stg.[ExcessiveIdleOccurs]  ,  
  
        [IdleTime]              = stg.[IdleTime]             ,  
        [IdleOccurs]            = stg.[IdleOccurs]           ,  
  
        [EngineSeconds]         = stg.[EngineSeconds]        ,  
  
        --calculated fields  
        [NoGoZoneEntry]         = stg.[NoGoZoneEntry]        ,  
        [Passengers]            = stg.[Passengers]           ,  
  
        [FuelUsedMeasured]      = ISNULL(stg.[FuelUsedMeasured]  ,0.0),  
        [FuelUsedCalculated]    = ISNULL(stg.[FuelUsedCalculated],0.0),  
        [FuelUsedHierarchy]     = ISNULL(stg.[FuelUsedHierarchy] ,-1) ,  
  
        [NightDuration]         = ISNULL(stg.[NightDuration]     ,0.0),
        [AfterHoursDuration]    = stg.[AfterHoursDuration]   ,  
        [TotalCarbonEmission]   = stg.[TotalCarbonEmission]  ,  
        [TotalCO2Emission]      = stg.[TotalCO2Emission]     ,

        [RoadSpeedTime]         = ISNULL(stg.[RoadSpeedTime],0),
        [RoadSpeedOccurs]       = ISNULL(stg.[RoadSpeedOccurs],0),

        [UTCOffsetKey]          = stg.[UTCOffsetKey]         ,  
        [IsDeleted]             = 0                          ,
        UpdateBatchKey          = @batchKey  
      OUTPUT  
        DELETED.[ActivityDetailKey]   ,  
        DELETED.[ActivitySummaryKey]  ,  
        DELETED.[OrganisationKey]     ,  
        DELETED.[HostID]              ,  
  
        DELETED.[VehicleSiteKey]      ,  
        DELETED.[ActivityStartDateKey],  
        DELETED.[ActivityEndDateKey]  ,  
        DELETED.[ActivityStartTime]   ,  
        DELETED.[ActivityEndTime]     ,  
        DELETED.[ActivityStartDateTime],  
        DELETED.[ActivityEndDateTime]  ,  
        DELETED.[MovementStartDateKey],  
        DELETED.[MovementEndDateKey]  ,  
        DELETED.[MovementStartTime]   ,  
        DELETED.[MovementEndTime]     ,  
        DELETED.[MovementStartDateTime],  
        DELETED.[MovementEndDateTime]  ,  
        DELETED.[NextMovementActivityDetailKey],
        DELETED.[NextMovementStartDateTime]    ,
        DELETED.[IsLastMovement]      ,
  
        DELETED.[StartOdometer]       ,  
        DELETED.[EndOdometer]         ,  
        DELETED.[StartEngineSeconds]  ,
        DELETED.[EndEngineSeconds]    ,
        
        DELETED.[StartGeoLocationKey] ,  
        DELETED.[EndGeoLocationKey]   ,  
        DELETED.[DistanceTravelled]   ,  
        DELETED.[Duration]            ,  
        DELETED.[DrivingTime]         ,  
        DELETED.[StandingTime]        ,  
  
        DELETED.[DriverKey]           ,  
        DELETED.[VehicleKey]          ,  
  
        DELETED.[MaxSpeed]            ,  
        DELETED.[SpeedTime]           ,  
        DELETED.[SpeedOccurs]         ,  
  
        DELETED.[MaxBrake]            ,  
        DELETED.[BrakeTime]           ,  
        DELETED.[BrakeOccurs]         ,  
  
        DELETED.[MaxAccel]            ,  
        DELETED.[AccelTime]           ,  
        DELETED.[AccelOccurs]         ,  
  
        DELETED.[MaxRPM]              ,  
        DELETED.[RPMTIme]             ,  
        DELETED.[RPMOccurs]           ,  
  
        DELETED.[OutOfGreenBandTime]  ,  
  
        DELETED.[ExcessiveIdleTime]   ,  
        DELETED.[ExcessiveIdleOccurs] ,  
  
        DELETED.[IdleTime]            ,  
        DELETED.[IdleOccurs]          ,  
  
        DELETED.[EngineSeconds]         ,  
  
        -- calculated fields  
        DELETED.[NoGoZoneEntry]       ,  
        DELETED.[Passengers]          ,  
  
        DELETED.[FuelUsedMeasured]    ,  
        DELETED.[FuelUsedCalculated]  ,  
        DELETED.[FuelUsedHierarchy]   ,  
          
        DELETED.[NightDuration]       ,  
        DELETED.[AfterHoursDuration]  ,  
        DELETED.[TotalCarbonEmission] ,  
        DELETED.[TotalCO2Emission]    ,

        DELETED.[RoadSpeedTime]       ,
        DELETED.[RoadSpeedOccurs]     , 

        DELETED.[UTCOffsetKey]        ,  
        DELETED.[IsDeleted]           ,
        DELETED.[CreateBatchKey]      ,  
        DELETED.[UpdateBatchKey]  
      FROM
        [MiXData].dbo.FACT_ActivityDetails    AS tar
          INNER JOIN
        [StageUser].[STAGE_FACT_ActivityDetails] AS stg
          ON  tar.OrganisationKey      = @organisationKey
          AND tar.ActivitySummaryKey   = stg.ActivitySummaryKey
          AND tar.HostID               = stg.HostID
          AND tar.ActivityStartDateKey = stg.ActivityStartDateKey
      WHERE stg.Operation in ('I','U')
      ) AS upd;
  
    -- record number of records updated  
    SELECT @recordsUpdated = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    -- Deleted records
    INSERT INTO [StageUser].[ROLLBACK_FACT_ActivityDetails]  
    (   
      [ActivityDetailKey]   ,  
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
                              
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],
      [MovementEndDateTime]  ,
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]      ,
  
      [StartOdometer]       ,  
      [EndOdometer]         ,  
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,  
      [AccelTime]           ,  
      [AccelOccurs]         ,  
  
      [MaxRPM]              ,  
      [RPMTIme]             ,  
      [RPMOccurs]           ,  
                              
      [OutOfGreenBandTime]  ,  
  
      [ExcessiveIdleTime]   ,  
      [ExcessiveIdleOccurs] ,  
  
      [IdleTime]            ,  
      [IdleOccurs]          ,  
  
      [EngineSeconds]         ,  
  
      -- calculated fields  
      [NoGoZoneEntry]       ,  
      [Passengers]          ,  
  
      [FuelUsedMeasured]    ,  
      [FuelUsedCalculated]  ,  
      [FuelUsedHierarchy]   ,  
        
      [NightDuration]       ,
      [AfterHoursDuration]  ,
      [TotalCarbonEmission] ,
      [TotalCO2Emission]    ,
  
      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,
      [UpdateBatchKey]
    )  
    SELECT  
      [ActivityDetailKey]   ,  
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
  
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],  
      [MovementEndDateTime]  ,  
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]      ,
  
      [StartOdometer]       ,  
      [EndOdometer]         ,  
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,
      [AccelTime]           ,
      [AccelOccurs]         ,
  
      [MaxRPM]              ,
      [RPMTIme]             ,
      [RPMOccurs]           ,
  
      [OutOfGreenBandTime]  ,
  
      [ExcessiveIdleTime]   ,
      [ExcessiveIdleOccurs] ,
  
      [IdleTime]            ,
      [IdleOccurs]          ,
  
      [EngineSeconds]       ,
  
      -- calculated fields  
      [NoGoZoneEntry]       ,
      [Passengers]          ,
  
      [FuelUsedMeasured]    ,
      [FuelUsedCalculated]  ,
      [FuelUsedHierarchy]   ,
  
      [NightDuration]       ,
      [AfterHoursDuration]  ,
      [TotalCarbonEmission] ,
      [TotalCO2Emission]    ,

      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,
      [UpdateBatchKey]
    FROM  
     (UPDATE [MiXData].dbo.FACT_ActivityDetails  
      SET   
        [IsDeleted]      = 1,
        [UpdateBatchKey] = @batchKey
      OUTPUT  
        DELETED.[ActivityDetailKey]   ,  
        DELETED.[ActivitySummaryKey]  ,  
        DELETED.[OrganisationKey]     ,  
        DELETED.[HostID]              ,  
  
        DELETED.[VehicleSiteKey]      ,  
        DELETED.[ActivityStartDateKey],  
        DELETED.[ActivityEndDateKey]  ,  
        DELETED.[ActivityStartTime]   ,  
        DELETED.[ActivityEndTime]     ,  
        DELETED.[ActivityStartDateTime],  
        DELETED.[ActivityEndDateTime]  ,  
        DELETED.[MovementStartDateKey],  
        DELETED.[MovementEndDateKey]  ,  
        DELETED.[MovementStartTime]   ,  
        DELETED.[MovementEndTime]     ,  
        DELETED.[MovementStartDateTime],  
        DELETED.[MovementEndDateTime]  ,  
        DELETED.[NextMovementActivityDetailKey],
        DELETED.[NextMovementStartDateTime]    ,
        DELETED.[IsLastMovement]      ,
  
        DELETED.[StartOdometer]       ,  
        DELETED.[EndOdometer]         ,  
        DELETED.[StartEngineSeconds]  ,
        DELETED.[EndEngineSeconds]    ,

        DELETED.[StartGeoLocationKey] ,  
        DELETED.[EndGeoLocationKey]   ,  
        DELETED.[DistanceTravelled]   ,  
        DELETED.[Duration]            ,  
        DELETED.[DrivingTime]         ,  
        DELETED.[StandingTime]        ,  
  
        DELETED.[DriverKey]           ,  
        DELETED.[VehicleKey]          ,  
  
        DELETED.[MaxSpeed]            ,  
        DELETED.[SpeedTime]           ,  
        DELETED.[SpeedOccurs]         ,  
  
        DELETED.[MaxBrake]            ,  
        DELETED.[BrakeTime]           ,  
        DELETED.[BrakeOccurs]         ,  
  
        DELETED.[MaxAccel]            ,  
        DELETED.[AccelTime]           ,  
        DELETED.[AccelOccurs]         ,  
  
        DELETED.[MaxRPM]              ,  
        DELETED.[RPMTIme]             ,  
        DELETED.[RPMOccurs]           ,  
  
        DELETED.[OutOfGreenBandTime]  ,  
  
        DELETED.[ExcessiveIdleTime]   ,  
        DELETED.[ExcessiveIdleOccurs] ,  
  
        DELETED.[IdleTime]            ,  
        DELETED.[IdleOccurs]          ,  
  
        DELETED.[EngineSeconds]         ,  
  
        -- calculated fields  
        DELETED.[NoGoZoneEntry]       ,  
        DELETED.[Passengers]          ,  
  
        DELETED.[FuelUsedMeasured]    ,  
        DELETED.[FuelUsedCalculated]  ,  
        DELETED.[FuelUsedHierarchy]   ,  
          
        DELETED.[NightDuration]       ,  
        DELETED.[AfterHoursDuration]  ,  
        DELETED.[TotalCarbonEmission] ,  
        DELETED.[TotalCO2Emission]    ,

        DELETED.[RoadSpeedTime]       ,
        DELETED.[RoadSpeedOccurs]     ,

        DELETED.[UTCOffsetKey]        , 
        DELETED.[IsDeleted]           , 
        DELETED.[CreateBatchKey]      ,  
        DELETED.[UpdateBatchKey]  
      FROM   
        [MiXData].dbo.FACT_ActivityDetails    AS tar
          INNER JOIN
        [StageUser].[STAGE_FACT_ActivityDetails] AS stg
          ON  tar.OrganisationKey      = @organisationKey
          AND tar.ActivitySummaryKey   = stg.ActivitySummaryKey
          AND tar.HostID               = stg.HostID
          AND tar.ActivityStartDateKey = stg.ActivityStartDateKey
      WHERE stg.Operation = 'D'
      ) AS del
    WHERE
      UpdateBatchKey <> @batchKey;

    -- record number of records deleted  
    SELECT @recordsDeleted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    -- create rollback index  
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_ActivityDetails_ActivitySummaryKey_HostID  
      ON [StageUser].[ROLLBACK_FACT_ActivityDetails](ActivitySummaryKey,HostID);  
  
    -- insert records not existing in DW  
    INSERT [MiXData].dbo.FACT_ActivityDetails  
    (   
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
  
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],  
      [MovementEndDateTime]  ,  
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]      ,
  
      [StartOdometer]       ,  
      [EndOdometer]         ,
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,  
      [AccelTime]           ,  
      [AccelOccurs]         ,  
  
      [MaxRPM]              ,  
      [RPMTIme]             ,  
      [RPMOccurs]           ,  
                              
      [OutOfGreenBandTime]  ,  
  
      [ExcessiveIdleTime]   ,  
      [ExcessiveIdleOccurs] ,  
  
      [IdleTime]            ,  
      [IdleOccurs]          ,  
  
      [EngineSeconds]         ,  
  
      -- calculated fields  
      [NoGoZoneEntry]       ,  
      [Passengers]          ,  
  
      [FuelUsedMeasured]    ,  
      [FuelUsedCalculated]  ,  
      [FuelUsedHierarchy]   ,  
  
      [NightDuration]       ,  
      [AfterHoursDuration]  ,  
      [TotalCarbonEmission] ,  
      [TotalCO2Emission]    ,
        
      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,  
      [UpdateBatchKey]  
    )  
    SELECT  
      stg.[ActivitySummaryKey]  ,  
      @organisationKey          ,  
      stg.[HostID]              ,  
  
      ISNULL(stg.[VehicleSiteKey]      ,-1),  
      stg.[ActivityStartDateKey],  
      stg.[ActivityEndDateKey]  ,  
      stg.[ActivityStartTime]   ,  
      stg.[ActivityEndTime]     ,  
      stg.[ActivityStartDateTime],  
      stg.[ActivityEndDateTime]  ,  
      stg.[MovementStartDateKey],  
      stg.[MovementEndDateKey]  ,  
      stg.[MovementStartTime]   ,  
      stg.[MovementEndTime]     ,  
      stg.[MovementStartDateTime],  
      stg.[MovementEndDateTime]  ,  
      [NextMovementActivityDetailKey] = -1,
      [NextMovementStartDateTime]     = @unknownDateDefault,
      ISNULL(stg.[IsLastMovement],0),
  
      stg.[StartOdometer]       ,  
      stg.[EndOdometer]         ,  
      stg.[StartEngineSeconds]  ,
      stg.[EndEngineSeconds]    ,

      ISNULL(stg.[StartGeoLocationKey] ,-1),  
      ISNULL(stg.[EndGeoLocationKey]   ,-1),  
      stg.[DistanceTravelled]   ,  
      stg.[Duration]            ,  
      stg.[DrivingTime]         ,  
      stg.[StandingTime]        ,  
  
      ISNULL(stg.[DriverKey]           ,-1),  
      ISNULL(stg.[VehicleKey]          ,-1),  
  
      stg.[MaxSpeed]            ,  
      stg.[SpeedTime]           ,  
      stg.[SpeedOccurs]         ,  
  
      stg.[MaxBrake]            ,  
      stg.[BrakeTime]           ,  
      stg.[BrakeOccurs]         ,  
  
      stg.[MaxAccel]            ,  
      stg.[AccelTime]           ,  
      stg.[AccelOccurs]         ,  
  
      stg.[MaxRPM]              ,  
      stg.[RPMTIme]             ,  
      stg.[RPMOccurs]           ,  
  
      stg.[OutOfGreenBandTime]  ,  
  
      stg.[ExcessiveIdleTime]   ,  
      stg.[ExcessiveIdleOccurs] ,  
  
      stg.[IdleTime]            ,  
      stg.[IdleOccurs]          ,  
  
      stg.[EngineSeconds]         ,  
  
      -- calculated fields  
      stg.[NoGoZoneEntry]       ,  
      stg.[Passengers]          ,  
        
      ISNULL(stg.[FuelUsedMeasured]  ,0.0),  
      ISNULL(stg.[FuelUsedCalculated],0.0),  
      ISNULL(stg.[FuelUsedHierarchy] ,-1) ,  
  
      ISNULL(stg.[NightDuration]     ,0.0),
      stg.[AfterHoursDuration]  ,  
      stg.[TotalCarbonEmission] ,  
      stg.[TotalCO2Emission]    ,

      ISNULL(stg.[RoadSpeedTime],0),
      ISNULL(stg.[RoadSpeedOccurs],0),

      stg.[UTCOffsetKey]        ,
      0                         , -- IsDeleted
      @batchKey                 ,  
      @batchKey  
    FROM   
      [StageUser].[STAGE_FACT_ActivityDetails] AS stg  
    WHERE  
        stg.Operation in ('I','U')  
    AND NOT EXISTS (SELECT 1  
                    FROM  
                      [StageUser].[ROLLBACK_FACT_ActivityDetails] AS roll WITH (NOLOCK)  
                    WHERE  
                        stg.ActivitySummaryKey = roll.ActivitySummaryKey  
                    AND stg.HostID             = roll.HostID);  
  
    -- record number of records inserted  
    SELECT @recordsInserted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
    RETURN -1;  
  END CATCH;  
  
  --------------------------------------------------------------------  
  -- 6. Update ActivityDetailKey foreignkeys on other tables  
  --------------------------------------------------------------------  
  
  BEGIN TRY  
  
    ------------------------------------------  
    -- ActivityDetailKey (beter to get ActivityDetailKey on STG and then use with Lookups for other FACT tables)  
    UPDATE [StageUser].[STAGE_FACT_ActivityDetails]  
    SET  
      ActivityDetailKey = fad.ActivityDetailKey  
    FROM  
      [StageUser].[STAGE_FACT_ActivityDetails] stg  
        INNER JOIN  
      [MiXData].dbo.FACT_ActivityDetails    fad WITH (NOLOCK) ON fad.ActivitySummaryKey   = stg.ActivitySummaryKey  
                                                                AND fad.HostID               = stg.HostID  
                                                                AND fad.OrganisationKey      = @organisationKey
                                                                AND fad.ActivityStartDateKey = stg.ActivityStartDateKey;

    ------------------------------------------  
    -- FACT_FuelCapture (ActivityDetailKey,FuelStopGeoLocationKey)  
    UPDATE  
      [MiXData].dbo.[FACT_FuelCapture]  
    SET  
      [ActivityDetailKey]       = fad.[ActivityDetailKey],  
      [FuelStopGeoLocationKey]  = fad.[StartGeoLocationKey]  
    FROM  
      [MiXData].dbo.[FACT_FuelCapture]        ffc
        INNER JOIN  
      #VehiclesLookup                         dvf               ON ffc.VehicleKey      = dvf.VehicleKey  
        INNER JOIN  
      [StageUser].STAGE_FACT_ActivityDetails fad WITH (NOLOCK) ON fad.VehicleID       = dvf.HostID  
    WHERE  
        ffc.[OrganisationKey] = @organisationKey  
    AND ffc.[FillOdometer]    BETWEEN fad.[StartOdometer] AND fad.[EndOdometer];  
  
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_ActivityStartDateTime_ActivityEndDateTime   
      ON [StageUser].[STAGE_FACT_ActivityDetails](VehicleID,ActivityStartDateTime,ActivityEndDateTime)  
      INCLUDE(ActivityDetailKey);  
  
    ------------------------------------------  
    -- FACT_PositionDetails (ActivityDetailKey)  
    -- removed for now  

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6. Update ActivityDetailKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Update ActivityDetailKey foreignkeys on other tables';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
    RETURN -1;  
  END CATCH;  

  --------------------------------------------------------------------  
  -- 7. Update Overall ActivityDetail values
  -------------------------------------------------------------------- 

  BEGIN TRY

    ------------------------------------------
    -- calc for NextMovement
    -- 7.1.1 Get min MovementStartDateTime for STAGE for each vehicle
    INSERT INTO #lastMovementStartDateTime
    (
      VehicleID               ,
      MinMovementStartDateTime
    )
    SELECT
      stg.VehicleID ,
      MIN(MovementStartDateTime)
    FROM
      [StageUser].STAGE_FACT_ActivityDetails stg
    WHERE
      stg.HostID > 0
--      MovementStartDateTime > @validDateStartTime
    GROUP BY
      stg.VehicleID;

    CREATE CLUSTERED INDEX IX_lastMovementStartDateTime ON #lastMovementStartDateTime(VehicleID,MinMovementStartDateTime);

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='7.1.1 Get STAGE LastMovement', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7.1  Get STAGE LastMovement';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    -- 7.1.2. Get PreviousMovementStartDateTime from FAD because we need to recalc from that point onwards
    UPDATE
      #lastMovementStartDateTime
    SET
      PrevMovementStartDateTime = ISNULL((SELECT MAX(fad.MovementStartDateTime)
                                          FROM
                                            #VehiclesLookup                    dvh
                                              INNER JOIN
                                            [MiXData].dbo.FACT_ActivityDetails fad  WITH (NOLOCK) ON lm.VehicleID        = dvh.HostID
                                                                                                 AND fad.VehicleKey      = dvh.VehicleKey
                                          WHERE
                                              fad.MovementStartDateTime > '19000101'
                                          AND fad.MovementStartDateTime < lm.MinMovementStartDateTime),
                                          lm.MinMovementStartDateTime)
    FROM
      #lastMovementStartDateTime lm;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='7.1.2 Get Previous Movement from FAD', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7.2 Get Previous Movement from FAD';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  


    -- 7.1.3 get list of records to be updated with the cols necessary to do the calc
    INSERT INTO #recordsForNextMovementCalc
    ( 
      VehicleKey                    ,
      VehicleID                     ,
      MovementStartDateTime         ,
      MovementEndDateTime           ,
      ActivityDetailKey
    )
    SELECT
      fad.VehicleKey           ,
      lm.VehicleID             ,
      fad.MovementStartDateTime,
      fad.MovementEndDateTime  ,
      fad.ActivityDetailKey
    FROM
      #lastMovementStartDateTime         lm
        INNER JOIN
      #VehiclesLookup                    dvh                ON dvh.HostID           = lm.VehicleID
        INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails fad  WITH (NOLOCK) ON fad.VehicleKey       = dvh.VehicleKey
    WHERE
        fad.HostID > 0
    --    fad.MovementStartDateTime >  @validDateStartTime
    --AND fad.MovementEndDateTime   >  @validDateStartTime
    AND fad.MovementStartDateTime >= lm.PrevMovementStartDateTime;

    -- DROP INDEX IX_recordsForNextMovementCalc ON #recordsForNextMovementCalc;
    CREATE CLUSTERED INDEX IX_recordsForNextMovementCalc
      ON #recordsForNextMovementCalc
      (VehicleID,MovementStartDateTime,ActivityDetailKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='7.1.3 Get activities to process from FAD', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7.3 Get activities to process from FAD';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    -- 7.1.4 calculate values
    UPDATE
      #recordsForNextMovementCalc
    SET
      NextMovementStartDateTime = ISNULL((SELECT MIN(nm1.MovementStartDateTime)
                                          FROM #recordsForNextMovementCalc nm1
                                          WHERE
                                              nm1.VehicleID             = nm.VehicleID
                                          AND nm1.MovementStartDateTime > nm.MovementStartDateTime),
                                         nm.MovementStartDateTime)
    FROM                                 
      #recordsForNextMovementCalc nm;
-- 3s

    UPDATE
      #recordsForNextMovementCalc
    SET
      NextMovementActivityDetailKey = ISNULL((SELECT MIN(nm1.ActivityDetailKey)
                                              FROM #recordsForNextMovementCalc nm1
                                              WHERE
                                                  nm1.VehicleID = nm.VehicleID
                                              AND nm1.MovementStartDateTime = nm.NextMovementStartDateTime),
                                             -1)
    FROM
      #recordsForNextMovementCalc nm;
-- 1s

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='7.1.4 Calculate values', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7.1.4 Calculate values';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    ------------------------------------------
    -- NextMovementStartDateTime/NextMovementActivityDetailKey
    INSERT INTO [StageUser].[ROLLBACK_FACT_ActivityDetails]  
    (   
      [ActivityDetailKey]   ,  
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
                              
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],
      [MovementEndDateTime]  ,
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]      ,
  
      [StartOdometer]       ,  
      [EndOdometer]         ,  
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,  
      [AccelTime]           ,  
      [AccelOccurs]         ,  
  
      [MaxRPM]              ,  
      [RPMTIme]             ,  
      [RPMOccurs]           ,  
                              
      [OutOfGreenBandTime]  ,  
  
      [ExcessiveIdleTime]   ,  
      [ExcessiveIdleOccurs] ,  
  
      [IdleTime]            ,  
      [IdleOccurs]          ,  
  
      [EngineSeconds]         ,  
  
      -- calculated fields  
      [NoGoZoneEntry]       ,  
      [Passengers]          ,  
  
      [FuelUsedMeasured]    ,  
      [FuelUsedCalculated]  ,  
      [FuelUsedHierarchy]   ,  
        
      [NightDuration]       ,
      [AfterHoursDuration]  ,
      [TotalCarbonEmission] ,
      [TotalCO2Emission]    ,
  
      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,
      [UpdateBatchKey]
    )  
    SELECT  
      [ActivityDetailKey]   ,  
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
  
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],  
      [MovementEndDateTime]  ,  
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]      ,
  
      [StartOdometer]       ,  
      [EndOdometer]         ,  
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,
      [AccelTime]           ,
      [AccelOccurs]         ,
  
      [MaxRPM]              ,
      [RPMTIme]             ,
      [RPMOccurs]           ,
  
      [OutOfGreenBandTime]  ,
  
      [ExcessiveIdleTime]   ,
      [ExcessiveIdleOccurs] ,
  
      [IdleTime]            ,
      [IdleOccurs]          ,
  
      [EngineSeconds]       ,
  
      -- calculated fields  
      [NoGoZoneEntry]       ,
      [Passengers]          ,
  
      [FuelUsedMeasured]    ,
      [FuelUsedCalculated]  ,
      [FuelUsedHierarchy]   ,
  
      [NightDuration]       ,
      [AfterHoursDuration]  ,
      [TotalCarbonEmission] ,
      [TotalCO2Emission]    ,

      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,
      [UpdateBatchKey]
    FROM  
     (UPDATE
        fad
      SET
        NextMovementStartDateTime     = nm.NextMovementStartDateTime,
        NextMovementActivityDetailKey = nm.NextMovementActivityDetailKey,
        UpdateBatchKey                = @batchKey
      OUTPUT  
        DELETED.[ActivityDetailKey]   ,  
        DELETED.[ActivitySummaryKey]  ,  
        DELETED.[OrganisationKey]     ,  
        DELETED.[HostID]              ,  
  
        DELETED.[VehicleSiteKey]      ,  
        DELETED.[ActivityStartDateKey],  
        DELETED.[ActivityEndDateKey]  ,  
        DELETED.[ActivityStartTime]   ,  
        DELETED.[ActivityEndTime]     ,  
        DELETED.[ActivityStartDateTime],  
        DELETED.[ActivityEndDateTime]  ,  
        DELETED.[MovementStartDateKey],  
        DELETED.[MovementEndDateKey]  ,  
        DELETED.[MovementStartTime]   ,  
        DELETED.[MovementEndTime]     ,  
        DELETED.[MovementStartDateTime],  
        DELETED.[MovementEndDateTime]  ,  
        DELETED.[NextMovementActivityDetailKey],
        DELETED.[NextMovementStartDateTime]    ,
        DELETED.[IsLastMovement]      ,
  
        DELETED.[StartOdometer]       ,  
        DELETED.[EndOdometer]         ,  
        DELETED.[StartEngineSeconds]  ,
        DELETED.[EndEngineSeconds]    ,

        DELETED.[StartGeoLocationKey] ,  
        DELETED.[EndGeoLocationKey]   ,  
        DELETED.[DistanceTravelled]   ,  
        DELETED.[Duration]            ,  
        DELETED.[DrivingTime]         ,  
        DELETED.[StandingTime]        ,  
  
        DELETED.[DriverKey]           ,  
        DELETED.[VehicleKey]          ,  
  
        DELETED.[MaxSpeed]            ,  
        DELETED.[SpeedTime]           ,  
        DELETED.[SpeedOccurs]         ,  
  
        DELETED.[MaxBrake]            ,  
        DELETED.[BrakeTime]           ,  
        DELETED.[BrakeOccurs]         ,  
  
        DELETED.[MaxAccel]            ,  
        DELETED.[AccelTime]           ,  
        DELETED.[AccelOccurs]         ,  
  
        DELETED.[MaxRPM]              ,  
        DELETED.[RPMTIme]             ,  
        DELETED.[RPMOccurs]           ,  
  
        DELETED.[OutOfGreenBandTime]  ,  
  
        DELETED.[ExcessiveIdleTime]   ,  
        DELETED.[ExcessiveIdleOccurs] ,  
  
        DELETED.[IdleTime]            ,  
        DELETED.[IdleOccurs]          ,  
  
        DELETED.[EngineSeconds]         ,  
  
        -- calculated fields  
        DELETED.[NoGoZoneEntry]       ,  
        DELETED.[Passengers]          ,  
  
        DELETED.[FuelUsedMeasured]    ,  
        DELETED.[FuelUsedCalculated]  ,  
        DELETED.[FuelUsedHierarchy]   ,  
          
        DELETED.[NightDuration]       ,  
        DELETED.[AfterHoursDuration]  ,  
        DELETED.[TotalCarbonEmission] ,  
        DELETED.[TotalCO2Emission]    ,

        DELETED.[RoadSpeedTime]       ,
        DELETED.[RoadSpeedOccurs]     ,
        
        DELETED.[UTCOffsetKey]        , 
        DELETED.[IsDeleted]           , 
        DELETED.[CreateBatchKey]      ,  
        DELETED.[UpdateBatchKey]
      FROM
        #recordsForNextMovementCalc        nm
          INNER JOIN
        [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK) ON fad.ActivityDetailKey = nm.ActivityDetailKey
      ) AS upd
    WHERE
      UpdateBatchKey <> @batchKey;
                                     
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='7.1 Update Overall - NextMovementStartDateTime/NextMovementActivityDetailKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
    RETURN -1;  
  END CATCH;  
  
  --------------------------------------------------------------------  
  -- 8. Cleanup work tables  
  --------------------------------------------------------------------  
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging  
  -- Have to keep STG table is it gets reused in FACT_SimpleScoreDetails  
  --    TRUNCATE TABLE [StageUser].[STAGE_FACT_ActivityDetails];  
  
  IF @debugMode = 1  -- DebugMode is true  
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 8. Cleanup work tables';  
  
  --------------------------------------------------------------------  
  -- 9. Return values for Performance Monitoring  
  --------------------------------------------------------------------  
  SELECT RecordsInserted = isnull(@recordsInserted,0),  
         RecordsUpdated  = isnull(@recordsUpdated ,0),  
         RecordsDeleted  = isnull(@recordsDeleted ,0);  
  
  IF @debugMode = 1  -- DebugMode is true  
  BEGIN  
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set  
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 9. Return values for Performance Monitoring';  
  END;  
  
  --------------------------------------------------------------------  
  RETURN 0;  
  
END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_ActivitySummary_Late_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_ActivitySummary on DW (from ActivityDetails table, late transform)
-- ==============================================================================
/*
  Dependencies:
  
  All DIMs
  FACT_ActivitySummary

*/
CREATE PROCEDURE [StageUser].[sprFACT_ActivitySummary_Late_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE @endDateDefault     date   = '20501231';
  DECLARE @maxDuration        bigint = 2147483647; -- this is the max int data type value
  DECLARE @maxSubTripDuration int    = 157680000;  -- currently set to 5 years
  DECLARE	@currentDate     datetimeoffset = SYSUTCDATETIME(); -- used for validation
  
  -- for TripClassification calc
  DECLARE @locationTaxTypeBusinessLookupKey int;
  DECLARE @locationTaxTypePrivateLookupKey  int;
  DECLARE @tripClassBusinessLookupKey       int;
  DECLARE @tripClassPrivateLookupKey        int;
  DECLARE @tripClassCommuteLookupKey        int;
  DECLARE @tripClassOtherLookupKey          int;

  -- for DutchTaxClassification calc
  DECLARE @dutchTaxEventID                  int;

  SELECT
    @dutchTaxEventID = DutchTaxEventID
  FROM
    [MiXData].dbo.DIM_Organisations WITH (NOLOCK)
  WHERE OrganisationKey = @organisationKey;

  SELECT
    @locationTaxTypeBusinessLookupKey = tcl1.LookupRID,
    @locationTaxTypePrivateLookupKey  = tcl2.LookupRID,
    @tripClassBusinessLookupKey       = tcl3.LookupRID,
    @tripClassPrivateLookupKey        = tcl4.LookupRID,
    @tripClassCommuteLookupKey        = tcl5.LookupRID,
    @tripClassOtherLookupKey          = tcl6.LookupRID
  FROM
    [MiXData].dbo.DIM_TableColumnLookups tcl1 WITH (NOLOCK)
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tcl2 WITH (NOLOCK)
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tcl3 WITH (NOLOCK)
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tcl4 WITH (NOLOCK)
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tcl5 WITH (NOLOCK)
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tcl6 WITH (NOLOCK)
  WHERE
      tcl1.LookupTable  = 'DIM_Shapes'
  AND tcl1.LookupColumn = 'ShapeTaxTypeLookupKey'
  AND tcl1.LookupKey    = 1                 -- Business Shape Tax Type
  AND tcl2.LookupTable  = 'DIM_Shapes'
  AND tcl2.LookupColumn = 'ShapeTaxTypeLookupKey'
  AND tcl2.LookupKey    = 2                 -- Private Shape Tax Type
  AND tcl3.LookupTable  = 'FACT_ActivitySummary'
  AND tcl3.LookupColumn = 'TripClassificationLookupKey'
  AND tcl3.LookupKey    = 1                 -- Business Trip Class
  AND tcl4.LookupTable  = 'FACT_ActivitySummary'
  AND tcl4.LookupColumn = 'TripClassificationLookupKey'
  AND tcl4.LookupKey    = 2                 -- Private Trip Class
  AND tcl5.LookupTable  = 'FACT_ActivitySummary'
  AND tcl5.LookupColumn = 'TripClassificationLookupKey'
  AND tcl5.LookupKey    = 3                 -- Commute Trip Class
  AND tcl6.LookupTable  = 'FACT_ActivitySummary'
  AND tcl6.LookupColumn = 'TripClassificationLookupKey'
  AND tcl6.LookupKey    = 4;                -- Other Trip Class
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------

  -- Have to keep STG table is it gets reused from initial Summary transform
  
  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY
  
    -- insert changed records into STG (this already done in first proc)


    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -------------------------------------------
    -- Summary Totals from Details
    --   + get the ID of the last SubTrip record for the summary record
    ;WITH ActivityDetails AS
    (
      SELECT
        dtl.TripID,
        [MaxDetailID]             = MAX(dtl.HostID)              ,
        [TotalDuration]           = SUM(CONVERT(BIGINT,dtl.[Duration])),
        [TotalDistanceTravelled]  = SUM(dtl.[DistanceTravelled]) ,
        [TotalDrivingTime]        = SUM(CONVERT(BIGINT,dtl.[DrivingTime])),
        [TotalEngineSeconds]      = SUM(CONVERT(BIGINT,dtl.[EngineSeconds])),
        [MaxSpeed]                = MAX(dtl.[MaxSpeed])          ,
        [MaxAccel]                = MAX(dtl.[MaxAccel])          ,
        [MaxBrake]                = MAX(dtl.[MaxBrake])          ,
        [MaxRPM]                  = MAX(dtl.[MaxRPM])            ,
        
        [TotalFuelUsedMeasured]   = SUM(dtl.[FuelUsedMeasured])  ,
        [TotalFuelUsedCalculated] = SUM(dtl.[FuelUsedCalculated]),
        
        [TotalIdleTime]           = SUM(CONVERT(BIGINT,dtl.[IdleTime]))    ,
        [TotalPassengers]         = SUM(dtl.[Passengers])        ,
        [TotalStandingTime]       = SUM(CONVERT(BIGINT,dtl.[StandingTime])),
        [TotalNightDuration]      = SUM(CONVERT(BIGINT,dtl.[NightDuration]))     ,
        [TotalAfterHoursDuration] = SUM(CONVERT(BIGINT,dtl.[AfterHoursDuration])),
        [TotalCarbonEmission]     = SUM(dtl.[TotalCarbonEmission]),
        [TotalCO2Emission]        = SUM(dtl.[TotalCO2Emission]),
        [MovementCount]           = SUM(CASE WHEN dtl.HostID > 0 THEN 1 ELSE 0 END)  -- dont count activities where the vehicle was stationary
      FROM
        [StageUser].[STAGE_FACT_ActivityDetails] dtl
      GROUP BY
        dtl.TripID
    )
    UPDATE
      [StageUser].[STAGE_FACT_ActivitySummary]
    SET
      [MaxDetailID]             = slc.[MaxDetailID]            ,
      [TotalDuration]           = CASE WHEN ABS(slc.[TotalDuration]          ) > @maxDuration THEN -2 ELSE slc.[TotalDuration]           END,
      [TotalDistanceTravelled]  = slc.[TotalDistanceTravelled] ,
      [TotalDrivingTime]        = CASE WHEN ABS(slc.[TotalDrivingTime]       ) > @maxDuration THEN -2 ELSE slc.[TotalDrivingTime]        END,
      [TotalEngineSeconds]      = CASE WHEN ABS(slc.[TotalEngineSeconds]     ) > @maxDuration THEN -2 ELSE slc.[TotalEngineSeconds]      END,
      [MaxSpeed]                = slc.[MaxSpeed]               ,
      [MaxAccel]                = slc.[MaxAccel]               ,
      [MaxBrake]                = slc.[MaxBrake]               ,
      [MaxRPM]                  = slc.[MaxRPM]                 ,
      [TotalFuelUsedMeasured]   = slc.[TotalFuelUsedMeasured]  ,
      [TotalFuelUsedCalculated] = slc.[TotalFuelUsedCalculated],
      [TotalPassengers]         = slc.[TotalPassengers]        ,
      [TotalIdleTime]           = CASE WHEN ABS(slc.[TotalIdleTime]          ) > @maxDuration THEN -2 ELSE slc.[TotalIdleTime]           END,
      [TotalStandingTime]       = CASE WHEN ABS(slc.[TotalStandingTime]      ) > @maxDuration THEN -2 ELSE slc.[TotalStandingTime]       END,
      [TotalNightDuration]      = CASE WHEN ABS(slc.[TotalNightDuration]     ) > @maxDuration THEN -2 ELSE slc.[TotalNightDuration]      END,
      [TotalAfterHoursDuration] = CASE WHEN ABS(slc.[TotalAfterHoursDuration]) > @maxDuration THEN -2 ELSE slc.[TotalAfterHoursDuration] END,
      [TotalCarbonEmission]     = slc.[TotalCarbonEmission],
      [TotalCO2Emission]        = slc.[TotalCO2Emission],
      [MovementCount]           = slc.[MovementCount]
    FROM
      [StageUser].[STAGE_FACT_ActivitySummary] stg
        INNER JOIN
      ActivityDetails                          slc ON slc.TripID = stg.HostID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update ActivityDetails rollup', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    -------------------------------------------
    -- First SubTripData
    UPDATE
      [StageUser].[STAGE_FACT_ActivitySummary]
    SET
      [StartOdometer]       = dtl.[StartOdometer]      ,
      [StartEngineSeconds]  = dtl.[StartEngineSeconds] ,
      [StartGeoLocationKey] = ISNULL(dtl.[StartGeoLocationKey],-1)
    FROM
      [StageUser].[STAGE_FACT_ActivitySummary] stg
        INNER JOIN
      [StageUser].[STAGE_FACT_ActivityDetails] dtl ON stg.HostID = dtl.TripID
    WHERE
      dtl.HostID IN (0,1)  -- First Detail(SubTrip) record

    -------------------------------------------
    -- Last SubTripData
    UPDATE
      [StageUser].[STAGE_FACT_ActivitySummary]
    SET
      [EndOdometer]       = dtl.[EndOdometer]      ,
      [EndEngineSeconds]  = dtl.[EndEngineSeconds] ,
      [EndGeoLocationKey] = ISNULL(dtl.[EndGeoLocationKey],-1)
    FROM
      [StageUser].[STAGE_FACT_ActivitySummary] stg
        INNER JOIN
      [StageUser].[STAGE_FACT_ActivityDetails] dtl ON stg.HostID = dtl.TripID
    WHERE
      dtl.HostID = stg.MaxDetailID  -- Last Detail(SubTrip) record

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3 Update Start/End values', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    -------------------------------------------
    -- AverageSimpleDriverScore
    -- removed

    ------------------------------------------
    -- NextTripStartDateTime

    CREATE INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_HostID 
      ON [StageUser].[STAGE_FACT_ActivitySummary](VehicleID,ActivityStartDateTime,HostID);
    
    ;WITH
    NextTrip (VehicleID,ActivityStartDateTime,HostID,SequenceNo) AS
    (
      SELECT
        VehicleID,
        ActivityStartDateTime,
        HostID,
        RANK() OVER (PARTITION BY VehicleID ORDER BY ActivityStartDateTime,HostID) AS 'SequenceNo'
      FROM
        [StageUser].[STAGE_FACT_ActivitySummary]
    ),
    NextTripStart (HostID,NextTripStartDateTime) AS
    (
      SELECT
        nt1.HostID,
        nt2.ActivityStartDateTime AS NextTripStartDateTime
      FROM
        NextTrip nt1
          INNER JOIN
        NextTrip nt2 ON nt1.VehicleID = nt2.VehicleID AND nt1.SequenceNo + 1 = nt2.SequenceNo
    )
    UPDATE
      [StageUser].[STAGE_FACT_ActivitySummary]
    SET
      NextTripStartDateTime = n.NextTripStartDateTime
    FROM
      [StageUser].[STAGE_FACT_ActivitySummary] stg
        INNER JOIN
      NextTripStart                            n   ON stg.HostID = n.HostID;

    CREATE INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_NextTripStartDateTime
      ON [StageUser].[STAGE_FACT_ActivitySummary](VehicleID,ActivityStartDateTime,NextTripStartDateTime);

    UPDATE
      [StageUser].[STAGE_FACT_ActivitySummary]
    SET
      NextTripStartDateTime = ActivityEndDateTime
    WHERE NextTripStartDateTime IS NULL;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.5 Update AverageSimpleDriverScore', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    ------------------------------------------
    -- TripClassificationLookupKey
    --   Default of Other TripClass

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_ActivityEndDateTime
      ON [StageUser].[STAGE_FACT_ActivitySummary](VehicleID,ActivityStartDateTime,ActivityEndDateTime);

    -- Hierachy 1 - User/AutoClass table TaxTripClassification
    UPDATE
      [StageUser].[STAGE_FACT_ActivitySummary]
    SET
      TripClassificationLookupKey = CASE
                                      WHEN ttc.sTripClassification = 'resBusinessTrip'
                                        THEN @tripClassBusinessLookupKey
                                      WHEN ttc.sTripClassification = 'resPrivateTrip'
                                        THEN @tripClassPrivateLookupKey
                                      ELSE @tripClassOtherLookupKey
                                    END,
      TripClassificationHierarchy = 1
    FROM
      [StageUser].[STAGE_FACT_ActivitySummary] stg
        INNER JOIN
      [StageUser].TaxTripClassification        ttc ON stg.HostID = ttc.liTripID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.6.1 Update calculated cols - TripClassificationLookupKey - H1', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    -- Hierarchy 2
    --   basically the same as logic used to calculate auto tax in table TaxTripClassification
    --   IF either start or end of trip in business shape tax type then  Business Trip Class
    ;WITH BusinessTripClass (HostID) AS
    (
      SELECT 
        stg1.HostID
      FROM
        [StageUser].[STAGE_FACT_ActivitySummary]  stg1
          INNER JOIN
        [MiXData].dbo.DIM_GeoLocationsToShapes dgs WITH (NOLOCK) ON stg1.StartGeoLocationKey = dgs.GeoLocationKey
          INNER JOIN
        [MiXData].dbo.DIM_Shapes               dsp WITH (NOLOCK) ON dgs.ShapeKey             = dsp.ShapeKey
      WHERE
          stg1.TripClassificationHierarchy = -1
      AND dsp.OrganisationKey       = @organisationKey
      AND dsp.ShapeTaxTypeLookupKey = @locationTaxTypeBusinessLookupKey
      UNION
      SELECT 
        stg2.HostID
      FROM
        [StageUser].[STAGE_FACT_ActivitySummary]  stg2
          INNER JOIN
        [MiXData].dbo.DIM_GeoLocationsToShapes dgs WITH (NOLOCK) ON stg2.EndGeoLocationKey   = dgs.GeoLocationKey
          INNER JOIN
        [MiXData].dbo.DIM_Shapes               dsp WITH (NOLOCK) ON dgs.ShapeKey             = dsp.ShapeKey
      WHERE
          stg2.TripClassificationHierarchy = -1
      AND dsp.OrganisationKey       = @organisationKey
      AND dsp.ShapeTaxTypeLookupKey = @locationTaxTypeBusinessLookupKey
    )
    UPDATE
      [StageUser].[STAGE_FACT_ActivitySummary]
    SET
      TripClassificationLookupKey = @tripClassBusinessLookupKey,
      TripClassificationHierarchy = 2
    FROM
      [StageUser].[STAGE_FACT_ActivitySummary]  stg
        INNER JOIN
      BusinessTripClass                         btc WITH (NOLOCK) ON stg.HostID = btc.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.6.2 Update calculated cols - TripClassificationLookupKey - H2', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    -- Hierarchy 3 - TerminalData
    -- if more than 1 record per trip then use in decending order Business,Private,Commute,Other
    ;WITH TerminalData (HostID,TripTaxClass) AS
    (
      SELECT
        stg.HostID,
        TripTaxClass = CASE
                         WHEN ftd.MenuID IN ('BUSDR', 'JOBDR')
                           THEN 1     -- Business
                         WHEN ftd.MenuID = 'WTHDR'
                           THEN 2     -- Commute
                         WHEN ftd.MenuID = 'PVTDR'
                           THEN 3     -- Private
                         ELSE 
                           4          -- Other
                       END
      FROM
        [MiXData].dbo.FACT_TerminalDetails    ftd WITH (NOLOCK)
          INNER JOIN
        [MiXData].dbo.DIM_Vehicles            dvh WITH (NOLOCK) ON ftd.VehicleKey = dvh.VehicleKey
          INNER JOIN
        [StageUser].[STAGE_FACT_ActivitySummary] stg               ON dvh.HostID     = stg.VehicleID
      WHERE
          stg.TripClassificationHierarchy = -1
      AND dvh.OrganisationKey  = @organisationKey
      AND ftd.MenuID           IN ('ACCDR', 'BUSDR', 'HTWDR', 'JOBDR', 'MNTDR', 'OTHDR', 'PVTDR', 'UNSDR', 'WTHDR')
      AND ftd.TerminalDateTime BETWEEN stg.ActivityStartDateTime AND stg.ActivityEndDateTime
    ),
    TripTaxClassification (HostID,TripTaxClass) AS
    (
      SELECT
        HostID,
        MIN(TripTaxClass)
      FROM
        TerminalData
      GROUP BY
        HostID
    )
    UPDATE
      [StageUser].[STAGE_FACT_ActivitySummary]
    SET
      TripClassificationLookupKey = CASE
                                      WHEN ttc.TripTaxClass = 1
                                        THEN @tripClassBusinessLookupKey
                                      WHEN ttc.TripTaxClass = 2
                                        THEN @tripClassCommuteLookupKey
                                      WHEN ttc.TripTaxClass = 3
                                        THEN @tripClassPrivateLookupKey
                                      ELSE
                                        @tripClassOtherLookupKey
                                    END,
      TripClassificationHierarchy = 3
    FROM
      [StageUser].[STAGE_FACT_ActivitySummary]  stg
        INNER JOIN
      TripTaxClassification                     ttc ON stg.HostID = ttc.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.6.3 Update calculated cols - TripClassificationLookupKey - H3', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    -- Hierarchy 4 - EventData (EventID = 41)
    -- if more than 1 record per trip then use in decending order Business,Private,Commute,Other
    ;WITH TripClassEventData (HostID,TripTaxClass) AS
    (
      SELECT
        stg.HostID,
        MIN(fed.EventValue)
      FROM
        [MiXData].dbo.FACT_EventDetails       fed WITH (NOLOCK)
          INNER JOIN
        [MiXData].dbo.DIM_EventDescriptions   ded WITH (NOLOCK) ON fed.EventDescriptionKey = ded.EventDescriptionKey
          INNER JOIN
        [MiXData].dbo.DIM_Vehicles            dvh WITH (NOLOCK) ON fed.VehicleKey          = dvh.VehicleKey
          INNER JOIN
        [StageUser].[STAGE_FACT_ActivitySummary] stg               ON dvh.HostID              = stg.VehicleID
      WHERE
          stg.TripClassificationHierarchy = -1
      AND dvh.OrganisationKey    = @organisationKey
      AND ded.OrganisationKey    = @organisationKey
      AND ded.HostID             = 41
      AND fed.EventStartDateTime BETWEEN stg.ActivityStartDateTime AND stg.NextTripStartDateTime
      GROUP BY
        stg.HostID
    )
    UPDATE
      [StageUser].[STAGE_FACT_ActivitySummary]
    SET
      TripClassificationLookupKey = CASE
                                      WHEN ttc.TripTaxClass = 1
                                        THEN @tripClassBusinessLookupKey
                                      WHEN ttc.TripTaxClass = 2
                                        THEN @tripClassPrivateLookupKey
                                      WHEN ttc.TripTaxClass = 3
                                        THEN @tripClassCommuteLookupKey
                                      ELSE
                                        @tripClassOtherLookupKey
                                    END,
      TripClassificationHierarchy = 4
    FROM
      [StageUser].[STAGE_FACT_ActivitySummary]  stg
        INNER JOIN
      TripClassEventData                        ttc ON stg.HostID = ttc.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.6.4 Update calculated cols - TripClassificationLookupKey - H4', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- IsDutchTaxTripClassification
    --   where EventID = DutchTaxEventID (FMOnlineDB.tbDutchTaxOptions) and EventValue > 6
    ;WITH EventData (EventDetailKey,EventStartDateTime,EventValue,VehicleID) AS
    (
      SELECT
        DISTINCT
        fed.EventDetailKey,
        fed.EventStartDateTime,
        fed.EventValue,
        stg.VehicleID
      FROM
        [MiXData].dbo.FACT_EventDetails       fed WITH (NOLOCK)
          INNER JOIN
        [MiXData].dbo.DIM_EventDescriptions   ded WITH (NOLOCK) ON fed.EventDescriptionKey = ded.EventDescriptionKey
          INNER JOIN
        [MiXData].dbo.DIM_Vehicles            dvh WITH (NOLOCK) ON fed.VehicleKey          = dvh.VehicleKey
          INNER JOIN
        [StageUser].[STAGE_FACT_ActivitySummary] stg               ON dvh.HostID              = stg.VehicleID
      WHERE
          dvh.OrganisationKey  = @organisationKey
      AND ded.OrganisationKey  = @organisationKey
      AND ded.HostID           = @dutchTaxEventID
      AND fed.EventValue       > 6                   -- DutchTax
--      AND fed.EventStartDateTime >= stg.ActivityEndDateTime
      AND fed.EventStartDateTime BETWEEN stg.ActivityStartDateTime AND stg.NextTripStartDateTime
    ),
    DutchTaxEventData (HostID,VehicleID,EventStartDateTime) AS
    (
      SELECT
        stg.HostID,
        e.VehicleID,
        MIN(e.EventStartDateTime)
      FROM
        EventData e
          INNER JOIN
        [StageUser].[STAGE_FACT_ActivitySummary] stg ON e.VehicleID = stg.VehicleID
      WHERE
        e.EventStartDateTime > stg.ActivityEndDateTime
      GROUP BY
        stg.HostID,
        e.VehicleID
    )
    UPDATE
      [StageUser].[STAGE_FACT_ActivitySummary]
    SET
      IsDutchTaxTripClassification = 1
    FROM
      [StageUser].[STAGE_FACT_ActivitySummary]  stg
        INNER JOIN
      DutchTaxEventData                         dte ON stg.HostID = dte.HostID
        INNER JOIN
      EventData                                 ed  ON dte.VehicleID          = ed.VehicleID
                                                   AND dte.EventStartDateTime = ed.EventStartDateTime;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.7 Update calculated cols - IsDutchTaxTripClassification', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF EXISTS (SELECT 1
               FROM
                 [StageUser].[STAGE_FACT_ActivitySummary]
               WHERE
                 ActivityStartDateKey > DATEADD(DAY,1,@currentDate))
    BEGIN
      RAISERROR(N'Some Units internal clock seem to be out of sync',16,1);
    END
 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    UPDATE
      [MiXData].dbo.FACT_ActivitySummary
    SET 
      [StartOdometer]            = stg.[StartOdometer]           ,
      [EndOdometer]              = stg.[EndOdometer]             ,
      [StartEngineSeconds]       = stg.[StartEngineSeconds]      ,
      [EndEngineSeconds]         = stg.[EndEngineSeconds]        ,
      [StartGeoLocationKey]      = stg.[StartGeoLocationKey]     ,
      [EndGeoLocationKey]        = stg.[EndGeoLocationKey]       ,
      [AverageSimpleDriverScore] = stg.[AverageSimpleDriverScore],
      [TotalDuration]            = stg.[TotalDuration]           ,
      [TotalDistanceTravelled]   = stg.[TotalDistanceTravelled]  ,
      [TotalDrivingTime]         = stg.[TotalDrivingTime]        ,
      [TotalEngineSeconds]       = stg.[TotalEngineSeconds]      ,
      [MaxSpeed]                 = stg.[MaxSpeed]                ,
      [MaxAccel]                 = stg.[MaxAccel]                ,
      [MaxBrake]                 = stg.[MaxBrake]                ,
      [MaxRPM]                   = stg.[MaxRPM]                  ,
      
      [TotalFuelUsedMeasured]    = stg.[TotalFuelUsedMeasured]   ,
      [TotalFuelUsedCalculated]  = stg.[TotalFuelUsedCalculated] ,
      
      [TotalIdleTime]            = stg.[TotalIdleTime]           ,
      [TotalPassengers]          = stg.[TotalPassengers]         ,
      [TotalStandingTime]        = stg.[TotalStandingTime]       ,
      [TotalNightDuration]       = stg.[TotalNightDuration]      ,
      [TotalAfterHoursDuration]  = stg.[TotalAfterHoursDuration] ,
      [TotalCarbonEmission]      = stg.[TotalCarbonEmission]     ,
      [TotalCO2Emission]         = stg.[TotalCO2Emission]        ,
      [MovementCount]            = stg.[MovementCount]           ,

      [TripClassificationLookupKey]  = CASE
                                         WHEN tar.[TripClassificationHierarchy] = 1 AND stg.[TripClassificationHierarchy] <> 1
                                           THEN tar.[TripClassificationLookupKey]
                                         ELSE
                                           ISNULL(stg.[TripClassificationLookupKey],@tripClassOtherLookupKey)
                                       END,
      [TripClassificationHierarchy]  = CASE
                                         WHEN tar.[TripClassificationHierarchy] = 1 AND stg.[TripClassificationHierarchy] <> 1
                                           THEN tar.[TripClassificationHierarchy]
                                         ELSE
                                           stg.[TripClassificationHierarchy]
                                       END,
      [IsDutchTaxTripClassification] = ISNULL(stg.[IsDutchTaxTripClassification],0),
      [UpdateBatchKey]               = @batchKey
    FROM
      [MiXData].dbo.FACT_ActivitySummary    tar
        INNER JOIN
      [StageUser].[STAGE_FACT_ActivitySummary] stg ON tar.[OrganisationKey] = @organisationKey
                                                  AND tar.[HostID]          = stg.[HostID];

    -- record nr of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Rollup Values', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_ActivitySummary];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = 0,
         RecordsUpdated  = @recordsUpdated,
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 8. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_ActivitySummary_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_ActivitySummary on DW (details of organisations, late transform)
-- ==============================================================================
/*
  Dependencies:
  
  DIM_Drivers
  DIM_Vehicles
  DIM_Sites

  STAGE_DIM_UTCOffsetsLookup

  TripData

*/
CREATE PROCEDURE [StageUser].[sprFACT_ActivitySummary_Transform]
(
	@batchKey        int,
	@organisationKey int,
	@debugMode       int = 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;

  DECLARE @unknownDateDefault     date     = '00010101';
  DECLARE @unknownDateTimeDefault datetime = '19000101';
  DECLARE @endDateDefault         date     = '20501231';
  DECLARE	@currentDate            datetimeoffset = SYSUTCDATETIME(); -- used for validation

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_FACT_ActivityChanges];
  TRUNCATE TABLE [StageUser].[STAGE_FACT_ActivitySummary];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_ActivitySummary];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_HostID_Operation ON [StageUser].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_ActivityStartDateKey')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_ActivityStartDateKey ON [StageUser].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_DriverID_ActivityStartDateKey')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_DriverID_ActivityStartDateKey ON [StageUser].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateKey')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateKey ON [StageUser].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_ActivityEndDateTime')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_ActivityEndDateTime ON [StageUser].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_HostID')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_HostID ON [StageUser].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_NextTripStartDateTime')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_NextTripStartDateTime ON [StageUser].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivityChanges]') AND name = N'PK_STAGE_FACT_ActivityChanges')
      DROP INDEX PK_STAGE_FACT_ActivityChanges ON [StageUser].[STAGE_FACT_ActivityChanges];


    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_ActivitySummary]') AND name = N'IX_ROLLBACK_FACT_ActivitySummary_HostID')
      DROP INDEX IX_ROLLBACK_FACT_ActivitySummary_HostID ON [StageUser].[ROLLBACK_FACT_ActivitySummary];

    -- insert changed records into STG
	  INSERT INTO [StageUser].[STAGE_FACT_ActivitySummary]
	  (
	    [Operation]            ,
	    [VehicleID]            ,
      [DriverID]             ,
      [OriginalDriverID]     ,
      [HostID]               ,
      [UnitTripNumber]       ,
      [ActivityStartDateKey] ,
      [ActivityEndDateKey]   ,
      [ActivityStartTime]    ,
      [ActivityEndTime]      ,
      [ActivityStartDateTime],
      [ActivityEndDateTime]  ,
      [UTCOffsetKey]         ,
      [TripClassificationHierarchy]
	  )
	  SELECT
	    s.[Operation]                                      ,
	    [VehicleID]             = s.VehicleID              ,
      [DriverID]              = s.DriverID               ,
      [OriginalDriverID]      = s.OriginalDriverID       ,
      [HostID]                = s.TripID                 ,
      [UnitTripNumber]        = s.TripNumber             ,
      [ActivityStartDateKey]  = CONVERT(DATE,s.TripStart),
      [ActivityEndDateKey]    = CONVERT(DATE,s.TripEnd)  ,
      [ActivityStartTime]     = CONVERT(TIME,s.TripStart),
      [ActivityEndTime]       = CONVERT(TIME,s.TripEnd)  ,
      CASE 
        WHEN s.TripStart IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.TripStart,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      CASE 
        WHEN s.TripEnd IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.TripEnd,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      utc.UTCOffsetKey,
      [TripClassificationHierarchy] = -1
	  FROM
	    [StageUser].TripData s WITH (NOLOCK)
        CROSS JOIN
      [StageUser].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
    WHERE
        ISNULL(CONVERT(DATETIMEOFFSET(0),s.TripStart),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime  
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.TripStart),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2. Add to STG';
    END;

    -- get list of all TripIDs with changes in both Trip/SubTripData (Summary as well as Detail records, need update both sets where necessarry)
    INSERT INTO [StageUser].[STAGE_FACT_ActivityChanges]
    ( 
      TripID,
      IsInTripSource,
      IsInSubTripSource,
      IsInTaxClassification,
      IsMoreThanScoreChangeOnly
    )
    SELECT TripID,0,0,0,0
    FROM [StageUser].TripData
    UNION
    SELECT TripID,0,0,0,0
    FROM [StageUser].SubTripData std
    UNION
    SELECT liTripID,0,0,0,0
    FROM [StageUser].TaxTripClassification;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;

    CREATE CLUSTERED INDEX PK_STAGE_FACT_ActivityChanges
      ON [StageUser].[STAGE_FACT_ActivityChanges](TripID);

    --------------------------------
    -- IsInTripSource
    UPDATE [StageUser].[STAGE_FACT_ActivityChanges]
    SET IsInTripSource = 1
    FROM 
      [StageUser].[STAGE_FACT_ActivityChanges] c
        INNER JOIN
      [StageUser].TripData                     t ON c.TripID = t.TripID;

    --------------------------------
    -- IsInSubTripSource
    UPDATE [StageUser].[STAGE_FACT_ActivityChanges]
    SET IsInSubTripSource = 1
    FROM 
      [StageUser].[STAGE_FACT_ActivityChanges] c
        INNER JOIN
      [StageUser].SubTripData                  t ON c.TripID = t.TripID;

    --------------------------------
    -- IsInTaxClassification
    UPDATE [StageUser].[STAGE_FACT_ActivityChanges]
    SET IsInTaxClassification = 1
    FROM 
      [StageUser].[STAGE_FACT_ActivityChanges] c
        INNER JOIN
      [StageUser].TaxTripClassification        t ON c.TripID = t.liTripID;

    --------------------------------
    -- IsMoreThanScoreChangeOnly (includes new records as well)
    
    -- get existing data from Warehouse
    SELECT
      TripID            = fas.HostID,
      Sequence          = fad.HostID,
      Depart            = CONVERT(DATETIME,NULLIF(fad.MovementStartDateTime,@unknownDateDefault)),
      Halt              = CONVERT(DATETIME,NULLIF(fad.MovementEndDateTime  ,@unknownDateDefault)),
      fad.StandingTime      ,
      TripDistance      = fad.DistanceTravelled,
      Odometer          = fad.EndOdometer,
      fad.MaxSpeed          ,
      fad.SpeedTime         ,
      fad.SpeedOccurs       ,
      fad.MaxBrake          ,
      fad.BrakeTime         ,
      fad.BrakeOccurs       ,
      fad.MaxAccel          ,
      fad.AccelTime         ,
      fad.AccelOccurs       ,
      fad.MaxRPM            ,
      fad.RPMTime           ,
      fad.RPMOccurs         ,
      GBTime            = fad.OutOfGreenBandTime,
      ExIdleTime        = fad.ExcessiveIdleTime,
      ExIdleOccurs      = fad.ExcessiveIdleOccurs,
      NIdleTime         = fad.IdleTime,
      NIdleOccurs       = fad.IdleOccurs,
      Litres            = fad.FuelUsedMeasured,
      fad.PulseValue        ,
      fad.StartEngineSeconds,
      fad.EndEngineSeconds,
      fad.StartGeoLocationKey,
      fad.EndGeoLocationKey
    INTO #ExistingSubTripData
    FROM
      [StageUser].SubTripData           std WITH (NOLOCK)
        INNER JOIN
      [MiXData].dbo.FACT_ActivitySummary fas WITH (NOLOCK) ON fas.OrganisationKey    = @organisationKey
                                                          AND fas.HostID             = std.TripID
        INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK) ON fad.ActivitySummaryKey = fas.ActivitySummaryKey
                                                          AND fad.HostID             = std.Sequence;
    
    -- add columns to compare GPSData
    ALTER TABLE #ExistingSubTripData
    ADD
    StartLatitude  real NULL,
    StartLongitude real NULL,
    EndLatitude    real NULL,
    EndLongitude   real NULL;

    CREATE INDEX IX_ExistingSubTripData_StartGeoLocationKey ON #ExistingSubTripData(StartGeoLocationKey);
    CREATE INDEX IX_ExistingSubTripData_EndGeoLocationKey   ON #ExistingSubTripData(EndGeoLocationKey);

    -- add GPSData
    UPDATE
      e
    SET
      StartLatitude  = dgl.Latitude,
      StartLongitude = dgl.Longitude
    FROM
      #ExistingSubTripData e
        INNER JOIN
      [MiXData].dbo.DIM_GeoLocations dgl WITH (NOLOCK) ON dgl.GeoLocationKey = e.StartGeoLocationKey;

    UPDATE
      e
    SET
      EndLatitude  = dgl.Latitude,
      EndLongitude = dgl.Longitude
    FROM
      #ExistingSubTripData e
        INNER JOIN
      [MiXData].dbo.DIM_GeoLocations dgl WITH (NOLOCK) ON dgl.GeoLocationKey = e.EndGeoLocationKey;

    DROP INDEX IX_ExistingSubTripData_StartGeoLocationKey ON #ExistingSubTripData;
    DROP INDEX IX_ExistingSubTripData_EndGeoLocationKey   ON #ExistingSubTripData;

    CREATE CLUSTERED INDEX IX_ExistingSubTripData_Compare
      ON #ExistingSubTripData(TripID,Sequence);
    
    -- compare new SubTripData to existing Warehouse SubTripData to identify other than score changes
    UPDATE
      c
    SET
      IsMoreThanScoreChangeOnly = 1
    FROM
      [StageUser].[STAGE_FACT_ActivityChanges]  c
        INNER JOIN
      #ExistingSubTripData     e                 ON e.TripID       = c.TripID
        INNER JOIN
      [StageUser].SubTripData std WITH (NOLOCK) ON std.TripID     = e.TripID
                                                AND std.Sequence   = e.Sequence
        LEFT JOIN
      [StageUser].GPSData     gps WITH (NOLOCK) ON std.StartGPSID = gps.liGPSID
        LEFT JOIN
      [StageUser].GPSData     gpe WITH (NOLOCK) ON std.EndGPSID   = gpe.liGPSID
    WHERE
       ISNULL(std.Depart,@unknownDateTimeDefault) <> ISNULL(e.Depart,@unknownDateTimeDefault)
    OR ISNULL(std.Halt  ,@unknownDateTimeDefault) <> ISNULL(e.Halt  ,@unknownDateTimeDefault)
    OR ISNULL(std.StandingTime      ,0.0)         <> ISNULL(e.StandingTime      ,0.0)
    OR ISNULL(std.TripDistance      ,0.0)         <> ISNULL(e.TripDistance      ,0.0)
    OR ISNULL(std.Odometer          ,0.0)         <> ISNULL(e.Odometer          ,0.0)
    OR ISNULL(std.MaxSpeed          ,0.0)         <> ISNULL(e.MaxSpeed          ,0.0)
    OR ISNULL(std.SpeedTime         ,0.0)         <> ISNULL(e.SpeedTime         ,0.0)
    OR ISNULL(std.SpeedOccurs       ,0.0)         <> ISNULL(e.SpeedOccurs       ,0.0)
    OR ISNULL(std.MaxBrake          ,0.0)         <> ISNULL(e.MaxBrake          ,0.0)
    OR ISNULL(std.BrakeTime         ,0.0)         <> ISNULL(e.BrakeTime         ,0.0)
    OR ISNULL(std.BrakeOccurs       ,0.0)         <> ISNULL(e.BrakeOccurs       ,0.0)
    OR ISNULL(std.MaxAccel          ,0.0)         <> ISNULL(e.MaxAccel          ,0.0)
    OR ISNULL(std.AccelTime         ,0.0)         <> ISNULL(e.AccelTime         ,0.0)
    OR ISNULL(std.AccelOccurs       ,0.0)         <> ISNULL(e.AccelOccurs       ,0.0)
    OR ISNULL(std.MaxRPM            ,0.0)         <> ISNULL(e.MaxRPM            ,0.0)
    OR ISNULL(std.RPMTime           ,0.0)         <> ISNULL(e.RPMTime           ,0.0)
    OR ISNULL(std.RPMOccurs         ,0.0)         <> ISNULL(e.RPMOccurs         ,0.0)
    OR ISNULL(std.GBTime            ,0.0)         <> ISNULL(e.GBTime            ,0.0)
    OR ISNULL(std.ExIdleTime        ,0.0)         <> ISNULL(e.ExIdleTime        ,0.0)
    OR ISNULL(std.ExIdleOccurs      ,0.0)         <> ISNULL(e.ExIdleOccurs      ,0.0)
    OR ISNULL(std.NIdleTime         ,0.0)         <> ISNULL(e.NIdleTime         ,0.0)
    OR ISNULL(std.NIdleOccurs       ,0.0)         <> ISNULL(e.NIdleOccurs       ,0.0)
    OR ISNULL(std.Litres            ,0.0)         <> ISNULL(e.Litres            ,0.0)
    OR ISNULL(std.PulseValue        ,0.0)         <> ISNULL(e.PulseValue        ,0.0)
    OR ISNULL(std.StartEngineSeconds,0.0)         <> ISNULL(e.StartEngineSeconds,0.0)
    OR ISNULL(std.EndEngineSeconds  ,0.0)         <> ISNULL(e.EndEngineSeconds  ,0.0)
    OR ISNULL(gps.fLatitude         ,0.0)         <> ISNULL(e.StartLatitude     ,0.0)
    OR ISNULL(gps.fLongitude        ,0.0)         <> ISNULL(e.StartLongitude    ,0.0)
    OR ISNULL(gpe.fLatitude         ,0.0)         <> ISNULL(e.EndLatitude       ,0.0)
    OR ISNULL(gpe.fLongitude        ,0.0)         <> ISNULL(e.EndLongitude      ,0.0);

    UPDATE
      c
    SET
      IsMoreThanScoreChangeOnly = 1
    FROM
      [StageUser].[STAGE_FACT_ActivityChanges] c
        INNER JOIN
      [StageUser].SubTripData                  std WITH (NOLOCK) ON std.TripID = c.TripID
    WHERE
      NOT EXISTS (SELECT 1 FROM #ExistingSubTripData e WITH (NOLOCK)
                  WHERE e.TripID   = std.TripID
                  AND   e.Sequence = std.Sequence);

    DROP TABLE #ExistingSubTripData;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.1 Indentify Activity Changes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.1 Indentify Activity Changes';
    END;

    -- insert changes in details subtrips (details) that is not contained in tripsource changes (summary)
	  INSERT INTO [StageUser].[STAGE_FACT_ActivitySummary]
	  (
	    [Operation]            ,
	    [VehicleID]            ,
      [DriverID]             ,
      [OriginalDriverID]     ,
      [HostID]               ,
      [UnitTripNumber]       ,
      [ActivityStartDateKey] ,
      [ActivityEndDateKey]   ,
      [ActivityStartTime]    ,
      [ActivityEndTime]      ,
      [ActivityStartDateTime],
      [ActivityEndDateTime]  ,
      [UTCOffsetKey]         ,
      [TripClassificationHierarchy]
	  )
	  SELECT
	    'U'                                 , -- update operation
	    [VehicleID]             = dvh.HostID,
      [DriverID]              = dd1.HostID,
      [OriginalDriverID]      = dd2.HostID,
      s.[HostID]               ,
      s.[UnitTripNumber]       ,
      s.[ActivityStartDateKey] ,
      s.[ActivityEndDateKey]   ,
      s.[ActivityStartTime]    ,
      s.[ActivityEndTime]      ,
      s.[ActivityStartDateTime],
      s.[ActivityEndDateTime]  ,
      s.[UTCOffsetKey]         ,
      [TripClassificationHierarchy] = -1
	  FROM
	    [StageUser].[STAGE_FACT_ActivityChanges] c
	      INNER JOIN
	    [MiXData].dbo.FACT_ActivitySummary    s   WITH (NOLOCK) ON s.OrganisationKey = @organisationKey
              	                                                AND s.HostID          = c.TripID
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles            dvh WITH (NOLOCK) ON dvh.VehicleKey    = s.VehicleKey
        INNER JOIN
      [MiXData].dbo.DIM_Drivers             dd1 WITH (NOLOCK) ON dd1.DriverKey     = s.DriverKey
        INNER JOIN
      [MiXData].dbo.DIM_Drivers             dd2 WITH (NOLOCK) ON dd2.DriverKey     = s.OriginalDriverKey

	  WHERE 
	       c.IsInTripSource            = 0
	  AND (c.IsMoreThanScoreChangeOnly = 1
	  OR   c.IsInTaxClassification     = 1);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.2 Insert NonExisting ActivityDetails records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.2 Insert NonExisting ActivityDetails records';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivitySummary_HostID_Operation 
      ON [StageUser].[STAGE_FACT_ActivitySummary](HostID,Operation);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivitySummary_ActivityStartDateKey
      ON [StageUser].[STAGE_FACT_ActivitySummary](ActivityStartDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivitySummary_DriverID_ActivityStartDateKey
      ON [StageUser].[STAGE_FACT_ActivitySummary](DriverID,ActivityStartDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateKey
      ON [StageUser].[STAGE_FACT_ActivitySummary](VehicleID,ActivityStartDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
    END;

    ------------------------------------------
    -- DriverKey/OriginalDriverSiteKey
    UPDATE
      [StageUser].[STAGE_FACT_ActivitySummary]
    SET
      [DriverKey]             = dd.[DriverKey],
      [OriginalDriverSiteKey] = ds.[SiteKey]
    FROM
      [StageUser].[STAGE_FACT_ActivitySummary] stg
          INNER JOIN
      [MiXData].dbo.DIM_Drivers             dd WITH (NOLOCK) ON  dd.OrganisationKey = @organisationKey
                                                                AND stg.DriverID       = dd.HostID
        LEFT JOIN
      [MiXData].dbo.DIM_Sites               ds WITH (NOLOCK) ON  dd.OrganisationKey = ds.OrganisationKey
                                                                AND dd.SiteGUID        = ds.SiteGUID
    WHERE
      ISNULL(stg.ActivityStartDateKey, @endDateDefault) BETWEEN dd.StartDateKey AND dd.EndDateKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update calculated cols - DriverKey/DriverSiteKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- OriginalDriverKey
    UPDATE
      [StageUser].[STAGE_FACT_ActivitySummary]
    SET
      [OriginalDriverKey]     = dd.[DriverKey]
    FROM
      [StageUser].[STAGE_FACT_ActivitySummary] stg
        INNER JOIN
      [MiXData].dbo.DIM_Drivers             dd WITH (NOLOCK) ON dd.OrganisationKey   = @organisationKey
                                                               AND stg.OriginalDriverID = dd.HostID
    WHERE
      ISNULL(stg.ActivityStartDateKey,@endDateDefault) BETWEEN dd.StartDateKey AND dd.EndDateKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update calculated cols - OriginalDriverKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- VehicleKey/OriginalVehicleSiteKey
    UPDATE [StageUser].[STAGE_FACT_ActivitySummary]
    SET
      [VehicleKey]             = dvh.[VehicleKey],
      [OriginalVehicleSiteKey] = ds.[SiteKey]
    FROM
      [StageUser].[STAGE_FACT_ActivitySummary] stg
         INNER JOIN
      [MiXData].dbo.DIM_Vehicles            dvh WITH (NOLOCK) ON dvh.OrganisationKey = @organisationKey
                                                                AND stg.VehicleID       = dvh.HostID
         INNER JOIN
      [MiXData].dbo.DIM_Sites               ds  WITH (NOLOCK) ON dvh.OrganisationKey = ds.OrganisationKey
                                                                AND dvh.SiteGUID        = ds.SiteGUID
    WHERE
      ISNULL(stg.ActivityStartDateKey,@endDateDefault) BETWEEN dvh.StartDateKey AND dvh.EndDateKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update calculated cols - VehicleKey/VehicleSiteKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- TotalFuelUsed (calculated on ActivityDetail)

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF EXISTS (SELECT 1
               FROM
                 [StageUser].[STAGE_FACT_ActivitySummary]
               WHERE
                 ActivityStartDateKey > DATEADD(DAY,1,@currentDate))
    BEGIN
      RAISERROR(N'Some Units internal clock seem to be out of sync',16,1);
    END
 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Add to RollBck table
    INSERT INTO [StageUser].[ROLLBACK_FACT_ActivitySummary]
    ( 
      [ActivitySummaryKey]          ,
      [OrganisationKey]             ,
      [HostID]                      ,
      [UnitTripNumber]              ,
      [ActivityStartDateKey]        ,
      [ActivityEndDateKey]          ,
      [ActivityStartTime]           ,
      [ActivityEndTime]             ,
      [ActivityStartDateTime]       ,
      [ActivityEndDateTime]         ,
      [VehicleKey]                  ,
      [DriverKey]                   ,
      [OriginalDriverKey]           ,
      [OriginalDriverSiteKey]       ,
      [OriginalVehicleSiteKey]      ,
      [UTCOffsetKey]                ,
      [TotalFuelUsedMeasured]       ,
      [TotalFuelUsedCalculated]     ,
      [StartOdometer]               ,
      [EndOdometer]                 ,
      [StartEngineSeconds]          ,
      [EndEngineSeconds]            ,
      [StartGeoLocationKey]         ,
      [EndGeoLocationKey]           ,
      [AverageSimpleDriverScore]    ,
      [TotalDistanceTravelled]      ,
      [TotalDrivingTime]            ,
      [TotalEngineSeconds]          ,
      [MaxSpeed]                    ,
      [MaxAccel]                    ,
      [MaxBrake]                    ,
      [MaxRPM]                      ,
      [TotalIdleTime]               ,
      [TotalPassengers]             ,
      [TotalStandingTime]           ,
      [TotalNightDuration]          ,
      [TotalAfterHoursDuration]     ,
      [TotalCarbonEmission]         ,
      [TotalCO2Emission]            ,
      [TripClassificationLookupKey] ,
      [TripClassificationHierarchy] ,
      [IsDutchTaxTripClassification],
      [MovementCount]               ,
      [IsDeleted]                   ,
      [CreateBatchKey]              ,
      [UpdateBatchKey]
    )
    SELECT
      [ActivitySummaryKey]          ,
      [OrganisationKey]             ,
      [HostID]                      ,
      [UnitTripNumber]              ,
      [ActivityStartDateKey]        ,
      [ActivityEndDateKey]          ,
      [ActivityStartTime]           ,
      [ActivityEndTime]             ,
      [ActivityStartDateTime]       ,
      [ActivityEndDateTime]         ,
      [VehicleKey]                  ,
      [DriverKey]                   ,
      [OriginalDriverKey]           ,
      [OriginalDriverSiteKey]       ,
      [OriginalVehicleSiteKey]      ,
      [UTCOffsetKey]                ,
      [TotalFuelUsedMeasured]       ,
      [TotalFuelUsedCalculated]     ,
      [StartOdometer]               ,
      [EndOdometer]                 ,
      [StartEngineSeconds]          ,
      [EndEngineSeconds]            ,
      [StartGeoLocationKey]         ,
      [EndGeoLocationKey]           ,
      [AverageSimpleDriverScore]    ,
      [TotalDistanceTravelled]      ,
      [TotalDrivingTime]            ,
      [TotalEngineSeconds]          ,
      [MaxSpeed]                    ,
      [MaxAccel]                    ,
      [MaxBrake]                    ,
      [MaxRPM]                      ,
      [TotalIdleTime]               ,
      [TotalPassengers]             ,
      [TotalStandingTime]           ,
      [TotalNightDuration]          ,
      [TotalAfterHoursDuration]     ,
      [TotalCarbonEmission]         ,
      [TotalCO2Emission]            ,
      [TripClassificationLookupKey] ,
      [TripClassificationHierarchy] ,
      [IsDutchTaxTripClassification],
      [MovementCount]               ,
      [IsDeleted]                   ,
      [CreateBatchKey]              ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [UnitTripNumber]               = stg.[UnitTripNumber]        ,
        [ActivityStartDateKey]         = stg.[ActivityStartDateKey]  ,
        [ActivityEndDateKey]           = stg.[ActivityEndDateKey]    ,
        [ActivityStartTime]            = stg.[ActivityStartTime]     ,
        [ActivityEndTime]              = stg.[ActivityEndTime]       ,
        [ActivityStartDateTime]        = stg.[ActivityStartDateTime] ,
        [ActivityEndDateTime]          = stg.[ActivityEndDateTime]   ,
        [VehicleKey]                   = ISNULL(stg.[VehicleKey]            ,-1),
        [DriverKey]                    = ISNULL(stg.[DriverKey]             ,-1),
        [OriginalDriverKey]            = ISNULL(stg.[OriginalDriverKey]     ,-1),
        [OriginalDriverSiteKey]        = ISNULL(stg.[OriginalDriverSiteKey] ,-1),
        [OriginalVehicleSiteKey]       = ISNULL(stg.[OriginalVehicleSiteKey],-1),
        [UTCOffsetKey]                 = stg.[UTCOffsetKey]          ,
        [IsDeleted]                    = 0                           ,
        UpdateBatchKey                 = @batchKey
      OUTPUT
        DELETED.[ActivitySummaryKey]          ,
        DELETED.[OrganisationKey]             ,
        DELETED.[HostID]                      ,
        DELETED.[UnitTripNumber]              ,
        DELETED.[ActivityStartDateKey]        ,
        DELETED.[ActivityEndDateKey]          ,
        DELETED.[ActivityStartTime]           ,
        DELETED.[ActivityEndTime]             ,
        DELETED.[ActivityStartDateTime]       ,
        DELETED.[ActivityEndDateTime]         ,
        DELETED.[VehicleKey]                  ,
        DELETED.[DriverKey]                   ,
        DELETED.[OriginalDriverKey]           ,
        DELETED.[OriginalDriverSiteKey]       ,
        DELETED.[OriginalVehicleSiteKey]      ,
        DELETED.[UTCOffsetKey]                ,
        DELETED.[TotalFuelUsedMeasured]       ,
        DELETED.[TotalFuelUsedCalculated]     ,
        DELETED.[StartOdometer]               ,
        DELETED.[EndOdometer]                 ,
        DELETED.[StartEngineSeconds]          ,
        DELETED.[EndEngineSeconds]            ,
        DELETED.[StartGeoLocationKey]         ,
        DELETED.[EndGeoLocationKey]           ,
        DELETED.[AverageSimpleDriverScore]    ,
        DELETED.[TotalDistanceTravelled]      ,
        DELETED.[TotalDrivingTime]            ,
        DELETED.[TotalEngineSeconds]          ,
        DELETED.[MaxSpeed]                    ,
        DELETED.[MaxAccel]                    ,
        DELETED.[MaxBrake]                    ,
        DELETED.[MaxRPM]                      ,
        DELETED.[TotalIdleTime]               ,
        DELETED.[TotalPassengers]             ,
        DELETED.[TotalStandingTime]           ,
        DELETED.[TotalNightDuration]          ,
        DELETED.[TotalAfterHoursDuration]     ,
        DELETED.[TotalCarbonEmission]         ,
        DELETED.[TotalCO2Emission]            ,
        DELETED.[TripClassificationLookupKey] ,
        DELETED.[TripClassificationHierarchy] ,
        DELETED.[IsDutchTaxTripClassification],
        DELETED.[MovementCount]               ,
        DELETED.[IsDeleted]                   ,
        DELETED.[CreateBatchKey]              ,
        DELETED.[UpdateBatchKey]
      FROM 
        [MiXData].dbo.FACT_ActivitySummary    AS tar
          INNER JOIN
        [StageUser].[STAGE_FACT_ActivitySummary] AS stg ON tar.HostID               = stg.HostID
                                                       AND tar.OrganisationKey      = @organisationKey
      WHERE stg.Operation in ('I','U')
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    -- Deleted records
    INSERT INTO [StageUser].[ROLLBACK_FACT_ActivitySummary]
    ( 
      [ActivitySummaryKey]          ,
      [OrganisationKey]             ,
      [HostID]                      ,
      [UnitTripNumber]              ,
      [ActivityStartDateKey]        ,
      [ActivityEndDateKey]          ,
      [ActivityStartTime]           ,
      [ActivityEndTime]             ,
      [ActivityStartDateTime]       ,
      [ActivityEndDateTime]         ,
      [VehicleKey]                  ,
      [DriverKey]                   ,
      [OriginalDriverKey]           ,
      [OriginalDriverSiteKey]       ,
      [OriginalVehicleSiteKey]      ,
      [UTCOffsetKey]                ,
      [TotalFuelUsedMeasured]       ,
      [TotalFuelUsedCalculated]     ,
      [StartOdometer]               ,
      [EndOdometer]                 ,
      [StartEngineSeconds]          ,
      [EndEngineSeconds]            ,
      [StartGeoLocationKey]         ,
      [EndGeoLocationKey]           ,
      [AverageSimpleDriverScore]    ,
      [TotalDistanceTravelled]      ,
      [TotalDrivingTime]            ,
      [TotalEngineSeconds]          ,
      [MaxSpeed]                    ,
      [MaxAccel]                    ,
      [MaxBrake]                    ,
      [MaxRPM]                      ,
      [TotalIdleTime]               ,
      [TotalPassengers]             ,
      [TotalStandingTime]           ,
      [TotalNightDuration]          ,
      [TotalAfterHoursDuration]     ,
      [TotalCarbonEmission]         ,
      [TotalCO2Emission]            ,
      [TripClassificationLookupKey] ,
      [TripClassificationHierarchy] ,
      [IsDutchTaxTripClassification],
      [MovementCount]               ,
      [IsDeleted]                   ,
      [CreateBatchKey]              ,
      [UpdateBatchKey]
    )
    SELECT
      [ActivitySummaryKey]          ,
      [OrganisationKey]             ,
      [HostID]                      ,
      [UnitTripNumber]              ,
      [ActivityStartDateKey]        ,
      [ActivityEndDateKey]          ,
      [ActivityStartTime]           ,
      [ActivityEndTime]             ,
      [ActivityStartDateTime]       ,
      [ActivityEndDateTime]         ,
      [VehicleKey]                  ,
      [DriverKey]                   ,
      [OriginalDriverKey]           ,
      [OriginalDriverSiteKey]       ,
      [OriginalVehicleSiteKey]      ,
      [UTCOffsetKey]                ,
      [TotalFuelUsedMeasured]       ,
      [TotalFuelUsedCalculated]     ,
      [StartOdometer]               ,
      [EndOdometer]                 ,
      [StartEngineSeconds]          ,
      [EndEngineSeconds]            ,
      [StartGeoLocationKey]         ,
      [EndGeoLocationKey]           ,
      [AverageSimpleDriverScore]    ,
      [TotalDistanceTravelled]      ,
      [TotalDrivingTime]            ,
      [TotalEngineSeconds]          ,
      [MaxSpeed]                    ,
      [MaxAccel]                    ,
      [MaxBrake]                    ,
      [MaxRPM]                      ,
      [TotalIdleTime]               ,
      [TotalPassengers]             ,
      [TotalStandingTime]           ,
      [TotalNightDuration]          ,
      [TotalAfterHoursDuration]     ,
      [TotalCarbonEmission]         ,
      [TotalCO2Emission]            ,
      [TripClassificationLookupKey] ,
      [TripClassificationHierarchy] ,
      [IsDutchTaxTripClassification],
      [MovementCount]               ,
      [IsDeleted]                   ,
      [CreateBatchKey]              ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]      = 1,
        [UpdateBatchKey] = @batchKey
      OUTPUT
        DELETED.[ActivitySummaryKey]          ,
        DELETED.[OrganisationKey]             ,
        DELETED.[HostID]                      ,
        DELETED.[UnitTripNumber]              ,
        DELETED.[ActivityStartDateKey]        ,
        DELETED.[ActivityEndDateKey]          ,
        DELETED.[ActivityStartTime]           ,
        DELETED.[ActivityEndTime]             ,
        DELETED.[ActivityStartDateTime]       ,
        DELETED.[ActivityEndDateTime]         ,
        DELETED.[VehicleKey]                  ,
        DELETED.[DriverKey]                   ,
        DELETED.[OriginalDriverKey]           ,
        DELETED.[OriginalDriverSiteKey]       ,
        DELETED.[OriginalVehicleSiteKey]      ,
        DELETED.[UTCOffsetKey]                ,
        DELETED.[TotalFuelUsedMeasured]       ,
        DELETED.[TotalFuelUsedCalculated]     ,
        DELETED.[StartOdometer]               ,
        DELETED.[EndOdometer]                 ,
        DELETED.[StartEngineSeconds]          ,
        DELETED.[EndEngineSeconds]            ,
        DELETED.[StartGeoLocationKey]         ,
        DELETED.[EndGeoLocationKey]           ,
        DELETED.[AverageSimpleDriverScore]    ,
        DELETED.[TotalDistanceTravelled]      ,
        DELETED.[TotalDrivingTime]            ,
        DELETED.[TotalEngineSeconds]          ,
        DELETED.[MaxSpeed]                    ,
        DELETED.[MaxAccel]                    ,
        DELETED.[MaxBrake]                    ,
        DELETED.[MaxRPM]                      ,
        DELETED.[TotalIdleTime]               ,
        DELETED.[TotalPassengers]             ,
        DELETED.[TotalStandingTime]           ,
        DELETED.[TotalNightDuration]          ,
        DELETED.[TotalAfterHoursDuration]     ,
        DELETED.[TotalCarbonEmission]         ,
        DELETED.[TotalCO2Emission]            ,
        DELETED.[TripClassificationLookupKey] ,
        DELETED.[TripClassificationHierarchy] ,
        DELETED.[IsDutchTaxTripClassification],
        DELETED.[MovementCount]               ,
        DELETED.[IsDeleted]                   ,
        DELETED.[CreateBatchKey]              ,
        DELETED.[UpdateBatchKey]
      FROM 
        [MiXData].dbo.FACT_ActivitySummary    AS tar
          INNER JOIN
        [StageUser].[STAGE_FACT_ActivitySummary] AS stg ON tar.HostID               = stg.HostID
                                                       AND tar.OrganisationKey      = @organisationKey
      WHERE stg.Operation = 'D'
      ) AS del;

    -- record number of records deleted  
    SELECT @recordsDeleted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;  
    END;  

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_ActivitySummary_HostID
      ON [StageUser].[ROLLBACK_FACT_ActivitySummary](HostID);

    -- insert records not existing in DW
    INSERT INTO [MiXData].dbo.FACT_ActivitySummary
    ( 
      [OrganisationKey]             ,
      [HostID]                      ,
      [UnitTripNumber]              ,
      [ActivityStartDateKey]        ,
      [ActivityEndDateKey]          ,
      [ActivityStartTime]           ,
      [ActivityEndTime]             ,
      [ActivityStartDateTime]       ,
      [ActivityEndDateTime]         ,
      [VehicleKey]                  ,
      [DriverKey]                   ,
      [OriginalDriverKey]           ,
      [OriginalDriverSiteKey]       ,
      [OriginalVehicleSiteKey]      ,
      [StartGeoLocationKey]         ,
      [EndGeoLocationKey]           ,
      [UTCOffsetKey]                , 
      [IsDeleted]                   ,
      [CreateBatchKey]              ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey            ,
      stg.[HostID]                ,
      stg.[UnitTripNumber]        ,
      stg.[ActivityStartDateKey]  ,
      stg.[ActivityEndDateKey]    ,
      stg.[ActivityStartTime]     ,
      stg.[ActivityEndTime]       ,
      stg.[ActivityStartDateTime] ,
      stg.[ActivityEndDateTime]   ,
      ISNULL(stg.[VehicleKey]            ,-1),
      ISNULL(stg.[DriverKey]             ,-1),
      ISNULL(stg.[OriginalDriverKey]     ,-1),
      ISNULL(stg.[OriginalDriverSiteKey] ,-1),
      ISNULL(stg.[OriginalVehicleSiteKey],-1),
      -1                          , -- StartGeoLocationKey
      -1                          , -- EndGeoLocationKey
      stg.[UTCOffsetKey]          , 
      0                           , -- IsDeleted
      @batchKey                   ,
      @batchKey
    FROM 
      [StageUser].[STAGE_FACT_ActivitySummary] AS stg
    WHERE
        stg.Operation IN ('I','U')
    AND NOT EXISTS (SELECT 1
                    FROM
                      [StageUser].[ROLLBACK_FACT_ActivitySummary] AS roll WITH (NOLOCK)
                    WHERE
                      stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  
  -- Have to keep STG table is it gets reused in the Late transform and cleaned up then

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_EventDetails_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_EventDetails on DW (event details)
-- ==============================================================================
/*
  Dependencies:
  
  All DIMs
  FACT_ActivityDetails

*/
CREATE PROCEDURE [StageUser].[sprFACT_EventDetails_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected  int = 0;
  DECLARE @nrOfValidationErrors int = 0;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE @endDateDefault     date = '20501231';
  DECLARE @currentDate        datetimeoffset(0); -- used for validation
  DECLARE @flagStartTime      datetimeoffset(0) = SYSUTCDATETIME();
  DECLARE @flagSeq            smallint = 1;

  CREATE TABLE #EventTypeLookup
  (
    LookupRID  INT,
    LookupKey  INT
  );

  CREATE TABLE #EventDescriptionsLookup
  (
    HostID              INT,
    EventDescriptionKey INT,
    ParameterKey        INT
  );

  CREATE TABLE #VehiclesLookup
  (
    VehicleKey   INT,
    HostID       INT,
    StartDateKey DATE,
    EndDateKey   DATE
  );

  CREATE TABLE #DriversLookup
  (
    DriverKey    INT,
    HostID       INT,
    StartDateKey DATE,
    EndDateKey   DATE
  );

  CREATE TABLE #rollback
  (
    HostID       BIGINT
  );

  SELECT @currentDate = SYSUTCDATETIME();
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_FACT_EventDetails];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_EventDetails];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY
    
    -- create required source indexes
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser].[EventData]') AND name = N'IX_EventData_StartDate')
      CREATE NONCLUSTERED INDEX IX_EventData_StartDate
        ON [StageUser].[EventData] ( [StartDate] )
        INCLUDE ( [Operation],[EventKey],[VehicleID],[DriverID],[EventID],[StartOdometer],[StartGPSID],[EndDate],[EndOdometer],[EndGPSID],[TotalTime],[TotalOccurs],[Value])

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.1. Create Source Index', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_HostID_EventStartDateKey_Operation')
      DROP INDEX IX_STAGE_FACT_EventDetails_HostID_EventStartDateKey_Operation ON [StageUser].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_EventDetails_HostID_Operation ON [StageUser].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_EventStartDateKey')
      DROP INDEX IX_STAGE_FACT_EventDetails_EventStartDateKey         ON [StageUser].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_DriverID_EventStartDateKey')
      DROP INDEX IX_STAGE_FACT_EventDetails_DriverID_EventStartDateKey  ON [StageUser].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime')
      DROP INDEX IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime ON [StageUser].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_TrailerUnitID')
      DROP INDEX IX_STAGE_FACT_EventDetails_TrailerUnitID             ON [StageUser].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_EventID')
      DROP INDEX IX_STAGE_FACT_EventDetails_EventID                   ON [StageUser].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_EventDescriptionKey_VehicleKey_EventStartDateKey')
      DROP INDEX IX_STAGE_FACT_EventDetails_EventDescriptionKey_VehicleKey_EventStartDateKey ON [StageUser].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime_Filtered')
      DROP INDEX IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime_Filtered ON [StageUser].[STAGE_FACT_EventDetails];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_EventDetails]') AND name = N'IX_ROLLBACK_FACT_EventDetails_HostID')
      DROP INDEX IX_ROLLBACK_FACT_EventDetails_HostID ON [StageUser].[ROLLBACK_FACT_EventDetails];

    -- get EventType LookupKeys
    INSERT INTO #EventTypeLookup
    ( LookupRID, LookupKey )
    SELECT
      tcl.LookupRID,
      tcl.LookupKey
    FROM
      [MiXData].dbo.DIM_TableColumnLookups tcl WITH (NOLOCK)
    WHERE
        tcl.LookupTable  = 'FACT_EventDetails'
    AND tcl.LookupColumn = 'EventTypeLookupKey';
    
    CREATE CLUSTERED INDEX IX_EventTypeLookup ON #EventTypeLookup(LookupRID);

    -- insert changed records into STG
    INSERT INTO [StageUser].[STAGE_FACT_EventDetails]
    (
      [Operation]          ,
      [HostID]             ,

      [DriverID]           ,
      [VehicleID]          ,
      [TrailerUnitID]      ,
      [EventID]            ,
      [StartGPSID]         ,
      [EndGPSID]           ,
      [EventTypeLookupKey] ,

      [EventStartDateKey]  ,
      [EventEndDateKey]    ,
      [EventStartTime]     ,
      [EventEndTime]       ,
      [EventStartDateTime] ,
      [EventEndDateTime]   ,

      [StartOdometer]      ,
      [EndOdometer]        ,
      [EventValue]         ,
      [TotalOccurs]        ,
      [TotalTime]          ,
      [Litres]             ,
      [PulseParameterID]   ,
      [PulseValue]         ,
      [UTCOffsetKey]       ,
      [VideoKey]
    )
    SELECT
      s.Operation         ,
      HostID = s.EventKey ,

      s.DriverID          ,
      s.VehicleID         ,
      [TrailerUnitID] = CASE -- can also use DIM_CalibrationParameter.ValueFormat (11 passengers, 12 trailers)
                          WHEN s.EventID IN (31,32,33,34,35,118,119,120,121,122,123,124,125)
                            THEN CONVERT(INT,s.Value)
                          ELSE
                            NULL
                        END,
      s.EventID            ,
      s.StartGPSID         ,
      s.EndGPSID           ,
      ISNULL(et.LookupRID,-1),
      
      [EventStartDateKey] = ISNULL(CONVERT(DATE,s.StartDate),@unknownDateDefault),
      [EventEndDateKey]   = CASE 
                              WHEN s.EndDate IS NULL AND EventType = 3 -- Notifications
                                THEN ISNULL(CONVERT(DATE,s.StartDate),@unknownDateDefault)
                                ELSE ISNULL(CONVERT(DATE,s.EndDate)  ,@unknownDateDefault)
                            END,
      [EventStartTime]    = CONVERT(TIME(0),ISNULL(s.StartDate,0)),
      [EventEndTime]      = CASE 
                              WHEN s.EndDate IS NULL AND EventType = 3 -- Notifications
                                THEN CONVERT(TIME(0),ISNULL(s.StartDate,0))
                                ELSE CONVERT(TIME(0),ISNULL(s.EndDate  ,0)) 
                            END,
      [EventStartDateTime]= CASE 
                              WHEN s.StartDate IS NULL
                                THEN @unknownDateDefault
                                ELSE TODATETIMEOFFSET(s.StartDate,ISNULL(utc.UTCOffsetMinutes,0))
                            END,
      [EventEndDateTime]  = CASE 
                              WHEN s.EndDate IS NULL AND EventType = 3 -- Notifications
                                THEN
                                  CASE 
                                    WHEN s.StartDate IS NULL
                                      THEN @unknownDateDefault
                                      ELSE TODATETIMEOFFSET(s.StartDate,ISNULL(utc.UTCOffsetMinutes,0))
                                  END
                              WHEN s.EndDate IS NULL
                                THEN @unknownDateDefault
                              ELSE TODATETIMEOFFSET(s.EndDate  ,ISNULL(utc.UTCOffsetMinutes,0))
                            END,
      [StartOdometer]     = s.StartOdometer,
      [EndOdometer]       = s.EndOdometer  ,
      [EventValue]        = s.Value        ,
      s.TotalOccurs                        ,
      s.TotalTime                          ,
      s.Litres                             ,
      s.PulseParameterID                   ,
      s.PulseValue                         ,
      utc.UTCOffsetKey                     ,
      s.VideoKey
    FROM
      [StageUser].EventData s WITH (NOLOCK)
        CROSS JOIN
      [StageUser].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
        LEFT JOIN
      #EventTypeLookup                       et ON et.LookupKey = s.EventType
    WHERE
      ISNULL(CONVERT(DATETIMEOFFSET(0),s.StartDate),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime
  AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.StartDate),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
        
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create indexes required for lookups
    --CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_HostID_Operation 
    --  ON [StageUser].[STAGE_FACT_EventDetails](HostID,Operation);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_EventStartDateKey
      ON [StageUser].[STAGE_FACT_EventDetails](EventStartDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_DriverID_EventStartDateKey
      ON [StageUser].[STAGE_FACT_EventDetails](DriverID,EventStartDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime
      ON [StageUser].[STAGE_FACT_EventDetails](VehicleID,EventStartDateKey,EventStartDateTime);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_TrailerUnitID
      ON [StageUser].[STAGE_FACT_EventDetails](TrailerUnitID,EventStartDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_EventID
      ON [StageUser].[STAGE_FACT_EventDetails](EventID);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    ------------------------------------------
    -- DriverKey
    INSERT INTO #DriversLookup
    ( DriverKey,HostID,StartDateKey,EndDateKey )
    SELECT
      ddr.DriverKey,
      ddr.HostID,
      ddr.StartDateKey,
      ddr.EndDateKey
    FROM
      [MiXData].dbo.DIM_Drivers ddr WITH (NOLOCK)
    WHERE ddr.OrganisationKey = @organisationKey;

    CREATE CLUSTERED INDEX IX_DriversLookup ON #DriversLookup(DriverKey);

    UPDATE stg
    SET
      [DriverKey] = ddr.[DriverKey]
    FROM
      [StageUser].[STAGE_FACT_EventDetails] stg
        INNER JOIN
      #DriversLookup                         ddr ON stg.DriverID = ddr.HostID
    WHERE
      ISNULL(stg.EventStartDateKey,@endDateDefault) BETWEEN ddr.StartDateKey AND ddr.EndDateKey;

    ------------------------------------------
    -- VehicleKey
    INSERT INTO #VehiclesLookup
    ( VehicleKey,HostID,StartDateKey,EndDateKey )
    SELECT
      dvh.VehicleKey,
      dvh.HostID,
      dvh.StartDateKey,
      dvh.EndDateKey
    FROM
      [MiXData].dbo.DIM_Vehicles dvh WITH (NOLOCK)
    WHERE dvh.OrganisationKey = @organisationKey;

    CREATE CLUSTERED INDEX IX_Vehicles ON #VehiclesLookup(VehicleKey);

    UPDATE [StageUser].[STAGE_FACT_EventDetails]
    SET
      [VehicleKey]             = dvh.[VehicleKey]
    FROM
      [StageUser].[STAGE_FACT_EventDetails] stg
         INNER JOIN
      #VehiclesLookup                       dvh ON stg.VehicleID = dvh.HostID
    WHERE
      ISNULL(stg.EventStartDateKey,@endDateDefault) BETWEEN dvh.StartDateKey AND dvh.EndDateKey;

    ------------------------------------------
    -- TrailerKey (still need to identify how to connect Trialer to event)
    UPDATE [StageUser].[STAGE_FACT_EventDetails]
    SET
      [TrailerKey]             = dtl.[TrailerKey]
    FROM
      [StageUser].[STAGE_FACT_EventDetails] stg
         INNER JOIN
      [MiXData].dbo.DIM_Trailers         dtl WITH (NOLOCK)
         ON  dtl.OrganisationKey = @organisationKey
         AND stg.TrailerUnitID   = dtl.TrailerUnitID
    WHERE
      ISNULL(stg.EventStartDateKey,@endDateDefault) BETWEEN dtl.StartDateKey AND dtl.EndDateKey;

    ------------------------------------------
    -- EventDescriptionKey 
    INSERT INTO #EventDescriptionsLookup
    ( HostID, EventDescriptionKey,ParameterKey )
    SELECT
      HostID,
      EventDescriptionKey,
      ParameterKey
    FROM [MiXData].dbo.DIM_EventDescriptions ded WITH (NOLOCK)
    WHERE ded.OrganisationKey = @organisationKey;
    
    CREATE CLUSTERED INDEX IX_EventDescriptionsLookup ON #EventDescriptionsLookup(HostID);
    
    UPDATE [StageUser].[STAGE_FACT_EventDetails]
    SET
      [EventDescriptionKey] = ded.[EventDescriptionKey],
      [ParameterKey]        = ded.[ParameterKey]
    FROM
      [StageUser].[STAGE_FACT_EventDetails]  stg
         INNER JOIN
      #EventDescriptionsLookup                ded ON stg.EventID = ded.HostID;

    ------------------------------------------
    -- ParameterKey
    UPDATE
      [StageUser].STAGE_FACT_EventDetails
    SET
      [PulseParameterKey] = dcp.ParameterKey
    FROM
      [StageUser].STAGE_FACT_EventDetails        stg
        INNER JOIN
      [MiXData].dbo.DIM_CalibrationParameters dcp WITH (NOLOCK) ON dcp.OrganisationKey = @organisationKey
                                                                  AND dcp.HostID          = stg.PulseParameterID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update Keys', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    ------------------------------------------
    -- ActivityDetailKey 
    -- enable after initial run
    UPDATE stg
    SET [ActivityDetailKey] = fad.[ActivityDetailKey]
    -- select top 10 fad.ActivityDetailKey,stg.HostID select count(1)
    FROM
      #VehiclesLookup                       dvh
         INNER JOIN -- select top 1000 * from
      [StageUser].[STAGE_FACT_EventDetails] stg               ON stg.VehicleID         = dvh.HostID
                                                              AND stg.EventStartDateKey > '0001-01-01'
         INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK) ON fad.VehicleKey  = dvh.VehicleKey
    WHERE
        fad.ActivityStartDateKey BETWEEN DATEADD(DAY,-7,stg.EventStartDateKey) AND stg.EventStartDateKey
    AND stg.EventStartDateTime   BETWEEN fad.ActivityStartDateTime AND fad.ActivityEndDateTime
    OPTION (FAST 10000);
    SELECT @nrOfrecordsAffected = @@ROWCOUNT;

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime_Filtered
      ON [StageUser].[STAGE_FACT_EventDetails](VehicleID,EventStartDateKey,EventStartDateTime)
      WHERE ActivityDetailKey IS NULL;

    IF EXISTS (SELECT 1 FROM [StageUser].[STAGE_FACT_EventDetails] WHERE ActivityDetailKey IS NULL)
    BEGIN
      UPDATE stg
      SET [ActivityDetailKey] = fad.[ActivityDetailKey]
      FROM
        #VehiclesLookup                       dvh
           INNER JOIN
        [StageUser].[STAGE_FACT_EventDetails] stg               ON stg.VehicleID   = dvh.HostID
                                                                AND stg.EventStartDateKey > '0001-01-01'
                                                                AND stg.[ActivityDetailKey]  IS NULL
           INNER JOIN
        [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK) ON fad.VehicleKey  = dvh.VehicleKey
      WHERE stg.EventStartDateTime   BETWEEN fad.ActivityStartDateTime AND fad.ActivityEndDateTime
      OPTION (FAST 10000);
    END;
    
    SELECT @nrOfrecordsAffected = @nrOfrecordsAffected + @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3 Update ActivityDetailKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    ------------------------------------------
    -- StartGeoLocationKey (still need to get logic to calc)
    UPDATE [StageUser].[STAGE_FACT_EventDetails]
    SET
      StartGeoLocationKey = g.GeoLocationKey
    FROM
      [StageUser].[STAGE_FACT_EventDetails] stg
        INNER JOIN
      [StageUser].STAGE_DIM_GeoLocations       g WITH (NOLOCK) ON stg.StartGPSID = g.HostID;


    ------------------------------------------
    -- EndGeoLocationKey (still need to get logic to calc)
    UPDATE [StageUser].[STAGE_FACT_EventDetails]
    SET
      EndGeoLocationKey = g.GeoLocationKey
    FROM
      [StageUser].[STAGE_FACT_EventDetails] stg
        INNER JOIN
      [StageUser].STAGE_DIM_GeoLocations       g WITH (NOLOCK) ON stg.EndGPSID = g.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.4 Update GeoLocationKeys', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    DROP INDEX IX_STAGE_FACT_EventDetails_EventStartDateKey
      ON [StageUser].[STAGE_FACT_EventDetails];

    DROP INDEX IX_STAGE_FACT_EventDetails_DriverID_EventStartDateKey
      ON [StageUser].[STAGE_FACT_EventDetails];

    DROP INDEX IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime
      ON [StageUser].[STAGE_FACT_EventDetails];

    DROP INDEX IX_STAGE_FACT_EventDetails_TrailerUnitID
      ON [StageUser].[STAGE_FACT_EventDetails];

    DROP INDEX IX_STAGE_FACT_EventDetails_EventID
      ON [StageUser].[STAGE_FACT_EventDetails];

    DROP INDEX IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime_Filtered
      ON [StageUser].[STAGE_FACT_EventDetails];

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
        
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    SELECT @nrOfValidationErrors = ISNULL(count(1),0)
    FROM
      [StageUser].[STAGE_FACT_EventDetails]
    WHERE
      EventStartDateKey > DATEADD(DAY,1,@currentDate);

    IF @nrOfValidationErrors > 0
    BEGIN
      DELETE [StageUser].[STAGE_FACT_EventDetails]
      WHERE EventStartDateKey > DATEADD(DAY,1,@currentDate);

      RAISERROR(N'Some Units internal clock seem to be out of sync',16,1);
    END

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE CLUSTERED INDEX IX_STAGE_FACT_EventDetails_HostID_EventStartDateKey_Operation
      ON [StageUser].STAGE_FACT_EventDetails(HostID,EventStartDateKey,Operation);

    -- Add to RollBck table
    INSERT INTO #rollback
    SELECT HostID
    FROM
     (UPDATE
        tar
      SET
        [DriverKey]           = ISNULL(stg.[DriverKey]          ,-1),
        [VehicleKey]          = ISNULL(stg.[VehicleKey]         ,-1),
        [TrailerKey]          = ISNULL(stg.[TrailerKey]         ,-1),
        [EventDescriptionKey] = ISNULL(stg.[EventDescriptionKey],-1),
        [EventTypeLookupKey]  = stg.[EventTypeLookupKey],
        [ActivityDetailKey]   = ISNULL(stg.[ActivityDetailKey]  ,-1),
        [EventStartDateKey]   = stg.[EventStartDateKey]  ,
        [EventEndDateKey]     = stg.[EventEndDateKey]    ,
        [EventStartTime]      = stg.[EventStartTime]     ,
        [EventEndTime]        = stg.[EventEndTime]       ,
        [EventStartDateTime]  = stg.[EventStartDateTime] ,
        [EventEndDateTime]    = stg.[EventEndDateTime]   ,
        [StartOdometer]       = stg.[StartOdometer]      ,
        [EndOdometer]         = stg.[EndOdometer]        ,
        [EventValue]          = stg.[EventValue]         ,
        [StartGeoLocationKey] = ISNULL(stg.[StartGeoLocationKey],tar.[StartGeoLocationKey]),
        [EndGeoLocationKey]   = ISNULL(stg.[EndGeoLocationKey]  ,tar.[EndGeoLocationKey]  ),     
        [TotalOccurs]         = stg.[TotalOccurs]        ,
        [TotalTime]           = stg.[TotalTime]          ,
        [ParameterKey]        = stg.[ParameterKey]       ,
        [Litres]              = stg.[Litres]             ,
        [PulseParameterKey]   = stg.[PulseParameterKey]  ,
        [PulseValue]          = stg.[PulseValue]         ,
        [UTCOffsetKey]        = stg.[UTCOffsetKey]       ,
        [VideoKey]            = stg.[VideoKey]           ,
        [IsDeleted]           = 0                        ,
        [UpdateBatchKey]      = @batchKey
      OUTPUT
        DELETED.[HostID]
      FROM 
        [StageUser].[STAGE_FACT_EventDetails] AS stg
          INNER JOIN 
        [MiXData].dbo.FACT_EventDetails    AS tar ON tar.OrganisationKey      = @organisationKey
                                                    AND tar.HostID            = stg.HostID
--                                                    AND tar.EventStartDateKey = stg.EventStartDateKey
      WHERE stg.Operation in ('I','U')
      ) AS upd
      OPTION (FAST 1000);
    SELECT @recordsUpdated = @@ROWCOUNT;

/*
    INSERT INTO #rollback
    SELECT HostID
    FROM
     (UPDATE
        tar
      SET
        [DriverKey]           = ISNULL(stg.[DriverKey]          ,-1),
        [VehicleKey]          = ISNULL(stg.[VehicleKey]         ,-1),
        [TrailerKey]          = ISNULL(stg.[TrailerKey]         ,-1),
        [EventDescriptionKey] = ISNULL(stg.[EventDescriptionKey],-1),
        [EventTypeLookupKey]  = stg.[EventTypeLookupKey],
        [ActivityDetailKey]   = ISNULL(stg.[ActivityDetailKey]  ,-1),
        [EventStartDateKey]   = stg.[EventStartDateKey]  ,
        [EventEndDateKey]     = stg.[EventEndDateKey]    ,
        [EventStartTime]      = stg.[EventStartTime]     ,
        [EventEndTime]        = stg.[EventEndTime]       ,
        [EventStartDateTime]  = stg.[EventStartDateTime] ,
        [EventEndDateTime]    = stg.[EventEndDateTime]   ,
        [StartOdometer]       = stg.[StartOdometer]      ,
        [EndOdometer]         = stg.[EndOdometer]        ,
        [EventValue]          = stg.[EventValue]         ,
        [StartGeoLocationKey] = ISNULL(stg.[StartGeoLocationKey],tar.[StartGeoLocationKey]),
        [EndGeoLocationKey]   = ISNULL(stg.[EndGeoLocationKey]  ,tar.[EndGeoLocationKey]  ),     
        [TotalOccurs]         = stg.[TotalOccurs]        ,
        [TotalTime]           = stg.[TotalTime]          ,
        [ParameterKey]        = stg.[ParameterKey]       ,
        [Litres]              = stg.[Litres]             ,
        [PulseParameterKey]   = stg.[PulseParameterKey]  ,
        [PulseValue]          = stg.[PulseValue]         ,
        [UTCOffsetKey]        = stg.[UTCOffsetKey]       ,
        [VideoKey]            = stg.[VideoKey]           ,
        [IsDeleted]           = 0                        ,
        [UpdateBatchKey]      = @batchKey
      OUTPUT
        DELETED.[HostID]
      FROM 
        [StageUser].[STAGE_FACT_EventDetails] AS stg
          INNER JOIN 
        [$(MiXData)].dbo.FACT_EventDetails    AS tar ON tar.OrganisationKey      = @organisationKey
                                                    AND tar.HostID            = stg.HostID
                                                    AND stg.EventStartDateKey > '00010101'
                                                    AND tar.EventStartDateKey = '00010101'
      WHERE stg.Operation in ('I','U')
      ) AS upd;
*/
    -- record number of records updated
--    SELECT @recordsUpdated = @recordsUpdated + @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- Deleted records
    INSERT INTO #rollback
    SELECT HostID
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]      = 1,
        [UpdateBatchKey] = @batchKey
      OUTPUT
        DELETED.[HostID]
      FROM 
        [MiXData].dbo.FACT_EventDetails       tar
          INNER JOIN 
        [StageUser].[STAGE_FACT_EventDetails] stg ON tar.HostID           = stg.HostID
                                                 AND tar.OrganisationKey  = @organisationKey
      WHERE stg.Operation in ('D')
      ) AS del
    OPTION (FAST 1000);
    SELECT @recordsDeleted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_EventDetails_HostID
      ON [StageUser].[ROLLBACK_FACT_EventDetails](HostID);

    CREATE CLUSTERED INDEX IX_rollback ON #rollback(HostID);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_HostID_Operation
      ON [StageUser].[STAGE_FACT_EventDetails](HostID,Operation);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_EventDetails
    ( 
      [OrganisationKey]    ,
      [HostID]             ,
      [DriverKey]          ,
      [VehicleKey]         ,
      [TrailerKey]         ,
      [EventDescriptionKey],
      [EventTypeLookupKey] ,
      [ActivityDetailKey]  ,
      [EventStartDateKey]  ,
      [EventEndDateKey]    ,
      [EventStartTime]     ,
      [EventEndTime]       ,
      [EventStartDateTime] ,
      [EventEndDateTime]   ,
      [StartOdometer]      ,
      [EndOdometer]        ,
      [EventValue]         ,
      [StartGeoLocationKey],
      [EndGeoLocationKey]  ,
      [TotalOccurs]        ,
      [TotalTime]          ,
      [ParameterKey]       ,
      [Litres]             ,
      [PulseParameterKey]  ,
      [PulseValue]         ,
      [UTCOffsetKey]       ,
      [IsDeleted]          ,
      [CreateBatchKey]     ,
      [UpdateBatchKey]     ,
      [VideoKey]
    )
    SELECT
      @organisationKey         ,
      stg.[HostID]             ,
      ISNULL(stg.[DriverKey]          ,-1),
      ISNULL(stg.[VehicleKey]         ,-1),
      ISNULL(stg.[TrailerKey]         ,-1),
      ISNULL(stg.[EventDescriptionKey],-1),
      stg.[EventTypeLookupKey] ,
      ISNULL(stg.[ActivityDetailKey]  ,-1),
      stg.[EventStartDateKey]  ,
      stg.[EventEndDateKey]    ,
      stg.[EventStartTime]     ,
      stg.[EventEndTime]       ,
      stg.[EventStartDateTime] ,
      stg.[EventEndDateTime]   ,
      stg.[StartOdometer]      ,
      stg.[EndOdometer]        ,
      stg.[EventValue]         ,
      ISNULL(stg.[StartGeoLocationKey],-1),
      ISNULL(stg.[EndGeoLocationKey]  ,-1),
      stg.[TotalOccurs]        ,
      stg.[TotalTime]          ,
      stg.[ParameterKey]       ,
      stg.[Litres]             ,
      stg.[PulseParameterKey]  ,
      stg.[PulseValue]         ,
      stg.[UTCOffsetKey]       ,
      0                        , -- IsDeleted
      @batchKey                ,
      @batchKey                ,
      stg.[VideoKey]
    FROM
      [StageUser].[STAGE_FACT_EventDetails]    AS stg
    WHERE
        stg.Operation IN ('I','U')
    AND NOT EXISTS (SELECT 1
                    FROM
                      #rollback AS roll WITH (NOLOCK)
                    WHERE
                      stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[EventData]') AND name = N'IX_EventData_StartDate')
      DROP INDEX IX_EventData_StartDate ON [StageUser].[EventData];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_EventRoadspeedLimits_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_EventRoadspeedLimits on DW
-- ==============================================================================
/*
  Dependencies:
  
  FACT_EventDetails

*/
CREATE PROCEDURE [StageUser].[sprFACT_EventRoadspeedLimits_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected  int = 0;
  DECLARE @nrOfValidationErrors int = 0;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE @endDateDefault     date = '20501231';
  DECLARE @currentDate        datetimeoffset(0); -- used for validation

  SELECT @currentDate = SYSUTCDATETIME();

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
--  TRUNCATE TABLE [StageUser].[STAGE_FACT_EventRoadspeedLimits];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_EventRoadspeedLimits];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  --BEGIN TRY

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
  --  EXEC [Control].sprLogError @organisationKey = @organisationKey;
        
  --  RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  --BEGIN TRY

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
  --  EXEC [Control].sprLogError @organisationKey = @organisationKey;
  --  RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  --BEGIN TRY


  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
  --  EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Add to RollBck table

    -- merge records
    ;WITH
    STAGE_FACT_EventRoadspeedLimits AS
    (
      SELECT
        fed.EventDetailKey,
        fed.EventStartDateKey,
        stg.SpeedLimit,
        IsDeleted = CASE WHEN stg.Operation = 'D' THEN CONVERT(BIT,1) ELSE 0 END
      FROM
        [StageUser].[STAGE_FACT_EventRoadspeedLimits] stg
          INNER JOIN
        [MiXData].dbo.FACT_EventDetails fed WITH (NOLOCK) ON fed.OrganisationKey = @organisationKey
                                                            AND fed.HostID          = stg.EventKey
    )
    INSERT [StageUser].[ROLLBACK_FACT_EventRoadspeedLimits]
    (
      EventDetailKey   ,
      EventStartDateKey,
      OrganisationKey  ,
      SpeedLimit       ,
      IsDeleted        ,
      CreateBatchKey   ,
      UpdateBatchKey
    )
    SELECT
      EventDetailKey   ,
      EventStartDateKey,
      OrganisationKey  ,
      SpeedLimit       ,
      IsDeleted        ,
      CreateBatchKey   ,
      UpdateBatchKey
    FROM
      ( MERGE [MiXData].dbo.FACT_EventRoadspeedLimits tar
        USING STAGE_FACT_EventRoadspeedLimits stg
          ON tar.EventDetailKey = stg.EventDetailKey
        WHEN MATCHED THEN                           -- update existing records to FACT
          UPDATE
          SET tar.EventStartDateKey = stg.EventStartDateKey,
              tar.SpeedLimit        = stg.SpeedLimit,
              tar.IsDeleted         = stg.IsDeleted,
              tar.UpdateBatchKey    = @batchKey
        WHEN NOT MATCHED AND stg.IsDeleted = 0 THEN -- insert new records to FACT
          INSERT
          (
            EventDetailKey   ,
            EventStartDateKey,
            OrganisationKey  ,
            SpeedLimit       ,
            IsDeleted        ,
            CreateBatchKey   ,
            UpdateBatchKey
          )
          VALUES
          (
            stg.EventDetailKey   ,
            stg.EventStartDateKey,
            @organisationKey     ,
            stg.SpeedLimit       ,
            stg.IsDeleted        ,
            @batchKey,
            @batchKey
          )
        OUTPUT
          $action   AS Operation,
          DELETED.EventDetailKey   ,
          DELETED.EventStartDateKey,
          DELETED.OrganisationKey  ,
          DELETED.SpeedLimit       ,
          DELETED.IsDeleted        ,
          DELETED.CreateBatchKey   ,
          DELETED.UpdateBatchKey
        ) Rollbck
    WHERE Operation = 'UPDATE';

    SELECT @recordsUpdated = COUNT(1)
    FROM [StageUser].ROLLBACK_FACT_EventRoadspeedLimits rll;
    SELECT @recordsInserted = COUNT(1)
    FROM [StageUser].STAGE_FACT_EventRoadspeedLimits stg
    WHERE Operation IN ('U','I');

    -- record number of records deleted
    SELECT @recordsDeleted = COUNT(1)
    FROM [StageUser].STAGE_FACT_EventRoadspeedLimits stg
    WHERE Operation = 'D';

    -- record number of records inserted
    SELECT @recordsInserted = CASE WHEN (@recordsInserted - @recordsUpdated) < 0 THEN 0 ELSE @recordsInserted - @recordsUpdated END;

    -- record number of records updated
    SELECT @recordsUpdated  = CASE WHEN @recordsUpdated  - @recordsDeleted < 0 THEN 0 ELSE @recordsUpdated  - @recordsDeleted END;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'5.1 Merge Records';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_EventRoadspeedLimits];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = ISNULL(@nrOfRecordsAffected,0);
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_EventSummary_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_EventSummary on DW
-- ==============================================================================
/*
  Dependencies:

   FACT_EventDetails

   STAGE_FACT_EventDetails
*/
CREATE PROCEDURE [StageUser].[sprFACT_EventSummary_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value         int;
  DECLARE @recordsInserted      int;
  DECLARE @recordsUpdated       int;
  DECLARE @recordsDeleted       int;
  DECLARE @nrOfrecordsAffected  int    = 0;
  DECLARE @unknownDateDefault   date   = '00010101';
  DECLARE @maxDuration          bigint = 2147483647; -- this is the max int data type value

  DECLARE @flagStartTime      datetimeoffset(0) = SYSUTCDATETIME();
  DECLARE @flagSeq            smallint = 1;

  CREATE TABLE #rollback
  (
    EventStartDateKey   DATE,
    EventDescriptionKey INT,
    VehicleKey          INT,
    DriverKey           INT
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].STAGE_FACT_EventSummary;

  IF @debugMode = 1  -- DebugMode is true
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0,
        @isStartFlag=1, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 0. Make sure work tables are cleared';
    END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_EventSummary]') AND name = N'IX_STAGE_FACT_EventSummary_EventDescriptionKey_VehicleKey_DriverKey_EventStartDateKey')
      BEGIN
        DROP INDEX IX_STAGE_FACT_EventSummary_EventDescriptionKey_VehicleKey_DriverKey_EventStartDateKey ON [StageUser].[STAGE_FACT_EventSummary];  
      END;
  
    -- create index for changed records
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes
                  WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_EventDescriptionKey_VehicleKey_EventStartDateKey')
      BEGIN
        CREATE INDEX IX_STAGE_FACT_EventDetails_EventDescriptionKey_VehicleKey_EventStartDateKey
          ON [StageUser].[STAGE_FACT_EventDetails](EventDescriptionKey,VehicleKey,EventStartDateKey);
      END;

    -- insert changed records into STG  
    ;WITH changedKeys AS
    (
      SELECT
        EventDescriptionKey,
        VehicleKey,
        EventStartDateKey
      FROM
        [StageUser].STAGE_FACT_EventDetails
      WHERE
        EventStartDateKey > @unknownDateDefault
      GROUP BY
        EventDescriptionKey,
        VehicleKey,
        EventStartDateKey
    )
    INSERT INTO [StageUser].[STAGE_FACT_EventSummary]
    (
      EventDescriptionKey,
      VehicleKey,
      DriverKey,
      EventStartDateKey,
      TrailerKey,
      UTCOffsetKey,
      NumberOfEvents,
      MaxEventValue,
      MinEventValue,
      AvgEventValue,
      TotalEventValue,
      TotalOccurs,
      TotalTime,
      TotalLitres
    )
    SELECT
      fed.EventDescriptionKey,
      fed.VehicleKey,
      fed.DriverKey,
      fed.EventStartDateKey,
      fed.TrailerKey,
      fed.UTCOffsetKey,
      COUNT(*),
      MAX(fed.EventValue),
      MIN(fed.EventValue),
      AVG(fed.EventValue),
      SUM(fed.EventValue),
      SUM(fed.TotalOccurs),
      CASE
        WHEN ABS(SUM(CONVERT(BIGINT, fed.TotalTime))) >= @maxDuration
          THEN -2
        ELSE
          SUM(CONVERT(BIGINT, fed.TotalTime))
      END,
      SUM(CONVERT(decimal(19,4), fed.Litres))
    FROM
      changedKeys ck
        INNER JOIN
      [MiXData].dbo.FACT_EventDetails fed WITH (NOLOCK) ON ck.EventDescriptionKey = fed.EventDescriptionKey
                                                          AND ck.VehicleKey          = fed.VehicleKey
                                                          AND ck.EventStartDateKey   = fed.EventStartDateKey
    GROUP BY
      fed.EventDescriptionKey,
      fed.VehicleKey,
      fed.DriverKey,
      fed.EventStartDateKey,
      fed.TrailerKey,
      fed.UTCOffsetKey;
    SELECT @nrOfrecordsAffected = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
        @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventSummary_EventDescriptionKey_VehicleKey_DriverKey_EventStartDateKey
      ON [StageUser].[STAGE_FACT_EventSummary](EventDescriptionKey, VehicleKey, DriverKey, EventStartDateKey);
    SELECT @nrOfrecordsAffected = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
        @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    ------------------------------------------
    -- VehicleSiteKey
      UPDATE stg
      SET
        VehicleSiteKey = ds.SiteKey
      FROM
        [StageUser].STAGE_FACT_EventSummary stg
          INNER JOIN
        [MiXData].dbo.DIM_Vehicles              dvh WITH (NOLOCK) ON stg.VehicleKey     = dvh.VehicleKey
          INNER JOIN
        [MiXData].dbo.DIM_Sites                 ds  WITH (NOLOCK) ON ds.OrganisationKey = dvh.OrganisationKey
                                                                   AND ds.SiteGUID        = dvh.SiteGUID;
    SELECT @nrOfrecordsAffected = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update VehicleSiteKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
                @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------

    -- This assumes that EventDescriptionKey, VehicleKey and EventStartDateKey cannot change.

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;
  DECLARE @processPoint   int = 0;  -- what has already been done.
  WHILE @exceptionCount < 20
    BEGIN
      BEGIN TRY

      -- 5.1: Update existing rollups to have new totals
        IF @processPoint < 1
          BEGIN
            BEGIN TRANSACTION;
            INSERT INTO #rollback
            (
              EventDescriptionKey,
              DriverKey,
              VehicleKey,
              EventStartDateKey
            )
            SELECT
              EventDescriptionKey,
              DriverKey,
              VehicleKey,
              EventStartDateKey
            FROM
            (
              UPDATE
                fact
              SET
                TrailerKey        = stg.TrailerKey,
                NumberOfEvents    = ISNULL(stg.NumberOfEvents, 0),
                MaxEventValue     = stg.MaxEventValue,
                MinEventValue     = stg.MinEventValue,
                AvgEventValue     = stg.AvgEventValue,
                TotalEventValue   = ISNULL(stg.TotalEventValue, 0.0),
                TotalOccurs       = ISNULL(stg.TotalOccurs, 0),
                TotalTime         = ISNULL(stg.TotalTime, 0),
                TotalLitres       = ISNULL(stg.TotalLitres, 0.0),
                UTCOffsetKey      = stg.UTCOffsetKey,
                UpdateBatchKey    = @batchKey
              OUTPUT
                deleted.EventDescriptionKey,
                deleted.DriverKey,
                deleted.VehicleKey,
                deleted.EventStartDateKey
              FROM
                [MiXData].[dbo].FACT_EventSummary fact
                  INNER JOIN
                [StageUser].STAGE_FACT_EventSummary stg ON  fact.EventDescriptionKey  = stg.EventDescriptionKey
                                                       AND fact.VehicleKey            = stg.VehicleKey
                                                       AND fact.DriverKey             = stg.DriverKey
                                                       AND fact.EventStartDateKey     = stg.EventStartDateKey
              ) updated
              OPTION (FAST 1000);
            SET @recordsUpdated = @@ROWCOUNT;
            COMMIT TRANSACTION;
            SET @processPoint += 1;

            IF @debugMode = 1  -- DebugMode is true
              BEGIN
                EXEC [Control].strProcProgressMonitor_Set
                  @flag='5.1 Update existing rollups', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
                  @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
                SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
                PRINT '5.1 Update existing rollups = ' + CAST(@recordsUpdated AS nvarchar);
              END;
          END; -- @processPoint 1

      -- 5.2: remove rollups where DriverKey not longer exists
        IF @processPoint < 2
          BEGIN
            BEGIN TRANSACTION;
            INSERT INTO #rollback
            (
              EventDescriptionKey,
              DriverKey,
              VehicleKey,
              EventStartDateKey
            )
            SELECT
              EventDescriptionKey,
              DriverKey,
              VehicleKey,
              EventStartDateKey
            FROM
            (
              DELETE
                [MiXData].[dbo].FACT_EventSummary
              OUTPUT
                deleted.EventDescriptionKey,
                deleted.DriverKey,
                deleted.VehicleKey,
                deleted.EventStartDateKey
              FROM
                [MiXData].[dbo].FACT_EventSummary fact
                  INNER JOIN
                [StageUser].STAGE_FACT_EventSummary stg ON fact.EventDescriptionKey = stg.EventDescriptionKey
                                                       AND fact.EventStartDateKey   = stg.EventStartDateKey
                                                       AND fact.VehicleKey          = stg.VehicleKey
                                                       --- no driver match!
                                                       AND fact.UpdateBatchKey     != @batchKey
            ) deleted
            OPTION (FAST 1000);
            SET @recordsDeleted = @@ROWCOUNT;
            COMMIT TRANSACTION
            SET @processPoint += 1;

            IF @debugMode = 1  -- DebugMode is true
              BEGIN
                EXEC [Control].strProcProgressMonitor_Set
                  @flag='5.2: remove rollups where DriverKey not longer exists', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
                  @nrOfRecordsAffected=@recordsDeleted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
                SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
                PRINT '5.2: remove rollups where DriverKey not longer exists = ' + CAST(@recordsDeleted AS nvarchar);
              END;
          END; -- @processPoint 2

      -- 5.3: insert new rollups (no rollback required)
        IF @processPoint < 3
          BEGIN
            BEGIN TRANSACTION;
            INSERT INTO [MiXData].[dbo].FACT_EventSummary
            (
              OrganisationKey,
              VehicleSiteKey,
              DriverKey,
              VehicleKey,
              TrailerKey,
              EventDescriptionKey,
              EventStartDateKey,
              NumberOfEvents,
              MaxEventValue,
              MinEventValue,
              AvgEventValue,
              TotalEventValue,
              TotalOccurs,
              TotalTime,
              TotalLitres,
              UTCOffsetKey,
              CreateBatchKey,
              UpdateBatchKey
            )
            SELECT
              @organisationKey,
              ISNULL(VehicleSiteKey, -1),
              DriverKey,
              VehicleKey,
              TrailerKey,
              EventDescriptionKey,
              EventStartDateKey,
              ISNULL(NumberOfEvents, 0),
              MaxEventValue,
              MinEventValue,
              AvgEventValue,
              ISNULL(TotalEventValue, 0.0),
              ISNULL(TotalOccurs, 0),
              ISNULL(TotalTime, 0),
              ISNULL(TotalLitres, 0.0),
              UTCOffsetKey,
              @batchKey,
              @batchKey
            FROM
              [StageUser].STAGE_FACT_EventSummary stg
            WHERE
              NOT EXISTS (SELECT *
                          FROM
                            #rollback rbk
                          WHERE
                            rbk.EventDescriptionKey     = stg.EventDescriptionKey
                            AND rbk.VehicleKey          = stg.VehicleKey
                            AND rbk.DriverKey           = stg.DriverKey
                            AND rbk.EventStartDateKey   = stg.EventStartDateKey);
            SET @recordsInserted = @@ROWCOUNT;
            COMMIT TRANSACTION;
            SET @processPoint += 1;

            IF @debugMode = 1  -- DebugMode is true
              BEGIN
                EXEC [Control].strProcProgressMonitor_Set
                  @flag='5.3: insert new rollups', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
                  @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
                SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
                PRINT '5.3: insert new rollups = ' + CAST(@recordsInserted AS nvarchar);
              END;
          END; -- @processPoint 3

          BREAK; -- out of while loop
      END TRY
      -- CATCH Errors
      BEGIN CATCH
        ROLLBACK TRANSACTION;
        SET @exceptionCount += 1;
        IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
          BEGIN
            EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
            IF @debugMode = 1  -- DebugMode is true
              BEGIN
                PRINT '5.error: deadlock occured, restarting merge';
                EXEC [Control].strProcProgressMonitor_Set
                  @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
                  @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
                SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
              END;
          END;
        ELSE
          BEGIN
            EXEC [Control].sprLogError @organisationKey = @organisationKey;
            RETURN -1;
            BREAK; -- out of while loop
          END;
      END CATCH;
    END -- While

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_EventSummary];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = ISNULL(@recordsInserted, 0),
         RecordsUpdated  = ISNULL(@recordsUpdated,  0),
         RecordsDeleted  = ISNULL(@recordsDeleted,  0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated + @recordsDeleted;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
      @nrOfRecordsAffected=@nrOfRecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 7. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_FuelCapture_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_FuelCapture on DW
-- ==============================================================================
/*
  Dependencies:


  STAGE_DIM_UTCOffsetsLookup

  FuelUsage

*/
CREATE PROCEDURE [StageUser].[sprFACT_FuelCapture_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE	@currentDate        datetimeoffset = SYSUTCDATETIME(); -- used for validation

  DECLARE	@maxFuelConsumption real = 35.0; -- (km/l) if fuelconsumption is bigger than this value then it is most probably incorrect

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_FACT_FuelCapture];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_FuelCapture];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_FuelCapture]') AND name = N'IX_STAGE_FACT_FuelCapture_VehicleID')
      DROP INDEX IX_STAGE_FACT_FuelCapture_VehicleID ON [StageUser].[STAGE_FACT_FuelCapture];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_FuelCapture]') AND name = N'IX_ROLLBACK_FACT_FuelCapture_HostID')  
      DROP INDEX IX_ROLLBACK_FACT_FuelCapture_HostID ON [StageUser].[ROLLBACK_FACT_FuelCapture];  

    -- insert changed records into STG
	  INSERT INTO [StageUser].[STAGE_FACT_FuelCapture]
	  (
	    [Operation]    ,
      [HostID]       ,
      [VehicleID]    ,
      [FillDateKey]  ,
      [FillTime]     ,
      [FillDateTime] ,
      [Litres]       ,
      [BaseCost]     ,
      [BaseCurrency] ,
      [FillOdometer] ,
      [EngineSeconds],
      [UTCOffsetKey]
	  )
	  SELECT
	    s.Operation                  ,
      HostID = s.liFuelKey         ,
      s.iVehicleID                 ,
      CONVERT(DATE,s.dtFillDate)   ,
      CONVERT(TIME(0),s.dtFillDate),
      CASE 
        WHEN s.dtFillDate IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.dtFillDate,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      s.fLitres                    ,
      s.fBaseCost                  ,
      s.sBaseCur                   ,
      s.fFillOdo                   ,
      s.liEngineSeconds            ,
      utc.UTCOffsetKey
	  FROM
	    [StageUser].FuelUsage s WITH (NOLOCK)
	      CROSS JOIN
      [StageUser].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
    WHERE
        ISNULL(CONVERT(DATETIMEOFFSET(0),s.dtFillDate),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.dtFillDate),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    ------------------------------------------
    -- VehicleKey
    UPDATE
      [StageUser].[STAGE_FACT_FuelCapture]
    SET
      [VehicleKey] = dv.[VehicleKey]
    FROM
      [StageUser].[STAGE_FACT_FuelCapture] stg
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles      dv  WITH (NOLOCK)
        ON  dv.OrganisationKey = @organisationKey
        AND stg.VehicleID      = dv.HostID
    WHERE
      stg.FillDateKey BETWEEN dv.StartDateKey AND dv.EndDateKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update VehicleKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- BaseCurrencyKey
    UPDATE
      [StageUser].[STAGE_FACT_FuelCapture]
    SET
      [BaseCurrencyKey] = dc.[CurrencyKey]
    FROM
      [StageUser].[STAGE_FACT_FuelCapture] stg
        INNER JOIN -- select * from
      [MiXData].dbo.DIM_Currencies      dc WITH (NOLOCK)
        ON  dc.[CurrencyAlternateKey] = stg.[BaseCurrency];

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3 Update BaseCurrencyKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- PreviousFillOdometer/PreviousEngineSeconds

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_FuelCapture_VehicleID
      ON [StageUser].STAGE_FACT_FuelCapture(VehicleID)
      INCLUDE(FillOdometer,FillDateTime,EngineSeconds);

    ;WITH Previous (VehicleID,FillOdometer,EngineSeconds) AS
    (
      SELECT VehicleID,
             FillOdometer,
             EngineSeconds
      FROM [StageUser].[STAGE_FACT_FuelCapture]
      UNION
      SELECT VehicleID = dvh.HostID,
             ffc.FillOdometer,
             ffc.EngineSeconds
      FROM [MiXData].dbo.[FACT_FuelCapture] ffc WITH (NOLOCK)
             INNER JOIN
           [MiXData].dbo.[DIM_Vehicles]     dvh WITH (NOLOCK)
             ON ffc.VehicleKey = dvh.VehicleKey
      WHERE ffc.OrganisationKey = @organisationKey
    )
    UPDATE
      [StageUser].[STAGE_FACT_FuelCapture]
    SET
      PreviousFillOdometer  = (SELECT MAX(p.FillOdometer)
                               FROM
                                 Previous p
                               WHERE
                                 stg.VehicleID  = p.VehicleID
                               AND
                                 p.FillOdometer < stg.FillOdometer),
      PreviousEngineSeconds = (SELECT MAX(p.EngineSeconds)
                               FROM
                                 Previous p
                               WHERE
                                 stg.VehicleID  = p.VehicleID
                               AND
                                 p.EngineSeconds < stg.EngineSeconds)
    FROM
      [StageUser].[STAGE_FACT_FuelCapture] stg;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.4 Update PreviousFillOdometer/PreviousEngineSeconds', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- PreviousFillDateTime
    ;WITH Previous (VehicleID,FillDateTime) AS
    (
      SELECT VehicleID,
             FillDateTime
      FROM [StageUser].[STAGE_FACT_FuelCapture]
      UNION
      SELECT VehicleID = dvh.HostID,
             ffc.FillDateTime
      FROM [MiXData].dbo.[FACT_FuelCapture] ffc WITH (NOLOCK)
             INNER JOIN
           [MiXData].dbo.[DIM_Vehicles]     dvh WITH (NOLOCK)
             ON ffc.VehicleKey = dvh.VehicleKey
      WHERE ffc.OrganisationKey = @organisationKey
    )
    UPDATE
      [StageUser].[STAGE_FACT_FuelCapture]
    SET
      PreviousFillDateTime = (SELECT MAX(p.FillDateTime)
                              FROM
                                Previous p
                              WHERE
                                stg.VehicleID  = p.VehicleID
                              AND
                                p.FillDateTime < stg.FillDateTime)
    FROM
      [StageUser].[STAGE_FACT_FuelCapture] stg;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.5 Update PreviousFillDateTime', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- DistanceTravelled
    UPDATE
      [StageUser].[STAGE_FACT_FuelCapture]
    SET
      DistanceTravelled = CASE
                            WHEN FillOdometer >= ISNULL(PreviousFillOdometer,FillOdometer)
                              THEN FillOdometer - PreviousFillOdometer
                            ELSE 0.0
                          END;

    ------------------------------------------
    -- FillFuelConsumption (l/100km)
    UPDATE
      [StageUser].[STAGE_FACT_FuelCapture]
    SET
      FillFuelConsumption   = CASE
                                WHEN ISNULL(DistanceTravelled,0.0) = 0.0
                                  THEN NULL
                                ELSE
                                  CASE
                                    WHEN (Litres/DistanceTravelled)*100 > @maxFuelConsumption
                                      THEN NULL
                                    ELSE
                                      (Litres/DistanceTravelled)*100
                                  END
                              END;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.6 Update FillFuelConsumption/DistanceTravelled', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;
    

    ------------------------------------------
    -- ActivityDetailKey
      -- calculated on sprFACT_ActivitySummary_Late_Transform

    ------------------------------------------
    -- FuelStopGeoLocationKey
      -- calculated on sprFACT_ActivitySummary_Late_Transform


  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Changed records
    INSERT INTO [StageUser].[ROLLBACK_FACT_FuelCapture]
    ( 
      [FuelCapturekey]        ,
      [OrganisationKey]       ,
      [HostID]                ,
      [VehicleKey]            ,
      [FillDateKey]           ,
      [FillTime]              ,
      [FillDateTime]          ,
      [PreviousFillDateTime]  ,
      [Litres]                ,
      [BaseCost]              ,
      [BaseCurrencyKey]       ,
      [FillOdometer]          ,
      [PreviousFillOdometer]  ,
      [EngineSeconds]         ,
      [PreviousEngineSeconds] ,
      [DistanceTravelled]     ,
      [FillFuelConsumption]   ,
      [ActivityDetailKey]     ,
      [FuelStopGeoLocationKey],
      [UTCOffsetKey]          ,
      [IsDeleted]             ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    )
    SELECT
      [FuelCapturekey]        ,
      [OrganisationKey]       ,
      [HostID]                ,
      [VehicleKey]            ,
      [FillDateKey]           ,
      [FillTime]              ,
      [FillDateTime]          ,
      [PreviousFillDateTime]  ,
      [Litres]                ,
      [BaseCost]              ,
      [BaseCurrencyKey]       ,
      [FillOdometer]          ,
      [PreviousFillOdometer]  ,
      [EngineSeconds]         ,
      [PreviousEngineSeconds] ,
      [DistanceTravelled]     ,
      [FillFuelConsumption]   ,
      [ActivityDetailKey]     ,
      [FuelStopGeoLocationKey],
      [UTCOffsetKey]          ,
      [IsDeleted]             ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [VehicleKey]              = ISNULL(stg.[VehicleKey],-1) ,
        [FillDateKey]             = stg.[FillDateKey]           ,
        [FillTime]                = stg.[FillTime]              ,
        [FillDateTime]            = stg.[FillDateTime]          ,
        [PreviousFillDateTime]    = ISNULL(stg.[PreviousFillDateTime],@unknownDateDefault),
        [Litres]                  = stg.[Litres]                ,
        [BaseCost]                = stg.[BaseCost]              ,
        [BaseCurrencyKey]         = ISNULL(stg.[BaseCurrencyKey],-1),
        [FillOdometer]            = stg.[FillOdometer]          ,
        [PreviousFillOdometer]    = ISNULL(stg.[PreviousFillOdometer],stg.[FillOdometer]),
        [EngineSeconds]           = stg.[EngineSeconds],
        [PreviousEngineSeconds]   = ISNULL(stg.[PreviousEngineSeconds],stg.[EngineSeconds]),
        [DistanceTravelled]       = ISNULL(stg.[DistanceTravelled],0.0),
        [FillFuelConsumption]     = stg.[FillFuelConsumption]          ,
        [ActivityDetailKey]       = ISNULL(stg.[ActivityDetailKey],tar.[ActivityDetailKey]),
        [FuelStopGeoLocationKey]  = ISNULL(stg.[FuelStopGeoLocationKey],tar.[FuelStopGeoLocationKey]),
        [UTCOffsetKey]            = stg.[UTCOffsetKey]          ,
        [IsDeleted]               = 0                           ,
        [UpdateBatchKey]          = @batchKey
      OUTPUT
        DELETED.[FuelCapturekey]        ,
        DELETED.[OrganisationKey]       ,
        DELETED.[HostID]                ,
        DELETED.[VehicleKey]            ,
        DELETED.[FillDateKey]           ,
        DELETED.[FillTime]              ,
        DELETED.[FillDateTime]          ,
        DELETED.[PreviousFillDateTime]  ,
        DELETED.[Litres]                ,
        DELETED.[BaseCost]              ,
        DELETED.[BaseCurrencyKey]       ,
        DELETED.[FillOdometer]          ,
        DELETED.[PreviousFillOdometer]  ,
        DELETED.[EngineSeconds]         ,
        DELETED.[PreviousEngineSeconds] ,
        DELETED.[DistanceTravelled]     ,
        DELETED.[FillFuelConsumption]   ,
        DELETED.[ActivityDetailKey]     ,
        DELETED.[FuelStopGeoLocationKey],
        DELETED.[UTCOffsetKey]          ,
        DELETED.[IsDeleted]             ,
        DELETED.[CreateBatchKey]        ,
        DELETED.[UpdateBatchKey]
      FROM
        [MiXData].dbo.FACT_FuelCapture    AS tar WITH (NOLOCK)
          INNER JOIN
        [StageUser].[STAGE_FACT_FuelCapture] AS stg ON tar.HostID          = stg.HostID
                                                   AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation in ('I','U')
      ) AS upd;

    -- record number of records updated  
    SELECT @recordsUpdated = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;  
    END;  

    -- Deleted records
    INSERT INTO [StageUser].[ROLLBACK_FACT_FuelCapture]
    ( 
      [FuelCapturekey]        ,
      [OrganisationKey]       ,
      [HostID]                ,
      [VehicleKey]            ,
      [FillDateKey]           ,
      [FillTime]              ,
      [FillDateTime]          ,
      [PreviousFillDateTime]  ,
      [Litres]                ,
      [BaseCost]              ,
      [BaseCurrencyKey]       ,
      [FillOdometer]          ,
      [PreviousFillOdometer]  ,
      [EngineSeconds]         ,
      [PreviousEngineSeconds] ,
      [DistanceTravelled]     ,
      [FillFuelConsumption]   ,
      [ActivityDetailKey]     ,
      [FuelStopGeoLocationKey],
      [UTCOffsetKey]          ,
      [IsDeleted]             ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    )
    SELECT
      [FuelCapturekey]        ,
      [OrganisationKey]       ,
      [HostID]                ,
      [VehicleKey]            ,
      [FillDateKey]           ,
      [FillTime]              ,
      [FillDateTime]          ,
      [PreviousFillDateTime]  ,
      [Litres]                ,
      [BaseCost]              ,
      [BaseCurrencyKey]       ,
      [FillOdometer]          ,
      [PreviousFillOdometer]  ,
      [EngineSeconds]         ,
      [PreviousEngineSeconds] ,
      [DistanceTravelled]     ,
      [FillFuelConsumption]   ,
      [ActivityDetailKey]     ,
      [FuelStopGeoLocationKey],
      [UTCOffsetKey]          ,
      [IsDeleted]             ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]      = 1,
        [UpdateBatchKey] = @batchKey
      OUTPUT
        DELETED.[FuelCapturekey]        ,
        DELETED.[OrganisationKey]       ,
        DELETED.[HostID]                ,
        DELETED.[VehicleKey]            ,
        DELETED.[FillDateKey]           ,
        DELETED.[FillTime]              ,
        DELETED.[FillDateTime]          ,
        DELETED.[PreviousFillDateTime]  ,
        DELETED.[Litres]                ,
        DELETED.[BaseCost]              ,
        DELETED.[BaseCurrencyKey]       ,
        DELETED.[FillOdometer]          ,
        DELETED.[PreviousFillOdometer]  ,
        DELETED.[EngineSeconds]         ,
        DELETED.[PreviousEngineSeconds] ,
        DELETED.[DistanceTravelled]     ,
        DELETED.[FillFuelConsumption]   ,
        DELETED.[ActivityDetailKey]     ,
        DELETED.[FuelStopGeoLocationKey],
        DELETED.[UTCOffsetKey]          ,
        DELETED.[IsDeleted]             ,
        DELETED.[CreateBatchKey]        ,
        DELETED.[UpdateBatchKey]
      FROM
        [MiXData].dbo.FACT_FuelCapture    AS tar WITH (NOLOCK)
          INNER JOIN
        [StageUser].[STAGE_FACT_FuelCapture] AS stg ON tar.HostID          = stg.HostID
                                                   AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation = 'D'
      ) AS del;

    -- record number of records deleted  
    SELECT @recordsDeleted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;  
    END;  

    -- create rollback index  
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_FuelCapture_HostID  
      ON [StageUser].[ROLLBACK_FACT_FuelCapture](HostID);  

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_FuelCapture
    ( 
      [OrganisationKey]       ,
      [HostID]                ,
      [VehicleKey]            ,
      [FillDateKey]           ,
      [FillTime]              ,
      [FillDateTime]          ,
      [PreviousFillDateTime]  ,
      [Litres]                ,
      [BaseCost]              ,
      [BaseCurrencyKey]       ,
      [FillOdometer]          ,
      [PreviousFillOdometer]  ,
      [EngineSeconds]         ,
      [PreviousEngineSeconds] ,
      [DistanceTravelled]     ,
      [FillFuelConsumption]   ,
      [ActivityDetailKey]     ,
      [FuelStopGeoLocationKey],
      [UTCOffsetKey]          ,
      [IsDeleted]             ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey            ,
      stg.[HostID]                ,
      ISNULL(stg.[VehicleKey],-1) ,
      stg.[FillDateKey]           ,
      stg.[FillTime]              ,
      stg.[FillDateTime]          ,
      ISNULL(stg.[PreviousFillDateTime],@unknownDateDefault),
      stg.[Litres]                ,
      stg.[BaseCost]              ,
      ISNULL(stg.[BaseCurrencyKey],-1),
      stg.[FillOdometer]          ,
      ISNULL(stg.[PreviousFillOdometer],stg.[FillOdometer]),
      stg.[EngineSeconds]         ,
      ISNULL(stg.[PreviousEngineSeconds],stg.[EngineSeconds]),
      ISNULL(stg.[DistanceTravelled],0.0),
      [FillFuelConsumption]           ,
      ISNULL(stg.[ActivityDetailKey],-1),
      ISNULL(stg.[FuelStopGeoLocationKey],-1),
      stg.[UTCOffsetKey]          ,
      0                           , -- IsDeleted
      @batchKey                   ,
      @batchKey
    FROM
      [StageUser].[STAGE_FACT_FuelCapture]    AS stg
    WHERE
      stg.Operation in ('I','U')
    AND
      NOT EXISTS (SELECT 1
                  FROM
                    [StageUser].[ROLLBACK_FACT_FuelCapture] AS roll WITH (NOLOCK)
                  WHERE
                    stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_FuelCapture];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated + @recordsDeleted;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_PassengerActivities_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_PassengerActivities on DW
-- ==============================================================================
/*
  Dependencies:


*/
CREATE PROCEDURE [StageUser].[sprFACT_PassengerActivities_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected  int = 0;

  DECLARE	@currentDate        datetimeoffset; -- used for validation
  DECLARE @unknownDateDefault date = '00010101';

  SELECT @currentDate = SYSUTCDATETIME();

  CREATE TABLE #VehiclesLookup
  (
    VehicleKey   INT,
    HostID       INT,
    StartDateKey DATE,
    EndDateKey   DATE,
    PRIMARY KEY CLUSTERED (VehicleKey)
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_FACT_PassengerActivities];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_PassengerActivities];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create required source indexes
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser].[PassengerData]') AND name = N'IX_PassengerData_IdentifiedDate')
      CREATE NONCLUSTERED INDEX IX_PassengerData_IdentifiedDate
        ON [StageUser].PassengerData ( [IdentifiedDate] );

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_PassengerActivities]') AND name = N'IX_STAGE_FACT_PassengerActivities_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_PassengerActivities_HostID_Operation ON [StageUser].STAGE_FACT_PassengerActivities;

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_PassengerActivities]') AND name = N'IX_STAGE_FACT_PassengerActivities_IdentifiedDateKey')
      DROP INDEX IX_STAGE_FACT_PassengerActivities_IdentifiedDateKey ON [StageUser].STAGE_FACT_PassengerActivities;

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_PassengerActivities]') AND name = N'IX_STAGE_FACT_PassengerActivities_PassengerID_IdentifiedDateKey')
      DROP INDEX IX_STAGE_FACT_PassengerActivities_PassengerID_IdentifiedDateKey  ON [StageUser].STAGE_FACT_PassengerActivities;

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_PassengerActivities]') AND name = N'IX_STAGE_FACT_PassengerActivities_VehicleID_IdentifiedDateKey')
      DROP INDEX IX_STAGE_FACT_PassengerActivities_VehicleID_IdentifiedDateKey ON [StageUser].STAGE_FACT_PassengerActivities;

    -- insert changed records into STG
	  INSERT INTO [StageUser].[STAGE_FACT_PassengerActivities]
	  (
      Operation      ,
      HostID         ,
      PassengerID    ,
      VehicleID      ,
      Odometer       ,
      IdentifiedDateKey,
      IdentifiedTime   ,
      IdentifiedDateTime,
      UTCOffsetKey
	  )
	  SELECT
      s.Operation,
      HostID = s.RID  ,
      s.PassengerID   ,
      s.VehicleID     ,
      s.Odometer      ,
      ISNULL(CONVERT(DATE,s.IdentifiedDate),@unknownDateDefault),
      CONVERT(TIME(0),ISNULL(s.IdentifiedDate,0)),
      TODATETIMEOFFSET(s.IdentifiedDate,ISNULL(utc.UTCOffsetMinutes,0)),
      utc.UTCOffsetKey
	  FROM
	    [StageUser].PassengerData s WITH (NOLOCK)
	      CROSS JOIN
	    [StageUser].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
	  WHERE s.RID IS NOT NULL
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.IdentifiedDate),'19010101') BETWEEN utc.StartDateTime       AND utc.EndDateTime
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.IdentifiedDate),'19010101') BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create indexes required for lookups
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_PassengerActivities_HostID_Operation ON [StageUser].STAGE_FACT_PassengerActivities
    (HostID,Operation);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_PassengerActivities_IdentifiedDateKey ON [StageUser].STAGE_FACT_PassengerActivities
    (IdentifiedDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_PassengerActivities_PassengerID_IdentifiedDateKey  ON [StageUser].STAGE_FACT_PassengerActivities
    (PassengerID,IdentifiedDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_PassengerActivities_VehicleID_IdentifiedDateKey ON [StageUser].STAGE_FACT_PassengerActivities
    (VehicleID,IdentifiedDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
    END;

    ------------------------------------------
    -- VehicleKey
    INSERT INTO #VehiclesLookup
    ( VehicleKey,HostID,StartDateKey,EndDateKey )
    SELECT
      dvh.VehicleKey,
      dvh.HostID,
      dvh.StartDateKey,
      dvh.EndDateKey
    FROM
      [MiXData].dbo.DIM_Vehicles dvh WITH (NOLOCK)
    WHERE dvh.OrganisationKey = @organisationKey;

    UPDATE
      [StageUser].[STAGE_FACT_PassengerActivities]
    SET
      [VehicleKey] = dv.[VehicleKey]
    FROM
      [StageUser].[STAGE_FACT_PassengerActivities] stg
        INNER JOIN
      #VehiclesLookup dv
        ON stg.VehicleID      = dv.HostID
    WHERE stg.[IdentifiedDateKey] BETWEEN dv.StartDateKey AND dv.EndDateKey;

    ------------------------------------------
    -- PassengerKey
    UPDATE
      [StageUser].[STAGE_FACT_PassengerActivities]
    SET
      [PassengerKey] = dp.[PassengerKey]
    FROM
      [StageUser].[STAGE_FACT_PassengerActivities] stg
        INNER JOIN
      [MiXData].dbo.DIM_Passengers dp WITH (NOLOCK) ON dp.OrganisationKey = @organisationKey
                                                      AND stg.PassengerID    = dp.HostID
    WHERE stg.[IdentifiedDateKey] BETWEEN dp.StartDateKey AND dp.EndDateKey;

    ------------------------------------------
    -- ActivityDetailKey/ActivitySummaryKey/DriverKey
    UPDATE
      [StageUser].[STAGE_FACT_PassengerActivities]
    SET
      [ActivityDetailKey]   = fad.[ActivityDetailKey],
      [ActivitySummaryKey]  = fad.[ActivitySummaryKey]
    FROM
      #VehiclesLookup dv
        INNER JOIN
      [StageUser].[STAGE_FACT_PassengerActivities] stg        ON stg.VehicleID = dv.HostID
        INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK) ON fad.OrganisationKey = @organisationKey
                                                             AND fad.VehicleKey      = dv.VehicleKey
    WHERE stg.IdentifiedDateTime IS NOT NULL
    AND stg.[IdentifiedDateTime] BETWEEN fad.ActivityStartDateTime AND fad.NextMovementStartDateTime;


    ------------------------------------------
    -- RankNo (based on PassengerID,ActivitySummaryKey ordered by IdentifiedDate,HostID)
 

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  --BEGIN TRY

 
  --  IF @debugMode = 1  -- DebugMode is true
  --    PRINT N'4. Validation before Loading to DW';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
  --  EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
  --  RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    INSERT [StageUser].ROLLBACK_FACT_PassengerActivities
    (
      PassengerActivityKey,
      OrganisationKey     ,
      HostID              ,
      PassengerKey        ,
      VehicleKey          ,
      ActivitySummaryKey  ,
      ActivityDetailKey   ,
      IdentifiedDateKey   ,
      IdentifiedTime      ,
      IdentifiedDateTime  ,
      Odometer            ,
      UTCOffsetKey        ,
      IsDeleted           ,
      CreateBatchKey      ,
      UpdateBatchKey
    )
    SELECT
      PassengerActivityKey,
      OrganisationKey     ,
      HostID              ,
      PassengerKey        ,
      VehicleKey          ,
      ActivitySummaryKey  ,
      ActivityDetailKey   ,
      IdentifiedDateKey   ,
      IdentifiedTime      ,
      IdentifiedDateTime  ,
      Odometer            ,
      UTCOffsetKey        ,
      IsDeleted           ,
      CreateBatchKey      ,
      UpdateBatchKey
    FROM
      ( MERGE [MiXData].dbo.FACT_PassengerActivities tar
        USING [StageUser].[STAGE_FACT_PassengerActivities] stg
           ON tar.OrganisationKey = @organisationKey
          AND tar.HostID          = stg.HostID
        WHEN MATCHED THEN                           -- update existing records to FACT
          UPDATE
          SET tar.PassengerKey       = ISNULL(stg.PassengerKey,-1),
              tar.VehicleKey         = ISNULL(stg.VehicleKey,-1),
              tar.ActivitySummaryKey = ISNULL(stg.ActivitySummaryKey,-1),
              tar.ActivityDetailKey  = ISNULL(stg.ActivityDetailKey,-1),
              tar.IdentifiedDateKey  = stg.IdentifiedDateKey ,
              tar.IdentifiedTime     = stg.IdentifiedTime    ,
              tar.IdentifiedDateTime = stg.IdentifiedDateTime,
              tar.Odometer           = stg.Odometer          ,
              tar.UTCOffsetKey       = stg.UTCOffsetKey      ,
              tar.IsDeleted          = CASE WHEN stg.Operation = 'D' THEN CONVERT(BIT,1) ELSE 0 END,
              tar.UpdateBatchKey     = @batchKey
        WHEN NOT MATCHED AND stg.Operation IN ('U','I') THEN -- insert new records to FACT
          INSERT
          (
            OrganisationKey   ,
            HostID            ,
            PassengerKey      ,
            VehicleKey        ,
            ActivitySummaryKey,
            ActivityDetailKey ,
            IdentifiedDateKey ,
            IdentifiedTime    ,
            IdentifiedDateTime,
            Odometer          ,
            UTCOffsetKey      ,
            IsDeleted        ,
            CreateBatchKey   ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey      ,
            stg.HostID            ,
            ISNULL(stg.PassengerKey,-1),
            ISNULL(stg.VehicleKey,-1),
            ISNULL(stg.ActivitySummaryKey,-1),
            ISNULL(stg.ActivityDetailKey ,-1),
            stg.IdentifiedDateKey ,
            stg.IdentifiedTime    ,
            stg.IdentifiedDateTime,
            stg.Odometer          ,
            stg.UTCOffsetKey      ,
            0,
            @batchKey,
            @batchKey
          )
        OUTPUT
          $action   AS Operation,
          DELETED.PassengerActivityKey,
          DELETED.OrganisationKey     ,
          DELETED.HostID              ,
          DELETED.PassengerKey        ,
          DELETED.VehicleKey          ,
          DELETED.ActivitySummaryKey  ,
          DELETED.ActivityDetailKey   ,
          DELETED.IdentifiedDateKey   ,
          DELETED.IdentifiedTime      ,
          DELETED.IdentifiedDateTime  ,
          DELETED.Odometer            ,
          DELETED.UTCOffsetKey        ,
          DELETED.IsDeleted           ,
          DELETED.CreateBatchKey      ,
          DELETED.UpdateBatchKey
        ) Rollbck
    WHERE Operation = 'UPDATE';

    SELECT @recordsUpdated = COUNT(1)
    FROM [StageUser].ROLLBACK_FACT_PassengerActivities rll;
    SELECT @recordsInserted = COUNT(1)
    FROM [StageUser].STAGE_FACT_PassengerActivities stg
    WHERE Operation IN ('U','I');

    -- record number of records deleted
    SELECT @recordsDeleted = COUNT(1)
    FROM [StageUser].STAGE_FACT_PassengerActivities stg
    WHERE Operation = 'D';

    -- record number of records inserted
    SELECT @recordsInserted = CASE WHEN (@recordsInserted - @recordsUpdated) < 0 THEN 0 ELSE @recordsInserted - @recordsUpdated END;

    -- record number of records updated
    SELECT @recordsUpdated  = CASE WHEN @recordsUpdated  - @recordsDeleted   < 0 THEN 0 ELSE @recordsUpdated  - @recordsDeleted END;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'5.1 Merge Records';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_PassengerActivities];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_ProfileDetails_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_ProfileDetails on DW
-- ==============================================================================
/*
  Dependencies:

    FACT_ActivitySummary
    FACT_ActivityDetails
    DIM_CalibrationParameters
    DIM_VehicleProfiles

    ProfileData

*/
CREATE PROCEDURE [StageUser].[sprFACT_ProfileDetails_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;

  DECLARE @nrOfrecordsAffected int  = 0;
  DECLARE @unknownDateDefault  date = '00010101';
  DECLARE	@currentDate         datetimeoffset = SYSUTCDATETIME(); -- used for validation

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_FACT_ProfileDetails];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_ProfileDetails];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM [sys].indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ProfileDetails]') AND name = N'IX_STAGE_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID')
      DROP INDEX IX_STAGE_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID ON [StageUser].[STAGE_FACT_ProfileDetails];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_ProfileDetails]') AND name = N'IX_ROLLBACK_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID')
      DROP INDEX IX_ROLLBACK_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID ON [StageUser].[ROLLBACK_FACT_ProfileDetails];

    -- create source indexes before insert
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser].ProfileData') AND name = N'IX_ProfileData_TripID_SubTripSequence_ParameterID_Sequence')
      CREATE INDEX IX_ProfileData_TripID_SubTripSequence_ParameterID_Sequence 
        ON [StageUser].ProfileData (TripID,SubTripSequence,ParameterID,[Sequence])
        INCLUDE (Operation);

    -- insert changed records into STG
    WITH 
      ProfileData AS
      ( SELECT
          s.Operation                        ,
          HostTripID      = s.TripID         ,
          HostSequenceID  = s.SubTripSequence,
          HostParameterID = s.ParameterID    ,
          RangeDuration0     = CASE
                                 WHEN s.Sequence = 0 THEN 
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration1     = CASE
                                 WHEN s.Sequence = 1 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration2     = CASE
                                 WHEN s.Sequence = 2 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration3     = CASE
                                 WHEN s.Sequence = 3 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration4     = CASE
                                 WHEN s.Sequence = 4 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration5     = CASE
                                 WHEN s.Sequence = 5 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration6     = CASE
                                 WHEN s.Sequence = 6 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration7     = CASE
                                 WHEN s.Sequence = 7 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration8     = CASE
                                 WHEN s.Sequence = 8 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration9     = CASE
                                 WHEN s.Sequence = 9 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration10    = CASE
                                 WHEN s.Sequence = 10 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration11    = CASE
                                 WHEN s.Sequence = 11 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END
        --  Duration-- select *
        FROM
          [StageUser].ProfileData s
      )
    INSERT INTO [StageUser].STAGE_FACT_ProfileDetails
    (
--      Operation      ,
      HostTripID     ,
      HostSequenceID ,
      HostParameterID,
      RangeDuration0 , 
      RangeDuration1 , 
      RangeDuration2 , 
      RangeDuration3 , 
      RangeDuration4 , 
      RangeDuration5 , 
      RangeDuration6 , 
      RangeDuration7 , 
      RangeDuration8 , 
      RangeDuration9 , 
      RangeDuration10, 
      RangeDuration11 
    )
    SELECT
--      pd.Operation                             ,
      pd.HostTripID                            ,
      pd.HostSequenceID                        ,
      pd.HostParameterID                       ,
      RangeDuration0  = MAX(pd.RangeDuration0) ,
      RangeDuration1  = MAX(pd.RangeDuration1) ,
      RangeDuration2  = MAX(pd.RangeDuration2) ,
      RangeDuration3  = MAX(pd.RangeDuration3) ,
      RangeDuration4  = MAX(pd.RangeDuration4) ,
      RangeDuration5  = MAX(pd.RangeDuration5) ,
      RangeDuration6  = MAX(pd.RangeDuration6) ,
      RangeDuration7  = MAX(pd.RangeDuration7) ,
      RangeDuration8  = MAX(pd.RangeDuration8) ,
      RangeDuration9  = MAX(pd.RangeDuration9) ,
      RangeDuration10 = MAX(pd.RangeDuration10),
      RangeDuration11 = MAX(pd.RangeDuration11)
    FROM
      ProfileData pd
    GROUP BY
--      Operation      ,
      HostTripID     ,
      HostSequenceID ,
      HostParameterID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;
    
    -- remove source index
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].ProfileData') AND name = N'IX_ProfileData_TripID_SubTripSequence_ParameterID_Sequence')
      DROP INDEX IX_ProfileData_TripID_SubTripSequence_ParameterID_Sequence ON [StageUser].ProfileData;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID
      ON [StageUser].[STAGE_FACT_ProfileDetails](HostTripID,HostSequenceID,HostParameterID);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
    END;

    ------------------------------------------
    -- ActivityDetails Data
    ;WITH Activity AS
    (
      SELECT
        stg1.HostTripID,
        stg1.HostSequenceID,
        ActivityDetailKey = ( SELECT MIN(fad1.ActivityDetailKey)
                              FROM
                                [MiXData].dbo.FACT_ActivitySummary fas1 WITH (NOLOCK)
                                  INNER JOIN
                                [MiXData].dbo.FACT_ActivityDetails fad1 WITH (NOLOCK) ON fad1.ActivitySummaryKey = fas1.ActivitySummaryKey
                                                                                     AND fad1.HostID             = stg1.HostSequenceID
                              WHERE
                                  fas1.OrganisationKey = @organisationKey
                              AND fas1.HostID          = stg1.HostTripID)
      FROM
        [StageUser].[STAGE_FACT_ProfileDetails] stg1
    )
    UPDATE
      [StageUser].[STAGE_FACT_ProfileDetails]
    SET
      [ActivityDetailKey] = fad.[ActivityDetailKey]    ,
      [VehicleKey]        = fad.[VehicleKey]           ,
      [StartDateKey]      = fad.[ActivityStartDateKey] ,
      [EndDateKey]        = fad.[ActivityEndDateKey]   ,
      [StartTime]         = fad.[ActivityStartTime]    ,
      [EndTime]           = fad.[ActivityEndTime]      ,
      [StartDateTime]     = fad.[ActivityStartDateTime],
      [EndDateTime]       = fad.[ActivityEndDateTime]  ,
      [UTCOffsetKey]      = fad.[UTCOffsetKey]
    FROM
      [StageUser].[STAGE_FACT_ProfileDetails] stg
        INNER JOIN
      Activity                                a   ON a.HostTripID     = stg.HostTripID
                                                 AND a.HostSequenceID = stg.HostSequenceID
        INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails      fad WITH (NOLOCK) ON fad.ActivityDetailKey = a.ActivityDetailKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update calculated cols - ActivityDetails Data', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;
    
    -- Remove from STAGE where Activity does not exist
    DELETE [StageUser].[STAGE_FACT_ProfileDetails]
    WHERE [ActivityDetailKey] IS NULL;
    
    ------------------------------------------
    -- ParameterKey
    UPDATE
      [StageUser].[STAGE_FACT_ProfileDetails]
    SET
      [ParameterKey] = dpr.[ParameterKey]
    FROM
      [StageUser].[STAGE_FACT_ProfileDetails]      stg
        INNER JOIN
      [MiXData].[dbo].DIM_CalibrationParameters dpr WITH (NOLOCK) ON @organisationKey    = dpr.OrganisationKey
                                                                    AND stg.HostParameterID = dpr.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3 Update calculated cols - ParameterKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- VehicleProfileKey
    UPDATE
      [StageUser].[STAGE_FACT_ProfileDetails]
    SET
      [VehicleProfileKey] = dvp.[VehicleProfileKey]
    FROM
      [StageUser].[STAGE_FACT_ProfileDetails]  stg
        INNER JOIN
      [MiXData].[dbo].DIM_Vehicles          dvh WITH (NOLOCK) ON stg.VehicleKey      = dvh.VehicleKey
        INNER JOIN
      [MiXData].[dbo].DIM_VehicleProfiles   dvp WITH (NOLOCK) ON dvp.OrganisationKey  = @organisationKey
                                                                 AND dvh.VehicleGUID     = dvp.VehicleGUID
                                                                 AND stg.ParameterKey    = dvp.ParameterKey
    WHERE
      stg.StartDateKey BETWEEN dvp.StartDateKey AND dvp.EndDateKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.4 Update calculated cols - VehicleProfileKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Changed records
    INSERT INTO [StageUser].[ROLLBACK_FACT_ProfileDetails]
    ( 
      ProfileDetailKey  ,
      OrganisationKey   ,
      HostTripID        ,
      HostSequenceID    ,
      HostParameterID   ,
      VehicleKey        ,
      ParameterKey      ,
      VehicleProfileKey ,
      ActivityDetailKey ,
      StartDateKey      ,
      StartTime         ,
      StartDateTime     ,
      EndDateKey        ,
      EndTime           ,
      EndDateTime       ,
      RangeDuration0    ,
      RangeDuration1    ,
      RangeDuration2    ,
      RangeDuration3    ,
      RangeDuration4    ,
      RangeDuration5    ,
      RangeDuration6    ,
      RangeDuration7    ,
      RangeDuration8    ,
      RangeDuration9    ,
      RangeDuration10   ,
      RangeDuration11   ,
      UTCOffsetKey      ,
      CreateBatchKey    ,
      UpdateBatchKey
    )
    SELECT
      ProfileDetailKey  ,
      OrganisationKey   ,
      HostTripID        ,
      HostSequenceID    ,
      HostParameterID   ,
      VehicleKey        ,
      ParameterKey      ,
      VehicleProfileKey ,
      ActivityDetailKey ,
      StartDateKey      ,
      StartTime         ,
      StartDateTime     ,
      EndDateKey        ,
      EndTime           ,
      EndDateTime       ,
      RangeDuration0    ,
      RangeDuration1    ,
      RangeDuration2    ,
      RangeDuration3    ,
      RangeDuration4    ,
      RangeDuration5    ,
      RangeDuration6    ,
      RangeDuration7    ,
      RangeDuration8    ,
      RangeDuration9    ,
      RangeDuration10   ,
      RangeDuration11   ,
      UTCOffsetKey      ,
      CreateBatchKey    ,
      UpdateBatchKey
    FROM
     (UPDATE
        tar
      SET
        VehicleKey          = ISNULL(stg.VehicleKey        ,-1),
        ParameterKey        = ISNULL(stg.ParameterKey      ,-1),
        VehicleProfileKey   = ISNULL(stg.VehicleProfileKey ,-1),
        ActivityDetailKey   = ISNULL(stg.ActivityDetailKey ,-1),
        StartDateKey        = stg.StartDateKey      ,
        StartTime           = stg.StartTime         ,
        StartDateTime       = stg.StartDateTime     ,
        EndDateKey          = stg.EndDateKey        ,
        EndTime             = stg.EndTime           ,
        EndDateTime         = stg.EndDateTime       ,
        RangeDuration0      = ISNULL(stg.RangeDuration0    , tar.RangeDuration0  ),
        RangeDuration1      = ISNULL(stg.RangeDuration1    , tar.RangeDuration1  ),
        RangeDuration2      = ISNULL(stg.RangeDuration2    , tar.RangeDuration2  ),
        RangeDuration3      = ISNULL(stg.RangeDuration3    , tar.RangeDuration3  ),
        RangeDuration4      = ISNULL(stg.RangeDuration4    , tar.RangeDuration4  ),
        RangeDuration5      = ISNULL(stg.RangeDuration5    , tar.RangeDuration5  ),
        RangeDuration6      = ISNULL(stg.RangeDuration6    , tar.RangeDuration6  ),
        RangeDuration7      = ISNULL(stg.RangeDuration7    , tar.RangeDuration7  ),
        RangeDuration8      = ISNULL(stg.RangeDuration8    , tar.RangeDuration8  ),
        RangeDuration9      = ISNULL(stg.RangeDuration9    , tar.RangeDuration9  ),
        RangeDuration10     = ISNULL(stg.RangeDuration10   , tar.RangeDuration10 ),
        RangeDuration11     = ISNULL(stg.RangeDuration11   , tar.RangeDuration11 ),
        UTCOffsetKey        = stg.UTCOffsetKey      ,
        UpdateBatchKey      = @batchKey
      OUTPUT
        DELETED.ProfileDetailKey  ,
        DELETED.OrganisationKey   ,
        DELETED.HostTripID        ,
        DELETED.HostSequenceID    ,
        DELETED.HostParameterID   ,
        DELETED.VehicleKey        ,
        DELETED.ParameterKey      ,
        DELETED.VehicleProfileKey ,
        DELETED.ActivityDetailKey ,
        DELETED.StartDateKey      ,
        DELETED.StartTime         ,
        DELETED.StartDateTime     ,
        DELETED.EndDateKey        ,
        DELETED.EndTime           ,
        DELETED.EndDateTime       ,
        DELETED.RangeDuration0    ,
        DELETED.RangeDuration1    ,
        DELETED.RangeDuration2    ,
        DELETED.RangeDuration3    ,
        DELETED.RangeDuration4    ,
        DELETED.RangeDuration5    ,
        DELETED.RangeDuration6    ,
        DELETED.RangeDuration7    ,
        DELETED.RangeDuration8    ,
        DELETED.RangeDuration9    ,
        DELETED.RangeDuration10   ,
        DELETED.RangeDuration11   ,
        DELETED.UTCOffsetKey      ,
        DELETED.CreateBatchKey    ,
        DELETED.UpdateBatchKey
      FROM 
       [MiXData].dbo.FACT_ProfileDetails    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser].[STAGE_FACT_ProfileDetails] AS stg ON tar.HostTripID      = stg.HostTripID
                                                     AND tar.HostSequenceID  = stg.HostSequenceID
                                                     AND tar.HostParameterID = stg.HostParameterID
                                                     AND tar.OrganisationKey = @organisationKey
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID
      ON [StageUser].[ROLLBACK_FACT_ProfileDetails](HostTripID,HostSequenceID,HostParameterID);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_ProfileDetails
    ( 
      OrganisationKey   ,
      HostTripID        ,
      HostSequenceID    ,
      HostParameterID   ,
      VehicleKey        ,
      ParameterKey      ,
      VehicleProfileKey ,
      ActivityDetailKey ,
      StartDateKey      ,
      StartTime         ,
      StartDateTime     ,
      EndDateKey        ,
      EndTime           ,
      EndDateTime       ,
      RangeDuration0    ,
      RangeDuration1    ,
      RangeDuration2    ,
      RangeDuration3    ,
      RangeDuration4    ,
      RangeDuration5    ,
      RangeDuration6    ,
      RangeDuration7    ,
      RangeDuration8    ,
      RangeDuration9    ,
      RangeDuration10   ,
      RangeDuration11   ,
      UTCOffsetKey      ,
      CreateBatchKey    ,
      UpdateBatchKey
    )
    SELECT
      @organisationKey      ,
      stg.HostTripID        ,
      stg.HostSequenceID    ,
      stg.HostParameterID   ,
      ISNULL(stg.VehicleKey        ,-1),
      ISNULL(stg.ParameterKey      ,-1),
      ISNULL(stg.VehicleProfileKey ,-1),
      ISNULL(stg.ActivityDetailKey ,-1),
      stg.StartDateKey      ,
      stg.StartTime         ,
      stg.StartDateTime     ,
      stg.EndDateKey        ,
      stg.EndTime           ,
      stg.EndDateTime       ,
      ISNULL(stg.RangeDuration0 , 0),
      ISNULL(stg.RangeDuration1 , 0),
      ISNULL(stg.RangeDuration2 , 0),
      ISNULL(stg.RangeDuration3 , 0),
      ISNULL(stg.RangeDuration4 , 0),
      ISNULL(stg.RangeDuration5 , 0),
      ISNULL(stg.RangeDuration6 , 0),
      ISNULL(stg.RangeDuration7 , 0),
      ISNULL(stg.RangeDuration8 , 0),
      ISNULL(stg.RangeDuration9 , 0),
      ISNULL(stg.RangeDuration10, 0),
      ISNULL(stg.RangeDuration11, 0),
      stg.UTCOffsetKey      ,
      @batchKey             ,
      @batchKey
    FROM
      [StageUser].[STAGE_FACT_ProfileDetails]    AS stg
    WHERE
      NOT EXISTS (SELECT 1
                    FROM
                      [StageUser].[ROLLBACK_FACT_ProfileDetails] AS roll WITH (NOLOCK)
                    WHERE
                        stg.HostTripID      = roll.HostTripID
                    AND stg.HostSequenceID  = roll.HostSequenceID
                    AND stg.HostParameterID = roll.HostParameterID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_ProfileDetails];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_ServiceHistory_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_ServiceHistory on DW
-- ==============================================================================
/*
  Dependencies:


*/
CREATE PROCEDURE [StageUser].[sprFACT_ServiceHistory_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE	@currentDate        datetimeoffset; -- used for validation

  SELECT @currentDate = SYSUTCDATETIME();
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_FACT_ServiceHistory];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_ServiceHistory];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_ServiceHistory]') AND name = N'IX_ROLLBACK_FACT_ServiceHistory_HostID')
      DROP INDEX IX_ROLLBACK_FACT_ServiceHistory_HostID ON [StageUser].[ROLLBACK_FACT_ServiceHistory];
  
    -- insert changed records into STG
	  INSERT INTO [StageUser].[STAGE_FACT_ServiceHistory]
	  ( 
	    [Operation]      ,
      [HostID]         ,
      [VehicleID]      ,
      [ServiceDateKey] ,
      [ServiceDateTime],
      [Odometer]       ,
      [EngineSeconds]  ,
      [Reference]      ,
      [BaseCost]       ,
      [BaseCurrency]   ,
      [Notes]          ,
      [UTCOffsetKey]
	  )
	  SELECT
	    s.Operation                  ,
      HostID = s.liServiceKey      ,
      s.iVehicleID                 ,
      CONVERT(DATE,s.dtServiceDate),
      CASE 
        WHEN s.dtServiceDate IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.dtServiceDate,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      s.fOdometer                  ,
      s.liEngineSeconds            ,
      s.sReference                 ,
      s.fBaseCost                  ,
      s.sBaseCur                   ,
      s.sNotes                     ,
      utc.UTCOffsetKey
	  FROM
	    [StageUser].ServiceHistory s WITH (NOLOCK)
	      CROSS JOIN
	    [StageUser].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
	  WHERE
        ISNULL(CONVERT(DATETIMEOFFSET(0),s.dtServiceDate),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.dtServiceDate),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    ------------------------------------------
    -- VehicleKey
    UPDATE
      [StageUser].[STAGE_FACT_ServiceHistory]
    SET
      [VehicleKey] = dv.[VehicleKey]
    FROM
      [StageUser].[STAGE_FACT_ServiceHistory] stg
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles      dv  WITH (NOLOCK)
        ON  dv.OrganisationKey = @organisationKey
        AND stg.VehicleID      = dv.HostID
    WHERE
      stg.ServiceDateKey BETWEEN dv.StartDateKey AND dv.EndDateKey;

    ------------------------------------------
    -- BaseCurrrencyKey
    UPDATE
      [StageUser].[STAGE_FACT_ServiceHistory]
    SET
      [BaseCurrencyKey] = dc.[CurrencyKey]
    FROM
      [StageUser].[STAGE_FACT_ServiceHistory] stg
        INNER JOIN
      [MiXData].dbo.DIM_Currencies      dc WITH (NOLOCK)
        ON  dc.[CurrencyAlternateKey] = stg.[BaseCurrency];

    ------------------------------------------
    -- UTCOffsetKey (use company UTC for now, will change in future)
/*    
    UPDATE [StageUser].[STAGE_FACT_ServiceHistory]
    SET
      UTCOffsetKey = utc.UTCOffsetKey
    FROM
      [StageUser].[STAGE_FACT_ServiceHistory] stg,
      [StageUser].STAGE_DIM_UTCOffsetsLookUp utc WITH (NOLOCK)
    WHERE
      stg.ServiceDateKey BETWEEN utc.StartDateKey    AND utc.EndDateKey
    AND
      stg.ServiceDateKey BETWEEN utc.SeasonStartDate AND utc.SeasonEndDate;
*/

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Changed records
    INSERT INTO [StageUser].[ROLLBACK_FACT_ServiceHistory]
    ( 
      [ServiceHistoryKeyID],
      [OrganisationKey]    ,
      [HostID]             ,
      [VehicleKey]         ,
      [ServiceDateKey]     ,
      [ServiceDateTime]    ,
      [Odometer]           ,
      [EngineSeconds]      ,
      [Reference]          ,
      [BaseCost]           ,
      [BaseCurrencyKey]    ,
      [Notes]              ,
      [UTCOffsetKey]       ,
      [IsDeleted]          ,
      [CreateBatchKey]     ,
      [UpdateBatchKey]
    )
    SELECT
      [ServiceHistoryKeyID],
      [OrganisationKey]    ,
      [HostID]             ,
      [VehicleKey]         ,
      [ServiceDateKey]     ,
      [ServiceDateTime]    ,
      [Odometer]           ,
      [EngineSeconds]      ,
      [Reference]          ,
      [BaseCost]           ,
      [BaseCurrencyKey]    ,
      [Notes]              ,
      [UTCOffsetKey]       ,
      [IsDeleted]          ,
      [CreateBatchKey]     ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [VehicleKey]       = ISNULL(stg.[VehicleKey]     ,-1),
        [ServiceDateKey]   = stg.[ServiceDateKey] ,
        [ServiceDateTime]  = stg.[ServiceDateTime],
        [Odometer]         = stg.[Odometer]       ,
        [EngineSeconds]    = stg.[EngineSeconds]  ,
        [Reference]        = stg.[Reference]      ,
        [BaseCost]         = stg.[BaseCost]       ,
        [BaseCurrencyKey]  = ISNULL(stg.[BaseCurrencyKey],-1),
        [Notes]            = stg.[Notes]          ,
        [UTCOffsetKey]     = stg.[UTCOffsetKey]   ,
        [UpdateBatchKey]   = @batchKey
      OUTPUT
        DELETED.[ServiceHistoryKeyID],
        DELETED.[OrganisationKey]    ,
        DELETED.[HostID]             ,
        DELETED.[VehicleKey]         ,
        DELETED.[ServiceDateKey]     ,
        DELETED.[ServiceDateTime]    ,
        DELETED.[Odometer]           ,
        DELETED.[EngineSeconds]      ,
        DELETED.[Reference]          ,
        DELETED.[BaseCost]           ,
        DELETED.[BaseCurrencyKey]    ,
        DELETED.[Notes]              ,
        DELETED.[UTCOffsetKey]       ,
        DELETED.IsDeleted            ,
        DELETED.[CreateBatchKey]     ,
        DELETED.[UpdateBatchKey]
      FROM 
       [MiXData].dbo.FACT_ServiceHistory    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser].[STAGE_FACT_ServiceHistory] AS stg ON tar.HostID          = stg.HostID
                                                     AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation in ('I','U')
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;  
    END;  

    -- Deleted records
    INSERT INTO [StageUser].[ROLLBACK_FACT_ServiceHistory]
    ( 
      [ServiceHistoryKeyID],
      [OrganisationKey]    ,
      [HostID]             ,
      [VehicleKey]         ,
      [ServiceDateKey]     ,
      [ServiceDateTime]    ,
      [Odometer]           ,
      [EngineSeconds]      ,
      [Reference]          ,
      [BaseCost]           ,
      [BaseCurrencyKey]    ,
      [Notes]              ,
      [UTCOffsetKey]       ,
      [IsDeleted]          ,
      [CreateBatchKey]     ,
      [UpdateBatchKey]
    )
    SELECT
      [ServiceHistoryKeyID],
      [OrganisationKey]    ,
      [HostID]             ,
      [VehicleKey]         ,
      [ServiceDateKey]     ,
      [ServiceDateTime]    ,
      [Odometer]           ,
      [EngineSeconds]      ,
      [Reference]          ,
      [BaseCost]           ,
      [BaseCurrencyKey]    ,
      [Notes]              ,
      [UTCOffsetKey]       ,
      [IsDeleted]          ,
      [CreateBatchKey]     ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]       = 1,
        [UpdateBatchKey]  = @batchKey
      OUTPUT
        DELETED.[ServiceHistoryKeyID],
        DELETED.[OrganisationKey]    ,
        DELETED.[HostID]             ,
        DELETED.[VehicleKey]         ,
        DELETED.[ServiceDateKey]     ,
        DELETED.[ServiceDateTime]    ,
        DELETED.[Odometer]           ,
        DELETED.[EngineSeconds]      ,
        DELETED.[Reference]          ,
        DELETED.[BaseCost]           ,
        DELETED.[BaseCurrencyKey]    ,
        DELETED.[Notes]              ,
        DELETED.[UTCOffsetKey]       ,
        DELETED.[IsDeleted]          ,
        DELETED.[CreateBatchKey]     ,
        DELETED.[UpdateBatchKey]
      FROM 
       [MiXData].dbo.FACT_ServiceHistory    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser].[STAGE_FACT_ServiceHistory] AS stg ON tar.HostID          = stg.HostID
                                                     AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation = 'D'
      ) AS del;

    -- record number of records deleted
    SELECT @recordsDeleted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;  
    END;  

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_ServiceHistory_HostID
      ON [StageUser].[ROLLBACK_FACT_ServiceHistory](HostID);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_ServiceHistory
    ( 
      [OrganisationKey],
      [HostID]         ,
      [VehicleKey]     ,
      [ServiceDateKey] ,
      [ServiceDateTime],
      [Odometer]       ,
      [EngineSeconds]  ,
      [Reference]      ,
      [BaseCost]       ,
      [BaseCurrencyKey],
      [Notes]          ,
      [UTCOffsetKey]   ,
      [IsDeleted]      ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey     ,
      stg.[HostID]         ,
      ISNULL(stg.[VehicleKey]     ,-1),
      stg.[ServiceDateKey] ,
      stg.[ServiceDateTime],
      stg.[Odometer]       ,
      stg.[EngineSeconds]  ,
      stg.[Reference]      ,
      stg.[BaseCost]       ,
      ISNULL(stg.[BaseCurrencyKey],-1),
      stg.[Notes]          ,
      stg.[UTCOffsetKey]   ,
      IsDeleted = 0        ,
      @batchKey            ,
      @batchKey
    FROM
      [StageUser].[STAGE_FACT_ServiceHistory]    AS stg
    WHERE
        stg.Operation IN ('I','U')
    AND NOT EXISTS (SELECT 1
                    FROM
                      [StageUser].[ROLLBACK_FACT_ServiceHistory] AS roll WITH (NOLOCK)
                    WHERE
                      stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_ServiceHistory];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_ShapeVisits_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_ShapeVisits on DW
-- ==============================================================================
/*
  Dependencies:

   FACT_ActivityDetails
   
   STAGE_FACT_ActivityDetails

*/
CREATE PROCEDURE [StageUser].[sprFACT_ShapeVisits_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int   = 0;
  DECLARE @unknownDateDefault  date   = '00010101';
  DECLARE @maxDuration         bigint = 2147483647; -- this is the max int data type value
  DECLARE @maxDurationYears    int  = 68; -- anything bigger than 68 causes overflow of int datatype
  DECLARE @maxFuelLimit        int  = 99999.0; -- anything bigger than 68 causes overflow of int datatype  
  DECLARE @currentDate         datetimeoffset = SYSUTCDATETIME(); -- used for validation
  DECLARE @flagStartTime       datetimeoffset(0) = SYSUTCDATETIME();
  DECLARE @flagSeq             smallint = 1;
  
  CREATE TABLE #newChangedShapes
  (
    ShapeKey int
  );

  CREATE TABLE #ActivityChangedDates
  (
    VehicleKey           INT,
    ActivityStartDateKey DATE
  );

  -- used for temporary storage
  CREATE TABLE #activityDetails
  (
    ActivityDetailKey             bigint,
    NextMovementActivityDetailKey bigint,
    ActivityStartDateKey          date,
    VehicleKey                    int,
    DriverKey                     int,
    UTCOffsetKey                  int,
    DurationAtLocation            int,
    EndGeoLocationKey             bigint
  );

  CREATE TABLE #activityDetailsChanged
  (
    ActivityDetailKey             bigint,
    NextMovementActivityDetailKey bigint,
    ActivityStartDateKey          date,
    VehicleKey                    int,
    DriverKey                     int,
    UTCOffsetKey                  int,
    DurationAtLocation            int,
    EndGeoLocationKey             bigint
  );

  -- used for temporary storage
  CREATE TABLE #activityEndGeoLocation
  (
    EndGeoLocationKey  bigint,
    EndShapeKey        int
  );
  
  CREATE TABLE #VehiclesLookup
  (
    VehicleKey INT NOT NULL,
    HostID     INT NOT NULL
  );

  CREATE TABLE #ShapesLookup
  (
    ShapeKey INT NOT NULL
  );

  CREATE TABLE #DuplicateActivityShapes
  (
    VehicleKey                    int,
    DriverKey                     int,
    ActivityStartDateKey          date,
    ActivityDetailKey             bigint,
    NextMovementActivityDetailKey bigint,
    EndShapeKey                   int,
    NMEndShapeKey                 int
  );

  CREATE TABLE #DeDuplicatedActivityShapes
  (
    VehicleKey                    int,
    DriverKey                     int,
    ActivityStartDateKey          date,
    ActivityDetailKey             bigint,
    NextMovementActivityDetailKey bigint,
    EndShapeKey                   int,
    NMEndShapeKey                 int
  );

  CREATE TABLE #rollback
  (
    HostID       BIGINT
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_FACT_ShapeVisits];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_ShapeVisits];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY


    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ShapeVisits]') AND name = N'IX_STAGE_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey')
      DROP INDEX IX_STAGE_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey ON [StageUser].[STAGE_FACT_ShapeVisits];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_ShapeVisits]') AND name = N'IX_ROLLBACK_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey')
      DROP INDEX IX_ROLLBACK_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey ON [StageUser].[ROLLBACK_FACT_ShapeVisits];

    -- create STAGE indexes
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey_VehicleKey')
      CREATE INDEX IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey_VehicleKey
        ON [StageUser].STAGE_FACT_ActivityDetails(ActivityStartDateKey,VehicleKey);

    INSERT INTO #newChangedShapes (ShapeKey)
    SELECT DISTINCT
      dsh.ShapeKey
    FROM
      [StageUser].STAGE_DIM_Shapes ssh WITH (NOLOCK)
        INNER JOIN
      [MiXData].dbo.DIM_Shapes      dsh WITH (NOLOCK) ON dsh.OrganisationKey = @organisationKey
                                                     AND dsh.HostID          = ssh.HostID
    WHERE
      ssh.IsDeleted       = 0;
    
    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    CREATE CLUSTERED INDEX IX_newChangedShapes ON #newChangedShapes(ShapeKey);

    -- get GeoLocations for new Shapes
    IF EXISTS(SELECT 1 FROM #newChangedShapes)
    BEGIN
      INSERT INTO #activityEndGeoLocation
      ( EndGeoLocationKey, EndShapeKey )
      SELECT DISTINCT
        dgls.GeoLocationKey,
        dgls.ShapeKey
      FROM
        #newChangedShapes                      ncs
          INNER JOIN
        [MiXData].dbo.DIM_GeoLocationsToShapes dgls WITH (NOLOCK) ON dgls.ShapeKey            = ncs.ShapeKey;
    END;

    CREATE CLUSTERED INDEX IX_activityEndGeoLocation ON #activityEndGeoLocation(EndGeoLocationKey,EndShapeKey);

    INSERT INTO #VehiclesLookup
    ( VehicleKey, HostID )
    SELECT
      dvh.VehicleKey,
      dvh.HostID
    FROM
      [MiXData].dbo.DIM_Vehicles dvh  WITH (NOLOCK)
    WHERE dvh.OrganisationKey = @organisationKey;

    CREATE CLUSTERED INDEX IX_VehiclesLookup ON #VehiclesLookup(VehicleKey);

    INSERT INTO #ShapesLookup
    ( ShapeKey )
    SELECT
      ds.ShapeKey
    FROM
      [MiXData].dbo.DIM_Shapes ds  WITH (NOLOCK)
    WHERE ds.OrganisationKey = @organisationKey;

    CREATE CLUSTERED INDEX IX_ShapesLookup ON #ShapesLookup(ShapeKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.1 Initial Insert - Create Lookups', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.1 Initial Insert - Create Lookups';
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- insert Activities of new/changed shapes
    IF EXISTS(SELECT 1 FROM #newChangedShapes)
    BEGIN
      INSERT INTO #activityDetails
      (
        ActivityDetailKey            ,
        NextMovementActivityDetailKey,
        ActivityStartDateKey         ,
        VehicleKey                   ,
        DriverKey                    ,
        UTCOffsetKey                 ,
        DurationAtLocation           ,
        EndGeoLocationKey
      )
      SELECT
        fad.ActivityDetailKey            ,
        fad.NextMovementActivityDetailKey,
        fad.ActivityStartDateKey         ,
        fad.VehicleKey                   ,
        fad.DriverKey                    ,
        fad.UTCOffsetKey                 ,
        DurationAtLocation = CASE 
                               WHEN ABS(DATEDIFF(year,fad.MovementEndDateTime,fad.NextMovementStartDateTime)) < @maxDurationYears
                                AND fad.MovementEndDateTime < fad.NextMovementStartDateTime
                                 THEN DATEDIFF(s,fad.MovementEndDateTime,fad.NextMovementStartDateTime)
                               ELSE 0
                             END,
        fad.EndGeoLocationKey
      FROM
        #VehiclesLookup                       dvh
          INNER JOIN  -- select EndGeoLocationKey from
        [MiXData].dbo.FACT_ActivityDetails fad  WITH (NOLOCK) ON fad.VehicleKey = dvh.VehicleKey
      WHERE
          fad.HostID > 0
      AND EXISTS (SELECT 1
                  FROM #activityEndGeoLocation egl
                  WHERE egl.EndGeoLocationKey = fad.EndGeoLocationKey);
    END;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    CREATE CLUSTERED INDEX IX_activityDetails ON #activityDetails(ActivityDetailKey);
    
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.2 Initial Insert - Activities for new/changed Shapes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.2 Initial Insert - Activities for new/changed Shapes';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- insert changed Activities
    INSERT INTO #ActivityChangedDates
    ( ActivityStartDateKey,VehicleKey )
    SELECT
      ActivityStartDateKey,
      VehicleKey
    FROM
      [StageUser].STAGE_FACT_ActivityDetails
    GROUP BY
      ActivityStartDateKey,
      VehicleKey;
    
    CREATE CLUSTERED INDEX IX_ActivityChangedDates ON #ActivityChangedDates(VehicleKey,ActivityStartDateKey);

    INSERT INTO #activityDetailsChanged
    (
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      ActivityStartDateKey         ,
      VehicleKey                   ,
      DriverKey                    ,
      UTCOffsetKey                 ,
      DurationAtLocation           ,
      EndGeoLocationKey
    )
    SELECT
      fad.ActivityDetailKey            ,
      fad.NextMovementActivityDetailKey,
      fad.ActivityStartDateKey         ,
      fad.VehicleKey                   ,
      fad.DriverKey                    ,
      fad.UTCOffsetKey                 ,
      DurationAtLocation = CASE 
                             WHEN ABS(DATEDIFF(year,fad.MovementEndDateTime,fad.NextMovementStartDateTime)) < @maxDurationYears
                              AND fad.MovementEndDateTime < fad.NextMovementStartDateTime
                               THEN DATEDIFF(s,fad.MovementEndDateTime,fad.NextMovementStartDateTime)
                             ELSE 0
                           END,
      fad.EndGeoLocationKey
    FROM
      #ActivityChangedDates                ac
        INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails fad  WITH (NOLOCK) ON fad.VehicleKey           = ac.VehicleKey
                                                              AND fad.ActivityStartDateKey = ac.ActivityStartDateKey
    WHERE
        fad.HostID > 0
    AND EXISTS (SELECT 1
                FROM 
                  #ShapesLookup                             dsh
                    INNER JOIN
                  [MiXData].dbo.DIM_GeoLocationsToShapes dgls WITH (NOLOCK) ON dgls.ShapeKey = dsh.ShapeKey
                WHERE dgls.GeoLocationKey = fad.EndGeoLocationKey);

    CREATE CLUSTERED INDEX IX_activityDetailsChanged ON #activityDetailsChanged(ActivityDetailKey);

    INSERT INTO #activityDetails
    (
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      ActivityStartDateKey         ,
      VehicleKey                   ,
      DriverKey                    ,
      UTCOffsetKey                 ,
      DurationAtLocation           ,
      EndGeoLocationKey
    )
    SELECT
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      ActivityStartDateKey         ,
      VehicleKey                   ,
      DriverKey                    ,
      UTCOffsetKey                 ,
      DurationAtLocation           ,
      EndGeoLocationKey
    FROM #activityDetailsChanged fad
    WHERE NOT EXISTS (SELECT 1
                      FROM #activityDetails a
                      WHERE a.ActivityDetailKey = fad.ActivityDetailKey);
    DROP TABLE #activityDetailsChanged;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.3 Initial Insert - changed Activities', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.3 Initial Insert - changed Activities';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- get GeoLocations for Changed Acitivities
    CREATE INDEX IX_activityDetails_EndGeoLocationKey ON #activityDetails(EndGeoLocationKey);

    ;WITH
    ActivityEndLocations AS
    (
      SELECT DISTINCT ad.EndGeoLocationKey
      FROM #activityDetails ad
    )
    INSERT INTO #activityEndGeoLocation
    ( EndGeoLocationKey, EndShapeKey )
    SELECT DISTINCT
      dgls.GeoLocationKey,
      dgls.ShapeKey
    FROM
      ActivityEndLocations                   al
        INNER JOIN
      [MiXData].dbo.DIM_GeoLocationsToShapes dgls WITH (NOLOCK) ON dgls.GeoLocationKey = al.EndGeoLocationKey
        INNER JOIN
      [MiXData].dbo.DIM_Shapes               dsh  WITH (NOLOCK) ON dsh.OrganisationKey = @organisationKey
                                                               AND dsh.ShapeKey        = dgls.ShapeKey
    WHERE
      NOT EXISTS (SELECT 1
                  FROM #activityEndGeoLocation agl
                  WHERE
                      agl.EndGeoLocationKey = dgls.GeoLocationKey
                  AND agl.EndShapeKey       = dgls.ShapeKey);

    -- Add simple visits to STAGE table
    INSERT INTO [StageUser].[STAGE_FACT_ShapeVisits]
    (
      VisitDateKey      ,
      ShapeKey          ,
      VehicleKey        ,
      DriverKey         ,
      UTCOffsetKey      ,
      DurationAtLocation,
      NumberOfVisits
    )
    SELECT
      fad.ActivityStartDateKey,
      egl.EndShapeKey         ,
      fad.VehicleKey          ,
      fad.DriverKey           ,
      fad.UTCOffsetKey        ,
      DurationAtLocation = SUM(DurationAtLocation),
      NumberOfVisits     = COUNT(DISTINCT fad.ActivityDetailKey)
    FROM
      #activityEndGeoLocation egl
        INNER JOIN
      #activityDetails        fad ON fad.EndGeoLocationKey = egl.EndGeoLocationKey
    GROUP BY
      fad.ActivityStartDateKey,
      egl.EndShapeKey         ,
      fad.VehicleKey          ,
      fad.DriverKey           ,
      fad.UTCOffsetKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.4 Initial Insert - add Simple visits to STAGE', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.4 Initial Insert - add Simple visits to STAGE';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -------------------------------------
    -- 2.5 Calculate Unique Visits
    -- 2.5.1 Identify Duplicate ActivityShape rows
    CREATE INDEX IX_activityDetails_NextMovementActivityDetailKey_VehicleKey_DriverKey ON #activityDetails(NextMovementActivityDetailKey,VehicleKey,DriverKey);

    INSERT INTO #DuplicateActivityShapes
    (
      VehicleKey                   ,
      DriverKey                    ,
      ActivityStartDateKey         ,
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      EndShapeKey                  ,
      NMEndShapeKey
    )
    SELECT
      m.VehicleKey,
      m.DriverKey,
      m.ActivityStartDateKey,
      m.ActivityDetailKey,
      m.NextMovementActivityDetailKey,
      ge.EndShapeKey,
      NMEndShapeKey = gen.EndShapeKey
    FROM
      #activityEndGeoLocation ge
        INNER JOIN
      #activityDetails        m   ON m.EndGeoLocationKey             = ge.EndGeoLocationKey
        LEFT JOIN
      #activityDetails        nm  ON m.NextMovementActivityDetailKey = nm.ActivityDetailKey
                                 AND m.VehicleKey                    = nm.VehicleKey
                                 AND m.DriverKey                     = nm.DriverKey
        LEFT JOIN
      #activityEndGeoLocation gen ON nm.EndGeoLocationKey            = gen.EndGeoLocationKey
    WHERE
      ge.EndShapeKey = gen.EndShapeKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    
    CREATE CLUSTERED INDEX IX_DuplicatedActivityShapes ON #DuplicateActivityShapes(ActivityDetailKey,EndShapeKey,ActivityStartDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.5.1 Initial Insert - Unique ShapeVisits - Identify Duplicate ActivityShape rows', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.5.1 Initial Insert - Unique ShapeVisits - Identify Duplicate ActivityShape rows';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- 2.5.2 De-duplicate ActivityShape rows
    INSERT INTO #DeDuplicatedActivityShapes
    (
      VehicleKey                   ,
      DriverKey                    ,
      ActivityStartDateKey         ,
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      EndShapeKey                  ,
      NMEndShapeKey
    )
    SELECT
      VehicleKey                   ,
      DriverKey                    ,
      ActivityStartDateKey         ,
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      EndShapeKey                  ,
      NMEndShapeKey
    FROM #DuplicateActivityShapes;

    CREATE CLUSTERED INDEX IX_DeDuplicatedActivityShapes ON #DeDuplicatedActivityShapes(ActivityDetailKey,EndShapeKey,ActivityStartDateKey);

    DELETE dd
    FROM
      #DeDuplicatedActivityShapes dd
    WHERE
      EXISTS (SELECT 1
              FROM #DeDuplicatedActivityShapes dd2
              WHERE
                  dd2.ActivityDetailKey    = dd.NextMovementActivityDetailKey
              AND dd2.EndShapeKey          = dd.EndShapeKey
              AND dd2.ActivityStartDateKey = dd.ActivityStartDateKey
              AND dd2.VehicleKey           = dd.VehicleKey
              AND dd2.DriverKey            = dd.DriverKey);

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.5.2 Initial Insert - Unique ShapeVisits - De-duplicate ActivityShape rows', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.5.2 Initial Insert - Unique ShapeVisits - De-duplicate ActivityShape rows';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- 2.5.3 Identify Single ActivityShapeVisits
    INSERT INTO #DeDuplicatedActivityShapes
    (
      VehicleKey                   ,
      DriverKey                    ,
      ActivityStartDateKey         ,
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      EndShapeKey
    )
    SELECT
      m.VehicleKey,
      m.DriverKey,
      m.ActivityStartDateKey,
      m.ActivityDetailKey,
      m.NextMovementActivityDetailKey,
      ge.EndShapeKey
    FROM
      #activityEndGeoLocation ge
        INNER JOIN
      #activityDetails        m  ON m.EndGeoLocationKey = ge.EndGeoLocationKey
    WHERE
      NOT EXISTS (SELECT 1
                  FROM #DuplicateActivityShapes d
                  where 
                      d.VehicleKey           = m.VehicleKey
                  AND d.VehicleKey           = m.VehicleKey
                  AND d.ActivityStartDateKey = m.ActivityStartDateKey
                  AND d.EndShapeKey          = ge.EndShapeKey
                  AND d.ActivityDetailKey    = m.ActivityDetailKey)
    AND
      NOT EXISTS (SELECT 1
                  FROM #DuplicateActivityShapes d
                  WHERE
                      d.VehicleKey                    = m.VehicleKey
                  AND d.DriverKey                     = m.DriverKey
                  AND d.ActivityStartDateKey          = m.ActivityStartDateKey
                  AND d.NMEndShapeKey                 = ge.EndShapeKey
                  AND d.NextMovementActivityDetailKey = m.ActivityDetailKey);

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.5.3 Initial Insert - Unique ShapeVisits - Identify Single ActivityShapeVisits', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.5.3 Initial Insert - Unique ShapeVisits - Identify Single ActivityShapeVisits';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;
    
    -- 2.5.4 Update Unique ShapeVisits
    ;WITH
    UniqueShapeVisits AS
    (
      SELECT
        dd.VehicleKey,
        dd.DriverKey,
        dd.ActivityStartDateKey,
        dd.EndShapeKey,
        NumberOfUniqueVisits = COUNT(1)
      FROM
        #DeDuplicatedActivityShapes dd
      GROUP BY
        dd.VehicleKey,
        dd.DriverKey,
        dd.ActivityStartDateKey,
        dd.EndShapeKey
    )
    UPDATE
      stg
    SET
      NumberOfUniqueVisits = usv.NumberOfUniqueVisits
    FROM
      [StageUser].[STAGE_FACT_ShapeVisits] stg
        INNER JOIN
      UniqueShapeVisits                    usv ON usv.VehicleKey           = stg.VehicleKey
                                              AND usv.DriverKey            = stg.DriverKey
                                              AND usv.ActivityStartDateKey = stg.VisitDateKey
                                              AND usv.EndShapeKey          = stg.ShapeKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.5.4 Initial Insert - Update Unique ShapeVisits', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.5.4 Initial Insert - Update Unique ShapeVisits';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey
      ON [StageUser].[STAGE_FACT_ShapeVisits](ShapeKey,VehicleKey,VisitDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;        
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;
  DECLARE @processPoint   int = 0;  -- what has already been done.
  WHILE @exceptionCount < 5
  BEGIN

    BEGIN TRY

      -- 5.1 Remove Changed records from DW
      IF @processPoint < 1
      BEGIN
        BEGIN TRANSACTION;
        DELETE tar
        FROM
          [StageUser].[STAGE_FACT_ShapeVisits] stg
            INNER JOIN
          [MiXData].dbo.FACT_ShapeVisits    tar ON                tar.ShapeKey            = stg.ShapeKey
                                                                 AND tar.VehicleKey          = stg.VehicleKey
                                                                 AND tar.VisitDateKey        = stg.VisitDateKey;

        -- record number of records updated
        SELECT @recordsUpdated = @@ROWCOUNT;
        COMMIT TRANSACTION;
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.1 Merge Remove Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
      END; -- @processPoint 1

      -- 5.2 Remove Deleted Shapes records from DW
      IF @processPoint < 2
      BEGIN
        BEGIN TRANSACTION;
        IF EXISTS (SELECT 1
                   FROM [StageUser].STAGE_DIM_Shapes
                   WHERE IsDeleted =1)
        BEGIN
          DELETE tar
          FROM 
            [StageUser].STAGE_DIM_Shapes      ssh WITH (NOLOCK)
              INNER JOIN
            [MiXData].dbo.DIM_Shapes       dsh WITH (NOLOCK) ON dsh.OrganisationKey     = @organisationKey
                                                               AND ssh.IsDeleted           = 1
                                                               AND dsh.HostID              = ssh.HostID
              INNER JOIN
            [MiXData].dbo.FACT_ShapeVisits tar               ON tar.ShapeKey            = dsh.ShapeKey;
        END;

        -- record number of records updated
        SELECT @recordsDeleted = @@ROWCOUNT;
        COMMIT TRANSACTION
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.2 Merge Remove Deleted Shapes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;            
        END;
      END; -- @processPoint 2

      -- create rollback index
      IF NOT EXISTS(SELECT *
                    FROM sys.indexes 
                    WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_ShapeVisits]') AND name = N'IX_ROLLBACK_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey')
        CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey
          ON [StageUser].[ROLLBACK_FACT_ShapeVisits](ShapeKey,VehicleKey,VisitDateKey);

      -- 5.3 insert new records to FACT
      IF @processPoint < 3
      BEGIN
        BEGIN TRANSACTION;

        INSERT INTO [MiXData].dbo.FACT_ShapeVisits
        (
          [OrganisationKey]   ,
          [VisitDateKey]      ,
          [ShapeKey]          ,
          [VehicleKey]        ,
          [DriverKey]         ,
          [DurationAtLocation],
          [NumberOfVisits]    ,
          NumberOfUniqueVisits,
          [UTCOffsetKey]      ,
          [CreateBatchKey]    ,
          [UpdateBatchKey]
        )
        SELECT
          @organisationKey    ,
          [VisitDateKey]      ,
          [ShapeKey]          ,
          [VehicleKey]        ,
          [DriverKey]         ,
          ISNULL([DurationAtLocation],0),
          ISNULL([NumberOfVisits]    ,0),
          ISNULL(NumberOfUniqueVisits,0),
          [UTCOffsetKey]      ,
          @batchKey           ,
          @batchKey
        FROM
          [StageUser].[STAGE_FACT_ShapeVisits]    AS stg;

        -- record number of records inserted
        SELECT @recordsInserted = @@ROWCOUNT;
        COMMIT TRANSACTION;
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
        
      END; -- @processPoint 3

      BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 5 AND ERROR_NUMBER() = 1205 -- DEADLOCK
        BEGIN
          EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
          IF @debugMode = 1  -- DebugMode is true
            BEGIN
              PRINT '5.error: deadlock occured, restarting merge';
              EXEC [Control].strProcProgressMonitor_Set
                @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
              SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
            END;
        END;
      ELSE
        BEGIN
          EXEC [Control].sprLogError @organisationKey = @organisationKey;
          RETURN -1;
          BREAK; -- out of while loop
        END;
    END CATCH;
  END -- While

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_ShapeVisits];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_SimpleScoreDaily_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_SimpleScoreDaily on DW
-- ==============================================================================
/*
  Dependencies:

   DIM_SimpleScoreCriteria
   FACT_SimpleScoreDetails
   
   STAGE_FACT_SimpleScoreDetails

*/
CREATE PROCEDURE [StageUser].[sprFACT_SimpleScoreDaily_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int    = 0;
  DECLARE @maxDuration         bigint = 2147483647; -- this is the max int data type value
  
  DECLARE @currentDate   datetimeoffset; -- used for validation
  DECLARE @flagStartTime datetimeoffset(0) = SYSUTCDATETIME();
  DECLARE @flagSeq       smallint = 1;

  SELECT @currentDate = SYSUTCDATETIME();

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_FACT_SimpleScoreDaily];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_SimpleScoreDaily];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY


    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_SimpleScoreDaily]') AND name = N'IX_STAGE_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey')
      DROP INDEX IX_STAGE_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey ON [StageUser].[STAGE_FACT_SimpleScoreDaily];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_SimpleScoreDaily]') AND name = N'IX_ROLLBACK_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey')
      DROP INDEX IX_ROLLBACK_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey ON [StageUser].[ROLLBACK_FACT_SimpleScoreDaily];

    -- insert changed records into STG
    ;WITH
      SimpleScoreChangedDates AS
      (
        SELECT
          VehicleKey,
          ActivityStartDateKey
        FROM
          [StageUser].STAGE_FACT_SimpleScoreDetails
        GROUP BY
          VehicleKey,
          ActivityStartDateKey
      )
    INSERT INTO [StageUser].[STAGE_FACT_SimpleScoreDaily]
    (
      [SnapShotDateKey]              ,
      [DriverKey]                    ,
      [VehicleKey]                   ,
      [DistanceTravelled]            ,
      [DrivingTime]                  ,
      [Duration]                     ,
      [MaxSpeed]                     ,
      [SpeedTime]                    ,
      [SpeedOccurs]                  ,
      [SpeedScoreByDuration]         ,
      [MaxBrake]                     ,
      [BrakeTime]                    ,
      [BrakeOccurs]                  ,
      [BrakeScoreByDuration]         ,
      [MaxAccel]                     ,
      [AccelTime]                    ,
      [AccelOccurs]                  ,
      [AccelScoreByDuration]         ,
      [MaxRPM]                       ,
      [RPMTime]                      ,
      [RPMOccurs]                    ,
      [RPMScoreByDuration]           ,
      [OutOfGreenBandTime]           ,
      [OutOfGreenBandScoreByDuration],
      [ExcessiveIdleOccurs]          ,
      [ExcessiveIdleTime]            ,
      [ExcessiveIdleScoreByDuration] ,
      [RoadSpeedTime]                ,
      [RoadSpeedOccurs]              ,
      [RoadSpeedScoreByDuration]
    )
    SELECT
      fsd.[ActivityStartDateKey]          ,
      fsd.[DriverKey]                     ,
      fsd.[VehicleKey]                    ,
      SUM([DistanceTravelled])            ,
      SUM([DrivingTime])                  ,
      CASE
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN -1
        ELSE SUM(CONVERT(BIGINT,[Duration]))
      END,
      MAX([MaxSpeed])                     ,
      SUM([SpeedTime])                    ,
      SUM([SpeedOccurs])                  ,
      CASE 
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([SpeedScore]          * Duration)
      END,
      MAX([MaxBrake])                     ,
      SUM([BrakeTime])                    ,
      SUM([BrakeOccurs])                  ,
      CASE 
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([BrakeScore]          * Duration)
      END,
      MAX([MaxAccel])                     ,
      SUM([AccelTime])                    ,
      SUM([AccelOccurs])                  ,
      CASE 
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([AccelScore]          * Duration)
      END,
      MAX([MaxRPM])                       ,
      SUM([RPMTime])                      ,
      SUM([RPMOccurs])                    ,
      CASE 
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([RPMScore]            * Duration)
      END,
      SUM([OutOfGreenBandTime])           ,
      CASE 
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([OutOfGreenBandScore] * Duration)
      END,
      SUM([ExcessiveIdleOccurs])          ,
      SUM([ExcessiveIdleTime])            ,
      CASE 
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([ExcessiveIdleScore]  * Duration)
      END,
      SUM([RoadSpeedTime]),
      SUM([RoadSpeedOccurs]),
      CASE
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([RoadSpeedScore]  * Duration)
      END
    FROM
      [MiXData].dbo.FACT_SimpleScoreDetails fsd WITH (NOLOCK)
        INNER JOIN
      SimpleScoreChangedDates                  ssc ON fsd.VehicleKey           = ssc.VehicleKey
                                                  AND fsd.ActivityStartDateKey = ssc.ActivityStartDateKey
    GROUP BY
      fsd.[ActivityStartDateKey]         ,
      fsd.[DriverKey]                    ,
      fsd.[VehicleKey];

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey
      ON [StageUser].[STAGE_FACT_SimpleScoreDaily](VehicleKey,DriverKey,SnapShotDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;
  DECLARE @processPoint   int = 0;  -- what has already been done.
  WHILE @exceptionCount < 4
  BEGIN

    BEGIN TRY

      IF @processPoint < 1
      BEGIN
        BEGIN TRANSACTION;

        -- 5.1 Changed records
        INSERT INTO [StageUser].[ROLLBACK_FACT_SimpleScoreDaily]
        ( 
          [SimpleScoreDailyKey]          ,
          [OrganisationKey]              ,
          [SnapShotDateKey]              ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScoreByDuration]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScoreByDuration]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScoreByDuration]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScoreByDuration]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScoreByDuration],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScoreByDuration] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScoreByDuration]     ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        )
        SELECT
          [SimpleScoreDailyKey]          ,
          [OrganisationKey]              ,
          [SnapShotDateKey]              ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScoreByDuration]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScoreByDuration]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScoreByDuration]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScoreByDuration]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScoreByDuration],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScoreByDuration] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScoreByDuration]     ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        FROM
         (UPDATE
            tar
          SET
            [DistanceTravelled]             = stg.[DistanceTravelled]            ,
            [DrivingTime]                   = stg.[DrivingTime]                  ,
            [Duration]                      = stg.[Duration]                     ,
            [MaxSpeed]                      = stg.[MaxSpeed]                     ,
            [SpeedTime]                     = stg.[SpeedTime]                    ,
            [SpeedOccurs]                   = stg.[SpeedOccurs]                  ,
            [SpeedScoreByDuration]          = stg.[SpeedScoreByDuration]         ,
            [MaxBrake]                      = stg.[MaxBrake]                     ,
            [BrakeTime]                     = stg.[BrakeTime]                    ,
            [BrakeOccurs]                   = stg.[BrakeOccurs]                  ,
            [BrakeScoreByDuration]          = stg.[BrakeScoreByDuration]         ,
            [MaxAccel]                      = stg.[MaxAccel]                     ,
            [AccelTime]                     = stg.[AccelTime]                    ,
            [AccelOccurs]                   = stg.[AccelOccurs]                  ,
            [AccelScoreByDuration]          = stg.[AccelScoreByDuration]         ,
            [MaxRPM]                        = stg.[MaxRPM]                       ,
            [RPMTime]                       = stg.[RPMTime]                      ,
            [RPMOccurs]                     = stg.[RPMOccurs]                    ,
            [RPMScoreByDuration]            = stg.[RPMScoreByDuration]           ,
            [OutOfGreenBandTime]            = stg.[OutOfGreenBandTime]           ,
            [OutOfGreenBandScoreByDuration] = stg.[OutOfGreenBandScoreByDuration],
            [ExcessiveIdleOccurs]           = stg.[ExcessiveIdleOccurs]          ,
            [ExcessiveIdleTime]             = stg.[ExcessiveIdleTime]            ,
            [ExcessiveIdleScoreByDuration]  = stg.[ExcessiveIdleScoreByDuration] ,
            [RoadSpeedTime]                 = ISNULL(stg.[RoadSpeedTime],0),
            [RoadSpeedOccurs]               = ISNULL(stg.[RoadSpeedOccurs],0),
            [RoadSpeedScoreByDuration]      = ISNULL(stg.[RoadSpeedScoreByDuration],0),
            [UpdateBatchKey]                = @batchKey
          OUTPUT
            DELETED.[SimpleScoreDailyKey]          ,
            DELETED.[OrganisationKey]              ,
            DELETED.[SnapShotDateKey]              ,
            DELETED.[DriverKey]                    ,
            DELETED.[VehicleKey]                   ,
            DELETED.[DistanceTravelled]            ,
            DELETED.[DrivingTime]                  ,
            DELETED.[Duration]                     ,
            DELETED.[MaxSpeed]                     ,
            DELETED.[SpeedTime]                    ,
            DELETED.[SpeedOccurs]                  ,
            DELETED.[SpeedScoreByDuration]         ,
            DELETED.[MaxBrake]                     ,
            DELETED.[BrakeTime]                    ,
            DELETED.[BrakeOccurs]                  ,
            DELETED.[BrakeScoreByDuration]         ,
            DELETED.[MaxAccel]                     ,
            DELETED.[AccelTime]                    ,
            DELETED.[AccelOccurs]                  ,
            DELETED.[AccelScoreByDuration]         ,
            DELETED.[MaxRPM]                       ,
            DELETED.[RPMTime]                      ,
            DELETED.[RPMOccurs]                    ,
            DELETED.[RPMScoreByDuration]           ,
            DELETED.[OutOfGreenBandTime]           ,
            DELETED.[OutOfGreenBandScoreByDuration],
            DELETED.[ExcessiveIdleOccurs]          ,
            DELETED.[ExcessiveIdleTime]            ,
            DELETED.[ExcessiveIdleScoreByDuration] ,
            DELETED.[RoadSpeedTime]                ,
            DELETED.[RoadSpeedOccurs]              ,
            DELETED.[RoadSpeedScoreByDuration]     ,
            0 AS IsDeleted                         ,
            DELETED.[CreateBatchKey]               ,
            DELETED.[UpdateBatchKey]
          FROM 
           [MiXData].dbo.FACT_SimpleScoreDaily    AS tar WITH (NOLOCK)
             INNER JOIN
           [StageUser].[STAGE_FACT_SimpleScoreDaily] AS stg ON tar.VehicleKey      = stg.VehicleKey
                                                           AND tar.DriverKey       = stg.DriverKey
                                                           AND tar.SnapShotDateKey = stg.SnapShotDateKey
          ) AS upd;

        -- record number of records updated
        SELECT @recordsUpdated = @@ROWCOUNT;
        COMMIT TRANSACTION;
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
      END; -- @processPoint 1

      -- create rollback index
      IF NOT EXISTS(SELECT *
                    FROM sys.indexes 
                    WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_SimpleScoreDaily]') AND name = N'IX_ROLLBACK_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey')
        CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey
          ON [StageUser].[ROLLBACK_FACT_SimpleScoreDaily](VehicleKey,DriverKey,SnapShotDateKey);

      -- 5.2 insert new records to FACT
      IF @processPoint < 2
      BEGIN
        BEGIN TRANSACTION;

        INSERT INTO [MiXData].dbo.FACT_SimpleScoreDaily
        ( 
          [OrganisationKey]              ,
          [SnapShotDateKey]              ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScoreByDuration]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScoreByDuration]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScoreByDuration]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScoreByDuration]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScoreByDuration],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScoreByDuration] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScoreByDuration]     ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        )
        SELECT
          @organisationKey               ,
          [SnapShotDateKey]              ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScoreByDuration]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScoreByDuration]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScoreByDuration]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScoreByDuration]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScoreByDuration],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScoreByDuration] ,
          ISNULL([RoadSpeedTime],0),
          ISNULL([RoadSpeedOccurs],0),
          ISNULL([RoadSpeedScoreByDuration],0),
          @batchKey                      ,
          @batchKey
        FROM
          [StageUser].[STAGE_FACT_SimpleScoreDaily]    AS stg
        WHERE
          NOT EXISTS (SELECT 1
                      FROM
                        [StageUser].[ROLLBACK_FACT_SimpleScoreDaily] AS roll WITH (NOLOCK)
                      WHERE
                          stg.VehicleKey      = roll.VehicleKey
                      AND stg.DriverKey       = roll.DriverKey
                      AND stg.SnapShotDateKey = roll.SnapShotDateKey);

        -- record number of records inserted
        SELECT @recordsInserted = @@ROWCOUNT;
        COMMIT TRANSACTION
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.1 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
      END; -- @processPoint 2

      -- 5.3: remove rollups where DriverKey not longer exists
        IF @processPoint < 3
          BEGIN
            BEGIN TRANSACTION;
            INSERT INTO [StageUser].[ROLLBACK_FACT_SimpleScoreDaily]
            ( 
              [SimpleScoreDailyKey]          ,
              [OrganisationKey]              ,
              [SnapShotDateKey]              ,
              [DriverKey]                    ,
              [VehicleKey]                   ,
              [DistanceTravelled]            ,
              [DrivingTime]                  ,
              [Duration]                     ,
              [MaxSpeed]                     ,
              [SpeedTime]                    ,
              [SpeedOccurs]                  ,
              [SpeedScoreByDuration]         ,
              [MaxBrake]                     ,
              [BrakeTime]                    ,
              [BrakeOccurs]                  ,
              [BrakeScoreByDuration]         ,
              [MaxAccel]                     ,
              [AccelTime]                    ,
              [AccelOccurs]                  ,
              [AccelScoreByDuration]         ,
              [MaxRPM]                       ,
              [RPMTime]                      ,
              [RPMOccurs]                    ,
              [RPMScoreByDuration]           ,
              [OutOfGreenBandTime]           ,
              [OutOfGreenBandScoreByDuration],
              [ExcessiveIdleOccurs]          ,
              [ExcessiveIdleTime]            ,
              [ExcessiveIdleScoreByDuration] ,
              [RoadSpeedTime]                ,
              [RoadSpeedOccurs]              ,
              [RoadSpeedScoreByDuration]     ,
              [IsDeleted]                    ,
              [CreateBatchKey]               ,
              [UpdateBatchKey]
            )
            SELECT
              [SimpleScoreDailyKey]          ,
              [OrganisationKey]              ,
              [SnapShotDateKey]              ,
              [DriverKey]                    ,
              [VehicleKey]                   ,
              [DistanceTravelled]            ,
              [DrivingTime]                  ,
              [Duration]                     ,
              [MaxSpeed]                     ,
              [SpeedTime]                    ,
              [SpeedOccurs]                  ,
              [SpeedScoreByDuration]         ,
              [MaxBrake]                     ,
              [BrakeTime]                    ,
              [BrakeOccurs]                  ,
              [BrakeScoreByDuration]         ,
              [MaxAccel]                     ,
              [AccelTime]                    ,
              [AccelOccurs]                  ,
              [AccelScoreByDuration]         ,
              [MaxRPM]                       ,
              [RPMTime]                      ,
              [RPMOccurs]                    ,
              [RPMScoreByDuration]           ,
              [OutOfGreenBandTime]           ,
              [OutOfGreenBandScoreByDuration],
              [ExcessiveIdleOccurs]          ,
              [ExcessiveIdleTime]            ,
              [ExcessiveIdleScoreByDuration] ,
              ISNULL([RoadSpeedTime],0),
              ISNULL([RoadSpeedOccurs],0),
              ISNULL([RoadSpeedScoreByDuration],0),
              [IsDeleted]                    ,
              [CreateBatchKey]               ,
              [UpdateBatchKey]
            FROM
            (
              DELETE
                [MiXData].[dbo].FACT_SimpleScoreDaily
              OUTPUT
                DELETED.[SimpleScoreDailyKey]          ,
                DELETED.[OrganisationKey]              ,
                DELETED.[SnapShotDateKey]              ,
                DELETED.[DriverKey]                    ,
                DELETED.[VehicleKey]                   ,
                DELETED.[DistanceTravelled]            ,
                DELETED.[DrivingTime]                  ,
                DELETED.[Duration]                     ,
                DELETED.[MaxSpeed]                     ,
                DELETED.[SpeedTime]                    ,
                DELETED.[SpeedOccurs]                  ,
                DELETED.[SpeedScoreByDuration]         ,
                DELETED.[MaxBrake]                     ,
                DELETED.[BrakeTime]                    ,
                DELETED.[BrakeOccurs]                  ,
                DELETED.[BrakeScoreByDuration]         ,
                DELETED.[MaxAccel]                     ,
                DELETED.[AccelTime]                    ,
                DELETED.[AccelOccurs]                  ,
                DELETED.[AccelScoreByDuration]         ,
                DELETED.[MaxRPM]                       ,
                DELETED.[RPMTime]                      ,
                DELETED.[RPMOccurs]                    ,
                DELETED.[RPMScoreByDuration]           ,
                DELETED.[OutOfGreenBandTime]           ,
                DELETED.[OutOfGreenBandScoreByDuration],
                DELETED.[ExcessiveIdleOccurs]          ,
                DELETED.[ExcessiveIdleTime]            ,
                DELETED.[ExcessiveIdleScoreByDuration] ,
                DELETED.[RoadSpeedTime]                ,
                DELETED.[RoadSpeedOccurs]              ,
                DELETED.[RoadSpeedScoreByDuration]     ,
                1 AS IsDeleted                         ,
                DELETED.[CreateBatchKey]               ,
                DELETED.[UpdateBatchKey]
              FROM
                [MiXData].dbo.FACT_SimpleScoreDaily    AS tar WITH (NOLOCK)
                  INNER JOIN
                [StageUser].[STAGE_FACT_SimpleScoreDaily] AS stg ON tar.VehicleKey      = stg.VehicleKey
                                                                 AND tar.SnapShotDateKey = stg.SnapShotDateKey
                                                                 -- no driver match!
                                                                 AND tar.UpdateBatchKey != @batchKey
            ) deleted
            SET @recordsDeleted = @@ROWCOUNT;
            COMMIT TRANSACTION
            SET @processPoint += 1;

            IF @debugMode = 1  -- DebugMode is true
              BEGIN
                EXEC [Control].strProcProgressMonitor_Set
                  @flag='5.2: remove rollups where DriverKey not longer exists', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
                PRINT '5.2: remove rollups where DriverKey not longer exists = ' + CAST(@recordsDeleted AS nvarchar);
                SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
              END;
          END; -- @processPoint 3
      
      BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 4 AND ERROR_NUMBER() = 1205 -- DEADLOCK
        BEGIN
          EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
          IF @debugMode = 1  -- DebugMode is true
            BEGIN
              PRINT '5.error: deadlock occured, restarting merge';
              EXEC [Control].strProcProgressMonitor_Set
                @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
              SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
            END;
        END;
      ELSE
        BEGIN
          EXEC [Control].sprLogError @organisationKey = @organisationKey;
          RETURN -1;
          BREAK; -- out of while loop
        END;
    END CATCH;
  END -- While
  
  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_SimpleScoreDaily];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_SimpleScoreDetails_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_SimpleScoreDetails on DW (details of organisations, late transform)
-- ==============================================================================
/*
  Dependencies:
  
  All DIMs
  FACT_ActivityDetails

*/
CREATE PROCEDURE [StageUser].[sprFACT_SimpleScoreDetails_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;

  DECLARE @maxDurationYears int            = 68;               -- anything bigger than 68 causes overflow of int datatype
  DECLARE @currentDate      datetimeoffset = SYSUTCDATETIME(); -- used for validation
  DECLARE @flagStartTime datetimeoffset(0) = SYSUTCDATETIME();
  DECLARE @flagSeq       smallint = 1;

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_FACT_SimpleScoreDetails];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_SimpleScoreDetails];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY
  
      -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_SimpleScoreDetails]') AND name = N'IX_STAGE_FACT_SimpleScoreDetails_ActivitySummaryKey_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_SimpleScoreDetails_ActivitySummaryKey_HostID_Operation ON [StageUser].[STAGE_FACT_SimpleScoreDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_SimpleScoreDetails]') AND name = N'IX_STAGE_FACT_SimpleScoreDetails_ActivityStartDateKey')
      DROP INDEX IX_STAGE_FACT_SimpleScoreDetails_ActivityStartDateKey ON [StageUser].[STAGE_FACT_SimpleScoreDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_SimpleScoreDetails]') AND name = N'IX_STAGE_FACT_SimpleScoreDetails_ActivityDetailKey')
      DROP INDEX IX_STAGE_FACT_SimpleScoreDetails_ActivityDetailKey ON [StageUser].[STAGE_FACT_SimpleScoreDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_SimpleScoreDetails]') AND name = N'IX_STAGE_FACT_SimpleScoreDetails_ScoreKeys')
      DROP INDEX IX_STAGE_FACT_SimpleScoreDetails_ScoreKeys ON [StageUser].[STAGE_FACT_SimpleScoreDetails]

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_SimpleScoreDetails]') AND name = N'IX_ROLLBACK_FACT_SimpleScoreDetails_ActivityDetailKey')
      DROP INDEX IX_ROLLBACK_FACT_SimpleScoreDetails_ActivityDetailKey ON [StageUser].[ROLLBACK_FACT_SimpleScoreDetails];

    -- create Source index
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser].SubTripData') AND name = N'IX_SubTripData_TripID_Sequence')
      CREATE INDEX IX_SubTripData_TripID_Sequence ON [StageUser].SubTripData
        (TripID,Sequence)
        INCLUDE(Operation);

  -- insert changed records into STG
  INSERT INTO [StageUser].[STAGE_FACT_SimpleScoreDetails]
  (
    [Operation]           ,
    [TripID]              ,
    [ActivityDetailKey]   ,
    [ActivitySummaryKey]  ,
    [HostID]              ,
    [ActivityStartDateKey],
    [VehicleKey]          ,
    [DriverKey]
  )
  SELECT
    std.Operation           ,
    std.TripID              ,
    fad.ActivityDetailKey   ,
    fad.ActivitySummaryKey  ,
    fad.HostID              ,
    fad.ActivityStartDateKey,
    fad.VehicleKey          ,
    fad.DriverKey
  FROM
    [StageUser].STAGE_FACT_ActivityDetails std
      INNER JOIN
    [MiXData].dbo.FACT_ActivityDetails  fad WITH (NOLOCK) ON fad.ActivityDetailKey = std.ActivityDetailKey;

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].SubTripData') AND name = N'IX_SubTripData_TripID_Sequence')
      DROP INDEX IX_SubTripData_TripID_Sequence ON [StageUser].SubTripData;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create indexes to be used for lookups
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SimpleScoreDetails_ActivitySummaryKey_HostID_Operation 
      ON [StageUser].[STAGE_FACT_SimpleScoreDetails](ActivitySummaryKey,HostID,Operation);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SimpleScoreDetails_ActivityStartDateKey
      ON [StageUser].[STAGE_FACT_SimpleScoreDetails](ActivityStartDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    ------------------------------------------
    -- ActivityDetailKey
    --UPDATE
      --[StageUser].[STAGE_FACT_SimpleScoreDetails]
    --SET
    --ActivityDetailKey = fad.ActivityDetailKey
    --FROM
      --[StageUser].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        --INNER JOIN
      --[$(MiXData)].dbo.FACT_ActivityDetails        fad WITH (NOLOCK) ON stg.ActivitySummaryKey = fad.ActivitySummaryKey
                                                               --AND stg.HostID             = fad.HostID
                                                               --AND fad.OrganisationKey    = @organisationKey;

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SimpleScoreDetails_ActivityDetailKey
      ON [StageUser].[STAGE_FACT_SimpleScoreDetails](ActivityDetailKey);

    ------------------------------------------
    -- SpeedScoreCiteriaKey
    UPDATE
      [StageUser].[STAGE_FACT_SimpleScoreDetails]
    SET
      SpeedScoreCiteriaKey = dsc.[ScoreCriteriaKey]
    FROM
      [StageUser].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_SimpleScoreCriteria  dsc WITH (NOLOCK)
    WHERE
        dsc.OrganisationKey        = @organisationKey
    AND stg.[ActivityStartDateKey] BETWEEN dsc.StartDateKey AND dsc.EndDateKey
    AND dsc.HostID                 = 1; -- Speed

    ------------------------------------------
    -- RPMScoreCiteriaKey
    UPDATE
      [StageUser].[STAGE_FACT_SimpleScoreDetails]
    SET
      RPMScoreCiteriaKey = dsc.[ScoreCriteriaKey]
    FROM
      [StageUser].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_SimpleScoreCriteria  dsc WITH (NOLOCK)
    WHERE
        dsc.OrganisationKey        = @organisationKey
    AND stg.[ActivityStartDateKey] BETWEEN dsc.StartDateKey AND dsc.EndDateKey
    AND dsc.HostID                 = 2; -- RPM

    ------------------------------------------
    -- BrakeScoreCiteriaKey
    UPDATE
      [StageUser].[STAGE_FACT_SimpleScoreDetails]
    SET
      BrakeScoreCiteriaKey = dsc.[ScoreCriteriaKey]
    FROM
      [StageUser].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_SimpleScoreCriteria  dsc WITH (NOLOCK)
    WHERE
        dsc.OrganisationKey        = @organisationKey
    AND stg.[ActivityStartDateKey] BETWEEN dsc.StartDateKey AND dsc.EndDateKey
    AND dsc.HostID                 = 3; -- Brake

    ------------------------------------------
    -- OutOfGreenbandScoreCiteriaKey
    UPDATE
      [StageUser].[STAGE_FACT_SimpleScoreDetails]
    SET
      OutOfGreenbandScoreCiteriaKey = dsc.[ScoreCriteriaKey]
    FROM
      [StageUser].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_SimpleScoreCriteria  dsc WITH (NOLOCK)
    WHERE
        dsc.OrganisationKey        = @organisationKey
    AND stg.[ActivityStartDateKey] BETWEEN dsc.StartDateKey AND dsc.EndDateKey
    AND dsc.HostID                 = 4; -- OutOfGreenband

    ------------------------------------------
    -- ExcessiveIdleScoreCiteriaKey
    UPDATE
      [StageUser].[STAGE_FACT_SimpleScoreDetails]
    SET
      ExcessiveIdleScoreCiteriaKey = dsc.[ScoreCriteriaKey]
    FROM
      [StageUser].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_SimpleScoreCriteria  dsc WITH (NOLOCK)
    WHERE
        dsc.OrganisationKey        = @organisationKey
    AND stg.[ActivityStartDateKey] BETWEEN dsc.StartDateKey AND dsc.EndDateKey
    AND dsc.HostID                 = 5; -- ExcessiveIdle

    ------------------------------------------
    -- AccelScoreCiteriaKey
    UPDATE
      [StageUser].[STAGE_FACT_SimpleScoreDetails]
    SET
      AccelScoreCiteriaKey = dsc.[ScoreCriteriaKey]
    FROM
      [StageUser].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_SimpleScoreCriteria  dsc WITH (NOLOCK)
    WHERE
        dsc.OrganisationKey        = @organisationKey
    AND stg.[ActivityStartDateKey] BETWEEN dsc.StartDateKey AND dsc.EndDateKey
    AND dsc.HostID                 = 7; -- Accel

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update Keys', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- drop index on stage_fact_activitydetails
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Duration')
      DROP INDEX IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Duration ON [StageUser].[STAGE_FACT_ActivityDetails];

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;
  DECLARE @processPoint   int = 0;  -- what has already been done.
  WHILE @exceptionCount < 5
  BEGIN

    BEGIN TRY

      -- 5.1 Add to RollBck table
      IF @processPoint < 1
      BEGIN
        BEGIN TRANSACTION;

        INSERT INTO [StageUser].[ROLLBACK_FACT_SimpleScoreDetails]
        ( 
          [SimpleScoreKey]               ,
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        )
        SELECT
          [SimpleScoreKey]               ,
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        FROM
         (UPDATE
            tar
          SET
            [ActivityStartDateKey]           = stg.[ActivityStartDateKey]         ,
            [DriverKey]                      = stg.[DriverKey]                    ,
            [VehicleKey]                     = stg.[VehicleKey]                   ,
            [DistanceTravelled]              = std.TripDistance                   ,
            [DrivingTime]                    = CASE  
                                                 WHEN ABS(DATEDIFF(YEAR,std.Depart,std.Halt)) > @maxDurationYears -- if Duration is longer than 68 years than indicate with error value  
                                                   THEN -2                                                        -- value used for indication erronous value  
                                                 ELSE  
                                                   DATEDIFF(SECOND,std.Depart,std.Halt)  
                                               END, 
            [Duration]                       = CASE  
                                                 WHEN ABS(DATEDIFF(YEAR,std.Depart,std.Halt)) > @maxDurationYears   -- if Duration is longer than 68 years than indicate with error value  
                                                   THEN -2                                                 -- value used for indication erronous value  
                                                 ELSE  
                                                   ISNULL(DATEDIFF(SECOND,std.Depart,std.Halt),0) + ISNULL(std.StandingTime,0)  
                                               END,
            [MaxSpeed]                       = std.[MaxSpeed]                     ,
            [SpeedTime]                      = std.[SpeedTime]                    ,
            [SpeedOccurs]                    = std.[SpeedOccurs]                  ,
            [SpeedScore]                     = std.[SpeedScore]                   ,
            [SpeedScoreCiteriaKey]           = stg.[SpeedScoreCiteriaKey]         ,
            [MaxBrake]                       = std.[MaxBrake]                     ,
            [BrakeTime]                      = std.[BrakeTime]                    ,
            [BrakeOccurs]                    = std.[BrakeOccurs]                  ,
            [BrakeScore]                     = std.[BrakeScore]                   ,
            [BrakeScoreCiteriaKey]           = stg.[BrakeScoreCiteriaKey]         ,
            [MaxAccel]                       = std.[MaxAccel]                     ,
            [AccelTime]                      = std.[AccelTime]                    ,
            [AccelOccurs]                    = std.[AccelOccurs]                  ,
            [AccelScore]                     = std.[AccelScore]                   ,
            [AccelScoreCiteriaKey]           = stg.[AccelScoreCiteriaKey]         ,
            [MaxRPM]                         = std.[MaxRPM]                       ,
            [RPMTime]                        = std.[RPMTime]                      ,
            [RPMOccurs]                      = std.[RPMOccurs]                    ,
            [RPMScore]                       = std.[RPMScore]                     ,
            [RPMScoreCiteriaKey]             = stg.[RPMScoreCiteriaKey]           ,
            [OutOfGreenBandTime]             = std.GBTime                         ,
            [OutOfGreenBandScore]            = std.GBScore                        ,
            [OutOfGreenbandScoreCiteriaKey]  = stg.[OutOfGreenbandScoreCiteriaKey],
            [ExcessiveIdleOccurs]            = std.ExIdleOccurs                   ,
            [ExcessiveIdleTime]              = std.ExIdleTime                     ,
            [ExcessiveIdleScore]             = std.ExIdleScore                    ,
            [ExcessiveIdleScoreCiteriaKey]   = stg.[ExcessiveIdleScoreCiteriaKey] ,
            [RoadSpeedTime]                  = ISNULL(std.[RoadSpeedTime],0)      ,
            [RoadSpeedOccurs]                = ISNULL(std.[RoadSpeedOccurs],0)    ,
            [RoadSpeedScore]                 = ISNULL(std.[RoadSpeedScore],100.0) ,
            [IsDeleted]                      = 0                                  ,
            [UpdateBatchKey]                 = @batchKey
          OUTPUT
            DELETED.[SimpleScoreKey]               ,
            DELETED.[OrganisationKey]              ,
            DELETED.[ActivityDetailKey]            ,
            DELETED.[ActivityStartDateKey]         ,
            DELETED.[DriverKey]                    ,
            DELETED.[VehicleKey]                   ,
            DELETED.[DistanceTravelled]            ,
            DELETED.[DrivingTime]                  ,
            DELETED.[Duration]                     ,
            DELETED.[MaxSpeed]                     ,
            DELETED.[SpeedTime]                    ,
            DELETED.[SpeedOccurs]                  ,
            DELETED.[SpeedScore]                   ,
            DELETED.[SpeedScoreCiteriaKey]         ,
            DELETED.[MaxBrake]                     ,
            DELETED.[BrakeTime]                    ,
            DELETED.[BrakeOccurs]                  ,
            DELETED.[BrakeScore]                   ,
            DELETED.[BrakeScoreCiteriaKey]         ,
            DELETED.[MaxAccel]                     ,
            DELETED.[AccelTime]                    ,
            DELETED.[AccelOccurs]                  ,
            DELETED.[AccelScore]                   ,
            DELETED.[AccelScoreCiteriaKey]         ,
            DELETED.[MaxRPM]                       ,
            DELETED.[RPMTime]                      ,
            DELETED.[RPMOccurs]                    ,
            DELETED.[RPMScore]                     ,
            DELETED.[RPMScoreCiteriaKey]           ,
            DELETED.[OutOfGreenBandTime]           ,
            DELETED.[OutOfGreenBandScore]          ,
            DELETED.[OutOfGreenbandScoreCiteriaKey],
            DELETED.[ExcessiveIdleOccurs]          ,
            DELETED.[ExcessiveIdleTime]            ,
            DELETED.[ExcessiveIdleScore]           ,
            DELETED.[ExcessiveIdleScoreCiteriaKey] ,
            DELETED.[RoadSpeedTime]                ,
            DELETED.[RoadSpeedOccurs]              ,
            DELETED.[RoadSpeedScore]               ,
            DELETED.[IsDeleted]                    ,
            DELETED.[CreateBatchKey]               ,
            DELETED.[UpdateBatchKey]
          FROM
            [MiXData].dbo.FACT_SimpleScoreDetails    tar
              INNER JOIN
            [StageUser].[STAGE_FACT_SimpleScoreDetails] stg ON tar.ActivityDetailKey = stg.ActivityDetailKey
                                                           AND tar.OrganisationKey   = @organisationKey
              INNER JOIN
            [StageUser].[SubTripData]                   std ON std.TripID            = stg.TripID
                                                           AND std.Sequence          = stg.HostID
          WHERE stg.Operation in ('I','U')
          ) AS upd;

        -- record number of records updated
        SELECT @recordsUpdated = @@ROWCOUNT;
        COMMIT TRANSACTION;
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
      END; -- @processPoint 1

      -- 5.2 Deleted records
      IF @processPoint < 2
      BEGIN
        BEGIN TRANSACTION;
        
        INSERT INTO [StageUser].[ROLLBACK_FACT_SimpleScoreDetails]
        ( 
          [SimpleScoreKey]               ,
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        )
        SELECT
          [SimpleScoreKey]               ,
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        FROM
         (UPDATE
            tar
          SET
            [IsDeleted]      = 1,
            [UpdateBatchKey] = @batchKey
          OUTPUT
            DELETED.[SimpleScoreKey]               ,
            DELETED.[OrganisationKey]              ,
            DELETED.[ActivityDetailKey]            ,
            DELETED.[ActivityStartDateKey]         ,
            DELETED.[DriverKey]                    ,
            DELETED.[VehicleKey]                   ,
            DELETED.[DistanceTravelled]            ,
            DELETED.[DrivingTime]                  ,
            DELETED.[Duration]                     ,
            DELETED.[MaxSpeed]                     ,
            DELETED.[SpeedTime]                    ,
            DELETED.[SpeedOccurs]                  ,
            DELETED.[SpeedScore]                   ,
            DELETED.[SpeedScoreCiteriaKey]         ,
            DELETED.[MaxBrake]                     ,
            DELETED.[BrakeTime]                    ,
            DELETED.[BrakeOccurs]                  ,
            DELETED.[BrakeScore]                   ,
            DELETED.[BrakeScoreCiteriaKey]         ,
            DELETED.[MaxAccel]                     ,
            DELETED.[AccelTime]                    ,
            DELETED.[AccelOccurs]                  ,
            DELETED.[AccelScore]                   ,
            DELETED.[AccelScoreCiteriaKey]         ,
            DELETED.[MaxRPM]                       ,
            DELETED.[RPMTime]                      ,
            DELETED.[RPMOccurs]                    ,
            DELETED.[RPMScore]                     ,
            DELETED.[RPMScoreCiteriaKey]           ,
            DELETED.[OutOfGreenBandTime]           ,
            DELETED.[OutOfGreenBandScore]          ,
            DELETED.[OutOfGreenbandScoreCiteriaKey],
            DELETED.[ExcessiveIdleOccurs]          ,
            DELETED.[ExcessiveIdleTime]            ,
            DELETED.[ExcessiveIdleScore]           ,
            DELETED.[ExcessiveIdleScoreCiteriaKey] ,
            DELETED.[RoadSpeedTime]                ,
            DELETED.[RoadSpeedOccurs]              ,
            DELETED.[RoadSpeedScore]               ,
            DELETED.[IsDeleted]                    ,
            DELETED.[CreateBatchKey]               ,
            DELETED.[UpdateBatchKey]
          FROM
            [MiXData].dbo.FACT_SimpleScoreDetails    tar
              INNER JOIN
            [StageUser].[STAGE_FACT_SimpleScoreDetails] stg ON tar.ActivityDetailKey = stg.ActivityDetailKey
                                                           AND tar.OrganisationKey   = @organisationKey
          WHERE stg.Operation = 'D'
          ) AS del;

        -- record number of records deleted  
        SELECT @recordsDeleted = @@ROWCOUNT;  
        COMMIT TRANSACTION
        SET @processPoint += 1;
      
        IF @debugMode = 1  -- DebugMode is true  
        BEGIN  
          EXEC [Control].strProcProgressMonitor_Set  
            @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;  
      END; -- @processPoint 2

      -- create rollback index
      IF NOT EXISTS(SELECT *
                    FROM sys.indexes 
                    WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_SimpleScoreDetails]') AND name = N'IX_ROLLBACK_FACT_SimpleScoreDetails_ActivityDetailKey')
        CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_SimpleScoreDetails_ActivityDetailKey
          ON [StageUser].[ROLLBACK_FACT_SimpleScoreDetails](ActivityDetailKey);

      -- 5.3 insert new records to FACT
      IF @processPoint < 3
      BEGIN
        BEGIN TRANSACTION;

        INSERT INTO [MiXData].dbo.[FACT_SimpleScoreDetails]
        ( 
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        )
        SELECT
          @organisationKey                   ,
          stg.[ActivityDetailKey]            ,
          stg.[ActivityStartDateKey]         ,
          stg.[DriverKey]                    ,
          stg.[VehicleKey]                   ,
          std.TripDistance                   ,
          [DrivingTime]                      = CASE  
                                                 WHEN ABS(DATEDIFF(YEAR,std.Depart,std.Halt)) > @maxDurationYears -- if Duration is longer than 68 years than indicate with error value  
                                                   THEN -2                                                        -- value used for indication erronous value  
                                                 ELSE  
                                                   DATEDIFF(SECOND,std.Depart,std.Halt)  
                                               END, 
          [Duration]                         = CASE  
                                                 WHEN ABS(DATEDIFF(YEAR,std.Depart,std.Halt)) > @maxDurationYears   -- if Duration is longer than 68 years than indicate with error value  
                                                   THEN -2                                                          -- value used for indication erronous value  
                                                 ELSE  
                                                   ISNULL(DATEDIFF(SECOND,std.Depart,std.Halt),0) + ISNULL(std.StandingTime,0)  
                                               END,
          std.[MaxSpeed]                     ,
          std.[SpeedTime]                    ,
          std.[SpeedOccurs]                  ,
          std.[SpeedScore]                   ,
          stg.[SpeedScoreCiteriaKey]         ,
          std.[MaxBrake]                     ,
          std.[BrakeTime]                    ,
          std.[BrakeOccurs]                  ,
          std.[BrakeScore]                   ,
          stg.[BrakeScoreCiteriaKey]         ,
          std.[MaxAccel]                     ,
          std.[AccelTime]                    ,
          std.[AccelOccurs]                  ,
          std.[AccelScore]                   ,
          stg.[AccelScoreCiteriaKey]         ,
          std.[MaxRPM]                       ,
          std.[RPMTime]                      ,
          std.[RPMOccurs]                    ,
          std.[RPMScore]                     ,
          stg.[RPMScoreCiteriaKey]           ,
          std.GBTime                         ,
          std.GBScore                        ,
          stg.[OutOfGreenbandScoreCiteriaKey],
          std.ExIdleOccurs                   ,
          std.ExIdleTime                     ,
          std.ExIdleScore                    ,
          stg.[ExcessiveIdleScoreCiteriaKey] ,
          ISNULL(std.[RoadSpeedTime],0)      ,
          ISNULL(std.[RoadSpeedOccurs],0)    ,
          ISNULL(std.[RoadSpeedScore],100.0) ,
          0                                  , -- IsDeleted
          @batchKey                          ,
          @batchKey
        FROM
          [StageUser].[STAGE_FACT_SimpleScoreDetails] stg
            INNER JOIN  -- select * from
          [StageUser].SubTripData                     std ON std.TripID             = stg.TripID
                                                         AND std.Sequence           = stg.HostID
        WHERE
            stg.Operation IN ('I','U')
        AND NOT EXISTS (SELECT 1
                        FROM
                          [StageUser].[ROLLBACK_FACT_SimpleScoreDetails] AS roll
                        WHERE
                          stg.ActivityDetailKey = roll.ActivityDetailKey);

        -- record number of records inserted
        SELECT @recordsInserted = @@ROWCOUNT;
        COMMIT TRANSACTION;
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
      
      END; -- @processPoint 3

      -- 5.4 Update DriverKey,VehicleKey updates
      IF @processPoint < 4
      BEGIN
        BEGIN TRANSACTION;

        INSERT INTO [StageUser].[ROLLBACK_FACT_SimpleScoreDetails]
        ( 
          [SimpleScoreKey]               ,
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        )
        SELECT
          [SimpleScoreKey]               ,
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        FROM
         (UPDATE
            tar
          SET
            [ActivityStartDateKey]           = stg.[ActivityStartDateKey]         ,
            [DriverKey]                      = stg.[DriverKey]                    ,
            [VehicleKey]                     = stg.[VehicleKey]                   ,
            [UpdateBatchKey]                 = @batchKey
          OUTPUT
            DELETED.[SimpleScoreKey]               ,
            DELETED.[OrganisationKey]              ,
            DELETED.[ActivityDetailKey]            ,
            DELETED.[ActivityStartDateKey]         ,
            DELETED.[DriverKey]                    ,
            DELETED.[VehicleKey]                   ,
            DELETED.[DistanceTravelled]            ,
            DELETED.[DrivingTime]                  ,
            DELETED.[Duration]                     ,
            DELETED.[MaxSpeed]                     ,
            DELETED.[SpeedTime]                    ,
            DELETED.[SpeedOccurs]                  ,
            DELETED.[SpeedScore]                   ,
            DELETED.[SpeedScoreCiteriaKey]         ,
            DELETED.[MaxBrake]                     ,
            DELETED.[BrakeTime]                    ,
            DELETED.[BrakeOccurs]                  ,
            DELETED.[BrakeScore]                   ,
            DELETED.[BrakeScoreCiteriaKey]         ,
            DELETED.[MaxAccel]                     ,
            DELETED.[AccelTime]                    ,
            DELETED.[AccelOccurs]                  ,
            DELETED.[AccelScore]                   ,
            DELETED.[AccelScoreCiteriaKey]         ,
            DELETED.[MaxRPM]                       ,
            DELETED.[RPMTime]                      ,
            DELETED.[RPMOccurs]                    ,
            DELETED.[RPMScore]                     ,
            DELETED.[RPMScoreCiteriaKey]           ,
            DELETED.[OutOfGreenBandTime]           ,
            DELETED.[OutOfGreenBandScore]          ,
            DELETED.[OutOfGreenbandScoreCiteriaKey],
            DELETED.[ExcessiveIdleOccurs]          ,
            DELETED.[ExcessiveIdleTime]            ,
            DELETED.[ExcessiveIdleScore]           ,
            DELETED.[ExcessiveIdleScoreCiteriaKey] ,
            DELETED.[RoadSpeedTime]                ,
            DELETED.[RoadSpeedOccurs]              ,
            DELETED.[RoadSpeedScore]               ,
            DELETED.[IsDeleted]                    ,
            DELETED.[CreateBatchKey]               ,
            DELETED.[UpdateBatchKey]
          FROM
            [MiXData].dbo.FACT_SimpleScoreDetails    tar
              INNER JOIN
            [StageUser].[STAGE_FACT_SimpleScoreDetails] stg ON tar.ActivityDetailKey = stg.ActivityDetailKey
                                                           AND tar.OrganisationKey   = @organisationKey
          WHERE NOT EXISTS (SELECT 1 FROM [StageUser].[ROLLBACK_FACT_SimpleScoreDetails] roll
                            WHERE roll.ActivityDetailKey = stg.ActivityDetailKey)
          ) AS upd;

        -- record number of records updated
        SELECT @recordsUpdated = @@ROWCOUNT;
        COMMIT TRANSACTION;
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.4 Merge Updated Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
      END; -- @processPoint 4

      BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 5 AND ERROR_NUMBER() = 1205 -- DEADLOCK
        BEGIN
          EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
          IF @debugMode = 1  -- DebugMode is true
            BEGIN
              PRINT '5.error: deadlock occured, restarting merge';
              EXEC [Control].strProcProgressMonitor_Set
                @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
              SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
            END;
        END;
      ELSE
        BEGIN
          EXEC [Control].sprLogError @organisationKey = @organisationKey;
          RETURN -1;
          BREAK; -- out of while loop
        END;
    END CATCH;
  END -- While

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_SimpleScoreDetails];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_SiteSnapshotDaily_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_SiteSnapshotDaily on DW
-- ==============================================================================
/*
  Dependencies:

   FACT_ActivityDetails
   
   STAGE_FACT_ActivityDetails

*/
CREATE PROCEDURE [StageUser].[sprFACT_SiteSnapshotDaily_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;
  DECLARE @maxDuration         bigint = 2147483647; -- this is the max int data type value
  
  DECLARE	@currentDate     datetimeoffset; -- used for validation

  SELECT @currentDate = SYSUTCDATETIME();

  CREATE TABLE #ActivityChangedDates
  (
    VehicleSiteKey       INT,
    ActivityStartDateKey DATE
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_FACT_SiteSnapshotDaily];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_SiteSnapshotDaily];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY


    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_SiteSnapshotDaily]') AND name = N'IX_STAGE_FACT_SiteSnapshotDaily_VehicleSiteKey_SnapShotDateKey')
      DROP INDEX IX_STAGE_FACT_SiteSnapshotDaily_VehicleSiteKey_SnapShotDateKey ON [StageUser].[STAGE_FACT_SiteSnapshotDaily];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_SiteSnapshotDaily]') AND name = N'IX_ROLLBACK_FACT_SiteSnapshotDaily_SnapShotDateKey_VehicleSiteKey')
      DROP INDEX IX_ROLLBACK_FACT_SiteSnapshotDaily_SnapShotDateKey_VehicleSiteKey ON [StageUser].[ROLLBACK_FACT_SiteSnapshotDaily];

    -- create STAGE indexes
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey_VehicleSiteKey')
      CREATE INDEX IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey_VehicleSiteKey
        ON [StageUser].STAGE_FACT_ActivityDetails (ActivityStartDateKey,VehicleSiteKey);

    -- insert changed records into STG
    INSERT INTO #ActivityChangedDates
    ( ActivityStartDateKey,VehicleSiteKey )
    SELECT
      ActivityStartDateKey,
      VehicleSiteKey
    FROM
      [StageUser].STAGE_FACT_ActivityDetails
    GROUP BY
      ActivityStartDateKey,
      VehicleSiteKey;
    
    CREATE CLUSTERED INDEX IX_ActivityChangedDates ON #ActivityChangedDates(VehicleSiteKey,ActivityStartDateKey);

    INSERT INTO [StageUser].[STAGE_FACT_SiteSnapshotDaily]
    (
      SnapShotDateKey   ,
      VehicleSiteKey    ,
      UTCOffsetKey      ,

      VehiclesWithTrips ,
      DriversWithTrips  ,
      NumberOfTrips     ,
      NumberOfKMs       ,
      NumberOfHours     ,
      FuelUsedMeasured  ,
      FuelUsedCalculated,
      TotalIdlingTime
    )
    SELECT
      fad.ActivityStartDateKey  ,
      fad.VehicleSiteKey        ,
      fad.UTCOffsetKey          ,

      COUNT(DISTINCT fad.VehicleKey),
      COUNT(DISTINCT fad.DriverKey) ,
      COUNT(1)                      ,
      SUM(fad.DistanceTravelled)    ,
      CASE WHEN ABS(SUM(CONVERT(BIGINT,fad.DrivingTime))) > @maxDuration THEN -2 ELSE SUM(CONVERT(BIGINT,fad.DrivingTime)) END,

      CASE WHEN SUM(FuelUsedMeasured)   > 99999.0 THEN 99999.0 ELSE SUM(FuelUsedMeasured)   END,
      CASE WHEN SUM(FuelUsedCalculated) > 99999.0 THEN 99999.0 ELSE SUM(FuelUsedCalculated) END,

      CASE WHEN ABS(SUM(CONVERT(BIGINT,fad.IdleTime)))    > @maxDuration THEN -2 ELSE SUM(CONVERT(BIGINT,fad.IdleTime))    END
	  FROM
	    [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK)
	      INNER JOIN
	    #ActivityChangedDates                  ac ON fad.OrganisationKey      = @organisationKey
	                                            AND fad.ActivityStartDateKey = ac.ActivityStartDateKey
	                                            AND fad.VehicleSiteKey       = ac.VehicleSiteKey
	  GROUP BY
      fad.ActivityStartDateKey,
      fad.VehicleSiteKey      ,
      fad.UTCOffsetKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SiteSnapshotDaily_VehicleSiteKey_SnapShotDateKey
      ON [StageUser].[STAGE_FACT_SiteSnapshotDaily](VehicleSiteKey,SnapShotDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
    END;

    ------------------------------------------
    -- NumberOfCollisions
    UPDATE stg
    SET NumberOfCollisions = (SELECT COUNT(* )
                              FROM [MiXData].dbo.DIM_Sites ds WITH (NOLOCK)
                                     INNER JOIN
                                   [MiXData].dbo.DIM_Vehicles          dvh WITH (NOLOCK) ON ds.SiteGUID         = dvh.SiteGUID
                                                                                        AND ds.OrganisationKey  = @organisationKey
                                     INNER JOIN
                                   [MiXData].dbo.DIM_EventDescriptions ded WITH (NOLOCK) ON ded.OrganisationKey = ds.OrganisationKey
                                                                                        AND ded.HostID BETWEEN 49 AND 50
                                     INNER JOIN
                                   [MiXData].dbo.FACT_EventDetails     fed WITH (NOLOCK) ON ded.EventDescriptionKey = fed.EventDescriptionKey
                                                                                        AND dvh.VehicleKey          = fed.VehicleKey
                              WHERE  
                                  ds.SiteKey            = stg.VehicleSiteKey
                              AND fed.EventStartDateKey = stg.SnapShotDateKey)
    FROM [StageUser].STAGE_FACT_SiteSnapshotDaily stg;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update NumberOfCollisions', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- NumberOfActiveVehicles/NumberOfActiveDrivers
    UPDATE [StageUser].STAGE_FACT_SiteSnapshotDaily
    SET
      NumberOfActiveVehicles = (SELECT COUNT(DISTINCT dvh.VehicleKey)
                                FROM 
                                  [MiXData].dbo.DIM_Vehicles dvh WITH (NOLOCK)
                                    INNER JOIN
                                  [MiXData].dbo.DIM_Sites    ds  WITH (NOLOCK) ON dvh.OrganisationKey = @organisationKey
                                                                                 AND dvh.SiteGUID        = ds.SiteGUID
                                WHERE 
                                    dvh.IsActive        = 1
                                AND stg.VehicleSiteKey  = ds.SiteKey
                                AND stg.SnapShotDateKey BETWEEN dvh.StartDateKey AND dvh.EndDateKey),
      NumberOfActiveDrivers  = (SELECT COUNT(DISTINCT dd.DriverKey)
                                FROM 
                                  [MiXData].dbo.DIM_Drivers dd WITH (NOLOCK)
                                    INNER JOIN
                                  [MiXData].dbo.DIM_Sites   ds WITH (NOLOCK) ON dd.OrganisationKey = @organisationKey
                                                                               AND dd.SiteGUID        = ds.SiteGUID
                                WHERE 
                                    dd.IsActive         = 1
                                AND stg.VehicleSiteKey  = ds.SiteKey
                                AND stg.SnapShotDateKey BETWEEN dd.StartDateKey AND dd.EndDateKey)
    FROM
      [StageUser].STAGE_FACT_SiteSnapshotDaily stg;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3 Update NumberOfActiveVehicles/NumberOfActiveDrivers', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    ------------------------------------------
    -- VehicleUtilization/DriverUtilization
    UPDATE [StageUser].STAGE_FACT_SiteSnapshotDaily
    SET
      VehicleUtilization = CASE
                             WHEN NumberOfActiveVehicles > 0
                               THEN VehiclesWithTrips/CONVERT(FLOAT,NumberOfActiveVehicles)
                             ELSE 0.0
                           END,
      DriverUtilization  =  CASE
                             WHEN NumberOfActiveDrivers  > 0
                               THEN VehiclesWithTrips/CONVERT(FLOAT,NumberOfActiveDrivers)
                             ELSE 0.0
                           END;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.4 Update VehicleUtilization/DriverUtilization', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Changed records
    INSERT INTO [StageUser].[ROLLBACK_FACT_SiteSnapshotDaily]
    ( 
      SiteSnapShotKey   ,
      OrganisationKey   ,
      SnapShotDateKey   ,
      VehicleSiteKey    ,
      VehiclesWithTrips ,
      DriversWithTrips  ,
      NumberOfTrips     ,
      NumberOfCollisions ,
      NumberOfKMs       ,
      NumberOfHours     ,
      FuelUsedMeasured  ,
      FuelUsedCalculated,
      TotalIdlingTime   ,
      NumberOfActiveVehicles,
      NumberOfActiveDrivers, 
      VehicleUtilization,    
      DriverUtilization ,    
      UTCOffsetKey      ,
      IsDeleted         ,
      CreateBatchKey    ,
      UpdateBatchKey
    )
    SELECT
      SiteSnapShotKey   ,
      OrganisationKey   ,
      SnapShotDateKey   ,
      VehicleSiteKey    ,
      VehiclesWithTrips ,
      DriversWithTrips  ,
      NumberOfTrips     ,
      NumberOfCollisions ,
      NumberOfKMs       ,
      NumberOfHours     ,
      FuelUsedMeasured  ,
      FuelUsedCalculated,
      TotalIdlingTime   ,
      NumberOfActiveVehicles,
      NumberOfActiveDrivers,
      VehicleUtilization,    
      DriverUtilization ,    
      UTCOffsetKey      ,
      IsDeleted         ,
      CreateBatchKey    ,
      UpdateBatchKey
    FROM
     (UPDATE
        tar
      SET
        VehiclesWithTrips      = stg.VehiclesWithTrips ,
        DriversWithTrips       = stg.DriversWithTrips  ,
        NumberOfTrips          = stg.NumberOfTrips     ,
        NumberOfCollisions     = ISNULL(stg.NumberOfCollisions,0),
        NumberOfKMs            = stg.NumberOfKMs       ,
        NumberOfHours          = stg.NumberOfHours     ,
        FuelUsedMeasured       = stg.FuelUsedMeasured  ,
        FuelUsedCalculated     = stg.FuelUsedCalculated,
        TotalIdlingTime        = stg.TotalIdlingTime   ,
        NumberOfActiveVehicles = ISNULL(stg.NumberOfActiveVehicles,0),
        NumberOfActiveDrivers  = ISNULL(stg.NumberOfActiveDrivers,0),
        VehicleUtilization     = stg.VehicleUtilization,
        DriverUtilization      = stg.DriverUtilization,
        UTCOffsetKey           = stg.UTCOffsetKey      ,
        UpdateBatchKey         = @batchKey
      OUTPUT
        DELETED.SiteSnapShotKey   ,
        DELETED.OrganisationKey   ,
        DELETED.SnapShotDateKey   ,
        DELETED.VehicleSiteKey    ,
        DELETED.VehiclesWithTrips ,
        DELETED.DriversWithTrips  ,
        DELETED.NumberOfTrips     ,
        DELETED.NumberOfCollisions ,
        DELETED.NumberOfKMs       ,
        DELETED.NumberOfHours     ,
        DELETED.FuelUsedMeasured  ,
        DELETED.FuelUsedCalculated,
        DELETED.TotalIdlingTime   ,
        DELETED.NumberOfActiveVehicles,
        DELETED.NumberOfActiveDrivers, 
        DELETED.VehicleUtilization,    
        DELETED.DriverUtilization ,    
        DELETED.UTCOffsetKey      ,
        0 AS IsDeleted            ,
        DELETED.CreateBatchKey    ,
        DELETED.UpdateBatchKey
      FROM 
       [MiXData].dbo.FACT_SiteSnapshotDaily    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser].[STAGE_FACT_SiteSnapshotDaily] AS stg ON tar.OrganisationKey = @organisationKey
                                                       AND tar.SnapShotDateKey = stg.SnapShotDateKey
                                                       AND tar.VehicleSiteKey  = stg.VehicleSiteKey
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_SiteSnapshotDaily_SnapShotDateKey_VehicleSiteKey
      ON [StageUser].[ROLLBACK_FACT_SiteSnapshotDaily](SnapShotDateKey,VehicleSiteKey);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_SiteSnapshotDaily
    ( 
      OrganisationKey   ,
      SnapShotDateKey   ,
      VehicleSiteKey    ,
      VehiclesWithTrips ,
      DriversWithTrips  ,
      NumberOfTrips     ,
      NumberOfCollisions ,
      NumberOfKMs       ,
      NumberOfHours     ,
      FuelUsedMeasured  ,
      FuelUsedCalculated,
      TotalIdlingTime   ,
      NumberOfActiveVehicles,
      NumberOfActiveDrivers, 
      VehicleUtilization,    
      DriverUtilization ,    
      UTCOffsetKey      ,
      CreateBatchKey    ,
      UpdateBatchKey
    )
    SELECT
      @organisationKey  ,
      SnapShotDateKey   ,
      VehicleSiteKey    ,
      VehiclesWithTrips ,
      DriversWithTrips  ,
      NumberOfTrips     ,
      ISNULL(NumberOfCollisions,0),
      NumberOfKMs       ,
      NumberOfHours     ,
      FuelUsedMeasured  ,
      FuelUsedCalculated,
      TotalIdlingTime   ,
      ISNULL(NumberOfActiveVehicles,0),
      ISNULL(NumberOfActiveDrivers,0),
      VehicleUtilization,    
      DriverUtilization ,    
      UTCOffsetKey      ,
      @batchKey         ,
      @batchKey
    FROM
      [StageUser].[STAGE_FACT_SiteSnapshotDaily]    AS stg
    WHERE
      NOT EXISTS (SELECT 1
                  FROM
                    [StageUser].[ROLLBACK_FACT_SiteSnapshotDaily] AS roll WITH (NOLOCK)
                  WHERE
                      stg.SnapShotDateKey = roll.SnapShotDateKey
                  AND stg.VehicleSiteKey  = roll.VehicleSiteKey);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.2 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_SiteSnapshotDaily];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_TachoData_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_TachoData on DW
-- ==============================================================================
/*
  Dependencies:


*/
CREATE PROCEDURE [StageUser].[sprFACT_TachoData_Transform]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE	@currentDate        datetimeoffset; -- used for validation

  SELECT @currentDate = SYSUTCDATETIME();
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_FACT_TachoData];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_TachoData];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_TachoData]') AND name = N'IX_STAGE_FACT_TachoData_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_TachoData_HostID_Operation ON [StageUser].[STAGE_FACT_TachoData];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_TachoData]') AND name = N'IX_STAGE_FACT_TachoData_VehicleID_TachoStartDateKey')
      DROP INDEX IX_STAGE_FACT_TachoData_VehicleID_TachoStartDateKey ON [StageUser].[STAGE_FACT_TachoData];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_TachoData]') AND name = N'IX_ROLLBACK_FACT_TachoData_HostID')
      DROP INDEX IX_ROLLBACK_FACT_TachoData_HostID ON [StageUser].[ROLLBACK_FACT_TachoData];
  
    -- insert changed records into STG
	  INSERT INTO [StageUser].[STAGE_FACT_TachoData]
	  ( [Operation]         ,
      [HostID]            ,
      [BlockSequence]     ,
      [VehicleID]         ,
      [TachoStartDateKey] ,
      [TachoEndDateKey]   ,
      [TachoStartDateTime],
      [TachoEndDateTime]  ,
      [RawData]           ,
      [UTCOffsetKey]
	  )
	  SELECT
	    s.Operation              ,
      HostID = s.RID           ,
      s.BlockSequence          ,
      s.VehicleID              ,
      CONVERT(DATE,s.StartDate),
      CONVERT(DATE,s.EndDate)  ,
      CASE 
        WHEN s.StartDate IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.StartDate,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      CASE 
        WHEN s.EndDate IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.EndDate,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      s.RawData                ,
      utc.UTCOffsetKey
	  FROM
	    [StageUser].TachoData                  s   WITH (NOLOCK)
	      CROSS JOIN
	    [StageUser].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
	  WHERE
        ISNULL(CONVERT(DATETIMEOFFSET(0),s.StartDate),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.StartDate),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create indexes required for lookups
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_TachoData_HostID_Operation 
      ON [StageUser].[STAGE_FACT_TachoData](HostID,Operation);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_TachoData_VehicleID_TachoStartDateKey
      ON [StageUser].[STAGE_FACT_TachoData](VehicleID,TachoStartDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
    END;

    ------------------------------------------
    -- VehicleKey
    UPDATE
      [StageUser].[STAGE_FACT_TachoData]
    SET
      VehicleKey = dv.[VehicleKey]
    FROM
      [StageUser].[STAGE_FACT_TachoData] stg
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles      dv  WITH (NOLOCK)
        ON  dv.OrganisationKey = @organisationKey
        AND stg.VehicleID      = dv.HostID
    WHERE
      stg.TachoStartDateKey BETWEEN dv.StartDateKey AND dv.EndDateKey;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update VehicleKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    ------------------------------------------
    -- UTCOffsetKey (use company UTC for now, will change in future)
/*    
    UPDATE [StageUser].[STAGE_FACT_TachoData]
    SET
      UTCOffsetKey = utc.UTCOffsetKey
    FROM
      [StageUser].[STAGE_FACT_TachoData] stg,
      [StageUser].STAGE_DIM_UTCOffsetsLookUp utc WITH (NOLOCK)
    WHERE
        stg.TachoStartDateKey BETWEEN utc.StartDateKey    AND utc.EndDateKey
    AND stg.TachoStartDateKey BETWEEN utc.SeasonStartDate AND utc.SeasonEndDate;
*/

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Changed records
    INSERT INTO [StageUser].[ROLLBACK_FACT_TachoData]
    ( 
      [TachoDataKey]      ,
      [HostID]            ,
      [OrganisationKey]   ,
      [BlockSequence]     ,
      [VehicleKey]        ,
      [TachoStartDateKey] ,
      [TachoEndDateKey]   ,
      [TachoStartDateTime],
      [TachoEndDateTime]  ,
      [RawData]           ,
      [MaxSpeed]          ,
      [MinSpeed]          ,
      [AvgSpeed]          ,
      [UTCOffsetKey]      ,
      [IsDeleted]         ,
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    )
    SELECT
      [TachoDataKey]      ,
      [HostID]            ,
      [OrganisationKey]   ,
      [BlockSequence]     ,
      [VehicleKey]        ,
      [TachoStartDateKey] ,
      [TachoEndDateKey]   ,
      [TachoStartDateTime],
      [TachoEndDateTime]  ,
      [RawData]           ,
      [MaxSpeed]          ,
      [MinSpeed]          ,
      [AvgSpeed]          ,
      [UTCOffsetKey]      ,
      [IsDeleted]         ,
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [VehicleKey]         = ISNULL(stg.[VehicleKey]        ,-1),
        [BlockSequence]      = stg.[BlockSequence]     ,
        [TachoStartDateKey]  = stg.[TachoStartDateKey] ,
        [TachoEndDateKey]    = stg.[TachoEndDateKey]   ,
        [TachoStartDateTime] = stg.[TachoStartDateTime],
        [TachoEndDateTime]   = stg.[TachoEndDateTime]  ,
        [RawData]            = stg.[RawData]           ,
        [MaxSpeed]           = stg.[MaxSpeed]          ,
        [MinSpeed]           = stg.[MinSpeed]          ,
        [AvgSpeed]           = stg.[AvgSpeed]          ,
        [UTCOffsetKey]       = stg.[UTCOffsetKey]      ,
        [IsDeleted]          = 0                       ,
        [UpdateBatchKey]     = @batchKey
      OUTPUT
        DELETED.[TachoDataKey]      ,
        DELETED.[HostID]            ,
        DELETED.[OrganisationKey]   ,
        DELETED.[BlockSequence]     ,
        DELETED.[VehicleKey]        ,
        DELETED.[TachoStartDateKey] ,
        DELETED.[TachoEndDateKey]   ,
        DELETED.[TachoStartDateTime],
        DELETED.[TachoEndDateTime]  ,
        DELETED.[RawData]           ,
        DELETED.[MaxSpeed]          ,
        DELETED.[MinSpeed]          ,
        DELETED.[AvgSpeed]          ,
        DELETED.[UTCOffsetKey]      ,
        DELETED.[IsDeleted]         ,
        DELETED.[CreateBatchKey]    ,
        DELETED.[UpdateBatchKey]
      FROM 
       [MiXData].dbo.FACT_TachoData    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser].[STAGE_FACT_TachoData] AS stg ON tar.HostID          = stg.HostID
                                                AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation in ('I','U')
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    -- Deleted records
    INSERT INTO [StageUser].[ROLLBACK_FACT_TachoData]
    ( 
      [TachoDataKey]      ,
      [HostID]            ,
      [OrganisationKey]   ,
      [BlockSequence]     ,
      [VehicleKey]        ,
      [TachoStartDateKey] ,
      [TachoEndDateKey]   ,
      [TachoStartDateTime],
      [TachoEndDateTime]  ,
      [RawData]           ,
      [MaxSpeed]          ,
      [MinSpeed]          ,
      [AvgSpeed]          ,
      [UTCOffsetKey]      ,
      [IsDeleted]         ,
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    )
    SELECT
      [TachoDataKey]      ,
      [HostID]            ,
      [OrganisationKey]   ,
      [BlockSequence]     ,
      [VehicleKey]        ,
      [TachoStartDateKey] ,
      [TachoEndDateKey]   ,
      [TachoStartDateTime],
      [TachoEndDateTime]  ,
      [RawData]           ,
      [MaxSpeed]          ,
      [MinSpeed]          ,
      [AvgSpeed]          ,
      [UTCOffsetKey]      ,
      [IsDeleted]         ,
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]          = 1,
        [UpdateBatchKey]     = @batchKey
      OUTPUT
        DELETED.[TachoDataKey]      ,
        DELETED.[HostID]            ,
        DELETED.[OrganisationKey]   ,
        DELETED.[BlockSequence]     ,
        DELETED.[VehicleKey]        ,
        DELETED.[TachoStartDateKey] ,
        DELETED.[TachoEndDateKey]   ,
        DELETED.[TachoStartDateTime],
        DELETED.[TachoEndDateTime]  ,
        DELETED.[RawData]           ,
        DELETED.[MaxSpeed]          ,
        DELETED.[MinSpeed]          ,
        DELETED.[AvgSpeed]          ,
        DELETED.[UTCOffsetKey]      ,
        DELETED.[IsDeleted]         ,
        DELETED.[CreateBatchKey]    ,
        DELETED.[UpdateBatchKey]
      FROM 
       [MiXData].dbo.FACT_TachoData    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser].[STAGE_FACT_TachoData] AS stg ON tar.HostID          = stg.HostID
                                                AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation = 'D'
      ) AS del;

    -- record number of records deleted  
    SELECT @recordsDeleted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;  
    END;  

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_TachoData_HostID
      ON [StageUser].[ROLLBACK_FACT_TachoData](HostID);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_TachoData
    ( 
      [OrganisationKey]   ,
      [HostID]            ,
      [BlockSequence]     ,
      [VehicleKey]        ,
      [TachoStartDateKey] ,
      [TachoEndDateKey]   ,
      [TachoStartDateTime],
      [TachoEndDateTime]  ,
      [RawData]           ,
      [MaxSpeed]          ,
      [MinSpeed]          ,
      [AvgSpeed]          ,
      [UTCOffsetKey]      ,
      [IsDeleted]         ,
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey        ,
      stg.[HostID]            ,
      stg.[BlockSequence]     ,
      ISNULL(stg.[VehicleKey]        ,-1),
      stg.[TachoStartDateKey] ,
      stg.[TachoEndDateKey]   ,
      stg.[TachoStartDateTime],
      stg.[TachoEndDateTime]  ,
      stg.[RawData]           ,
      stg.[MaxSpeed]          ,
      stg.[MinSpeed]          ,
      stg.[AvgSpeed]          ,
      stg.[UTCOffsetKey]      ,
      0                       , --IsDeleted
      @batchKey               ,
      @batchKey
    FROM
      [StageUser].[STAGE_FACT_TachoData]    AS stg
    WHERE
        stg.Operation IN ('I','U')
    AND NOT EXISTS (SELECT 1
                    FROM
                      [StageUser].[ROLLBACK_FACT_TachoData] AS roll WITH (NOLOCK)
                    WHERE
                      stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_TachoData];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_TerminalDetails_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_TerminalDetails on DW (details of terminal)
-- ==============================================================================
/*
  Dependencies:
  
  All DIMs
  FACT_ActivityDetails

*/
CREATE PROCEDURE [StageUser].[sprFACT_TerminalDetails_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;
  DECLARE @nrOfValidationErrors   int = 0;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE	@currentDate     datetimeoffset; -- used for validation

  SELECT @currentDate = SYSUTCDATETIME();
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_FACT_TerminalDetails];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_TerminalDetails];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY


    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_TerminalDetails]') AND name = N'IX_STAGE_FACT_TerminalDetails_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_TerminalDetails_HostID_Operation ON [StageUser].[STAGE_FACT_TerminalDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_TerminalDetails]') AND name = N'IX_STAGE_FACT_TerminalDetails_VehicleID_TerminalDateTime_TerminalDateKey')
      DROP INDEX IX_STAGE_FACT_TerminalDetails_VehicleID_TerminalDateTime_TerminalDateKey ON [StageUser].[STAGE_FACT_TerminalDetails];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_TerminalDetails]') AND name = N'IX_ROLLBACK_FACT_TerminalDetails_HostID')
      DROP INDEX IX_ROLLBACK_FACT_TerminalDetails_HostID ON [StageUser].[ROLLBACK_FACT_TerminalDetails];

    -- insert changed records into STG
    INSERT INTO [StageUser].[STAGE_FACT_TerminalDetails]
    ( 
      [Operation]       ,
      [HostID]          ,
      [VehicleID]       ,
      [TerminalDateKey] ,
      [TerminalTime]    ,
      [TerminalDateTime],
      [Odometer]        ,
      [MenuID]          ,
      [MenuItemCode]    ,
      [ValueType]       ,
      [NumberValue]     ,
      [StringValue]     ,
      [UTCOffsetKey]
    )
    SELECT
      s.Operation        ,
      HostID = s.EventKey,
      s.VehicleID        ,
      [TerminalDateKey] = CONVERT(DATE,   s.EventDate),
      [TerminalTime]    = CONVERT(TIME(0),s.EventDate),
      CASE 
        WHEN s.EventDate IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.EventDate,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      s.Odometer         ,
      s.MenuID           ,
      s.MenuItemCode     ,
      s.ValueType        ,
      s.NumberValue      ,
      s.StringValue      ,
      utc.UTCOffsetKey
    FROM
      [StageUser].TerminalData s WITH (NOLOCK)
        CROSS JOIN
      [StageUser].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
    WHERE
        ISNULL(CONVERT(DATETIMEOFFSET(0),s.EventDate),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.EventDate),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_TerminalDetails_HostID_Operation 
      ON [StageUser].[STAGE_FACT_TerminalDetails](HostID,Operation);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_TerminalDetails_VehicleID_TerminalDateTime_TerminalDateKey 
      ON [StageUser].[STAGE_FACT_TerminalDetails](VehicleID,TerminalDateTime,TerminalDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
    END;

    ------------------------------------------
    -- VehicleKey
    UPDATE
      [StageUser].[STAGE_FACT_TerminalDetails]
    SET
      VehicleKey = dv.[VehicleKey]
    FROM
      [StageUser].[STAGE_FACT_TerminalDetails] stg
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles            dv  WITH (NOLOCK) ON stg.VehicleID      = dv.HostID
                                                             AND dv.OrganisationKey = @organisationKey
    WHERE
      stg.[TerminalDateKey] BETWEEN dv.StartDateKey AND dv.EndDateKey;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update VehicleKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    ------------------------------------------
    -- ActivityDetailKey/DriverKey
    -- disabled for initial run
    UPDATE
      [StageUser].[STAGE_FACT_TerminalDetails]
    SET
      ActivityDetailKey   = fad.[ActivityDetailKey],
      DriverKey           = fad.[DriverKey]
    FROM
      [MiXData].dbo.DIM_Vehicles            dv  WITH (NOLOCK)
        INNER JOIN
      [StageUser].[STAGE_FACT_TerminalDetails] stg               ON dv.OrganisationKey   = @organisationKey
                                                                AND stg.VehicleID        = dv.HostID
        INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails    fad WITH (NOLOCK) ON fad.VehicleKey      = dv.VehicleKey
    WHERE
      stg.[TerminalDateTime] BETWEEN fad.ActivityStartDateTime AND fad.ActivityEndDateTime;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3 Update ActivityDetailKey/DriverKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    ------------------------------------------
    -- UTCOffsetKey (use company UTC for now, will change in future)

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------

  -- EventDate is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser].[STAGE_FACT_TerminalDetails]  
    WHERE 
        [TerminalDateKey] IS NULL
    AND Operation         <> 'D';
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some TerminalDetails has EventDates of null',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.1 Validation before Loading to DW (EventDate is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;  
  END CATCH;

  -- Remove dirty data
  BEGIN TRY  

    DELETE
      [StageUser].[STAGE_FACT_TerminalDetails]
    WHERE
       [TerminalDateKey] IS NULL
    AND Operation        <> 'D';

  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Changed records
    INSERT INTO [StageUser].[ROLLBACK_FACT_TerminalDetails]
    ( 
      [TerminalDetailKey],
      [OrganisationKey]  ,
      [HostID]           ,
      [VehicleKey]       ,
      [DriverKey]        ,
      [TerminalDateKey]  ,
      [TerminalTime]     ,
      [TerminalDateTime] ,
      [Odometer]         ,
      [MenuID]           ,
      [MenuItemCode]     ,
      [ValueType]        ,
      [NumberValue]      ,
      [StringValue]      ,
      [ActivityDetailKey],
      [UTCOffsetKey]     ,
      [IsDeleted]        ,
      [CreateBatchKey]   ,
      [UpdateBatchKey]
    )
    SELECT
      [TerminalDetailKey],
      [OrganisationKey]  ,
      [HostID]           ,
      [VehicleKey]       ,
      [DriverKey]        ,
      [TerminalDateKey]  ,
      [TerminalTime]     ,
      [TerminalDateTime] ,
      [Odometer]         ,
      [MenuID]           ,
      [MenuItemCode]     ,
      [ValueType]        ,
      [NumberValue]      ,
      [StringValue]      ,
      [ActivityDetailKey],
      [UTCOffsetKey]     ,
      [IsDeleted]        ,
      [CreateBatchKey]   ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [VehicleKey]         = ISNULL(stg.[VehicleKey]       ,-1),
        [DriverKey]          = ISNULL(stg.[DriverKey]        ,-1),
        [TerminalDateKey]    = stg.[TerminalDateKey]  ,
        [TerminalTime]       = stg.[TerminalTime]     ,
        [Odometer]           = stg.[Odometer]         ,
        [MenuID]             = stg.[MenuID]           ,
        [MenuItemCode]       = stg.[MenuItemCode]     ,
        [ValueType]          = stg.[ValueType]        ,
        [NumberValue]        = stg.[NumberValue]      ,
        [StringValue]        = stg.[StringValue]      ,
        [ActivityDetailKey]  = ISNULL(stg.[ActivityDetailKey],-1),
        [UTCOffsetKey]       = stg.[UTCOffsetKey]     ,
        [IsDeleted]          = 0                      ,
        [UpdateBatchKey]     = @batchKey
      OUTPUT
        DELETED.[TerminalDetailKey],
        DELETED.[OrganisationKey]  ,
        DELETED.[HostID]           ,
        DELETED.[VehicleKey]       ,
        DELETED.[DriverKey]        ,
        DELETED.[TerminalDateKey]  ,
        DELETED.[TerminalTime]     ,
        DELETED.[TerminalDateTime] ,
        DELETED.[Odometer]         ,
        DELETED.[MenuID]           ,
        DELETED.[MenuItemCode]     ,
        DELETED.[ValueType]        ,
        DELETED.[NumberValue]      ,
        DELETED.[StringValue]      ,
        DELETED.[ActivityDetailKey],
        DELETED.[UTCOffsetKey]     ,
        DELETED.[IsDeleted]        ,
        DELETED.[CreateBatchKey]   ,
        DELETED.[UpdateBatchKey]
      FROM 
       [MiXData].dbo.FACT_TerminalDetails    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser].[STAGE_FACT_TerminalDetails] AS stg ON tar.HostID          = stg.HostID
                                                      AND tar.OrganisationKey = @organisationKey

      WHERE stg.Operation in ('I','U')
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    -- Deleted records
    INSERT INTO [StageUser].[ROLLBACK_FACT_TerminalDetails]
    ( 
      [TerminalDetailKey],
      [OrganisationKey]  ,
      [HostID]           ,
      [VehicleKey]       ,
      [DriverKey]        ,
      [TerminalDateKey]  ,
      [TerminalTime]     ,
      [TerminalDateTime] ,
      [Odometer]         ,
      [MenuID]           ,
      [MenuItemCode]     ,
      [ValueType]        ,
      [NumberValue]      ,
      [StringValue]      ,
      [ActivityDetailKey],
      [UTCOffsetKey]     ,
      [IsDeleted]        ,
      [CreateBatchKey]   ,
      [UpdateBatchKey]
    )
    SELECT
      [TerminalDetailKey],
      [OrganisationKey]  ,
      [HostID]           ,
      [VehicleKey]       ,
      [DriverKey]        ,
      [TerminalDateKey]  ,
      [TerminalTime]     ,
      [TerminalDateTime] ,
      [Odometer]         ,
      [MenuID]           ,
      [MenuItemCode]     ,
      [ValueType]        ,
      [NumberValue]      ,
      [StringValue]      ,
      [ActivityDetailKey],
      [UTCOffsetKey]     ,
      [IsDeleted]        ,
      [CreateBatchKey]   ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]          = 1,
        [UpdateBatchKey]     = @batchKey
      OUTPUT
        DELETED.[TerminalDetailKey],
        DELETED.[OrganisationKey]  ,
        DELETED.[HostID]           ,
        DELETED.[VehicleKey]       ,
        DELETED.[DriverKey]        ,
        DELETED.[TerminalDateKey]  ,
        DELETED.[TerminalTime]     ,
        DELETED.[TerminalDateTime] ,
        DELETED.[Odometer]         ,
        DELETED.[MenuID]           ,
        DELETED.[MenuItemCode]     ,
        DELETED.[ValueType]        ,
        DELETED.[NumberValue]      ,
        DELETED.[StringValue]      ,
        DELETED.[ActivityDetailKey],
        DELETED.[UTCOffsetKey]     ,
        DELETED.[IsDeleted]        ,
        DELETED.[CreateBatchKey]   ,
        DELETED.[UpdateBatchKey]
      FROM 
       [MiXData].dbo.FACT_TerminalDetails    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser].[STAGE_FACT_TerminalDetails] AS stg ON tar.HostID          = stg.HostID
                                                      AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation = 'D'
      ) AS del;

    -- record number of records deleted  
    SELECT @recordsDeleted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;  
    END;  

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_TerminalDetails_HostID
      ON [StageUser].[ROLLBACK_FACT_TerminalDetails](HostID);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_TerminalDetails
    ( 
      [OrganisationKey]  ,
      [HostID]           ,
      [VehicleKey]       ,
      [DriverKey]        ,
      [TerminalDateKey]  ,
      [TerminalTime]     ,
      [TerminalDateTime] ,
      [Odometer]         ,
      [MenuID]           ,
      [MenuItemCode]     ,
      [ValueType]        ,
      [NumberValue]      ,
      [StringValue]      ,
      [ActivityDetailKey],
      [UTCOffsetKey]     ,
      [IsDeleted]        ,
      [CreateBatchKey]   ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey       ,
      stg.[HostID]           ,
      ISNULL(stg.[VehicleKey]       ,-1),
      ISNULL(stg.[DriverKey]        ,-1),
      stg.[TerminalDateKey]  ,
      stg.[TerminalTime]     ,
      stg.[TerminalDateTime] ,
      stg.[Odometer]         ,
      stg.[MenuID]           ,
      stg.[MenuItemCode]     ,
      stg.[ValueType]        ,
      stg.[NumberValue]      ,
      stg.[StringValue]      ,
      ISNULL(stg.[ActivityDetailKey],-1),
      stg.[UTCOffsetKey]     ,
      0                      , --IsDeleted
      @batchKey              ,
      @batchKey
    FROM
      [StageUser].[STAGE_FACT_TerminalDetails]    AS stg
    WHERE
        stg.Operation IN ('I','U')
    AND NOT EXISTS (SELECT 1
                    FROM
                      [StageUser].[ROLLBACK_FACT_TerminalDetails] AS roll WITH (NOLOCK)
                    WHERE
                      stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_TerminalDetails];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprFACT_VehicleCosts_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Populates FACT_VehicleCosts on DW (details of vehicle costs)
-- ==============================================================================
/*
  Dependencies:
  
  DIM_Currencies
  DIM_Vehicles
  DIM_VehicleCostCategories
  
  STAGE_DIM_UTCOffsetsLookUp
  
  ExtensionProperties_FACT

*/
CREATE PROCEDURE [StageUser].[sprFACT_VehicleCosts_Transform]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  
  DECLARE	@currentDate     datetimeoffset; -- used for validation

  SELECT @currentDate = SYSUTCDATETIME();
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser].[STAGE_FACT_VehicleCosts];
  TRUNCATE TABLE [StageUser].[ROLLBACK_FACT_VehicleCosts];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[STAGE_FACT_VehicleCosts]') AND name = N'IX_STAGE_FACT_VehicleCosts_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_VehicleCosts_HostID_Operation ON [StageUser].[STAGE_FACT_VehicleCosts];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser].[ROLLBACK_FACT_VehicleCosts]') AND name = N'IX_ROLLBACK_FACT_VehicleCosts_HostID')
      DROP INDEX IX_ROLLBACK_FACT_VehicleCosts_HostID ON [StageUser].[ROLLBACK_FACT_VehicleCosts];
  
    -- insert changed records into STG
	  INSERT INTO [StageUser].[STAGE_FACT_VehicleCosts]
	  ( 
	    [Operation]      ,
      [HostID]         ,
      [VehicleID]      ,
      [CategoryID]     ,
      [CostDateKey]        ,
      [OdometerReading],
      [BaseCost]       ,
      [BaseCurrency]
	  )
    SELECT
      s.Operation                                                                  ,
      HostID       = s.sProperty                                                   ,
      VehicleID    = s.liObjectID                                                  ,
      CategoryID   = dbo.fncGetListItemInt(ISNULL(s.sValue,''),'CategoryID',0)                , --CONVERT(INT,dbo.fncStringColumnValueGet('CategoryID',s.sValue)),
      DateKey      = CONVERT(DATE,CONVERT(DATETIME,dbo.fncGetListItemFloat(ISNULL(s.sValue,''),'DateTime',0))),
      Odo          = dbo.fncGetListItemFloat(ISNULL(s.sValue,''),'Odo',0.0)                   , --CONVERT(INT,dbo.fncStringColumnValueGet('Odo',s.sValue)),      
      BaseValue    = dbo.fncGetListItemFloat(ISNULL(s.sValue,''),'BaseValue',0.0)             , --CONVERT(NUMERIC(16,4),dbo.fncStringColumnValueGet('BaseValue',s.sValue)),
      BaseCurrCode = dbo.fncGetListItem(ISNULL(s.sValue,''),'BaseCurrCode','')
    FROM
      [StageUser].ExtensionProperties_FACT s WITH (NOLOCK)
    WHERE
        s.sAppID       = 'Costing'
    AND s.liObjectType = 1;  -- transactional costing values

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_VehicleCosts_HostID_Operation 
      ON [StageUser].[STAGE_FACT_VehicleCosts](HostID,Operation);

    ------------------------------------------
    -- VehicleKey
    UPDATE
      [StageUser].[STAGE_FACT_VehicleCosts]
    SET
      [VehicleKey] = dv.[VehicleKey]
    FROM
      [StageUser].[STAGE_FACT_VehicleCosts] stg
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles      dv  WITH (NOLOCK)
        ON  dv.OrganisationKey = @organisationKey
        AND stg.VehicleID      = dv.HostID
    WHERE
      stg.CostDateKey BETWEEN dv.StartDateKey AND dv.EndDateKey;

    ------------------------------------------
    -- CostCategoryKey/IsRecurring
    UPDATE
      [StageUser].[STAGE_FACT_VehicleCosts]
    SET
      [CostCategoryKey] = dvc.[VehicleCostCategoryKey],
      [IsRecurring]     = dvc.[IsRecurring]
    FROM
      [StageUser].[STAGE_FACT_VehicleCosts] stg
        INNER JOIN
      [MiXData].dbo.DIM_VehicleCostCategories dvc WITH (NOLOCK)
        ON  dvc.[OrganisationKey] = @organisationKey
        AND dvc.[HostID]          = stg.[CategoryID];

    ------------------------------------------
    -- BaseCurrencyKey
    UPDATE
      [StageUser].[STAGE_FACT_VehicleCosts]
    SET
      [BaseCurrencyKey] = dc.[CurrencyKey]
    FROM
      [StageUser].[STAGE_FACT_VehicleCosts] stg
        INNER JOIN
      [MiXData].dbo.DIM_Currencies dc WITH (NOLOCK)
        ON  dc.[CurrencyAlternateKey] = stg.[BaseCurrency];

    ------------------------------------------
    -- UTCOffsetKey (use company UTC for now, will change in future)
    UPDATE [StageUser].[STAGE_FACT_VehicleCosts]
    SET
      UTCOffsetKey         = utc.[UTCOffsetKey]
    FROM
      [StageUser].[STAGE_FACT_VehicleCosts]    stg,
      [StageUser].STAGE_DIM_UTCOffsetsLookUp utc WITH (NOLOCK)
    WHERE
        stg.[CostDateKey] BETWEEN utc.[StartDateKey]        AND utc.[EndDateKey]
    AND stg.[CostDateKey] BETWEEN utc.[SeasonStartDateTime] AND utc.[SeasonEndDateTime]

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Add to RollBck table
    INSERT INTO [StageUser].[ROLLBACK_FACT_VehicleCosts]
    ( 
      [VehicleCostKey] ,
      [OrganisationKey],
      [HostID]         ,
      [CostDateKey]    ,
      [IsRecurring]    ,
      [VehicleKey]     ,
      [OdometerReading],
      [CostCategoryKey],
      [BaseCost]       ,
      [BaseCurrencyKey],
      [UTCOffsetKey]   ,
      [IsDeleted]      ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      [VehicleCostKey] ,
      [OrganisationKey],
      [HostID]         ,
      [CostDateKey]    ,
      [IsRecurring]    ,
      [VehicleKey]     ,
      [OdometerReading],
      [CostCategoryKey],
      [BaseCost]       ,
      [BaseCurrencyKey],
      [UTCOffsetKey]   ,
      [IsDeleted]      ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [CostDateKey]     = stg.[CostDateKey]    ,
        [IsRecurring]     = stg.[IsRecurring]    ,
        [VehicleKey]      = ISNULL(stg.[VehicleKey]     ,-1),
        [OdometerReading] = stg.[OdometerReading],
        [CostCategoryKey] = ISNULL(stg.[CostCategoryKey],-1),
        [BaseCost]        = stg.[BaseCost]       ,
        [BaseCurrencyKey] = ISNULL(stg.[BaseCurrencyKey],-1),
        [UTCOffsetKey]    = stg.[UTCOffsetKey]   ,
        [IsDeleted]       = 0                    ,
        [UpdateBatchKey]  = @batchKey
      OUTPUT
        DELETED.[VehicleCostKey] ,
        DELETED.[OrganisationKey],
        DELETED.[HostID]         ,
        DELETED.[CostDateKey]    ,
        DELETED.[IsRecurring]    ,
        DELETED.[VehicleKey]     ,
        DELETED.[OdometerReading],
        DELETED.[CostCategoryKey],
        DELETED.[BaseCost]       ,
        DELETED.[BaseCurrencyKey],
        DELETED.[UTCOffsetKey]   ,
        DELETED.[IsDeleted]      ,
        DELETED.[CreateBatchKey] ,
        DELETED.[UpdateBatchKey]
      FROM [MiXData].dbo.FACT_VehicleCosts    AS tar
             INNER JOIN
           [StageUser].[STAGE_FACT_VehicleCosts] AS stg ON tar.HostID               = stg.HostID
                                                       AND tar.OrganisationKey      = @organisationKey
      WHERE stg.Operation in ('I','U')
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    -- Deleted records
    INSERT INTO [StageUser].[ROLLBACK_FACT_VehicleCosts]
    ( 
      [VehicleCostKey] ,
      [OrganisationKey],
      [HostID]         ,
      [CostDateKey]    ,
      [IsRecurring]    ,
      [VehicleKey]     ,
      [OdometerReading],
      [CostCategoryKey],
      [BaseCost]       ,
      [BaseCurrencyKey],
      [UTCOffsetKey]   ,
      [IsDeleted]      ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      [VehicleCostKey] ,
      [OrganisationKey],
      [HostID]         ,
      [CostDateKey]    ,
      [IsRecurring]    ,
      [VehicleKey]     ,
      [OdometerReading],
      [CostCategoryKey],
      [BaseCost]       ,
      [BaseCurrencyKey],
      [UTCOffsetKey]   ,
      [IsDeleted]      ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]       = 1,
        [UpdateBatchKey]  = @batchKey
      OUTPUT
        DELETED.[VehicleCostKey] ,
        DELETED.[OrganisationKey],
        DELETED.[HostID]         ,
        DELETED.[CostDateKey]    ,
        DELETED.[IsRecurring]    ,
        DELETED.[VehicleKey]     ,
        DELETED.[OdometerReading],
        DELETED.[CostCategoryKey],
        DELETED.[BaseCost]       ,
        DELETED.[BaseCurrencyKey],
        DELETED.[UTCOffsetKey]   ,
        DELETED.[IsDeleted]      ,
        DELETED.[CreateBatchKey] ,
        DELETED.[UpdateBatchKey]
      FROM [MiXData].dbo.FACT_VehicleCosts    AS tar
             INNER JOIN
           [StageUser].[STAGE_FACT_VehicleCosts] AS stg ON tar.HostID               = stg.HostID
                                                       AND tar.OrganisationKey      = @organisationKey
      WHERE stg.Operation = 'D'
      ) AS del;

    -- record number of records deleted  
    SELECT @recordsDeleted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;  
    END;  

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_VehicleCosts_HostID
      ON [StageUser].[ROLLBACK_FACT_VehicleCosts](HostID);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_VehicleCosts
    ( 
      [OrganisationKey],
      [HostID]         ,
      [CostDateKey]    ,
      [IsRecurring]    ,
      [VehicleKey]     ,
      [OdometerReading],
      [CostCategoryKey],
      [BaseCost]       ,
      [BaseCurrencyKey],
      [UTCOffsetKey]   ,
      [IsDeleted]      ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey     ,
      stg.[HostID]         ,
      stg.[CostDateKey]    ,
      stg.[IsRecurring]    ,
      ISNULL(stg.[VehicleKey]     ,-1),
      stg.[OdometerReading],
      ISNULL(stg.[CostCategoryKey],-1),
      stg.[BaseCost]       ,
      ISNULL(stg.[BaseCurrencyKey],-1),
      stg.[UTCOffsetKey]   ,
      0                    , -- IsDeleted
      @batchKey            ,
      @batchKey
    FROM
      [StageUser].[STAGE_FACT_VehicleCosts]    AS stg
    WHERE
        stg.Operation IN ('I','U')
    AND NOT EXISTS (SELECT 1
                    FROM
                      [StageUser].[ROLLBACK_FACT_VehicleCosts] AS roll WITH (NOLOCK)
                    WHERE
                      stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser].[STAGE_FACT_VehicleCosts];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprGroupTriggers_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move GroupTriggers records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprGroupTriggers_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].GroupTriggers_CT  AS tar
      USING [StageUser].GroupTriggers AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.liGroupID      = stg.liGroupID    ,
            tar.iEventID       = stg.iEventID     ,
            tar.ucTriggerID    = stg.ucTriggerID  ,
            tar.ucSeq          = stg.ucSeq        ,
            tar.iParameterID   = stg.iParameterID ,
            tar.ucOperator     = stg.ucOperator   ,
            tar.lfValue        = stg.lfValue      ,
            tar.bRequired      = stg.bRequired    ,
            tar.ucTOper        = stg.ucTOper      ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            liGroupID      ,
            iEventID       ,
            ucTriggerID    ,
            ucSeq          ,
            iParameterID   ,
            ucOperator     ,
            lfValue        ,
            bRequired      ,
            ucTOper        ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.liGroupID    ,
            stg.iEventID     ,
            stg.ucTriggerID  ,
            stg.ucSeq        ,
            stg.iParameterID ,
            stg.ucOperator   ,
            stg.lfValue      ,
            stg.bRequired    ,
            stg.ucTOper      ,
            @batchKey        ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprMapLocationPolygonPoints_Get]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprMapLocationPolygonPoints_Get]
(
  @locationID int
) AS

SELECT
  fLongitude,
  fLatitude
FROM
  [StageUser].MapLocationPolygonPoints
WHERE
  liLocationID = @locationID
ORDER BY
  liSequence ASC;

GO
/****** Object:  StoredProcedure [StageUser].[sprOrgOptions_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move OrgOptions records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprOrgOptions_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].OrgOptions_CT  AS tar
      USING [StageUser].OrgOptions AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate    ,
            tar.Operation      = stg.Operation     ,
            tar.UpdateMask     = stg.UpdateMask    ,
            tar.ChangeVersion  = stg.ChangeVersion ,
            tar.sLPDealerName  = stg.sLPDealerName ,
            tar.sLPDealerTelNo = stg.sLPDealerTelNo,
            tar.sLPRegCode     = stg.sLPRegCode    ,
            tar.UpdateBatchKey = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            sLPDealerName  ,
            sLPDealerTelNo ,
            sLPRegCode     ,
            CreateBatchKey ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey  ,
            stg.RID           ,
            stg.ChangeDate    ,
            stg.Operation     ,
            stg.UpdateMask    ,
            stg.ChangeVersion ,
            stg.sLPDealerName ,
            stg.sLPDealerTelNo,
            stg.sLPRegCode    ,
            @batchKey         ,
            @batchKey
      );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprParam_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move DeviceParam records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprParam_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  
  
  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Param_CT  AS tar
      USING [StageUser].Param AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iParameterID   = stg.iParameterID ,
            tar.sDescription   = stg.sDescription ,
            tar.sSystemName    = stg.sSystemName  ,
            tar.ucValueFormat  = stg.ucValueFormat,
            tar.sUnits         = stg.sUnits       ,
            tar.bSystem        = stg.bSystem      ,
            tar.bFuelCounter   = stg.bFuelCounter ,
            tar.bProfiled      = stg.bProfiled    ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iParameterID   ,
            sDescription   ,
            sSystemName    ,
            ucValueFormat  ,
            sUnits         ,
            bSystem        ,
            bFuelCounter   ,
            bProfiled      ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.iParameterID ,
            stg.sDescription ,
            stg.sSystemName  ,
            stg.ucValueFormat,
            stg.sUnits       ,
            stg.bSystem      ,
            stg.bFuelCounter ,
            stg.bProfiled    ,
            @batchKey        ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprPartitionCreate]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprPartitionCreate]
(
	@Dbname nvarchar(128),
	@PartitionScheme nvarchar(128),
	@PartitionFunction nvarchar(128),
	@PartitionSize varchar(6)
)
AS

Declare @Stmt nvarchar(max);
Declare @CurrDate Date
Declare @NextMonth nchar(2);
Declare @NextYear nchar(4);
Declare @FileGroup nvarchar(10);

set @CurrDate = GETUTCDATE()
set @NextMonth = REPLICATE('0',2-LEN(RTRIM(CONVERT(varchar(20),DATEPART(month,DATEADD(month,1,@CurrDate))))))+CONVERT(varchar(20),DATEPART(month,DATEADD(month,1,@CurrDate)))
set @NextYear = DATEPART(year,DATEADD(month,1,@CurrDate))
set @FileGroup = @NextYear + '-' + @NextMonth

select @Stmt = 'Use [' + @Dbname + '];' + char(13);

select @Stmt = @Stmt + 'Alter Database [' + @Dbname + '] Add Filegroup [' + @FileGroup + '];' + char(13);

select @Stmt  = @Stmt +  'Alter Database [' + @Dbname + '] Add File (Name = [' + @FileGroup + '_' + FileNum + '],' + 'Filename = N''' + Drive + DPath + @Dbname + '_' + @FileGroup + '_' + FileNum + '.ndf'',Size = ' + @PartitionSize + 'MB,FILEGROWTH = 256MB)' + 'To FileGroup [' + @FileGroup + '];' + char(13)
				  from MixStaging.Control.PartitionInfo where MonNum = @NextMonth; 
 
select @Stmt  = @Stmt +   'Alter Partition Scheme [' + @PartitionScheme + '] Next Used [' + @FileGroup + '];' + char(13); 
 
select @Stmt  = @Stmt +   'Alter Partition Function [' + @PartitionFunction + '] () Split Range (''' + @FileGroup + '-' + '01'');' + char(13);
exec (@Stmt);
--print @Stmt;

RETURN 0;

GO
/****** Object:  StoredProcedure [StageUser].[sprPassengers_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move Passengers records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprPassengers_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Passengers_CT  AS tar
      USING [StageUser].Passengers AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.PassengerGUID  = stg.PassengerGUID,
            tar.iPassengerID   = stg.iPassengerID ,
            tar.sName          = stg.sName        ,
            tar.UpdateBatchKey = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            PassengerGUID  ,
            iPassengerID   ,
            sName          ,
            CreateBatchKey ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.PassengerGUID,
            stg.iPassengerID ,
            stg.sName        ,
            @batchKey        ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprRestoreAuditRecordsMerge]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprRestoreAuditRecordsMerge]
(
  @organisationKey INT  
)
AS
BEGIN
  SET NOCOUNT ON

  DECLARE @firstAuditRecordHostRID INT;
  DECLARE @numberOfRecordsAffected INT;

  --------------------------------
  -- DeviceParam
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].DeviceParam
  
  INSERT INTO [StageUser].DeviceParam
  (
    [OrganisationKey]  ,
    [RID]              ,
    [ChangeDate]       ,
    [Operation]        ,
    [UpdateMask]       ,
    [ChangeVersion]    ,
    [liDeviceID]       ,
    [iParameterID]     ,
    [bDeviceDefault]   ,
    [bParamDefault]    ,
    [ucCalibrationType],
    [lfCalibration1]   ,
    [lfValue1]         ,
    [lfCalibration2]   ,
    [lfValue2]         ,
    [sUserName]
  )
  SELECT
    [OrganisationKey]  ,
    [HostRID]          ,
    [ChangeDate]       ,
    [Operation]        ,
    [UpdateMask]       ,
    [ChangeVersion]    ,
    [liDeviceID]       ,
    [iParameterID]     ,
    [bDeviceDefault]   ,
    [bParamDefault]    ,
    [ucCalibrationType],
    [lfCalibration1]   ,
    [lfValue1]         ,
    [lfCalibration2]   ,
    [lfValue2]         ,
    [sUserName]
  FROM audit.DeviceParam_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey        = @organisationKey
  AND (a.HostRID                < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Devices
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].Devices

  INSERT INTO [StageUser].Devices
  (
    [OrganisationKey]   ,
    [RID]               ,
    [ChangeDate]        ,
    [Operation]         ,
    [UpdateMask]        ,
    [ChangeVersion]     ,
    [liDeviceID]        ,
    [sDescription]      ,
    [sSystemName]       ,
    [ucDeviceType]      ,
    [bCanRecordInterval],
    [sReportProgID]     ,
    [sUserName]
  )
  SELECT
    [OrganisationKey]   ,
    [HostRID]           ,
    [ChangeDate]        ,
    [Operation]         ,
    [UpdateMask]        ,
    [ChangeVersion]     ,
    [liDeviceID]        ,
    [sDescription]      ,
    [sSystemName]       ,
    [ucDeviceType]      ,
    [bCanRecordInterval],
    [sReportProgID]     ,
    [sUserName]
  FROM audit.Devices_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- DriverCertifications
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].DriverCertifications

  INSERT INTO [StageUser].DriverCertifications
  (
    [OrganisationKey]     ,
    [RID]                 ,
    [ChangeDate]          ,
    [Operation]           ,
    [UpdateMask]          ,
    [ChangeVersion]       ,
    [iDriverID]           ,
    [liCertificationID]   ,
    [dtObtained]          ,
    [sInstructor]         ,
    [bInstructorQualified],
    [sLocation]
  )
  SELECT
    [OrganisationKey]     ,
    [HostRID]             ,
    [ChangeDate]          ,
    [Operation]           ,
    [UpdateMask]          ,
    [ChangeVersion]       ,
    [iDriverID]           ,
    [liCertificationID]   ,
    [dtObtained]          ,
    [sInstructor]         ,
    [bInstructorQualified],
    [sLocation]
  FROM audit.DriverCertifications_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- DriverLicences
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].DriverLicences

  INSERT INTO [StageUser].DriverLicences
  (
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [OrganisationKey],
    [iDriverID]      ,
    [liLicenceID]    ,
    [dtObtained]     ,
    [dtExpires]
  )
  SELECT
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [OrganisationKey],
    [iDriverID]      ,
    [liLicenceID]    ,
    [dtObtained]     ,
    [dtExpires]
  FROM audit.DriverLicences_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Drivers
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].Drivers

  INSERT INTO [StageUser].Drivers
  (
    [RID]              ,
    [ChangeDate]       ,
    [Operation]        ,
    [UpdateMask]       ,
    [ChangeVersion]    ,
    [OrganisationKey]  ,
    [DriverGUID]       ,
    [iDriverID]        ,
    [liSiteID]         ,
    [liGroupID]        ,
    [sEmployeeNumber]  ,
    [sName]            ,
    [bLicense]         ,
    [dtLastLicense]    ,
    [dtNextLicense]    ,
    [ucLicenseInterval],
    [dtDistanceChecked],
    [sExtendedID]      ,
    [ucLicenseRemind]
  )
  SELECT
    [HostRID]          ,
    [ChangeDate]       ,
    [Operation]        ,
    [UpdateMask]       ,
    [ChangeVersion]    ,
    [OrganisationKey]  ,
    [DriverGUID]       ,
    [iDriverID]        ,
    [liSiteID]         ,
    [liGroupID]        ,
    [sEmployeeNumber]  ,
    [sName]            ,
    [bLicense]         ,
    [dtLastLicense]    ,
    [dtNextLicense]    ,
    [ucLicenseInterval],
    [dtDistanceChecked],
    [sExtendedID]      ,
    [ucLicenseRemind]
  FROM audit.Drivers_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- EventDescription
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].EventDescription

  INSERT INTO [StageUser].EventDescription
  (
    [RID]          ,
    [ChangeDate]   ,
    [Operation]    ,
    [UpdateMask]   ,
    [ChangeVersion],
    [iEventID]     ,
    [sDescription] ,
    [sSystemName]  ,
    [sCriticalID]  ,
    [ucSummaryType],
    [iSummaryID]   ,
    [sUserName]
  )
  SELECT
    [HostRID]      ,
    [ChangeDate]   ,
    [Operation]    ,
    [UpdateMask]   ,
    [ChangeVersion],
    [iEventID]     ,
    [sDescription] ,
    [sSystemName]  ,
    [sCriticalID]  ,
    [ucSummaryType],
    [iSummaryID]   ,
    [sUserName]
  FROM audit.EventDescription_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- EventTriggers
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].EventTriggers

  INSERT INTO [StageUser].EventTriggers
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iEventID]       ,
    [ucTriggerID]    ,
    [ucSeq]          ,
    [iParameterID]   ,
    [ucOperator]     ,
    [lfValue]        ,
    [bRequired]      ,
    [ucTOper]        ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iEventID]       ,
    [ucTriggerID]    ,
    [ucSeq]          ,
    [iParameterID]   ,
    [ucOperator]     ,
    [lfValue]        ,
    [bRequired]      ,
    [ucTOper]        ,
    [sUserName]
  FROM audit.EventTriggers_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- ExtensionProperties
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].ExtensionProperties_DIM

  INSERT INTO [StageUser].ExtensionProperties_DIM
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [sAppID]         ,
    [liObjectType]   ,
    [liObjectID]     ,
    [sProperty]      ,
    [sValue]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [sAppID]         ,
    [liObjectType]   ,
    [liObjectID]     ,
    [sProperty]      ,
    [sValue]
  FROM audit.ExtensionProperties_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- GroupTriggers
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].GroupTriggers

  INSERT INTO [StageUser].GroupTriggers
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [liGroupID]      ,
    [iEventID]       ,
    [ucTriggerID]    ,
    [ucSeq]          ,
    [iParameterID]   ,
    [ucOperator]     ,
    [lfValue]        ,
    [bRequired]      ,
    [ucTOper]        ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [liGroupID]      ,
    [iEventID]       ,
    [ucTriggerID]    ,
    [ucSeq]          ,
    [iParameterID]   ,
    [ucOperator]     ,
    [lfValue]        ,
    [bRequired]      ,
    [ucTOper]        ,
    [sUserName]
  FROM audit.GroupTriggers_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- OrgOptions
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].OrgOptions

  INSERT INTO [StageUser].OrgOptions
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [sLPDealerName]  ,
    [sLPDealerTelNo] ,
    [sLPRegCode]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [sLPDealerName]  ,
    [sLPDealerTelNo] ,
    [sLPRegCode]
  FROM audit.OrgOptions_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Param
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].[Param]

  INSERT INTO [StageUser].[Param]
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iParameterID]   ,
    [sDescription]   ,
    [sSystemName]    ,
    [ucValueFormat]  ,
    [sUnits]         ,
    [bSystem]        ,
    [bFuelCounter]   ,
    [bProfiled]      ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iParameterID]   ,
    [sDescription]   ,
    [sSystemName]    ,
    [ucValueFormat]  ,
    [sUnits]         ,
    [bSystem]        ,
    [bFuelCounter]   ,
    [bProfiled]      ,
    [sUserName]
  FROM audit.Param_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Passengers
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].Passengers

  INSERT INTO [StageUser].Passengers
  (
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [OrganisationKey],
    [PassengerGUID]  ,
    [iPassengerID]   ,
    [sName]
  )
  SELECT
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [OrganisationKey],
    [PassengerGUID]  ,
    [iPassengerID]   ,
    [sName]
  FROM audit.Passengers_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- ScoredEvents
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].ScoredEvents

  INSERT INTO [StageUser].ScoredEvents
  (
    [RID]             ,
    [ChangeDate]      ,
    [Operation]       ,
    [UpdateMask]      ,
    [ChangeVersion]   ,
    [iEventID]        ,
    [ucScoreWeight]   ,
    [lfScoreDuration] ,
    [lfScoreSeverity] ,
    [ucScoreTriggerID],
    [sUserName]
  )
  SELECT
    [HostRID]         ,
    [ChangeDate]      ,
    [Operation]       ,
    [UpdateMask]      ,
    [ChangeVersion]   ,
    [iEventID]        ,
    [ucScoreWeight]   ,
    [lfScoreDuration] ,
    [lfScoreSeverity] ,
    [ucScoreTriggerID],
    [sUserName]
  FROM audit.ScoredEvents_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Sites
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].Sites

  INSERT INTO [StageUser].Sites
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [liSiteID]       ,
    [SiteGUID]       ,
    [sName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [liSiteID]       ,
    [SiteGUID]       ,
    [sName]
  FROM audit.Sites_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Trailers
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].Trailers

  INSERT INTO [StageUser].Trailers
  (
    [RID]              ,
    [ChangeDate]       ,
    [Operation]        ,
    [UpdateMask]       ,
    [ChangeVersion]    ,
    [OrganisationKey]  ,
    [TrailerGUID]      ,
    [liTrailerID]      ,
    [sDescription]     ,
    [sRegNo]           ,
    [sAssetNumber]     ,
    [fSetOdometer]     ,
    [dtOdometerChanged],
    [dtPrevService]    ,
    [dtNextService]    ,
    [iServIntTime]     ,
    [fPrevService]     ,
    [fNextService]     ,
    [fServIntDistance]
  )
  SELECT
    [HostRID]          ,
    [ChangeDate]       ,
    [Operation]        ,
    [UpdateMask]       ,
    [ChangeVersion]    ,
    [OrganisationKey]  ,
    [TrailerGUID]      ,
    [liTrailerID]      ,
    [sDescription]     ,
    [sRegNo]           ,
    [sAssetNumber]     ,
    [fSetOdometer]     ,
    [dtOdometerChanged],
    [dtPrevService]    ,
    [dtNextService]    ,
    [iServIntTime]     ,
    [fPrevService]     ,
    [fNextService]     ,
    [fServIntDistance]
  FROM audit.Trailers_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- TrailerUnitIDs
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].TrailerUnitIDs

  INSERT INTO [StageUser].TrailerUnitIDs
  (
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [OrganisationKey],
    [liUnitID]       ,
    [liTrailerID]    ,
    [dtAttached]
  )
  SELECT
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [OrganisationKey],
    [liUnitID]       ,
    [liTrailerID]    ,
    [dtAttached]
  FROM audit.TrailerUnitIDs_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- VehicleDeviceParam
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].VehicleDeviceParam;

  INSERT INTO [StageUser].VehicleDeviceParam
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [liDeviceID]     ,
    [iParameterID]   ,
    [lfCalibration1] ,
    [lfValue1]       ,
    [lfCalibration2] ,
    [lfValue2]       ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [liDeviceID]     ,
    [iParameterID]   ,
    [lfCalibration1] ,
    [lfValue1]       ,
    [lfCalibration2] ,
    [lfValue2]       ,
    [sUserName]
  FROM audit.VehicleDeviceParam_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- VehicleDeviceProperties
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].VehicleDeviceProperties;

  INSERT INTO [StageUser].VehicleDeviceProperties
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [liDeviceID]     ,
    [sProperty]      ,
    [sValue]         ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [liDeviceID]     ,
    [sProperty]      ,
    [sValue]         ,
    [sUserName]
  FROM audit.VehicleDeviceProperties_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- VehicleDevices
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].VehicleDevices;

  INSERT INTO [StageUser].VehicleDevices
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [liDeviceID]     ,
    [sInputID]       ,
    [bIsActive]      ,
    [bRecordInterval],
    [liPowerDeviceID],
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [liDeviceID]     ,
    [sInputID]       ,
    [bIsActive]      ,
    [bRecordInterval],
    [liPowerDeviceID],
    [sUserName]
  FROM audit.VehicleDevices_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- VehicleEvent
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].VehicleEvent;

  INSERT INTO [StageUser].VehicleEvent
  (
    [OrganisationKey]        ,
    [RID]                    ,
    [ChangeDate]             ,
    [Operation]              ,
    [UpdateMask]             ,
    [ChangeVersion]          ,
    [iVehicleID]             ,
    [iEventID]               ,
    [ucEventType]            ,
    [bInUse]                 ,
    [bStartOdo]              ,
    [bStartPosition]         ,
    [bEndOdo]                ,
    [bEndPosition]           ,
    [bRecordF3Count]         ,
    [bWarningMessage]        ,
    [bActivePosition]        ,
    [iRecordTime]            ,
    [iAlarmTime]             ,
    [iRelayTime]             ,
    [iRelay2Time]            ,
    [iCriticalTime]          ,
    [iActiveTime]            ,
    [iActiveEndTime]         ,
    [iTrackTime]             ,
    [iTrackInterval]         ,
    [ucAlarmState]           ,
    [ucRelayState]           ,
    [ucRelay2State]          ,
    [sWarningMessage]        ,
    [ucPriority]             ,
    [dtLastEventNotification],
    [sUserName]
  )
  SELECT
    [OrganisationKey]        ,
    [HostRID]                ,
    [ChangeDate]             ,
    [Operation]              ,
    [UpdateMask]             ,
    [ChangeVersion]          ,
    [iVehicleID]             ,
    [iEventID]               ,
    [ucEventType]            ,
    [bInUse]                 ,
    [bStartOdo]              ,
    [bStartPosition]         ,
    [bEndOdo]                ,
    [bEndPosition]           ,
    [bRecordF3Count]         ,
    [bWarningMessage]        ,
    [bActivePosition]        ,
    [iRecordTime]            ,
    [iAlarmTime]             ,
    [iRelayTime]             ,
    [iRelay2Time]            ,
    [iCriticalTime]          ,
    [iActiveTime]            ,
    [iActiveEndTime]         ,
    [iTrackTime]             ,
    [iTrackInterval]         ,
    [ucAlarmState]           ,
    [ucRelayState]           ,
    [ucRelay2State]          ,
    [sWarningMessage]        ,
    [ucPriority]             ,
    [dtLastEventNotification],
    [sUserName]
  FROM audit.VehicleEvent_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- VehicleProfile
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].VehicleProfile;

  INSERT INTO [StageUser].VehicleProfile
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [iParameterID]   ,
    [ucSeq]          ,
    [lfValue]        ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [iParameterID]   ,
    [ucSeq]          ,
    [lfValue]        ,
    [sUserName]
  FROM audit.VehicleProfile_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Vehicles
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].Vehicles;

  INSERT INTO [StageUser].Vehicles
  (
    [OrganisationKey]        ,
    [RID]                    ,
    [ChangeDate]             ,
    [Operation]              ,
    [UpdateMask]             ,
    [ChangeVersion]          ,
    [VehicleGUID]            ,
    [iVehicleID]             ,
    [liSiteID]               ,
    [liGroupID]              ,
    [sDesc]                  ,
    [sRegNo]                 ,
    [ucUnitType]             ,
    [liLastServiceKey]       ,
    [fNextServiceKm]         ,
    [fServiceKm]             ,
    [fRemindKm]              ,
    [dtNextServiceDate]      ,
    [ucServiceMonths]        ,
    [ucRemindWeeks]          ,
    [liNextServiceSeconds]   ,
    [liServiceSeconds]       ,
    [liRemindSeconds]        ,
    [dtLastLicense]          ,
    [dtNextLicense]          ,
    [ucLicenseInterval]      ,
    [ucLicenseRemind]        ,
    [dtLastCOR]              ,
    [dtNextCOR]              ,
    [ucCORInterval]          ,
    [ucCORRemind]            ,
    [bServiceKm]             ,
    [bServiceDate]           ,
    [bServiceHours]          ,
    [bLicense]               ,
    [bCOR]                   ,
    [bActive]                ,
    [sActiveReason]          ,
    [ucActiveState]          ,
    [iDefaultDriver]         ,
    [fTargetConsumption]     ,
    [fTargetHourlyConsumption]
  )
  SELECT
    [OrganisationKey]        ,
    [HostRID]                ,
    [ChangeDate]             ,
    [Operation]              ,
    [UpdateMask]             ,
    [ChangeVersion]          ,
    [VehicleGUID]            ,
    [iVehicleID]             ,
    [liSiteID]               ,
    [liGroupID]              ,
    [sDesc]                  ,
    [sRegNo]                 ,
    [ucUnitType]             ,
    [liLastServiceKey]       ,
    [fNextServiceKm]         ,
    [fServiceKm]             ,
    [fRemindKm]              ,
    [dtNextServiceDate]      ,
    [ucServiceMonths]        ,
    [ucRemindWeeks]          ,
    [liNextServiceSeconds]   ,
    [liServiceSeconds]       ,
    [liRemindSeconds]        ,
    [dtLastLicense]          ,
    [dtNextLicense]          ,
    [ucLicenseInterval]      ,
    [ucLicenseRemind]        ,
    [dtLastCOR]              ,
    [dtNextCOR]              ,
    [ucCORInterval]          ,
    [ucCORRemind]            ,
    [bServiceKm]             ,
    [bServiceDate]           ,
    [bServiceHours]          ,
    [bLicense]               ,
    [bCOR]                   ,
    [bActive]                ,
    [sActiveReason]          ,
    [ucActiveState]          ,
    [iDefaultDriver]         ,
    [fTargetConsumption]     ,
    [fTargetHourlyConsumption]
  FROM audit.Vehicles_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- VehicleTriggers
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser].VehicleTriggers;

  INSERT INTO [StageUser].VehicleTriggers
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [iEventID]       ,
    [ucTriggerID]    ,
    [lfValue]        ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [iEventID]       ,
    [ucTriggerID]    ,
    [lfValue]        ,
    [sUserName]
  FROM audit.VehicleTriggers_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;
  
  SELECT NumberOfRecordsAffected = @numberOfRecordsAffected;

  RETURN 0;
END; -- end proc

GO
/****** Object:  StoredProcedure [StageUser].[sprScoredEvents_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move ScoredEvents records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprScoredEvents_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].ScoredEvents_CT  AS tar
      USING [StageUser].ScoredEvents AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate       = stg.ChangeDate      ,
            tar.Operation        = stg.Operation       ,
            tar.UpdateMask       = stg.UpdateMask      ,
            tar.ChangeVersion    = stg.ChangeVersion   ,
            tar.iEventID         = stg.iEventID        ,
            tar.ucScoreWeight    = stg.ucScoreWeight   ,
            tar.lfScoreDuration  = stg.lfScoreDuration ,
            tar.lfScoreSeverity  = stg.lfScoreSeverity ,
            tar.ucScoreTriggerID = stg.ucScoreTriggerID,
            tar.UpdateBatchKey   = @batchKey,
            tar.sUserName        = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey ,
            HostRID         ,
            ChangeDate      ,
            Operation       ,
            UpdateMask      ,
            ChangeVersion   ,
            iEventID        ,
            ucScoreWeight   ,
            lfScoreDuration ,
            lfScoreSeverity ,
            ucScoreTriggerID,
            CreateBatchKey  ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey    ,
            stg.RID             ,
            stg.ChangeDate      ,
            stg.Operation       ,
            stg.UpdateMask      ,
            stg.ChangeVersion   ,
            stg.iEventID        ,
            stg.ucScoreWeight   ,
            stg.lfScoreDuration ,
            stg.lfScoreSeverity ,
            stg.ucScoreTriggerID,
            @batchKey           ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprSites_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move Sites records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprSites_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Sites_CT  AS tar
      USING [StageUser].Sites AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.SiteGUID       = stg.SiteGUID     ,
            tar.liSiteID       = stg.liSiteID     ,
            tar.sName          = stg.sName        ,
            tar.UpdateBatchKey = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            SiteGUID       ,
            liSiteID       ,
            sName          ,
            CreateBatchKey ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.SiteGUID     ,
            stg.liSiteID     ,
            stg.sName        ,
            @batchKey        ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprSTAGE_VehicleDeviceProperties_GetForVehicleDevice]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprSTAGE_VehicleDeviceProperties_GetForVehicleDevice]
(
  @vehicleHostID smallint, 
  @deviceHostID  int
) AS

--  SET NOCOUNT ON;  CANNOT SET as this is called from SQLCLR function!

SELECT
  Operation,
  PropertyName,
  PropertyValue
FROM
  [StageUser].STAGE_VehicleDeviceProperties
WHERE
  VehicleHostID = @vehicleHostID
  AND DeviceHostID = @deviceHostID;

RETURN;

GO
/****** Object:  StoredProcedure [StageUser].[sprSTAGE_VehicleTriggers_GetForVehicleEvent]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprSTAGE_VehicleTriggers_GetForVehicleEvent]
(
  @vehicleHostID  smallint,
  @eventHostID    smallint
) AS

--  SET NOCOUNT ON;  CANNOT SET as this is called from SQLCLR function!

SELECT
  TriggerID,
  Operation,
  Sequence,
  ParameterKey,
  Operator,
  ThresholdValue,
  Required,
  JoinOperator
FROM
  [StageUser].STAGE_VehicleTriggers
WHERE
  VehicleHostID = @vehicleHostID
  AND EventHostID = @eventHostID

RETURN;

GO
/****** Object:  StoredProcedure [StageUser].[sprTachoData_RemoveNonTrackedChanges]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Removes any non-tracked changes, i.e. Swap-Unit resequencing
-- ==============================================================================
/*
  Dependencies:

  TachoData

*/
CREATE PROCEDURE [StageUser].[sprTachoData_RemoveNonTrackedChanges]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  EXEC [Control].strProcProgressMonitor_Set
    @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 1. Start';
  END;

  --------------------------------------------------------------------
  -- 1. Remove records from Stage source table
  --------------------------------------------------------------------

  DELETE td
  FROM
    [StageUser].TachoData         td
      INNER JOIN
    [MiXData].[dbo].FACT_TachoData fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                     AND td.RID           = fact.HostID
  WHERE
    CHECKSUM
    (
      CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),td.StartDate)),
      CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),td.EndDate))
    )
      =
    CHECKSUM
    (
      CONVERT(DATETIME,NULLIF(fact.TachoStartDateTime,'0001-01-01 00:00:00 +00:00')),
      CONVERT(DATETIME,NULLIF(fact.TachoEndDateTime,'0001-01-01 00:00:00 +00:00'))
    );

  SELECT @recordsDeleted = @@ROWCOUNT;

  --------------------------------------------------------------------
  -- 2. Return values for Performance Monitoring
  --------------------------------------------------------------------
  EXEC [Control].strProcProgressMonitor_Set
    @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Return values for Performance Monitoring';
  END;

  SELECT RecordsDeleted  = isnull(@recordsDeleted ,0);

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser].[sprTachoData_RemoveNonTrackedChanges_DataStream]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprTachoData_RemoveNonTrackedChanges_DataStream]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  --------------------------------------------------------------------
  -- 0. Remove resequenced records from Stage source table
  --------------------------------------------------------------------
  DELETE td
  FROM
    [StageUser].TachoData td
      INNER JOIN
    [MiXData].[dbo].FACT_TachoData fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                        AND td.RID           = fact.HostID
  WHERE td.Operation   = 'U'
  AND td.BlockSequence < 0;

  --------------------------------------------------------------------
  -- 1. Identify records from Stage source table
  --------------------------------------------------------------------
--  ignore where swap unit has updated TripNumber
  SELECT
    td.RID,
    DWTachoStartDateTime = CONVERT(DATETIME,NULLIF(fact.TachoStartDateTime,'0001-01-01 00:00:00 +00:00')),
    td.StartDate,
    DWTachoEndDateTime   = CONVERT(DATETIME,NULLIF(fact.TachoEndDateTime,'0001-01-01 00:00:00 +00:00')),
    td.EndDate
  FROM
    [StageUser].TachoData td
      INNER JOIN
    [MiXData].[dbo].FACT_TachoData fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                        AND td.RID           = fact.HostID
  WHERE
    td.Operation = 'U';

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser].[sprTachoData_RemoveNonTrackedChanges_Remove]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Removes any non-tracked changes, i.e. Swap-Unit resequencing
-- ==============================================================================
/*
  Dependencies:

  TachoData

*/
CREATE PROCEDURE [StageUser].[sprTachoData_RemoveNonTrackedChanges_Remove]
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @RecordsDeleted INT;

  DELETE td
  FROM
    [StageUser].TachoData td
      INNER JOIN
    [StageUser].STAGE_FACT_TachoData_NonTrackedChanges tnc WITH (NOLOCK) ON tnc.RID = td.RID;

  SELECT RecordsDeleted = ISNULL(@@ROWCOUNT,0);

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser].[sprTerminalData_RemoveNonTrackedChanges]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Removes any non-tracked changes, i.e. Swap-Unit resequencing
-- ==============================================================================
/*
  Dependencies:

  TerminalData

*/
CREATE PROCEDURE [StageUser].[sprTerminalData_RemoveNonTrackedChanges]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  CREATE TABLE #Vehicles
  ( 
    VehicleKey INT PRIMARY KEY CLUSTERED,
    HostID     SMALLINT 
  );

  CREATE TABLE #Drivers
  ( 
    DriverKey  INT PRIMARY KEY CLUSTERED,
    HostID     SMALLINT
  );

  EXEC [Control].strProcProgressMonitor_Set
    @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Start';
  END;

  INSERT INTO #Vehicles
  ( 
    VehicleKey,
    HostID    
  )
  SELECT
    dvh.VehicleKey,
    dvh.HostID
  FROM [MiXData].[dbo].DIM_Vehicles dvh  WITH (NOLOCK)
  WHERE dvh.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    dvh.VehicleKey,
    dvh.HostID
  FROM [MiXData].[dbo].DIM_Vehicles dvh  WITH (NOLOCK)
  WHERE dvh.VehicleKey = -1;

  INSERT INTO #Drivers
  ( 
    DriverKey,
    HostID    
  )
  SELECT
    dd.DriverKey,
    dd.HostID
  FROM [MiXData].[dbo].DIM_Drivers dd  WITH (NOLOCK)
  WHERE dd.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    dd.DriverKey,
    dd.HostID
  FROM [MiXData].[dbo].DIM_Drivers dd  WITH (NOLOCK)
  WHERE dd.DriverKey = -1;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0.1 Get org DIM data';
  END;

  --------------------------------------------------------------------
  -- 1. Remove records from Stage source table
  --------------------------------------------------------------------
  --  ignore where Driver ID set to 0 (assume cause is driverID deleted)
  ;WITH
  UpdatedTerminalData AS
  (
    SELECT
      fact.HostID,
      fact.VehicleKey,
      fact.DriverKey,
      fact.Odometer,
      fact.MenuID,
      fact.ValueType,
      fact.TerminalDateTime,
      fact.MenuItemCode,
      fact.NumberValue,
      fact.StringValue
    FROM
      [StageUser].TerminalData td
        INNER JOIN
      [MiXData].[dbo].FACT_TerminalDetails fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                                AND td.EventKey      = fact.HostID
  )
  DELETE td
  FROM
    [StageUser].TerminalData td
      INNER JOIN
    UpdatedTerminalData       fact ON td.EventKey     = fact.HostID
      INNER JOIN
    #Vehicles                 veh  ON fact.VehicleKey = veh.VehicleKey
      INNER JOIN
    #Drivers                  drv  ON fact.DriverKey  = drv.DriverKey
  WHERE
    CHECKSUM
    (
      td.VehicleID,
      td.Odometer,
      td.MenuID,
      td.ValueType,
      CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),td.EventDate)),
      td.MenuItemCode,
      td.NumberValue,
      td.StringValue
    )
      =
    CHECKSUM
    (
      veh.HostID,
      fact.Odometer,
      fact.MenuID,
      fact.ValueType,
      CONVERT(DATETIME,NULLIF(fact.TerminalDateTime,'0001-01-01 00:00:00 +00:00')),
      fact.MenuItemCode,
      fact.NumberValue,
      fact.StringValue
    )
  AND (td.DriverID = 0
  OR   td.DriverID = drv.HostID);

  SELECT @recordsDeleted = @@ROWCOUNT;

  --------------------------------------------------------------------
  -- 2. Return values for Performance Monitoring
  --------------------------------------------------------------------
  EXEC [Control].strProcProgressMonitor_Set
    @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Return values for Performance Monitoring';
  END;

  SELECT RecordsDeleted  = isnull(@recordsDeleted ,0);

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser].[sprTerminalData_RemoveNonTrackedChanges_DataStream]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprTerminalData_RemoveNonTrackedChanges_DataStream]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  --------------------------------------------------------------------
  -- 0. Remove resequenced records from Stage source table
  --------------------------------------------------------------------
  ;WITH
  Vehicles AS
  (
    SELECT
      dvh.VehicleKey,
      VehicleID = dvh.HostID
    FROM
      [MiXData].[dbo].DIM_Vehicles dvh WITH (NOLOCK)
    WHERE dvh.OrganisationKey  = @organisationKey
  )
  DELETE td
  FROM
    [StageUser].TerminalData td
      INNER JOIN
    [MiXData].[dbo].FACT_TerminalDetails fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                           AND td.EventKey      = fact.HostID
      INNER JOIN
    Vehicles                             veh  WITH (NOLOCK) ON fact.VehicleKey  = veh.VehicleKey
  WHERE
      td.Operation      = 'U'
  AND (td.DriverID      = 0
  OR   td.BlockSequence < 0);

  --------------------------------------------------------------------
  -- 1. Identify records from Stage source table
  --------------------------------------------------------------------
  --  ignore where Driver ID set to 0 (assume cause is driverID deleted)
  ;WITH
  Vehicles AS
  (
    SELECT
      dvh.VehicleKey,
      VehicleID = dvh.HostID
    FROM
      [MiXData].[dbo].DIM_Vehicles dvh WITH (NOLOCK)
    WHERE dvh.OrganisationKey  = @organisationKey
  )
  SELECT
    td.EventKey,
    DWVehicleID = veh.VehicleID,
    td.VehicleID,
    DWTerminalDateTime = CONVERT(DATETIME,NULLIF(fact.TerminalDateTime,'0001-01-01 00:00:00 +00:00')),
    td.EventDate,
    DWOdometer  = fact.Odometer,
    td.Odometer,
    DWMenuID    = fact.MenuID,
    td.MenuID,
    DWValueType = fact.ValueType,
    td.ValueType,
    DWMenuItemCode = fact.MenuItemCode,
    td.MenuItemCode,
    DWNumberValue  = fact.NumberValue,
    td.NumberValue,
    DWStringValue  = fact.StringValue,
    td.StringValue
  FROM
    [StageUser].TerminalData td
      INNER JOIN
    [MiXData].[dbo].FACT_TerminalDetails fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                           AND td.EventKey      = fact.HostID
      INNER JOIN
    Vehicles                             veh  WITH (NOLOCK) ON fact.VehicleKey  = veh.VehicleKey
  WHERE
      td.Operation     = 'U';

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser].[sprTerminalData_RemoveNonTrackedChanges_Remove]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Removes any non-tracked changes, i.e. Swap-Unit resequencing
-- ==============================================================================
/*
  Dependencies:

  TerminalData

*/
CREATE PROCEDURE [StageUser].[sprTerminalData_RemoveNonTrackedChanges_Remove]
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @RecordsDeleted INT;

  DELETE td
  FROM
    [StageUser].TerminalData td
      INNER JOIN
    [StageUser].STAGE_FACT_TerminalDetails_NonTrackedChanges tnc WITH (NOLOCK) ON tnc.EventKey = td.EventKey;
  
  SELECT RecordsDeleted = ISNULL(@@ROWCOUNT,0);

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser].[sprTrailers_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move Trailers records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprTrailers_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Trailers_CT  AS tar
      USING [StageUser].Trailers AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate        = stg.ChangeDate       ,
            tar.Operation         = stg.Operation        ,
            tar.UpdateMask        = stg.UpdateMask       ,
            tar.ChangeVersion     = stg.ChangeVersion    ,
            tar.TrailerGUID       = stg.TrailerGUID      ,
            tar.liTrailerID       = stg.liTrailerID      ,
            tar.sDescription      = stg.sDescription     ,
            tar.sRegNo            = stg.sRegNo           ,
            tar.sAssetNumber      = stg.sAssetNumber     ,
            tar.fSetOdometer      = stg.fSetOdometer     ,
            tar.dtOdometerChanged = stg.dtOdometerChanged,
            tar.dtPrevService     = stg.dtPrevService    ,
            tar.dtNextService     = stg.dtNextService    ,
            tar.iServIntTime      = stg.iServIntTime     ,
            tar.fPrevService      = stg.fPrevService     ,
            tar.fNextService      = stg.fNextService     ,
            tar.fServIntDistance  = stg.fServIntDistance ,
            tar.UpdateBatchKey    = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey  ,
            HostRID          ,
            ChangeDate       ,
            Operation        ,
            UpdateMask       ,
            ChangeVersion    ,
            TrailerGUID      ,
            liTrailerID      ,
            sDescription     ,
            sRegNo           ,
            sAssetNumber     ,
            fSetOdometer     ,
            dtOdometerChanged,
            dtPrevService    ,
            dtNextService    ,
            iServIntTime     ,
            fPrevService     ,
            fNextService     ,
            fServIntDistance ,
            CreateBatchKey   ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey     ,
            stg.RID              ,
            stg.ChangeDate       ,
            stg.Operation        ,
            stg.UpdateMask       ,
            stg.ChangeVersion    ,
            stg.TrailerGUID      ,
            stg.liTrailerID      ,
            stg.sDescription     ,
            stg.sRegNo           ,
            stg.sAssetNumber     ,
            stg.fSetOdometer     ,
            stg.dtOdometerChanged,
            stg.dtPrevService    ,
            stg.dtNextService    ,
            stg.iServIntTime     ,
            stg.fPrevService     ,
            stg.fNextService     ,
            stg.fServIntDistance ,
            @batchKey            ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprTrailerUnitIDs_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move TrailerUnitIDs records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprTrailerUnitIDs_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].TrailerUnitIDs_CT  AS tar
      USING [StageUser].TrailerUnitIDs AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.liUnitID       = stg.liUnitID     ,
            tar.liTrailerID    = stg.liTrailerID  ,
            tar.dtAttached     = stg.dtAttached   ,
            tar.UpdateBatchKey = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            liUnitID       ,
            liTrailerID    ,
            dtAttached     ,
            CreateBatchKey ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey,
            stg.RID,
            stg.ChangeDate,
            stg.Operation,
            stg.UpdateMask,
            stg.ChangeVersion,
            stg.liUnitID,
            stg.liTrailerID,
            stg.dtAttached,
            @batchKey       ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprTripData_RemoveNonTrackedChanges]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Removes any non-tracked changes, i.e. Swap-Unit resequencing
-- ==============================================================================
/*
  Dependencies:

  TripData

*/
CREATE PROCEDURE [StageUser].[sprTripData_RemoveNonTrackedChanges]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  CREATE TABLE #Vehicles
  ( 
    VehicleKey INT PRIMARY KEY CLUSTERED,
    HostID     SMALLINT 
  );

  CREATE TABLE #Drivers
  ( 
    DriverKey  INT PRIMARY KEY CLUSTERED,
    HostID     SMALLINT
  );

  EXEC [Control].strProcProgressMonitor_Set
    @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Start';
  END;

  INSERT INTO #Vehicles
  ( 
    VehicleKey,
    HostID    
  )
  SELECT
    dvh.VehicleKey,
    dvh.HostID
  FROM [MiXData].[dbo].DIM_Vehicles dvh  WITH (NOLOCK)
  WHERE dvh.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    dvh.VehicleKey,
    dvh.HostID
  FROM [MiXData].[dbo].DIM_Vehicles dvh  WITH (NOLOCK)
  WHERE dvh.VehicleKey = -1;

  INSERT INTO #Drivers
  ( 
    DriverKey,
    HostID    
  )
  SELECT
    dd.DriverKey,
    dd.HostID
  FROM [MiXData].[dbo].DIM_Drivers dd  WITH (NOLOCK)
  WHERE dd.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    dd.DriverKey,
    dd.HostID
  FROM [MiXData].[dbo].DIM_Drivers dd  WITH (NOLOCK)
  WHERE dd.DriverKey = -1;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0.1 Get org DIM data';
  END;

  --------------------------------------------------------------------
  -- 1. Remove records from Stage source table
  --------------------------------------------------------------------
  --  ignore where Driver ID set to 0 (assume cause is driverID deleted)
  --  and where swap unit has updated TripNumber
  ;WITH
  UpdatedTripData AS
  (
    SELECT
      fact.HostID,
      fact.VehicleKey,
      fact.DriverKey,
      fact.UnitTripNumber,
      fact.ActivityStartDateTime,
      fact.ActivityEndDateTime
    FROM
      [StageUser].TripData td
        INNER JOIN
      [MiXData].[dbo].FACT_ActivitySummary fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                                AND td.TripID        = fact.HostID
  )
  DELETE td
  FROM
    [StageUser].TripData td
      INNER JOIN
    UpdatedTripData       fact ON td.TripID       = fact.HostID
      INNER JOIN
    #Vehicles             veh  ON fact.VehicleKey = veh.VehicleKey
      INNER JOIN
    #Drivers              drv  ON fact.DriverKey  = drv.DriverKey
  WHERE
    CHECKSUM
    (
      td.VehicleID,
      CONVERT(BIGINT,td.TripNumber),
      CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),td.TripStart)),
      CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),td.TripEnd))
    )
      =
    CHECKSUM
    (
      veh.HostID,
      fact.UnitTripNumber,
      CONVERT(DATETIME,NULLIF(fact.ActivityStartDateTime,'0001-01-01 00:00:00 +00:00')),
      CONVERT(DATETIME,NULLIF(fact.ActivityEndDateTime,'0001-01-01 00:00:00 +00:00'))
    )
  AND (td.DriverID = 0
  OR   td.DriverID = drv.HostID);

  SELECT @recordsDeleted = @@ROWCOUNT;

  --------------------------------------------------------------------
  -- 2. Return values for Performance Monitoring
  --------------------------------------------------------------------
  EXEC [Control].strProcProgressMonitor_Set
    @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Return values for Performance Monitoring';
  END;

  SELECT RecordsDeleted  = isnull(@recordsDeleted ,0);

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser].[sprTripData_RemoveNonTrackedChanges_DataStream]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser].[sprTripData_RemoveNonTrackedChanges_DataStream]
(
  @batchKey        int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 0. Remove resequenced records from Stage source table
  --------------------------------------------------------------------
  DELETE td
  FROM
    [StageUser].TripData td
      INNER JOIN
    [MiXData].[dbo].FACT_ActivitySummary fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                           AND td.TripID        = fact.HostID
  WHERE
      td.Operation   = 'U'
  AND (td.TripNumber < 0
  OR   td.DriverID   = 0);

  --------------------------------------------------------------------
  -- 1. Identify records from Stage source table
  --------------------------------------------------------------------
  --  ignore where Driver ID set to 0 (assume cause is driverID deleted)
  --  and where swap unit has updated TripNumber
  SELECT
    td.TripID,
    DWTripNumber = fact.UnitTripNumber,
    td.TripNumber,
    DWActivityStartDateTime = CONVERT(DATETIME,NULLIF(fact.ActivityStartDateTime,'0001-01-01 00:00:00 +00:00')),
    td.TripStart,
    DWActivityEndDateTime   = CONVERT(DATETIME,NULLIF(fact.ActivityEndDateTime,'0001-01-01 00:00:00 +00:00')),
    td.TripEnd
  FROM
    [StageUser].TripData td
      INNER JOIN
    [MiXData].[dbo].FACT_ActivitySummary fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                           AND td.TripID        = fact.HostID
  WHERE
    td.Operation  = 'U';

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser].[sprTripData_RemoveNonTrackedChanges_Remove]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- ==============================================================================
-- Removes any non-tracked changes, i.e. Swap-Unit resequencing
-- ==============================================================================
/*
  Dependencies:

  TripData

*/
CREATE PROCEDURE [StageUser].[sprTripData_RemoveNonTrackedChanges_Remove]
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  DELETE td
  FROM
    [StageUser].[TripData] td
      INNER JOIN
    [StageUser].STAGE_FACT_ActivitySummary_NonTrackedChanges anc WITH (NOLOCK) ON anc.TripID = td.TripID;

  SELECT RecordsDeleted = ISNULL(@@ROWCOUNT,0);

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser].[sprVehicleDeviceParam_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move VehicleDeviceParam records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprVehicleDeviceParam_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].VehicleDeviceParam_CT  AS tar
      USING [StageUser].VehicleDeviceParam AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate    ,
            tar.Operation      = stg.Operation     ,
            tar.UpdateMask     = stg.UpdateMask    ,
            tar.ChangeVersion  = stg.ChangeVersion ,
            tar.iVehicleID     = stg.iVehicleID    ,
            tar.liDeviceID     = stg.liDeviceID    ,
            tar.iParameterID   = stg.iParameterID  ,
            tar.lfCalibration1 = stg.lfCalibration1,
            tar.lfValue1       = stg.lfValue1      ,
            tar.lfCalibration2 = stg.lfCalibration2,
            tar.lfValue2       = stg.lfValue2      ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iVehicleID     ,
            liDeviceID     ,
            iParameterID   ,
            lfCalibration1 ,
            lfValue1       ,
            lfCalibration2 ,
            lfValue2       ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey  ,
            stg.RID           ,
            stg.ChangeDate    ,
            stg.Operation     ,
            stg.UpdateMask    ,
            stg.ChangeVersion ,
            stg.iVehicleID    ,
            stg.liDeviceID    ,
            stg.iParameterID  ,
            stg.lfCalibration1,
            stg.lfValue1      ,
            stg.lfCalibration2,
            stg.lfValue2      ,
            @batchKey         ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprVehicleDeviceProperties_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move VehicleDeviceProperties records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprVehicleDeviceProperties_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].VehicleDeviceProperties_CT  AS tar
      USING [StageUser].VehicleDeviceProperties AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iVehicleID     = stg.iVehicleID   ,
            tar.liDeviceID     = stg.liDeviceID   ,
            tar.sProperty      = stg.sProperty    ,
            tar.sValue         = stg.sValue       ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iVehicleID     ,
            liDeviceID     ,
            sProperty      ,
            sValue         ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.iVehicleID   ,
            stg.liDeviceID   ,
            stg.sProperty    ,
            stg.sValue       ,
            @batchKey        ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprVehicleDevices_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move VehicleDevices records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprVehicleDevices_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].VehicleDevices_CT  AS tar
      USING [StageUser].VehicleDevices AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate      = stg.ChangeDate     ,
            tar.Operation       = stg.Operation      ,
            tar.UpdateMask      = stg.UpdateMask     ,
            tar.ChangeVersion   = stg.ChangeVersion  ,
            tar.iVehicleID      = stg.iVehicleID     ,
            tar.liDeviceID      = stg.liDeviceID     ,
            tar.sInputID        = stg.sInputID       ,
            tar.bIsActive       = stg.bIsActive      ,
            tar.bRecordInterval = stg.bRecordInterval,
            tar.liPowerDeviceID = stg.liPowerDeviceID,
            tar.UpdateBatchKey  = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iVehicleID     ,
            liDeviceID     ,
            sInputID       ,
            bIsActive      ,
            bRecordInterval,
            liPowerDeviceID,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey   ,
            stg.RID            ,
            stg.ChangeDate     ,
            stg.Operation      ,
            stg.UpdateMask     ,
            stg.ChangeVersion  ,
            stg.iVehicleID     ,
            stg.liDeviceID     ,
            stg.sInputID       ,
            stg.bIsActive      ,
            stg.bRecordInterval,
            stg.liPowerDeviceID,
            @batchKey          ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprVehicleEvent_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move VehicleEvent records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprVehicleEvent_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].VehicleEvent_CT  AS tar
      USING [StageUser].VehicleEvent AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate              = stg.ChangeDate             ,
            tar.Operation               = stg.Operation              ,
            tar.UpdateMask              = stg.UpdateMask             ,
            tar.ChangeVersion           = stg.ChangeVersion          ,
            tar.iVehicleID              = stg.iVehicleID             ,
            tar.iEventID                = stg.iEventID               ,
            tar.ucEventType             = stg.ucEventType            ,
            tar.bInUse                  = stg.bInUse                 ,
            tar.bStartOdo               = stg.bStartOdo              ,
            tar.bStartPosition          = stg.bStartPosition         ,
            tar.bEndOdo                 = stg.bEndOdo                ,
            tar.bEndPosition            = stg.bEndPosition           ,
            tar.bRecordF3Count          = stg.bRecordF3Count         ,
            tar.bWarningMessage         = stg.bWarningMessage        ,
            tar.bActivePosition         = stg.bActivePosition        ,
            tar.iRecordTime             = stg.iRecordTime            ,
            tar.iAlarmTime              = stg.iAlarmTime             ,
            tar.iRelayTime              = stg.iRelayTime             ,
            tar.iRelay2Time             = stg.iRelay2Time            ,
            tar.iCriticalTime           = stg.iCriticalTime          ,
            tar.iActiveTime             = stg.iActiveTime            ,
            tar.iActiveEndTime          = stg.iActiveEndTime         ,
            tar.iTrackTime              = stg.iTrackTime             ,
            tar.iTrackInterval          = stg.iTrackInterval         ,
            tar.ucAlarmState            = stg.ucAlarmState           ,
            tar.ucRelayState            = stg.ucRelayState           ,
            tar.ucRelay2State           = stg.ucRelay2State          ,
            tar.sWarningMessage         = stg.sWarningMessage        ,
            tar.ucPriority              = stg.ucPriority             ,
            tar.dtLastEventNotification = stg.dtLastEventNotification,
            tar.UpdateBatchKey          = @batchKey,
            tar.sUserName               = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey        ,
            HostRID                ,
            ChangeDate             ,
            Operation              ,
            UpdateMask             ,
            ChangeVersion          ,
            iVehicleID             ,
            iEventID               ,
            ucEventType            ,
            bInUse                 ,
            bStartOdo              ,
            bStartPosition         ,
            bEndOdo                ,
            bEndPosition           ,
            bRecordF3Count         ,
            bWarningMessage        ,
            bActivePosition        ,
            iRecordTime            ,
            iAlarmTime             ,
            iRelayTime             ,
            iRelay2Time            ,
            iCriticalTime          ,
            iActiveTime            ,
            iActiveEndTime         ,
            iTrackTime             ,
            iTrackInterval         ,
            ucAlarmState           ,
            ucRelayState           ,
            ucRelay2State          ,
            sWarningMessage        ,
            ucPriority             ,
            dtLastEventNotification,
            CreateBatchKey         ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey           ,
            stg.RID                    ,
            stg.ChangeDate             ,
            stg.Operation              ,
            stg.UpdateMask             ,
            stg.ChangeVersion          ,
            stg.iVehicleID             ,
            stg.iEventID               ,
            stg.ucEventType            ,
            stg.bInUse                 ,
            stg.bStartOdo              ,
            stg.bStartPosition         ,
            stg.bEndOdo                ,
            stg.bEndPosition           ,
            stg.bRecordF3Count         ,
            stg.bWarningMessage        ,
            stg.bActivePosition        ,
            stg.iRecordTime            ,
            stg.iAlarmTime             ,
            stg.iRelayTime             ,
            stg.iRelay2Time            ,
            stg.iCriticalTime          ,
            stg.iActiveTime            ,
            stg.iActiveEndTime         ,
            stg.iTrackTime             ,
            stg.iTrackInterval         ,
            stg.ucAlarmState           ,
            stg.ucRelayState           ,
            stg.ucRelay2State          ,
            stg.sWarningMessage        ,
            stg.ucPriority             ,
            stg.dtLastEventNotification,
            @batchKey                  ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprVehicleProfile_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move VehicleProfile records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprVehicleProfile_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].VehicleProfile_CT  AS tar
      USING [StageUser].VehicleProfile AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iVehicleID     = stg.iVehicleID   ,
            tar.iParameterID   = stg.iParameterID ,
            tar.ucSeq          = stg.ucSeq        ,
            tar.lfValue        = stg.lfValue      ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iVehicleID     ,
            iParameterID   ,
            ucSeq          ,
            lfValue        ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.iVehicleID   ,
            stg.iParameterID ,
            stg.ucSeq        ,
            stg.lfValue      ,
            @batchKey        ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprVehicles_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move Vehicles records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprVehicles_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Vehicles_CT  AS tar
      USING [StageUser].Vehicles AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate                 = stg.ChangeDate                ,
            tar.Operation                  = stg.Operation                 ,
            tar.UpdateMask                 = stg.UpdateMask                ,
            tar.ChangeVersion              = stg.ChangeVersion             ,
            tar.VehicleGUID                = stg.VehicleGUID               ,
            tar.iVehicleID                 = stg.iVehicleID                ,
            tar.liSiteID                   = stg.liSiteID                  ,
            tar.liGroupID                  = stg.liGroupID                 ,
            tar.sDesc                      = stg.sDesc                     ,
            tar.sRegNo                     = stg.sRegNo                    ,
            tar.ucUnitType                 = stg.ucUnitType                ,
            tar.liLastServiceKey           = stg.liLastServiceKey          ,
            tar.fNextServiceKm             = stg.fNextServiceKm            ,
            tar.fServiceKm                 = stg.fServiceKm                ,
            tar.fRemindKm                  = stg.fRemindKm                 ,
            tar.dtNextServiceDate          = stg.dtNextServiceDate         ,
            tar.ucServiceMonths            = stg.ucServiceMonths           ,
            tar.ucRemindWeeks              = stg.ucRemindWeeks             ,
            tar.liNextServiceSeconds       = stg.liNextServiceSeconds      ,
            tar.liServiceSeconds           = stg.liServiceSeconds          ,
            tar.liRemindSeconds            = stg.liRemindSeconds           ,
            tar.dtLastLicense              = stg.dtLastLicense             ,
            tar.dtNextLicense              = stg.dtNextLicense             ,
            tar.ucLicenseInterval          = stg.ucLicenseInterval         ,
            tar.ucLicenseRemind            = stg.ucLicenseRemind           ,
            tar.dtLastCOR                  = stg.dtLastCOR                 ,
            tar.dtNextCOR                  = stg.dtNextCOR                 ,
            tar.ucCORInterval              = stg.ucCORInterval             ,
            tar.ucCORRemind                = stg.ucCORRemind               ,
            tar.bServiceKm                 = stg.bServiceKm                ,
            tar.bServiceDate               = stg.bServiceDate              ,
            tar.bServiceHours              = stg.bServiceHours             ,
            tar.bLicense                   = stg.bLicense                  ,
            tar.bCOR                       = stg.bCOR                      ,
            tar.bActive                    = stg.bActive                   ,
            tar.sActiveReason              = stg.sActiveReason             ,
            tar.ucActiveState              = stg.ucActiveState             ,
            tar.iDefaultDriver             = stg.iDefaultDriver            ,
            tar.fTargetConsumption         = stg.fTargetConsumption        ,
            tar.fTargetHourlyConsumption   = stg.fTargetHourlyConsumption  ,
            tar.UpdateBatchKey = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey   ,
            HostRID           ,
            ChangeDate                ,
            Operation                 ,
            UpdateMask                ,
            ChangeVersion             ,
            VehicleGUID               ,
            iVehicleID                ,
            liSiteID                  ,
            liGroupID                 ,
            sDesc                     ,
            sRegNo                    ,
            ucUnitType                ,
            liLastServiceKey          ,
            fNextServiceKm            ,
            fServiceKm                ,
            fRemindKm                 ,
            dtNextServiceDate         ,
            ucServiceMonths           ,
            ucRemindWeeks             ,
            liNextServiceSeconds      ,
            liServiceSeconds          ,
            liRemindSeconds           ,
            dtLastLicense             ,
            dtNextLicense             ,
            ucLicenseInterval         ,
            ucLicenseRemind           ,
            dtLastCOR                 ,
            dtNextCOR                 ,
            ucCORInterval             ,
            ucCORRemind               ,
            bServiceKm                ,
            bServiceDate              ,
            bServiceHours             ,
            bLicense                  ,
            bCOR                      ,
            bActive                   ,
            sActiveReason             ,
            ucActiveState             ,
            iDefaultDriver            ,
            fTargetConsumption        ,
            fTargetHourlyConsumption  ,
            CreateBatchKey            ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey              ,
            stg.RID                       ,
            stg.ChangeDate                ,
            stg.Operation                 ,
            stg.UpdateMask                ,
            stg.ChangeVersion             ,
            stg.VehicleGUID               ,
            stg.iVehicleID                ,
            stg.liSiteID                  ,
            stg.liGroupID                 ,
            stg.sDesc                     ,
            stg.sRegNo                    ,
            stg.ucUnitType                ,
            stg.liLastServiceKey          ,
            stg.fNextServiceKm            ,
            stg.fServiceKm                ,
            stg.fRemindKm                 ,
            stg.dtNextServiceDate         ,
            stg.ucServiceMonths           ,
            stg.ucRemindWeeks             ,
            stg.liNextServiceSeconds      ,
            stg.liServiceSeconds          ,
            stg.liRemindSeconds           ,
            stg.dtLastLicense             ,
            stg.dtNextLicense             ,
            stg.ucLicenseInterval         ,
            stg.ucLicenseRemind           ,
            stg.dtLastCOR                 ,
            stg.dtNextCOR                 ,
            stg.ucCORInterval             ,
            stg.ucCORRemind               ,
            stg.bServiceKm                ,
            stg.bServiceDate              ,
            stg.bServiceHours             ,
            stg.bLicense                  ,
            stg.bCOR                      ,
            stg.bActive                   ,
            stg.sActiveReason             ,
            stg.ucActiveState             ,
            stg.iDefaultDriver            ,
            stg.fTargetConsumption        ,
            stg.fTargetHourlyConsumption  ,
            @batchKey                     ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser].[sprVehicleTriggers_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Move VehicleTriggers records to audit schema
-- =============================================
CREATE PROCEDURE [StageUser].[sprVehicleTriggers_MoveToAudit]
(
  @batchKey         int,
  @organisationKey int,
  @debugMode       int = 0  -- used for debuging, will not clear worktables if set to other than default of 0
)
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].VehicleTriggers_CT  AS tar
      USING [StageUser].VehicleTriggers AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iVehicleID     = stg.iVehicleID   ,
            tar.iEventID       = stg.iEventID     ,
            tar.ucTriggerID    = stg.ucTriggerID  ,
            tar.lfValue        = stg.lfValue      ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iVehicleID     ,
            iEventID       ,
            ucTriggerID    ,
            lfValue        ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey,
            RID             ,
            ChangeDate      ,
            Operation       ,
            UpdateMask      ,
            ChangeVersion   ,
            iVehicleID      ,
            stg.iEventID        ,
            ucTriggerID     ,
            lfValue         ,
            @batchKey       ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDeviceParam_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDeviceParam_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  
  
  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].DeviceParam_CT  AS tar
      USING [StageUser1].DeviceParam AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate        = stg.ChangeDate       ,
            tar.Operation         = stg.Operation        ,
            tar.UpdateMask        = stg.UpdateMask       ,
            tar.ChangeVersion     = stg.ChangeVersion    ,
            tar.liDeviceID        = stg.liDeviceID       ,
            tar.iParameterID      = stg.iParameterID     ,
            tar.bDeviceDefault    = stg.bDeviceDefault   ,
            tar.bParamDefault     = stg.bParamDefault    ,
            tar.ucCalibrationType = stg.ucCalibrationType,
            tar.lfCalibration1    = stg.lfCalibration1   ,
            tar.lfValue1          = stg.lfValue1         ,
            tar.lfCalibration2    = stg.lfCalibration2   ,
            tar.lfValue2          = stg.lfValue2         ,
            tar.UpdateBatchKey    = @batchKey,
            tar.sUserName         = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey   ,
            HostRID          ,
            ChangeDate       ,
            Operation        ,
            UpdateMask       ,
            ChangeVersion    ,
            liDeviceID       ,
            iParameterID     ,
            bDeviceDefault   ,
            bParamDefault    ,
            ucCalibrationType,
            lfCalibration1   ,
            lfValue1         ,
            lfCalibration2   ,
            lfValue2         ,
            CreateBatchKey   ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey     ,
            stg.RID              ,
            stg.ChangeDate       ,
            stg.Operation        ,
            stg.UpdateMask       ,
            stg.ChangeVersion    ,
            stg.liDeviceID       ,
            stg.iParameterID     ,
            stg.bDeviceDefault   ,
            stg.bParamDefault    ,
            stg.ucCalibrationType,
            stg.lfCalibration1   ,
            stg.lfValue1         ,
            stg.lfCalibration2   ,
            stg.lfValue2         ,
            @batchKey            ,
            @batchKey,
            stg.sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDevices_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDevices_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Devices_CT  AS tar
      USING [StageUser1].Devices AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate         = stg.ChangeDate        ,
            tar.Operation          = stg.Operation         ,
            tar.UpdateMask         = stg.UpdateMask        ,
            tar.ChangeVersion      = stg.ChangeVersion     ,
            tar.liDeviceID         = stg.liDeviceID        ,
            tar.sDescription       = stg.sDescription      ,
            tar.sSystemName        = stg.sSystemName       ,
            tar.ucDeviceType       = stg.ucDeviceType      ,
            tar.bCanRecordInterval = stg.bCanRecordInterval,
            tar.sReportProgID      = stg.sReportProgID     ,
            tar.UpdateBatchKey     = @batchKey,
            tar.sUserName          = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey   ,
            HostRID           ,
            ChangeDate        ,
            Operation         ,
            UpdateMask        ,
            ChangeVersion     ,
            liDeviceID        ,
            sDescription      ,
            sSystemName       ,
            ucDeviceType      ,
            bCanRecordInterval,
            sReportProgID     ,
            CreateBatchKey    ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey      ,
            stg.RID               ,
            stg.ChangeDate        ,
            stg.Operation         ,
            stg.UpdateMask        ,
            stg.ChangeVersion     ,
            stg.liDeviceID        ,
            stg.sDescription      ,
            stg.sSystemName       ,
            stg.ucDeviceType      ,
            stg.bCanRecordInterval,
            stg.sReportProgID     ,
            @batchKey             ,
            @batchKey,
            stg.sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_CalibrationParameters_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_CalibrationParameters_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  int = 0;
  DECLARE @recordsUpdated   int = 0;
  DECLARE @recordsDeleted   int = 0;

  DECLARE @merge            table
  (
    Operation                     char (6)          NOT NULL,
    ParameterKey                  int               NOT NULL,
    OrganisationKey               int               NULL,
    HostID                        smallint          NOT NULL,
    Description                   nvarchar (200)    NULL,
    Units                         nvarchar (20)     NULL,
    ValueFormat                   tinyint           NULL,
    IsFuelCounter                 bit               NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].STAGE_DIM_CalibrationParameters;
  TRUNCATE TABLE [StageUser1].[ROLLBACK_DIM_CalibrationParameters];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY
    
    ;WITH LatestParams (RID) AS
    (
      SELECT
        MAX(RID)
      FROM [StageUser1].Param d WITH (NOLOCK)
      GROUP BY
        iParameterID
    )
    INSERT INTO [StageUser1].STAGE_DIM_CalibrationParameters
    (
      HostID,
      Description,
      Units,
      ValueFormat,
      IsFuelCounter
    )
    SELECT
      d.iParameterID,
      d.sDescription,
      d.sUnits,
      CASE
        WHEN d.iParameterID IN (1, 31047, 31301) THEN  -- Speed
          200
        WHEN d.iParameterID IN (10003, 10004, 21001, 31198, 31199, 31252, 31253) THEN -- Distance (Km)
          201
        WHEN d.iParameterID IN (31049, 31100) THEN -- Distance (m)
          202
        WHEN d.bFuelCounter = 1 THEN -- Fuel Quantity (l)
          203
        WHEN d.iParameterID IN (5, 14, 21003, 21004, 31173, 31174, 31175, 31176, 31177) THEN -- Temperature (C)
          204
        WHEN d.iParameterID IN (31205, 31206, 31207, 31208, 31209, 31210, 31211, 31212, 31213, 31214, 31215, 31216) THEN -- Weight (tonnes)
          205
        WHEN d.iParameterID IN (31258) THEN -- Weight (Kg)
          206
        WHEN d.iParameterID IN (31017, 31018) THEN  -- Acceleration/Deceleration
          207
        ELSE
          d.ucValueFormat
      END,
      d.bFuelCounter
    FROM
      LatestParams      l
        INNER JOIN
      [StageUser1].Param d WITH (NOLOCK) ON d.RID = l.RID
    WHERE
      d.bSystem = 0;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  --BEGIN TRY

    --------------------------------------------

    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'3. Update calculated columns onto STG';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError @organisationKey = @organisationKey;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  --BEGIN TRY


    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'4. Validation before Loading to DW';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError @organisationKey = @organisationKey;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    MERGE [MiXData].[dbo].DIM_CalibrationParameters tar
      USING [StageUser1].STAGE_DIM_CalibrationParameters stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostID          = stg.HostID
      WHEN MATCHED THEN
        UPDATE
        SET tar.Description   = stg.Description,
            tar.Units         = stg.Units,
            tar.ValueFormat   = stg.ValueFormat,
            tar.IsFuelCounter = stg.IsFuelCounter
      WHEN NOT MATCHED THEN
        INSERT
        (
          OrganisationKey,
          HostID,
          Description,
          Units,
          ValueFormat,
          IsFuelCounter,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.HostID,
          stg.Description,
          stg.Units,
          stg.ValueFormat,
          stg.IsFuelCounter,
          @batchKey,
          @batchKey
        )
      OUTPUT
        $action Operation,
        ISNULL(DELETED.ParameterKey, INSERTED.ParameterKey),
        DELETED.OrganisationKey,
        ISNULL(DELETED.HostID, INSERTED.HostID),
        DELETED.Description,
        DELETED.Units,
        DELETED.ValueFormat,
        DELETED.IsFuelCounter,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
        INTO @merge;

    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merge
    WHERE
      Operation = 'INSERT';

    -- Add to RollBck table
    INSERT INTO [StageUser1].ROLLBACK_DIM_CalibrationParameters
    (
      ParameterKey,
      OrganisationKey,
      HostID,
      Description,
      Units,
      ValueFormat,
      IsFuelCounter
    )
    SELECT
      ParameterKey,
      OrganisationKey,
      HostID,
      Description,
      Units,
      ValueFormat,
      IsFuelCounter
    FROM
     @merge
    WHERE
      Operation = 'UPDATE';
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].STAGE_DIM_CalibrationParameters;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    0                     RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_Certifications_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_Certifications_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int = 0;
  DECLARE @recordsUpdated  int = 0;
  DECLARE @recordsDeleted  int = 0;
  DECLARE @nrOfrecordsAffected int = 0;
  
  DECLARE @driverCertificatesLookupRID int; -- special merge for this type of certification required (combination of liCertificationID and iDriverID)

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_DIM_Certifications];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_DIM_Certifications];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_DIM_Certifications]') AND name = N'IX_STAGE_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID')
      DROP INDEX IX_STAGE_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID ON [StageUser1].[STAGE_DIM_Certifications];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_DIM_Certifications]') AND name = N'IX_ROLLBACK_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID')  
      DROP INDEX IX_ROLLBACK_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID ON [StageUser1].[ROLLBACK_DIM_Certifications];  

    -- get for later use
    SELECT @driverCertificatesLookupRID = l.LookupRID
    FROM
      [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	      l.LookupTable  = 'DIM_Certifications'
	  AND l.LookupColumn = 'CertificationTypeLookupKey'
	  AND l.LookupKey    = 6; -- Driver Certificates

    -- insert into STAGE table
	  ;WITH 
	    LatestDriverLicences (MaxRID) AS
	      (SELECT
	         MaxRID = MAX(RID)
	       FROM
	         [StageUser1].DriverLicences
	       GROUP BY
	         iDriverID,
	         liLicenceID),
	    LatestDriverCertifications (MaxRID) AS
	      (SELECT
	         MaxRID = MAX(RID)
	       FROM
	         [StageUser1].DriverCertifications
	       GROUP BY
	         iDriverID,
	         liCertificationID),
	    LatestDrivers (MaxRID) AS
	      (SELECT
	         MaxRID = MAX(RID)
	       FROM
	         [StageUser1].Drivers
	       GROUP BY
	         iDriverID),
	    LatestVehicles (MaxRID) AS
	      (SELECT
	         MaxRID = MAX(RID)
	       FROM
	         [StageUser1].Vehicles
	       GROUP BY
	         iVehicleID)  -- end WITH
	  INSERT INTO [StageUser1].[STAGE_DIM_Certifications]
	  (
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays]
	  )
    SELECT
      [ChangeDate]                 = d.ChangeDate            ,
      [HostID]                     = d.iDriverID             ,
      [DriverGUID]                 = d.DriverGUID            ,
      [TrailerGUID]                = NULL                    ,
      [VehicleGUID]                = NULL                    ,
      [CertificationTypeLookupKey] = l.LookupRID             , -- Driver License
      [CertificationDescription]   = NULL                    ,
      [ExpirationDateKey]          = d.dtNextLicense         ,
      [ObtainedDateKey]            = d.dtLastLicense         ,
      [LastRenewalDateKey]         = NULL                    ,
      [CertificationDurationDays]  = d.ucLicenseInterval * 30,
      [CertificationReminderDays]  = d.ucLicenseRemind   * 30
    FROM
      LatestDrivers       lstd
        INNER JOIN
      [StageUser1].Drivers d   ON d.RID = lstd.MaxRID
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	      l.LookupTable  = 'DIM_Certifications'
	  AND l.LookupColumn = 'CertificationTypeLookupKey'
	  AND l.LookupKey    = 1 -- Driver License
    UNION
    SELECT
      [ChangeDate]                 = vl.ChangeDate            ,
      [HostID]                     = vl.iVehicleID            ,
      [DriverGUID]                 = NULL                     ,
      [TrailerGUID]                = NULL                     ,
      [VehicleGUID]                = vl.VehicleGUID           ,
      [CertificationTypeLookupKey] = l.LookupRID              , -- Vehicle License
      [CertificationDescription]   = NULL                     ,
      [ExpirationDateKey]          = vl.dtNextLicense         ,
      [ObtainedDateKey]            = vl.dtLastLicense         ,
      [LastRenewalDateKey]         = NULL                     ,
      [CertificationDurationDays]  = vl.ucLicenseInterval * 30,
      [CertificationReminderDays]  = vl.ucLicenseRemind   * 30
    FROM
      LatestVehicles       lstv
        INNER JOIN
      [StageUser1].Vehicles vl  ON vl.RID = lstv.MaxRID
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	      l.LookupTable  = 'DIM_Certifications'
	  AND l.LookupColumn = 'CertificationTypeLookupKey'
	  AND l.LookupKey    = 2 -- Vehicle License
    UNION
    SELECT
      [ChangeDate]                 = vrc.ChangeDate        ,
      [HostID]                     = vrc.iVehicleID        ,
      [DriverGUID]                 = NULL                  ,
      [TrailerGUID]                = NULL                  ,
      [VehicleGUID]                = vrc.VehicleGUID       ,
      [CertificationTypeLookupKey] = l.LookupRID           , -- Roadworthy Certificate
      [CertificationDescription]   = NULL                  ,
      [ExpirationDateKey]          = vrc.dtNextCOR         ,
      [ObtainedDateKey]            = vrc.dtLastCOR         ,
      [LastRenewalDateKey]         = NULL                  ,
      [CertificationDurationDays]  = vrc.ucCORInterval * 30,
      [CertificationReminderDays]  = vrc.ucCORRemind   * 30
    FROM
      LatestVehicles       lstrc
        INNER JOIN
      [StageUser1].Vehicles vrc ON vrc.RID = lstrc.MaxRID
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	      l.LookupTable  = 'DIM_Certifications'
	  AND l.LookupColumn = 'CertificationTypeLookupKey'
	  AND l.LookupKey    = 3 -- Roadworthy Certificate
    UNION
    SELECT
      dl.ChangeDate                                        ,
      [HostID]                     = dl.RID                ,
      dd.DriverGUID                                        ,
      [TrailerGUID]                = NULL                  ,
      [VehicleGUID]                = NULL                  ,
      [CertificationTypeLookupKey] = l.LookupRID           , -- Driver License Codes
      [CertificationDescription]   = dlc.sLicenceCode      ,
      [ExpirationDateKey]          = dl.dtExpires          ,
      [ObtainedDateKey]            = dl.dtObtained         ,
      [LastRenewalDateKey]         = NULL                  ,
      [CertificationDurationDays]  = dlc.iExpiryMonths * 30,
      [CertificationReminderDays]  = dlc.iRemindWeeks  * 7
    FROM
      LatestDriverLicences           lstdl
        INNER JOIN
      [StageUser1].DriverLicences     dl                 ON dl.RID              = lstdl.MaxRID
        LEFT OUTER JOIN
      [StageUser1].DriverLicenceCodes dlc                ON dl.liLicenceID      = dlc.liLicenceID
        LEFT OUTER JOIN
      [MiXData].dbo.DIM_Drivers     dd WITH (NOLOCK) ON dd.OrganisationKey = @organisationKey
                                                       AND dl.iDriverID       = dd.HostID
                                                       AND dd.IsCurrentRecord = 1
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	      l.LookupTable  = 'DIM_Certifications'
	  AND l.LookupColumn = 'CertificationTypeLookupKey'
	  AND l.LookupKey    = 5 -- Driver License Codes
    UNION
    SELECT
      [ChangeDate]                 = dc.ChangeDate         ,
      [HostID]                     = dc.liCertificationID  ,
      [DriverGUID]                 = dd.DriverGUID         ,
      [TrailerGUID]                = NULL                  ,
      [VehicleGUID]                = NULL                  ,
      [CertificationTypeLookupKey] = l.LookupRID           , -- Driver Certificates
      [CertificationDescription]   = c.sDescription        ,
      [ExpirationDateKey]          = DATEADD(MONTH,c.iValidMonths,dc.dtObtained),
      [ObtainedDateKey]            = dc.dtObtained         ,
      [LastRenewalDateKey]         = NULL                  ,
      [CertificationDurationDays]  = c.iValidMonths    * 30,
      [CertificationReminderDays]  = 0
    FROM
      LatestDriverCertifications       lstdc
        INNER JOIN
      [StageUser1].DriverCertifications dc               ON dc.RID               = lstdc.MaxRID
        LEFT OUTER JOIN
      [StageUser1].Certifications       c                ON dc.liCertificationID = c.liCertificationID
        LEFT OUTER JOIN
      [MiXData].dbo.DIM_Drivers     dd WITH (NOLOCK) ON dd.OrganisationKey   = @organisationKey
                                                       AND dc.iDriverID         = dd.HostID
                                                       AND dd.IsCurrentRecord   = 1
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	      l.LookupTable  = 'DIM_Certifications'
	  AND l.LookupColumn = 'CertificationTypeLookupKey'
	  AND l.LookupKey    = 6; -- Driver Certificates

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create STAGE indexes
    CREATE INDEX IX_STAGE_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID
      ON [StageUser1].[STAGE_DIM_Certifications](HostID,CertificationTypeLookupKey,DriverGUID)
      INCLUDE(ExpirationDateKey,ObtainedDateKey);

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- update DriverCertifications only
    --   requires special merge because combination of liCertificationID and iDriverID makes record unique
    INSERT INTO [StageUser1].[ROLLBACK_DIM_Certifications]
    ( 
      [CertificationKey]          ,
      [OrganisationKey]           ,
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays] ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    )
    SELECT
      [CertificationKey]          ,
      [OrganisationKey]           ,
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays] ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET tar.[CertificationDescription]  = stg.[CertificationDescription] ,
          tar.[ExpirationDateKey]         = stg.[ExpirationDateKey]        ,
          tar.[ObtainedDateKey]           = stg.[ObtainedDateKey]          ,
          tar.[LastRenewalDateKey]        = stg.[LastRenewalDateKey]       ,
          tar.[CertificationDurationDays] = stg.[CertificationDurationDays],
          tar.[CertificationReminderDays] = stg.[CertificationReminderDays],
          tar.[UTCOffsetKey]              = stg.[UTCOffsetKey]             ,
          tar.UpdateBatchKey              = @batchKey
      OUTPUT
        DELETED.[CertificationKey]          ,
        DELETED.[OrganisationKey]           ,
        DELETED.[ChangeDate]                ,
        DELETED.[HostID]                    ,
        DELETED.[DriverGUID]                ,
        DELETED.[TrailerGUID]               ,
        DELETED.[VehicleGUID]               ,
        DELETED.[CertificationTypeLookupKey],
        DELETED.[CertificationDescription]  ,
        DELETED.[ExpirationDateKey]         ,
        DELETED.[ObtainedDateKey]           ,
        DELETED.[LastRenewalDateKey]        ,
        DELETED.[CertificationDurationDays] ,
        DELETED.[CertificationReminderDays] ,
        DELETED.[UTCOffsetKey]              ,
        DELETED.[CreateBatchKey]            ,
        DELETED.[UpdateBatchKey]
      FROM
        [StageUser1].[STAGE_DIM_Certifications] AS stg
          INNER JOIN
        [MiXData].dbo.DIM_Certifications    AS tar ON tar.OrganisationKey              = @organisationKey
                                                     AND tar.[HostID]                     = stg.[HostID]
                                                     AND tar.DriverGUID                   = stg.DriverGUID   -- additional lookup column
                                                     AND tar.[CertificationTypeLookupKey] = stg.[CertificationTypeLookupKey]
      WHERE
           stg.[CertificationTypeLookupKey] = @driverCertificatesLookupRID
      AND  (tar.[ExpirationDateKey]         = stg.[ExpirationDateKey]
       OR   tar.[ObtainedDateKey]           = stg.[ObtainedDateKey])
      ) AS upd;

    SELECT @recordsUpdated = ISNULL(@@ROWCOUNT,0);

    -- update all but DriverCertifications
    INSERT INTO [StageUser1].[ROLLBACK_DIM_Certifications]
    ( 
      [CertificationKey]          ,
      [OrganisationKey]           ,
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays] ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    )
    SELECT
      [CertificationKey]          ,
      [OrganisationKey]           ,
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays] ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET tar.[CertificationDescription]  = stg.[CertificationDescription] ,
          tar.[ExpirationDateKey]         = stg.[ExpirationDateKey]        ,
          tar.[ObtainedDateKey]           = stg.[ObtainedDateKey]          ,
          tar.[LastRenewalDateKey]        = stg.[LastRenewalDateKey]       ,
          tar.[CertificationDurationDays] = stg.[CertificationDurationDays],
          tar.[CertificationReminderDays] = stg.[CertificationReminderDays],
          tar.[UTCOffsetKey]              = stg.[UTCOffsetKey]             ,
          tar.UpdateBatchKey              = @batchKey
      OUTPUT
        DELETED.[CertificationKey]          ,
        DELETED.[OrganisationKey]           ,
        DELETED.[ChangeDate]                ,
        DELETED.[HostID]                    ,
        DELETED.[DriverGUID]                ,
        DELETED.[TrailerGUID]               ,
        DELETED.[VehicleGUID]               ,
        DELETED.[CertificationTypeLookupKey],
        DELETED.[CertificationDescription]  ,
        DELETED.[ExpirationDateKey]         ,
        DELETED.[ObtainedDateKey]           ,
        DELETED.[LastRenewalDateKey]        ,
        DELETED.[CertificationDurationDays] ,
        DELETED.[CertificationReminderDays] ,
        DELETED.[UTCOffsetKey]              ,
        DELETED.[CreateBatchKey]            ,
        DELETED.[UpdateBatchKey]
      FROM
        [StageUser1].[STAGE_DIM_Certifications] AS stg
          INNER JOIN
        [MiXData].dbo.DIM_Certifications    AS tar ON tar.OrganisationKey              = @organisationKey
                                                     AND tar.[HostID]                     = stg.[HostID]
                                                     AND tar.[CertificationTypeLookupKey] = stg.[CertificationTypeLookupKey]
      WHERE
           stg.[CertificationTypeLookupKey] <> @driverCertificatesLookupRID
      AND  (tar.[ExpirationDateKey]         = stg.[ExpirationDateKey]
       OR   tar.[ObtainedDateKey]           = stg.[ObtainedDateKey])
      ) AS upd;

    SELECT @recordsUpdated = @recordsUpdated + ISNULL(@@ROWCOUNT,0);

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;  
    END;  

    -- drop ROLLBACK indexes before insert
    CREATE INDEX IX_ROLLBACK_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID
      ON [StageUser1].[ROLLBACK_DIM_Certifications](HostID,CertificationTypeLookupKey,DriverGUID)
      INCLUDE(ExpirationDateKey,ObtainedDateKey);

    -- insert brand new records
    INSERT INTO [MiXData].dbo.DIM_Certifications
    ( 
      [OrganisationKey]           ,
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays] ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey                ,
      stg.[ChangeDate]                ,
      stg.[HostID]                    ,
      stg.[DriverGUID]                ,
      stg.[TrailerGUID]               ,
      stg.[VehicleGUID]               ,
      stg.[CertificationTypeLookupKey],
      stg.[CertificationDescription]  ,
      stg.[ExpirationDateKey]         ,
      stg.[ObtainedDateKey]           ,
      stg.[LastRenewalDateKey]        ,
      stg.[CertificationDurationDays] ,
      stg.[CertificationReminderDays] ,
      stg.[UTCOffsetKey]              ,
      @batchKey                 ,
      @batchKey
    FROM
      [StageUser1].[STAGE_DIM_Certifications] AS stg
    WHERE
      NOT EXISTS (SELECT 1
                  FROM
                    [StageUser1].[STAGE_DIM_Certifications] AS roll WITH (NOLOCK)
                  WHERE
                     (stg.[CertificationTypeLookupKey] <> @driverCertificatesLookupRID
                  AND stg.HostID                       = roll.HostID)
                  OR (stg.[CertificationTypeLookupKey] = @driverCertificatesLookupRID
                  AND stg.HostID                       = roll.HostID
                  AND stg.DriverGUID                   = roll.DriverGUID));

    SELECT @recordsInserted = ISNULL(@@ROWCOUNT,0);

    -- insert changed values
    INSERT INTO [MiXData].dbo.DIM_Certifications
    ( 
      [OrganisationKey]           ,
      [ChangeDate]                ,
      [HostID]                    ,
      [DriverGUID]                ,
      [TrailerGUID]               ,
      [VehicleGUID]               ,
      [CertificationTypeLookupKey],
      [CertificationDescription]  ,
      [ExpirationDateKey]         ,
      [ObtainedDateKey]           ,
      [LastRenewalDateKey]        ,
      [CertificationDurationDays] ,
      [CertificationReminderDays] ,
      [UTCOffsetKey]              ,
      [CreateBatchKey]            ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey                ,
      stg.[ChangeDate]                ,
      stg.[HostID]                    ,
      stg.[DriverGUID]                ,
      stg.[TrailerGUID]               ,
      stg.[VehicleGUID]               ,
      stg.[CertificationTypeLookupKey],
      stg.[CertificationDescription]  ,
      stg.[ExpirationDateKey]         ,
      stg.[ObtainedDateKey]           ,
      stg.[LastRenewalDateKey]        ,
      stg.[CertificationDurationDays] ,
      stg.[CertificationReminderDays] ,
      stg.[UTCOffsetKey]              ,
      @batchKey                        ,
      @batchKey
    FROM
      [StageUser1].[STAGE_DIM_Certifications] AS stg
        INNER JOIN
      [MiXData].dbo.DIM_Certifications     AS tar ON  tar.OrganisationKey              = @organisationKey
                                                     AND tar.[HostID]                     = stg.[HostID]
                                                     AND tar.[CertificationTypeLookupKey] = stg.[CertificationTypeLookupKey]
    WHERE 
        (stg.[CertificationTypeLookupKey] <> @driverCertificatesLookupRID
    OR   stg.[CertificationTypeLookupKey] =  @driverCertificatesLookupRID 
    AND  tar.DriverGUID = stg.DriverGUID)
    AND NOT
        (tar.[ExpirationDateKey] = stg.[ExpirationDateKey] 
    OR   tar.[ObtainedDateKey]   = stg.[ObtainedDateKey]);
    
    SELECT @recordsInserted = @recordsInserted + ISNULL(@@ROWCOUNT,0);
    
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.2 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_DIM_Certifications];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated + @recordsDeleted;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_Devices_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_Devices_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  int = 0;
  DECLARE @recordsUpdated   int = 0;
  DECLARE @recordsDeleted   int = 0;

  DECLARE @merge            table
  (
    Operation                     char (6)          NOT NULL,
    DeviceKey                     int               NOT NULL,
    OrganisationKey               int               NULL,
    HostID                        int               NOT NULL,
    DeviceType                    nvarchar (50)     NULL,
    DeviceName                    nvarchar (200)    NULL,
    SystemName                    nvarchar (255)    NULL,
    ReportProgID                  nvarchar (200)    NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].STAGE_DIM_Devices;
  TRUNCATE TABLE [StageUser1].ROLLBACK_DIM_Devices;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    ;WITH LatestDevice (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser1].Devices WITH (NOLOCK)
      GROUP BY
        liDeviceID
    )
    INSERT INTO [StageUser1].STAGE_DIM_Devices
    (
      HostID,
      DeviceType,
      DeviceName,
      SystemName,
      ReportProgID
    )
    SELECT
      d.liDeviceID,
      d.ucDeviceType,
      d.sDescription,
      d.sSystemName,
      d.sReportProgID
    FROM
      [StageUser1].Devices d WITH (NOLOCK)
      INNER JOIN LatestDevice l ON d.RID = l.MaxRID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  --BEGIN TRY

    --------------------------------------------

    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'3. Update calculated columns onto STG';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError @organisationKey = @organisationKey;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  --BEGIN TRY


    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'4. Validation before Loading to DW';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError @organisationKey = @organisationKey;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    MERGE [MiXData].[dbo].DIM_Devices tar
      USING [StageUser1].STAGE_DIM_Devices stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostID          = stg.HostID
      WHEN MATCHED THEN
        UPDATE
        SET
          tar.DeviceType      = stg.DeviceType,
          tar.DeviceName      = stg.DeviceName,
          tar.SystemName      = stg.SystemName,
          tar.ReportProgID    = stg.ReportProgID,
          tar.UpdateBatchKey  = @batchKey
      WHEN NOT MATCHED THEN
        INSERT
        (
          OrganisationKey,
          HostID,
          DeviceType,
          DeviceName,
          SystemName,
          ReportProgID,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.HostID,
          stg.DeviceType,
          stg.DeviceName,
          stg.SystemName,
          stg.ReportProgID,
          @batchKey,
          @batchKey
        )
      OUTPUT
        $action   AS Operation,
        ISNULL(DELETED.DeviceKey, INSERTED.DeviceKey),
        DELETED.OrganisationKey,
        ISNULL(DELETED.HostID, INSERTED.HostID),
        DELETED.DeviceType,
        DELETED.DeviceName,
        DELETED.SystemName,
        DELETED.ReportProgID,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
        INTO @merge;

    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merge
    WHERE
      Operation = 'INSERT';

    -- Add to RollBck table
    INSERT INTO [StageUser1].ROLLBACK_DIM_Devices
    (
      DeviceKey,
      OrganisationKey,
      HostID,
      DeviceType,
      DeviceName,
      SystemName,
      ReportProgID,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      DeviceKey,
      OrganisationKey,
      HostID,
      DeviceType,
      DeviceName,
      SystemName,
      ReportProgID,
      CreateBatchKey,
      UpdateBatchKey
    FROM
      @merge
    WHERE
      Operation = 'UPDATE';
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].STAGE_DIM_Devices;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    0                     RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_Drivers_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_Drivers_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey           int;
  DECLARE @UTCOffsetMinutes       smallint;
  DECLARE @maxAuditDate           datetimeoffset (0);
  DECLARE @startDate              datetimeoffset (0);
  DECLARE @tmpDate                datetimeoffset (0);
  DECLARE @endDate                datetimeoffset (0);
  DECLARE @startDateKey           date;
  DECLARE @previousEndDateKey     date;

  -- Default values
  DECLARE @startDateFirstInsert   date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @endDateDefault         date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)

  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                     nvarchar (10)     NOT NULL,
    DriverKey                     int               NOT NULL,
    StartDateKey                  date              NULL,
    EndDateKey                    date              NULL,
    IsCurrentRecord               bit               NULL,
    OrganisationKey               int               NULL,
    HostID                        int               NULL,
    DriverGUID                    uniqueidentifier  NULL,
    IsActive                      bit               NULL,
    SiteGUID                      uniqueidentifier  NULL,
    SiteKey                       int               NULL,
    DriverName                    nvarchar (255)    NULL,
    DriverEmployeeNumber          nvarchar (255)    NULL,
    DriverExtendedID              varchar (32)      NULL,
    ConfigurationGroupName        nvarchar (255)    NULL,
    UTCOffsetKey                  int               NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );
  DECLARE @type2Keys table
  (
    DriverKey                     int NOT NULL,
    HostID                        int NOT NULL
  );

  -- Get range for which SCD should be calculated
  SELECT
    @startDate     = MIN(ChangeDate),
    @maxAuditDate  = MAX(ChangeDate)
  FROM
    [StageUser1].Drivers;

  TRUNCATE TABLE [StageUser1].ROLLBACK_DIM_Drivers;

  -- Loop through calculation a day at a time and Load to DW
  WHILE @StartDate <= @MaxAuditDate
    BEGIN
    -- get timezone infomation
      SELECT
        @UTCOffsetKey     = UTCOffsetKey,
        @UTCOffsetMinutes = UTCOffsetMinutes,
        @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
      FROM
        [StageUser1].STAGE_DIM_UTCOffsetsLookUp
      WHERE
        @startDate     BETWEEN StartDateTime       AND EndDateTime
        AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

      SET @startDateKey       = CONVERT(date, @tmpDate);
    -- get the UTC time for the start of the next day in organisation's timezone
      SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
      SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
      TRUNCATE TABLE [StageUser1].STAGE_DIM_Drivers;

      IF @debugMode = 1  -- DebugMode is true
        PRINT N'0. Make sure work tables are cleared for processing from ' + CONVERT(nvarchar, @startDate, 0) + ' to ' + CONVERT(nvarchar, @endDate, 0);

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------


  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
      BEGIN TRY

        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser1].Drivers WITH (NOLOCK)
          WHERE
            ChangeDate      >= @startDate
            AND ChangeDate  <  @endDate
          GROUP BY
            iDriverID
        )
        INSERT INTO [StageUser1].STAGE_DIM_Drivers
        (
          DriverHostID,
          DriverGUID,
          DriverName,
          DriverEmployeeNumber,
          DriverExtendedID,
          SiteHostID,
          ConfigurationGroupName,
          IsActive
        )
        SELECT
          s.iDriverID,
          s.DriverGUID,
          s.sName,
          s.sEmployeeNumber,
          s.sExtendedID,
          s.liSiteID,
          g.sName,
          IsActive = CASE
                       WHEN s.Operation = 'D' THEN
                         0
                       ELSE
                         1
                     END
        FROM
          Latest l
          INNER JOIN [StageUser1].Drivers s      WITH (NOLOCK) ON l.RID       = s.RID
          LEFT  JOIN [StageUser1].DriverConfig g WITH (NOLOCK) ON s.liGroupID = g.liGroupID;
        SET @rowcount = @@ROWCOUNT;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
      BEGIN TRY

    ------------------------------------------
    -- SiteGUID
        UPDATE
          [StageUser1].STAGE_DIM_Drivers
        SET
          SiteGUID = ds.SiteGUID,
          SiteKey  = ds.SiteKey
        FROM
          [StageUser1].STAGE_DIM_Drivers stg
          INNER JOIN [MiXData].[dbo].DIM_Sites ds WITH (NOLOCK) ON @organisationKey = ds.OrganisationKey
                                                                  AND stg.SiteHostID    = ds.HostID;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'3. Update calculated columns onto STG';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
      --BEGIN TRY

        --IF @debugMode = 1  -- DebugMode is true
          --PRINT N'4. Validation before Loading to DW';

      --END TRY
      ---- CATCH Errors
      --BEGIN CATCH
        --EXEC [Control].sprLogError @organisationKey = @organisationKey;
        --RETURN -1;
      --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBack (Type 2)
  --------------------------------------------------------------------
      BEGIN TRY

        DELETE @merged;
        MERGE INTO [MiXData].[dbo].DIM_Drivers tar
          USING [StageUser1].STAGE_DIM_Drivers stg
             ON tar.OrganisationKey = @organisationKey
            AND tar.HostID          = stg.DriverHostID
        -- Matched and DW IsCurrent record (then just update)
          WHEN MATCHED
            AND tar.StartDateKey = @StartDateKey
            AND tar.EndDateKey   = @endDateDefault
            THEN UPDATE
            SET
              tar.IsActive             = stg.IsActive,
              tar.SiteGUID             = ISNULL(stg.SiteGUID,'00000000-0000-0000-0000-000000000000'),
              tar.SiteKey              = ISNULL(stg.SiteKey,-1),
              tar.DriverName           = stg.DriverName,
              tar.DriverEmployeeNumber = stg.DriverEmployeeNumber,
              tar.DriverExtendedID     = stg.DriverExtendedID,
              tar.DriverGUID           = stg.DriverGUID,
              tar.UpdateBatchKey       = @batchKey
        -- Not Matched -> insert new record into DW
          WHEN NOT MATCHED
            THEN INSERT
            (
              StartDateKey,
              EndDateKey,
              IsCurrentRecord,
              HostID,
              IsActive,
              DriverGUID,
              OrganisationKey,
              SiteGUID,
              SiteKey,
              DriverName,
              DriverEmployeeNumber,
              DriverExtendedID,
              ConfigurationGroupName,
              UTCOffsetKey,
              CreateBatchKey,
              UpdateBatchKey
            )
            VALUES
            (
              @startDateFirstInsert,
              @endDateDefault,
              1,
              stg.DriverHostID,
              stg.IsActive,
              stg.DriverGUID,
              @organisationKey,
              ISNULL(stg.SiteGUID,'00000000-0000-0000-0000-000000000000'),
              ISNULL(stg.SiteKey,-1),
              stg.DriverName,
              stg.DriverEmployeeNumber,
              stg.DriverExtendedID,
              stg.ConfigurationGroupName,
              @UTCOffsetKey,
              @batchKey,
              @batchKey
            )
          OUTPUT
            $action   AS Operation,
            ISNULL(DELETED.DriverKey, INSERTED.DriverKey),
            DELETED.StartDateKey,
            DELETED.EndDateKey,
            DELETED.IsCurrentRecord,
            ISNULL(DELETED.HostID, INSERTED.HostID),
            DELETED.IsActive,
            ISNULL(DELETED.DriverGUID, INSERTED.DriverGUID),
            DELETED.OrganisationKey,
            DELETED.SiteGUID,
            DELETED.SiteKey,
            DELETED.DriverName,
            DELETED.DriverEmployeeNumber,
            DELETED.DriverExtendedID,
            DELETED.ConfigurationGroupName,
            DELETED.UTCOffsetKey,
            DELETED.CreateBatchKey,
            DELETED.UpdateBatchKey
            INTO @merged;
        SET @rowcount = @@ROWCOUNT;
        SELECT
          @recordsInserted += COUNT(*)
        FROM
          @merged
        WHERE
          Operation = 'INSERT'
        
        INSERT INTO [StageUser1].ROLLBACK_DIM_Drivers
        (
          DriverKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          HostID,
          IsActive,
          DriverGUID,
          OrganisationKey,
          SiteGUID,
          SiteKey,
          DriverName,
          DriverEmployeeNumber,
          DriverExtendedID,
          ConfigurationGroupName,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        SELECT
          DriverKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          HostID,
          IsActive,
          DriverGUID,
          OrganisationKey,
          SiteGUID,
          SiteKey,
          DriverName,
          DriverEmployeeNumber,
          DriverExtendedID,
          ConfigurationGroupName,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        FROM
          @merged
        WHERE
          Operation          = 'UPDATE'
          AND UpdateBatchKey < @batchKey;
        SET @recordsUpdated += @@ROWCOUNT;
        
       IF @debugMode = 1
          PRINT '    after merge: rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

  --------------------------------------------------------------------
      -- type 2 changes -> first expire current
        DELETE @type2Keys;
        INSERT INTO @type2Keys
        SELECT
          tar.DriverKey,
          tar.HostID
        FROM
          [MiXData].[dbo].DIM_Drivers tar
          INNER JOIN [StageUser1].STAGE_DIM_Drivers stg ON tar.OrganisationKey = @organisationKey
                                                      AND tar.HostID          = stg.DriverHostID
        WHERE
          tar.StartDateKey      < @StartDateKey
          AND  tar.EndDateKey   = @endDateDefault
          AND CHECKSUM
              (
                tar.SiteGUID            ,
                tar.DriverName          ,
                tar.DriverEmployeeNumber,
                tar.DriverExtendedID    ,
                tar.IsActive            ,
                tar.DriverGUID
              )
              <>
              CHECKSUM
              (
                CONVERT(uniqueidentifier,ISNULL(stg.SiteGUID,'00000000-0000-0000-0000-000000000000')),
                stg.DriverName,
                stg.DriverEmployeeNumber,
                stg.DriverExtendedID,
                stg.IsActive,
                stg.DriverGUID
              );
        SET @rowcount = @@ROWCOUNT;

        INSERT INTO [StageUser1].ROLLBACK_DIM_Drivers
        (
          DriverKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          HostID,
          IsActive,
          DriverGUID,
          OrganisationKey,
          SiteGUID,
          SiteKey,
          DriverName,
          DriverEmployeeNumber,
          DriverExtendedID,
          ConfigurationGroupName,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        SELECT
          DriverKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          HostID,
          IsActive,
          DriverGUID,
          OrganisationKey,
          SiteGUID,
          SiteKey,
          DriverName,
          DriverEmployeeNumber,
          DriverExtendedID,
          ConfigurationGroupName,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        FROM
         (UPDATE
            [MiXData].[dbo].DIM_Drivers
          SET
            EndDateKey      = @previousEndDateKey,
            IsCurrentRecord = 0,
            UpdateBatchKey  = @batchKey
          OUTPUT
            DELETED.DriverKey,
            DELETED.StartDateKey,
            DELETED.EndDateKey,
            DELETED.IsCurrentRecord,
            DELETED.HostID,
            DELETED.IsActive,
            DELETED.DriverGUID,
            DELETED.OrganisationKey,
            DELETED.SiteGUID,
            DELETED.SiteKey,
            DELETED.DriverName,
            DELETED.DriverEmployeeNumber,
            DELETED.DriverExtendedID,
            DELETED.ConfigurationGroupName,
            DELETED.UTCOffsetKey,
            DELETED.CreateBatchKey,
            DELETED.UpdateBatchKey
          FROM
            [MiXData].[dbo].DIM_Drivers tar
            INNER JOIN @type2Keys k ON tar.DriverKey = k.DriverKey
          ) AS RollBck              -- end update
        WHERE
          UpdateBatchKey < @batchKey; -- end insert

        -- Insert new Records for Type 2 changes
        INSERT INTO [MiXData].[dbo].DIM_Drivers
        (
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          HostID,
          IsActive,
          DriverGUID,
          OrganisationKey,
          SiteGUID,
          SiteKey,
          DriverName,
          DriverEmployeeNumber,
          DriverExtendedID,
          ConfigurationGroupName,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        SELECT
          @startDateKey,
          @endDateDefault,
          1,
          stg.DriverHostID,
          stg.IsActive,
          stg.DriverGUID,
          @organisationKey,
          ISNULL(stg.SiteGUID,'00000000-0000-0000-0000-000000000000'),
          ISNULL(stg.SiteKey,-1),
          stg.DriverName,
          stg.DriverEmployeeNumber,
          stg.DriverExtendedID,
          stg.ConfigurationGroupName,
          @UTCOffsetKey,
          @batchKey,
          @batchKey
        FROM
          [StageUser1].STAGE_DIM_Drivers stg
          INNER JOIN @type2Keys k ON stg.DriverHostID = k.HostID;
        SET @recordsType2Inserted += @@ROWCOUNT;

        IF @debugMode = 1
          PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  -- next day to process:
      SELECT
        @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
      FROM
        [StageUser1].Drivers
      WHERE
        ChangeDate >= @endDate;

    END -- END WHILE

  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------
  BEGIN TRY

    -- only need to stage keys and type1 columns
    TRUNCATE TABLE [StageUser1].STAGE_DIM_Drivers;
    ;WITH Latest (RID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser1].Drivers WITH (NOLOCK)
      GROUP BY
        iDriverID
    )
    INSERT INTO [StageUser1].STAGE_DIM_Drivers
    (
      DriverHostID,
      ConfigurationGroupName
    )
    SELECT
      s.iDriverID,
      g.sName
    FROM
      Latest l
      INNER JOIN [StageUser1].Drivers s      WITH (NOLOCK) ON l.RID       = s.RID
      LEFT  JOIN [StageUser1].DriverConfig g WITH (NOLOCK) ON s.liGroupID = g.liGroupID;

    INSERT INTO [StageUser1].ROLLBACK_DIM_Drivers
    (
      DriverKey,
      StartDateKey,
      EndDateKey,
      IsCurrentRecord,
      HostID,
      IsActive,
      DriverGUID,
      OrganisationKey,
      SiteGUID,
      SiteKey,
      DriverName,
      DriverEmployeeNumber,
      DriverExtendedID,
      ConfigurationGroupName,
      UTCOffsetKey,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      DriverKey,
      StartDateKey,
      EndDateKey,
      IsCurrentRecord,
      HostID,
      IsActive,
      DriverGUID,
      OrganisationKey,
      SiteGUID,
      SiteKey,
      DriverName,
      DriverEmployeeNumber,
      DriverExtendedID,
      ConfigurationGroupName,
      UTCOffsetKey,
      CreateBatchKey,
      UpdateBatchKey
    FROM
     (
      UPDATE
        [MiXData].[dbo].DIM_Drivers
      SET
        ConfigurationGroupName = stg.ConfigurationGroupName
      OUTPUT
        DELETED.DriverKey,
        DELETED.StartDateKey,
        DELETED.EndDateKey,
        DELETED.IsCurrentRecord,
        DELETED.HostID,
        DELETED.IsActive,
        DELETED.DriverGUID,
        DELETED.OrganisationKey,
        DELETED.SiteGUID,
        DELETED.SiteKey,
        DELETED.DriverName,
        DELETED.DriverEmployeeNumber,
        DELETED.DriverExtendedID,
        DELETED.ConfigurationGroupName,
        DELETED.UTCOffsetKey,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
      FROM
        [MiXData].[dbo].DIM_Drivers tar
        INNER JOIN [StageUser1].STAGE_DIM_Drivers stg ON tar.OrganisationKey = @organisationKey
                                                    AND tar.HostID          = stg.DriverHostID
      WHERE
        tar.ConfigurationGroupName <> stg.ConfigurationGroupName
     ) rllbck
    WHERE
      UpdateBatchKey < @batchKey;
    SET @recordsUpdated += @@ROWCOUNT;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Update Type 1 columns on DW';

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    BEGIN
      TRUNCATE TABLE [StageUser1].STAGE_DIM_Drivers;
    END;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_EventDescriptions_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_EventDescriptions_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  int = 0;
  DECLARE @recordsUpdated   int = 0;
  DECLARE @recordsDeleted   int = 0;
  
  DECLARE @summaryMinLookupKey     int;
  DECLARE @summaryMaxLookupKey     int;
  DECLARE @summaryAverageLookupKey int;
  DECLARE @summaryLastLookupKey    int;
  
  DECLARE @merge            table
  (
    Operation                     char (6)          NOT NULL,
    EventDescriptionKey           int               NOT NULL,
    OrganisationKey               int               NULL,
    HostID                        int               NOT NULL,
    EventName                     nvarchar (255)    NULL,
    ParameterKey                  int               NULL,
    SummaryTypeLookupKey          int               NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  )
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].STAGE_DIM_EventDescriptions;
  TRUNCATE TABLE [StageUser1].ROLLBACK_DIM_EventDescriptions;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY
  
    SELECT
      @summaryMinLookupKey     = tcl1.LookupRID,
      @summaryMaxLookupKey     = tcl2.LookupRID,
      @summaryAverageLookupKey = tcl3.LookupRID,
      @summaryLastLookupKey    = tcl4.LookupRID
    FROM
      [MiXData].dbo.DIM_TableColumnLookups tcl1 WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups tcl2 WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups tcl3 WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_TableColumnLookups tcl4 WITH (NOLOCK)
	  WHERE
	      tcl1.LookupTable  = 'DIM_EventDescriptions'
	  AND tcl1.LookupColumn = 'SummaryTypeLookupKey'
	  AND tcl1.LookupKey    = 1  -- Summary Min
	  AND tcl2.LookupTable  = 'DIM_EventDescriptions'
	  AND tcl2.LookupColumn = 'SummaryTypeLookupKey'
	  AND tcl2.LookupKey    = 2  -- Summary Max
	  AND tcl3.LookupTable  = 'DIM_EventDescriptions'
	  AND tcl3.LookupColumn = 'SummaryTypeLookupKey'
	  AND tcl3.LookupKey    = 3  -- Summary Average
	  AND tcl4.LookupTable  = 'DIM_EventDescriptions'
	  AND tcl4.LookupColumn = 'SummaryTypeLookupKey'
	  AND tcl4.LookupKey    = 4; -- Summary Last Reading

    -- insert existing event groups
    ;WITH LastRID (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser1].EventDescription WITH (NOLOCK)
      GROUP BY
        iEventID
    )
    INSERT INTO [StageUser1].STAGE_DIM_EventDescriptions
    (
      HostID,
      EventName,
      SummaryTypeLookupKey,
      SummaryID
    )
    SELECT
      s.iEventID,
      s.sDescription,
      CASE
        WHEN s.ucSummaryType = 0 THEN @summaryMinLookupKey
        WHEN s.ucSummaryType = 1 THEN @summaryMaxLookupKey
        WHEN s.ucSummaryType = 2 THEN @summaryAverageLookupKey
        WHEN s.ucSummaryType = 3 THEN @summaryLastLookupKey
        ELSE -1
      END,
      s.iSummaryID
    FROM
      [StageUser1].EventDescription s WITH (NOLOCK)
      INNER JOIN LastRID lr ON s.RID = lr.MaxRID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- ParameterKey
    UPDATE
      [StageUser1].STAGE_DIM_EventDescriptions
    SET
      ParameterKey = dcp.ParameterKey
    FROM
      [StageUser1].STAGE_DIM_EventDescriptions    stg
        INNER JOIN
      [MiXData].dbo.DIM_CalibrationParameters dcp WITH (NOLOCK) ON dcp.OrganisationKey = @organisationKey
                                                                  AND dcp.HostID          = stg.SummaryID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  --BEGIN TRY

    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'4. Validation before Loading to DW';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError @organisationKey = @organisationKey;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    MERGE [MiXData].[dbo].DIM_EventDescriptions tar
      USING [StageUser1].STAGE_DIM_EventDescriptions stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostID          = stg.HostID
      WHEN MATCHED THEN
        UPDATE
        SET
          tar.EventName            = stg.EventName           ,
          tar.ParameterKey         = ISNULL(stg.ParameterKey ,-1),
          tar.SummaryTypeLookupKey = stg.SummaryTypeLookupKey
      WHEN NOT MATCHED THEN
        INSERT
        ( 
          OrganisationKey,
          HostID,
          EventName,
          ParameterKey,
          SummaryTypeLookupKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.HostID,
          stg.EventName,
          ISNULL(stg.ParameterKey,-1),
          stg.SummaryTypeLookupKey,
          @batchKey,
          @batchKey
        )
      OUTPUT 
        $action   AS Operation, 
        ISNULL(DELETED.EventDescriptionKey, INSERTED.EventDescriptionKey),
        ISNULL(DELETED.OrganisationKey,INSERTED.OrganisationKey),
        ISNULL(DELETED.HostID, INSERTED.HostID),
        DELETED.EventName,
        DELETED.ParameterKey,
        DELETED.SummaryTypeLookupKey,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
      INTO @merge;

    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merge
    WHERE
      Operation = 'INSERT';

    -- Add to RollBck table
    INSERT INTO [StageUser1].ROLLBACK_DIM_EventDescriptions
    ( 
      EventDescriptionKey,
      OrganisationKey,
      HostID,
      EventName,
      ParameterKey,
      SummaryTypeLookupKey,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      EventDescriptionKey,
      OrganisationKey,
      HostID,
      EventName,
      ParameterKey,
      SummaryTypeLookupKey,
      CreateBatchKey,
      UpdateBatchKey
    FROM
      @merge
    WHERE
      Operation = 'UPDATE'; -- end insert
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_DIM_EventDescriptions];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  
  SELECT
    @recordsInserted      RecordsInserted,
    0                     RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_EventGroups_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_EventGroups_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_DIM_EventGroups];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_DIM_EventGroups];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- insert existing event groups
    ;WITH
    LatestEventDescription AS
    (
      SELECT
        MaxRID = MAX(RID)
      FROM [StageUser1].EventDescription s WITH (NOLOCK)
      GROUP BY
        iEventID
    )
	  INSERT INTO [StageUser1].[STAGE_DIM_EventGroups]
	  (
	    EventID,
	    EventGroupnameLookupKey
	  )
	  SELECT
      s.iEventID,
      l.LookupRID
	  FROM
	    LatestEventDescription               lst
	      INNER JOIN
	    [StageUser1].EventDescription         s WITH (NOLOCK) ON s.RID = lst.MaxRID
	      CROSS JOIN
	    [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	    s.iEventID    BETWEEN -32000 AND -30000
	  AND
	    l.LookupTable  = 'DIM_EventGroups'
	  AND
	    l.LookupColumn = 'EventGroupnameLookupKey'
	  AND
	    l.LookupKey     = 2 -- System
    UNION
	  SELECT
      s.iEventID,
      l.LookupRID
	  FROM
	    LatestEventDescription               lst
	      INNER JOIN
	    [StageUser1].EventDescription         s WITH (NOLOCK) ON s.RID = lst.MaxRID
	      CROSS JOIN
	    [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	    s.iEventID    BETWEEN -29999 AND -1
	  AND
	    l.LookupTable  = 'DIM_EventGroups'
	  AND
	    l.LookupColumn = 'EventGroupnameLookupKey'
	  AND
	    l.LookupKey    = 3 -- User Defined
    UNION
	  SELECT
      s.iEventID,
      l.LookupRID
	  FROM
	    LatestEventDescription               lst
	      INNER JOIN
	    [StageUser1].EventDescription         s WITH (NOLOCK) ON s.RID = lst.MaxRID
	      INNER JOIN
	    [Control].EventGroupLookups          g WITH (NOLOCK)
	      ON s.iEventID  = g.iEventID
	      INNER JOIN
	    [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	      ON l.LookupKey = g.EventGroupnameLookupKey
	  WHERE
	    l.LookupTable = 'DIM_EventGroups'
	  AND
	    LookupColumn  = 'EventGroupnameLookupKey';

    -- insert Undefined event groups
    ;WITH
    LatestEventDescription AS
    (
      SELECT
        MaxRID = MAX(RID)
      FROM [StageUser1].EventDescription s WITH (NOLOCK)
      GROUP BY
        iEventID
    )
	  INSERT INTO [StageUser1].[STAGE_DIM_EventGroups]
	  (
	    EventID,
	    EventGroupnameLookupKey
	  )
	  SELECT
      s.iEventID,
      l.LookupKey
	  FROM
	    LatestEventDescription               lst
	      INNER JOIN
	    [StageUser1].EventDescription         s WITH (NOLOCK) ON s.RID = lst.MaxRID
	      CROSS JOIN
	    [MiXData].dbo.DIM_TableColumnLookups l WITH (NOLOCK)
	  WHERE
	    l.LookupTable  = 'DIM_EventGroups'
	  AND
	    l.LookupColumn = 'EventGroupnameLookupKey'
	  AND
	    l.LookupKey    = 1 -- Undefined
    AND
      NOT EXISTS (SELECT 1
                  FROM
                    [StageUser1].[STAGE_DIM_EventGroups] stg
                  WHERE
                    stg.EventID = s.iEventID)


    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    UPDATE
      [StageUser1].[STAGE_DIM_EventGroups]
    SET
      EventDescriptionKey = ded.EventDescriptionKey
    FROM
      [StageUser1].STAGE_DIM_EventGroups  stg
        INNER JOIN
      [MiXData].dbo.DIM_EventDescriptions ded WITH (NOLOCK) 
        ON ded.OrganisationKey = @organisationKey
       AND ded.HostID          = stg.EventID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Add to RollBck table
    INSERT INTO [StageUser1].[ROLLBACK_DIM_EventGroups]
    ( [EventGroupKey]          ,
      [OrganisationKey]        ,
      [EventGroupnameLookupKey],
      [EventDescriptionKey]    ,
      [CreateBatchKey]         ,
      [UpdateBatchKey]    )
    SELECT
      [EventGroupKey]          ,
      [OrganisationKey]        ,
      [EventGroupnameLookupKey],
      [EventDescriptionKey]    ,
      [CreateBatchKey]         ,
      [UpdateBatchKey]
    FROM 
     (MERGE [MiXData].dbo.DIM_EventGroups     AS tar
      USING [StageUser1].[STAGE_DIM_EventGroups] AS stg
       ON  tar.OrganisationKey           = @organisationKey
       AND tar.[EventDescriptionKey]     = stg.[EventDescriptionKey]
       AND tar.[EventGroupnameLookupKey] = stg.[EventGroupnameLookupKey]
      --WHEN MATCHED
      --THEN
      -- Not Matched
      WHEN NOT MATCHED THEN
        INSERT
        ( 
          [OrganisationKey]        ,
          [EventGroupnameLookupKey],
          [EventDescriptionKey]    ,
          [CreateBatchKey]         ,
          [UpdateBatchKey]
        )
        VALUES
        (
          @organisationKey             ,
          stg.[EventGroupnameLookupKey],
          stg.[EventDescriptionKey]    ,
          @batchKey                     ,
          @batchKey
        )
      OUTPUT 
        $action   AS Operation, 
        DELETED.[EventGroupKey]          ,
        DELETED.[OrganisationKey]        ,
        DELETED.[EventGroupnameLookupKey],
        DELETED.[EventDescriptionKey]    ,
        DELETED.[CreateBatchKey]         ,
        DELETED.[UpdateBatchKey]
      ) AS RollBck              -- end merge
    WHERE
      Operation        = 'UPDATE'; -- end insert

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_DIM_EventGroups];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsUpdated = count(1)
  FROM
    [MiXData].dbo.DIM_EventGroups WITH (NOLOCK)
  WHERE
    OrganisationKey = @organisationKey
  AND
    UpdateBatchKey  = @batchKey;

  SELECT
    @recordsInserted = count(1)
  FROM
    [MiXData].dbo.DIM_EventGroups WITH (NOLOCK)
  WHERE
    OrganisationKey = @organisationKey
  AND
    CreateBatchKey  = @batchKey;
  
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = (isnull(@recordsUpdated,0) - isnull(@recordsInserted,0)),  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_GeoLocations_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_GeoLocations_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted int = 0;
  DECLARE @recordsAffected int = 0;

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------

  TRUNCATE TABLE [StageUser1].STAGE_DIM_GeoLocations;
  TRUNCATE TABLE [StageUser1].STAGE_DIM_OrganisationsToGeoLocations

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfrecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create index on source
    IF NOT EXISTS(SELECT *
                  FROM [sys].indexes
                  WHERE object_id = OBJECT_ID(N'[StageUser1].GPSData', 'U') AND name = 'IX_GPSData_fLongitude_fLatitude')
      BEGIN
        CREATE INDEX IX_GPSData_fLongitude_fLatitude ON [StageUser1].GPSData
        (
          fLongitude,
          fLatitude
        ) WITH (FILLFACTOR = 100);
      END;

    -- drop indexes on STAGE
    IF EXISTS(SELECT *
              FROM [sys].indexes
              WHERE object_id = OBJECT_ID(N'[StageUser1].STAGE_DIM_GeoLocations', N'U') AND name = 'IX_STAGE_DIM_GeoLocations_GeoLocationKey')
      BEGIN
        DROP INDEX IX_STAGE_DIM_GeoLocations_GeoLocationKey ON [StageUser1].STAGE_DIM_GeoLocations;
      END;

    IF EXISTS(SELECT *
              FROM [sys].indexes
              WHERE object_id = OBJECT_ID(N'[StageUser1].STAGE_DIM_GeoLocations', N'U') AND name = 'IX_STAGE_DIM_GeoLocations_Longitude_Latitude')
      BEGIN
        DROP INDEX IX_STAGE_DIM_GeoLocations_Longitude_Latitude ON [StageUser1].STAGE_DIM_GeoLocations;
      END;

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].STAGE_DIM_OrganisationsToGeoLocations') AND name = N'IX_STAGE_DIM_OrganisationsToGeoLocations_LocationPoint')
      BEGIN
        DROP INDEX IX_STAGE_DIM_OrganisationsToGeoLocations_LocationPoint ON [StageUser1].STAGE_DIM_OrganisationsToGeoLocations;
      END;

    -- insert into STAGE
    ;WITH NoteworthyPoints (HostID, Longitude, Latitude) AS
    (
      SELECT
        g.liGPSID,
        ROUND(g.fLongitude, 5),
        ROUND(g.fLatitude, 5)
      FROM
        [StageUser1].[GPSData] g WITH (NOLOCK)
    )
    INSERT INTO [StageUser1].STAGE_DIM_GeoLocations
    (HostID,   Longitude,   Latitude)
    SELECT
      n.HostID,
      n.Longitude,
      n.Latitude
    FROM
      NoteworthyPoints n;
    SELECT @recordsAffected = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
      BEGIN  
        EXEC [Control].strProcProgressMonitor_Set  
          @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfrecordsAffected=@recordsAffected;  
        PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2. Add to STG';  
      END;  

    DROP INDEX IX_GPSData_fLongitude_fLatitude ON [StageUser1].GPSData;

    CREATE INDEX IX_STAGE_DIM_GeoLocations_Longitude_Latitude ON [StageUser1].STAGE_DIM_GeoLocations
    (
      Longitude,
      Latitude
    ) WITH (FILLFACTOR = 100);

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.9 created indexes';  

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;

    SELECT
      @recordsInserted      RecordsInserted,
      0                     RecordsType2Inserted,
      0                     RecordsUpdated,
      0                     RecordsDeleted,
      ERROR_NUMBER()        ErrorCode;

    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. Insert to DW (Load)
  --------------------------------------------------------------------
  BEGIN TRY

    ;WITH
    distinctPoints (Longitude,Latitude) AS
    (
      SELECT DISTINCT
        stg.Longitude,
        stg.Latitude
      FROM
        [StageUser1].STAGE_DIM_GeoLocations stg
    )
    INSERT INTO [MiXData].[dbo].DIM_GeoLocations
    (
      OrganisationKey,
      LocationPoint,
      Longitude,
      Latitude,
      StreetLevelName,
      GeographyKey,
      CreateBatchKey,
      UpdateBatchKey
    )
    OUTPUT
      INSERTED.GeoLocationKey,INSERTED.LocationPoint
    INTO [StageUser1].STAGE_DIM_OrganisationsToGeoLocations
    SELECT
      @organisationKey,
      geography::Point(stg.Latitude, stg.Longitude, 4326),
      stg.Longitude,
      stg.Latitude,
      '',
      -1,
      @batchKey,
      @batchKey
    FROM
      distinctPoints stg
    WHERE
      NOT EXISTS (SELECT *
                  FROM
                    [MiXData].[dbo].DIM_GeoLocations tar
                  WHERE
                      tar.OrganisationKey = @organisationKey
                  AND tar.Longitude       = stg.Longitude
                  AND tar.Latitude        = stg.Latitude);
    SET @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfrecordsAffected=@recordsInserted;  
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 5.2 Inserted ' + CAST(@recordsInserted AS nvarchar)  + ' new geolocations';
    END;  

    UPDATE
      [StageUser1].STAGE_DIM_GeoLocations
    SET
      GeoLocationKey = dim.GeoLocationKey
    FROM
      [StageUser1].STAGE_DIM_GeoLocations  stg
        INNER JOIN
      [MiXData].[dbo].DIM_GeoLocations dim WITH (NOLOCK) ON dim.OrganisationKey = @organisationKey
                                                           AND stg.Longitude       = dim.Longitude
                                                           AND stg.Latitude        = dim.Latitude;
    SELECT @recordsAffected = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.3 Return GeoLocationKeys', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfrecordsAffected=@recordsAffected;  
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N': 5.3 Return GeoLocationKeys';
    END;

    CREATE NONCLUSTERED INDEX IX_STAGE_DIM_GeoLocations_GeoLocationKey
       ON [StageUser1].STAGE_DIM_GeoLocations( GeoLocationKey ) WITH (FILLFACTOR = 100);

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;

    SELECT
      @recordsInserted      RecordsInserted,
      0                     RecordsType2Inserted,
      0                     RecordsUpdated,
      0                     RecordsDeleted,
      ERROR_NUMBER()        ErrorCode;

    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    0                     RecordsType2Inserted,
    0                     RecordsUpdated,
    0                     RecordsDeleted,
    0                     ErrorCode;

  IF @debugMode = 1  -- DebugMode is true  
  BEGIN  
    SELECT @recordsAffected = @recordsInserted;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfrecordsAffected=@recordsAffected;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 7. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_GeoLocationsToShapes_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_GeoLocationsToShapes_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  int = 0;
  DECLARE @recordsDeleted   int = 0;
  DECLARE @nrOfrecordsAffected int = 0;
  DECLARE @minBatchKey      int; -- used to identify if existing GeoLocations existed before inserting as new shapes

  CREATE TABLE #inserting 
  (
    GeoLocationKey                int               NOT NULL,
    ShapeKey                      int               NOT NULL
  );

  CREATE TABLE #inserting_changed
  (
    GeoLocationKey                int               NOT NULL,
    ShapeKey                      int               NOT NULL
  );

  CREATE TABLE #deleting         
  (
    GeoLocationToShapeKey         bigint            NOT NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    TRUNCATE TABLE [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes;

    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes') AND name = N'IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes')
      DROP INDEX IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes ON [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes;

    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser1].STAGE_DIM_OrganisationsToGeoLocations') AND name = N'IX_STAGE_DIM_OrganisationsToGeoLocations_LocationPoint')
      CREATE SPATIAL INDEX IX_STAGE_DIM_OrganisationsToGeoLocations_LocationPoint ON [StageUser1].STAGE_DIM_OrganisationsToGeoLocations(LocationPoint)
        USING GEOGRAPHY_GRID WITH
        ( CELLS_PER_OBJECT = 6,GRIDS = (LEVEL_1 = HIGH, LEVEL_2 = HIGH, LEVEL_3 = HIGH, LEVEL_4 = HIGH),ONLINE = OFF );

    INSERT INTO [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes
    (
      ShapeKey,
      ShapeBoundary
    )
    SELECT
      ds.ShapeKey,
      ds.ShapeBoundary
    FROM
      [MiXData].[dbo].DIM_Shapes ds WITH (NOLOCK)
    WHERE
        ds.OrganisationKey = @organisationKey
    AND ds.IsDeleted       = 0;

    CREATE SPATIAL INDEX IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes ON [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes(ShapeBoundary)
      USING GEOGRAPHY_GRID WITH
      ( CELLS_PER_OBJECT = 32, GRIDS = (LEVEL_1 = MEDIUM, LEVEL_2 = MEDIUM, LEVEL_3 = HIGH, LEVEL_4 = HIGH), ONLINE = OFF );

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.0 Initial Insert - Shapes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.0 Add to STG - Shapes ' + CAST(@nrOfrecordsAffected AS nvarchar);
    END;

    -- Add all new GeoLocation points in an existing Shape for the organisation:
    INSERT INTO #inserting
    (
      GeoLocationKey,
      ShapeKey
    )
    SELECT
      og.GeoLocationKey,
      s.ShapeKey
    FROM
      [StageUser1].STAGE_DIM_OrganisationsToGeoLocations        og WITH (NOLOCK) --,INDEX (IX_STAGE_DIM_OrganisationsToGeoLocations_LocationPoint))
        INNER JOIN
      [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes s  WITH (NOLOCK)
        ON s.ShapeBoundary.STIntersects(og.LocationPoint) = 1;

    CREATE INDEX IX_inserting ON #inserting(GeoLocationKey,ShapeKey);

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.1 Initial Insert - new Geo points', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.1 Add to STG - new Geo points ' + CAST(@nrOfrecordsAffected AS nvarchar);
    END;

    TRUNCATE TABLE [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes;
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes') AND name = N'IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes')
      DROP INDEX IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes ON [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes;

    -- Find all Shapes with new boundaries for the organisation:
    INSERT INTO [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes
    (
      ShapeKey,
      ShapeBoundary
    )
    SELECT
      ds.ShapeKey,
      ds.ShapeBoundary
    FROM
      [MiXData].[dbo].DIM_Shapes ds WITH (NOLOCK)
        INNER JOIN
      [StageUser1].ROLLBACK_DIM_Shapes rbds ON ds.ShapeKey = rbds.ShapeKey
    WHERE
        ds.IsDeleted = 0
    AND (ISNULL(rbds.ShapeBoundary.STEquals(ds.ShapeBoundary), 0) = 0
    OR rbds.IsDeleted <> ds.IsDeleted);
    SELECT @nrOfrecordsAffected = @@ROWCOUNT;

    -- brand new shapes

    -- only add to [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes if existing points already exists
    --   (dont want to run this for initial insert since we have already added these in step 2.1)
    SELECT @minBatchKey = MIN(CreateBatchKey)
    FROM [MiXData].[dbo].DIM_Vehicles WITH (NOLOCK)
    WHERE OrganisationKey = @organisationKey;

    SELECT @nrOfrecordsAffected = 0;
    IF (@batchKey > ISNULL(@minBatchKey,0))
    BEGIN
      INSERT INTO [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes
      (
        ShapeKey,
        ShapeBoundary
      )
      SELECT
        ds.ShapeKey,
        ds.ShapeBoundary
      FROM
        [MiXData].[dbo].DIM_Shapes ds WITH (NOLOCK)
      WHERE
          ds.OrganisationKey = @organisationKey
      AND ds.CreateBatchKey  = @batchKey
      AND ds.IsDeleted       = 0
      AND NOT EXISTS (SELECT 1
                      FROM [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes cs
                      WHERE cs.ShapeKey = ds.ShapeKey);
      SELECT @nrOfrecordsAffected = @nrOfrecordsAffected + @@ROWCOUNT;
    END;
    
    CREATE SPATIAL INDEX IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes ON [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes(ShapeBoundary)
      USING GEOGRAPHY_GRID WITH
      ( CELLS_PER_OBJECT = 32, GRIDS = (LEVEL_1 = MEDIUM, LEVEL_2 = MEDIUM, LEVEL_3 = HIGH, LEVEL_4 = HIGH), ONLINE = OFF );

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.2 Initial Insert - changed Shapes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.2 Add to STG - changed Shapes ' + CAST(@nrOfrecordsAffected AS nvarchar);
    END;

  --Save all locations that fall into these changed shapes:
    SELECT @nrOfrecordsAffected = 0;
    IF (ISNULL((SELECT COUNT(1) FROM [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes),0) > 0) -- only exec if changed shapes exists
    BEGIN
      INSERT INTO #inserting_changed
      (
        GeoLocationKey,
        ShapeKey
      )
      SELECT
        g.GeoLocationKey,
        s.ShapeKey
      FROM
        [MiXData].[dbo].DIM_GeoLocations g  WITH (NOLOCK,INDEX (IX_DIM_GeoLocations_LocationPoint))
          INNER JOIN
        [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes s WITH (NOLOCK)
                                                                 ON g.OrganisationKey = @organisationKey
                                                                AND s.ShapeBoundary.STIntersects(g.LocationPoint) = 1;

      CREATE INDEX IX_inserting_changed ON #inserting_changed(GeoLocationKey,ShapeKey);

      DELETE c
      FROM       
        #inserting_changed c
          INNER JOIN
        [MiXData].[dbo].DIM_GeoLocationsToShapes gs WITH (NOLOCK) ON gs.GeoLocationKey = c.GeoLocationKey
                                                                 AND gs.ShapeKey       = c.ShapeKey;

      INSERT INTO #inserting
      (
        GeoLocationKey,
        ShapeKey
      )
      SELECT
        c.GeoLocationKey,
        c.ShapeKey
      FROM #inserting_changed c
      WHERE
          NOT EXISTS (SELECT *
                      FROM
                        #inserting i
                      WHERE
                          i.GeoLocationKey = c.GeoLocationKey
                      AND i.ShapeKey       = c.ShapeKey);

      SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    END; -- end if only execute if changed shapes exists

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.3 Initial Insert - changed Shape points', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.3 Add to STG - changed Shape points';
    END;

  -- Now detect any locations no longer in the changed shapes
    -- only need to remove records for changed shapes only and not new shapes
    DELETE
      ds
    FROM
      [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes ds
    WHERE NOT EXISTS (SELECT 1
                      FROM [StageUser1].ROLLBACK_DIM_Shapes rbds 
                      WHERE ds.ShapeKey = rbds.ShapeKey);

    SELECT @nrOfrecordsAffected = 0;
    IF (ISNULL((SELECT COUNT(1) FROM [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes),0) > 0) -- only exec if changed shapes exists
    BEGIN
      ;WITH
      ExistingGeoLocationsToShapes AS
      (
        SELECT
          gs.GeoLocationToShapeKey,
          gs.GeoLocationKey
        FROM
          [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes s  WITH (NOLOCK)
            INNER JOIN
          [MiXData].[dbo].DIM_GeoLocationsToShapes                  gs WITH (NOLOCK) ON s.ShapeKey = gs.ShapeKey
      )
      INSERT INTO #deleting
      (
        GeoLocationToShapeKey
      )
      SELECT
        gs.GeoLocationToShapeKey
      FROM
        ExistingGeoLocationsToShapes     gs
          INNER JOIN
        [MiXData].[dbo].DIM_GeoLocations g   WITH (NOLOCK) ON gs.GeoLocationKey = g.GeoLocationKey
          INNER JOIN
        [StageUser1].STAGE_DIM_GeoLocationsToShapes_ChangedShapes s WITH (NOLOCK)
                                                           ON s.ShapeBoundary.STIntersects(g.LocationPoint) = 0; -- NOT in shape!

      CREATE INDEX IX_deleting ON #deleting(GeoLocationToShapeKey);

      SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    END;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.4 Initial Insert - changed Shape deleted points', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.4 Add to STG - changed Shape deleted points';
    END;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. Insert/Delete against DW (Load)
  --------------------------------------------------------------------
  BEGIN TRY

    INSERT INTO [MiXData].[dbo].DIM_GeoLocationsToShapes
    (
      GeoLocationKey,
      ShapeKey,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      GeoLocationKey,
      ShapeKey,
      @batchKey,
      @batchKey
    FROM
      #inserting
    SET @recordsInserted += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
    END;

    INSERT INTO [StageUser1].ROLLBACK_DIM_GeoLocationsToShapes
    (
      GeoLocationToShapeKey,
      GeoLocationKey,
      ShapeKey,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      GeoLocationToShapeKey,
      GeoLocationKey,
      ShapeKey,
      CreateBatchKey,
      UpdateBatchKey
    FROM
     (DELETE
        gs
      OUTPUT
        DELETED.GeoLocationToShapeKey,
        DELETED.GeoLocationKey,
        DELETED.ShapeKey,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
      FROM
        [MiXData].[dbo].DIM_GeoLocationsToShapes gs
          INNER JOIN
        #deleting d ON gs.GeoLocationToShapeKey = d.GeoLocationToShapeKey
     ) as RollBck
    SET @recordsDeleted = @@ROWCOUNT;

    -- removal for Removed Shapes
    INSERT INTO [StageUser1].ROLLBACK_DIM_GeoLocationsToShapes
    (
      GeoLocationToShapeKey,
      GeoLocationKey,
      ShapeKey,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      GeoLocationToShapeKey,
      GeoLocationKey,
      ShapeKey,
      CreateBatchKey,
      UpdateBatchKey
    FROM
     (DELETE
        gs
      OUTPUT
        DELETED.GeoLocationToShapeKey,
        DELETED.GeoLocationKey,
        DELETED.ShapeKey,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
      FROM
        [StageUser1].STAGE_DIM_Shapes                d
          INNER JOIN
        [MiXData].[dbo].DIM_Shapes               ds WITH (NOLOCK) ON ds.OrganisationKey = @organisationKey
                                                                    AND ds.HostID          = d.HostID
                                                                    AND d.IsDeleted        = 1
          INNER JOIN
        [MiXData].[dbo].DIM_GeoLocationsToShapes gs               ON gs.ShapeKey        = ds.ShapeKey
     ) as RollBck
    SET @recordsDeleted = @recordsDeleted + @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.2 Merge Delete Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 5. Insert/Delete against DW (Load)';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    0                     RecordsType2Inserted,
    0                     RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsDeleted;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 7. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_Organisations_Late_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_Organisations_Late_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_DIM_Organisations_Late];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_DIM_Organisations_Late];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -------------------------------
    -- Organisation
    ;WITH Latest (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser1].OrgOptions WITH (NOLOCK)
    )
	  INSERT INTO [StageUser1].[STAGE_DIM_Organisations_Late]
	  (
      DealerName      ,
      DealerTelNo
	  )
	  SELECT 
      s.sLPDealerName ,
      s.sLPDealerTelNo
	  FROM -- select * from
	    [StageUser1].OrgOptions s WITH (NOLOCK)
        INNER JOIN
      Latest l ON s.RID = l.MaxRID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Validation before Loading to DW
  --------------------------------------------------------------------
 BEGIN TRY
    -- Check 1 - Make sure there are no duplicate GuidIDs
    --IF NOT EXISTS (SELECT 1
                     --FROM [StageUser1].[STAGE_DIM_Organisations_Late])
    --BEGIN
      --RAISERROR(N'No OrgOptions available (possibly empty CompanyGUID)',16,1);
    --END

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    INSERT INTO [StageUser1].[ROLLBACK_DIM_Organisations_Late]
    (
      OrganisationKey ,
      OrganisationGUID,
      DealerName      ,
      DealerTelNo     ,
      CreateBatchKey  ,
      UpdateBatchKey
    )
    SELECT
      tar.OrganisationKey ,
      tar.OrganisationGUID,
      tar.DealerName      ,
      tar.DealerTelNo     ,
      tar.CreateBatchKey  ,
      tar.UpdateBatchKey
    FROM
      [MiXData].dbo.DIM_Organisations             AS tar
        CROSS JOIN
      [StageUser1].[STAGE_DIM_Organisations_Late] AS stg
    WHERE
      tar.OrganisationKey  = @organisationKey
    AND
      (ISNULL(tar.DealerName,'')  <> ISNULL(stg.DealerName,'')
    OR  
       ISNULL(tar.DealerTelNo,'') <> ISNULL(stg.DealerTelNo,''));

    UPDATE
      [MiXData].dbo.DIM_Organisations
    SET
      DealerName  = ISNULL(stg.DealerName, ''),
      DealerTelNo = ISNULL(stg.DealerTelNo,'')
    FROM
      [MiXData].dbo.DIM_Organisations             AS tar
        CROSS JOIN
      [StageUser1].[STAGE_DIM_Organisations_Late] AS stg
    WHERE
      tar.OrganisationKey  = @organisationKey
    AND
      (ISNULL(tar.DealerName,'')  <> ISNULL(stg.DealerName,'')
    OR  
       ISNULL(tar.DealerTelNo,'') <> ISNULL(stg.DealerTelNo,''));
    
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_DIM_Organisations_Late];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'5. Cleanup work tables';

  --------------------------------------------------------------------
  -- 6. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = 0,
         RecordsUpdated  = ISNULL(@recordsUpdated,0),
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_Passengers_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_Passengers_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey         int;
  DECLARE @UTCOffsetMinutes     smallint;
  DECLARE @minAuditDate         datetimeoffset(0);  
  DECLARE @maxAuditDate         datetimeoffset(0);
  DECLARE @startDate            datetimeoffset(0);
  DECLARE @tmpDate              datetimeoffset(0);
  DECLARE @endDate              datetimeoffset(0);
  DECLARE @startDateKey         date;
  DECLARE @endDateKey           date;
  DECLARE @previousEndDateKey   date;

  -- Default values
  DECLARE @endDateDefault       date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)
  DECLARE @startDateFirstInsert date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @defaultIdentifierValue uniqueidentifier = '00000000-0000-0000-0000-000000000000'; -- used with GUID comparison for null values

  -- Get range for which SCD should be calculated
  SELECT
    @startDate    = MIN(ChangeDate),
    @maxAuditDate = MAX(ChangeDate)
  FROM
    [StageUser1].Passengers;

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[ROLLBACK_DIM_Passengers];

  --------------------------------------------------------------------
  -- Loop through calculation a day at a time and Load to DW
  WHILE @StartDate <= @MaxAuditDate
  BEGIN

  -- get timezone infomation
  SELECT
    @UTCOffsetKey     = UTCOffsetKey,
    @UTCOffsetMinutes = UTCOffsetMinutes,
    @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
  FROM
    [StageUser1].STAGE_DIM_UTCOffsetsLookUp
  WHERE
    @startDate     BETWEEN StartDateTime       AND EndDateTime
    AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

  SET @startDateKey       = CONVERT(date, @tmpDate);

  -- get the UTC time for the start of the next day in organisation's timezone
  SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
  SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_DIM_Passengers];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

  ;WITH
  Latest (MaxRID) AS
  (
    SELECT MAX(RID)
    FROM [StageUser1].Passengers WITH (NOLOCK)
    WHERE
        ChangeDate >= @startDate
    AND ChangeDate  < @endDate
    GROUP BY iPassengerID
  )
  INSERT INTO [StageUser1].[STAGE_DIM_Passengers]
  (
    HostID,
    PassengerName,
    PassengerGUID,
    MaxRID
  )
  SELECT
    s.iPassengerID ,
    s.sName,
    s.PassengerGUID,
    l.MaxRID
  FROM
    Latest l
      INNER JOIN
    [StageUser1].Passengers s WITH (NOLOCK) ON s.RID = l.MaxRID
  WHERE
      s.ChangeDate >= @startDate
  AND s.ChangeDate  < @endDate;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------


  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck (Type 2)
  --------------------------------------------------------------------
  BEGIN TRY

    INSERT INTO [StageUser1].[ROLLBACK_DIM_Passengers]
    ( 
      [PassengerKey]   ,
      [OrganisationKey],
      [StartDateKey]   ,
      [EndDateKey]     ,
      [IsCurrentRecord],
      [HostID]         ,
      [PassengerGUID]  ,
      [PassengerName]  ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      [PassengerKey]   ,
      [OrganisationKey],
      [StartDateKey]   ,
      [EndDateKey]     ,
      [IsCurrentRecord],
      [HostID]         ,
      [PassengerGUID]  ,
      [PassengerName]  ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    FROM 
     (MERGE [MiXData].dbo.DIM_Passengers     AS tar
      USING [StageUser1].[STAGE_DIM_Passengers] AS stg
       ON  tar.OrganisationKey = @organisationKey
       AND tar.HostID          = stg.HostID

      -- Matched and DW StartDateKey = StartDate (then just update)
      WHEN MATCHED
       AND  tar.StartDateKey   = @StartDateKey
       AND  tar.EndDateKey     = @endDateDefault
       AND  (tar.PassengerName <> stg.PassengerName
        OR   tar.PassengerGUID <> stg.PassengerGUID)
      THEN
        UPDATE 
        SET
          tar.[PassengerName]  = stg.[PassengerName],
          tar.[PassengerGUID]  = stg.[PassengerGUID],
          tar.[UpdateBatchKey] = @batchKey

      -- Not Matched
      WHEN NOT MATCHED THEN
        INSERT
        (
          [OrganisationKey],
          [StartDateKey]   ,
          [EndDateKey]     ,
          [IsCurrentRecord],
          [HostID]         ,
          [PassengerGUID]  ,
          [PassengerName]  ,
          [CreateBatchKey] ,
          [UpdateBatchKey]
        )
        VALUES
        (
          @OrganisationKey     ,
          @startDateFirstInsert,
          @endDateDefault      ,
          1                    ,
          stg.[HostID]         ,
          stg.[PassengerGUID]  ,
          stg.[PassengerName]  ,
          @batchKey             ,
          @batchKey
        )
      OUTPUT 
        $action   AS Operation   , 
        DELETED.[PassengerKey]   ,
        DELETED.[OrganisationKey],
        DELETED.[StartDateKey]   ,
        DELETED.[EndDateKey]     ,
        DELETED.[IsCurrentRecord],
        DELETED.[HostID]         ,
        DELETED.[PassengerGUID]  ,
        DELETED.[PassengerName]  ,
        DELETED.[CreateBatchKey] ,
        DELETED.[UpdateBatchKey]
      ) AS RollBck              -- end merge
    WHERE
      Operation        = 'UPDATE'
    AND
      [UpdateBatchKey] < @batchKey; -- end insert

    -- Matched and DW StartDateKey < StartDate (set EndDateKey/IsCurrentRecord)    
    INSERT INTO [StageUser1].[ROLLBACK_DIM_Passengers]
    ( 
      [PassengerKey]   ,
      [OrganisationKey],
      [StartDateKey]   ,
      [EndDateKey]     ,
      [IsCurrentRecord],
      [HostID]         ,
      [PassengerGUID]  ,
      [PassengerName]  ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      [PassengerKey]   ,
      [OrganisationKey],
      [StartDateKey]   ,
      [EndDateKey]     ,
      [IsCurrentRecord],
      [HostID]         ,
      [PassengerGUID]  ,
      [PassengerName]  ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    FROM 
     (MERGE [MiXData].dbo.DIM_Passengers     AS tar
      USING [StageUser1].[STAGE_DIM_Passengers] AS stg
       ON  tar.OrganisationKey = @organisationKey
       AND tar.HostID          = stg.HostID

      WHEN MATCHED
      AND  tar.StartDateKey   < @StartDateKey
      AND  tar.EndDateKey     = @endDateDefault
      AND  (tar.PassengerName <> stg.PassengerName
       OR   tar.PassengerGUID <> stg.PassengerGUID)
      THEN 
        UPDATE
        SET
          tar.EndDateKey      = @previousEndDateKey,
          tar.IsCurrentRecord = 0,
          tar.UpdateBatchKey  = @batchKey
        
      OUTPUT 
        $action   AS Operation   ,
        DELETED.[PassengerKey]   ,
        DELETED.[OrganisationKey],
        DELETED.[StartDateKey]   ,
        DELETED.[EndDateKey]     ,
        DELETED.[IsCurrentRecord],
        DELETED.[HostID]         ,
        DELETED.[PassengerGUID]  ,
        DELETED.[PassengerName]  ,
        DELETED.[CreateBatchKey] ,
        DELETED.[UpdateBatchKey]
      ) AS RollBck              -- end merge
    WHERE
      Operation        = 'UPDATE'
    AND
      [UpdateBatchKey] < @batchKey; -- end insert

    -- Insert new Records for Type 2 changes
    INSERT INTO [MiXData].dbo.DIM_Passengers
    (
      [OrganisationKey],
      [StartDateKey]   ,
      [EndDateKey]     ,
      [IsCurrentRecord],
      [HostID]         ,
      [PassengerGUID]  ,
      [PassengerName]  ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      @OrganisationKey   ,
      @startDateKey      ,
      @endDateDefault    ,
      1                  ,
      stg.[HostID]       ,
      stg.[PassengerGUID],
      stg.[PassengerName],
      @batchKey           ,
      @batchKey
    FROM
      [MiXData].dbo.DIM_Passengers     AS tar
        INNER JOIN
      [StageUser1].[STAGE_DIM_Passengers] AS stg
        ON tar.OrganisationKey = @organisationKey
       AND tar.HostID          = stg.HostID
    WHERE
        tar.StartDateKey     < @StartDateKey
    AND tar.EndDateKey       = @previousEndDateKey
    AND (tar.[PassengerName] <> stg.[PassengerName]
     OR  tar.PassengerGUID   <> stg.PassengerGUID);

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  SELECT @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
  FROM [StageUser1].Passengers
  WHERE ChangeDate >= @endDate;
    
  END -- END WHILE

  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------


  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Update Type 1 columns on DW';

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_DIM_Passengers];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsUpdated = count(1)
  FROM
    [MiXData].dbo.DIM_Passengers WITH (NOLOCK)
  WHERE
    OrganisationKey = @organisationKey
  AND
    UpdateBatchKey  = @batchKey;

  SELECT
    @recordsInserted = count(1)
  FROM
    [MiXData].dbo.DIM_Passengers WITH (NOLOCK)
  WHERE
    OrganisationKey = @organisationKey
  AND
    CreateBatchKey = @batchKey;
  
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = (isnull(@recordsUpdated,0) - isnull(@recordsInserted,0)),  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsType2Inserted = 0,
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_ReportingGroups_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_ReportingGroups_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value     int;
  DECLARE @recordsInserted  int;
  DECLARE @recordsUpdated   int;
  DECLARE @recordsDeleted   int;

  DECLARE @driverLookupKey  int;
  DECLARE @vehicleLookupKey int;

  DECLARE @ROLLBACK_DIM_ReportingGroups TABLE 
  (
    ReportingGroupKey           int               NOT NULL PRIMARY KEY,
    OrganisationKey             int               NOT NULL,
    ReportingGroupTypeLookupKey int               NULL,
    HostID                      int               NULL,
    ReportingGroupGUID          uniqueidentifier  NULL,
    ReportingGroupName          nvarchar (510)     NULL,
    MemberGUID                  uniqueidentifier  NULL,
    ReportingGroupParentKey     int               NULL,
    CreateBatchKey              int               NULL,
    UpdateBatchKey              int               NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_DIM_ReportingGroups];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_DIM_ReportingGroups];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    SELECT
      @driverLookupKey = tcl.LookupRID
	  FROM
      [MiXData].dbo.DIM_TableColumnLookups tcl WITH (NOLOCK)
    WHERE
      tcl.LookupTable  = 'DIM_ReportingGroups'
    AND
      tcl.LookupColumn = 'ReportingGroupTypeLookupKey'
    AND
      tcl.LookupKey    = 1; -- Drivers

    SELECT
      @vehicleLookupKey = tcl.LookupRID
    FROM
      [MiXData].dbo.DIM_TableColumnLookups tcl WITH (NOLOCK)
    WHERE
      tcl.LookupTable  = 'DIM_ReportingGroups'
    AND
      tcl.LookupColumn = 'ReportingGroupTypeLookupKey'
    AND
      tcl.LookupKey    = 2; -- Vehicles

	  INSERT INTO [StageUser1].[STAGE_DIM_ReportingGroups]
	  (
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberID]                   ,
      [ReportingGroupParentKey]
	  )
	  SELECT
	    @driverLookupKey  ,
      dr.liGroupID      ,
      dr.GroupGUID      ,
      dr.sName          ,
      drg.iDriverID     ,
      0         -- default of 0 for now
	  FROM
	    [StageUser1].[DriverReporting]       dr
	      INNER JOIN
	    [StageUser1].[DriverReportingGroups] drg
	      ON dr.liGroupID = drg.liGroupID
	  WHERE
	    drg.[Operation] <> 'D';

	  INSERT INTO [StageUser1].[STAGE_DIM_ReportingGroups]
	  (
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberID]                   ,
      [ReportingGroupParentKey]
	  )
	  SELECT
	    @vehicleLookupKey  ,
      vr.liGroupID       ,
      vr.GroupGUID       ,
      vr.sName           ,
      vrg.iVehicleID     ,
      0         -- default of 0 for now
	  FROM
	    [StageUser1].[VehicleReporting]       vr
	      INNER JOIN
	    [StageUser1].[VehicleReportingGroups] vrg
	      ON vr.liGroupID = vrg.liGroupID
	  WHERE
	    vrg.[Operation] <> 'D';

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    ------------------------------------------
    -- MemberGUID (Driver)
    UPDATE
      [StageUser1].[STAGE_DIM_ReportingGroups]
    SET
      MemberGUID = s.DriverGUID
    FROM
      [StageUser1].[STAGE_DIM_ReportingGroups] stg
        INNER JOIN
      [MiXData].dbo.DIM_Drivers s WITH (NOLOCK)
        ON  s.OrganisationKey               = @organisationKey
        AND stg.MemberID                    = s.HostID
    WHERE
      stg.ReportingGroupTypeLookupKey = @driverLookupKey;

    ------------------------------------------
    -- MemberGUID (Vehicle)
    UPDATE
      [StageUser1].[STAGE_DIM_ReportingGroups]
    SET
      MemberGUID = s.VehicleGUID
    FROM
      [StageUser1].[STAGE_DIM_ReportingGroups] stg
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles s WITH (NOLOCK)
        ON  s.OrganisationKey               = @organisationKey
        AND stg.MemberID                    = s.HostID
    WHERE
      stg.ReportingGroupTypeLookupKey = @vehicleLookupKey;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5.1 MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- backup deleted records to Rollback tbl
    INSERT INTO [StageUser1].[ROLLBACK_DIM_ReportingGroups]
    ( 
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    )
    SELECT
      tar.[ReportingGroupKey]          ,
      tar.[OrganisationKey]            ,
      tar.[ReportingGroupTypeLookupKey],
      tar.[HostID]                     ,
      tar.[ReportingGroupGUID]         ,
      tar.[ReportingGroupName]         ,
      tar.[MemberGUID]                 ,
      tar.[ReportingGroupParentKey]    ,
      tar.[CreateBatchKey]             ,
      tar.[UpdateBatchKey]
    FROM
      [MiXData].dbo.DIM_ReportingGroups tar WITH (NOLOCK)
        INNER JOIN
      [MiXData].dbo.DIM_Drivers         drv WITH (NOLOCK) ON tar.OrganisationKey             = @organisationKey
                                                            AND tar.ReportingGroupTypeLookupKey = @driverLookupKey
                                                            AND drv.OrganisationKey             = tar.OrganisationKey
                                                            AND drv.DriverGUID                  = tar.MemberGUID
                                                            AND drv.IsCurrentRecord             = 1
        INNER JOIN
      [StageUser1].[DriverReportingGroups]  drg               ON drg.liGroupID = tar.HostID
                                                            AND drg.iDriverID = drv.HostID
    WHERE drg.[Operation] = 'D'
    UNION
    SELECT
      tar.[ReportingGroupKey]          ,
      tar.[OrganisationKey]            ,
      tar.[ReportingGroupTypeLookupKey],
      tar.[HostID]                     ,
      tar.[ReportingGroupGUID]         ,
      tar.[ReportingGroupName]         ,
      tar.[MemberGUID]                 ,
      tar.[ReportingGroupParentKey]    ,
      tar.[CreateBatchKey]             ,
      tar.[UpdateBatchKey]
    FROM
      [MiXData].dbo.DIM_ReportingGroups tar WITH (NOLOCK)
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles       vhc  WITH (NOLOCK) ON tar.OrganisationKey             = @organisationKey
                                                            AND tar.ReportingGroupTypeLookupKey = @vehicleLookupKey
                                                            AND vhc.OrganisationKey             = tar.OrganisationKey
                                                            AND vhc.VehicleGUID                 = tar.MemberGUID
                                                            AND vhc.IsCurrentRecord             = 1
        INNER JOIN
      [StageUser1].[VehicleReportingGroups]  vrg              ON vrg.liGroupID  = tar.HostID
                                                            AND vrg.iVehicleID = vhc.HostID
    WHERE vrg.[Operation]                 = 'D';
	  
    DELETE [MiXData].dbo.DIM_ReportingGroups
    FROM
      [MiXData].dbo.DIM_ReportingGroups tar
        INNER JOIN
      [StageUser1].[ROLLBACK_DIM_ReportingGroups] r ON tar.[ReportingGroupKey] = r.[ReportingGroupKey]
     WHERE
       tar.OrganisationKey         = @organisationKey;

    -- Add to RollBck table
    INSERT INTO [StageUser1].[ROLLBACK_DIM_ReportingGroups]
    (
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    )
    SELECT
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    FROM 
     (MERGE [MiXData].dbo.DIM_ReportingGroups     AS tar
      USING [StageUser1].[STAGE_DIM_ReportingGroups] AS stg
       ON  tar.OrganisationKey             = @organisationKey
       AND tar.ReportingGroupTypeLookupKey = stg.ReportingGroupTypeLookupKey
       AND tar.HostID                      = stg.HostID
--       AND tar.ReportingGroupGUID          = stg.ReportingGroupGUID
       AND tar.MemberGUID                  = stg.MemberGUID
      WHEN MATCHED
       AND  (tar.[ReportingGroupName]      <> stg.[ReportingGroupName]
        OR   tar.[ReportingGroupParentKey] <> stg.[ReportingGroupParentKey]
        OR   tar.ReportingGroupGUID        <> stg.ReportingGroupGUID)
      THEN
        UPDATE 
        SET tar.[ReportingGroupName]      = stg.[ReportingGroupName]     ,
            tar.[ReportingGroupParentKey] = stg.[ReportingGroupParentKey],
            tar.ReportingGroupGUID        = stg.ReportingGroupGUID,
            tar.UpdateBatchKey            = @batchKey
      -- Not Matched
      WHEN NOT MATCHED THEN
        INSERT
        ( 
          [OrganisationKey]            ,
          [ReportingGroupTypeLookupKey],
          [HostID]                     ,
          [ReportingGroupGUID]         ,
          [ReportingGroupName]         ,
          [MemberGUID]                 ,
          [ReportingGroupParentKey]    ,
          [CreateBatchKey]             ,
          [UpdateBatchKey]
        )
        VALUES
        (
          @organisationKey                 ,
          stg.[ReportingGroupTypeLookupKey],
          stg.[HostID]                     ,
          stg.[ReportingGroupGUID]         ,
          stg.[ReportingGroupName]         ,
          stg.[MemberGUID]                 ,
          stg.[ReportingGroupParentKey]    ,
          @batchKey                         ,
          @batchKey
        )
      OUTPUT 
        $action   AS Operation, 
        DELETED.[ReportingGroupKey]          ,
        DELETED.[OrganisationKey]            ,
        DELETED.[ReportingGroupTypeLookupKey],
        DELETED.[HostID]                     ,
        DELETED.[ReportingGroupGUID]         ,
        DELETED.[ReportingGroupName]         ,
        DELETED.[MemberGUID]                 ,
        DELETED.[ReportingGroupParentKey]    ,
        DELETED.[CreateBatchKey]             ,
        DELETED.[UpdateBatchKey]
      ) AS RollBck              -- end merge
    WHERE
      Operation        = 'UPDATE'; -- end insert

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5.1 MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5.2 Update Type 1 changes
  --------------------------------------------------------------------
  BEGIN TRY

    -- VehicleReportingGroup
    INSERT INTO @ROLLBACK_DIM_ReportingGroups
    (
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    )
    SELECT
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    FROM 
     (UPDATE
        tar
      SET
        [ReportingGroupName] = stg.sName,
        [ReportingGroupGUID] = stg.GroupGUID
      OUTPUT 
        DELETED.[ReportingGroupKey]          ,
        DELETED.[OrganisationKey]            ,
        DELETED.[ReportingGroupTypeLookupKey],
        DELETED.[HostID]                     ,
        DELETED.[ReportingGroupGUID]         ,
        DELETED.[ReportingGroupName]         ,
        DELETED.[MemberGUID]                 ,
        DELETED.[ReportingGroupParentKey]    ,
        DELETED.[CreateBatchKey]             ,
        DELETED.[UpdateBatchKey]
      FROM
       [StageUser1].[VehicleReporting]       stg
         INNER JOIN
       [MiXData].dbo.DIM_ReportingGroups tar ON tar.OrganisationKey             = @organisationKey
                                               AND tar.ReportingGroupTypeLookupKey = @vehicleLookupKey
                                               AND tar.HostID                      = stg.liGroupID
      WHERE
         tar.[ReportingGroupName] <> stg.sName
      OR tar.[ReportingGroupGUID] <> stg.GroupGUID) upd;
      
    SELECT @recordsUpdated = @@ROWCOUNT;
    
    INSERT INTO [StageUser1].ROLLBACK_DIM_ReportingGroups
    (
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    )
    SELECT
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    FROM
      @ROLLBACK_DIM_ReportingGroups rb
    WHERE
      NOT EXISTS (SELECT 1 
                  FROM [StageUser1].[ROLLBACK_DIM_ReportingGroups] roll
                  WHERE roll.[ReportingGroupKey] = rb.[ReportingGroupKey]);
    DELETE @ROLLBACK_DIM_ReportingGroups;

    -- DriverReportingGroup
    INSERT INTO @ROLLBACK_DIM_ReportingGroups
    (
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    )
    SELECT
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    FROM 
     (UPDATE
        tar
      SET
        [ReportingGroupName] = stg.sName,
        [ReportingGroupGUID] = stg.GroupGUID
      OUTPUT 
        DELETED.[ReportingGroupKey]          ,
        DELETED.[OrganisationKey]            ,
        DELETED.[ReportingGroupTypeLookupKey],
        DELETED.[HostID]                     ,
        DELETED.[ReportingGroupGUID]         ,
        DELETED.[ReportingGroupName]         ,
        DELETED.[MemberGUID]                 ,
        DELETED.[ReportingGroupParentKey]    ,
        DELETED.[CreateBatchKey]             ,
        DELETED.[UpdateBatchKey]
      FROM
       [StageUser1].[DriverReporting]       stg
         INNER JOIN
       [MiXData].dbo.DIM_ReportingGroups tar ON tar.OrganisationKey             = @organisationKey
                                               AND tar.ReportingGroupTypeLookupKey = @driverLookupKey
                                               AND tar.HostID                      = stg.liGroupID
      WHERE
         tar.[ReportingGroupName] <> stg.sName
      OR tar.[ReportingGroupGUID] <> stg.GroupGUID) upd;

    SELECT @recordsUpdated = ISNULL(@recordsUpdated,0) + @@ROWCOUNT;

    INSERT INTO [StageUser1].ROLLBACK_DIM_ReportingGroups
    (
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    )
    SELECT
      [ReportingGroupKey]          ,
      [OrganisationKey]            ,
      [ReportingGroupTypeLookupKey],
      [HostID]                     ,
      [ReportingGroupGUID]         ,
      [ReportingGroupName]         ,
      [MemberGUID]                 ,
      [ReportingGroupParentKey]    ,
      [CreateBatchKey]             ,
      [UpdateBatchKey]
    FROM
      @ROLLBACK_DIM_ReportingGroups rb
    WHERE
      NOT EXISTS (SELECT 1 
                  FROM [StageUser1].[ROLLBACK_DIM_ReportingGroups] roll
                  WHERE roll.[ReportingGroupKey] = rb.[ReportingGroupKey]);

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5.2 MERGE to DW (Load) and add to RollBck';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_DIM_ReportingGroups];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsInserted = count(1)
  FROM
    [MiXData].dbo.DIM_ReportingGroups WITH (NOLOCK)
  WHERE
      OrganisationKey = @organisationKey
  AND CreateBatchKey  = @batchKey;
  
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated,0),  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_Shapes_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_Shapes_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  int = 0;
  DECLARE @recordsUpdated   int = 0;
  DECLARE @recordsDeleted   int = 0;
  DECLARE @taxBusinessLookupKey  int;
  DECLARE @taxPrivateLookupKey   int;

  DECLARE @merged           table
  (
    Operation                     char (6)          NOT NULL,
    ShapeKey                      int               NOT NULL,
    OrganisationKey               int               NULL,
    HostID                        int               NULL,
    SiteKey                       int               NULL,
    ShapeType                     tinyint           NULL,
    ShapeName                     nvarchar (100)    NULL,
    ShapeBoundaryType             tinyint           NULL,
    ShapeBoundary                 geography         NULL,
    ShapeTaxTypeLookupKey         int               NULL,
    IsDeleted                     bit               NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_DIM_Shapes];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_DIM_Shapes];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    SELECT
      @taxBusinessLookupKey = tcl.LookupRID
	  FROM
      [MiXData].dbo.DIM_TableColumnLookups tcl WITH (NOLOCK)
    WHERE
        tcl.LookupTable  = 'DIM_Shapes'
    AND tcl.LookupColumn = 'ShapeTaxTypeLookupKey'
    AND tcl.LookupKey    = 1; -- Business

    SELECT
      @taxPrivateLookupKey = tcl.LookupRID
	  FROM
      [MiXData].dbo.DIM_TableColumnLookups tcl WITH (NOLOCK)
    WHERE
        tcl.LookupTable  = 'DIM_Shapes'
    AND tcl.LookupColumn = 'ShapeTaxTypeLookupKey'
    AND tcl.LookupKey    = 2; -- Private

    INSERT INTO [StageUser1].[STAGE_DIM_Shapes]
    (
      HostID,
      Operation,
      SiteHostID,
      ShapeType,
      ShapeName,
      ShapeBoundaryType,
      ShapeBoundary,
      ShapeTaxTypeLookupKey,
      IsDeleted
    )
    SELECT
      liLocationID,
      Operation,
      liSiteID,
      ucLocationType,
      sLocationName,
      ucShapeType,
      CASE ucShapeType
        WHEN 0 THEN
          dbo.fncBuildCircle(fPointLongitude, fPointLatitude, liPointRadius)
        WHEN 1 THEN
          dbo.fncBuildPolygonFromMapLocationPolygonPoints('[StageUser1]', liLocationID)
        WHEN 2 THEN
          dbo.fncBuildRectangle(fUpperLeftLongitude, fUpperLeftLatitude, fLowerRightLongitude, fLowerRightLatitude)
        WHEN 3 THEN
          dbo.fncBuildLineFromMapLocationPolygonPoints('[StageUser1]', liLocationID)
        ELSE
          NULL
      END,
      CASE ucTaxType
        WHEN 0 THEN @taxBusinessLookupKey
        WHEN 1 THEN @taxPrivateLookupKey
        ELSE -1
      END,
      CASE WHEN bDeleted IS NULL AND Operation = 'D' THEN 1 ELSE bDeleted END
    FROM
      [StageUser1].MapLocations WITH (NOLOCK)
    WHERE
       ucLocationSource = 1
    OR Operation        = 'D';

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    --------------------------------------------

    -- SiteKey
    UPDATE
      [StageUser1].[STAGE_DIM_Shapes]
    SET
      SiteKey     = ds.SiteKey
    FROM
      [StageUser1].[STAGE_DIM_Shapes] stg
      INNER JOIN [MiXData].dbo.DIM_Sites ds WITH (NOLOCK) ON ds.OrganisationKey  = @organisationKey
                                                            AND stg.SiteHostID      = ds.HostID
    WHERE
      stg.SiteHostID IS NOT NULL;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  --BEGIN TRY


    --IF @debugMode = 1  -- DebugMode is true
      --PRINT N'4. Validation before Loading to DW';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
    --EXEC [Control].sprLogError @organisationKey = @organisationKey;
    --RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    MERGE [MiXData].[dbo].DIM_Shapes tar
      USING [StageUser1].STAGE_DIM_Shapes stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostID          = stg.HostID
      WHEN MATCHED 
        AND Operation != 'D' THEN
        UPDATE SET
          tar.SiteKey               = ISNULL(stg.SiteKey,-1),
          tar.ShapeType             = stg.ShapeType,
          tar.ShapeName             = stg.ShapeName,
          tar.ShapeBoundaryType     = stg.ShapeBoundaryType,
          tar.ShapeBoundary         = stg.ShapeBoundary,
          tar.ShapeTaxTypeLookupKey = stg.ShapeTaxTypeLookupKey,
          tar.IsDeleted             = stg.IsDeleted,
          tar.UpdateBatchKey        = @batchKey
      -- Not Matched
      WHEN NOT MATCHED
        AND Operation != 'D' THEN
        INSERT
        (
          OrganisationKey,
          HostID,
          SiteKey,
          ShapeType,
          ShapeName,
          ShapeBoundaryType,
          ShapeBoundary,
          ShapeTaxTypeLookupKey,
          IsDeleted,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.HostID,
          ISNULL(stg.SiteKey,-1),
          stg.ShapeType,
          stg.ShapeName,
          stg.ShapeBoundaryType,
          stg.ShapeBoundary,
          stg.ShapeTaxTypeLookupKey,
          stg.IsDeleted,
          @batchKey,
          @batchKey
        )
      OUTPUT
        $action   AS Operation,
        ISNULL(DELETED.ShapeKey, INSERTED.ShapeKey),
        DELETED.OrganisationKey,
        DELETED.HostID,
        DELETED.SiteKey,
        DELETED.ShapeType,
        DELETED.ShapeName,
        DELETED.ShapeBoundaryType,
        DELETED.ShapeBoundary,
        DELETED.ShapeTaxTypeLookupKey,
        DELETED.IsDeleted,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
        INTO @merged;

    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merged
    WHERE
      Operation = 'INSERT';

    UPDATE
      [MiXData].[dbo].DIM_Shapes
    SET
      IsDeleted = 1
    OUTPUT
      'UPDATE' AS Operation,
      DELETED.ShapeKey,
      DELETED.OrganisationKey,
      DELETED.HostID,
      DELETED.SiteKey,
      DELETED.ShapeType,
      DELETED.ShapeName,
      DELETED.ShapeBoundaryType,
      DELETED.ShapeBoundary,
      DELETED.ShapeTaxTypeLookupKey,
      DELETED.IsDeleted,
      DELETED.CreateBatchKey,
      DELETED.UpdateBatchKey
      INTO @merged
    FROM
      [MiXData].[dbo].DIM_Shapes tar
      INNER JOIN [StageUser1].STAGE_DIM_Shapes stg ON tar.OrganisationKey = @organisationKey
                                                 AND tar.HostID          = stg.HostID
    WHERE
      stg.Operation = 'D'

    -- Add to RollBack table: 
    INSERT INTO [StageUser1].[ROLLBACK_DIM_Shapes]
    (
      ShapeKey,
      OrganisationKey,
      HostID,
      SiteKey,
      ShapeType,
      ShapeName,
      ShapeBoundaryType,
      ShapeBoundary,
      ShapeTaxTypeLookupKey,
      IsDeleted,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      ShapeKey,
      OrganisationKey,
      HostID,
      SiteKey,
      ShapeType,
      ShapeName,
      ShapeBoundaryType,
      ShapeBoundary,
      ShapeTaxTypeLookupKey,
      IsDeleted,
      CreateBatchKey,
      UpdateBatchKey
    FROM
      @merged
    WHERE
      Operation != 'INSERT';
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------

  -- do not clear STAGE_DIM_Shapes as it is needed by other transforms!

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    0                     RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_SimpleScoreCriteria_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_SimpleScoreCriteria_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey           int;
  DECLARE @UTCOffsetMinutes       smallint;
  DECLARE @maxAuditDate           datetimeoffset (0);
  DECLARE @startDate              datetimeoffset (0);
  DECLARE @tmpDate                datetimeoffset (0);
  DECLARE @endDate                datetimeoffset (0);
  DECLARE @startDateKey           date;
  DECLARE @previousEndDateKey     date;

  -- Default values
  DECLARE @startDateFirstInsert   date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @endDateDefault         date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)

  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                   nvarchar (10)     NOT NULL,
    ScoreCriteriaKey            int               NOT NULL,
    StartDateKey                date              NULL,
    EndDateKey                  date              NULL,
    IsCurrentRecord             bit               NULL,
    IsActive                    bit               NULL,
    OrganisationKey             int               NULL,
    HostID                      int               NULL,
    EventDescriptionKey         int               NULL,
    TriggerID                   int               NULL,
    ScoreDuration               float             NULL,
    ScoreSeverity               float             NULL,
    ScoreWeight                 int               NULL,
    UTCOffsetKey                int               NULL,
    CreateBatchKey              int               NULL,
    UpdateBatchKey              int               NULL
  );
  DECLARE @type2Keys table
  (
    ScoreCriteriaKey          int  NOT NULL,
    HostID                    int  NOT NULL
  );
  
  -- Get range for which SCD should be calculated
  SELECT 
    @startDate    = MIN(ChangeDate),
    @maxAuditDate = MAX(ChangeDate)
  FROM
    [StageUser1].ScoredEvents;

  TRUNCATE TABLE [StageUser1].ROLLBACK_DIM_SimpleScoreCriteria;

  -- Loop through calculation a day at a time and Load to DW
  WHILE @startDate <= @MaxAuditDate
    BEGIN
    -- get timezone infomation
      SELECT
        @UTCOffsetKey     = UTCOffsetKey,
        @UTCOffsetMinutes = UTCOffsetMinutes,
        @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
      FROM
        [StageUser1].STAGE_DIM_UTCOffsetsLookUp
      WHERE
        @startDate     BETWEEN StartDateTime       AND EndDateTime
        AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

      SET @startDateKey       = CONVERT(date, @tmpDate);
    -- get the UTC time for the start of the next day in organisation's timezone
      SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
      SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
      TRUNCATE TABLE [StageUser1].[STAGE_DIM_SimpleScoreCriteria];

      IF @debugMode = 1  -- DebugMode is true
        PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
      BEGIN TRY
        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser1].ScoredEvents WITH (NOLOCK)
          WHERE
            ChangeDate      >= @startDate
            AND ChangeDate  <  @endDate
          GROUP BY
            iEventID
        )
	      INSERT INTO [StageUser1].[STAGE_DIM_SimpleScoreCriteria]
	      (
	        HostID       ,
	        TriggerID    ,
	        ScoreDuration,
          ScoreSeverity,
          ScoreWeight  ,
          IsActive
	      )
	      SELECT
          s.iEventID        ,
          s.ucScoreTriggerID,
          s.lfScoreDuration ,
          s.lfScoreSeverity ,
          s.ucScoreWeight   ,
          IsActive = CASE
                       WHEN s.Operation = 'D' THEN
                         0
                       ELSE
                         1
                     END
	      FROM
          Latest l
            INNER JOIN
	        [StageUser1].ScoredEvents s WITH (NOLOCK) ON l.RID = s.RID;

        SET @rowcount = @@ROWCOUNT;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
      BEGIN TRY
      
        ---------------------------------
        -- EventDescriptionKey
        UPDATE
          [StageUser1].[STAGE_DIM_SimpleScoreCriteria]
        SET
          EventDescriptionKey = ded.EventDescriptionKey
        FROM
          [StageUser1].[STAGE_DIM_SimpleScoreCriteria] stg
            INNER JOIN
          [MiXData].dbo.[DIM_EventDescriptions]     ded WITH (NOLOCK)
            ON stg.HostID = ded.HostID;

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
      BEGIN TRY

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'4. Validation before Loading to DW';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck (Type 2)
  --------------------------------------------------------------------
      BEGIN TRY

        DELETE @merged;

        MERGE INTO [MiXData].[dbo].DIM_SimpleScoreCriteria tar
          USING [StageUser1].STAGE_DIM_SimpleScoreCriteria stg
             ON tar.OrganisationKey = @organisationKey
            AND tar.HostID          = stg.HostID
        -- Matched and DW IsCurrent record (then just update)
          WHEN MATCHED
            AND tar.StartDateKey = @StartDateKey
            AND tar.EndDateKey   = @endDateDefault
            THEN UPDATE
            SET
              tar.IsActive            = stg.IsActive           ,
              tar.EventDescriptionKey = stg.EventDescriptionKey,
              tar.TriggerID           = stg.TriggerID          ,
              tar.ScoreDuration       = stg.ScoreDuration      ,
              tar.ScoreSeverity       = stg.ScoreSeverity      ,
              tar.ScoreWeight         = stg.ScoreWeight        ,
              tar.UTCOffsetKey        = @UTCOffsetKey          ,
              tar.UpdateBatchKey      = @batchKey
        -- Not Matched -> insert new record into DW
          WHEN NOT MATCHED
            THEN INSERT
            (
              StartDateKey       ,
              EndDateKey         ,
              IsCurrentRecord    ,
              IsActive           ,
              OrganisationKey    ,
              HostID             ,
              EventDescriptionKey,
              TriggerID          ,
              ScoreDuration      ,
              ScoreSeverity      ,
              ScoreWeight        ,
              UTCOffsetKey       ,
              CreateBatchKey     ,
              UpdateBatchKey
            )
            VALUES
            (
              @startDateFirstInsert  ,
              @endDateDefault        ,
              1                      ,
              stg.IsActive           ,
              @organisationKey       ,
              stg.HostID             ,
              stg.EventDescriptionKey,
              stg.TriggerID          ,
              stg.ScoreDuration      ,
              stg.ScoreSeverity      ,
              stg.ScoreWeight        ,
              @UTCOffsetKey,
              @batchKey,
              @batchKey
            )
          OUTPUT
            $action   AS Operation                 ,
            ISNULL(DELETED.ScoreCriteriaKey, -1)   ,
            DELETED.StartDateKey                   ,
            DELETED.EndDateKey                     ,
            DELETED.IsCurrentRecord                ,
            DELETED.IsActive                       ,
            DELETED.OrganisationKey                ,
            ISNULL(DELETED.HostID, INSERTED.HostID),
            DELETED.EventDescriptionKey            ,
            DELETED.TriggerID                      ,
            DELETED.ScoreDuration                  ,
            DELETED.ScoreSeverity                  ,
            DELETED.ScoreWeight                    ,
            DELETED.UTCOffsetKey                   ,
            DELETED.CreateBatchKey                 ,
            DELETED.UpdateBatchKey
            INTO @merged;
        SET @rowcount = @@ROWCOUNT;
        SELECT
          @recordsInserted += COUNT(*)
        FROM
          @merged
        WHERE
          Operation = 'INSERT';

        INSERT INTO [StageUser1].ROLLBACK_DIM_SimpleScoreCriteria
        (
          ScoreCriteriaKey   ,
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          EventDescriptionKey,
          TriggerID          ,
          ScoreDuration      ,
          ScoreSeverity      ,
          ScoreWeight        ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        )
        SELECT
          ScoreCriteriaKey   ,
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          EventDescriptionKey,
          TriggerID          ,
          ScoreDuration      ,
          ScoreSeverity      ,
          ScoreWeight        ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        FROM
          @merged
        WHERE
          Operation        = 'UPDATE'
          AND UpdateBatchKey < @batchKey; -- end insert
        SET @recordsUpdated += @@ROWCOUNT;
        
       IF @debugMode = 1
          PRINT '    after merge: rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

  --------------------------------------------------------------------
      -- type 2 changes -> first expire current
        DELETE @type2Keys;
        INSERT INTO @type2Keys
        SELECT
          tar.ScoreCriteriaKey,
          tar.HostID
        FROM
          [MiXData].[dbo].DIM_SimpleScoreCriteria tar
          INNER JOIN [StageUser1].STAGE_DIM_SimpleScoreCriteria stg ON  tar.OrganisationKey = @organisationKey
                                                                   AND tar.HostID          = stg.HostID
        WHERE
          tar.StartDateKey      < @StartDateKey
          AND  tar.EndDateKey   = @endDateDefault
          AND (tar.TriggerID     <> stg.TriggerID
            OR tar.ScoreDuration <> stg.ScoreDuration
            OR tar.ScoreSeverity <> stg.ScoreSeverity
            OR tar.ScoreWeight   <> stg.ScoreWeight
            OR tar.IsActive      <> stg.IsActive
              );
        SET @rowcount = @@ROWCOUNT;

        INSERT INTO [StageUser1].ROLLBACK_DIM_SimpleScoreCriteria
        (
          ScoreCriteriaKey   ,
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          EventDescriptionKey,
          TriggerID          ,
          ScoreDuration      ,
          ScoreSeverity      ,
          ScoreWeight        ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        )
        SELECT
          ScoreCriteriaKey   ,
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          EventDescriptionKey,
          TriggerID          ,
          ScoreDuration      ,
          ScoreSeverity      ,
          ScoreWeight        ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        FROM
         (
          UPDATE
            [MiXData].[dbo].DIM_SimpleScoreCriteria
          SET
            EndDateKey      = @previousEndDateKey,
            IsCurrentRecord = 0,
            UpdateBatchKey  = @batchKey
          OUTPUT
            DELETED.ScoreCriteriaKey   ,
            DELETED.StartDateKey       ,
            DELETED.EndDateKey         ,
            DELETED.IsCurrentRecord    ,
            DELETED.IsActive           ,
            DELETED.OrganisationKey    ,
            DELETED.HostID             ,
            DELETED.EventDescriptionKey,
            DELETED.TriggerID          ,
            DELETED.ScoreDuration      ,
            DELETED.ScoreSeverity      ,
            DELETED.ScoreWeight        ,
            DELETED.UTCOffsetKey       ,
            DELETED.CreateBatchKey     ,
            DELETED.UpdateBatchKey
          FROM
            [MiXData].[dbo].DIM_SimpleScoreCriteria tar
            INNER JOIN @type2Keys k ON tar.ScoreCriteriaKey = k.ScoreCriteriaKey
          ) AS RollBck              -- end update
        WHERE
          UpdateBatchKey < @batchKey; -- end insert

        -- Insert new Records for Type 2 changes
        INSERT INTO [MiXData].[dbo].DIM_SimpleScoreCriteria
        (
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          EventDescriptionKey,
          TriggerID          ,
          ScoreDuration      ,
          ScoreSeverity      ,
          ScoreWeight        ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        )
        SELECT
          @startDateFirstInsert  ,
          @endDateDefault        ,
          1                      ,
          stg.IsActive           ,
          @organisationKey       ,
          stg.HostID             ,
          stg.EventDescriptionKey,
          stg.TriggerID          ,
          stg.ScoreDuration      ,
          stg.ScoreSeverity      ,
          stg.ScoreWeight        ,
          @UTCOffsetKey          ,
          @batchKey              ,
          @batchKey
        FROM
          [StageUser1].STAGE_DIM_SimpleScoreCriteria stg
          INNER JOIN @type2Keys k ON stg.HostID = k.HostID;
        SET @recordsType2Inserted += @@ROWCOUNT;

        IF @debugMode = 1
          PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

      SELECT
        @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
      FROM
        [StageUser1].ScoredEvents
      WHERE
        ChangeDate >= @endDate;
    
    END -- END WHILE

  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------
  BEGIN TRY
    -- only need to stage keys and type1 columns
    TRUNCATE TABLE [StageUser1].STAGE_DIM_SimpleScoreCriteria;

    ;WITH Latest (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser1].ScoredEvents WITH (NOLOCK)
      GROUP BY
        iEventID
    )
    INSERT INTO [StageUser1].STAGE_DIM_SimpleScoreCriteria
    (
      HostID,
      EventDescriptionKey
    )
    SELECT
      s.iEventID,
      ded.EventDescriptionKey
    FROM
      Latest l
      INNER JOIN [StageUser1].ScoredEvents           s   WITH (NOLOCK) ON l.MaxRID            = s.RID
      LEFT  JOIN [MiXData].dbo.DIM_EventDescriptions ded WITH (NOLOCK) ON s.iEventID          = ded.HostID
                                                                      AND ded.OrganisationKey = @organisationKey;

    INSERT INTO [StageUser1].ROLLBACK_DIM_SimpleScoreCriteria
    (
      ScoreCriteriaKey   ,
      StartDateKey       ,
      EndDateKey         ,
      IsCurrentRecord    ,
      IsActive           ,
      OrganisationKey    ,
      HostID             ,
      EventDescriptionKey,
      TriggerID          ,
      ScoreDuration      ,
      ScoreSeverity      ,
      ScoreWeight        ,
      UTCOffsetKey       ,
      CreateBatchKey     ,
      UpdateBatchKey
    )
    SELECT
      ScoreCriteriaKey   ,
      StartDateKey       ,
      EndDateKey         ,
      IsCurrentRecord    ,
      IsActive           ,
      OrganisationKey    ,
      HostID             ,
      EventDescriptionKey,
      TriggerID          ,
      ScoreDuration      ,
      ScoreSeverity      ,
      ScoreWeight        ,
      UTCOffsetKey       ,
      CreateBatchKey     ,
      UpdateBatchKey
    FROM
     (
      UPDATE
        [MiXData].[dbo].DIM_SimpleScoreCriteria
      SET
        EventDescriptionKey = stg.EventDescriptionKey
      OUTPUT
        DELETED.ScoreCriteriaKey   ,
        DELETED.StartDateKey       ,
        DELETED.EndDateKey         ,
        DELETED.IsCurrentRecord    ,
        DELETED.IsActive           ,
        DELETED.OrganisationKey    ,
        DELETED.HostID             ,
        DELETED.EventDescriptionKey,
        DELETED.TriggerID          ,
        DELETED.ScoreDuration      ,
        DELETED.ScoreSeverity      ,
        DELETED.ScoreWeight        ,
        DELETED.UTCOffsetKey       ,
        DELETED.CreateBatchKey     ,
        DELETED.UpdateBatchKey
      FROM
        [MiXData].[dbo].DIM_SimpleScoreCriteria tar
        INNER JOIN [StageUser1].STAGE_DIM_SimpleScoreCriteria stg ON tar.OrganisationKey = @organisationKey
                                                                AND tar.HostID          = stg.HostID
      WHERE
        tar.EventDescriptionKey <> stg.EventDescriptionKey
     ) rllbck
    WHERE
      UpdateBatchKey < @batchKey;
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'6. Update Type 1 columns on DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_DIM_SimpleScoreCriteria];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;
  
  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_Sites_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_Sites_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_DIM_Sites];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_DIM_Sites];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    ;WITH Latest (HostID,SiteGUID,MaxRID) AS
    (
      SELECT
        liSiteID,
        SiteGUID,
        MAX(RID)
      FROM
        [StageUser1].Sites WITH (NOLOCK)
      GROUP BY
        liSiteID,
        SiteGUID
    )
	  INSERT INTO [StageUser1].[STAGE_DIM_Sites]
	  (
	    HostID          ,
	    SiteName        ,
	    SiteGUID        ,
      MemberOfSiteGUID
	  )
	  SELECT
      s.liSiteID,
      ISNULL(s.sName,''),
      s.SiteGUID,
      s.SiteGUID
	  FROM
	    [StageUser1].Sites s WITH (NOLOCK)
        INNER JOIN
      Latest l 
        ON  s.RID      = l.MaxRID
        AND s.liSiteID = l.HostID
        AND s.SiteGUID = l.SiteGUID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY


    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF EXISTS (SELECT 1
               FROM
                 [StageUser1].[STAGE_DIM_Sites]
               WHERE
                 SiteGUID         IS NULL)
    BEGIN
      RAISERROR(N'Missing Keys (possibly no values in DIM_GUIDToKeys)',16,1);
    END
 
    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Add to RollBck table
    INSERT INTO [StageUser1].[ROLLBACK_DIM_Sites]
    ( 
      [SiteKey]              ,
      [SiteGUID]             ,
      [OrganisationKey]      ,
      [HostID]               ,
      [SiteName]             ,
      [MemberOfSiteGUID]  ,
      [CreateBatchKey]       ,
      [UpdateBatchKey]
    )
    SELECT
      [SiteKey]              ,
      [SiteGUID]             ,
      [OrganisationKey]      ,
      [HostID]               ,
      [SiteName]             ,
      [SiteGUID]             ,
      [CreateBatchKey]       ,
      [UpdateBatchKey]       
    FROM 
     (MERGE [MiXData].dbo.DIM_Sites     AS tar
      USING [StageUser1].[STAGE_DIM_Sites] AS stg
       ON  tar.OrganisationKey = @organisationKey
       AND tar.SiteGUID        = stg.SiteGUID
      WHEN MATCHED
       AND  (tar.SiteName              <> stg.SiteName
        OR   tar.[MemberOfSiteGUID] <> stg.[MemberOfSiteGUID])
      THEN
        UPDATE 
        SET tar.SiteName            = stg.SiteName,
            tar.MemberOfSiteGUID = stg.MemberOfSiteGUID,
            tar.UpdateBatchKey  = @batchKey
      -- Not Matched
      WHEN NOT MATCHED THEN
        INSERT
        ( 
          [OrganisationKey]      ,
          [HostID]               ,
          [SiteName]             ,
          [SiteGUID]             ,
          [MemberOfSiteGUID]     ,
          [CreateBatchKey]       ,
          [UpdateBatchKey]       
        )
        VALUES
        (
          @organisationKey         ,
          stg.[HostID]             ,
          stg.[SiteName]           ,
          stg.[SiteGUID]           ,
          stg.[SiteGUID]           ,
          @batchKey                 ,
          @batchKey
        )
      OUTPUT 
        $action   AS Operation, 
        DELETED.[SiteKey]              ,
        DELETED.[SiteGUID]             ,
        DELETED.[OrganisationKey]      ,
        DELETED.[HostID]               ,
        DELETED.[SiteName]             ,
        DELETED.[MemberOfSiteGUID]     ,
        DELETED.[CreateBatchKey]       ,
        DELETED.[UpdateBatchKey]       
      ) AS RollBck              -- end merge
    WHERE
      Operation        = 'UPDATE'; -- end insert

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_DIM_Sites];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT @recordsUpdated = count(1)
  FROM   [MiXData].dbo.DIM_Sites WITH (NOLOCK)
  WHERE
    OrganisationKey = @organisationKey
  AND
    UpdateBatchKey  = @batchKey;

  SELECT @recordsInserted = count(1)
  FROM   [MiXData].dbo.DIM_Sites WITH (NOLOCK)
  WHERE
    OrganisationKey = @organisationKey
  AND
    CreateBatchKey  = @batchKey;
  
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = (isnull(@recordsUpdated,0) - isnull(@recordsInserted,0)),  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_Trailers_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_Trailers_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey           int;
  DECLARE @UTCOffsetMinutes       smallint;
  DECLARE @maxAuditDate           datetimeoffset (0);
  DECLARE @startDate              datetimeoffset (0);
  DECLARE @tmpDate                datetimeoffset (0);
  DECLARE @endDate                datetimeoffset (0);
  DECLARE @startDateKey           date;
  DECLARE @previousEndDateKey     date;

  -- Default values
  DECLARE @startDateFirstInsert   date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @endDateDefault         date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)

  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                       nvarchar (10)     NOT NULL,
    TrailerKey                      int               NOT NULL,
    StartDateKey                    date              NULL,
    EndDateKey                      date              NULL,
    IsCurrentRecord                 bit               NULL,
    IsActive                        bit               NULL,
    OrganisationKey                 int               NULL,
    HostID                          int               NULL,
    TrailerGUID                     uniqueidentifier  NULL,
    TrailerAssetNumber              nvarchar (255)    NULL,
    TrailerRegNumber                nvarchar (15)     NULL,
    TrailerDescription              nvarchar (255)    NULL,
    TrailerUnitID                   int               NULL,
    SiteGUID                        uniqueidentifier  NULL,
    UnitTypeLookupKey               int               NULL,
    UTCOffsetKey                    int               NULL,
    CreateBatchKey                  int               NULL,
    UpdateBatchKey                  int               NULL
  );
  DECLARE @type2Keys table
  (
    TrailerKey          int  NOT NULL,
    HostID              int  NOT NULL
  );
  
  -- Get range for which SCD should be calculated
  SELECT 
    @startDate    = MIN(ChangeDate),
    @maxAuditDate = MAX(ChangeDate)
  FROM
    [StageUser1].Trailers;

  TRUNCATE TABLE [StageUser1].ROLLBACK_DIM_Trailers;

  -- Loop through calculation a day at a time and Load to DW
  WHILE @startDate <= @MaxAuditDate
    BEGIN
    -- get timezone infomation
      SELECT
        @UTCOffsetKey     = UTCOffsetKey,
        @UTCOffsetMinutes = UTCOffsetMinutes,
        @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
      FROM
        [StageUser1].STAGE_DIM_UTCOffsetsLookUp
      WHERE
        @startDate     BETWEEN StartDateTime       AND EndDateTime
        AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

      SET @startDateKey       = CONVERT(date, @tmpDate);
    -- get the UTC time for the start of the next day in organisation's timezone
      SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
      SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
      TRUNCATE TABLE [StageUser1].[STAGE_DIM_Trailers];

      IF @debugMode = 1  -- DebugMode is true
        PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
      BEGIN TRY
        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser1].Trailers WITH (NOLOCK)
          WHERE
            ChangeDate      >= @startDate
            AND ChangeDate  <  @endDate
          GROUP BY
            liTrailerID,
            TrailerGUID
        )
        INSERT INTO [StageUser1].[STAGE_DIM_Trailers]
        (
          HostID            ,
          TrailerGUID       ,
          TrailerAssetNumber,
          TrailerRegNumber  ,
          TrailerDescription,
          IsActive
        )
        SELECT
              s.liTrailerID ,
              s.TrailerGUID ,
              s.sAssetNumber,
              s.sRegNo      ,
              s.sDescription,
              IsActive = CASE
                           WHEN s.Operation = 'D' THEN
                             0
                           ELSE
                             1
                         END
        FROM
          Latest l
            INNER JOIN
	        [StageUser1].Trailers s WITH (NOLOCK) ON l.RID = s.RID;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'2. Add to STG';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
      BEGIN TRY

        ------------------------------------------
        -- TrailerUnitID (will need to relook at using this calculation as source tbl usage might change)
        ;WITH Latest (TrailerID,MaxDateAttached) AS
        (
          SELECT
            liTrailerID,
            MAX(dtAttached)
          FROM
            [StageUser1].TrailerUnitIDs
          GROUP BY
            liTrailerID
        )
        UPDATE
          [StageUser1].[STAGE_DIM_Trailers]
        SET
          TrailerUnitID = s.liUnitID
        FROM
          [StageUser1].[STAGE_DIM_Trailers] stg
            INNER JOIN
          [StageUser1].[TrailerUnitIDs]     s WITH (NOLOCK) ON stg.HostID   = s.liTrailerID
            INNER JOIN
          Latest                           l               ON s.liTrailerID = l.TrailerID
                                                          AND s.dtAttached  = l.MaxDateAttached;
        
        ------------------------------------------
        -- SiteGUID (Currently nothing that associates a Trailer with a site)

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'3. Update calculated columns onto STG';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
      BEGIN TRY
        IF EXISTS (SELECT 1
                   FROM
                     [StageUser1].[STAGE_DIM_Trailers]
                   WHERE
                     TrailerGUID IS NULL)
          RAISERROR(N'NULL value on TrailerGUID (check Trailer.TrailerGUID on source data)',16,1);

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'4. Validation before Loading to DW';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck (Type 2)
  --------------------------------------------------------------------
      BEGIN TRY

        DELETE @merged;

        MERGE INTO [MiXData].[dbo].DIM_Trailers tar
          USING [StageUser1].STAGE_DIM_Trailers stg
             ON tar.OrganisationKey = @organisationKey
            AND tar.HostID          = stg.HostID
        -- Matched and DW IsCurrent record (then just update)
          WHEN MATCHED
            AND tar.StartDateKey = @StartDateKey
            AND tar.EndDateKey   = @endDateDefault
            THEN UPDATE
            SET
              tar.IsActive           = stg.IsActive          ,
              tar.TrailerAssetNumber = stg.TrailerAssetNumber,
              tar.TrailerRegNumber   = stg.TrailerRegNumber  ,
              tar.TrailerDescription = stg.TrailerDescription,
              tar.TrailerUnitID      = stg.TrailerUnitID     ,
              tar.SiteGUID           = ISNULL(stg.SiteGUID          ,'00000000-0000-0000-0000-000000000000'),
              tar.UnitTypeLookupKey  = ISNULL(stg.UnitTypeLookupKey ,tar.UnitTypeLookupKey),
              tar.UTCOffsetKey       = @UTCOffsetKey         ,
              tar.UpdateBatchKey     = @batchKey
        -- Not Matched -> insert new record into DW
          WHEN NOT MATCHED
            THEN INSERT
            (
              StartDateKey       ,
              EndDateKey         ,
              IsCurrentRecord    ,
              IsActive           ,
              OrganisationKey    ,
              HostID             ,
              TrailerGUID        ,
              TrailerAssetNumber ,
              TrailerRegNumber   ,
              TrailerDescription ,
              TrailerUnitID      ,
              SiteGUID           ,
              UnitTypeLookupKey  ,
              UTCOffsetKey       ,
              CreateBatchKey     ,
              UpdateBatchKey
            )
            VALUES
            (
              @startDateFirstInsert  ,
              @endDateDefault        ,
              1                      ,
              stg.IsActive           ,
              @organisationKey       ,
              stg.HostID             ,
              stg.TrailerGUID        ,
              stg.TrailerAssetNumber ,
              stg.TrailerRegNumber   ,
              stg.TrailerDescription ,
              stg.TrailerUnitID      ,
              ISNULL(stg.SiteGUID           ,'00000000-0000-0000-0000-000000000000'),
              stg.UnitTypeLookupKey  ,
              @UTCOffsetKey          ,
              @batchKey              ,
              @batchKey
            )
          OUTPUT
            $action   AS Operation                 ,
            ISNULL(DELETED.TrailerKey, -1)         ,
            DELETED.StartDateKey                   ,
            DELETED.EndDateKey                     ,
            DELETED.IsCurrentRecord                ,
            DELETED.IsActive                       ,
            DELETED.OrganisationKey                ,
            ISNULL(DELETED.HostID, INSERTED.HostID),
            DELETED.TrailerGUID                    ,
            DELETED.TrailerAssetNumber             ,
            DELETED.TrailerRegNumber               ,
            DELETED.TrailerDescription             ,
            DELETED.TrailerUnitID                  ,
            DELETED.SiteGUID                       ,
            DELETED.UnitTypeLookupKey              ,
            DELETED.UTCOffsetKey                   ,
            DELETED.CreateBatchKey                 ,
            DELETED.UpdateBatchKey
            INTO @merged;
        SET @rowcount = @@ROWCOUNT;
        SELECT
          @recordsInserted += COUNT(*)
        FROM
          @merged
        WHERE
          Operation = 'INSERT';

        INSERT INTO [StageUser1].ROLLBACK_DIM_Trailers
        (
          TrailerKey        ,
          StartDateKey      ,
          EndDateKey        ,
          IsCurrentRecord   ,
          IsActive          ,
          OrganisationKey   ,
          HostID            ,
          TrailerGUID       ,
          TrailerAssetNumber,
          TrailerRegNumber  ,
          TrailerDescription,
          TrailerUnitID     ,
          SiteGUID          ,
          UnitTypeLookupKey ,
          UTCOffsetKey      ,
          CreateBatchKey    ,
          UpdateBatchKey
        )
        SELECT
          TrailerKey        ,
          StartDateKey      ,
          EndDateKey        ,
          IsCurrentRecord   ,
          IsActive          ,
          OrganisationKey   ,
          HostID            ,
          TrailerGUID       ,
          TrailerAssetNumber,
          TrailerRegNumber  ,
          TrailerDescription,
          TrailerUnitID     ,
          SiteGUID          ,
          UnitTypeLookupKey ,
          UTCOffsetKey      ,
          CreateBatchKey    ,
          UpdateBatchKey
        FROM
          @merged
        WHERE
          Operation        = 'UPDATE'
          AND UpdateBatchKey < @batchKey; -- end insert
        SET @recordsUpdated += @@ROWCOUNT;
        
       IF @debugMode = 1
          PRINT '    after merge: rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

  --------------------------------------------------------------------
      -- type 2 changes -> first expire current
        DELETE @type2Keys;
        INSERT INTO @type2Keys
        SELECT
          tar.TrailerKey,
          tar.HostID
        FROM
          [MiXData].[dbo].DIM_Trailers tar
          INNER JOIN [StageUser1].STAGE_DIM_Trailers stg ON tar.OrganisationKey = @organisationKey
                                                       AND tar.HostID          = stg.HostID
        WHERE
          tar.StartDateKey      < @StartDateKey
          AND  tar.EndDateKey   = @endDateDefault
          AND (tar.TrailerAssetNumber <> stg.TrailerAssetNumber
            OR tar.TrailerRegNumber   <> stg.TrailerRegNumber
            OR tar.TrailerDescription <> stg.TrailerDescription
            OR tar.TrailerUnitID      <> stg.TrailerUnitID
            OR tar.IsActive           <> stg.IsActive
            OR tar.UnitTypeLookupKey  <> ISNULL(stg.UnitTypeLookupKey,-1)
              );
        SET @rowcount = @@ROWCOUNT;

        INSERT INTO [StageUser1].ROLLBACK_DIM_Trailers
        (
          TrailerKey         ,
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          TrailerGUID        ,
          TrailerAssetNumber ,
          TrailerRegNumber   ,
          TrailerDescription ,
          TrailerUnitID      ,
          SiteGUID           ,
          UnitTypeLookupKey  ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        )
        SELECT
          TrailerKey         ,
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          TrailerGUID        ,
          TrailerAssetNumber ,
          TrailerRegNumber   ,
          TrailerDescription ,
          TrailerUnitID      ,
          SiteGUID           ,
          UnitTypeLookupKey  ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        FROM
         (
          UPDATE
            [MiXData].[dbo].DIM_Trailers
          SET
            EndDateKey      = @previousEndDateKey,
            IsCurrentRecord = 0,
            UpdateBatchKey  = @batchKey
          OUTPUT
            DELETED.TrailerKey         ,
            DELETED.StartDateKey       ,
            DELETED.EndDateKey         ,
            DELETED.IsCurrentRecord    ,
            DELETED.IsActive           ,
            DELETED.OrganisationKey    ,
            DELETED.HostID             ,
            DELETED.TrailerGUID        ,
            DELETED.TrailerAssetNumber ,
            DELETED.TrailerRegNumber   ,
            DELETED.TrailerDescription ,
            DELETED.TrailerUnitID      ,
            DELETED.SiteGUID           ,
            DELETED.UnitTypeLookupKey  ,
            DELETED.UTCOffsetKey       ,
            DELETED.CreateBatchKey     ,
            DELETED.UpdateBatchKey
          FROM
            [MiXData].[dbo].DIM_Trailers tar
            INNER JOIN @type2Keys k ON tar.TrailerKey = k.TrailerKey
          ) AS RollBck              -- end update
        WHERE
          UpdateBatchKey < @batchKey; -- end insert

        -- Insert new Records for Type 2 changes
        INSERT INTO [MiXData].[dbo].DIM_Trailers
        (
          StartDateKey       ,
          EndDateKey         ,
          IsCurrentRecord    ,
          IsActive           ,
          OrganisationKey    ,
          HostID             ,
          TrailerGUID        ,
          TrailerAssetNumber ,
          TrailerRegNumber   ,
          TrailerDescription ,
          TrailerUnitID      ,
          SiteGUID           ,
          UnitTypeLookupKey  ,
          UTCOffsetKey       ,
          CreateBatchKey     ,
          UpdateBatchKey
        )
        SELECT
          @startDateFirstInsert  ,
          @endDateDefault        ,
          1                      ,
          stg.IsActive           ,
          @organisationKey       ,
          stg.HostID             ,
          stg.TrailerGUID        ,
          stg.TrailerAssetNumber ,
          stg.TrailerRegNumber   ,
          stg.TrailerDescription ,
          stg.TrailerUnitID      ,
          ISNULL(stg.SiteGUID           ,'00000000-0000-0000-0000-000000000000'),
          ISNULL(stg.UnitTypeLookupKey  ,-1),
          @UTCOffsetKey          ,
          @batchKey              ,
          @batchKey
        FROM
          [StageUser1].STAGE_DIM_Trailers stg
          INNER JOIN @type2Keys k ON stg.HostID = k.HostID;
        SET @recordsType2Inserted += @@ROWCOUNT;

        IF @debugMode = 1
          PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

      SELECT
        @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
      FROM
        [StageUser1].ScoredEvents
      WHERE
        ChangeDate >= @endDate;
    
    END -- END WHILE

  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Update Type 1 columns on DW';

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_DIM_Trailers];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_Units_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_Units_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey           int;
  DECLARE @UTCOffsetMinutes       smallint;
  DECLARE @maxAuditDate           datetimeoffset (0);
  DECLARE @startDate              datetimeoffset (0);
  DECLARE @tmpDate                datetimeoffset (0);
  DECLARE @endDate                datetimeoffset (0);
  DECLARE @startDateKey           date;
  DECLARE @previousEndDateKey     date;

  -- Default values
  DECLARE @startDateFirstInsert   date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @endDateDefault         date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)

  -- Used for AssetTypeLookups
  DECLARE @notConnectedLookupKey  int;
  DECLARE @vehiclesLookupKey      int;
  DECLARE @trailersLookupKey      int;

  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                       nvarchar (10)     NOT NULL,
    UnitKey                         int               NOT NULL,
    StartDateKey                    date              NOT NULL,
    EndDateKey                      date              NOT NULL,
    IsCurrentRecord                 bit               NOT NULL,
    IsActive                        bit               NOT NULL,
    OrganisationKey                 int               NOT NULL,
    AssetHostID                     int               NOT NULL,
    AssetTypeLookupKey              int               NOT NULL,
    UnitSerial                      nvarchar (50)     NULL,
    AssetGUID                       uniqueidentifier  NULL,
    UnitTypeLookupKey               int               NULL,
    SiteGUID                        uniqueidentifier  NULL,
    OSVersion                       nvarchar (50)     NULL,
    FirmwareVersion                 nvarchar (50)     NULL,
    FirmwareLoadedDateKey           date              NULL,
    UTCOffsetKey                    int               NULL,
    CreateBatchKey                  int               NULL,
    UpdateBatchKey                  int               NULL
  );
  DECLARE @type2Keys table
  (
    UnitKey          int               NOT NULL,
    AssetHostID      int               NOT NULL,
    UnitSerial       nvarchar (50)     NULL
  );
  -- used to hold list of change dates of all source tables to cycle through
  DECLARE @sourceChangeDates table
  (
    ChangeDate       datetime NOT NULL
  );
  -- used to hold list of change dates of all source tables to cycle through
  DECLARE @sourceChangesRIDs table
  (
    SourceTable      char(25) NOT NULL,
    RID              int      NOT NULL
  );

  -- Get AssetTypeLookupKeys
  SELECT
    @notConnectedLookupKey = tl1.LookupRID,
    @vehiclesLookupKey     = tl2.LookupRID,
    @trailersLookupKey     = tl3.LookupRID
  FROM
    [MiXData].dbo.DIM_TableColumnLookups tl1
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tl2
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tl3
  WHERE
      tl1.LookupTable  = 'DIM_Units'
  AND tl1.LookupColumn = 'AssetTypeLookupKey'
  AND tl1.LookupKey    = 1 -- Not Connected
  AND tl2.LookupTable  = 'DIM_Units'
  AND tl2.LookupColumn = 'AssetTypeLookupKey'
  AND tl2.LookupKey    = 2 -- Vehicles
  AND tl3.LookupTable  = 'DIM_Units'
  AND tl3.LookupColumn = 'AssetTypeLookupKey'
  AND tl3.LookupKey    = 3; -- Trailers
  
  -- Get range for which SCD should be calculated
  INSERT INTO @sourceChangeDates (ChangeDate)
  SELECT DISTINCT
    ChangeDate
  FROM
    [StageUser1].Vehicles
  UNION ALL
  SELECT DISTINCT
    ChangeDate = dtAttached
  FROM
    [StageUser1].TrailerUnitIDs
  UNION ALL
  SELECT DISTINCT
    ChangeDate
  FROM
    [StageUser1].VehicleDeviceProperties
  WHERE
      liDeviceID = 0
  AND sProperty  in ('FMGUID','DriverSetVersion','DriverSetLoadDate','OSVersion');

  SELECT 
    @startDate    = MIN(ChangeDate),
    @maxAuditDate = MAX(ChangeDate)
  FROM
    @sourceChangeDates;

  TRUNCATE TABLE [StageUser1].ROLLBACK_DIM_Units;

  -- Loop through calculation a day at a time and Load to DW
  WHILE @StartDate <= @MaxAuditDate
    BEGIN
    -- get timezone infomation
      SELECT
        @UTCOffsetKey     = UTCOffsetKey,
        @UTCOffsetMinutes = UTCOffsetMinutes,
        @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
      FROM
        [StageUser1].STAGE_DIM_UTCOffsetsLookUp
      WHERE
          @startDate BETWEEN StartDateTime       AND EndDateTime
      AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

      SET @startDateKey       = CONVERT(date, @tmpDate);
    -- get the UTC time for the start of the next day in organisation's timezone
      SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
      SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
      TRUNCATE TABLE [StageUser1].[STAGE_DIM_Units];
      DELETE @sourceChangesRIDs;
      
      IF @debugMode = 1  -- DebugMode is true
        PRINT N'0. Make sure work tables are cleared for processing from ' + CONVERT(nvarchar, @startDate, 0) + ' to ' + CONVERT(nvarchar, @endDate, 0);

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
      BEGIN TRY
        
        ;WITH 
          LatestVehicles (RID) AS
            (
              SELECT
                MAX(RID)
              FROM
                [StageUser1].Vehicles WITH (NOLOCK)
              WHERE
                ChangeDate      >= @startDate
                AND ChangeDate  <  @endDate
              GROUP BY
                iVehicleID
            )
	      INSERT INTO [StageUser1].[STAGE_DIM_Units]
	      ( 
	        Operation         ,
	        AssetHostID       ,
	        AssetTypeLookupKey,
	        IsActive
	      )
	      SELECT
	        s.Operation       ,
          s.iVehicleID      ,
          @vehiclesLookupKey,
          IsActive = CASE
                       WHEN s.Operation = 'D' THEN
                         0
                       ELSE
                         1
                     END
	      FROM
          LatestVehicles       c
            INNER JOIN
	        [StageUser1].Vehicles s WITH (NOLOCK) ON c.RID = s.RID;

        ;WITH
          LatestVehicleDeviceProperties (RID) AS
            (
              SELECT
                MAX(RID)
              FROM
                [StageUser1].VehicleDeviceProperties WITH (NOLOCK)
              WHERE
                ChangeDate      >= @startDate
                AND ChangeDate  <  @endDate
                AND liDeviceID  = 0
                AND sProperty   in ('FMGUID','DriverSetVersion','DriverSetLoadDate','OSVersion')
              GROUP BY
                iVehicleID
            )
	      INSERT INTO [StageUser1].[STAGE_DIM_Units]
	      (
	        Operation         ,
	        AssetHostID       ,
	        AssetTypeLookupKey,
	        IsActive
	      )
	      SELECT
          s.Operation       ,
          s.iVehicleID      ,
          @vehiclesLookupKey,
          1
	      FROM
          LatestVehicleDeviceProperties       c
            INNER JOIN
	        [StageUser1].VehicleDeviceProperties s   WITH (NOLOCK) ON c.RID    = s.RID
	      WHERE
	        NOT EXISTS (SELECT 1
	                    FROM
	                      [StageUser1].[STAGE_DIM_Units] stg
	                    WHERE
	                      stg.AssetHostID = s.iVehicleID);

        SET @rowcount = @@ROWCOUNT;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
      BEGIN TRY


        ---------------------------------
        -- UnitSerial
        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser1].VehicleDeviceProperties WITH (NOLOCK)
          WHERE
                ChangeDate  >= @startDate
            AND ChangeDate  <  @endDate
            AND liDeviceID   = 0
            AND sProperty    = 'FMGUID'
          GROUP BY
            iVehicleID
        )
        UPDATE
          [StageUser1].[STAGE_DIM_Units]
        SET
          UnitSerial = CASE
                         WHEN s.Operation = 'D' 
                           THEN 'D'
                         ELSE
                           s.sValue
                       END
        FROM
          [StageUser1].[STAGE_DIM_Units]       stg
            INNER JOIN
          [StageUser1].VehicleDeviceProperties s  ON stg.AssetHostID = s.iVehicleID
            INNER JOIN
          Latest                               l  ON l.RID           = s.RID;

        ---------------------------------
        -- OSVersion
        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser1].VehicleDeviceProperties WITH (NOLOCK)
          WHERE
                ChangeDate  >= @startDate
            AND ChangeDate  <  @endDate
            AND liDeviceID   = 0
            AND sProperty    = 'OSVersion'
          GROUP BY
            iVehicleID
        )
        UPDATE
          [StageUser1].[STAGE_DIM_Units]
        SET
          UnitSerial = CASE
                         WHEN s.Operation = 'D' 
                           THEN 'D'
                         ELSE
                           s.sValue
                       END
        FROM
          [StageUser1].[STAGE_DIM_Units]       stg
            INNER JOIN
          [StageUser1].VehicleDeviceProperties s  ON stg.AssetHostID = s.iVehicleID
            INNER JOIN
          Latest                               l  ON l.RID           = s.RID;


        ---------------------------------
        -- FirmwareVersion
        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser1].VehicleDeviceProperties WITH (NOLOCK)
          WHERE
                ChangeDate  >= @startDate
            AND ChangeDate  <  @endDate
            AND liDeviceID   = 0
            AND sProperty    = 'DriverSetVersion'
          GROUP BY
            iVehicleID
        )
        UPDATE
          [StageUser1].[STAGE_DIM_Units]
        SET
          UnitSerial = CASE
                         WHEN s.Operation = 'D' 
                           THEN 'D'
                         ELSE
                           s.sValue
                       END
        FROM
          [StageUser1].[STAGE_DIM_Units]       stg
            INNER JOIN
          [StageUser1].VehicleDeviceProperties s  ON stg.AssetHostID = s.iVehicleID
            INNER JOIN
          Latest                               l  ON l.RID           = s.RID;


        ---------------------------------
        -- FirmwareLoadedDateKey
        ;WITH Latest (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser1].VehicleDeviceProperties WITH (NOLOCK)
          WHERE
                ChangeDate  >= @startDate
            AND ChangeDate  <  @endDate
            AND liDeviceID   = 0
            AND sProperty    = 'DriverSetLoadDate'
          GROUP BY
            iVehicleID
        )
        UPDATE
          [StageUser1].[STAGE_DIM_Units]
        SET
          UnitSerial = CASE
                         WHEN s.Operation = 'D' 
                           THEN 'D'
                         ELSE
                           s.sValue
                       END
        FROM
          [StageUser1].[STAGE_DIM_Units]       stg
            INNER JOIN
          [StageUser1].VehicleDeviceProperties s  ON stg.AssetHostID = s.iVehicleID
            INNER JOIN
          Latest                               l  ON l.RID           = s.RID;

        ---------------------------------
        -- AssetGUID/SiteGUID/UnitTypeLookupKey
        ;WITH
          Latest (RID) AS
            (
              SELECT
                MAX(RID)
              FROM
                [StageUser1].Vehicles WITH (NOLOCK)
              WHERE
                ChangeDate      >= @startDate
                AND ChangeDate  <  @endDate
              GROUP BY
                iVehicleID
            )
        UPDATE
          [StageUser1].[STAGE_DIM_Units]
        SET
          AssetGUID         = dvh.VehicleGUID,
          SiteGUID          = dvh.SiteGUID   ,
          UnitTypeLookupKey = dl.LookupRID
        FROM
          [StageUser1].[STAGE_DIM_Units]           stg
            INNER JOIN
          [StageUser1].Vehicles                    v   WITH (NOLOCK) ON stg.AssetHostID     = v.iVehicleID
            INNER JOIN
          Latest                                  l                 ON v.RID               = l.RID
            INNER JOIN
          [Control].UnitTypeLookups               utl WITH (NOLOCK) ON v.ucUnitType        = utl.UnitTypeID
            INNER JOIN
          [MiXData].dbo.DIM_TableColumnLookups dl  WITH (NOLOCK) ON dl.LookupKey        = utl.UnitTypeLookupKey
            INNER JOIN
          [MiXData].dbo.[DIM_Vehicles]         dvh WITH (NOLOCK) ON dvh.OrganisationKey = @organisationKey
                                                                   AND dvh.HostID          = stg.AssetHostID
        WHERE
            dl.LookupTable  = 'DIM_Units'
        AND dl.LookupColumn = 'UnitTypeLookupKey';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
      BEGIN TRY

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'4. Validation before Loading to DW';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck (Type 2)
  --------------------------------------------------------------------
      BEGIN TRY

        DELETE @merged;


        -- Update DW values that currently DOES have a UnitSerial (<> Not Available)
        INSERT INTO @merged
        (
          Operation            ,
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        )
        SELECT
          Operation            ,
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        FROM
          ( UPDATE
              [MiXData].[dbo].DIM_Units
            SET
              AssetHostID           = stg.AssetHostID          ,
              AssetGUID             = stg.AssetGUID            ,
              UnitTypeLookupKey     = stg.UnitTypeLookupKey    ,
              SiteGUID              = stg.SiteGUID             ,
              OSVersion             = CASE WHEN stg.OSVersion       = 'D' THEN ''              ELSE ISNULL(stg.OSVersion,'')       END,
              FirmwareVersion       = CASE WHEN stg.FirmwareVersion = 'D' THEN ''              ELSE ISNULL(stg.FirmwareVersion,'') END,
              FirmwareLoadedDateKey = ISNULL(stg.FirmwareLoadedDateKey,'00010101'),
              UTCOffsetKey          = @UTCOffsetKey            ,
              UpdateBatchKey        = @batchKey
            OUTPUT
              'UPDATE'  AS Operation       ,
              DELETED.UnitKey              ,
              DELETED.StartDateKey         ,
              DELETED.EndDateKey           ,
              DELETED.IsCurrentRecord      ,
              DELETED.IsActive             ,
              DELETED.OrganisationKey      ,
              DELETED.AssetHostID          ,
              DELETED.AssetTypeLookupKey   ,
              DELETED.UnitSerial           ,
              DELETED.AssetGUID            ,
              DELETED.UnitTypeLookupKey    ,
              DELETED.SiteGUID             ,
              DELETED.OSVersion            ,
              DELETED.FirmwareVersion      ,
              DELETED.FirmwareLoadedDateKey,
              DELETED.UTCOffsetKey         ,
              DELETED.CreateBatchKey       ,
              DELETED.UpdateBatchKey
            FROM
              [MiXData].[dbo].DIM_Units tar
                INNER JOIN
              [StageUser1].STAGE_DIM_Units  stg ON tar.OrganisationKey = @organisationKey
                                              AND tar.UnitSerial      = ISNULL(stg.UnitSerial,'Not Available')
            WHERE
                tar.StartDateKey       = @StartDateKey
            AND tar.EndDateKey         = @endDateDefault
            AND tar.UnitSerial         <> 'Not Available'
            AND tar.AssetTypeLookupKey = @vehiclesLookupKey
          ) upd; 
   
        -- Update DW values that currently does NOT have a UnitSerial (= Not Available)
        INSERT INTO @merged
        (
          Operation            ,
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        )
        SELECT
          Operation            ,
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        FROM
          ( UPDATE
              [MiXData].[dbo].DIM_Units
            SET
              UnitSerial            = CASE WHEN stg.UnitSerial      = 'D' THEN 'Not Available' ELSE ISNULL(stg.UnitSerial,'Not Available') END,
              AssetGUID             = stg.AssetGUID            ,
              UnitTypeLookupKey     = stg.UnitTypeLookupKey    ,
              SiteGUID              = stg.SiteGUID             ,
              OSVersion             = CASE WHEN stg.OSVersion       = 'D' THEN ''              ELSE ISNULL(stg.OSVersion,'')       END,
              FirmwareVersion       = CASE WHEN stg.FirmwareVersion = 'D' THEN ''              ELSE ISNULL(stg.FirmwareVersion,'') END,
              FirmwareLoadedDateKey = ISNULL(stg.FirmwareLoadedDateKey,'00010101'),
              UTCOffsetKey          = @UTCOffsetKey            ,
              UpdateBatchKey        = @batchKey
            OUTPUT
              'UPDATE'  AS Operation       ,
              DELETED.UnitKey              ,
              DELETED.StartDateKey         ,
              DELETED.EndDateKey           ,
              DELETED.IsCurrentRecord      ,
              DELETED.IsActive             ,
              DELETED.OrganisationKey      ,
              DELETED.AssetHostID          ,
              DELETED.AssetTypeLookupKey   ,
              DELETED.UnitSerial           ,
              DELETED.AssetGUID            ,
              DELETED.UnitTypeLookupKey    ,
              DELETED.SiteGUID             ,
              DELETED.OSVersion            ,
              DELETED.FirmwareVersion      ,
              DELETED.FirmwareLoadedDateKey,
              DELETED.UTCOffsetKey         ,
              DELETED.CreateBatchKey       ,
              DELETED.UpdateBatchKey
            FROM
              [MiXData].[dbo].DIM_Units tar
                INNER JOIN
              [StageUser1].STAGE_DIM_Units  stg ON tar.OrganisationKey = @organisationKey
                                              AND tar.AssetHostID     = stg.AssetHostID
            WHERE
                tar.StartDateKey       = @StartDateKey
            AND tar.EndDateKey         = @endDateDefault
            AND tar.UnitSerial         = 'Not Available'
            AND tar.AssetTypeLookupKey = @vehiclesLookupKey
            AND NOT EXISTS (SELECT 1
                            FROM
                              @merged m
                            WHERE m.AssetHostID = stg.AssetHostID)
          ) upd; 


        -- INSERT new Units
        INSERT INTO [MiXData].[dbo].DIM_Units
        (
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        )
        SELECT
          @startDateFirstInsert    ,
          @endDateDefault          ,
          1                        ,
          stg.IsActive             ,
          @organisationKey         ,
          stg.AssetHostID          ,
          stg.AssetTypeLookupKey   ,
          ISNULL(stg.UnitSerial    ,'Not Available'),
          stg.AssetGUID            ,
          stg.UnitTypeLookupKey    ,
          stg.SiteGUID             ,
          ISNULL(stg.OSVersion      ,''),
          ISNULL(stg.FirmwareVersion,''),
          ISNULL(stg.FirmwareLoadedDateKey,'00010101'),
          @UTCOffsetKey            ,
          @batchKey                ,
          @batchKey
        FROM
          [StageUser1].STAGE_DIM_Units  stg
        WHERE
          NOT EXISTS (SELECT 1
                      FROM @merged m
                      WHERE m.AssetHostID = stg.AssetHostID)
        AND
          NOT EXISTS (SELECT 1
                      FROM @merged m
                      WHERE ISNULL(m.UnitSerial,'Not Available')  = ISNULL(stg.UnitSerial,'Not Available'));

        SELECT @recordsInserted += @@ROWCOUNT;
        
        INSERT INTO [StageUser1].ROLLBACK_DIM_Units
        (
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        )
        SELECT
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          ISNULL(UnitSerial    ,'Not Available'),
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          ISNULL(OSVersion      ,''),
          ISNULL(FirmwareVersion,''),
          ISNULL(FirmwareLoadedDateKey,'00010101'),
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        FROM
          @merged
        WHERE
          Operation        = 'UPDATE'
          AND UpdateBatchKey < @batchKey; -- end insert
        SET @recordsUpdated += @@ROWCOUNT;
        
       IF @debugMode = 1
          PRINT '    after merge: rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

  --------------------------------------------------------------------
      -- type 2 changes -> first expire current
        DELETE @type2Keys;

        -- insert based on UnitSerial
        INSERT INTO @type2Keys
        SELECT
          tar.UnitKey     ,
          tar.AssetHostID ,
          tar.UnitSerial
        FROM
          [MiXData].[dbo].DIM_Units tar
            INNER JOIN
          [StageUser1].STAGE_DIM_Units stg ON tar.OrganisationKey = @organisationKey
                                         AND tar.UnitSerial      = ISNULL(stg.UnitSerial,'Not Available')
        WHERE
               tar.UnitSerial             <> 'Not Available'
          AND  tar.StartDateKey           < @StartDateKey
          AND  tar.EndDateKey             = @endDateDefault
          AND  tar.AssetTypeLookupKey     = @vehiclesLookupKey
          AND (tar.AssetHostID            <> stg.AssetHostID
            OR ISNULL(tar.AssetGUID,'')   <> ISNULL(stg.AssetGUID,'')
            OR ISNULL(tar.SiteGUID,'')    <> ISNULL(stg.SiteGUID,'')
            OR tar.OSVersion              <> ISNULL(stg.OSVersion,'')
            OR tar.FirmwareVersion        <> ISNULL(stg.FirmwareVersion,'')
            OR tar.FirmwareLoadedDateKey  <> ISNULL(stg.FirmwareLoadedDateKey,'00010101')
            OR tar.IsActive               <> stg.IsActive
              );

        SET @rowcount = @@ROWCOUNT;

        -- insert based on AssetHostID
        INSERT INTO @type2Keys
        SELECT
          tar.UnitKey     ,
          tar.AssetHostID ,
          tar.UnitSerial
        FROM
          [MiXData].[dbo].DIM_Units tar
            INNER JOIN
          [StageUser1].STAGE_DIM_Units stg ON tar.OrganisationKey = @organisationKey
                                         AND tar.AssetHostID     = stg.AssetHostID
        WHERE
               tar.UnitSerial            = 'Not Available'
          AND  tar.StartDateKey          < @StartDateKey
          AND  tar.EndDateKey            = @endDateDefault
          AND  tar.AssetTypeLookupKey    = @vehiclesLookupKey
          AND (tar.UnitSerial            <> ISNULL(stg.UnitSerial,'Not Available')
            OR ISNULL(tar.AssetGUID,'')  <> ISNULL(stg.AssetGUID,'')
            OR ISNULL(tar.SiteGUID,'')   <> ISNULL(stg.SiteGUID,'')
            OR tar.OSVersion             <> ISNULL(stg.OSVersion,'')
            OR tar.FirmwareVersion       <> ISNULL(stg.FirmwareVersion,'')
            OR tar.FirmwareLoadedDateKey <> ISNULL(stg.FirmwareLoadedDateKey,'00010101')
            OR tar.IsActive              <> stg.IsActive
              );

        SET @rowcount += @@ROWCOUNT;

        INSERT INTO [StageUser1].ROLLBACK_DIM_Units
        (
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        )
        SELECT
          UnitKey              ,
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        FROM
         (
          UPDATE
            [MiXData].[dbo].DIM_Units
          SET
            EndDateKey      = @previousEndDateKey,
            IsCurrentRecord = 0,
            UpdateBatchKey  = @batchKey
          OUTPUT
            DELETED.UnitKey              ,
            DELETED.StartDateKey         ,
            DELETED.EndDateKey           ,
            DELETED.IsCurrentRecord      ,
            DELETED.IsActive             ,
            DELETED.OrganisationKey      ,
            DELETED.AssetHostID          ,
            DELETED.AssetTypeLookupKey   ,
            DELETED.UnitSerial           ,
            DELETED.AssetGUID            ,
            DELETED.UnitTypeLookupKey    ,
            DELETED.SiteGUID             ,
            DELETED.OSVersion            ,
            DELETED.FirmwareVersion      ,
            DELETED.FirmwareLoadedDateKey,
            DELETED.UTCOffsetKey         ,
            DELETED.CreateBatchKey       ,
            DELETED.UpdateBatchKey
          FROM
            [MiXData].[dbo].DIM_Units tar
              INNER JOIN 
            @type2Keys                   k ON tar.UnitKey = k.UnitKey
          ) AS RollBck              -- end update
        WHERE
          UpdateBatchKey < @batchKey; -- end insert

        -- Insert new Records for Type 2 changes
        INSERT INTO [MiXData].[dbo].DIM_Units
        (
          StartDateKey         ,
          EndDateKey           ,
          IsCurrentRecord      ,
          IsActive             ,
          OrganisationKey      ,
          AssetHostID          ,
          AssetTypeLookupKey   ,
          UnitSerial           ,
          AssetGUID            ,
          UnitTypeLookupKey    ,
          SiteGUID             ,
          OSVersion            ,
          FirmwareVersion      ,
          FirmwareLoadedDateKey,
          UTCOffsetKey         ,
          CreateBatchKey       ,
          UpdateBatchKey
        )
        SELECT
          @startDateFirstInsert    ,
          @endDateDefault          ,
          1                        ,
          stg.IsActive             ,
          @organisationKey         ,
          stg.AssetHostID          ,
          stg.AssetTypeLookupKey   ,
          ISNULL(stg.UnitSerial    ,'Not Available'),
          stg.AssetGUID            ,
          stg.UnitTypeLookupKey    ,
          stg.SiteGUID             ,
          ISNULL(stg.OSVersion            ,''),
          ISNULL(stg.FirmwareVersion      ,''),
          ISNULL(stg.FirmwareLoadedDateKey,'00010101'),
          @UTCOffsetKey            ,
          @batchKey                ,
          @batchKey
        FROM
          [StageUser1].STAGE_DIM_Units stg
            INNER JOIN 
          @type2Keys                  k ON stg.AssetHostID = k.AssetHostID;
        SET @recordsType2Inserted += @@ROWCOUNT;

        IF @debugMode = 1
          PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

      SELECT
        @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
      FROM
        @sourceChangeDates
      WHERE
        ChangeDate >= @endDate;

    IF @debugMode = 1  -- DebugMode is true
      PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'
    
    END -- END WHILE


  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------
  BEGIN TRY


    IF @debugMode = 1  -- DebugMode is true
      PRINT N'6. Update Type 1 columns on DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_DIM_Units];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;
  
  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_UTCOffsetsLookup_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_UTCOffsetsLookup_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int = 0;
  DECLARE @recordsUpdated  int = 0;
  DECLARE @recordsDeleted  int = 0;
  DECLARE @validationCount int = 0;

  DECLARE @defaultStartDateTime datetimeoffset(0) = '19000101';
  DECLARE @defaultTime          time(0)           = '00:00:00';

  DECLARE @startDateKey              date;
  DECLARE @endDateKey                date;
  DECLARE @UTCOffsetMinutes          int;
  DECLARE @prevEndDateTime           datetimeoffset(0);
  DECLARE @seasonYear                int;
  DECLARE @DayLightStartDateTime     datetimeoffset(0);
  DECLARE @DayLightStartTime         time(0);
  DECLARE @DayLightEndDateTime       datetimeoffset(0);
  DECLARE @DayLightEndTime           time(0);
  DECLARE @adjustementUTCOffsetKey   int;
  DECLARE @standardUTCOffsetMinutes  int;
  DECLARE @standardUTCOffsetKey      int;
  DECLARE @lpDate                    datetimeoffset(0);

  DECLARE @lpAdjustmentStartDateTime datetimeoffset(0);
  DECLARE @lpAdjustmentEndDateTime   datetimeoffset(0);
  DECLARE @lpStandardStartDateTime   datetimeoffset(0);
  DECLARE @lpStandardEndDateTime     datetimeoffset(0);

  DECLARE @TmpSCD table
  (
    RID                           int identity(1,1)   NOT NULL,
    UTCOffsetKey                  int                 NOT NULL,
    AdjustmentType                nvarchar (10)       NULL,
    StartDateKey                  date                NULL,
    EndDateKey                    date                NULL,
    StartDateTime                 datetimeoffset (0)  NULL,
    EndDateTime                   datetimeoffset (0)  NULL,
    DaylightStartDateTime         datetimeoffset (0)  NULL,
    DaylightEndDateTime           datetimeoffset (0)  NULL,
    UTCOffsetMinutes              smallint            NULL,
    Processed                     bit                 NOT NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].STAGE_DIM_UTCOffsetsLookUp;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_DIM_UTCOffsetsLookup]') AND name = N'IX_STAGE_DIM_UTCOffsetsLookup')
      DROP INDEX IX_STAGE_DIM_UTCOffsetsLookup ON [StageUser1].STAGE_DIM_UTCOffsetsLookup;


    -- Get Organisations UTCOffset SCD records
    INSERT INTO @TmpSCD
    (
      UTCOffsetKey         ,
      AdjustmentType       ,
      StartDateKey         ,
      EndDateKey           ,
      DaylightStartDateTime,
      DaylightEndDateTime  ,
      UTCOffsetMinutes     ,
      Processed            
    )
    SELECT
      UTCOffsetKey  ,
      AdjustmentType,
      StartDateKey  ,
      EndDateKey    ,
      TODATETIMEOFFSET(DaylightStart,CONVERT(INT,ISNULL(UTCOffsetMinutes,0))),
      TODATETIMEOFFSET(DaylightEnd  ,CONVERT(INT,ISNULL(UTCOffsetMinutes,0))),
      UTCOffsetMinutes,
      Processed = 0
    FROM
      [MiXData].dbo.DIM_UTCOffsets
    WHERE
      OrganisationKey = @organisationKey
    ORDER BY
      StartDateKey,AdjustmentType;

    -- START Loop through SCD records (1 StartDateKey will be processed at a time)
    WHILE EXISTS (SELECT 1 FROM @TmpSCD WHERE Processed = 0)
    BEGIN

      -- get first StartDateKey to process
      SELECT @startDateKey = MIN(StartDateKey)
      FROM @TmpSCD
      WHERE Processed = 0;

      -------------------------------------
      -- get UTCOffset details

      -- Adjustment details
      SELECT
        @endDateKey              = EndDateKey,
        @UTCOffsetMinutes        = UTCOffsetMinutes,
        @DayLightStartDateTime   = DaylightStartDateTime,
        @DayLightStartTime       = CONVERT(time(0),DaylightStartDateTime),
        @DayLightEndDateTime     = DaylightEndDateTime,
        @DayLightEndTime         = CONVERT(time(0),DaylightEndDateTime),
        @adjustementUTCOffsetKey = UTCOffsetKey
      FROM @TmpSCD
      WHERE
          StartDateKey = @startDateKey
      AND AdjustmentType = 'Adjustment';
      
      -- Standard details
      SELECT
        @standardUTCOffsetMinutes = UTCOffsetMinutes,
        @standardUTCOffsetKey     = UTCOffsetKey
      FROM @TmpSCD
      WHERE
          StartDateKey = @startDateKey
      AND AdjustmentType = 'Standard';

      --  Calc PrevEndDateTime
      IF @startDateKey > '00010101'
      BEGIN
        SELECT
          @prevEndDateTime = EndDateTime
        FROM @TmpSCD
        WHERE
            EndDateKey = DATEADD(DAY,-1,@startDateKey)
        AND AdjustmentType = 'Adjustment';
      END;
  
      -- Populate StartDateTime/EndDateTime's
      UPDATE
        @TmpSCD
      SET
        StartDateTime =  CASE
                           WHEN StartDateKey = '00010101'
                             THEN '0001-01-01 00:00:00.0000000 +00:00'
                           ELSE
                             DATEADD(s,1,@prevEndDateTime)
                         END,
        EndDateTime   = CASE
                           WHEN EndDateKey = '00010101'
                             THEN '0001-01-01 00:00:00.0000000 +00:00'
                           ELSE
                             DATEADD(s,-1,DATEADD(day,1,TODATETIMEOFFSET(CONVERT(DATETIME,EndDateKey)+ ISNULL(@DayLightEndTime,@defaultTime),@UTCOffsetMinutes)))
                         END
      WHERE
        StartDateKey = @StartDateKey;


      -------------------------------------
      -- populate STAGE table


      -- if no daylight savings specified or OffsetMinutes for both are set the same, only insert standard offset
      IF ((@DayLightStartDateTime IS NULL) OR (ISNULL(@standardUTCOffsetMinutes,0) = ISNULL(@UTCOffsetMinutes,0)))
      BEGIN
        INSERT INTO [StageUser1].STAGE_DIM_UTCOffsetsLookup
        (
          UTCOffsetKey,
          OffsetYear,
          StartDateKey,
          EndDateKey,
          StartDateTime,
          EndDateTime,
          SeasonStartDateTime,
          SeasonEndDateTime,
          UTCOffsetMinutes,
          AdjustmentType
        )
        SELECT
          @standardUTCOffsetKey,
          2050,
          StartDateKey,
          EndDateKey,
          StartDateTime,
          EndDateTime,
          StartDateTime,
          EndDateTime,
          @standardUTCOffsetMinutes,
          'Standard'
        FROM
          @TmpSCD
        WHERE
          UTCOffsetKey = @adjustementUTCOffsetKey;
      END  -- end if Standard Only
      ELSE
      BEGIN  -- Adjustments Enabled
        SELECT @seasonYear = 1980;
        
        -- Loop through Seasons
        WHILE (@seasonYear < 2051)
        BEGIN
          
          -- Northern Hemisphere
          IF ((MONTH(@DayLightStartDateTime)        < MONTH(@DayLightEndDateTime))
          OR (MONTH(@DayLightStartDateTime)         = MONTH(@DayLightEndDateTime) 
          AND DAY(@DayLightStartDateTime)          <= DAY(@DayLightEndDateTime)
          AND CONVERT(TIME,@DayLightStartDateTime) <= CONVERT(TIME,@DayLightStartDateTime)))
          BEGIN
            SELECT
              @lpAdjustmentStartDateTime = DATEADD(YEAR,-(YEAR(@DayLightStartDateTime) - @seasonYear),@DayLightStartDateTime),
              @lpAdjustmentEndDateTime   = DATEADD(YEAR,-(YEAR(@DayLightEndDateTime)   - @seasonYear),@DayLightEndDateTime);
              
          END
          -- Southern Hemisphere
          ELSE
          BEGIN
            SELECT
              @lpAdjustmentStartDateTime = DATEADD(YEAR,-(YEAR(@DayLightStartDateTime) - @seasonYear+1),@DayLightStartDateTime),
              @lpAdjustmentEndDateTime   = DATEADD(YEAR,-(YEAR(@DayLightEndDateTime)   - @seasonYear),@DayLightEndDateTime);
          END;

          SELECT
            @lpStandardStartDateTime = DATEADD(s, 1,DATEADD(YEAR,-1,@lpAdjustmentEndDateTime)),
            @lpStandardEndDateTime   = DATEADD(s,-1,@lpAdjustmentStartDateTime);

          IF ((@seasonYear = 1980) AND (@lpStandardEndDateTime > @startDateKey))
          BEGIN
            INSERT INTO [StageUser1].STAGE_DIM_UTCOffsetsLookup
            (
              UTCOffsetKey,
              OffsetYear,
              StartDateKey,
              EndDateKey,
              StartDateTime,
              EndDateTime,
              SeasonStartDateTime,
              SeasonEndDateTime,
              UTCOffsetMinutes,
              AdjustmentType
            )
            SELECT
              @standardUTCOffsetKey,
              1980,
              StartDateKey,
              EndDateKey,
              StartDateTime,
              EndDateTime,
              StartDateTime,
              @lpAdjustmentEndDateTime,
              @standardUTCOffsetMinutes,
              'Standard'
            FROM
              @TmpSCD
            WHERE
              UTCOffsetKey = @adjustementUTCOffsetKey;

          END  -- end if @seasonYear = 1980
          ELSE
          BEGIN -- @seasonYear > 1980

            -- insert Standard
            INSERT INTO [StageUser1].STAGE_DIM_UTCOffsetsLookup
            (
              UTCOffsetKey,
              OffsetYear,
              StartDateKey,
              EndDateKey,
              StartDateTime,
              EndDateTime,
              SeasonStartDateTime,
              SeasonEndDateTime,
              UTCOffsetMinutes,
              AdjustmentType
            )
            SELECT
              @standardUTCOffsetKey,
              @seasonYear,
              StartDateKey,
              EndDateKey,
              StartDateTime,
              EndDateTime,

              @lpStandardStartDateTime,
              @lpStandardEndDateTime,

              @standardUTCOffsetMinutes,
              'Standard'
            FROM
              @TmpSCD
            WHERE
              UTCOffsetKey = @adjustementUTCOffsetKey;

            -- insert Adjustment
            INSERT INTO [StageUser1].STAGE_DIM_UTCOffsetsLookup
            (
              UTCOffsetKey,
              OffsetYear,
              StartDateKey,
              EndDateKey,
              StartDateTime,
              EndDateTime,
              SeasonStartDateTime,
              SeasonEndDateTime,
              UTCOffsetMinutes,
              AdjustmentType
            )
            SELECT
              @standardUTCOffsetKey,
              @seasonYear,
              StartDateKey,
              EndDateKey,
              StartDateTime,
              EndDateTime,

              @lpAdjustmentStartDateTime,
              @lpAdjustmentEndDateTime,

              @UTCOffsetMinutes,
              'Adjustment'
            FROM
              @TmpSCD
            WHERE
              UTCOffsetKey = @adjustementUTCOffsetKey;

          END; -- end if @seasonYear > 1980

          SELECT @seasonYear = @seasonYear + 1;
        END; -- end while SeasonYears Loop
      END; -- end if Adjustments Enabled


      --------------------------------------
      -- update Loop table
      UPDATE @TmpSCD
      SET Processed = 1
      WHERE StartDateKey = @startDateKey;

    END; -- end while SCD

    -----------------------------------
    -- remove out of boundary values
    DELETE [StageUser1].STAGE_DIM_UTCOffsetsLookup
    WHERE
        (SeasonStartDateTime < StartDateTime 
    AND  SeasonEndDateTime   < StartDateTime)
    OR  (SeasonStartDateTime > EndDateTime 
    AND  SeasonEndDateTime   > EndDateTime);

    -- create index
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_DIM_UTCOffsetsLookup]') AND name = N'IX_STAGE_DIM_UTCOffsetsLookup')
      CREATE NONCLUSTERED INDEX IX_STAGE_DIM_UTCOffsetsLookup
        ON [StageUser1].STAGE_DIM_UTCOffsetsLookup(StartDateTime,EndDateTime,SeasonStartDateTime,SeasonEndDateTime,StartDateKey,EndDateKey)
        INCLUDE (UTCOffsetKey,UTCOffsetMinutes);

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'2. Add to STG';

  --------------------------------------------------------------------
  -- 3. Cleanup work tables
  --------------------------------------------------------------------
  -- table gets used for lookups on all fact tables thus needs to be there till the end

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'3. Cleanup work tables'

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    -- Validation to ensure their is records populated
    SELECT
      @recordsInserted = ISNULL(COUNT(1),0)
    FROM
      [StageUser1].STAGE_DIM_UTCOffsetsLookUp WITH (NOLOCK);

    IF ISNULL(@recordsInserted,0) < 1
    BEGIN
      RAISERROR(N'No DIM_UTCOffsetsLookup values populated',16,1);
    END

    -- Validation to ensure that at least the current date returns exactly one record
    SELECT
      @validationCount = ISNULL(COUNT(1),0)
    FROM
      [StageUser1].STAGE_DIM_UTCOffsetsLookUp utc WITH (NOLOCK)
    WHERE
        SYSUTCDATETIME() BETWEEN utc.StartDateTime       AND utc.EndDateTime
    AND SYSUTCDATETIME() BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    IF ISNULL(@validationCount,0) <> 1
    BEGIN
      RAISERROR(N'Duplicate DIM_UTCOffsetsLookup values populated',16,1);
    END

    -- Validation to ensure a valid daylight savings is being setup
    SELECT
      @validationCount = ISNULL(COUNT(1),0)
    FROM
      [StageUser1].STAGE_DIM_UTCOffsetsLookUp WITH (NOLOCK)
	WHERE SeasonStartDateTime = SeasonEndDateTime;

    IF ISNULL(@validationCount,0) > 0
    BEGIN
      RAISERROR(N'Invalid Daylight Savings values in DIM_UTCOffsetsLookup populated',16,1);
    END

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW:' + convert(nvarchar(15),@organisationKey);

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT @recordsUpdated = 0;

  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = 0,  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'5. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- end proc

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_VehicleCostCategories_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_VehicleCostCategories_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_DIM_VehicleCostCategories];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_DIM_VehicleCostCategories];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create source table indexes
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser1].ExtensionProperties_DIM') AND name = N'IX_ExtensionProperties_DIM_sAppID_sProperty_liObjectType')
      CREATE NONCLUSTERED INDEX IX_ExtensionProperties_DIM_sAppID_sProperty_liObjectType
        ON [StageUser1].ExtensionProperties_DIM(sAppID,sProperty,liObjectType)
        INCLUDE (liObjectID,sValue);

    -- insert existing event groups
     ;WITH LastCosting (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser1].ExtensionProperties_DIM s WITH (NOLOCK)
          WHERE
                s.sAppID       = 'Costing'
            AND s.sProperty    = 'Name'
            AND s.liObjectType = 10000
          GROUP BY
            sAppID,
            sProperty,
            liObjectType,
            liObjectID 
          )
	  INSERT INTO [StageUser1].[STAGE_DIM_VehicleCostCategories]
	  (
	    [Operation]   ,
	    [HostID]      ,
	    [CategoryName]
	  )
	  SELECT 
	    s.Operation ,
        s.liObjectID,
        s.sValue
	  FROM
	    [StageUser1].ExtensionProperties_DIM s WITH (NOLOCK)
	    INNER JOIN LastCosting lc ON s.RID = lc.RID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -----------------------------------------
    -- CategoryNotes
    UPDATE
      [StageUser1].[STAGE_DIM_VehicleCostCategories]
    SET
      CategoryNotes = s.sValue
    FROM
      [StageUser1].[STAGE_DIM_VehicleCostCategories] stg
        INNER JOIN
	    [StageUser1].ExtensionProperties_DIM s WITH (NOLOCK) ON  stg.HostID = s.liObjectID
    WHERE
        s.sAppID       = 'Costing'
    AND s.sProperty    = 'DefMemo'
    AND s.liObjectType = 10000;

    -----------------------------------------
    -- Type
    -- ?? ToDo: look at Type description, only storing int
    UPDATE
      [StageUser1].[STAGE_DIM_VehicleCostCategories]
    SET
      Type = s.sValue
    FROM
      [StageUser1].[STAGE_DIM_VehicleCostCategories] stg
        INNER JOIN
	    [StageUser1].ExtensionProperties_DIM s WITH (NOLOCK) ON  stg.HostID = s.liObjectID
    WHERE
        s.sAppID       = 'Costing'
    AND s.sProperty    = 'Type'
    AND s.liObjectType = 10000;

    -----------------------------------------
    -- IsRecurring
    UPDATE
      [StageUser1].[STAGE_DIM_VehicleCostCategories]
    SET
      IsRecurring = CONVERT(BIT,s.sValue)
    FROM
      [StageUser1].[STAGE_DIM_VehicleCostCategories] stg
        INNER JOIN
	    [StageUser1].ExtensionProperties_DIM s WITH (NOLOCK) ON  stg.HostID = s.liObjectID
    WHERE
        s.sAppID       = 'Costing'
    AND s.sProperty    = 'Recurring'
    AND s.liObjectType = 10000;

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Add to RollBck table
    INSERT INTO [StageUser1].[ROLLBACK_DIM_VehicleCostCategories]
    ( 
      [VehicleCostCategoryKey],
      [OrganisationKey]       ,
      [HostID]                ,
      [CategoryName]          ,
      [CategoryNotes]         ,
      [Type]                  ,
      [IsRecurring]           ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    )
    SELECT
      [VehicleCostCategoryKey],
      [OrganisationKey]       ,
      [HostID]                ,
      [CategoryName]          ,
      [CategoryNotes]         ,
      [Type]                  ,
      [IsRecurring]           ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    FROM 
     (MERGE [MiXData].dbo.DIM_VehicleCostCategories     AS tar
      USING [StageUser1].[STAGE_DIM_VehicleCostCategories] AS stg
       ON  tar.OrganisationKey   = @organisationKey
       AND tar.[HostID]          = stg.[HostID]
      WHEN MATCHED
      THEN
        UPDATE 
        SET tar.[CategoryName]   =  stg.[CategoryName] ,
            tar.[CategoryNotes]  =  stg.[CategoryNotes],
            tar.[Type]           =  stg.[Type]         ,
            tar.[IsRecurring]    =  stg.[IsRecurring]  ,
            tar.[UpdateBatchKey] =  @batchKey

      -- Not Matched
      WHEN NOT MATCHED THEN
        INSERT
        ( 
          [OrganisationKey]       ,
          [HostID]                ,
          [CategoryName]          ,
          [CategoryNotes]         ,
          [Type]                  ,
          [IsRecurring]           ,
          [CreateBatchKey]        ,
          [UpdateBatchKey]
        )
        VALUES
        (
          @organisationKey   ,
          stg.[HostID]       ,
          stg.[CategoryName] ,
          stg.[CategoryNotes],
          stg.[Type]         ,
          stg.[IsRecurring]  ,
          @batchKey          ,
          @batchKey
        )
      OUTPUT 
        $action   AS Operation          ,
        DELETED.[VehicleCostCategoryKey],
        DELETED.[OrganisationKey]       ,
        DELETED.[HostID]                ,
        DELETED.[CategoryName]          ,
        DELETED.[CategoryNotes]         ,
        DELETED.[Type]                  ,
        DELETED.[IsRecurring]           ,
        DELETED.[CreateBatchKey]        ,
        DELETED.[UpdateBatchKey]
      ) AS RollBck              -- end merge
    WHERE
      Operation        = 'UPDATE'; -- end insert

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_DIM_VehicleCostCategories];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsUpdated = count(1)
  FROM
    [MiXData].dbo.DIM_VehicleCostCategories WITH (NOLOCK)
  WHERE
      OrganisationKey = @organisationKey
  AND UpdateBatchKey  = @batchKey;

  SELECT
    @recordsInserted = count(1)
  FROM
    [MiXData].dbo.DIM_VehicleCostCategories WITH (NOLOCK)
  WHERE
      OrganisationKey = @organisationKey
  AND CreateBatchKey  = @batchKey;
  
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = (isnull(@recordsUpdated,0) - isnull(@recordsInserted,0)),  -- Insert also sets the UpdateBatchKey, thus need to subtract recordsInserted
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_VehicleDeviceParameters_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_VehicleDeviceParameters_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;
  DECLARE @nrOfValidationErrors   int = 0;


  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                     nvarchar (10)       NOT NULL,
    VehicleDeviceParameterKey     int                 NOT NULL,
    OrganisationKey               int                 NOT NULL,
    VehicleGUID                   uniqueidentifier    NOT NULL,
    DeviceKey                     int                 NOT NULL,
    ParameterKey                  int                 NULL,
    IsDeviceDefault               bit                 NULL,
    IsParameterDefault            bit                 NULL,
    CalibrationType               tinyint             NULL,
    CalibrationProperties         xml                 NULL,
    CreateBatchKey                int                 NULL,
    UpdateBatchKey                int                 NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].ROLLBACK_DIM_VehicleDeviceParameters;
  TRUNCATE TABLE [StageUser1].STAGE_DIM_VehicleDeviceParameters;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared for processing'

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------


  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

  --first all the VehicleDeviceParam records:
    INSERT INTO [StageUser1].STAGE_DIM_VehicleDeviceParameters
    (
      VehicleHostID,
      DeviceHostID,
      ParameterHostID,
      IsDeviceDefault,
      IsParameterDefault,
      CalibrationType,
      CalibrationProperties
    )
    SELECT
      s.VehicleID,
      s.DeviceID,
      s.ParameterID,
      s.IsDeviceDefault,
      s.IsParameterDefault,
      s.CalibrationType,
      CASE
        WHEN Value1 IS NULL AND Value2 IS NULL THEN
          NULL
        ELSE
          '<calibration>' +
          CASE WHEN s.CalibrationType = 1 THEN -- Boolean:
            '<threshold>' + CONVERT(nvarchar, Calibration1, 0) + '</threshold><operator>' + CONVERT(nvarchar, Value1, 0) + '</operator>'
          ELSE
            ISNULL('<point1><calibration>' + CONVERT(nvarchar, s.Calibration1, 0) + '</calibration><value>' + CONVERT(nvarchar, s.Value1, 0) + '</value></point1>', '') +
            ISNULL('<point2><calibration>' + CONVERT(nvarchar, s.Calibration2, 0) + '</calibration><value>' + CONVERT(nvarchar, s.Value2, 0) + '</value></point2>', '')
          END +
          '</calibration>'
      END
    FROM
      [StageUser1].DeviceParam_VehicleDeviceParam s WITH (NOLOCK)
    SET @rowcount += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

  ------------------------------------------
  -- VehicleGUID
    UPDATE
      [StageUser1].STAGE_DIM_VehicleDeviceParameters
    SET
      VehicleGUID     = v.VehicleGUID
    FROM
      [StageUser1].STAGE_DIM_VehicleDeviceParameters stg
      INNER JOIN [MiXData].[dbo].DIM_Vehicles v WITH (NOLOCK) ON @organisationKey  = v.OrganisationKey
                                                                AND stg.VehicleHostID = v.HostID
                                                                AND v.IsCurrentRecord = 1;

  ------------------------------------------
  -- DeviceKey
    UPDATE
      [StageUser1].STAGE_DIM_VehicleDeviceParameters
    SET
      DeviceKey     = d.DeviceKey
    FROM
      [StageUser1].STAGE_DIM_VehicleDeviceParameters stg
      INNER JOIN [MiXData].[dbo].DIM_Devices d WITH (NOLOCK) ON @organisationKey = d.OrganisationKey
                                                               AND stg.DeviceHostID = d.HostID;

  ------------------------------------------
  -- ParameterKey
    UPDATE
      [StageUser1].STAGE_DIM_VehicleDeviceParameters
    SET
      ParameterKey  = p.ParameterKey
    FROM
      [StageUser1].STAGE_DIM_VehicleDeviceParameters stg
      INNER JOIN [MiXData].[dbo].DIM_CalibrationParameters p WITH (NOLOCK) ON @organisationKey    = p.OrganisationKey
                                                                             AND stg.ParameterHostID = p.HostID;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

--------------------------------------------------------------------
-- 4. Validation before Loading to DW
--------------------------------------------------------------------

  -- VehicleGUID is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser1].STAGE_DIM_VehicleDeviceParameters  
    WHERE VehicleGUID IS NULL;
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some VehicleDeviceParameters does not have associated DIM_Vehicles records available',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.1 Validation before Loading to DW (VehicleGUID is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;  

  -- DeviceKey is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser1].STAGE_DIM_VehicleDeviceParameters  
    WHERE DeviceKey IS NULL;
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some VehicleDeviceParameters does not have associated DIM_Devices records available',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.2 Validation before Loading to DW (DeviceKey is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;  

  -- Remove dirty data
  BEGIN TRY  

    DELETE
      [StageUser1].STAGE_DIM_VehicleDeviceParameters
    WHERE
       VehicleGUID IS NULL
    OR DeviceKey   IS NULL;

  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
  END CATCH;

--------------------------------------------------------------------
    -- 5. MERGE to DW (Load) and add to RollBck
--------------------------------------------------------------------

  BEGIN TRY
    MERGE INTO [MiXData].[dbo].DIM_VehicleDeviceParameters tar
      USING [StageUser1].STAGE_DIM_VehicleDeviceParameters stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.VehicleGUID     = stg.VehicleGUID
        AND tar.DeviceKey       = stg.DeviceKey
        AND tar.ParameterKey    = stg.ParameterKey
      WHEN MATCHED THEN
        UPDATE SET
          IsDeviceDefault       = stg.IsDeviceDefault,
          IsParameterDefault    = stg.IsParameterDefault,
          CalibrationType       = stg.CalibrationType,
          CalibrationProperties = stg.CalibrationProperties,
          UpdateBatchKey        = @batchKey
      WHEN NOT MATCHED THEN
        INSERT
        (
          OrganisationKey,
          VehicleGUID,
          DeviceKey,
          ParameterKey,
          IsDeviceDefault,
          IsParameterDefault,
          CalibrationType,
          CalibrationProperties,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.VehicleGUID,
          stg.DeviceKey,
          stg.ParameterKey,
          stg.IsDeviceDefault,
          stg.IsParameterDefault,
          stg.CalibrationType,
          stg.CalibrationProperties,
          @batchKey,
          @batchKey
        )
        OUTPUT
          $action   AS Operation,
          ISNULL(DELETED.VehicleDeviceParameterKey, INSERTED.VehicleDeviceParameterKey),
          ISNULL(DELETED.OrganisationKey,INSERTED.OrganisationKey),
          ISNULL(DELETED.VehicleGUID, INSERTED.VehicleGUID),
          ISNULL(DELETED.DeviceKey, INSERTED.DeviceKey),
          ISNULL(DELETED.ParameterKey, INSERTED.ParameterKey),
          ISNULL(DELETED.IsDeviceDefault, INSERTED.IsDeviceDefault),
          ISNULL(DELETED.IsParameterDefault, INSERTED.IsParameterDefault),
          ISNULL(DELETED.CalibrationType, INSERTED.CalibrationType),
          DELETED.CalibrationProperties,
          ISNULL(DELETED.CreateBatchKey,INSERTED.CreateBatchKey),
          ISNULL(DELETED.UpdateBatchKey,INSERTED.UpdateBatchKey)
        INTO
          @merged;

    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merged
    WHERE
      Operation = 'INSERT';

    -- Add to RollBck table
    INSERT INTO [StageUser1].ROLLBACK_DIM_VehicleDeviceParameters
    (
      VehicleDeviceParameterKey,
      OrganisationKey,
      VehicleGUID,
      DeviceKey,
      ParameterKey,
      IsDeviceDefault,
      IsParameterDefault,
      CalibrationType,
      CalibrationProperties,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      VehicleDeviceParameterKey,
      OrganisationKey,
      VehicleGUID,
      DeviceKey,
      ParameterKey,
      IsDeviceDefault,
      IsParameterDefault,
      CalibrationType,
      CalibrationProperties,
      CreateBatchKey,
      UpdateBatchKey
    FROM
      @merged
    WHERE
      Operation = 'UPDATE';
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5. MERGE to DW (Load) and add to RollBck';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------

  --IF @debugMode = 1  -- DebugMode is true
    --PRINT N'6. Update Type 1 columns on DW';

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].STAGE_DIM_VehicleDeviceParameters;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';

  --------------------------------------------------------------------

  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_VehicleDevices_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_VehicleDevices_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;


  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;
  DECLARE @nrOfValidationErrors   int = 0;


  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                     nvarchar (10)     NOT NULL,
    VehicleDeviceKey              int               NOT NULL,
    OrganisationKey               int               NULL,
    VehicleGUID                   uniqueidentifier  NOT NULL,
    DeviceKey                     int               NOT NULL,
    InputLine                     char (2)          NULL,
    DeviceProperties              xml               NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].ROLLBACK_DIM_VehicleDevices;
  TRUNCATE TABLE [StageUser1].STAGE_DIM_VehicleDevices;
  TRUNCATE TABLE [StageUser1].STAGE_VehicleDeviceProperties;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    ;WITH LatestVehicleDevice (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser1].VehicleDevices WITH (NOLOCK)
      GROUP BY
        iVehicleID,
        liDeviceID
    )
    INSERT INTO [StageUser1].STAGE_DIM_VehicleDevices
    (
      VehicleHostID,
      DeviceHostID,
      PowerDeviceHostID,
      RecordInterval,
      InputLine
    )
    SELECT
      s.iVehicleID,
      s.liDeviceID,
      s.liPowerDeviceID,
      s.bRecordInterval,
      CASE
        WHEN s.bIsActive = 1 AND s.sInputID IS NOT NULL THEN
          s.sInputID
        ELSE
          NULL
      END
    FROM
      [StageUser1].VehicleDevices s WITH (NOLOCK)
        INNER JOIN
      LatestVehicleDevice l ON s.RID = MaxRID;
    SET @rowcount = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

  ------------------------------------------
  -- VehicleGUID
    UPDATE
      [StageUser1].STAGE_DIM_VehicleDevices
    SET
      VehicleGUID     = v.VehicleGUID
    FROM
      [StageUser1].STAGE_DIM_VehicleDevices stg
        INNER JOIN
      [MiXData].[dbo].DIM_Vehicles v WITH (NOLOCK) ON @organisationKey  = v.OrganisationKey
                                                     AND stg.VehicleHostID = v.HostID
                                                     AND v.IsCurrentRecord = 1;

  ------------------------------------------
  -- DeviceKey
    UPDATE
      [StageUser1].STAGE_DIM_VehicleDevices
    SET
      DeviceKey     = d.DeviceKey
    FROM
      [StageUser1].STAGE_DIM_VehicleDevices stg
        INNER JOIN
      [MiXData].[dbo].DIM_Devices d WITH (NOLOCK) ON @organisationKey = d.OrganisationKey
                                                    AND stg.DeviceHostID = d.HostID;

  ------------------------------------------
  -- prepare the properties:
  
    ;WITH LatestProperties (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser1].VehicleDeviceProperties prop WITH (NOLOCK)
      GROUP BY
        iVehicleID,
        liDeviceID,
        sProperty
    )
    , CombinedIntervals (VehicleHostID, DeviceHostID, PropertyName, Operation, PropertyValue) AS
    (
      SELECT
        s.iVehicleID,
        s.liDeviceID,
        s.sProperty,
        s.Operation,
        s.sValue
      FROM
        [StageUser1].VehicleDeviceProperties s WITH (NOLOCK)
          INNER JOIN
        LatestProperties l ON s.RID = l.MaxRID
    UNION ALL
      SELECT
        stg.VehicleHostID,
        stg.DeviceHostID,
        'RecordInterval',
        '?',
        CONVERT(nvarchar(1), stg.RecordInterval)
      FROM
        [StageUser1].STAGE_DIM_VehicleDevices stg
      WHERE
        stg.InputLine != 'U0'
    UNION ALL
      SELECT
        stg.VehicleHostID,
        stg.DeviceHostID,
        'PowerDeviceKey',
        '?',
        CONVERT(nvarchar, d.DeviceKey)
      FROM
        [StageUser1].STAGE_DIM_VehicleDevices stg
          INNER JOIN
        [MiXData].[dbo].DIM_Devices d WITH (NOLOCK) ON @organisationKey      = d.OrganisationKey
                                                      AND stg.PowerDeviceHostID = d.HostID
    )
    INSERT INTO [StageUser1].STAGE_VehicleDeviceProperties
    (
      VehicleHostID,
      DeviceHostID,
      PropertyName,
      Operation,
      PropertyValue
    )
    SELECT
      VehicleHostID,
      DeviceHostID,
      PropertyName,
      Operation,
      PropertyValue
    FROM
      CombinedIntervals;

  -- ensure that there is a staged VehicleDevice record for each Property changed
    IF EXISTS ( SELECT *
                FROM
                  [StageUser1].STAGE_VehicleDeviceProperties p
                    LEFT JOIN
                  [StageUser1].STAGE_DIM_VehicleDevices d ON p.VehicleHostID = d.VehicleHostID
                                                        AND p.DeviceHostID  = d.DeviceHostID
                WHERE
                  d.VehicleHostID IS NULL)
      BEGIN
        WITH missingVehicleDevices (VehicleHostID, DeviceHostID) AS
        (
          SELECT DISTINCT
            p.VehicleHostID,
            p.DeviceHostID
          FROM
            [StageUser1].STAGE_VehicleDeviceProperties p
              LEFT JOIN
            [StageUser1].STAGE_DIM_VehicleDevices d ON p.VehicleHostID = d.VehicleHostID
                                                  AND p.DeviceHostID  = d.DeviceHostID
          WHERE
            d.VehicleHostID IS NULL
        )
        INSERT INTO [StageUser1].STAGE_DIM_VehicleDevices
        (
          VehicleHostID,
          DeviceHostID,
          VehicleGUID,
          DeviceKey,
          InputLine,
          DeviceProperties
        )
        SELECT
          v.HostID,
          d.HostID,
          v.VehicleGUID,
          d.DeviceKey,
          vd.InputLine,
          vd.DeviceProperties
        FROM
          [MiXData].[dbo].DIM_VehicleDevices vd WITH (NOLOCK)
            INNER JOIN
          [MiXData].[dbo].DIM_Vehicles v  WITH (NOLOCK) ON @organisationKey  = v.OrganisationKey
                                                          AND vd.VehicleGUID    = v.VehicleGUID
                                                          AND v.IsCurrentRecord = 1
            INNER JOIN
          [MiXData].[dbo].DIM_Devices d   WITH (NOLOCK) ON @organisationKey  = d.OrganisationKey
                                                          AND vd.DeviceKey      = d.DeviceKey
            INNER JOIN
          missingVehicleDevices m                          ON v.HostID          = m.VehicleHostID
                                                          AND d.HostID          = m.DeviceHostID;
      END;

  -- update the XML property bag:
    UPDATE
      [StageUser1].STAGE_DIM_VehicleDevices
    SET
      DeviceProperties = dbo.fncTransformVehicleDeviceProperties('[StageUser1]', stg.VehicleHostID, stg.DeviceHostID, vd.DeviceProperties)
    FROM
      [StageUser1].STAGE_DIM_VehicleDevices stg
        LEFT JOIN
      [MiXData].[dbo].DIM_VehicleDevices vd ON @organisationKey = vd.OrganisationKey
                                              AND stg.VehicleGUID  = vd.VehicleGUID
                                              AND stg.DeviceKey    = vd.DeviceKey;

  ------------------------------------------

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

--------------------------------------------------------------------
-- 4. Validation before Loading to DW
--------------------------------------------------------------------

  -- VehicleGUID is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser1].STAGE_DIM_VehicleDevices  
    WHERE VehicleGUID IS NULL;
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some VehicleDevices does not have associated DIM_Vehicles records available',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.1 Validation before Loading to DW (VehicleGUID is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;  

  -- DeviceKey is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser1].STAGE_DIM_VehicleDevices  
    WHERE DeviceKey IS NULL;
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some VehicleDevices does not have associated DIM_Devices records available',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.2 Validation before Loading to DW (DeviceKey is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;  

  -- Remove dirty data
  BEGIN TRY  

    DELETE
      [StageUser1].STAGE_DIM_VehicleDevices
    WHERE
       VehicleGUID IS NULL
    OR DeviceKey IS NULL;

  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
  END CATCH;  

--------------------------------------------------------------------
-- 5. MERGE to DW (Load, update) and add to RollBck
--------------------------------------------------------------------
  BEGIN TRY

    DELETE @merged;

    MERGE [MiXData].[dbo].DIM_VehicleDevices tar
      USING [StageUser1].STAGE_DIM_VehicleDevices stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.VehicleGUID     = stg.VehicleGUID
        AND tar.DeviceKey       = stg.DeviceKey
      WHEN MATCHED
        THEN UPDATE SET
          tar.InputLine         = stg.InputLine,
          tar.DeviceProperties  = stg.DeviceProperties,
          tar.UpdateBatchKey    = @batchKey
      WHEN NOT MATCHED THEN
        INSERT
        (
          OrganisationKey,
          VehicleGUID,
          DeviceKey,
          InputLine,
          DeviceProperties,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.VehicleGUID,
          stg.DeviceKey,
          stg.InputLine,
          stg.DeviceProperties,
          @batchKey,
          @batchKey
        )
      OUTPUT
        $action   AS Operation,
        ISNULL(DELETED.VehicleDeviceKey,  INSERTED.VehicleDeviceKey),
        DELETED.OrganisationKey,
        ISNULL(DELETED.VehicleGUID,       INSERTED.VehicleGUID),
        ISNULL(DELETED.DeviceKey,         INSERTED.DeviceKey),
        DELETED.InputLine,
        DELETED.DeviceProperties,
        DELETED.CreateBatchKey,
        DELETED.UpdateBatchKey
      INTO
        @merged;
    SET @rowcount = @@ROWCOUNT;
    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merged
    WHERE
      Operation = 'INSERT'

    INSERT INTO [StageUser1].ROLLBACK_DIM_VehicleDevices
    (
      VehicleDeviceKey,
      OrganisationKey,
      VehicleGUID,
      DeviceKey,
      InputLine,
      DeviceProperties,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      VehicleDeviceKey,
      OrganisationKey,
      VehicleGUID,
      DeviceKey,
      InputLine,
      DeviceProperties,
      CreateBatchKey,
      UpdateBatchKey
    FROM
      @merged
    WHERE
      Operation = 'UPDATE'
      AND UpdateBatchKey < @batchKey;
    SET @recordsUpdated += @@ROWCOUNT;

   IF @debugMode = 1
      PRINT N'5. MERGE to DW (Load) and add to RollBck';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    BEGIN
      TRUNCATE TABLE [StageUser1].STAGE_DIM_VehicleDevices;
      TRUNCATE TABLE [StageUser1].STAGE_VehicleDeviceProperties;
    END;
  ELSE
    BEGIN  -- DebugMode is true
      PRINT N'7. Cleanup work tables';
    END;

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_VehicleEventDefinitions_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_VehicleEventDefinitions_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;
  DECLARE @nrOfrecordsAffected    int = 0;
  DECLARE @nrOfValidationErrors   int = 0;


  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                     nvarchar (10)     NOT NULL,
    VehicleEventKey               int               NOT NULL,
    OrganisationKey               int               NULL,
    VehicleGUID                   uniqueidentifier  NOT NULL,
    EventDescriptionKey           int               NOT NULL,
    
    EventType                     tinyint           NULL,
    InUse                         bit               NULL,
    RecordStartOdometer           bit               NULL,
    RecordStartPosition           bit               NULL,
    RecordEndOdometer             bit               NULL,
    RecordEndPosition             bit               NULL,
    RecordPulseCount              bit               NULL,
    SendActivePosition            bit               NULL,
    StartRecordDelay              smallint          NULL,
    StartAlarmDelay               smallint          NULL,
    StartExternalRelay1Delay      smallint          NULL,
    StartExternalRelay2Delay      smallint          NULL,
    StartCriticalDisplayDelay     smallint          NULL,
    ActiveSendDelay               smallint          NULL,
    ActiveEndSendDelay            smallint          NULL,
    StartActiveTrackDelay         smallint          NULL,
    ActiveTrackInterval           smallint          NULL,
    AlarmState                    tinyint           NULL,
    ExternalRelay1State           tinyint           NULL,
    ExternalRelay2State           tinyint           NULL,
    WarningMessage                nvarchar (255)    NULL,
    ActiveMessagePriority         tinyint           NULL,
    EventTriggerDefinition        xml               NULL,

    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------

  TRUNCATE TABLE [StageUser1].ROLLBACK_DIM_VehicleEventDefinitions;
  TRUNCATE TABLE [StageUser1].STAGE_DIM_VehicleEventDefinitions;
  TRUNCATE TABLE [StageUser1].STAGE_VehicleTriggers;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_DIM_VehicleEventDefinitions]') AND name = N'IX_STAGE_DIM_VehicleEventDefinitions_VehicleHostID_EventHostID')
      DROP INDEX IX_STAGE_DIM_VehicleEventDefinitions_VehicleHostID_EventHostID ON [StageUser1].STAGE_DIM_VehicleEventDefinitions;

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_DIM_VehicleEventDefinitions]') AND name = N'IX_STAGE_DIM_VehicleEventDefinitions_VehicleGUID_EventDescriptionKey')
      DROP INDEX IX_STAGE_DIM_VehicleEventDefinitions_VehicleGUID_EventDescriptionKey ON [StageUser1].STAGE_DIM_VehicleEventDefinitions;

    ;WITH LatestVehicleEvents (MaxRID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser1].VehicleEvent WITH (NOLOCK)
      GROUP BY
        iVehicleID,
        iEventID
    )
    INSERT INTO [StageUser1].STAGE_DIM_VehicleEventDefinitions
    (
      VehicleHostID,
      EventHostID,
      EventType,
      InUse,
      RecordStartOdometer,
      RecordStartPosition,
      RecordEndOdometer,
      RecordEndPosition,
      RecordPulseCount,
      SendActivePosition,
      StartRecordDelay,
      StartAlarmDelay,
      StartExternalRelay1Delay,
      StartExternalRelay2Delay,
      StartCriticalDisplayDelay,
      ActiveSendDelay,
      ActiveEndSendDelay,
      StartActiveTrackDelay,
      ActiveTrackInterval,
      AlarmState,
      ExternalRelay1State,
      ExternalRelay2State,
      WarningMessage,
      ActiveMessagePriority
    )
    SELECT
      s.iVehicleID,
      s.iEventID,
      s.ucEventType,
      s.bInUse,
      s.bStartOdo,
      s.bStartPosition,
      s.bEndOdo,
      s.bEndPosition,
      s.bRecordF3Count,
      s.bActivePosition,
      s.iRecordTime,
      s.iAlarmTime,
      s.iRelayTime,
      s.iRelay2Time,
      s.iCriticalTime,
      s.iActiveTime,
      s.iActiveEndTime,
      s.iTrackTime,
      s.iTrackInterval,
      s.ucAlarmState,
      s.ucRelayState,
      s.ucRelay2State,
      CASE s.bWarningMessage WHEN 0 THEN NULL ELSE s.sWarningMessage END,
      s.ucPriority
    FROM
      [StageUser1].VehicleEvent s WITH (NOLOCK)
        INNER JOIN
      LatestVehicleEvents l ON s.RID = MaxRID;
    SET @rowcount = @@ROWCOUNT;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

  -- create indexes required for lookups
  CREATE NONCLUSTERED INDEX IX_STAGE_DIM_VehicleEventDefinitions_VehicleHostID_EventHostID
    ON [StageUser1].STAGE_DIM_VehicleEventDefinitions(VehicleHostID,EventHostID);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
  END;

  ------------------------------------------
  -- VehicleGUID
    UPDATE
      [StageUser1].STAGE_DIM_VehicleEventDefinitions
    SET
      VehicleGUID     = v.VehicleGUID
    FROM
      [StageUser1].STAGE_DIM_VehicleEventDefinitions stg
        INNER JOIN
      [MiXData].[dbo].DIM_Vehicles v WITH (NOLOCK) ON @organisationKey  = v.OrganisationKey
                                                     AND stg.VehicleHostID = v.HostID
                                                     AND v.IsCurrentRecord = 1;

  ------------------------------------------
  -- EventDescriptionKey
    UPDATE
      [StageUser1].STAGE_DIM_VehicleEventDefinitions
    SET
      EventDescriptionKey     = d.EventDescriptionKey
    FROM
      [StageUser1].STAGE_DIM_VehicleEventDefinitions stg
        INNER JOIN
      [MiXData].[dbo].DIM_EventDescriptions d WITH (NOLOCK) ON @organisationKey = d.OrganisationKey
                                                              AND stg.EventHostID  = d.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update Keys', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

  ------------------------------------------

  IF NOT EXISTS(SELECT *
                FROM sys.indexes 
                WHERE object_id = OBJECT_ID(N'[StageUser1].[GroupTriggers_VehicleTriggers]') AND name = N'IX_GroupTriggers_VehicleTriggers_iParameterID')
    CREATE INDEX IX_GroupTriggers_VehicleTriggers_iParameterID
      ON [StageUser1].GroupTriggers_VehicleTriggers(iParameterID)
      INCLUDE
      (iVehicleID,iEventID,ucTriggerID,Operation,ucSeq,ucOperator,lfValue,bRequired,ucTOper);

  -- VehicleTriggers:
   -- a: prepare Staged triggers:
    INSERT INTO [StageUser1].STAGE_VehicleTriggers
          (VehicleHostID,  EventHostID,  TriggerID,       Operation,     Sequence,  ParameterKey,   Operator,       ThresholdValue, Required,      JoinOperator)
    SELECT stg.iVehicleID, stg.iEventID, stg.ucTriggerID, stg.Operation, stg.ucSeq, p.ParameterKey, stg.ucOperator, stg.lfValue,    stg.bRequired, stg.ucTOper
    FROM
      [StageUser1].GroupTriggers_VehicleTriggers stg
        INNER JOIN
      [MiXData].[dbo].DIM_CalibrationParameters p WITH (NOLOCK) ON @organisationKey = p.OrganisationKey
                                                                  AND stg.iParameterID = p.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3.a Update VehicleTriggers - prepare Staged triggers', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

   DROP INDEX IX_GroupTriggers_VehicleTriggers_iParameterID ON [StageUser1].GroupTriggers_VehicleTriggers;

   -- b: cater for Trigger only change:
    IF EXISTS ( SELECT *
                FROM
                  [StageUser1].STAGE_VehicleTriggers vt
                    LEFT JOIN
                  [StageUser1].STAGE_DIM_VehicleEventDefinitions ve ON vt.VehicleHostID = ve.VehicleHostID
                                                                  AND vt.EventHostID   = ve.EventHostID
                WHERE
                  ve.VehicleHostID IS NULL)
      BEGIN
        WITH missingVehicleEvents(VehicleHostID, EventHostID) AS
        (
          SELECT DISTINCT
            vt.VehicleHostID,
            vt.EventHostID
          FROM
            [StageUser1].STAGE_VehicleTriggers vt
              LEFT JOIN
            [StageUser1].STAGE_DIM_VehicleEventDefinitions ve ON vt.VehicleHostID = ve.VehicleHostID
                                                            AND vt.EventHostID   = ve.EventHostID
          WHERE
            ve.VehicleHostID IS NULL
        )
        INSERT INTO [StageUser1].STAGE_DIM_VehicleEventDefinitions
        (
          VehicleHostID,
          EventHostID,
          VehicleGUID,
          EventDescriptionKey,
          EventType,
          InUse,
          RecordStartOdometer,
          RecordStartPosition,
          RecordEndOdometer,
          RecordEndPosition,
          RecordPulseCount,
          SendActivePosition,
          StartRecordDelay,
          StartAlarmDelay,
          StartExternalRelay1Delay,
          StartExternalRelay2Delay,
          StartCriticalDisplayDelay,
          ActiveSendDelay,
          ActiveEndSendDelay,
          StartActiveTrackDelay,
          ActiveTrackInterval,
          AlarmState,
          ExternalRelay1State,
          ExternalRelay2State,
          WarningMessage,
          ActiveMessagePriority
        )
        SELECT
          v.HostID,
          ed.HostID,
          ved.VehicleGUID,
          ved.EventDescriptionKey,
          ved.EventType,
          ved.InUse,
          ved.RecordStartOdometer,
          ved.RecordStartPosition,
          ved.RecordEndOdometer,
          ved.RecordEndPosition,
          ved.RecordPulseCount,
          ved.SendActivePosition,
          ved.StartRecordDelay,
          ved.StartAlarmDelay,
          ved.StartExternalRelay1Delay,
          ved.StartExternalRelay2Delay,
          ved.StartCriticalDisplayDelay,
          ved.ActiveSendDelay,
          ved.ActiveEndSendDelay,
          ved.StartActiveTrackDelay,
          ved.ActiveTrackInterval,
          ved.AlarmState,
          ved.ExternalRelay1State,
          ved.ExternalRelay2State,
          ved.WarningMessage,
          ved.ActiveMessagePriority
        FROM
          [MiXData].[dbo].DIM_VehicleEventDefinitions ved  WITH (NOLOCK)
            INNER JOIN
          [MiXData].[dbo].DIM_Vehicles v           WITH (NOLOCK) ON @organisationKey         = v.OrganisationKey
                                                                   AND ved.VehicleGUID          = v.VehicleGUID
                                                                   AND v.IsCurrentRecord        = 1
            INNER JOIN
          [MiXData].[dbo].DIM_EventDescriptions ed WITH (NOLOCK) ON @organisationKey         = ed.OrganisationKey
                                                                   AND ved.EventDescriptionKey  = ed.EventDescriptionKey
            INNER JOIN
          missingVehicleEvents m                                    ON v.HostID                 = m.VehicleHostID
                                                                   AND ed.HostID                = m.EventHostID;
      END;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3.b Update VehicleTriggers - cater for Trigger only change', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

   -- c: update the XML property bag:
   CREATE INDEX IX_STAGE_DIM_VehicleEventDefinitions_VehicleGUID_EventDescriptionKey
     ON [StageUser1].STAGE_DIM_VehicleEventDefinitions(VehicleGUID,EventDescriptionKey)
     INCLUDE (VehicleHostID,EventHostID);

    UPDATE
      [StageUser1].STAGE_DIM_VehicleEventDefinitions
    SET
      EventTriggerDefinition = dbo.fncTransformVehicleTriggers('[StageUser1]', stg.VehicleHostID, stg.EventHostID, ved.EventTriggerDefinition)
    FROM
      [StageUser1].STAGE_DIM_VehicleEventDefinitions stg
        LEFT JOIN
      [MiXData].[dbo].DIM_VehicleEventDefinitions ved ON @organisationKey        = ved.OrganisationKey
                                                        AND stg.VehicleGUID         = ved.VehicleGUID
                                                        AND stg.EventDescriptionKey = ved.EventDescriptionKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3.c Update VehicleTriggers - update the XML property bag', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

  ------------------------------------------

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

--------------------------------------------------------------------
-- 4. Validation before Loading to DW
--------------------------------------------------------------------

  -- VehicleGUID is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser1].STAGE_DIM_VehicleEventDefinitions  
    WHERE VehicleGUID IS NULL;
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some VehicleEventDefinitions does not have associated DIM_Vehicles records available',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.1 Validation before Loading to DW (VehicleGUID is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;  

  -- EventDescriptionKey is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser1].STAGE_DIM_VehicleEventDefinitions  
    WHERE EventDescriptionKey IS NULL;
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some VehicleEventDefinitions does not have associated DIM_EventDescriptions records available',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.2 Validation before Loading to DW (EventDescriptionKey is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;  

  -- Remove dirty data
  BEGIN TRY  

    DELETE
      [StageUser1].STAGE_DIM_VehicleEventDefinitions
    WHERE
       VehicleGUID         IS NULL
    OR EventDescriptionKey IS NULL;

  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
  END CATCH;

--------------------------------------------------------------------
-- 5. MERGE to DW (Load, update) and add to RollBck
--------------------------------------------------------------------
  BEGIN TRY

    MERGE [MiXData].[dbo].DIM_VehicleEventDefinitions tar
      USING [StageUser1].STAGE_DIM_VehicleEventDefinitions stg
         ON tar.OrganisationKey         = @organisationKey
        AND tar.VehicleGUID             = stg.VehicleGUID
        AND tar.EventDescriptionKey     = stg.EventDescriptionKey
      WHEN MATCHED  
        THEN UPDATE SET
          tar.EventType                 = stg.EventType,
          tar.InUse                     = stg.InUse,
          tar.RecordStartOdometer       = stg.RecordStartOdometer,
          tar.RecordStartPosition       = stg.RecordStartPosition,
          tar.RecordEndOdometer         = stg.RecordEndOdometer,
          tar.RecordEndPosition         = stg.RecordEndPosition,
          tar.RecordPulseCount          = stg.RecordPulseCount,
          tar.SendActivePosition        = stg.SendActivePosition,
          tar.StartRecordDelay          = stg.StartRecordDelay,
          tar.StartAlarmDelay           = stg.StartAlarmDelay,
          tar.StartExternalRelay1Delay  = stg.StartExternalRelay1Delay,
          tar.StartExternalRelay2Delay  = stg.StartExternalRelay2Delay,
          tar.StartCriticalDisplayDelay = stg.StartCriticalDisplayDelay,
          tar.ActiveSendDelay           = stg.ActiveSendDelay,
          tar.ActiveEndSendDelay        = stg.ActiveEndSendDelay,
          tar.StartActiveTrackDelay     = stg.StartActiveTrackDelay,
          tar.ActiveTrackInterval       = stg.ActiveTrackInterval,
          tar.AlarmState                = stg.AlarmState,
          tar.ExternalRelay1State       = stg.ExternalRelay1State,
          tar.ExternalRelay2State       = stg.ExternalRelay2State,
          tar.WarningMessage            = stg.WarningMessage,
          tar.ActiveMessagePriority     = stg.ActiveMessagePriority,
          tar.EventTriggerDefinition    = stg.EventTriggerDefinition,
          tar.UpdateBatchKey            = @batchKey
      WHEN NOT MATCHED THEN
        INSERT
        (
          OrganisationKey,
          VehicleGUID,
          EventDescriptionKey,
          EventType,
          InUse,
          RecordStartOdometer,
          RecordStartPosition,
          RecordEndOdometer,
          RecordEndPosition,
          RecordPulseCount,
          SendActivePosition,
          StartRecordDelay,
          StartAlarmDelay,
          StartExternalRelay1Delay,
          StartExternalRelay2Delay,
          StartCriticalDisplayDelay,
          ActiveSendDelay,
          ActiveEndSendDelay,
          StartActiveTrackDelay,
          ActiveTrackInterval,
          AlarmState,
          ExternalRelay1State,
          ExternalRelay2State,
          WarningMessage,
          ActiveMessagePriority,
          EventTriggerDefinition,
          CreateBatchKey,
          UpdateBatchKey
        )
        VALUES
        (
          @organisationKey,
          stg.VehicleGUID,
          stg.EventDescriptionKey,
          stg.EventType,
          stg.InUse,
          stg.RecordStartOdometer,
          stg.RecordStartPosition,
          stg.RecordEndOdometer,
          stg.RecordEndPosition,
          stg.RecordPulseCount,
          stg.SendActivePosition,
          stg.StartRecordDelay,
          stg.StartAlarmDelay,
          stg.StartExternalRelay1Delay,
          stg.StartExternalRelay2Delay,
          stg.StartCriticalDisplayDelay,
          stg.ActiveSendDelay,
          stg.ActiveEndSendDelay,
          stg.StartActiveTrackDelay,
          stg.ActiveTrackInterval,
          stg.AlarmState,
          stg.ExternalRelay1State,
          stg.ExternalRelay2State,
          stg.WarningMessage,
          stg.ActiveMessagePriority,
          stg.EventTriggerDefinition,
          @batchKey,
          @batchKey
        )
      OUTPUT
        $action   AS Operation,
        ISNULL(deleted.VehicleEventKey,     inserted.VehicleEventKey),
        deleted.OrganisationKey,
        ISNULL(deleted.VehicleGUID,         inserted.VehicleGUID),
        ISNULL(deleted.EventDescriptionKey, inserted.EventDescriptionKey),
        deleted.EventType,
        deleted.InUse,
        deleted.RecordStartOdometer,
        deleted.RecordStartPosition,
        deleted.RecordEndOdometer,
        deleted.RecordEndPosition,
        deleted.RecordPulseCount,
        deleted.SendActivePosition,
        deleted.StartRecordDelay,
        deleted.StartAlarmDelay,
        deleted.StartExternalRelay1Delay,
        deleted.StartExternalRelay2Delay,
        deleted.StartCriticalDisplayDelay,
        deleted.ActiveSendDelay,
        deleted.ActiveEndSendDelay,
        deleted.StartActiveTrackDelay,
        deleted.ActiveTrackInterval,
        deleted.AlarmState,
        deleted.ExternalRelay1State,
        deleted.ExternalRelay2State,
        deleted.WarningMessage,
        deleted.ActiveMessagePriority,
        deleted.EventTriggerDefinition,
        deleted.CreateBatchKey,
        deleted.UpdateBatchKey
      INTO
        @merged;
    SET @rowcount = @@ROWCOUNT;
    SELECT
      @recordsInserted += COUNT(*)
    FROM
      @merged
    WHERE
      Operation = 'INSERT'

    INSERT INTO [StageUser1].ROLLBACK_DIM_VehicleEventDefinitions
    (
      VehicleEventKey,
      OrganisationKey,
      VehicleGUID,
      EventDescriptionKey,
      EventType,
      InUse,
      RecordStartOdometer,
      RecordStartPosition,
      RecordEndOdometer,
      RecordEndPosition,
      RecordPulseCount,
      SendActivePosition,
      StartRecordDelay,
      StartAlarmDelay,
      StartExternalRelay1Delay,
      StartExternalRelay2Delay,
      StartCriticalDisplayDelay,
      ActiveSendDelay,
      ActiveEndSendDelay,
      StartActiveTrackDelay,
      ActiveTrackInterval,
      AlarmState,
      ExternalRelay1State,
      ExternalRelay2State,
      WarningMessage,
      ActiveMessagePriority,
      EventTriggerDefinition,
      CreateBatchKey,
      UpdateBatchKey
    )
    SELECT
      VehicleEventKey,
      OrganisationKey,
      VehicleGUID,
      EventDescriptionKey,
      EventType,
      InUse,
      RecordStartOdometer,
      RecordStartPosition,
      RecordEndOdometer,
      RecordEndPosition,
      RecordPulseCount,
      SendActivePosition,
      StartRecordDelay,
      StartAlarmDelay,
      StartExternalRelay1Delay,
      StartExternalRelay2Delay,
      StartCriticalDisplayDelay,
      ActiveSendDelay,
      ActiveEndSendDelay,
      StartActiveTrackDelay,
      ActiveTrackInterval,
      AlarmState,
      ExternalRelay1State,
      ExternalRelay2State,
      WarningMessage,
      ActiveMessagePriority,
      EventTriggerDefinition,
      CreateBatchKey,
      UpdateBatchKey
    FROM
      @merged
    WHERE
      Operation = 'UPDATE'
      AND UpdateBatchKey < @batchKey;
    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5. MERGE to DW (Load) and add to RollBck', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    BEGIN
      TRUNCATE TABLE [StageUser1].STAGE_DIM_VehicleEventDefinitions;
    END;
  ELSE
    BEGIN
      PRINT N'7. Cleanup work tables';
    END;

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_VehicleProfiles_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_VehicleProfiles_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;
  DECLARE @nrOfValidationErrors   int = 0;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey           int;
  DECLARE @UTCOffsetMinutes       smallint;
  DECLARE @maxAuditDate           datetimeoffset (0);
  DECLARE @startDate              datetimeoffset (0);
  DECLARE @tmpDate                datetimeoffset (0);
  DECLARE @endDate                datetimeoffset (0);
  DECLARE @startDateKey           date;
  DECLARE @previousEndDateKey     date;

  -- Default values
  DECLARE @startDateFirstInsert date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @endDateDefault       date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)

  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                     nvarchar (10)     NOT NULL,
    VehicleProfileKey             int               NOT NULL,
    StartDateKey                  date              NULL,
    EndDateKey                    date              NULL,
    IsCurrentRecord               bit               NULL,
    OrganisationKey               int               NULL,
    VehicleGUID                   uniqueidentifier  NOT NULL,
    ParameterKey                  int               NOT NULL,
    RangeLowerValue1              float             SPARSE NULL,
    RangeLowerValue2              float             SPARSE NULL,
    RangeLowerValue3              float             SPARSE NULL,
    RangeLowerValue4              float             SPARSE NULL,
    RangeLowerValue5              float             SPARSE NULL,
    RangeLowerValue6              float             SPARSE NULL,
    RangeLowerValue7              float             SPARSE NULL,
    RangeLowerValue8              float             SPARSE NULL,
    RangeLowerValue9              float             SPARSE NULL,
    RangeLowerValue10             float             SPARSE NULL,
    RangeLowerValue11             float             SPARSE NULL,
    UTCOffsetKey                  smallint          NULL,
    CreateBatchKey                int               NULL,
    UpdateBatchKey                int               NULL
  );
  DECLARE @type2Keys table
  (
    VehicleProfileKey             int               NOT NULL,
    VehicleGUID                   uniqueidentifier  NOT NULL,
    ParameterKey                  int               NOT NULL
  );

  -- Get range for which SCD should be calculated
  SELECT
    @startDate    = MIN(ChangeDate),
    @maxAuditDate = MAX(ChangeDate)
  FROM
    [StageUser1].VehicleProfile;

  TRUNCATE TABLE [StageUser1].ROLLBACK_DIM_VehicleProfiles;

  -- Loop through calculation a day at a time and Load to DW
  WHILE @startDate <= @MaxAuditDate
    BEGIN
    -- get timezone infomation
      SELECT
        @UTCOffsetKey     = UTCOffsetKey,
        @UTCOffsetMinutes = UTCOffsetMinutes,
        @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
      FROM
        [StageUser1].STAGE_DIM_UTCOffsetsLookUp
      WHERE
        @startDate     BETWEEN StartDateTime       AND EndDateTime
        AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

      SET @startDateKey       = CONVERT(date, @tmpDate);
    -- get the UTC time for the start of the next day in organisation's timezone
      SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
      SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

    --------------------------------------------------------------------
    -- 0. Make sure work tables are cleared
    --------------------------------------------------------------------
      TRUNCATE TABLE [StageUser1].STAGE_DIM_VehicleProfiles;

      IF @debugMode = 1  -- DebugMode is true
        PRINT N'0. Make sure work tables are cleared for processing from ' + CONVERT(nvarchar, @startDate, 0) + ' to ' + CONVERT(nvarchar, @endDate, 0);

    --------------------------------------------------------------------
    -- 1. Source Data Validation
    --------------------------------------------------------------------


    --------------------------------------------------------------------
    -- 2. Add to STG
    --------------------------------------------------------------------
      BEGIN TRY

        ;WITH LastProfile (RID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser1].VehicleProfile WITH (NOLOCK)
          WHERE
            ChangeDate >= @startDate
            AND ChangeDate < @endDate
          GROUP BY
            iVehicleID,
            iParameterID,
            ucSeq
        )
        , profiles (VehicleHostID, ParameterHostID, RangeLowerValue1, RangeOperation1, RangeLowerValue2, RangeOperation2, RangeLowerValue3, RangeOperation3, RangeLowerValue4, RangeOperation4, RangeLowerValue5, RangeOperation5, RangeLowerValue6, RangeOperation6, RangeLowerValue7, RangeOperation7, RangeLowerValue8, RangeOperation8, RangeLowerValue9, RangeOperation9, RangeLowerValue10, RangeOperation10, RangeLowerValue11, RangeOperation11) AS
        (
          SELECT
            iVehicleID,
            iParameterID,                           ---- Force NULL when deleted!
            MAX(CASE WHEN ucSeq = 1  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 1  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 2  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 2  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 3  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 3  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 4  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 4  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 5  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 5  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 6  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 6  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 7  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 7  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 8  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 8  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 9  THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 9  THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 10 THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 10 THEN Operation ELSE NULL END),
            MAX(CASE WHEN ucSeq = 11 THEN CASE WHEN Operation = 'D' THEN NULL ELSE lfValue END ELSE NULL END),
            MAX(CASE WHEN ucSeq = 11 THEN Operation ELSE NULL END)
          FROM
            LastProfile l
            INNER JOIN [StageUser1].VehicleProfile p WITH (NOLOCK) ON l.RID = p.RID
          GROUP BY
            iVehicleID,
            iParameterID
        )
        INSERT INTO [StageUser1].STAGE_DIM_VehicleProfiles
        (
          VehicleHostID,
          ParameterHostID,
          RangeLowerValue1,
          RangeOperation1,
          RangeLowerValue2,
          RangeOperation2,
          RangeLowerValue3,
          RangeOperation3,
          RangeLowerValue4,
          RangeOperation4,
          RangeLowerValue5,
          RangeOperation5,
          RangeLowerValue6,
          RangeOperation6,
          RangeLowerValue7,
          RangeOperation7,
          RangeLowerValue8,
          RangeOperation8,
          RangeLowerValue9,
          RangeOperation9,
          RangeLowerValue10,
          RangeOperation10,
          RangeLowerValue11,
          RangeOperation11
        )
        SELECT * FROM profiles;
        SET @rowcount = @@ROWCOUNT;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

    --------------------------------------------------------------------
    -- 3. Update calculated columns onto STG
    --------------------------------------------------------------------
      BEGIN TRY

      ------------------------------------------
      -- VehicleGUID
        UPDATE
          [StageUser1].STAGE_DIM_VehicleProfiles
        SET
          VehicleGUID     = v.VehicleGUID
        FROM
          [StageUser1].STAGE_DIM_VehicleProfiles stg
          INNER JOIN [MiXData].[dbo].DIM_Vehicles v WITH (NOLOCK) ON @organisationKey  = v.OrganisationKey
                                                                    AND stg.VehicleHostID = v.HostID
        WHERE
          @startDateKey BETWEEN v.StartDateKey AND v.EndDateKey;

      ------------------------------------------
      -- ParameterKey
        UPDATE
          [StageUser1].STAGE_DIM_VehicleProfiles
        SET
          ParameterKey    = p.ParameterKey
        FROM
          [StageUser1].STAGE_DIM_VehicleProfiles stg
          INNER JOIN [MiXData].[dbo].DIM_CalibrationParameters p WITH (NOLOCK) ON @organisationKey    = p.OrganisationKey
                                                                                 AND stg.ParameterHostID = p.HostID;

        IF @debugMode = 1  -- DebugMode is true
          PRINT N'3. Update calculated columns onto STG';

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

    --------------------------------------------------------------------
    -- 4. Validation before Loading to DW
    --------------------------------------------------------------------
      -- VehicleGUID is null
      BEGIN TRY  

        SELECT
          @nrOfValidationErrors = ISNULL(COUNT(1),0)
        FROM
          [StageUser1].STAGE_DIM_VehicleProfiles  
        WHERE VehicleGUID IS NULL;
                     
        IF @nrOfValidationErrors > 0
        BEGIN  
          RAISERROR(N'Some VehicleProfiles does not have associated DIM_Vehicles records available',16,1);  
        END  
       
        IF @debugMode = 1  -- DebugMode is true  
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.1 Validation before Loading to DW (VehicleGUID is null)';  
      
      END TRY  
      -- CATCH Errors  
      BEGIN CATCH  
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
      END CATCH;  


      -- ParameterKey is null
      BEGIN TRY  

        SELECT
          @nrOfValidationErrors = ISNULL(COUNT(1),0)
        FROM
          [StageUser1].STAGE_DIM_VehicleProfiles  
        WHERE ParameterKey IS NULL;
                     
        IF @nrOfValidationErrors > 0
        BEGIN  
          RAISERROR(N'Some VehicleProfiles does not have associated DIM_CalibrationParameters records available',16,1);  
        END  
       
        IF @debugMode = 1  -- DebugMode is true  
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.2 Validation before Loading to DW (ParameterKey is null)';  
      
      END TRY  
      -- CATCH Errors  
      BEGIN CATCH  
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
      END CATCH;  

      -- Remove dirty data
      BEGIN TRY  

        DELETE
          [StageUser1].STAGE_DIM_VehicleProfiles
        WHERE
          ParameterKey IS NULL
        OR VehicleGUID IS NULL;

      END TRY  
      -- CATCH Errors  
      BEGIN CATCH  
        EXEC [Control].sprLogError @organisationKey = @organisationKey;  
      END CATCH;

    --------------------------------------------------------------------
    -- 5. MERGE to DW (Load) and add to RollBck (Type 2)
    --------------------------------------------------------------------
      BEGIN TRY

        DELETE @merged;
        MERGE [MiXData].[dbo].DIM_VehicleProfiles tar
          USING [StageUser1].STAGE_DIM_VehicleProfiles stg
             ON tar.OrganisationKey = @organisationKey
            AND tar.VehicleGUID     = stg.VehicleGUID
            AND tar.ParameterKey    = stg.ParameterKey
          WHEN MATCHED  -- Matched and DW StartDateKey = StartDate (then just update)
           AND tar.StartDateKey    = @startDate
           AND tar.EndDateKey      = @endDateDefault
            THEN UPDATE
            SET
              tar.RangeLowerValue1  = CASE
                                        WHEN RangeOperation1 IS NULL THEN
                                          tar.RangeLowerValue1    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue1
                                       END,
              tar.RangeLowerValue2  = CASE
                                        WHEN RangeOperation2 IS NULL THEN
                                          tar.RangeLowerValue2    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue2
                                       END,
              tar.RangeLowerValue3  = CASE
                                        WHEN RangeOperation3 IS NULL THEN
                                          tar.RangeLowerValue3    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue3
                                       END,
              tar.RangeLowerValue4  = CASE
                                        WHEN RangeOperation4 IS NULL THEN
                                          tar.RangeLowerValue4    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue4
                                       END,
              tar.RangeLowerValue5  = CASE
                                        WHEN RangeOperation5 IS NULL THEN
                                          tar.RangeLowerValue5    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue5
                                       END,
              tar.RangeLowerValue6  = CASE
                                        WHEN RangeOperation6 IS NULL THEN
                                          tar.RangeLowerValue6    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue6
                                       END,
              tar.RangeLowerValue7  = CASE
                                        WHEN RangeOperation7 IS NULL THEN
                                          tar.RangeLowerValue7    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue7
                                       END,
              tar.RangeLowerValue8  = CASE
                                        WHEN RangeOperation8 IS NULL THEN
                                          tar.RangeLowerValue8    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue8
                                       END,
              tar.RangeLowerValue9  = CASE
                                        WHEN RangeOperation9 IS NULL THEN
                                          tar.RangeLowerValue9    -- do not change!
                                        ELSE
                                          stg.RangeLowerValue9
                                       END,
              tar.RangeLowerValue10 = CASE
                                        WHEN RangeOperation10 IS NULL THEN
                                          tar.RangeLowerValue10   -- do not change!
                                        ELSE
                                          stg.RangeLowerValue10
                                       END,
              tar.RangeLowerValue11 = CASE
                                        WHEN RangeOperation11 IS NULL THEN
                                          tar.RangeLowerValue11   -- do not change!
                                        ELSE
                                          stg.RangeLowerValue11
                                       END,
              tar.UpdateBatchKey    = @batchKey
          WHEN NOT MATCHED THEN
            INSERT
            (
              StartDateKey,
              EndDateKey,
              IsCurrentRecord,
              OrganisationKey,
              VehicleGUID,
              ParameterKey,
              RangeLowerValue1,
              RangeLowerValue2,
              RangeLowerValue3,
              RangeLowerValue4,
              RangeLowerValue5,
              RangeLowerValue6,
              RangeLowerValue7,
              RangeLowerValue8,
              RangeLowerValue9,
              RangeLowerValue10,
              RangeLowerValue11,
              UTCOffsetKey,
              CreateBatchKey,
              UpdateBatchKey
            )
            VALUES
            (
              @startDateFirstInsert,
              @endDateDefault,
              1,
              @organisationKey,
              stg.VehicleGUID,
              stg.ParameterKey,
              stg.RangeLowerValue1,
              stg.RangeLowerValue2,
              stg.RangeLowerValue3,
              stg.RangeLowerValue4,
              stg.RangeLowerValue5,
              stg.RangeLowerValue6,
              stg.RangeLowerValue7,
              stg.RangeLowerValue8,
              stg.RangeLowerValue9,
              stg.RangeLowerValue10,
              stg.RangeLowerValue11,
              @UTCOffsetKey,
              @batchKey,
              @batchKey
            )
          OUTPUT
            $action   AS Operation,
            ISNULL(DELETED.VehicleProfileKey, INSERTED.VehicleProfileKey),
            DELETED.StartDateKey,
            DELETED.EndDateKey,
            DELETED.IsCurrentRecord,
            DELETED.OrganisationKey,
            ISNULL(DELETED.VehicleGUID,  INSERTED.VehicleGUID),
            ISNULL(DELETED.ParameterKey, INSERTED.ParameterKey),
            DELETED.RangeLowerValue1,
            DELETED.RangeLowerValue2,
            DELETED.RangeLowerValue3,
            DELETED.RangeLowerValue4,
            DELETED.RangeLowerValue5,
            DELETED.RangeLowerValue6,
            DELETED.RangeLowerValue7,
            DELETED.RangeLowerValue8,
            DELETED.RangeLowerValue9,
            DELETED.RangeLowerValue10,
            DELETED.RangeLowerValue11,
            DELETED.UTCOffsetKey,
            DELETED.CreateBatchKey,
            DELETED.UpdateBatchKey
            INTO @merged;
        SET @rowcount = @@ROWCOUNT;
        SELECT
          @recordsInserted += COUNT(*)
        FROM
          @merged
        WHERE
          Operation = 'INSERT'

        INSERT INTO [StageUser1].ROLLBACK_DIM_VehicleProfiles
        (
          VehicleProfileKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          OrganisationKey,
          VehicleGUID,
          ParameterKey,
          RangeLowerValue1,
          RangeLowerValue2,
          RangeLowerValue3,
          RangeLowerValue4,
          RangeLowerValue5,
          RangeLowerValue6,
          RangeLowerValue7,
          RangeLowerValue8,
          RangeLowerValue9,
          RangeLowerValue10,
          RangeLowerValue11,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        SELECT
          VehicleProfileKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          OrganisationKey,
          VehicleGUID,
          ParameterKey,
          RangeLowerValue1,
          RangeLowerValue2,
          RangeLowerValue3,
          RangeLowerValue4,
          RangeLowerValue5,
          RangeLowerValue6,
          RangeLowerValue7,
          RangeLowerValue8,
          RangeLowerValue9,
          RangeLowerValue10,
          RangeLowerValue11,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        FROM
          @merged
        WHERE
          Operation          = 'UPDATE'
          AND UpdateBatchKey < @batchKey;
        SET @recordsUpdated += @@ROWCOUNT;

       IF @debugMode = 1
          PRINT '    after merge: rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

  --------------------------------------------------------------------
      -- type 2 changes -> first expire current
        DELETE @type2Keys;
        INSERT INTO @type2Keys
        SELECT
          tar.VehicleProfileKey,
          tar.VehicleGUID,
          tar.ParameterKey
        FROM
          [MiXData].[dbo].DIM_VehicleProfiles tar
          INNER JOIN [StageUser1].STAGE_DIM_VehicleProfiles stg ON tar.OrganisationKey = @organisationKey
                                                              AND tar.VehicleGUID     = stg.VehicleGUID
                                                              AND tar.ParameterKey    = stg.ParameterKey
        WHERE
          NOT EXISTS (SELECT *
                      FROM
                        @merged m
                      WHERE
                        m.VehicleGUID      = tar.VehicleGUID
                        AND m.ParameterKey = tar.ParameterKey)
          AND tar.StartDateKey      < @startDate
          AND tar.EndDateKey        = @endDateDefault
          AND (
               stg.RangeOperation1  IS NOT NULL
            OR stg.RangeOperation2  IS NOT NULL
            OR stg.RangeOperation3  IS NOT NULL
            OR stg.RangeOperation4  IS NOT NULL
            OR stg.RangeOperation5  IS NOT NULL
            OR stg.RangeOperation6  IS NOT NULL
            OR stg.RangeOperation7  IS NOT NULL
            OR stg.RangeOperation8  IS NOT NULL
            OR stg.RangeOperation9  IS NOT NULL
            OR stg.RangeOperation10 IS NOT NULL
            OR stg.RangeOperation11 IS NOT NULL
              );
        SET @rowcount = @@ROWCOUNT;

        INSERT INTO [StageUser1].ROLLBACK_DIM_VehicleProfiles
        (
          VehicleProfileKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          OrganisationKey,
          VehicleGUID,
          ParameterKey,
          RangeLowerValue1,
          RangeLowerValue2,
          RangeLowerValue3,
          RangeLowerValue4,
          RangeLowerValue5,
          RangeLowerValue6,
          RangeLowerValue7,
          RangeLowerValue8,
          RangeLowerValue9,
          RangeLowerValue10,
          RangeLowerValue11,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        SELECT
          VehicleProfileKey,
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          OrganisationKey,
          VehicleGUID,
          ParameterKey,
          RangeLowerValue1,
          RangeLowerValue2,
          RangeLowerValue3,
          RangeLowerValue4,
          RangeLowerValue5,
          RangeLowerValue6,
          RangeLowerValue7,
          RangeLowerValue8,
          RangeLowerValue9,
          RangeLowerValue10,
          RangeLowerValue11,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        FROM
         (UPDATE
            tar
          SET
            tar.EndDateKey      = @previousEndDateKey,
            tar.IsCurrentRecord = 0,
            tar.UpdateBatchKey  = @batchKey
          OUTPUT
            DELETED.VehicleProfileKey,
            DELETED.StartDateKey,
            DELETED.EndDateKey,
            DELETED.IsCurrentRecord,
            DELETED.OrganisationKey,
            DELETED.VehicleGUID,
            DELETED.ParameterKey,
            DELETED.RangeLowerValue1,
            DELETED.RangeLowerValue2,
            DELETED.RangeLowerValue3,
            DELETED.RangeLowerValue4,
            DELETED.RangeLowerValue5,
            DELETED.RangeLowerValue6,
            DELETED.RangeLowerValue7,
            DELETED.RangeLowerValue8,
            DELETED.RangeLowerValue9,
            DELETED.RangeLowerValue10,
            DELETED.RangeLowerValue11,
            DELETED.UTCOffsetKey,
            DELETED.CreateBatchKey,
            DELETED.UpdateBatchKey
          FROM
            [MiXData].[dbo].DIM_VehicleProfiles tar
            INNER JOIN @type2Keys k ON tar.VehicleProfileKey = k.VehicleProfileKey
         ) rollbck  -- end Update
        WHERE
          UpdateBatchKey < @batchKey -- end rollback insert

        INSERT INTO [MiXData].[dbo].DIM_VehicleProfiles
        (
          StartDateKey,
          EndDateKey,
          IsCurrentRecord,
          OrganisationKey,
          VehicleGUID,
          ParameterKey,
          RangeLowerValue1,
          RangeLowerValue2,
          RangeLowerValue3,
          RangeLowerValue4,
          RangeLowerValue5,
          RangeLowerValue6,
          RangeLowerValue7,
          RangeLowerValue8,
          RangeLowerValue9,
          RangeLowerValue10,
          RangeLowerValue11,
          UTCOffsetKey,
          CreateBatchKey,
          UpdateBatchKey
        )
        SELECT
          @startDate,
          @endDateDefault,
          1,
          @organisationKey,
          stg.VehicleGUID,
          stg.ParameterKey,
          CASE
            WHEN RangeOperation1 IS NULL THEN
              tar.RangeLowerValue1    -- do not change!
            ELSE
              stg.RangeLowerValue1
          END,
          CASE
            WHEN RangeOperation2 IS NULL THEN
              tar.RangeLowerValue2    -- do not change!
            ELSE
              stg.RangeLowerValue2
          END,
          CASE
            WHEN RangeOperation3 IS NULL THEN
              tar.RangeLowerValue3    -- do not change!
            ELSE
              stg.RangeLowerValue3
          END,
          CASE
            WHEN RangeOperation4 IS NULL THEN
              tar.RangeLowerValue4    -- do not change!
            ELSE
              stg.RangeLowerValue4
          END,
          CASE
            WHEN RangeOperation5 IS NULL THEN
              tar.RangeLowerValue5    -- do not change!
            ELSE
              stg.RangeLowerValue5
          END,
          CASE
            WHEN RangeOperation6 IS NULL THEN
              tar.RangeLowerValue6    -- do not change!
            ELSE
              stg.RangeLowerValue6
          END,
          CASE
             WHEN RangeOperation7 IS NULL THEN
              tar.RangeLowerValue7    -- do not change!
            ELSE
              stg.RangeLowerValue7
          END,
          CASE
            WHEN RangeOperation8 IS NULL THEN
              tar.RangeLowerValue8    -- do not change!
            ELSE
              stg.RangeLowerValue8
          END,
          CASE
            WHEN RangeOperation9 IS NULL THEN
              tar.RangeLowerValue9    -- do not change!
            ELSE
              stg.RangeLowerValue9
          END,
          CASE
            WHEN RangeOperation10 IS NULL THEN
              tar.RangeLowerValue10   -- do not change!
            ELSE
              stg.RangeLowerValue10
          END,
          CASE
            WHEN RangeOperation11 IS NULL THEN
              tar.RangeLowerValue11   -- do not change!
            ELSE
              stg.RangeLowerValue11
          END,
          @UTCOffsetKey,
          @batchKey,
          @batchKey
        FROM
          [MiXData].[dbo].DIM_VehicleProfiles tar
          INNER JOIN [StageUser1].STAGE_DIM_VehicleProfiles stg ON tar.OrganisationKey = @organisationKey
                                                              AND tar.VehicleGUID     = stg.VehicleGUID
                                                              AND tar.ParameterKey    = stg.ParameterKey
          INNER JOIN @type2Keys k ON tar.VehicleProfileKey = k.VehicleProfileKey;
        SET @recordsType2Inserted += @@ROWCOUNT;

        IF @debugMode = 1
          PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

  -- next day to process:
      SELECT
        @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
      FROM
        [StageUser1].VehicleProfile
      WHERE
        ChangeDate >= @endDate;

    END -- END WHILE

  --------------------------------------------------------------------
  -- 6. Update Type 1 columns on DW
  --------------------------------------------------------------------

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Update Type 1 columns on DW';

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].STAGE_DIM_VehicleProfiles;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------

  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'8. Return values for Performance Monitoring';

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDIM_Vehicles_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDIM_Vehicles_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted        int = 0;
  DECLARE @recordsType2Inserted   int = 0;
  DECLARE @recordsUpdated         int = 0;
  DECLARE @recordsDeleted         int = 0;
  DECLARE @rowcount               int = 0;
  DECLARE @nrOfRecordsAffected    int = 0;

  -- Used for looping through SCD days
  DECLARE @UTCOffsetKey           int;
  DECLARE @UTCOffsetMinutes       smallint;
  DECLARE @maxAuditDate           datetimeoffset (0);
  DECLARE @startDate              datetimeoffset (0);
  DECLARE @tmpDate                datetimeoffset (0);
  DECLARE @endDate                datetimeoffset (0);
  DECLARE @startDateKey           date;
  DECLARE @previousEndDateKey     date;

  -- Default values
  DECLARE @startDateFirstInsert   date = '00010101'; -- used for the first record insert for that logical key (to be used incase factual data falls outside of beginning start date)
  DECLARE @endDateDefault         date = '20501231'; -- this will be the value assigned to the most recent active record (eg. IsActiveRecord = 1)
  DECLARE @defaultIdentifierValue uniqueidentifier = '00000000-0000-0000-0000-000000000000'; -- used with GUID comparison for null values

  -- Table to hold intermediate results
  DECLARE @merged table
  (
    Operation                            nvarchar (10)     NOT NULL,
    [VehicleKey]                         INT               NOT NULL,
    [OrganisationKey]                    INT               NULL,
    [StartDateKey]                       DATE              NULL,
    [EndDateKey]                         DATE              NULL,
    [IsCurrentRecord]                    BIT               NULL,
    [IsActive]                           BIT               NULL,
    [HostID]                             INT               NULL,
    [VehicleGUID]                        UNIQUEIDENTIFIER  NULL,
    [VehicleDescription]                 NVARCHAR (255)    NULL,
    [SiteGUID]                           UNIQUEIDENTIFIER  NULL,
    [SiteKey]                            INT               NULL,
    [LastServiceDateKey]                 DATE              NULL,
    [IsYellowEquip]                      BIT               NULL,
    [RegNumber]                          NVARCHAR (15)     NULL,
    [ServiceByDistance]                  DECIMAL (19, 4)   NULL,
    [ServiceByDate]                      TINYINT           NULL,
    [ServiceByEngineSeconds]             INT               NULL,
    [NextServiceDueDistance]             DECIMAL (19, 4)   NULL,
    [NextServiceDueDateKey]              DATE              NULL,
    [NextServiceDueEngineSeconds]        INT               NULL,
    [DefaultDriverGUID]                  UNIQUEIDENTIFIER  NULL,
    [TargetFuelConsumption]              REAL              NULL,
    [TargetFuelConsumptionHourly]        REAL              NULL,
    [ScoreTriggerOverspeeding]           FLOAT             NULL,
    [ScoreTriggerOverRevving]            FLOAT             NULL,
    [ScoreTriggerOverHarshDeceleration]  FLOAT             NULL,
    [ScoreTriggerOverHarshAccelleration] FLOAT             NULL,
    [TermScriptConfigGroup]              INT               NULL,
    [ConfigurationGroupNameID]           INT               NULL,
    [ConfigurationGroupName]             NVARCHAR(255)     NULL,
    [FuelTypeLookupKey]                  INT               NULL,
    [EstimateCO2EmissionGramsperKm]      INT               NULL,
    [UnitTypeLookupKey]                  INT               NULL,
    [BatteryVoltage]                     NUMERIC(19,6)     NULL,
    [CurrentDeviceDriverVersion]         NVARCHAR(25)      NULL,
    [LastDeviceDriverUploadDateTime]     DATETIMEOFFSET(0) NULL,
    [LastConfigurationUploadDateTime]    DATETIMEOFFSET(0) NULL,
    [LastDeviceChangeDateTime]           DATETIMEOFFSET(0) NULL,
    [LastEventChangeDateTime]            DATETIMEOFFSET(0) NULL,
    [CreateDateKey]                      DATE              NULL,
    [IsMeasuringFuel]                    BIT               NULL,
    [IsCofiguredForMeasuringFuel]        BIT               NULL,
    [UTCOffsetKey]                       INT               NULL,
    [CreateBatchKey]                     INT               NULL,
    [UpdateBatchKey]                     INT               NULL
  );

  DECLARE @type2Keys table
  (
    VehicleKey                           int   NOT NULL,
    HostID                               int   NOT NULL,
    [ScoreTriggerOverspeeding]           FLOAT NULL,
    [ScoreTriggerOverRevving]            FLOAT NULL,
    [ScoreTriggerOverHarshDeceleration]  FLOAT NULL,
    [ScoreTriggerOverHarshAccelleration] FLOAT NULL,
    VehicleGUID                          UNIQUEIDENTIFIER NULL
  );

  -- Get range for which SCD should be calculated
  SELECT 
    @startDate    = MIN(ChangeDate),
    @maxAuditDate = MAX(ChangeDate)
  FROM
    [StageUser1].Vehicles;

  TRUNCATE TABLE [StageUser1].ROLLBACK_DIM_Vehicles;

  IF @debugMode = 1  -- DebugMode is true  
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set  
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';  
  END;  

  -- Loop through calculation a day at a time and Load to DW
  WHILE @StartDate <= @MaxAuditDate
    BEGIN
    -- get timezone infomation
      SELECT
        @UTCOffsetKey     = UTCOffsetKey,
        @UTCOffsetMinutes = UTCOffsetMinutes,
        @tmpDate          = SWITCHOFFSET(@StartDate, UTCOffsetMinutes)
      FROM
        [StageUser1].STAGE_DIM_UTCOffsetsLookUp
      WHERE
        @startDate     BETWEEN StartDateTime       AND EndDateTime
        AND @startDate BETWEEN SeasonStartDateTime AND SeasonEndDateTime;

      SET @startDateKey       = CONVERT(date, @tmpDate);
    -- get the UTC time for the start of the next day in organisation's timezone
      SET @endDate            = TODATETIMEOFFSET(CONVERT(datetimeoffset(0), DATEADD(DAY, 1, @startDateKey)), @UTCOffsetMinutes);
      SET @previousEndDateKey = CONVERT(date, DATEADD(DAY, -1, @startDateKey));

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
      TRUNCATE TABLE [StageUser1].[STAGE_DIM_Vehicles];

      IF @debugMode = 1  -- DebugMode is true
        PRINT N'0. Make sure work tables are cleared for processing from ' + CONVERT(nvarchar, @startDate, 0) + ' to ' + CONVERT(nvarchar, @endDate, 0);

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  
  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
      BEGIN TRY

        ;WITH Latest (MaxRID) AS
        (
          SELECT
            MAX(RID)
          FROM
            [StageUser1].Vehicles WITH (NOLOCK)
          WHERE
            ChangeDate >= @startDate
          AND
            ChangeDate  < @endDate
          GROUP BY
            iVehicleID
        )
        INSERT INTO [StageUser1].[STAGE_DIM_Vehicles]
        (
          [HostID]                    ,
          [VehicleGUID]               ,
          [VehicleDescription]        , 
          [SiteID]                    , 
          [RegNumber]                 , 
          [ServiceByDistance]         , 
          [ServiceByDate]             , 
          [ServiceByEngineSeconds]      , 
          [NextServiceDueDistance]    , 
          [NextServiceDueDateKey]     , 
          [NextServiceDueEngineSeconds] , 
          [DefaultDriverID]           , 
          [TargetFuelConsumption]     , 
          [TargetFuelConsumptionHourly], 
          [ConfigurationGroupNameID]  , 
          [ConfigurationGroupName]    ,
          [TermScriptConfigGroup]     ,
          [IsActive]                  ,
          [ucUnitType]
        )
        SELECT
          s.iVehicleID                       ,
          s.VehicleGUID                      ,
          s.sDesc                            ,
          s.liSiteID                         ,
          s.sRegNo                           ,
          s.fServiceKm                       ,
          s.ucServiceMonths                  ,
          ISNULL(s.liServiceSeconds,0)       ,
          s.fNextServiceKm                   ,
          CONVERT(DATE,s.dtNextServiceDate)  ,
          ISNULL(s.liNextServiceSeconds,0)   ,
          s.iDefaultDriver                   ,
          s.fTargetConsumption               ,
          s.fTargetHourlyConsumption         ,
          s.liGroupID                        ,
          ISNULL(vc.sName,'')                ,
          1                                  ,  -- TermScriptConfigGroup default of 1
          IsActive = CASE
                       WHEN s.Operation = 'D' THEN
                         0
                       ELSE
                         s.bActive
                     END,
          s.ucUnitType
        FROM
          Latest l 
            INNER JOIN
          [StageUser1].Vehicles      s  WITH (NOLOCK) ON s.RID       = l.MaxRID
            LEFT OUTER JOIN
          [StageUser1].VehicleConfig vc WITH (NOLOCK) ON s.liGroupID = vc.liGroupID;

            SET @rowcount = @@ROWCOUNT;

            IF @debugMode = 1  -- DebugMode is true
              PRINT N'2. Add to STG, records staged = ' + CONVERT(nvarchar, @rowcount);

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
        RETURN -1;
      END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    ------------------------------------------
    -- SiteGUID
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET
      SiteGUID     = ds.SiteGUID,
      SiteKey      = ds.SiteKey
    FROM
      [StageUser1].[STAGE_DIM_Vehicles] stg
        INNER JOIN
      [MiXData].dbo.DIM_Sites ds WITH (NOLOCK) ON ds.OrganisationKey  = @organisationKey
                                                 AND stg.SiteID          = ds.HostID;

    ------------------------------------------
    -- DefaultDriverGUID
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET
      DefaultDriverGUID = dd.DriverGUID
    FROM
      [StageUser1].[STAGE_DIM_Vehicles] stg
        INNER JOIN
      [MiXData].dbo.DIM_Drivers dd WITH (NOLOCK) ON dd.OrganisationKey  = @organisationKey
                                                   AND stg.DefaultDriverID = dd.HostID;

    ------------------------------------------
    -- ScoreTrigger fields
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET -- select
      [ScoreTriggerOverspeeding]           = vt1.lfValue,
      [ScoreTriggerOverRevving]            = vt2.lfValue,
      [ScoreTriggerOverHarshDeceleration]  = vt3.lfValue,
      [ScoreTriggerOverHarshAccelleration] = vt4.lfValue
    FROM
      [StageUser1].[STAGE_DIM_Vehicles] AS stg 
        LEFT OUTER JOIN
      [StageUser1].VehicleTriggers  AS vt1 
        ON stg.HostID           = vt1.iVehicleID 
        INNER JOIN
      [StageUser1].ScoredEvents     AS se1 
        ON se1.ucScoreTriggerID = vt1.ucTriggerID AND 
           vt1.iEventID         = se1.iEventID 
        LEFT OUTER JOIN
      [StageUser1].ScoredEvents     AS se3 
        INNER JOIN
      [StageUser1].VehicleTriggers  AS vt3 
        ON se3.iEventID         = vt3.iEventID AND 
           se3.ucScoreTriggerID = vt3.ucTriggerID 
        ON stg.HostID           = vt3.iVehicleID 
        LEFT OUTER JOIN
      [StageUser1].ScoredEvents     AS se2 
        INNER JOIN
      [StageUser1].VehicleTriggers  AS vt2 
        ON se2.iEventID         = vt2.iEventID AND 
           se2.ucScoreTriggerID = vt2.ucTriggerID 
        ON stg.HostID           = vt2.iVehicleID
        LEFT OUTER JOIN
      [StageUser1].ScoredEvents     AS se4 
        INNER JOIN
      [StageUser1].VehicleTriggers  AS vt4 
        ON se4.iEventID         = vt4.iEventID AND 
           se4.ucScoreTriggerID = vt4.ucTriggerID 
        ON stg.HostID           = vt4.iVehicleID
    WHERE
        vt1.iEventID = 1  -- HardCoded from EventDescription - OverSpeeding
    AND vt2.iEventID = 2  -- HardCoded from EventDescription - OverRevving
    AND vt3.iEventID = 3  -- HardCoded from EventDescription - HarshDeceleration
    AND vt4.iEventID = 7; -- HardCoded from EventDescription - HarshAcceleration

    ------------------------------------------
    -- FuelTypeLookupKey
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET
      FuelTypeLookupKey     = dcl.LookupRID
    FROM
      [MiXData].dbo.DIM_TableColumnLookups dcl WITH (NOLOCK)
    WHERE
        dcl.LookupTable  = 'DIM_Vehicles'
    AND dcl.LookupColumn = 'FuelTypeLookupKey'
    AND dcl.LookupKey    = 2;  -- Default of Diesel for now

    ------------------------------------------
    -- EstimateCO2EmissionGramsperKm
    --   A gallon of gasoline is assumed to produce 8.8 kilograms (or 19.4 pounds) of CO2, converted to 2.321 kg/litre
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET
      EstimateCO2EmissionGramsperKm = TargetFuelConsumption * 2321.0;

    ------------------------------------------
    -- UnitTypeLookupKey
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET
      UnitTypeLookupKey = dl.LookupRID
    FROM
      [StageUser1].[STAGE_DIM_Vehicles]        stg
        INNER JOIN
      [Control].UnitTypeLookups               utl WITH (NOLOCK) ON stg.ucUnitType      = utl.UnitTypeID
        INNER JOIN
      [MiXData].dbo.DIM_TableColumnLookups dl  WITH (NOLOCK) ON dl.LookupKey        = utl.UnitTypeLookupKey
    WHERE
        dl.LookupTable  = 'DIM_Units'
    AND dl.LookupColumn = 'UnitTypeLookupKey';

    ------------------------------------------
    -- CreateDateKey
    ;WITH MinChangeDate AS
    (
      SELECT
        v.iVehicleID,
        v.VehicleGUID,
        MinChangeDate = MIN(v.ChangeDate)
      FROM
        [StageUser1].Vehicles v
      GROUP BY
        v.iVehicleID,
        v.VehicleGUID
    )
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET
      CreateDateKey = CONVERT(DATE,mc.MinChangeDate)
    FROM
      [StageUser1].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      MinChangeDate                       mc  WITH (NOLOCK) ON mc.iVehicleID  = stg.HostID
                                                           AND mc.VehicleGUID = stg.VehicleGUID;

    ------------------------------------------
    -- TermScriptConfigGroup (Still to be defined, current default to 1)
    ------------------------------------------
    -- AverageUtilization    (Still to be defined)
    ------------------------------------------
    -- LastEngineHourReading (Still to be defined)
    ------------------------------------------
    -- IsYellowEquip

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;

    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY
    IF EXISTS (SELECT 1
               FROM
                 [StageUser1].[STAGE_DIM_Vehicles]
               WHERE
                 VehicleGUID IS NULL)
    BEGIN
      RAISERROR(N'Missing Keys (possibly no values in DIM_GUIDToKeys)',16,1);
    END

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW:' + convert(nvarchar(15),@organisationKey);

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck (Type 2)
  --------------------------------------------------------------------
      BEGIN TRY

        DELETE @merged;

        MERGE INTO [MiXData].[dbo].DIM_Vehicles tar
          USING [StageUser1].STAGE_DIM_Vehicles     stg
             ON tar.OrganisationKey = @organisationKey
            AND tar.HostID          = stg.HostID
        -- Matched and DW IsCurrent record (then just update)
          WHEN MATCHED
            AND tar.StartDateKey = @StartDateKey
            AND tar.EndDateKey   = @endDateDefault
            THEN UPDATE
            SET
              tar.IsActive                           = stg.IsActive                          ,
              tar.VehicleGUID                        = stg.VehicleGUID                       ,
              tar.VehicleDescription                 = stg.VehicleDescription                ,
              tar.SiteGUID                           = stg.SiteGUID                          ,
              tar.SiteKey                            = stg.SiteKey                           ,
              tar.LastServiceDateKey                 = stg.LastServiceDateKey                ,
              tar.IsYellowEquip                      = stg.IsYellowEquip                     ,
              tar.RegNumber                          = stg.RegNumber                         ,
              tar.ServiceByDistance                  = stg.ServiceByDistance                 ,
              tar.ServiceByDate                      = stg.ServiceByDate                     ,
              tar.ServiceByEngineSeconds             = stg.ServiceByEngineSeconds            ,
              tar.NextServiceDueDistance             = stg.NextServiceDueDistance            ,
              tar.NextServiceDueDateKey              = stg.NextServiceDueDateKey             ,
              tar.NextServiceDueEngineSeconds        = stg.NextServiceDueEngineSeconds       ,
              tar.DefaultDriverGUID                  = stg.DefaultDriverGUID                 ,
              tar.TargetFuelConsumption              = stg.TargetFuelConsumption             ,
              tar.TargetFuelConsumptionHourly        = stg.TargetFuelConsumptionHourly       ,
              tar.ScoreTriggerOverspeeding           = ISNULL(stg.ScoreTriggerOverspeeding          ,tar.ScoreTriggerOverspeeding          ),
              tar.ScoreTriggerOverRevving            = ISNULL(stg.ScoreTriggerOverRevving           ,tar.ScoreTriggerOverRevving           ),
              tar.ScoreTriggerOverHarshDeceleration  = ISNULL(stg.ScoreTriggerOverHarshDeceleration ,tar.ScoreTriggerOverHarshDeceleration ),
              tar.ScoreTriggerOverHarshAccelleration = ISNULL(stg.ScoreTriggerOverHarshAccelleration,tar.ScoreTriggerOverHarshAccelleration),
              tar.TermScriptConfigGroup              = stg.TermScriptConfigGroup             ,
              tar.ConfigurationGroupNameID           = stg.ConfigurationGroupNameID          ,
              tar.ConfigurationGroupName             = stg.ConfigurationGroupName            ,
              tar.FuelTypeLookupKey                  = stg.FuelTypeLookupKey                 ,
              tar.EstimateCO2EmissionGramsperKm      = stg.EstimateCO2EmissionGramsperKm     ,
              tar.UnitTypeLookupKey                  = ISNULL(stg.UnitTypeLookupKey,-1)      ,
              tar.CreateDateKey                      = CASE
                                                         WHEN ISNULL(tar.CreateDateKey,'20500101') >= ISNULL(stg.CreateDateKey,'20500101')
                                                           THEN stg.CreateDateKey
                                                         ELSE tar.CreateDateKey
                                                       END,
              tar.UTCOffsetKey                       = @UTCOffsetKey                         ,
              tar.UpdateBatchKey                     = @batchKey
        -- Not Matched -> insert new record into DW
          WHEN NOT MATCHED
            THEN INSERT
            (
              StartDateKey                      ,
              EndDateKey                        ,
              IsCurrentRecord                   ,
              IsActive                          ,
              OrganisationKey                   ,
              HostID                            ,
              VehicleGUID                       ,
              VehicleDescription                ,
              SiteGUID                          ,
              SiteKey                           ,
              LastServiceDateKey                ,
              IsYellowEquip                     ,
              RegNumber                         ,
              ServiceByDistance                 ,
              ServiceByDate                     ,
              ServiceByEngineSeconds            ,
              NextServiceDueDistance            ,
              NextServiceDueDateKey             ,
              NextServiceDueEngineSeconds       ,
              DefaultDriverGUID                 ,
              TargetFuelConsumption             ,
              TargetFuelConsumptionHourly       ,
              ScoreTriggerOverspeeding          ,
              ScoreTriggerOverRevving           ,
              ScoreTriggerOverHarshDeceleration ,
              ScoreTriggerOverHarshAccelleration,
              TermScriptConfigGroup             ,
              ConfigurationGroupNameID          ,
              ConfigurationGroupName            ,
              FuelTypeLookupKey                 ,
              EstimateCO2EmissionGramsperKm     ,
              UnitTypeLookupKey                 ,
              CreateDateKey                     ,
              
              UTCOffsetKey                      ,
              CreateBatchKey                    ,
              UpdateBatchKey
            )
            VALUES
            (
              @startDateFirstInsert                 ,
              @endDateDefault                       ,
              1                                     ,
              stg.IsActive                          ,
              @organisationKey                      ,
              stg.HostID                            ,
              stg.VehicleGUID                       ,
              stg.VehicleDescription                ,
              stg.SiteGUID                          ,
              stg.SiteKey                           ,
              stg.LastServiceDateKey                ,
              stg.IsYellowEquip                     ,
              stg.RegNumber                         ,
              stg.ServiceByDistance                 ,
              stg.ServiceByDate                     ,
              stg.ServiceByEngineSeconds            ,
              stg.NextServiceDueDistance            ,
              stg.NextServiceDueDateKey             ,
              stg.NextServiceDueEngineSeconds       ,
              stg.DefaultDriverGUID                 ,
              stg.TargetFuelConsumption             ,
              stg.TargetFuelConsumptionHourly       ,
              stg.ScoreTriggerOverspeeding          ,
              stg.ScoreTriggerOverRevving           ,
              stg.ScoreTriggerOverHarshDeceleration ,
              stg.ScoreTriggerOverHarshAccelleration,
              stg.TermScriptConfigGroup             ,
              stg.ConfigurationGroupNameID          ,
              stg.ConfigurationGroupName            ,
              stg.FuelTypeLookupKey                 ,
              stg.EstimateCO2EmissionGramsperKm     ,
              ISNULL(stg.UnitTypeLookupKey          ,-1),
              stg.CreateDateKey                     ,
              @UTCOffsetKey                         ,
              @batchKey                             ,
              @batchKey
            )
          OUTPUT
            $action   AS Operation                    ,
            ISNULL(DELETED.VehicleKey, -1)            ,
            DELETED.OrganisationKey                   ,
            DELETED.StartDateKey                      ,
            DELETED.EndDateKey                        ,
            DELETED.IsCurrentRecord                   ,
            DELETED.IsActive                          ,
            ISNULL(DELETED.HostID, INSERTED.HostID)   ,
            DELETED.VehicleGUID                       ,
            DELETED.VehicleDescription                ,
            DELETED.SiteGUID                          ,
            DELETED.SiteKey                           ,
            DELETED.LastServiceDateKey                ,
            DELETED.IsYellowEquip                     ,
            DELETED.RegNumber                         ,
            DELETED.ServiceByDistance                 ,
            DELETED.ServiceByDate                     ,
            DELETED.ServiceByEngineSeconds            ,
            DELETED.NextServiceDueDistance            ,
            DELETED.NextServiceDueDateKey             ,
            DELETED.NextServiceDueEngineSeconds       ,
            DELETED.DefaultDriverGUID                 ,
            DELETED.TargetFuelConsumption             ,
            DELETED.TargetFuelConsumptionHourly       ,
            DELETED.ScoreTriggerOverspeeding          ,
            DELETED.ScoreTriggerOverRevving           ,
            DELETED.ScoreTriggerOverHarshDeceleration ,
            DELETED.ScoreTriggerOverHarshAccelleration,
            DELETED.TermScriptConfigGroup             ,
            DELETED.ConfigurationGroupNameID          ,
            DELETED.ConfigurationGroupName            ,
            DELETED.FuelTypeLookupKey                 ,
            DELETED.EstimateCO2EmissionGramsperKm     ,
            DELETED.UnitTypeLookupKey                 ,

            DELETED.BatteryVoltage                    ,
            DELETED.CurrentDeviceDriverVersion        ,
            DELETED.LastDeviceDriverUploadDateTime    ,
            DELETED.LastConfigurationUploadDateTime   ,
            DELETED.LastDeviceChangeDateTime          ,
            DELETED.LastEventChangeDateTime           ,
            DELETED.CreateDateKey                     ,
            DELETED.IsMeasuringFuel                   ,
            DELETED.IsCofiguredForMeasuringFuel       ,

            DELETED.UTCOffsetKey                      ,
            DELETED.CreateBatchKey                    ,
            DELETED.UpdateBatchKey
            INTO @merged;
        SET @rowcount = @@ROWCOUNT;
        SELECT
          @recordsInserted += COUNT(*)
        FROM
          @merged
        WHERE
          Operation = 'INSERT';

    IF @debugMode = 1  -- DebugMode is true
      PRINT N'5.1 Merge into DW';

        INSERT INTO [StageUser1].ROLLBACK_DIM_Vehicles
        (
          VehicleKey                        ,
          StartDateKey                      ,
          EndDateKey                        ,
          IsCurrentRecord                   ,
          IsActive                          ,
          OrganisationKey                   ,
          HostID                            ,
          VehicleGUID                       ,
          VehicleDescription                ,
          SiteGUID                          ,
          SiteKey                           ,
          LastServiceDateKey                ,
          IsYellowEquip                     ,
          RegNumber                         ,
          ServiceByDistance                 ,
          ServiceByDate                     ,
          ServiceByEngineSeconds            ,
          NextServiceDueDistance            ,
          NextServiceDueDateKey             ,
          NextServiceDueEngineSeconds       ,
          DefaultDriverGUID                 ,
          TargetFuelConsumption             ,
          TargetFuelConsumptionHourly       ,
          ScoreTriggerOverspeeding          ,
          ScoreTriggerOverRevving           ,
          ScoreTriggerOverHarshDeceleration ,
          ScoreTriggerOverHarshAccelleration,
          TermScriptConfigGroup             ,
          ConfigurationGroupNameID          ,
          ConfigurationGroupName            ,
          FuelTypeLookupKey                 ,
          EstimateCO2EmissionGramsperKm     ,
          UnitTypeLookupKey                 ,
          BatteryVoltage                    ,
          CurrentDeviceDriverVersion        ,
          LastDeviceDriverUploadDateTime    ,
          LastConfigurationUploadDateTime   ,
          LastDeviceChangeDateTime          ,
          LastEventChangeDateTime           ,
          CreateDateKey                     ,
          IsMeasuringFuel                   ,
          IsCofiguredForMeasuringFuel       ,
          UTCOffsetKey                      ,
          CreateBatchKey                    ,
          UpdateBatchKey
        )
        SELECT
          VehicleKey                        ,
          StartDateKey                      ,
          EndDateKey                        ,
          IsCurrentRecord                   ,
          IsActive                          ,
          OrganisationKey                   ,
          HostID                            ,
          VehicleGUID                       ,
          VehicleDescription                ,
          SiteGUID                          ,
          SiteKey                           ,
          LastServiceDateKey                ,
          IsYellowEquip                     ,
          RegNumber                         ,
          ServiceByDistance                 ,
          ServiceByDate                     ,
          ServiceByEngineSeconds            ,
          NextServiceDueDistance            ,
          NextServiceDueDateKey             ,
          NextServiceDueEngineSeconds       ,
          DefaultDriverGUID                 ,
          TargetFuelConsumption             ,
          TargetFuelConsumptionHourly       ,
          ScoreTriggerOverspeeding          ,
          ScoreTriggerOverRevving           ,
          ScoreTriggerOverHarshDeceleration ,
          ScoreTriggerOverHarshAccelleration,
          TermScriptConfigGroup             ,
          ConfigurationGroupNameID          ,
          ConfigurationGroupName            ,
          FuelTypeLookupKey                 ,
          EstimateCO2EmissionGramsperKm     ,
          UnitTypeLookupKey                 ,
          BatteryVoltage                    ,
          CurrentDeviceDriverVersion        ,
          LastDeviceDriverUploadDateTime    ,
          LastConfigurationUploadDateTime   ,
          LastDeviceChangeDateTime          ,
          LastEventChangeDateTime           ,
          CreateDateKey                     ,
          IsMeasuringFuel                   ,
          IsCofiguredForMeasuringFuel       ,
          UTCOffsetKey                      ,
          CreateBatchKey                    ,
          UpdateBatchKey
        FROM
          @merged
        WHERE
          Operation        = 'UPDATE'
          AND UpdateBatchKey < @batchKey; -- end insert
        SET @recordsUpdated += @@ROWCOUNT;
        
       IF @debugMode = 1
          PRINT '    after merge: rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

  --------------------------------------------------------------------
      -- type 2 changes -> first expire current
        DELETE @type2Keys;
        INSERT INTO @type2Keys
        (
          VehicleKey                          ,
          HostID                              ,
          [ScoreTriggerOverspeeding]          ,
          [ScoreTriggerOverRevving]           ,
          [ScoreTriggerOverHarshDeceleration] ,
          [ScoreTriggerOverHarshAccelleration],
          VehicleGUID
        )
        SELECT
          tar.VehicleKey                          ,
          tar.HostID                              ,
          tar.[ScoreTriggerOverspeeding]          ,
          tar.[ScoreTriggerOverRevving]           ,
          tar.[ScoreTriggerOverHarshDeceleration] ,
          tar.[ScoreTriggerOverHarshAccelleration],
          tar.VehicleGUID
        FROM
          [MiXData].[dbo].DIM_Vehicles tar
          INNER JOIN [StageUser1].STAGE_DIM_Vehicles stg ON tar.OrganisationKey = @organisationKey
                                                       AND tar.HostID          = stg.HostID
        WHERE
          tar.StartDateKey      < @StartDateKey
          AND  tar.EndDateKey   = @endDateDefault
          AND (ISNULL(tar.ScoreTriggerOverspeeding          ,0.0) <> ISNULL(stg.ScoreTriggerOverspeeding          ,tar.ScoreTriggerOverspeeding)
            OR ISNULL(tar.ScoreTriggerOverRevving           ,0.0) <> ISNULL(stg.ScoreTriggerOverRevving           ,tar.ScoreTriggerOverRevving)
            OR ISNULL(tar.ScoreTriggerOverHarshDeceleration ,0.0) <> ISNULL(stg.ScoreTriggerOverHarshDeceleration ,tar.ScoreTriggerOverHarshDeceleration)
            OR ISNULL(tar.ScoreTriggerOverHarshAccelleration,0.0) <> ISNULL(stg.ScoreTriggerOverHarshAccelleration,tar.ScoreTriggerOverHarshAccelleration)
            OR tar.IsActive                                       <> stg.IsActive
            OR ISNULL(tar.SiteGUID,@defaultIdentifierValue)       <> ISNULL(stg.SiteGUID,@defaultIdentifierValue)
            OR tar.UnitTypeLookupKey                              <> ISNULL(stg.UnitTypeLookupKey,-1)
            OR tar.VehicleGUID                                    <> stg.VehicleGUID
              );
        SET @rowcount = @@ROWCOUNT;

        INSERT INTO [StageUser1].ROLLBACK_DIM_Vehicles
        (
          [VehicleKey]                        ,
          [OrganisationKey]                   ,
          [StartDateKey]                      ,
          [EndDateKey]                        ,
          [IsCurrentRecord]                   ,
          [IsActive]                          ,
          [HostID]                            ,
          [VehicleGUID]                       ,
          [VehicleDescription]                ,
          [SiteGUID]                          ,
          [SiteKey]                           ,
          [LastServiceDateKey]                ,
          [IsYellowEquip]                     ,
          [RegNumber]                         ,
          [ServiceByDistance]                 ,
          [ServiceByDate]                     ,
          [ServiceByEngineSeconds]            ,
          [NextServiceDueDistance]            ,
          [NextServiceDueDateKey]             ,
          [NextServiceDueEngineSeconds]       ,
          [DefaultDriverGUID]                 ,
          [TargetFuelConsumption]             ,
          [TargetFuelConsumptionHourly]       ,
          [ScoreTriggerOverspeeding]          ,
          [ScoreTriggerOverRevving]           ,
          [ScoreTriggerOverHarshDeceleration] ,
          [ScoreTriggerOverHarshAccelleration],
          [TermScriptConfigGroup]             ,
          [ConfigurationGroupNameID]          ,
          [ConfigurationGroupName]            ,
          [FuelTypeLookupKey]                 ,
          [EstimateCO2EmissionGramsperKm]     ,
          [UnitTypeLookupKey]                 ,
          BatteryVoltage                      ,
          CurrentDeviceDriverVersion          ,
          LastDeviceDriverUploadDateTime      ,
          LastConfigurationUploadDateTime     ,
          LastDeviceChangeDateTime            ,
          LastEventChangeDateTime             ,
          CreateDateKey                       ,
          IsMeasuringFuel                     ,
          IsCofiguredForMeasuringFuel         ,
          [UTCOffsetKey]                      ,
          [CreateBatchKey]                    ,
          [UpdateBatchKey]
        )
        SELECT
          [VehicleKey]                        ,
          [OrganisationKey]                   ,
          [StartDateKey]                      ,
          [EndDateKey]                        ,
          [IsCurrentRecord]                   ,
          [IsActive]                          ,
          [HostID]                            ,
          [VehicleGUID]                       ,
          [VehicleDescription]                ,
          [SiteGUID]                          ,
          [SiteKey]                           ,
          [LastServiceDateKey]                ,
          [IsYellowEquip]                     ,
          [RegNumber]                         ,
          [ServiceByDistance]                 ,
          [ServiceByDate]                     ,
          [ServiceByEngineSeconds]            ,
          [NextServiceDueDistance]            ,
          [NextServiceDueDateKey]             ,
          [NextServiceDueEngineSeconds]       ,
          [DefaultDriverGUID]                 ,
          [TargetFuelConsumption]             ,
          [TargetFuelConsumptionHourly]       ,
          [ScoreTriggerOverspeeding]          ,
          [ScoreTriggerOverRevving]           ,
          [ScoreTriggerOverHarshDeceleration] ,
          [ScoreTriggerOverHarshAccelleration],
          [TermScriptConfigGroup]             ,
          [ConfigurationGroupNameID]          ,
          [ConfigurationGroupName]            ,
          [FuelTypeLookupKey]                 ,
          [EstimateCO2EmissionGramsperKm]     ,
          [UnitTypeLookupKey]                 ,
          BatteryVoltage                      ,
          CurrentDeviceDriverVersion          ,
          LastDeviceDriverUploadDateTime      ,
          LastConfigurationUploadDateTime     ,
          LastDeviceChangeDateTime            ,
          LastEventChangeDateTime             ,
          CreateDateKey                       ,
          IsMeasuringFuel                     ,
          IsCofiguredForMeasuringFuel         ,
          [UTCOffsetKey]                      ,
          [CreateBatchKey]                    ,
          [UpdateBatchKey]
        FROM
         (
          UPDATE
            [MiXData].[dbo].DIM_Vehicles
          SET
            EndDateKey      = @previousEndDateKey,
            IsCurrentRecord = 0,
            UpdateBatchKey  = @batchKey
          OUTPUT
            DELETED.[VehicleKey]                        ,
            DELETED.[OrganisationKey]                   ,
            DELETED.[StartDateKey]                      ,
            DELETED.[EndDateKey]                        ,
            DELETED.[IsCurrentRecord]                   ,
            DELETED.[IsActive]                          ,
            DELETED.[HostID]                            ,
            DELETED.[VehicleGUID]                       ,
            DELETED.[VehicleDescription]                ,
            DELETED.[SiteGUID]                          ,
            DELETED.[SiteKey]                           ,
            DELETED.[LastServiceDateKey]                ,
            DELETED.[IsYellowEquip]                     ,
            DELETED.[RegNumber]                         ,
            DELETED.[ServiceByDistance]                 ,
            DELETED.[ServiceByDate]                     ,
            DELETED.[ServiceByEngineSeconds]            ,
            DELETED.[NextServiceDueDistance]            ,
            DELETED.[NextServiceDueDateKey]             ,
            DELETED.[NextServiceDueEngineSeconds]       ,
            DELETED.[DefaultDriverGUID]                 ,
            DELETED.[TargetFuelConsumption]             ,
            DELETED.[TargetFuelConsumptionHourly]       ,
            DELETED.[ScoreTriggerOverspeeding]          ,
            DELETED.[ScoreTriggerOverRevving]           ,
            DELETED.[ScoreTriggerOverHarshDeceleration] ,
            DELETED.[ScoreTriggerOverHarshAccelleration],
            DELETED.[TermScriptConfigGroup]             ,
            DELETED.[ConfigurationGroupNameID]          ,
            DELETED.[ConfigurationGroupName]            ,
            DELETED.[FuelTypeLookupKey]                 ,
            DELETED.[EstimateCO2EmissionGramsperKm]     ,
            DELETED.[UnitTypeLookupKey]                 ,

            DELETED.BatteryVoltage                      ,
            DELETED.CurrentDeviceDriverVersion          ,
            DELETED.LastDeviceDriverUploadDateTime      ,
            DELETED.LastConfigurationUploadDateTime     ,
            DELETED.LastDeviceChangeDateTime            ,
            DELETED.LastEventChangeDateTime             ,
            DELETED.CreateDateKey                       ,
            DELETED.IsMeasuringFuel                     ,
            DELETED.IsCofiguredForMeasuringFuel         ,

            DELETED.[UTCOffsetKey]                      ,
            DELETED.[CreateBatchKey]                    ,
            DELETED.[UpdateBatchKey]
          FROM
            [MiXData].[dbo].DIM_Vehicles tar
            INNER JOIN @type2Keys k ON tar.VehicleKey = k.VehicleKey
          ) AS RollBck              -- end update
        WHERE
          UpdateBatchKey < @batchKey; -- end insert

        -- Insert new Records for Type 2 changes
        INSERT INTO [MiXData].[dbo].DIM_Vehicles
        (
          StartDateKey                        ,
          EndDateKey                          ,
          IsCurrentRecord                     ,
          IsActive                            ,
          OrganisationKey                     ,
          HostID                              ,
          [VehicleGUID]                       ,
          [VehicleDescription]                ,
          [SiteGUID]                          ,
          [SiteKey]                           ,
          [LastServiceDateKey]                ,
          [IsYellowEquip]                     ,
          [RegNumber]                         ,
          [ServiceByDistance]                 ,
          [ServiceByDate]                     ,
          [ServiceByEngineSeconds]            ,
          [NextServiceDueDistance]            ,
          [NextServiceDueDateKey]             ,
          [NextServiceDueEngineSeconds]       ,
          [DefaultDriverGUID]                 ,
          [TargetFuelConsumption]             ,
          [TargetFuelConsumptionHourly]       ,
          [ScoreTriggerOverspeeding]          ,
          [ScoreTriggerOverRevving]           ,
          [ScoreTriggerOverHarshDeceleration] ,
          [ScoreTriggerOverHarshAccelleration],
          [TermScriptConfigGroup]             ,
          [ConfigurationGroupNameID]          ,
          [ConfigurationGroupName]            ,
          [FuelTypeLookupKey]                 ,
          [EstimateCO2EmissionGramsperKm]     ,
          [UnitTypeLookupKey]                 ,
          CreateDateKey                       ,
          UTCOffsetKey                        ,
          CreateBatchKey                      ,
          UpdateBatchKey
        )
        SELECT
          @startDateKey                           ,
          @endDateDefault                         ,
          1                                       ,
          stg.IsActive                            ,
          @organisationKey                        ,
          stg.HostID                              ,
          stg.[VehicleGUID]                       ,
          stg.[VehicleDescription]                ,
          stg.[SiteGUID]                          ,
          stg.[SiteKey]                           ,
          stg.[LastServiceDateKey]                ,
          stg.[IsYellowEquip]                     ,
          stg.[RegNumber]                         ,
          stg.[ServiceByDistance]                 ,
          stg.[ServiceByDate]                     ,
          stg.[ServiceByEngineSeconds]            ,
          stg.[NextServiceDueDistance]            ,
          stg.[NextServiceDueDateKey]             ,
          stg.[NextServiceDueEngineSeconds]       ,
          stg.[DefaultDriverGUID]                 ,
          stg.[TargetFuelConsumption]             ,
          stg.[TargetFuelConsumptionHourly]       ,
          ISNULL(stg.[ScoreTriggerOverspeeding]          ,k.[ScoreTriggerOverspeeding]          ),
          ISNULL(stg.[ScoreTriggerOverRevving]           ,k.[ScoreTriggerOverRevving]           ),
          ISNULL(stg.[ScoreTriggerOverHarshDeceleration] ,k.[ScoreTriggerOverHarshDeceleration] ),
          ISNULL(stg.[ScoreTriggerOverHarshAccelleration],k.[ScoreTriggerOverHarshAccelleration]),
          stg.[TermScriptConfigGroup]             ,
          stg.[ConfigurationGroupNameID]          ,
          stg.[ConfigurationGroupName]            ,
          stg.[FuelTypeLookupKey]                 ,
          stg.[EstimateCO2EmissionGramsperKm]     ,
          ISNULL(stg.[UnitTypeLookupKey]          ,-1),
          stg.CreateDateKey                       ,
          @UTCOffsetKey                           ,
          @batchKey                               ,
          @batchKey
        FROM
          [StageUser1].STAGE_DIM_Vehicles stg
          INNER JOIN @type2Keys k ON stg.HostID = k.HostID;
        SET @recordsType2Inserted += @@ROWCOUNT;

        IF @debugMode = 1
          PRINT '    after type 2 rowcount=' + CONVERT(nchar(5), @rowcount) + '; inserted=' +  CONVERT(nchar(5), @recordsInserted) + '; type2inserted=' +  CONVERT(nchar(5), @recordsType2Inserted) + ';updated=' +  CONVERT(nchar(5), @recordsUpdated) + ';'

      END TRY
      -- CATCH Errors
      BEGIN CATCH
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
      END CATCH;

      SELECT
        @startDate = ISNULL(MIN(ChangeDate), @endDateDefault)
      FROM
        [StageUser1].Vehicles
      WHERE
        ChangeDate >= @endDate;
    
    END -- END WHILE

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='1. Loop through and apply latest changes + type 2 changes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 1. Loop through and apply latest changes + type 2 changes';
    END;

  --------------------------------------------------------------------
  -- 6.1 Update Type 1 columns on DW
  --------------------------------------------------------------------
  BEGIN TRY

    -- only need to stage keys and type1 columns
    TRUNCATE TABLE [StageUser1].STAGE_DIM_Vehicles;
    ;WITH Latest (RID) AS
    (
      SELECT
        MAX(RID)
      FROM
        [StageUser1].Vehicles WITH (NOLOCK)
      GROUP BY
        iVehicleID,
        VehicleGUID
    )
    INSERT INTO [StageUser1].[STAGE_DIM_Vehicles]
    (
      [HostID]                    ,
      [VehicleGUID]               ,
      [VehicleDescription]        , 
      [RegNumber]                 , 
      [ServiceByDistance]         , 
      [ServiceByDate]             , 
      [ServiceByEngineSeconds]    , 
      [NextServiceDueDistance]    , 
      [NextServiceDueDateKey]     , 
      [NextServiceDueEngineSeconds], 
      [TargetFuelConsumption]     ,
      [TargetFuelConsumptionHourly],
      [EstimateCO2EmissionGramsperKm],
      [ConfigurationGroupNameID]  , 
      [ConfigurationGroupName]    ,
      [IsActive]
    )
    SELECT
      s.iVehicleID                       ,
      s.VehicleGUID                      ,
      s.sDesc                            ,
      s.sRegNo                           ,
      s.fServiceKm                       ,
      s.ucServiceMonths                  ,
      ISNULL(s.liServiceSeconds,0)/60    ,
      s.fNextServiceKm                   ,
      CONVERT(DATE,s.dtNextServiceDate)  ,
      ISNULL(s.liNextServiceSeconds,0)/60,
      s.fTargetConsumption               ,
      s.fTargetHourlyConsumption         ,
      s.fTargetConsumption * 2321.0      ,  
      s.liGroupID                        ,
      ISNULL(vc.sName,'')                ,
      s.bActive
    FROM
      Latest l 
        INNER JOIN
      [StageUser1].Vehicles      s  WITH (NOLOCK) ON s.RID       = l.RID
        LEFT OUTER JOIN
      [StageUser1].VehicleConfig vc WITH (NOLOCK) ON s.liGroupID = vc.liGroupID;

    INSERT INTO [StageUser1].[ROLLBACK_DIM_Vehicles]
    ( 
      [VehicleKey]                        ,
      [OrganisationKey]                   ,
      [StartDateKey]                      ,
      [EndDateKey]                        ,
      [IsCurrentRecord]                   ,
      [IsActive]                          ,
      [HostID]                            ,
      [VehicleGUID]                       ,
      [VehicleDescription]                ,
      [SiteGUID]                          ,
      [SiteKey]                           ,
      [LastServiceDateKey]                ,
      [IsYellowEquip]                     ,
      [RegNumber]                         ,
      [ServiceByDistance]                 ,
      [ServiceByDate]                     ,
      [ServiceByEngineSeconds]            ,
      [NextServiceDueDistance]            ,
      [NextServiceDueDateKey]             ,
      [NextServiceDueEngineSeconds]       ,
      [DefaultDriverGUID]                 ,
      [TargetFuelConsumption]             ,
      [TargetFuelConsumptionHourly]       ,
      [ScoreTriggerOverspeeding]          ,
      [ScoreTriggerOverRevving]           ,
      [ScoreTriggerOverHarshDeceleration] ,
      [ScoreTriggerOverHarshAccelleration],
      [TermScriptConfigGroup]             ,
      [ConfigurationGroupNameID]          ,
      [ConfigurationGroupName]            ,
      [FuelTypeLookupKey]                 ,
      [EstimateCO2EmissionGramsperKm]     ,
      [UnitTypeLookupKey]                 ,
      BatteryVoltage                      ,
      CurrentDeviceDriverVersion          ,
      LastDeviceDriverUploadDateTime      ,
      LastConfigurationUploadDateTime     ,
      LastDeviceChangeDateTime            ,
      LastEventChangeDateTime             ,
      CreateDateKey                       ,
      IsMeasuringFuel                     ,
      IsCofiguredForMeasuringFuel         ,
      [UTCOffsetKey]                      ,
      [CreateBatchKey]                    ,
      [UpdateBatchKey]
    )
    SELECT
      [VehicleKey]                        ,
      [OrganisationKey]                   ,
      [StartDateKey]                      ,
      [EndDateKey]                        ,
      [IsCurrentRecord]                   ,
      [IsActive]                          ,
      [HostID]                            ,
      [VehicleGUID]                       ,
      [VehicleDescription]                ,
      [SiteGUID]                          ,
      [SiteKey]                           ,
      [LastServiceDateKey]                ,
      [IsYellowEquip]                     ,
      [RegNumber]                         ,
      [ServiceByDistance]                 ,
      [ServiceByDate]                     ,
      [ServiceByEngineSeconds]            ,
      [NextServiceDueDistance]            ,
      [NextServiceDueDateKey]             ,
      [NextServiceDueEngineSeconds]       ,
      [DefaultDriverGUID]                 ,
      [TargetFuelConsumption]             ,
      [TargetFuelConsumptionHourly]       ,
      [ScoreTriggerOverspeeding]          ,
      [ScoreTriggerOverRevving]           ,
      [ScoreTriggerOverHarshDeceleration] ,
      [ScoreTriggerOverHarshAccelleration],
      [TermScriptConfigGroup]             ,
      [ConfigurationGroupNameID]          ,
      [ConfigurationGroupName]            ,
      [FuelTypeLookupKey]                 ,
      [EstimateCO2EmissionGramsperKm]     ,
      [UnitTypeLookupKey]                 ,
      BatteryVoltage                      ,
      CurrentDeviceDriverVersion          ,
      LastDeviceDriverUploadDateTime      ,
      LastConfigurationUploadDateTime     ,
      LastDeviceChangeDateTime            ,
      LastEventChangeDateTime             ,
      CreateDateKey                       ,
      IsMeasuringFuel                     ,
      IsCofiguredForMeasuringFuel         ,
      [UTCOffsetKey]                      ,
      [CreateBatchKey]                    ,
      [UpdateBatchKey]
    FROM 
     (UPDATE tar
      SET
        [VehicleDescription]         = stg.[VehicleDescription]       ,
        [RegNumber]                  = stg.[RegNumber]                ,
        [ServiceByDistance]          = stg.[ServiceByDistance]        ,
        [ServiceByDate]              = stg.[ServiceByDate]            ,
        [ServiceByEngineSeconds]     = stg.[ServiceByEngineSeconds]   ,
        [NextServiceDueDistance]     = stg.[NextServiceDueDistance]   ,
        [NextServiceDueDateKey]      = stg.[NextServiceDueDateKey]    ,
        [NextServiceDueEngineSeconds]= stg.[NextServiceDueEngineSeconds],
        [TargetFuelConsumption]      = stg.[TargetFuelConsumption]    ,
        [TargetFuelConsumptionHourly]= stg.[TargetFuelConsumptionHourly],
        [ConfigurationGroupNameID]   = stg.[ConfigurationGroupNameID] ,       
        [ConfigurationGroupName]     = stg.[ConfigurationGroupName]   ,       
        [EstimateCO2EmissionGramsperKm] = stg.[EstimateCO2EmissionGramsperKm],
        UpdateBatchKey               = @batchKey
      OUTPUT
        DELETED.[VehicleKey]                        ,
        DELETED.[OrganisationKey]                   ,
        DELETED.[StartDateKey]                      ,
        DELETED.[EndDateKey]                        ,
        DELETED.[IsCurrentRecord]                   ,
        DELETED.[IsActive]                          ,
        DELETED.[HostID]                            ,
        DELETED.[VehicleGUID]                       ,
        DELETED.[VehicleDescription]                ,
        DELETED.[SiteGUID]                          ,
        DELETED.[SiteKey]                           ,
        DELETED.[LastServiceDateKey]                ,
        DELETED.[IsYellowEquip]                     ,
        DELETED.[RegNumber]                         ,
        DELETED.[ServiceByDistance]                 ,
        DELETED.[ServiceByDate]                     ,
        DELETED.[ServiceByEngineSeconds]            ,
        DELETED.[NextServiceDueDistance]            ,
        DELETED.[NextServiceDueDateKey]             ,
        DELETED.[NextServiceDueEngineSeconds]       ,
        DELETED.[DefaultDriverGUID]                 ,
        DELETED.[TargetFuelConsumption]             ,
        DELETED.[TargetFuelConsumptionHourly]       ,
        DELETED.[ScoreTriggerOverspeeding]          ,
        DELETED.[ScoreTriggerOverRevving]           ,
        DELETED.[ScoreTriggerOverHarshDeceleration] ,
        DELETED.[ScoreTriggerOverHarshAccelleration],
        DELETED.[TermScriptConfigGroup]             ,
        DELETED.[ConfigurationGroupNameID]          ,
        DELETED.[ConfigurationGroupName]            ,
        DELETED.[FuelTypeLookupKey]                 ,
        DELETED.[EstimateCO2EmissionGramsperKm]     ,
        DELETED.[UnitTypeLookupKey]                 ,
        DELETED.BatteryVoltage                      ,
        DELETED.CurrentDeviceDriverVersion          ,
        DELETED.LastDeviceDriverUploadDateTime      ,
        DELETED.LastConfigurationUploadDateTime     ,
        DELETED.LastDeviceChangeDateTime            ,
        DELETED.LastEventChangeDateTime             ,
        DELETED.CreateDateKey                       ,
        DELETED.IsMeasuringFuel                     ,
        DELETED.IsCofiguredForMeasuringFuel         ,
        DELETED.[UTCOffsetKey]                      ,
        DELETED.[CreateBatchKey]                    ,
        DELETED.[UpdateBatchKey]
      FROM
        [MiXData].dbo.DIM_Vehicles tar
          INNER JOIN
        [StageUser1].STAGE_DIM_Vehicles stg ON tar.OrganisationKey          = @organisationKey
                                          AND tar.HostID                   = stg.HostID
    ) rllbck
    WHERE
      UpdateBatchKey < @batchKey;

    SET @recordsUpdated += @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.1 Update Type 1 columns on DW', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.1 Update Type 1 columns on DW';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6.2 Update IsCurrentRecord columns on DW
  --------------------------------------------------------------------
  BEGIN TRY

    TRUNCATE TABLE [StageUser1].STAGE_DIM_Vehicles;
    
    -- insert all records that would be affected
    INSERT INTO [StageUser1].STAGE_DIM_Vehicles
    ( HostID )
    SELECT DISTINCT
      iVehicleID
    FROM
      [StageUser1].Vehicles
    UNION
    SELECT DISTINCT
      iVehicleID         = s.liObjectID
    FROM
      [StageUser1].[ExtensionProperties_FACT] s WITH (NOLOCK)
    WHERE 
        s.sAppID    = 'FMSchedulerPro'
    AND s.sProperty = 'VehicleStatus'
    UNION
    SELECT DISTINCT
      iVehicleID
    FROM
      [StageUser1].VehicleDeviceProperties vdp WITH (NOLOCK)
    UNION
    SELECT DISTINCT
      iVehicleID
    FROM
      [StageUser1].VehicleDevices vd
    UNION
    SELECT DISTINCT
      iVehicleID
    FROM
      [StageUser1].VehicleDeviceParam vdm
    UNION
    SELECT DISTINCT
      iVehicleID
    FROM
      [StageUser1].VehicleEvent ve
    UNION
    SELECT DISTINCT
      iVehicleID
    FROM
      [StageUser1].VehicleTriggers vt
    UNION
    SELECT DISTINCT vd.iVehicleID
    FROM -- select top 20 * from
      [StageUser1].[Param]        p
        INNER JOIN
      audit.VehicleDevices_CT     vd  ON vd.OrganisationKey  = @organisationKey
        INNER JOIN
      audit.VehicleDeviceParam_CT vdp ON vdp.OrganisationKey = vd.OrganisationKey
                                     AND vdp.iVehicleID      = vd.iVehicleID
                                     AND vdp.liDeviceID      = vd.liDeviceID
                                     AND vdp.iParameterID    = p.iParameterID
    WHERE p.bFuelCounter = 1;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.1 Update IsCurrentRecord columns on DW - Identification', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.1 Update IsCurrentRecord columns on DW - Identification';
    END;

    ------------------------------------------
    -- Update IsCurrent columns
    ------------------------------------------
    
    ------------------------------------------
    -- BatteryVoltage
    ;WITH VehicleStatus AS
    (
      SELECT
        VehicleID         = s.liObjectID,
        RetrievedDateTime = CONVERT(DATETIME,dbo.fncGetListItemFloat(ISNULL(s.sValue,''),'Retrieved',0)),
        BatteryVoltage    = dbo.fncGetListItemFloat(ISNULL(s.sValue,''),'BatVoltage',0)
      FROM
        [StageUser1].[ExtensionProperties_FACT] s WITH (NOLOCK)
      WHERE 
          s.sAppID    = 'FMSchedulerPro'
      AND s.sProperty = 'VehicleStatus'
    ),
    LastVehicleStatus AS
    (
      SELECT
        VehicleID,
        LastRetrievedDateTime = MAX(RetrievedDateTime)
      FROM
        VehicleStatus
      GROUP BY
        VehicleID
    )
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET
      BatteryVoltage = CASE
                         WHEN vs.BatteryVoltage > 1000000.0  -- 1kV
                           THEN 1000000.0
                         ELSE
                           vs.BatteryVoltage
                       END
    FROM
      [StageUser1].[STAGE_DIM_Vehicles] stg
        INNER JOIN
      LastVehicleStatus                lvs ON lvs.VehicleID = stg.HostID
        INNER JOIN
      VehicleStatus                    vs  ON vs.VehicleID         = lvs.VehicleID
                                          AND vs.RetrievedDateTime = LastRetrievedDateTime;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.2 Update IsCurrentRecord columns on DW - BatteryVoltage', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.2 Update IsCurrentRecord columns on DW - BatteryVoltage';
    END;

    ------------------------------------------
    -- CurrentDeviceDriverVersion
    ;WITH LastestVehicleDeviceProperties AS
    (
      SELECT
        MaxRID = MAX(RID)
      FROM
        [StageUser1].VehicleDeviceProperties
      WHERE
          liDeviceID  = 0
      AND sProperty   = 'DriverSetVersion'
      GROUP BY
        iVehicleID    
    )
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET
      CurrentDeviceDriverVersion = ISNULL(vdp.sValue,'')
    FROM
      [StageUser1].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      [StageUser1].VehicleDeviceProperties vdp WITH (NOLOCK) ON vdp.iVehicleID  = stg.HostID
                                                           AND vdp.liDeviceID  = 0
                                                           AND vdp.sProperty   = 'DriverSetVersion'
        INNER JOIN
      LastestVehicleDeviceProperties       lvdp              ON lvdp.MaxRID    = vdp.RID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.3 Update IsCurrentRecord columns on DW - CurrentDeviceDriverVersion', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.3 Update IsCurrentRecord columns on DW - CurrentDeviceDriverVersion';
    END;

    ------------------------------------------
    -- LastDeviceDriverUploadDateTime
    ;WITH LastestVehicleDeviceProperties AS
    (
      SELECT
        MaxRID = MAX(RID)
      FROM
        [StageUser1].VehicleDeviceProperties
      WHERE
          liDeviceID  = 0
      AND sProperty   = 'DriverSetLoadDate'
      GROUP BY
        iVehicleID    
    )
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET
      LastDeviceDriverUploadDateTime = DATEADD(s,CONVERT(INT,vdp.sValue),'19700101')
    FROM
      [StageUser1].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      [StageUser1].VehicleDeviceProperties vdp WITH (NOLOCK) ON vdp.iVehicleID  = stg.HostID
                                                           AND vdp.liDeviceID  = 0
                                                           AND vdp.sProperty   = 'DriverSetLoadDate'
        INNER JOIN
      LastestVehicleDeviceProperties       lvdp              ON lvdp.MaxRID    = vdp.RID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.4 Update IsCurrentRecord columns on DW - LastDeviceDriverUploadDateTime', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.4 Update IsCurrentRecord columns on DW - LastDeviceDriverUploadDateTime';
    END;

    ------------------------------------------
    -- LastConfigurationUploadDateTime
    ;WITH LastestVehicleDeviceProperties AS
    (
      SELECT
        MaxRID = MAX(RID)
      FROM
        [StageUser1].VehicleDeviceProperties
      WHERE
          liDeviceID  = 0
      AND sProperty   = 'LastConfig'
      GROUP BY
        iVehicleID    
    )
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET
      LastConfigurationUploadDateTime = DATEADD(s,CONVERT(INT,vdp.sValue),'19700101')
    FROM
      [StageUser1].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      [StageUser1].VehicleDeviceProperties vdp WITH (NOLOCK) ON vdp.iVehicleID  = stg.HostID
                                                           AND vdp.liDeviceID  = 0
                                                           AND vdp.sProperty   = 'LastConfig'
        INNER JOIN
      LastestVehicleDeviceProperties       lvdp              ON lvdp.MaxRID    = vdp.RID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.5 Update IsCurrentRecord columns on DW - LastConfigurationUploadDateTime', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.5 Update IsCurrentRecord columns on DW - LastConfigurationUploadDateTime';
    END;

    ------------------------------------------
    -- LastDeviceChangeDateTime
    ;WITH AllLastDeviceChangeDates AS
    (
      SELECT
        vdp.iVehicleID,
        MaxChangeDate = MAX(vdp.ChangeDate)
      FROM
        [StageUser1].VehicleDeviceProperties vdp
      WHERE 
        vdp.sProperty NOT IN ('LastConfig','DriverSetLoadDate','DriverSetVersion')
      GROUP BY
        vdp.iVehicleID
      UNION
      SELECT
        vd.iVehicleID,
        MaxChangeDate = MAX(vd.ChangeDate)
      FROM
        [StageUser1].VehicleDevices vd
      GROUP BY
        vd.iVehicleID
      UNION
      SELECT
        vdm.iVehicleID,
        MaxChangeDate = MAX(vdm.ChangeDate)
      FROM
        [StageUser1].VehicleDeviceParam vdm
      GROUP BY
        vdm.iVehicleID
    ),
    LastDeviceChangeDates AS
    (
      SELECT
        iVehicleID,
        MaxChangeDate = MAX(MaxChangeDate)
      FROM
        AllLastDeviceChangeDates
      GROUP BY
        iVehicleID
    )
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET
      LastDeviceChangeDateTime = ldc.MaxChangeDate
    FROM
      [StageUser1].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      LastDeviceChangeDates               ldc WITH (NOLOCK) ON ldc.iVehicleID  = stg.HostID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.6 Update IsCurrentRecord columns on DW - LastDeviceChangeDateTime', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.6 Update IsCurrentRecord columns on DW - LastDeviceChangeDateTime';
    END;

    ------------------------------------------
    -- LastEventChangeDateTime
    ;WITH AllLastEventChangeDates AS
    (
      SELECT
        ve.iVehicleID,
        MaxChangeDate = MAX(ve.ChangeDate)
      FROM
        [StageUser1].VehicleEvent ve
      GROUP BY
        ve.iVehicleID
      UNION
      SELECT
        vt.iVehicleID,
        MaxChangeDate = MAX(vt.ChangeDate)
      FROM
        [StageUser1].VehicleTriggers vt
      GROUP BY
        vt.iVehicleID
    ),
    LastEventChangeDates AS
    (
      SELECT
        iVehicleID,
        MaxChangeDate = MAX(MaxChangeDate)
      FROM
        AllLastEventChangeDates
      GROUP BY
        iVehicleID
    )
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET
      LastEventChangeDateTime = lec.MaxChangeDate
    FROM
      [StageUser1].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      LastEventChangeDates                lec WITH (NOLOCK) ON lec.iVehicleID  = stg.HostID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.7 Update IsCurrentRecord columns on DW - LastEventChangeDateTime', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.7 Update IsCurrentRecord columns on DW - LastEventChangeDateTime';
    END;

    ------------------------------------------
    -- IsMeasuringFuel
    ;WITH ActivityData AS
    (
      SELECT
        td.VehicleID,
        MaxLitres = MAX(std.Litres)
      FROM
        [StageUser1].TripData    td  WITH (NOLOCK)
          INNER JOIN
        [StageUser1].SubTripData std WITH (NOLOCK) ON std.TripID = td.TripID
      GROUP BY
        td.VehicleID
    )
    UPDATE
      [StageUser1].[STAGE_DIM_Vehicles]
    SET
      IsMeasuringFuel = CASE
                          WHEN MaxLitres IS NULL
                            THEN 0
                          ELSE 1
                        END
    FROM
      [StageUser1].[STAGE_DIM_Vehicles]    stg
        INNER JOIN
      ActivityData                        ad  ON ad.VehicleID  = stg.HostID;


    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.8 Update IsCurrentRecord columns on DW - IsMeasuringFuel', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.8 Update IsCurrentRecord columns on DW - IsMeasuringFuel';
    END;

    ------------------------------------------
    -- IsCofiguredForMeasuringFuel
    DECLARE @Param TABLE (iParameterID INT PRIMARY KEY);
    DECLARE @VehicleDeviceParam TABLE
    (iVehicleID INT,liDeviceID INT,iParameterID INT,
    PRIMARY KEY (iVehicleID,liDeviceID,iParameterID));

    ;WITH AllParams AS
    (
      SELECT
        RID = HostRID,
        iParameterID
      FROM
        audit.Param_CT WITH (NOLOCK)
      WHERE OrganisationKey = @organisationKey
      UNION
      SELECT
        RID,
        iParameterID
      FROM
        [StageUser1].Param WITH (NOLOCK)
    ),
    LastestParams (RID) AS
    (
      SELECT
        MAX(RID)
      FROM AllParams
      GROUP BY
        iParameterID
    )
    INSERT INTO @Param
    SELECT
      p.iParameterID
    FROM
      audit.Param_CT p  WITH (NOLOCK)
        INNER JOIN
      LastestParams  lp ON p.OrganisationKey = @organisationKey
                       AND lp.RID            = p.HostRID
    WHERE
        p.bFuelCounter = 1
    AND p.Operation    <> 'D'
    UNION
    SELECT
      p.iParameterID
    FROM
      [StageUser1].Param p  WITH (NOLOCK)
        INNER JOIN
      LastestParams  lp ON lp.RID = p.RID
    WHERE
        p.bFuelCounter = 1
    AND p.Operation    <> 'D';

    ;WITH AllVehicleDeviceParams AS
    (
      SELECT
        RID = vdp.HostRID,
        vdp.iVehicleID,
        vdp.liDeviceID,
        vdp.iParameterID
      FROM
        @Param                      p
          INNER JOIN
        audit.VehicleDeviceParam_CT vdp WITH (NOLOCK) ON vdp.OrganisationKey = @organisationKey
                                                     AND vdp.iParameterID    = p.iParameterID
      UNION
      SELECT
        vdp.RID,
        vdp.iVehicleID,
        vdp.liDeviceID,
        vdp.iParameterID
      FROM
        @Param                          p
          INNER JOIN
        [StageUser1].VehicleDeviceParam vdp WITH (NOLOCK) ON vdp.iParameterID = p.iParameterID
    ),
    LastestVehicleDeviceParams (RID) AS
    (
      SELECT
        MAX(RID)
      FROM AllVehicleDeviceParams
      GROUP BY
        iVehicleID,
        liDeviceID,
        iParameterID
    )
    INSERT INTO @VehicleDeviceParam
    (iVehicleID, liDeviceID, iParameterID)
    SELECT vdp.iVehicleID, vdp.liDeviceID, vdp.iParameterID
    FROM
      LastestVehicleDeviceParams  lvdp
        inner join
      audit.VehicleDeviceParam_CT vdp WITH (NOLOCK) ON vdp.OrganisationKey = @organisationKey
                                                   AND vdp.HostRID         = lvdp.RID
    WHERE vdp.Operation <> 'D'
    UNION
    SELECT vdp.iVehicleID, vdp.liDeviceID, vdp.iParameterID
    FROM
      LastestVehicleDeviceParams  lvdp
        inner join
      [StageUser1].VehicleDeviceParam vdp WITH (NOLOCK) ON vdp.RID         = lvdp.RID
    WHERE vdp.Operation <> 'D';

    ;WITH AllVehicleDevices AS
    (
      SELECT
        RID = vd.HostRID,
        vd.iVehicleID,
        vd.liDeviceID
      FROM
        @VehicleDeviceParam     vdp
          INNER JOIN
        audit.VehicleDevices_CT vd  WITH (NOLOCK) ON vd.OrganisationKey  = @organisationKey
                                                 AND vdp.iVehicleID      = vd.iVehicleID
                                                 AND vdp.liDeviceID      = vd.liDeviceID
      UNION
      SELECT
        vd.RID,
        vd.iVehicleID,
        vd.liDeviceID
      FROM
        @VehicleDeviceParam     vdp
          INNER JOIN
        [StageUser1].VehicleDevices vd  WITH (NOLOCK) ON vdp.iVehicleID  = vd.iVehicleID
                                                     AND vdp.liDeviceID  = vd.liDeviceID
    ),
    LastestVehicleDevices (RID) AS
    (
      SELECT
        MAX(RID)
      FROM AllVehicleDevices
      GROUP BY
        iVehicleID,
        liDeviceID
    ),
    VehiclesWithConfiguredFuelDevices AS
    (
      SELECT vd.iVehicleID --, vd.liDeviceID, vd.sInputID,vd.bIsActive
      FROM
        LastestVehicleDevices   lvd
          inner join
        audit.VehicleDevices_CT vd  WITH (NOLOCK) ON vd.OrganisationKey = @organisationKey
                                                 AND vd.HostRID         = lvd.RID
      WHERE
          vd.Operation <> 'D'
      AND vd.bIsActive = 1
      AND vd.sInputID  IS NOT NULL
      UNION
      SELECT vd.iVehicleID --, vd.liDeviceID, vd.sInputID,vd.bIsActive
      FROM
        LastestVehicleDevices       lvd
          inner join
        [StageUser1].VehicleDevices vd  WITH (NOLOCK) ON vd.RID   = lvd.RID
      WHERE
          vd.Operation <> 'D'
      AND vd.bIsActive = 1
      AND vd.sInputID  IS NOT NULL
    )
    UPDATE
      stg
    SET IsCofiguredForMeasuringFuel = 1
    FROM
      [StageUser1].STAGE_DIM_Vehicles   stg
        INNER JOIN
      VehiclesWithConfiguredFuelDevices vfd ON vfd.iVehicleID = stg.HostID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2.9 Update IsCurrentRecord columns on DW - IsCofiguredForMeasuringFuel', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2.9 Update IsCurrentRecord columns on DW - IsCofiguredForMeasuringFuel';
    END;

    -- UPDATE IsCurrentRecords
    INSERT INTO [StageUser1].[ROLLBACK_DIM_Vehicles]
    ( 
      [VehicleKey]                        ,
      [OrganisationKey]                   ,
      [StartDateKey]                      ,
      [EndDateKey]                        ,
      [IsCurrentRecord]                   ,
      [IsActive]                          ,
      [HostID]                            ,
      [VehicleGUID]                       ,
      [VehicleDescription]                ,
      [SiteGUID]                          ,
      [SiteKey]                           ,
      [LastServiceDateKey]                ,
      [IsYellowEquip]                     ,
      [RegNumber]                         ,
      [ServiceByDistance]                 ,
      [ServiceByDate]                     ,
      [ServiceByEngineSeconds]            ,
      [NextServiceDueDistance]            ,
      [NextServiceDueDateKey]             ,
      [NextServiceDueEngineSeconds]       ,
      [DefaultDriverGUID]                 ,
      [TargetFuelConsumption]             ,
      [TargetFuelConsumptionHourly]       ,
      [ScoreTriggerOverspeeding]          ,
      [ScoreTriggerOverRevving]           ,
      [ScoreTriggerOverHarshDeceleration] ,
      [ScoreTriggerOverHarshAccelleration],
      [TermScriptConfigGroup]             ,
      [ConfigurationGroupNameID]          ,
      [ConfigurationGroupName]            ,
      [FuelTypeLookupKey]                 ,
      [EstimateCO2EmissionGramsperKm]     ,
      [UnitTypeLookupKey]                 ,
      BatteryVoltage                      ,
      CurrentDeviceDriverVersion          ,
      LastDeviceDriverUploadDateTime      ,
      LastConfigurationUploadDateTime     ,
      LastDeviceChangeDateTime            ,
      LastEventChangeDateTime             ,
      CreateDateKey                       ,
      IsMeasuringFuel                     ,
      IsCofiguredForMeasuringFuel         ,
      [UTCOffsetKey]                      ,
      [CreateBatchKey]                    ,
      [UpdateBatchKey]
    )
    SELECT
      [VehicleKey]                        ,
      [OrganisationKey]                   ,
      [StartDateKey]                      ,
      [EndDateKey]                        ,
      [IsCurrentRecord]                   ,
      [IsActive]                          ,
      [HostID]                            ,
      [VehicleGUID]                       ,
      [VehicleDescription]                ,
      [SiteGUID]                          ,
      [SiteKey]                           ,
      [LastServiceDateKey]                ,
      [IsYellowEquip]                     ,
      [RegNumber]                         ,
      [ServiceByDistance]                 ,
      [ServiceByDate]                     ,
      [ServiceByEngineSeconds]            ,
      [NextServiceDueDistance]            ,
      [NextServiceDueDateKey]             ,
      [NextServiceDueEngineSeconds]       ,
      [DefaultDriverGUID]                 ,
      [TargetFuelConsumption]             ,
      [TargetFuelConsumptionHourly]       ,
      [ScoreTriggerOverspeeding]          ,
      [ScoreTriggerOverRevving]           ,
      [ScoreTriggerOverHarshDeceleration] ,
      [ScoreTriggerOverHarshAccelleration],
      [TermScriptConfigGroup]             ,
      [ConfigurationGroupNameID]          ,
      [ConfigurationGroupName]            ,
      [FuelTypeLookupKey]                 ,
      [EstimateCO2EmissionGramsperKm]     ,
      [UnitTypeLookupKey]                 ,
      BatteryVoltage                      ,
      CurrentDeviceDriverVersion          ,
      LastDeviceDriverUploadDateTime      ,
      LastConfigurationUploadDateTime     ,
      LastDeviceChangeDateTime            ,
      LastEventChangeDateTime             ,
      CreateDateKey                       ,
      IsMeasuringFuel                     ,
      IsCofiguredForMeasuringFuel         ,
      [UTCOffsetKey]                      ,
      [CreateBatchKey]                    ,
      [UpdateBatchKey]
    FROM 
     (UPDATE tar
      SET
        BatteryVoltage                  = ISNULL(stg.BatteryVoltage                 ,tar.BatteryVoltage                 ),
        CurrentDeviceDriverVersion      = ISNULL(stg.CurrentDeviceDriverVersion     ,tar.CurrentDeviceDriverVersion     ),
        LastDeviceDriverUploadDateTime  = ISNULL(stg.LastDeviceDriverUploadDateTime ,tar.LastDeviceDriverUploadDateTime ),
        LastConfigurationUploadDateTime = ISNULL(stg.LastConfigurationUploadDateTime,tar.LastConfigurationUploadDateTime),
        LastDeviceChangeDateTime        = ISNULL(stg.LastDeviceChangeDateTime       ,tar.LastDeviceChangeDateTime       ),
        LastEventChangeDateTime         = ISNULL(stg.LastEventChangeDateTime        ,tar.LastEventChangeDateTime        ),
        IsMeasuringFuel                 = ISNULL(stg.IsMeasuringFuel                ,ISNULL(tar.IsMeasuringFuel,0)      ),
        IsCofiguredForMeasuringFuel     = ISNULL(stg.IsCofiguredForMeasuringFuel    ,ISNULL(tar.IsCofiguredForMeasuringFuel,0)),
        UpdateBatchKey                  = @batchKey
      OUTPUT
        DELETED.[VehicleKey]                        ,
        DELETED.[OrganisationKey]                   ,
        DELETED.[StartDateKey]                      ,
        DELETED.[EndDateKey]                        ,
        DELETED.[IsCurrentRecord]                   ,
        DELETED.[IsActive]                          ,
        DELETED.[HostID]                            ,
        DELETED.[VehicleGUID]                       ,
        DELETED.[VehicleDescription]                ,
        DELETED.[SiteGUID]                          ,
        DELETED.[SiteKey]                           ,
        DELETED.[LastServiceDateKey]                ,
        DELETED.[IsYellowEquip]                     ,
        DELETED.[RegNumber]                         ,
        DELETED.[ServiceByDistance]                 ,
        DELETED.[ServiceByDate]                     ,
        DELETED.[ServiceByEngineSeconds]            ,
        DELETED.[NextServiceDueDistance]            ,
        DELETED.[NextServiceDueDateKey]             ,
        DELETED.[NextServiceDueEngineSeconds]       ,
        DELETED.[DefaultDriverGUID]                 ,
        DELETED.[TargetFuelConsumption]             ,
        DELETED.[TargetFuelConsumptionHourly]       ,
        DELETED.[ScoreTriggerOverspeeding]          ,
        DELETED.[ScoreTriggerOverRevving]           ,
        DELETED.[ScoreTriggerOverHarshDeceleration] ,
        DELETED.[ScoreTriggerOverHarshAccelleration],
        DELETED.[TermScriptConfigGroup]             ,
        DELETED.[ConfigurationGroupNameID]          ,
        DELETED.[ConfigurationGroupName]            ,
        DELETED.[FuelTypeLookupKey]                 ,
        DELETED.[EstimateCO2EmissionGramsperKm]     ,
        DELETED.[UnitTypeLookupKey]                 ,
        DELETED.BatteryVoltage                      ,
        DELETED.CurrentDeviceDriverVersion          ,
        DELETED.LastDeviceDriverUploadDateTime      ,
        DELETED.LastConfigurationUploadDateTime     ,
        DELETED.LastDeviceChangeDateTime            ,
        DELETED.LastEventChangeDateTime             ,
        DELETED.CreateDateKey                       ,
        DELETED.IsMeasuringFuel                     ,
        DELETED.IsCofiguredForMeasuringFuel         ,
        DELETED.[UTCOffsetKey]                      ,
        DELETED.[CreateBatchKey]                    ,
        DELETED.[UpdateBatchKey]
      FROM
        [MiXData].dbo.DIM_Vehicles tar
          INNER JOIN
        [StageUser1].STAGE_DIM_Vehicles stg ON tar.OrganisationKey          = @organisationKey
                                          AND tar.HostID                   = stg.HostID
                                          AND tar.IsCurrentRecord          = 1
    ) rllbck
    WHERE
      UpdateBatchKey < @batchKey;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6.2 Update IsCurrentRecord columns on DW', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6.2 Update IsCurrentRecord columns on DW';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_DIM_Vehicles];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT
    @recordsInserted      RecordsInserted,
    @recordsType2Inserted RecordsType2Inserted,
    @recordsUpdated       RecordsUpdated,
    @recordsDeleted       RecordsDeleted;

  IF @debugMode = 1  -- DebugMode is true  
  BEGIN  
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set  
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 8. Return values for Performance Monitoring';  
  END;  
   
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDriverCertifications_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDriverCertifications_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].DriverCertifications_CT  AS tar
      USING [StageUser1].DriverCertifications AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate           = stg.ChangeDate          ,
            tar.Operation            = stg.Operation           ,
            tar.UpdateMask           = stg.UpdateMask          ,
            tar.ChangeVersion        = stg.ChangeVersion       ,
            tar.iDriverID            = stg.iDriverID           ,
            tar.liCertificationID    = stg.liCertificationID   ,
            tar.dtObtained           = stg.dtObtained          ,
            tar.sInstructor          = stg.sInstructor         ,
            tar.bInstructorQualified = stg.bInstructorQualified,
            tar.sLocation            = stg.sLocation           ,
            tar.UpdateBatchKey       = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey     ,
            HostRID             ,
            ChangeDate          ,
            Operation           ,
            UpdateMask          ,
            ChangeVersion       ,
            iDriverID           ,
            liCertificationID   ,
            dtObtained          ,
            sInstructor         ,
            bInstructorQualified,
            sLocation           ,
            CreateBatchKey      ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey        ,
            stg.RID                 ,
            stg.ChangeDate          ,
            stg.Operation           ,
            stg.UpdateMask          ,
            stg.ChangeVersion       ,
            stg.iDriverID           ,
            stg.liCertificationID   ,
            stg.dtObtained          ,
            stg.sInstructor         ,
            stg.bInstructorQualified,
            stg.sLocation           ,
            @batchKey               ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDriverLicences_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDriverLicences_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].DriverLicences_CT  AS tar
      USING [StageUser1].DriverLicences AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iDriverID      = stg.iDriverID    ,
            tar.liLicenceID    = stg.liLicenceID  ,
            tar.dtObtained     = stg.dtObtained   ,
            tar.dtExpires      = stg.dtExpires    ,
            tar.UpdateBatchKey = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iDriverID      ,
            liLicenceID    ,
            dtObtained     ,
            dtExpires      ,
            CreateBatchKey ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.iDriverID    ,
            stg.liLicenceID  ,
            stg.dtObtained   ,
            stg.dtExpires    ,
            @batchKey        ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprDrivers_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprDrivers_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Drivers_CT  AS tar
      USING [StageUser1].Drivers AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate         = stg.ChangeDate        ,
            tar.Operation          = stg.Operation         ,
            tar.UpdateMask         = stg.UpdateMask        ,
            tar.ChangeVersion      = stg.ChangeVersion     ,
            tar.DriverGUID         = stg.DriverGUID        ,
            tar.iDriverID          = stg.iDriverID         ,
            tar.liSiteID           = stg.liSiteID          ,
            tar.liGroupID          = stg.liGroupID         ,
            tar.sEmployeeNumber    = stg.sEmployeeNumber   ,
            tar.sName              = stg.sName             ,
            tar.bLicense           = stg.bLicense          ,
            tar.dtLastLicense      = stg.dtLastLicense     ,
            tar.dtNextLicense      = stg.dtNextLicense     ,
            tar.ucLicenseInterval  = stg.ucLicenseInterval ,
            tar.dtDistanceChecked  = stg.dtDistanceChecked ,
            tar.sExtendedID        = stg.sExtendedID       ,
            tar.UpdateBatchKey     = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey   ,
            HostRID           ,
            ChangeDate        ,
            Operation         ,
            UpdateMask        ,
            ChangeVersion     ,
            DriverGUID        ,
            iDriverID         ,
            liSiteID          ,
            liGroupID         ,
            sEmployeeNumber   ,
            sName             ,
            bLicense          ,
            dtLastLicense     ,
            dtNextLicense     ,
            ucLicenseInterval ,
            dtDistanceChecked ,
            sExtendedID       ,
            CreateBatchKey    ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey      ,
            stg.RID               ,
            stg.ChangeDate        ,
            stg.Operation         ,
            stg.UpdateMask        ,
            stg.ChangeVersion     ,
            stg.DriverGUID        ,
            stg.iDriverID         ,
            stg.liSiteID          ,
            stg.liGroupID         ,
            stg.sEmployeeNumber   ,
            stg.sName             ,
            stg.bLicense          ,
            stg.dtLastLicense     ,
            stg.dtNextLicense     ,
            stg.ucLicenseInterval ,
            stg.dtDistanceChecked ,
            stg.sExtendedID       ,
            @batchKey             ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprEventData_RemoveNonTrackedChanges]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprEventData_RemoveNonTrackedChanges]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  DECLARE @unknownDateDefault date = '00010101';

  DECLARE @EventTypes TABLE
  (
    EventTypeLookupKey INT PRIMARY KEY CLUSTERED,
    EventType          TINYINT
  );

  CREATE TABLE #Vehicles
  ( 
    VehicleKey INT PRIMARY KEY CLUSTERED,
    HostID     SMALLINT 
  );

  CREATE TABLE #Drivers
  ( 
    DriverKey  INT PRIMARY KEY CLUSTERED,
    HostID     SMALLINT
  );

  CREATE TABLE #EventDescriptions
  ( 
    EventDescriptionKey INT PRIMARY KEY CLUSTERED,
    HostID              SMALLINT
  );

  CREATE TABLE #CalibrationParameters
  ( 
    ParameterKey INT PRIMARY KEY CLUSTERED,
    HostID       SMALLINT
  );

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Start';
  END;

  EXEC [Control].strProcProgressMonitor_Set
    @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;

  INSERT INTO @EventTypes
  (
    EventTypeLookupKey,
    EventType
  )
  SELECT
    LookupRID,
    LookupKey
  FROM
    [MiXData].dbo.DIM_TableColumnLookups
  WHERE
    LookupTable = 'FACT_EventDetails';

  INSERT INTO #Vehicles
  ( 
    VehicleKey,
    HostID    
  )
  SELECT
    dvh.VehicleKey,
    dvh.HostID
  FROM [MiXData].[dbo].DIM_Vehicles dvh  WITH (NOLOCK)
  WHERE dvh.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    dvh.VehicleKey,
    dvh.HostID
  FROM [MiXData].[dbo].DIM_Vehicles dvh  WITH (NOLOCK)
  WHERE dvh.VehicleKey = -1;

  INSERT INTO #Drivers
  ( 
    DriverKey,
    HostID    
  )
  SELECT
    dd.DriverKey,
    dd.HostID
  FROM [MiXData].[dbo].DIM_Drivers dd  WITH (NOLOCK)
  WHERE dd.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    dd.DriverKey,
    dd.HostID
  FROM [MiXData].[dbo].DIM_Drivers dd  WITH (NOLOCK)
  WHERE dd.DriverKey = -1;

  INSERT INTO #EventDescriptions
  ( 
    EventDescriptionKey,
    HostID    
  )
  SELECT
    ded.EventDescriptionKey,
    ded.HostID
  FROM [MiXData].[dbo].DIM_EventDescriptions ded  WITH (NOLOCK)
  WHERE ded.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    ded.EventDescriptionKey,
    ded.HostID
  FROM [MiXData].[dbo].DIM_EventDescriptions ded  WITH (NOLOCK)
  WHERE ded.EventDescriptionKey = -1;

  INSERT INTO #CalibrationParameters
  ( 
    ParameterKey,
    HostID    
  )
  SELECT
    prm.ParameterKey,
    prm.HostID
  FROM [MiXData].[dbo].DIM_CalibrationParameters prm  WITH (NOLOCK)
  WHERE prm.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    prm.ParameterKey,
    prm.HostID
  FROM [MiXData].[dbo].DIM_CalibrationParameters prm  WITH (NOLOCK)
  WHERE prm.ParameterKey = -1;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0.1 Get org DIM data';
  END;

  --------------------------------------------------------------------
  -- 1. Remove records from Stage source table
  --------------------------------------------------------------------

  --  ignore where Driver ID set to 0 (assume cause is driverID deleted)
  ;WITH
  UpdatedEventData AS
  (
    SELECT
      fact.EventDetailKey     ,
      fact.HostID             ,
      fact.DriverKey          ,
      fact.VehicleKey         ,
      fact.TrailerKey         ,
      fact.EventDescriptionKey,
      fact.EventTypeLookupKey ,
      fact.EventStartDateTime ,
      fact.EventEndDateTime   ,
      fact.StartOdometer      ,
      fact.EndOdometer        ,
      fact.EventValue         ,
      fact.TotalOccurs        ,
      fact.TotalTime          ,
      fact.ParameterKey       ,
      fact.Litres             ,
      fact.PulseParameterKey  ,
      fact.PulseValue         ,
      fact.IsDeleted
    FROM
      [StageUser1].EventData             ed
        INNER JOIN
      [MiXData].[dbo].FACT_EventDetails fact WITH (NOLOCK) ON fact.OrganisationKey = @organisationKey
                                                          AND fact.HostID          = ed.EventKey
  )
  DELETE ed
  FROM
    [StageUser1].EventData  ed
      INNER JOIN
    UpdatedEventData        fact ON fact.HostID              = ed.EventKey
      INNER JOIN
    #Vehicles               veh  ON fact.VehicleKey          = veh.VehicleKey
      INNER JOIN
    #EventDescriptions      evt  ON fact.EventDescriptionKey = evt.EventDescriptionKey
      INNER JOIN
    #Drivers                dd   ON fact.DriverKey           = dd.DriverKey
      LEFT JOIN
    #CalibrationParameters  prm  ON fact.PulseParameterKey   = prm.ParameterKey
      LEFT JOIN
    @EventTypes             et   ON fact.EventTypeLookupKey  = et.EventTypeLookupKey
  WHERE
    CHECKSUM
    (
      ed.VehicleID,
      ed.EventID,
      ed.EventType,
      CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),ed.StartDate)),
      ed.StartOdometer,
      CASE 
        WHEN ed.EndDate IS NULL AND ed.EventType = 3 -- Notifications
          THEN CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),ed.StartDate))
        ELSE CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),ed.EndDate))
      END,
      ed.EndOdometer,
      ed.TotalTime,
      ed.TotalOccurs,
      ed.Value,
      ed.Litres,
      ed.PulseParameterID,
      ed.PulseValue
    )
     =
    CHECKSUM
    (
      veh.HostID,
      evt.HostID,
      et.EventType,
      CONVERT(DATETIME,NULLIF(fact.EventStartDateTime,'0001-01-01 00:00:00 +00:00')),
      fact.StartOdometer,
      CONVERT(DATETIME,NULLIF(fact.EventEndDateTime,'0001-01-01 00:00:00 +00:00')),
      fact.EndOdometer,
      fact.TotalTime,
      fact.TotalOccurs,
      fact.EventValue,
      fact.Litres,
      prm.HostID,
      fact.PulseValue
    )
  AND (ed.DriverID = 0
  OR   ed.DriverID = dd.HostID);

  SELECT @recordsDeleted = @@ROWCOUNT;

  --------------------------------------------------------------------
  -- 2. Return values for Performance Monitoring
  --------------------------------------------------------------------
  EXEC [Control].strProcProgressMonitor_Set
    @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Return values for Performance Monitoring';
  END;

  SELECT RecordsDeleted  = isnull(@recordsDeleted ,0);

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprEventData_RemoveNonTrackedChanges_DataStream]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprEventData_RemoveNonTrackedChanges_DataStream]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @unknownDateDefault date = '00010101';

  --------------------------------------------------------------------
  -- 1. Identify records from Stage source table
  --------------------------------------------------------------------

  ;WITH
  EventTypes AS
  (
    SELECT
      EventTypeLookupKey = LookupRID,
      EventType          = LookupKey
    FROM
      [MiXData].dbo.DIM_TableColumnLookups
    WHERE
      LookupTable = 'FACT_EventDetails'
  ),
  EventDescriptions AS
  (
    SELECT
      ded.EventDescriptionKey,
      EventID = ded.HostID
    FROM
      [MiXData].[dbo].DIM_EventDescriptions ded WITH (NOLOCK)
    WHERE ded.OrganisationKey  = @organisationKey
  ),
  Vehicles AS
  (
    SELECT
      dvh.VehicleKey,
      VehicleID = dvh.HostID
    FROM
      [MiXData].[dbo].DIM_Vehicles dvh WITH (NOLOCK)
    WHERE dvh.OrganisationKey  = @organisationKey
  ),
  Drivers AS
  (
    SELECT
      drv.DriverKey,
      DriverID = drv.HostID
    FROM
      [MiXData].[dbo].DIM_Drivers drv WITH (NOLOCK)
    WHERE drv.OrganisationKey  = @organisationKey
  ),
  PulseParameters AS
  (
    SELECT
      PulseParameterKey = dcp.ParameterKey,
      PulseParameterID  = dcp.HostID
    FROM
      [MiXData].dbo.DIM_CalibrationParameters dcp WITH (NOLOCK)
    WHERE dcp.OrganisationKey = @organisationKey
  )  
  SELECT
    ed.EventKey,
    DWDriverID              = d.DriverID              ,
    ed.DriverID,
    DWVehicleID             = v.VehicleID         ,
    ed.VehicleID,
    DWEventDescriptionKey   = fact.EventDescriptionKey,
    e.EventDescriptionKey,
    DWEventTypeLookupKey    = fact.EventTypeLookupKey ,
    EventTypeLookupKey      = ISNULL(et.EventTypeLookupKey,-1),
    DWEventStartDateTime    = CONVERT(DATETIME,NULLIF(fact.EventStartDateTime,'0001-01-01 00:00:00 +00:00')),
    StartDate               = ed.StartDate,
    DWEventEndDateTime      = CONVERT(DATETIME,NULLIF(fact.EventEndDateTime,'0001-01-01 00:00:00 +00:00')),
    EndDate                 = CASE WHEN ed.EndDate IS NULL AND ed.EventType = 3 THEN ed.StartDate ELSE ed.EndDate END,
    DWStartOdometer         = fact.StartOdometer      ,
    StartOdometer           = ed.StartOdometer,
    DWEndOdometer           = fact.EndOdometer        ,
    EndOdometer             = ed.EndOdometer,
    DWEventValue            = fact.EventValue         ,
    Value                   = ed.Value,
    DWTotalOccurs           = fact.TotalOccurs        ,
    TotalOccurs             = ed.TotalOccurs,
    DWTotalTime             = fact.TotalTime          ,
    TotalTime               = ed.TotalTime,
    DWLitres                = fact.Litres             ,
    Litres                  = ed.Litres,
    DWPulseParameterKey     = fact.PulseParameterKey  ,
    pp.PulseParameterKey,
    DWPulseValue            = fact.PulseValue         ,
    ed.PulseValue,
    DWIsDeleted             = fact.IsDeleted
  FROM
    [StageUser1].EventData ed
      INNER JOIN
    [MiXData].[dbo].FACT_EventDetails fact         WITH (NOLOCK) ON fact.OrganisationKey  = @organisationKey
                                                                AND fact.HostID           = ed.EventKey
      INNER JOIN
    Vehicles                          v                          ON v.VehicleKey          = fact.VehicleKey
      INNER JOIN
    Drivers                           d                          ON d.DriverKey           = fact.DriverKey
      INNER JOIN
    EventDescriptions                 e                          ON e.EventID             = ed.EventID
      LEFT JOIN
    PulseParameters                   pp                         ON pp.PulseParameterID   = ed.PulseParameterID
      LEFT JOIN
    EventTypes                        et                         ON et.EventType          = ed.EventType
  WHERE
    ed.Operation = 'U';

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprEventData_RemoveNonTrackedChanges_Remove]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprEventData_RemoveNonTrackedChanges_Remove]
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @RecordsDeleted INT;

  DELETE ed
  FROM
    [StageUser1].[EventData] ed
      INNER JOIN
    [StageUser1].STAGE_FACT_EventDetails_NonTrackedChanges enc WITH (NOLOCK) ON enc.EventKey = ed.EventKey;
  
  SELECT RecordsDeleted = ISNULL(@@ROWCOUNT,0);

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprEventDescription_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprEventDescription_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].EventDescription_CT  AS tar
      USING [StageUser1].EventDescription AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iEventID       = stg.iEventID     ,
            tar.sDescription   = stg.sDescription ,
            tar.sSystemName    = stg.sSystemName  ,
            tar.sCriticalID    = stg.sCriticalID  ,
            tar.ucSummaryType  = stg.ucSummaryType,
            tar.iSummaryID     = stg.iSummaryID   ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iEventID       ,
            sDescription   ,
            sSystemName    ,
            sCriticalID    ,
            ucSummaryType  ,
            iSummaryID     ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.iEventID     ,
            stg.sDescription ,
            stg.sSystemName  ,
            stg.sCriticalID  ,
            stg.ucSummaryType,
            stg.iSummaryID   ,
            @batchKey        ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprEventTriggers_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprEventTriggers_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].EventTriggers_CT  AS tar
      USING [StageUser1].EventTriggers AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iEventID       = stg.iEventID     ,
            tar.ucTriggerID    = stg.ucTriggerID  ,
            tar.ucSeq          = stg.ucSeq        ,
            tar.iParameterID   = stg.iParameterID ,
            tar.ucOperator     = stg.ucOperator   ,
            tar.lfValue        = stg.lfValue      ,
            tar.bRequired      = stg.bRequired    ,
            tar.ucTOper        = stg.ucTOper      ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iEventID       ,
            ucTriggerID    ,
            ucSeq          ,
            iParameterID   ,
            ucOperator     ,
            lfValue        ,
            bRequired      ,
            ucTOper        ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.iEventID     ,
            stg.ucTriggerID  ,
            stg.ucSeq        ,
            stg.iParameterID ,
            stg.ucOperator   ,
            stg.lfValue      ,
            stg.bRequired    ,
            stg.ucTOper      ,
            @batchKey        ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprEWS_FutureDates]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprEWS_FutureDates]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  INT;
  DECLARE @EWSValidationKey INT;
  DECLARE @EWSSourceKey     INT;
  DECLARE @currentDate      DATE = CONVERT(DATE,SYSUTCDATETIME());

  SELECT
    @EWSValidationKey = (SELECT EWSValidationKey   
                         FROM [MiXData].ews.DIM_Validations
                         WHERE Validation = 'FutureDates'),
    @EWSSourceKey     = (SELECT EWSSourceKey
                         FROM [MiXData].ews.DIM_Sources
                         WHERE Source = 'FACT_EventDetails');

  INSERT INTO [MiXData].ews.FACT_Occurrences
  (
    EWSValidationKey    ,
    EWSSourceKey        ,
    EWSDateTime         ,
    BatchID             ,
    OrganisationID      ,
    VehicleID           ,
    TransactionalDateKey,
    Occurrences
  )
  SELECT
    @EWSValidationKey,
    @EWSSourceKey,
    SYSUTCDATETIME(),
    @batchKey,
    OrganisationID = (SELECT oc.OrganisationID FROM Control.OrganisationController oc  WITH (NOLOCK) WHERE oc.OrganisationKey = @organisationKey),
    stg.VehicleID,
    stg.EventStartDateKey,
    NumberOfRecords = COUNT(1)
  FROM
    [StageUser1].[STAGE_FACT_EventDetails] stg
  WHERE
    stg.EventStartDateKey > DATEADD(DAY,1,@currentDate)
  GROUP BY
    stg.VehicleID,
    stg.EventStartDateKey;

  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = 0,
         RecordsDeleted  = 0;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprEWS_InvalidDurations]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprEWS_InvalidDurations]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  INT;
  DECLARE @EWSValidationKey INT;
  DECLARE @EWSSourceKey     INT;
  DECLARE @currentDate      DATE = CONVERT(DATE,SYSUTCDATETIME());

  DECLARE @MaxSubTripDuration INT = 86400; -- 1 day, 3600seconds*24hours*1days

  SELECT
    @EWSValidationKey = (SELECT EWSValidationKey
                         FROM [MiXData].ews.DIM_Validations
                         WHERE Validation = 'InvalidDuration'),
    @EWSSourceKey     = (SELECT EWSSourceKey
                         FROM [MiXData].ews.DIM_Sources
                         WHERE Source = 'FACT_ActivityDetails');

  INSERT INTO [MiXData].ews.FACT_Occurrences
  (
    EWSValidationKey    ,
    EWSSourceKey        ,
    EWSDateTime         ,
    BatchID             ,
    OrganisationID      ,
    VehicleID           ,
    TransactionalDateKey,
    Occurrences
  )
  SELECT
    @EWSValidationKey,
    @EWSSourceKey,
    SYSUTCDATETIME(),
    @batchKey,
    OrganisationID = (SELECT oc.OrganisationID FROM Control.OrganisationController oc  WITH (NOLOCK) WHERE oc.OrganisationKey = @organisationKey),
    stg.VehicleID,
    stg.ActivityStartDateKey,
    COUNT(1)
  FROM
    [StageUser1].STAGE_FACT_ActivityDetails stg
  WHERE
     stg.Duration < 0
  OR stg.Duration > @MaxSubTripDuration
  GROUP BY
    stg.VehicleID,
    stg.ActivityStartDateKey;

  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = 0,
         RecordsDeleted  = 0;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprEWS_InvalidEngineSeconds]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprEWS_InvalidEngineSeconds]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  INT;
  DECLARE @EWSValidationKey INT;
  DECLARE @EWSSourceKey     INT;
  DECLARE @currentDate      DATE = CONVERT(DATE,SYSUTCDATETIME());

  SELECT
    @EWSValidationKey = (SELECT EWSValidationKey   
                         FROM [MiXData].ews.DIM_Validations
                         WHERE Validation = 'InvalidEngineSeconds'),
    @EWSSourceKey     = (SELECT EWSSourceKey
                         FROM [MiXData].ews.DIM_Sources
                         WHERE Source = 'FACT_ActivityDetails');

  INSERT INTO [MiXData].ews.FACT_Occurrences
  (
    EWSValidationKey    ,
    EWSSourceKey        ,
    EWSDateTime         ,
    BatchID             ,
    OrganisationID      ,
    VehicleID           ,
    TransactionalDateKey,
    Occurrences
  )
  SELECT
    @EWSValidationKey,
    @EWSSourceKey,
    SYSUTCDATETIME(),
    @batchKey,
    OrganisationID = (SELECT oc.OrganisationID FROM Control.OrganisationController oc  WITH (NOLOCK) WHERE oc.OrganisationKey = @organisationKey),
    stg.VehicleID,
    stg.ActivityStartDateKey,
    COUNT(1)
  FROM
    [StageUser1].STAGE_FACT_ActivityDetails stg
  WHERE
     stg.StartEngineSeconds > stg.EndEngineSeconds
  OR stg.StartEngineSeconds < 0
  OR stg.EndEngineSeconds   < 0
  GROUP BY
    stg.VehicleID,
    stg.ActivityStartDateKey;

  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = 0,
         RecordsDeleted  = 0;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprEWS_InvalidLitres]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprEWS_InvalidLitres]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  INT;
  DECLARE @EWSValidationKey INT;
  DECLARE @EWSSourceKey     INT;
  DECLARE @currentDate      DATE = CONVERT(DATE,SYSUTCDATETIME());

  DECLARE @MaxSubTripLitres DECIMAL(19,4) = 99999.9999; -- have to include boats that can use huge amount of Litres per sub-trip

  SELECT
    @EWSValidationKey = (SELECT EWSValidationKey   
                         FROM [MiXData].ews.DIM_Validations
                         WHERE Validation = 'InvalidLitres'),
    @EWSSourceKey     = (SELECT EWSSourceKey
                         FROM [MiXData].ews.DIM_Sources
                         WHERE Source = 'FACT_ActivityDetails');

  INSERT INTO [MiXData].ews.FACT_Occurrences
  (
    EWSValidationKey    ,
    EWSSourceKey        ,
    EWSDateTime         ,
    BatchID             ,
    OrganisationID      ,
    VehicleID           ,
    TransactionalDateKey,
    Occurrences
  )
  SELECT
    @EWSValidationKey,
    @EWSSourceKey,
    SYSUTCDATETIME(),
    @batchKey,
    OrganisationID = (SELECT oc.OrganisationID FROM Control.OrganisationController oc  WITH (NOLOCK) WHERE oc.OrganisationKey = @organisationKey),
    stg.VehicleID,
    stg.ActivityStartDateKey,
    COUNT(1)
  FROM
    [StageUser1].STAGE_FACT_ActivityDetails stg
  WHERE
     stg.FuelUsedMeasured >= @MaxSubTripLitres
  GROUP BY
    stg.VehicleID,
    stg.ActivityStartDateKey;

  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = 0,
         RecordsDeleted  = 0;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprEWS_QuarantinedData]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprEWS_QuarantinedData]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsInserted  INT;
  DECLARE @EWSValidationKey INT;
  DECLARE @currentDate      DATE = CONVERT(DATE,SYSUTCDATETIME());

  SELECT
    @EWSValidationKey = (SELECT EWSValidationKey   
                         FROM [MiXData].ews.DIM_Validations
                         WHERE Validation = 'QuarantinedData')

  INSERT INTO [MiXData].ews.FACT_Occurrences
  (
    EWSValidationKey    ,
    EWSSourceKey        ,
    EWSDateTime         ,
    BatchID             ,
    OrganisationID      ,
    VehicleID           ,
    TransactionalDateKey,
    Occurrences
  )
  SELECT
    @EWSValidationKey,
    dss.EWSSourceKey,
    SYSUTCDATETIME(),
    @batchKey,
    oc.OrganisationID,
    stg.VehicleID,
    stg.ChangeDateKey,
    stg.Occurrences
    -- select top 10 *
  FROM
    [StageUser1].QuarantinedDataSummary stg
      INNER JOIN
    Control.OrganisationController     oc  WITH (NOLOCK) ON oc.OrganisationKey = @organisationKey
      LEFT JOIN
    [MiXData].ews.DIM_Sources          dss WITH (NOLOCK) ON dss.Source         = stg.SourceTable;

  SELECT @recordsInserted = @@ROWCOUNT;

  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = 0,
         RecordsDeleted  = 0;

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprExtensionProperties_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprExtensionProperties_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].ExtensionProperties_CT  AS tar
      USING [StageUser1].ExtensionProperties_DIM AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate         = stg.ChangeDate,
            tar.Operation          = stg.Operation,
            tar.UpdateMask         = stg.UpdateMask,
            tar.ChangeVersion      = stg.ChangeVersion,
            tar.sAppID             = stg.sAppID,
            tar.liObjectType       = stg.liObjectType,
            tar.liObjectID         = stg.liObjectID,
            tar.sProperty          = stg.sProperty,
            tar.sValue             = stg.sValue,
            tar.UpdateBatchKey     = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID,
            ChangeDate,
            Operation,
            UpdateMask,
            ChangeVersion,
            sAppID,
            liObjectType,
            liObjectID,
            sProperty,
            sValue,
            CreateBatchKey,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey,
            stg.RID,
            stg.ChangeDate,
            stg.Operation,
            stg.UpdateMask,
            stg.ChangeVersion,
            stg.sAppID,
            stg.liObjectType,
            stg.liObjectID,
            stg.sProperty,
            stg.sValue,
            @batchKey,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_ActivityDetails_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_ActivityDetails_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;

  DECLARE @maxDurationYears   int  = 68; -- anything bigger than 68 causes overflow of int datatype
  DECLARE @maxFuelLimit       int  = 99999.0; -- anything bigger than 68 causes overflow of int datatype  
  DECLARE @unknownDateDefault date = '00010101';  
  DECLARE @averageFuelConsumptionLightTruck float = 13.36;    --   13.36 (l/100km) average fuel consumption for light trucks
  DECLARE @validDateStartTime datetimeoffset(0) = '20000101';

  -- http://www.epa.gov/OMS/climate/420f05004.htm  and http://www.epa.gov/oms/climate/420f05001.htm
  -- In particular, 40 CFR 600.113-78 gives a carbon content value of 2,421 grams (g) of carbon per gallon of gasoline, 
  -- which produces 8,877 g of CO2. (The carbon content is multiplied by the ratio of the molecular weight of CO2 to the molecular weight of carbon: 44/12).
  -- This number is then multiplied by an oxidation factor of 0.99, which assumes that 1 percent of the carbon remains un-oxidized.[1.] 
  -- This produces a value of 8,788 g or 8.8 kg (19.4 lbs) of CO2.
  -- Gasoline carbon content per gallon: 2,421 grams
  -- Diesel carbon content per gallon:   2,778 grams
  -- Currently FM is using 2.65 kg/litre

  DECLARE @averageCarbonEmission            float = 0.733869; -- kilograms/litre
  DECLARE @averageCO2Emission               float = 2.65;     -- kilograms/litre

  DECLARE @currentDate   datetimeoffset(0) = SYSUTCDATETIME(); -- used for validation  
  DECLARE @flagStartTime datetimeoffset(0) = SYSUTCDATETIME();
  DECLARE @flagSeq       smallint = 1;

  -- used for NextMovement calc
  CREATE TABLE #lastMovementStartDateTime
  ( 
    VehicleID                 int,
    MinMovementStartDateTime  datetimeoffset(0),
    PrevMovementStartDateTime datetimeoffset(0) NULL
  );

  -- used for NextMovement calc
  CREATE TABLE #recordsForNextMovementCalc
  ( 
    VehicleKey                    int,
    VehicleID                     int,
    MovementStartDateTime         datetimeoffset(0),
    MovementEndDateTime           datetimeoffset(0),
    ActivityDetailKey             bigint,
    NextMovementStartDateTime     datetimeoffset(0) NULL,
    NextMovementActivityDetailKey bigint            NULL
  );

  CREATE TABLE #VehiclesLookup
  (
    VehicleKey    INT  NOT NULL,
    HostID        INT  NOT NULL,
    StartDateKey  DATE NOT NULL,
    EndDateKey    DATE NOT NULL,
    TargetFuelConsumption       REAL NULL,
    TargetFuelConsumptionHourly REAL NULL
  );

  --------------------------------------------------------------------  
  -- 0. Make sure work tables are cleared  
  --------------------------------------------------------------------  
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_ActivityDetails];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_ActivityDetails];
  TRUNCATE TABLE [StageUser1].STAGE_FACT_EventRoadspeedLimitsScores;

  IF @debugMode = 1  -- DebugMode is true  
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set  
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
  END;  
  
  --------------------------------------------------------------------  
  -- 1. Source Data Validation  
  --------------------------------------------------------------------  
  
  --------------------------------------------------------------------  
  -- 2. Add to STG  
  --------------------------------------------------------------------  
  BEGIN TRY  
  
    IF NOT EXISTS(SELECT *  
                  FROM [sys].indexes   
                  WHERE object_id = OBJECT_ID(N'[StageUser1].[SubTripData]') AND name = N'IX_SubTripData_Depart')  
      CREATE NONCLUSTERED INDEX IX_SubTripData_Depart ON [StageUser1].[SubTripData](Depart)  
        INCLUDE(Halt);  
  
    -- drop STAGE indexes before insert  
    IF EXISTS(SELECT *  
              FROM [sys].indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_TripID_HostID')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_TripID_HostID ON [StageUser1].[STAGE_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_StartGPSID')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_StartGPSID ON [StageUser1].[STAGE_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_EndGPSID')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_EndGPSID ON [StageUser1].[STAGE_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey ON [StageUser1].[STAGE_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_VehicleKey')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_VehicleKey ON [StageUser1].[STAGE_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_VehicleID_StartOdometer_EndOdometer')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_VehicleID_StartOdometer_EndOdometer ON [StageUser1].[STAGE_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Operation')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Operation ON [StageUser1].[STAGE_FACT_ActivityDetails];  

    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_VehicleID_ActivityStartDateTime')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_VehicleID_ActivityStartDateTime ON [StageUser1].[STAGE_FACT_ActivityDetails];
  
    -- drop ROLLBACK indexes before insert  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_ActivityDetails]') AND name = N'IX_ROLLBACK_FACT_ActivityDetails_ActivitySummaryKey_HostID')  
      DROP INDEX IX_ROLLBACK_FACT_ActivityDetails_ActivitySummaryKey_HostID ON [StageUser1].[ROLLBACK_FACT_ActivityDetails];  
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_ActivityStartDateTime_ActivityEndDateTime')  
      DROP INDEX IX_STAGE_FACT_ActivityDetails_ActivityStartDateTime_ActivityEndDateTime ON [StageUser1].[STAGE_FACT_ActivityDetails];  
    
    -- insert changed records into STG  
   INSERT INTO [StageUser1].[STAGE_FACT_ActivityDetails]  
   (  
     [Operation]          ,  
     [TripID]             ,  
     [HostID]             ,  
     [StartGPSID]         ,  
     [EndGPSID]           ,  
  
     [MovementStartDateKey]   ,  
     [MovementEndDateKey]     ,  
     [MovementStartTime]      ,  
     [MovementEndTime]        ,  
     [MovementStartDateTime]  ,  
     [MovementEndDateTime]    ,  
  
     [StartOdometer]      ,
     [EndOdometer]        ,
     [StartEngineSeconds] ,
     [EndEngineSeconds]   ,
     
     [DistanceTravelled]  ,
     [Duration]           ,  
     [DrivingTime]        ,  
     [StandingTime]       ,  
     [MaxSpeed]           ,  
     [SpeedTime]          ,  
     [SpeedOccurs]        ,  
     [SpeedScore]         ,  
     [MaxBrake]           ,  
     [BrakeTime]          ,  
     [BrakeOccurs]        ,  
     [BrakeScore]         ,  
     [MaxAccel]           ,  
     [AccelTime]          ,  
     [AccelOccurs]        ,  
     [AccelScore]         ,  
     [MaxRPM]             ,  
     [RPMTIme]            ,  
     [RPMOccurs]          ,  
     [RPMScore]           ,  
     [OutOfGreenBandTime] ,  
     [OutOfGreenBandScore],  
     [ExcessiveIdleTime]  ,  
     [ExcessiveIdleOccurs],  
     [ExcessiveIdleScore] ,  
     [IdleTime]           ,  
     [IdleOccurs]         ,  
     [EngineSeconds]      ,  
     [FuelUsedMeasured]   ,  
     [FuelUsedCalculated] ,  
     [FuelUsedHierarchy]  ,
     [PulseParameterID]   ,
     [PulseValue]
   )  
   SELECT  
     s.Operation                                   ,  
     [TripID]              = s.[TripID]            ,  
     [HostID]              = s.[Sequence]          ,  
     [StartGPSID]          = s.[StartGPSID]        ,  
     [EndGPSID]            = s.[EndGPSID]          ,  
  
     [MovementStartDateKey] = ISNULL(CONVERT(DATE,s.Depart) ,@unknownDateDefault),  
     [MovementEndDateKey]   = ISNULL(CONVERT(DATE,s.Halt  ) ,@unknownDateDefault),  
     [MovementStartTime]    = CONVERT(TIME(0),ISNULL(s.Depart ,0)),  
     [MovementEndTime]      = CONVERT(TIME(0),ISNULL(s.Halt   ,0)),  
     [MovementStartDateTime]= CASE   
                                WHEN s.Depart IS NULL  
                                  THEN @unknownDateDefault  
                                  ELSE TODATETIMEOFFSET(s.Depart,ISNULL(utc.UTCOffsetMinutes,0))  
                              END,  
     [MovementEndDateTime]  = CASE   
                                WHEN s.Halt IS NULL  
                                  THEN @unknownDateDefault  
                                  ELSE TODATETIMEOFFSET(s.Halt,ISNULL(utc.UTCOffsetMinutes,0))  
                              END,  
                            
     [StartOdometer]       = s.Odometer - ISNULL(s.TripDistance,0),  
     [EndOdometer]         = s.Odometer          ,
     [StartEngineSeconds]  = s.StartEngineSeconds,
     [EndEngineSeconds]    = s.EndEngineSeconds  ,
     
  
     [DistanceTravelled]   = s.TripDistance      ,
     [Duration]            = CASE  
                               WHEN ABS(DATEDIFF(YEAR,s.Depart,s.Halt)) + ISNULL(s.StandingTime,0)/31536000  > @maxDurationYears   -- if Duration is longer than 68 years than indicate with error value  
                                 THEN -2                                                 -- value used for indication erronous value  
                               ELSE  
                                 ISNULL(DATEDIFF(SECOND,s.Depart,s.Halt),0) + ISNULL(s.StandingTime,0)  
                             END,  
     [DrivingTime]         = CASE  
                               WHEN ABS(DATEDIFF(YEAR,s.Depart,s.Halt)) > @maxDurationYears -- if Duration is longer than 68 years than indicate with error value  
                                 THEN -2                                               -- value used for indication erronous value  
                               ELSE  
                                 DATEDIFF(SECOND,s.Depart,s.Halt)  
                             END,  
     [StandingTime]        = ISNULL(s.StandingTime,0),  
  
     [MaxSpeed]            = s.[MaxSpeed]          ,  
     [SpeedTime]           = s.[SpeedTime]         ,  
     [SpeedOccurs]         = s.[SpeedOccurs]       ,  
     [SpeedScore]          = s.[SpeedScore]        ,  
  
     [MaxBrake]            = s.[MaxBrake]          ,  
     [BrakeTime]           = s.[BrakeTime]         ,  
     [BrakeOccurs]         = s.[BrakeOccurs]       ,  
     [BrakeScore]          = s.[BrakeScore]        ,  
  
     [MaxAccel]            = s.[MaxAccel]          ,   
     [AccelTime]           = s.[AccelTime]         ,   
     [AccelOccurs]         = s.[AccelOccurs]       ,   
     [AccelScore]          = s.[AccelScore]        ,   
  
     [MaxRPM]              = s.[MaxRPM]            ,   
     [RPMTime]             = s.[RPMTime]           ,   
     [RPMOccurs]           = s.[RPMOccurs]         ,   
     [RPMScore]            = s.[RPMScore]          ,   
  
     [OutOfGreenBandTime]  = s.[GBTime]            ,  
     [OutOfGreenBandScore] = s.[GBScore]           ,  
  
     [ExcessiveIdleTime]   = s.[ExIdleTime]        ,  
     [ExcessiveIdleOccurs] = s.[ExIdleOccurs]      ,  
     [ExcessiveIdleScore]  = s.[ExIdleScore]       ,  
  
     [IdleTime]            = s.[NIdleTime]         ,  
     [IdleOccurs]          = s.[NIdleOccurs]       ,  
     [EngineSeconds]       = CASE
                              WHEN ISNULL(s.StartEngineSeconds,0) > ISNULL(s.EndEngineSeconds,0)
                                THEN -2
                              ELSE
                                ISNULL((s.EndEngineSeconds-s.StartEngineSeconds),0)
                             END,
     [FuelUsedMeasured]    = CASE WHEN s.[Litres] < 0.0 THEN 0.0 ELSE ISNULL(s.[Litres],0.0) END, -- handle negative values
     0                                             ,
     -1                                            ,
     s.[PulseParameterID]                          ,
     s.[PulseValue]
   FROM
     [StageUser1].STAGE_FACT_ActivityChanges ac
       INNER JOIN
     [StageUser1].SubTripData                s   WITH (NOLOCK) ON s.TripID = ac.TripID
       CROSS JOIN  
     [StageUser1].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)  
   WHERE  
       ISNULL(CONVERT(DATETIMEOFFSET(0),s.Depart),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime  
   AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.Depart),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime
   AND (ac.IsMoreThanScoreChangeOnly = 1
   OR   ac.IsInTripSource            = 1
   OR   ac.IsInTaxClassification     = 1);
  
    -- insert Detailed records from changed Summary(TripData) into STG  
    --   we have to included all detailed records (SubTripData) from any changes in Summary(TripData) into the STG  
    --   to make sure their calculated values are updated correctly (volumes should be low)  
  
   INSERT INTO [StageUser1].[STAGE_FACT_ActivityDetails]  
   (   
     [Operation]          ,  
     [TripID]             ,  
     [HostID]             ,  
     [StartGPSID]         ,  
     [EndGPSID]           ,  
     [VehicleSiteKey]     ,  
     [StartGeoLocationKey],  
     [EndGeoLocationKey]  ,  
  
     [MovementStartDateKey]   ,  
     [MovementEndDateKey]     ,  
     [MovementStartTime]      ,  
     [MovementEndTime]        ,  
     [MovementStartDateTime]  ,  
     [MovementEndDateTime]    ,  
  
     [StartOdometer]      ,  
     [EndOdometer]        ,  
     [StartEngineSeconds] ,
     [EndEngineSeconds]   ,
     
     [DistanceTravelled]  ,  
     [Duration]           ,  
     [DrivingTime]        ,  
     [StandingTime]       ,  
     [MaxSpeed]           ,  
     [SpeedTime]          ,  
     [SpeedOccurs]        ,  
     [SpeedScore]         ,  
     [MaxBrake]           ,  
     [BrakeTime]          ,  
     [BrakeOccurs]        ,  
     [BrakeScore]         ,  
     [MaxAccel]           ,  
     [AccelTime]          ,  
     [AccelOccurs]        ,  
     [AccelScore]         ,  
     [MaxRPM]             ,  
     [RPMTIme]            ,  
     [RPMOccurs]          ,  
     [RPMScore]           ,  
     [OutOfGreenBandTime] ,  
     [OutOfGreenBandScore],  
     [ExcessiveIdleTime]  ,  
     [ExcessiveIdleOccurs],  
     [ExcessiveIdleScore] ,  
     [IdleTime]           ,  
     [IdleOccurs]         ,  
     [EngineSeconds]      ,  
     [FuelUsedMeasured]   ,  
     [FuelUsedCalculated] ,  
     [FuelUsedHierarchy]  ,
     [PulseParameterKey]  ,
     [PulseValue]
   )  
   SELECT  
     'U'                      , -- update operation  
     s.[TripID]               ,  
     fad.[HostID]             ,  
     [StartGPSID] = -1        ,  
     [EndGPSID]   = -1        ,  
     fad.[VehicleSiteKey]     ,  
     fad.[StartGeoLocationKey],  
     fad.[EndGeoLocationKey]  ,  
       
     fad.[MovementStartDateKey]   ,  
     fad.[MovementEndDateKey]     ,  
     fad.[MovementStartTime]      ,  
     fad.[MovementEndTime]        ,  
     fad.[MovementStartDateTime]  ,  
     fad.[MovementEndDateTime]    ,  
  
     fad.[StartOdometer]      ,  
     fad.[EndOdometer]        ,  
     fad.[StartEngineSeconds] ,
     fad.[EndEngineSeconds]   ,

     fad.[DistanceTravelled]  ,  
     fad.[Duration]           ,  
     fad.[DrivingTime]        ,  
     fad.[StandingTime]       ,  
     fad.[MaxSpeed]           ,  
     fad.[SpeedTime]          ,  
     fad.[SpeedOccurs]        ,  
     fssd.[SpeedScore]         ,  
     fad.[MaxBrake]           ,  
     fad.[BrakeTime]          ,  
     fad.[BrakeOccurs]        ,  
     fssd.[BrakeScore]         ,  
     fad.[MaxAccel]           ,  
     fad.[AccelTime]          ,  
     fad.[AccelOccurs]        ,  
     fssd.[AccelScore]         ,  
     fad.[MaxRPM]             ,  
     fad.[RPMTIme]            ,  
     fad.[RPMOccurs]          ,  
     fssd.[RPMScore]           ,  
     fad.[OutOfGreenBandTime] ,  
     fssd.[OutOfGreenBandScore],  
     fad.[ExcessiveIdleTime]  ,  
     fad.[ExcessiveIdleOccurs],  
     fssd.[ExcessiveIdleScore] ,  
     fad.[IdleTime]           ,  
     fad.[IdleOccurs]         ,  
     fad.[EngineSeconds]      ,  
     fad.[FuelUsedMeasured]   ,  
     fad.[FuelUsedCalculated] ,  
     fad.[FuelUsedHierarchy]  ,
     fad.[PulseParameterKey]  ,
     fad.[PulseValue]
   FROM  
     [StageUser1].[STAGE_FACT_ActivityChanges] s  
       INNER JOIN  
     [MiXData].dbo.FACT_ActivitySummary   fas   WITH (NOLOCK) ON fas.OrganisationKey = @organisationKey  
                                                                AND s.TripID            = fas.HostID  
       INNER JOIN  
     [MiXData].dbo.FACT_ActivityDetails   fad   WITH (NOLOCK) ON fad.OrganisationKey      = fas.OrganisationKey  
                                                                AND fad.[ActivitySummaryKey] = fas.[ActivitySummaryKey]  
       INNER JOIN  
     [MiXData].dbo.FACT_SimpleScoreDetails fssd WITH (NOLOCK) ON fssd.OrganisationKey   = fad.OrganisationKey  
                                                                AND fssd.ActivityDetailKey = fad.ActivityDetailKey  
   WHERE  
       s.IsInSubTripSource = 0  
   AND NOT EXISTS (SELECT 1  
                   FROM  
                     [StageUser1].[STAGE_FACT_ActivityDetails] stg WITH (NOLOCK)  
                   WHERE  
                       stg.TripID = s.TripID  
                   AND stg.HostID = fad.HostID);  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
    RETURN -1;  
  END CATCH;  
  
  --------------------------------------------------------------------  
  -- 3. Update calculated columns onto STG  
  --------------------------------------------------------------------  
  BEGIN TRY  
  
    IF EXISTS(SELECT *  
              FROM [sys].indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser1].[SubTripData]') AND name = N'IX_SubTripData_Depart')  
      DROP INDEX IX_SubTripData_Depart ON [StageUser1].[SubTripData];  
  
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_TripID_HostID  
      ON [StageUser1].[STAGE_FACT_ActivityDetails](TripID,HostID);  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
    INSERT INTO #VehiclesLookup
    (
      VehicleKey,
      HostID,
      StartDateKey,
      EndDateKey,
      TargetFuelConsumption,
      TargetFuelConsumptionHourly
    )
    SELECT
      dvh.VehicleKey,
      dvh.HostID,
      dvh.StartDateKey,
      dvh.EndDateKey,
      dvh.TargetFuelConsumption,
      dvh.TargetFuelConsumptionHourly
    FROM
      [MiXData].dbo.DIM_Vehicles dvh WITH (NOLOCK)
    WHERE dvh.OrganisationKey = @organisationKey;

    CREATE CLUSTERED INDEX IX_VehiclesLookup ON #VehiclesLookup(VehicleKey);

    ------------------------------------------  
    -- ActivitySummary Details  
    UPDATE  
      [StageUser1].[STAGE_FACT_ActivityDetails]  
    SET  
      [ActivitySummaryKey]   = fas.[ActivitySummaryKey]    ,  
      [DriverKey]            = fas.[DriverKey]             ,  
      [VehicleKey]           = fas.[VehicleKey]            ,  
      [VehicleID]            = dvh.HostID                  ,  
      [VehicleSiteKey]       = fas.[OriginalVehicleSiteKey],  
      [UTCOffsetKey]         = fas.UTCOffsetKey            ,  
      [ActivityStartDateKey] = CASE  
                                 WHEN stg.HostID < 2  
                                   THEN fas.[ActivityStartDateKey]  
                                 ELSE   stg.[MovementStartDateKey]  
                                END,  
      [ActivityStartTime]    = CASE  
                                 WHEN stg.HostID < 2  
                                   THEN fas.[ActivityStartTime]  
                                 ELSE   stg.[MovementStartTime]  
                                END,  
      [ActivityStartDateTime]= CASE  
                                 WHEN stg.HostID < 2  
                                   THEN fas.[ActivityStartDateTime]  
                                 ELSE   stg.[MovementStartDateTime]  
                                END  
    FROM  
      [StageUser1].[STAGE_FACT_ActivityDetails] stg  
        INNER JOIN  
      [MiXData].dbo.FACT_ActivitySummary   fas WITH (NOLOCK) ON stg.TripID          = fas.HostID
                                                            AND fas.OrganisationKey = @organisationKey
        LEFT JOIN  
      #VehiclesLookup                      dvh               ON fas.VehicleKey      = dvh.VehicleKey;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.2 Update ActivitySummary Details', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey  
      ON [StageUser1].[STAGE_FACT_ActivityDetails](ActivityStartDateKey);  
  
    ------------------------------------------  
    -- Activity End   
      
    -- update with next records Depart/MovementStartDate  
    UPDATE stg1  
    SET  
      stg1.[ActivityEndDateKey]  = stg2.MovementStartDateKey,  
      stg1.[ActivityEndTime]     = stg2.MovementStartTime   ,  
      stg1.[ActivityEndDateTime] = stg2.MovementStartDateTime  
    FROM  
      [StageUser1].[STAGE_FACT_ActivityDetails] stg1  
         INNER JOIN  
      [StageUser1].[STAGE_FACT_ActivityDetails] stg2 ON stg2.TripID = stg1.TripID  
                                                   AND stg2.HostID = stg1.HostID + 1;  
  
    -- update with Trip/ActivitySummary's TripEndDate/ActivityEndDate for last ActivityDetail(SubTrip)  
    UPDATE [StageUser1].[STAGE_FACT_ActivityDetails]  
    SET  
      [ActivityEndDateKey]  = fas.ActivityEndDateKey,  
      [ActivityEndTime]     = fas.ActivityEndTime   ,  
      [ActivityEndDateTime] = fas.ActivityEndDateTime  
    FROM  
      [StageUser1].[STAGE_FACT_ActivityDetails] stg  
         INNER JOIN  
      [MiXData].dbo.FACT_ActivitySummary   fas WITH (NOLOCK) ON stg.TripID          = fas.HostID  
                                                               AND fas.OrganisationKey = @organisationKey  
    WHERE  
      stg.[ActivityEndDateKey] IS NULL;  
  
  
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_StartGPSID  
      ON [StageUser1].[STAGE_FACT_ActivityDetails](StartGPSID);  
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_EndGPSID  
      ON [StageUser1].[STAGE_FACT_ActivityDetails](EndGPSID);  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.3 Update Activity End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
    ------------------------------------------  
    -- StartGeoLocationKey  
    UPDATE [StageUser1].[STAGE_FACT_ActivityDetails]  
    SET  
      StartGeoLocationKey = g.GeoLocationKey  
    FROM  
      [StageUser1].[STAGE_FACT_ActivityDetails] stg  
        INNER JOIN  
      [StageUser1].STAGE_DIM_GeoLocations       g WITH (NOLOCK) ON stg.StartGPSID = g.HostID;  
  
    ------------------------------------------  
    -- EndGeoLocationKey  
    UPDATE [StageUser1].[STAGE_FACT_ActivityDetails]  
    SET  
      EndGeoLocationKey = g.GeoLocationKey  
    FROM  
      [StageUser1].[STAGE_FACT_ActivityDetails] stg  
        INNER JOIN  
      [StageUser1].STAGE_DIM_GeoLocations       g WITH (NOLOCK) ON stg.EndGPSID = g.HostID;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.4 Update GeoLocationKeys', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
    ------------------------------------------  
    -- NoGoZoneEntry  (need to find calculation)  
  
  
    ------------------------------------------  
    -- Passengers   (need to find calculation)  
  
  
    ------------------------------------------  
    -- FuelUsedCalculated  

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_VehicleKey  
      ON [StageUser1].[STAGE_FACT_ActivityDetails](VehicleKey);  

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_VehicleID_ActivityStartDateTime
      ON [StageUser1].[STAGE_FACT_ActivityDetails](VehicleID,ActivityStartDateTime);  
  
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Operation  
      ON [StageUser1].[STAGE_FACT_ActivityDetails](ActivitySummaryKey,HostID,Operation);

  
    -- Hierarchy 1 - use TargetFuelConsumptionHourly if available,
    --           2 - use TargetFuelConsumption if available,
    --           3 - using AverageFuelConsumptionLightTruck otherwise
    UPDATE [StageUser1].[STAGE_FACT_ActivityDetails]  
    SET  
      FuelUsedCalculated = CASE
                             WHEN stg.Duration > 0.0 THEN -- valid DrivingDuration
                               CASE
                                 WHEN stg.DistanceTravelled/(stg.Duration*3600.0) > stg.MaxSpeed AND stg.DistanceTravelled > 1.0   -- Avg Speed (based on Duration as driving time contains nulls) > MaxSpeed where Distance > 1km
                                   THEN -1
                                 WHEN fvh.TargetFuelConsumptionHourly > 0.0 AND ISNULL(stg.EngineSeconds,0.0) > 0.0 AND (fvh.TargetFuelConsumptionHourly * stg.EngineSeconds)/3600.0 < @maxFuelLimit
                                   THEN (fvh.TargetFuelConsumptionHourly * stg.EngineSeconds)/3600.0                 -- TargetFuelConsumptionHourly saved as l/hr
                                 WHEN fvh.TargetFuelConsumption       > 0.0 AND (fvh.TargetFuelConsumption * stg.DistanceTravelled)/100.0 < @maxFuelLimit
                                   THEN (fvh.TargetFuelConsumption       * stg.DistanceTravelled)/100.0              -- TargetFuelConsumption saved as l/100km
                                 ELSE (@averageFuelConsumptionLightTruck * ISNULL(stg.DistanceTravelled,0.0))/100.0  -- @averageFuelConsumptionLightTruck used as l/100km
                               END
                             ELSE
                               CASE
                                 WHEN fvh.TargetFuelConsumptionHourly > 0.0 AND ISNULL(stg.EngineSeconds,0.0) > 0.0 AND (fvh.TargetFuelConsumptionHourly * stg.EngineSeconds)/3600.0 < @maxFuelLimit
                                   THEN (fvh.TargetFuelConsumptionHourly * stg.EngineSeconds)/3600.0                 -- TargetFuelConsumptionHourly saved as l/hr
                                 WHEN fvh.TargetFuelConsumption       > 0.0 AND (fvh.TargetFuelConsumption * stg.DistanceTravelled)/100.0 < @maxFuelLimit
                                   THEN (fvh.TargetFuelConsumption       * stg.DistanceTravelled)/100.0              -- TargetFuelConsumption saved as l/100km
                                 ELSE (@averageFuelConsumptionLightTruck * ISNULL(stg.DistanceTravelled,0.0))/100.0  -- @averageFuelConsumptionLightTruck used as l/100km
                               END
                           END,  
      FuelUsedHierarchy  = CASE  
                             WHEN fvh.TargetFuelConsumptionHourly > 0.0 AND ISNULL(stg.EngineSeconds,0.0) > 0.0 AND (fvh.TargetFuelConsumptionHourly * stg.EngineSeconds)/3600.0 < @maxFuelLimit
                               THEN 1
                             WHEN fvh.TargetFuelConsumption       > 0.0 AND (fvh.TargetFuelConsumption * stg.DistanceTravelled)/100.0 < @maxFuelLimit
                               THEN 2
                             ELSE   3
                           END
    FROM
      [StageUser1].[STAGE_FACT_ActivityDetails] stg  
        LEFT JOIN  
      #VehiclesLookup                           fvh ON fvh.VehicleKey = stg.VehicleKey;
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.5 Update FuelUsed', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    ------------------------------------------  
    -- NightDuration (from CLR function)  
    -- removed for now  
    WITH AvgActivityData AS
    (
      SELECT
        stg.ActivitySummaryKey,
        stg.HostID            ,
        AvgLatitude   = CASE
                          WHEN stg.StartGeoLocationKey > 0 
                           AND stg.EndGeoLocationKey   > 0 THEN (dgls.Latitude + dgle.Latitude)/2.0
                          WHEN stg.StartGeoLocationKey > 0 THEN  dgls.Latitude
                          WHEN stg.EndGeoLocationKey   > 0 THEN  dgle.Latitude
                          ELSE 0.0
                        END,
        AvgLongitude  = CASE
                          WHEN stg.StartGeoLocationKey > 0 
                           AND stg.EndGeoLocationKey   > 0 THEN (dgls.Longitude + dgle.Longitude)/2.0
                          WHEN stg.StartGeoLocationKey > 0 THEN  dgls.Longitude
                          WHEN stg.EndGeoLocationKey   > 0 THEN  dgle.Longitude
                          ELSE 0.0
                        END
      FROM
        [StageUser1].[STAGE_FACT_ActivityDetails] stg
          LEFT JOIN
        [MiXData].dbo.DIM_GeoLocations dgls WITH (NOLOCK) ON dgls.GeoLocationKey = stg.StartGeoLocationKey
          LEFT JOIN
        [MiXData].dbo.DIM_GeoLocations dgle WITH (NOLOCK) ON dgle.GeoLocationKey = stg.EndGeoLocationKey
    )
    UPDATE
      stg
    SET
      NightDuration = dbo.fncNightTimeDuration(aad.AvgLatitude,aad.AvgLongitude,stg.ActivityStartDateTime,stg.ActivityEndDateTime)
    FROM
      [StageUser1].[STAGE_FACT_ActivityDetails] stg
        INNER JOIN
      AvgActivityData                          aad ON aad.ActivitySummaryKey = stg.ActivitySummaryKey
                                                  AND aad.HostID             = stg.HostID;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.6 Update NightDuration', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    ------------------------------------------  
    -- AfterHoursDuration (still to be defined)  
  
  
    ------------------------------------------  
    -- TotalCarbonEmission/TotalCO2Emission
    UPDATE [StageUser1].[STAGE_FACT_ActivityDetails]  
    SET  
      TotalCarbonEmission = FuelUsedMeasured * @averageCarbonEmission,
      TotalCO2Emission    = FuelUsedMeasured * @averageCO2Emission
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.7 Update TotalCarbonEmission/TotalCO2Emission', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
    ------------------------------------------  
    -- IsLastMovement  
    ;WITH LastMovement AS  
    (  
      SELECT  
        TripID,  
        LastMovement = MAX(HostID)  
      FROM  
        [StageUser1].[STAGE_FACT_ActivityDetails]  
      GROUP BY  
        TripID  
    )  
    UPDATE  
      [StageUser1].[STAGE_FACT_ActivityDetails]  
    SET  
      IsLastMovement = 1  
    FROM  
      [StageUser1].[STAGE_FACT_ActivityDetails] stg  
        INNER JOIN  
      LastMovement                             m   ON stg.TripID = m.TripID   
                                                  AND stg.HostID = m.LastMovement;  

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.8 Update IsLastMovement', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    ------------------------------------------
    -- ParameterKey
    UPDATE
      [StageUser1].[STAGE_FACT_ActivityDetails]
    SET
      [PulseParameterKey] = dcp.ParameterKey
    FROM
      [StageUser1].[STAGE_FACT_ActivityDetails]   stg
        INNER JOIN
      [MiXData].dbo.DIM_CalibrationParameters dcp WITH (NOLOCK) ON dcp.OrganisationKey = @organisationKey
                                                                  AND dcp.HostID          = stg.PulseParameterID;
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='3.9 Update ParameterKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    ------------------------------------------
    -- RoadSpeedScoring values
    ;WITH
    OverSpeedingScoreCriteria AS
    (
      SELECT
        dsc.ScoreDuration,          -- @OverSpeedDurationLimit
        dsc.ScoreSeverity           -- @OverSpeedScoreSeverity
      FROM [MiXData].dbo.DIM_SimpleScoreCriteria dsc WITH (NOLOCK)
      WHERE dsc.OrganisationKey = @organisationKey
      AND dsc.HostID            = 1 -- Over Speeding event
      AND dsc.IsCurrentRecord   = 1 -- only use latest ScoreCriteria record
    ),
    IndividualEventScores AS
    (
      SELECT
        ed.VehicleID,
        ed.StartDate,
        ed.TotalOccurs,
        ed.TotalTime,
        SeverityScore = CASE
                          WHEN ed.Value IS NOT NULL THEN
                            dbo.fncCalculateRoadSpeedOverspeedingSeverityScore
                              (
                                dsc.ScoreSeverity,          -- @OverSpeedSeverityFactor
                                ISNULL(el.SpeedLimit,0.0),  -- @EventSpeedLimit
                                ISNULL(ed.Value,0.0)        -- @EventSpeed
                              )
                          ELSE 100.0
                        END
      FROM
        [StageUser1].STAGE_FACT_EventRoadspeedLimits el  WITH (NOLOCK)
          INNER JOIN
        [StageUser1].EventData                       ed  WITH (NOLOCK) ON el.EventKey = ed.EventKey
          CROSS JOIN
        OverSpeedingScoreCriteria                   dsc
      WHERE ed.Operation IN ('I','U')
    )
    INSERT INTO [StageUser1].STAGE_FACT_EventRoadspeedLimitsScores
    (
      TripID,
      HostID,
      RoadSpeedOccurs,
      RoadSpeedTime,
      SeverityScore,
      DurationScore
    )
    SELECT
      std.TripID,
      std.HostID,
      RoadSpeedOccurs = SUM(ies.TotalOccurs),
      RoadSpeedTime   = SUM(ies.TotalTime),
      SeverityScore   = MIN(ies.SeverityScore),
      DurationScore   = dbo.fncCalculateRoadSpeedOverspeedingDurationScore
                          (
                            dsc.ScoreDuration,               --@OverSpeedDurationFactor,
                            ISNULL(SUM(ies.TotalTime),0.0),  --@EventTotalTime,
                            ISNULL(std.DrivingTime,0.0) --@SubTripDuration
                          )
    FROM
      IndividualEventScores     ies
        INNER JOIN
      [StageUser1].STAGE_FACT_ActivityDetails std ON std.VehicleID = ies.VehicleID
                                                AND ies.StartDate BETWEEN CONVERT(DATETIME,std.MovementStartDateTime) AND CONVERT(DATETIME,std.MovementEndDateTime)
        CROSS JOIN
      OverSpeedingScoreCriteria dsc
    WHERE std.Operation IN ('I','U')
    AND std.MovementStartDateTime > '19000101'
    GROUP BY
      std.TripID,
      std.HostID,
      std.DrivingTime,
      dsc.ScoreDuration;

    -- update SubTripData
    UPDATE std
    SET
      RoadSpeedTime   = srs.RoadSpeedTime,
      RoadSpeedOccurs = srs.RoadSpeedOccurs,
      RoadSpeedScore  = (ISNULL(srs.DurationScore,0.0)+ISNULL(srs.SeverityScore,0.0))/2.0
    FROM
      [StageUser1].STAGE_FACT_EventRoadspeedLimitsScores srs
        INNER JOIN
      [StageUser1].SubTripData                           std ON std.TripID   = srs.TripID
                                                           AND std.Sequence = srs.HostID;

    -- update STAGE
    UPDATE std
    SET
      RoadSpeedTime   = srs.RoadSpeedTime,
      RoadSpeedOccurs = srs.RoadSpeedOccurs,
      RoadSpeedScore  = (ISNULL(srs.DurationScore,0.0)+ISNULL(srs.SeverityScore,0.0))/2.0
    FROM
      [StageUser1].STAGE_FACT_EventRoadspeedLimitsScores srs
        INNER JOIN
      [StageUser1].[STAGE_FACT_ActivityDetails]          std ON std.TripID = srs.TripID
                                                           AND std.HostID = srs.HostID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.10 update RoadSpeedScoring values', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------  
  -- 4. Validation before Loading to DW  
  --------------------------------------------------------------------  
  BEGIN TRY  
  
    IF EXISTS (SELECT 1  
               FROM  
                 [StageUser1].[STAGE_FACT_ActivityDetails]  
               WHERE  
                 ActivityStartDateKey > DATEADD(DAY,1,@currentDate))  
    BEGIN  
      RAISERROR(N'Some Units internal clock seem to be out of sync',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;  
  END CATCH;  
  
  --------------------------------------------------------------------  
  -- 5. MERGE to DW (Load) and add to RollBck  
  --------------------------------------------------------------------  
  BEGIN TRY  
  
    -- Remove ActivityDetails where no summary values exists (proir to 2006 data)  
    DELETE [StageUser1].[STAGE_FACT_ActivityDetails]  
    WHERE ActivitySummaryKey IS NULL;  
      
    -- Add existing records to RollBck table  
    -- update records existing in DW  
    INSERT INTO [StageUser1].[ROLLBACK_FACT_ActivityDetails]  
    (   
      [ActivityDetailKey]   ,  
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
                              
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],  
      [MovementEndDateTime]  ,  
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]    ,  
  
      [StartOdometer]       ,  
      [EndOdometer]         ,  
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,  
      [AccelTime]           ,  
      [AccelOccurs]         ,  
  
      [MaxRPM]              ,  
      [RPMTIme]             ,  
      [RPMOccurs]           ,  
                              
      [OutOfGreenBandTime]  ,  
  
      [ExcessiveIdleTime]   ,  
      [ExcessiveIdleOccurs] ,  
  
      [IdleTime]            ,  
      [IdleOccurs]          ,  
  
      [EngineSeconds]         ,  
  
      -- calculated fields  
      [NoGoZoneEntry]       ,  
      [Passengers]          ,  
  
      [FuelUsedMeasured]    ,  
      [FuelUsedCalculated]  ,  
      [FuelUsedHierarchy]   ,  
        
      [NightDuration]       ,
      [AfterHoursDuration]  ,
      [TotalCarbonEmission] ,
      [TotalCO2Emission]    ,
  
      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,
      [UpdateBatchKey]
    )  
    SELECT  
      [ActivityDetailKey]   ,  
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
  
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],  
      [MovementEndDateTime]  ,  
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]    ,  
  
      [StartOdometer]       ,  
      [EndOdometer]         ,  
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,
      [AccelTime]           ,
      [AccelOccurs]         ,
  
      [MaxRPM]              ,
      [RPMTIme]             ,
      [RPMOccurs]           ,
  
      [OutOfGreenBandTime]  ,
  
      [ExcessiveIdleTime]   ,
      [ExcessiveIdleOccurs] ,
  
      [IdleTime]            ,
      [IdleOccurs]          ,
  
      [EngineSeconds]       ,
  
      -- calculated fields  
      [NoGoZoneEntry]       ,
      [Passengers]          ,
  
      [FuelUsedMeasured]    ,
      [FuelUsedCalculated]  ,
      [FuelUsedHierarchy]   ,
  
      [NightDuration]       ,
      [AfterHoursDuration]  ,
      [TotalCarbonEmission] ,
      [TotalCO2Emission]    ,

      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,
      [UpdateBatchKey]
    FROM  
     (UPDATE [MiXData].dbo.FACT_ActivityDetails  
      SET   
        [VehicleSiteKey]        = ISNULL(stg.[VehicleSiteKey]       ,-1),  
--        [ActivityStartDateKey]  = stg.[ActivityStartDateKey] ,  
        [ActivityEndDateKey]    = stg.[ActivityEndDateKey]   ,  
        [ActivityStartTime]     = stg.[ActivityStartTime]    ,  
        [ActivityEndTime]       = stg.[ActivityEndTime]      ,  
        [ActivityStartDateTime] = stg.[ActivityStartDateTime],  
        [ActivityEndDateTime]   = stg.[ActivityEndDateTime]  ,  
        [MovementStartDateKey]  = stg.[MovementStartDateKey] ,  
        [MovementEndDateKey]    = stg.[MovementEndDateKey]   ,  
        [MovementStartTime]     = stg.[MovementStartTime]    ,  
        [MovementEndTime]       = stg.[MovementEndTime]      ,  
        [MovementStartDateTime] = stg.[MovementStartDateTime],  
        [MovementEndDateTime]   = stg.[MovementEndDateTime]  ,  
        [IsLastMovement]        = ISNULL(stg.[IsLastMovement],0),
  
        [StartOdometer]         = stg.[StartOdometer]        ,  
        [EndOdometer]           = stg.[EndOdometer]          ,  
        [StartEngineSeconds]    = stg.[StartEngineSeconds]   ,
        [EndEngineSeconds]      = stg.[EndEngineSeconds]     ,

        [StartGeoLocationKey]   = ISNULL(stg.[StartGeoLocationKey]  ,tar.[StartGeoLocationKey]),  
        [EndGeoLocationKey]     = ISNULL(stg.[EndGeoLocationKey]    ,tar.[EndGeoLocationKey]),  
        [DistanceTravelled]     = stg.[DistanceTravelled]    ,  
        [Duration]              = stg.[Duration]             ,  
        [DrivingTime]           = stg.[DrivingTime]          ,  
        [StandingTime]          = stg.[StandingTime]         ,  
  
        [DriverKey]             = ISNULL(stg.[DriverKey]            ,-1),  
        [VehicleKey]            = ISNULL(stg.[VehicleKey]           ,-1),  
  
        [MaxSpeed]              = stg.[MaxSpeed]             ,  
        [SpeedTime]             = stg.[SpeedTime]            ,  
        [SpeedOccurs]           = stg.[SpeedOccurs]          ,  
  
        [MaxBrake]              = stg.[MaxBrake]             ,  
        [BrakeTime]             = stg.[BrakeTime]            ,  
        [BrakeOccurs]           = stg.[BrakeOccurs]          ,  
  
        [MaxAccel]              = stg.[MaxAccel]             ,  
        [AccelTime]             = stg.[AccelTime]            ,  
        [AccelOccurs]           = stg.[AccelOccurs]          ,  
  
        [MaxRPM]                = stg.[MaxRPM]               ,  
        [RPMTIme]               = stg.[RPMTIme]              ,  
        [RPMOccurs]             = stg.[RPMOccurs]            ,  
  
        [OutOfGreenBandTime]    = stg.[OutOfGreenBandTime]   ,  
  
        [ExcessiveIdleTime]     = stg.[ExcessiveIdleTime]    ,  
        [ExcessiveIdleOccurs]   = stg.[ExcessiveIdleOccurs]  ,  
  
        [IdleTime]              = stg.[IdleTime]             ,  
        [IdleOccurs]            = stg.[IdleOccurs]           ,  
  
        [EngineSeconds]         = stg.[EngineSeconds]        ,  
  
        --calculated fields  
        [NoGoZoneEntry]         = stg.[NoGoZoneEntry]        ,  
        [Passengers]            = stg.[Passengers]           ,  
  
        [FuelUsedMeasured]      = ISNULL(stg.[FuelUsedMeasured]  ,0.0),  
        [FuelUsedCalculated]    = ISNULL(stg.[FuelUsedCalculated],0.0),  
        [FuelUsedHierarchy]     = ISNULL(stg.[FuelUsedHierarchy] ,-1) ,  
  
        [NightDuration]         = ISNULL(stg.[NightDuration]     ,0.0),
        [AfterHoursDuration]    = stg.[AfterHoursDuration]   ,  
        [TotalCarbonEmission]   = stg.[TotalCarbonEmission]  ,  
        [TotalCO2Emission]      = stg.[TotalCO2Emission]     ,

        [RoadSpeedTime]         = ISNULL(stg.[RoadSpeedTime],0),
        [RoadSpeedOccurs]       = ISNULL(stg.[RoadSpeedOccurs],0),

        [UTCOffsetKey]          = stg.[UTCOffsetKey]         ,  
        [IsDeleted]             = 0                          ,
        UpdateBatchKey          = @batchKey  
      OUTPUT  
        DELETED.[ActivityDetailKey]   ,  
        DELETED.[ActivitySummaryKey]  ,  
        DELETED.[OrganisationKey]     ,  
        DELETED.[HostID]              ,  
  
        DELETED.[VehicleSiteKey]      ,  
        DELETED.[ActivityStartDateKey],  
        DELETED.[ActivityEndDateKey]  ,  
        DELETED.[ActivityStartTime]   ,  
        DELETED.[ActivityEndTime]     ,  
        DELETED.[ActivityStartDateTime],  
        DELETED.[ActivityEndDateTime]  ,  
        DELETED.[MovementStartDateKey],  
        DELETED.[MovementEndDateKey]  ,  
        DELETED.[MovementStartTime]   ,  
        DELETED.[MovementEndTime]     ,  
        DELETED.[MovementStartDateTime],  
        DELETED.[MovementEndDateTime]  ,  
        DELETED.[NextMovementActivityDetailKey],
        DELETED.[NextMovementStartDateTime]    ,
        DELETED.[IsLastMovement]      ,
  
        DELETED.[StartOdometer]       ,  
        DELETED.[EndOdometer]         ,  
        DELETED.[StartEngineSeconds]  ,
        DELETED.[EndEngineSeconds]    ,
        
        DELETED.[StartGeoLocationKey] ,  
        DELETED.[EndGeoLocationKey]   ,  
        DELETED.[DistanceTravelled]   ,  
        DELETED.[Duration]            ,  
        DELETED.[DrivingTime]         ,  
        DELETED.[StandingTime]        ,  
  
        DELETED.[DriverKey]           ,  
        DELETED.[VehicleKey]          ,  
  
        DELETED.[MaxSpeed]            ,  
        DELETED.[SpeedTime]           ,  
        DELETED.[SpeedOccurs]         ,  
  
        DELETED.[MaxBrake]            ,  
        DELETED.[BrakeTime]           ,  
        DELETED.[BrakeOccurs]         ,  
  
        DELETED.[MaxAccel]            ,  
        DELETED.[AccelTime]           ,  
        DELETED.[AccelOccurs]         ,  
  
        DELETED.[MaxRPM]              ,  
        DELETED.[RPMTIme]             ,  
        DELETED.[RPMOccurs]           ,  
  
        DELETED.[OutOfGreenBandTime]  ,  
  
        DELETED.[ExcessiveIdleTime]   ,  
        DELETED.[ExcessiveIdleOccurs] ,  
  
        DELETED.[IdleTime]            ,  
        DELETED.[IdleOccurs]          ,  
  
        DELETED.[EngineSeconds]         ,  
  
        -- calculated fields  
        DELETED.[NoGoZoneEntry]       ,  
        DELETED.[Passengers]          ,  
  
        DELETED.[FuelUsedMeasured]    ,  
        DELETED.[FuelUsedCalculated]  ,  
        DELETED.[FuelUsedHierarchy]   ,  
          
        DELETED.[NightDuration]       ,  
        DELETED.[AfterHoursDuration]  ,  
        DELETED.[TotalCarbonEmission] ,  
        DELETED.[TotalCO2Emission]    ,

        DELETED.[RoadSpeedTime]       ,
        DELETED.[RoadSpeedOccurs]     , 

        DELETED.[UTCOffsetKey]        ,  
        DELETED.[IsDeleted]           ,
        DELETED.[CreateBatchKey]      ,  
        DELETED.[UpdateBatchKey]  
      FROM
        [MiXData].dbo.FACT_ActivityDetails    AS tar
          INNER JOIN
        [StageUser1].[STAGE_FACT_ActivityDetails] AS stg
          ON  tar.OrganisationKey      = @organisationKey
          AND tar.ActivitySummaryKey   = stg.ActivitySummaryKey
          AND tar.HostID               = stg.HostID
          AND tar.ActivityStartDateKey = stg.ActivityStartDateKey
      WHERE stg.Operation in ('I','U')
      ) AS upd;
  
    -- record number of records updated  
    SELECT @recordsUpdated = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    -- Deleted records
    INSERT INTO [StageUser1].[ROLLBACK_FACT_ActivityDetails]  
    (   
      [ActivityDetailKey]   ,  
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
                              
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],
      [MovementEndDateTime]  ,
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]      ,
  
      [StartOdometer]       ,  
      [EndOdometer]         ,  
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,  
      [AccelTime]           ,  
      [AccelOccurs]         ,  
  
      [MaxRPM]              ,  
      [RPMTIme]             ,  
      [RPMOccurs]           ,  
                              
      [OutOfGreenBandTime]  ,  
  
      [ExcessiveIdleTime]   ,  
      [ExcessiveIdleOccurs] ,  
  
      [IdleTime]            ,  
      [IdleOccurs]          ,  
  
      [EngineSeconds]         ,  
  
      -- calculated fields  
      [NoGoZoneEntry]       ,  
      [Passengers]          ,  
  
      [FuelUsedMeasured]    ,  
      [FuelUsedCalculated]  ,  
      [FuelUsedHierarchy]   ,  
        
      [NightDuration]       ,
      [AfterHoursDuration]  ,
      [TotalCarbonEmission] ,
      [TotalCO2Emission]    ,
  
      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,
      [UpdateBatchKey]
    )  
    SELECT  
      [ActivityDetailKey]   ,  
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
  
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],  
      [MovementEndDateTime]  ,  
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]      ,
  
      [StartOdometer]       ,  
      [EndOdometer]         ,  
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,
      [AccelTime]           ,
      [AccelOccurs]         ,
  
      [MaxRPM]              ,
      [RPMTIme]             ,
      [RPMOccurs]           ,
  
      [OutOfGreenBandTime]  ,
  
      [ExcessiveIdleTime]   ,
      [ExcessiveIdleOccurs] ,
  
      [IdleTime]            ,
      [IdleOccurs]          ,
  
      [EngineSeconds]       ,
  
      -- calculated fields  
      [NoGoZoneEntry]       ,
      [Passengers]          ,
  
      [FuelUsedMeasured]    ,
      [FuelUsedCalculated]  ,
      [FuelUsedHierarchy]   ,
  
      [NightDuration]       ,
      [AfterHoursDuration]  ,
      [TotalCarbonEmission] ,
      [TotalCO2Emission]    ,

      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,
      [UpdateBatchKey]
    FROM  
     (UPDATE [MiXData].dbo.FACT_ActivityDetails  
      SET   
        [IsDeleted]      = 1,
        [UpdateBatchKey] = @batchKey
      OUTPUT  
        DELETED.[ActivityDetailKey]   ,  
        DELETED.[ActivitySummaryKey]  ,  
        DELETED.[OrganisationKey]     ,  
        DELETED.[HostID]              ,  
  
        DELETED.[VehicleSiteKey]      ,  
        DELETED.[ActivityStartDateKey],  
        DELETED.[ActivityEndDateKey]  ,  
        DELETED.[ActivityStartTime]   ,  
        DELETED.[ActivityEndTime]     ,  
        DELETED.[ActivityStartDateTime],  
        DELETED.[ActivityEndDateTime]  ,  
        DELETED.[MovementStartDateKey],  
        DELETED.[MovementEndDateKey]  ,  
        DELETED.[MovementStartTime]   ,  
        DELETED.[MovementEndTime]     ,  
        DELETED.[MovementStartDateTime],  
        DELETED.[MovementEndDateTime]  ,  
        DELETED.[NextMovementActivityDetailKey],
        DELETED.[NextMovementStartDateTime]    ,
        DELETED.[IsLastMovement]      ,
  
        DELETED.[StartOdometer]       ,  
        DELETED.[EndOdometer]         ,  
        DELETED.[StartEngineSeconds]  ,
        DELETED.[EndEngineSeconds]    ,

        DELETED.[StartGeoLocationKey] ,  
        DELETED.[EndGeoLocationKey]   ,  
        DELETED.[DistanceTravelled]   ,  
        DELETED.[Duration]            ,  
        DELETED.[DrivingTime]         ,  
        DELETED.[StandingTime]        ,  
  
        DELETED.[DriverKey]           ,  
        DELETED.[VehicleKey]          ,  
  
        DELETED.[MaxSpeed]            ,  
        DELETED.[SpeedTime]           ,  
        DELETED.[SpeedOccurs]         ,  
  
        DELETED.[MaxBrake]            ,  
        DELETED.[BrakeTime]           ,  
        DELETED.[BrakeOccurs]         ,  
  
        DELETED.[MaxAccel]            ,  
        DELETED.[AccelTime]           ,  
        DELETED.[AccelOccurs]         ,  
  
        DELETED.[MaxRPM]              ,  
        DELETED.[RPMTIme]             ,  
        DELETED.[RPMOccurs]           ,  
  
        DELETED.[OutOfGreenBandTime]  ,  
  
        DELETED.[ExcessiveIdleTime]   ,  
        DELETED.[ExcessiveIdleOccurs] ,  
  
        DELETED.[IdleTime]            ,  
        DELETED.[IdleOccurs]          ,  
  
        DELETED.[EngineSeconds]         ,  
  
        -- calculated fields  
        DELETED.[NoGoZoneEntry]       ,  
        DELETED.[Passengers]          ,  
  
        DELETED.[FuelUsedMeasured]    ,  
        DELETED.[FuelUsedCalculated]  ,  
        DELETED.[FuelUsedHierarchy]   ,  
          
        DELETED.[NightDuration]       ,  
        DELETED.[AfterHoursDuration]  ,  
        DELETED.[TotalCarbonEmission] ,  
        DELETED.[TotalCO2Emission]    ,

        DELETED.[RoadSpeedTime]       ,
        DELETED.[RoadSpeedOccurs]     ,

        DELETED.[UTCOffsetKey]        , 
        DELETED.[IsDeleted]           , 
        DELETED.[CreateBatchKey]      ,  
        DELETED.[UpdateBatchKey]  
      FROM   
        [MiXData].dbo.FACT_ActivityDetails    AS tar
          INNER JOIN
        [StageUser1].[STAGE_FACT_ActivityDetails] AS stg
          ON  tar.OrganisationKey      = @organisationKey
          AND tar.ActivitySummaryKey   = stg.ActivitySummaryKey
          AND tar.HostID               = stg.HostID
          AND tar.ActivityStartDateKey = stg.ActivityStartDateKey
      WHERE stg.Operation = 'D'
      ) AS del
    WHERE
      UpdateBatchKey <> @batchKey;

    -- record number of records deleted  
    SELECT @recordsDeleted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    -- create rollback index  
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_ActivityDetails_ActivitySummaryKey_HostID  
      ON [StageUser1].[ROLLBACK_FACT_ActivityDetails](ActivitySummaryKey,HostID);  
  
    -- insert records not existing in DW  
    INSERT [MiXData].dbo.FACT_ActivityDetails  
    (   
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
  
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],  
      [MovementEndDateTime]  ,  
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]      ,
  
      [StartOdometer]       ,  
      [EndOdometer]         ,
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,  
      [AccelTime]           ,  
      [AccelOccurs]         ,  
  
      [MaxRPM]              ,  
      [RPMTIme]             ,  
      [RPMOccurs]           ,  
                              
      [OutOfGreenBandTime]  ,  
  
      [ExcessiveIdleTime]   ,  
      [ExcessiveIdleOccurs] ,  
  
      [IdleTime]            ,  
      [IdleOccurs]          ,  
  
      [EngineSeconds]         ,  
  
      -- calculated fields  
      [NoGoZoneEntry]       ,  
      [Passengers]          ,  
  
      [FuelUsedMeasured]    ,  
      [FuelUsedCalculated]  ,  
      [FuelUsedHierarchy]   ,  
  
      [NightDuration]       ,  
      [AfterHoursDuration]  ,  
      [TotalCarbonEmission] ,  
      [TotalCO2Emission]    ,
        
      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,  
      [UpdateBatchKey]  
    )  
    SELECT  
      stg.[ActivitySummaryKey]  ,  
      @organisationKey          ,  
      stg.[HostID]              ,  
  
      ISNULL(stg.[VehicleSiteKey]      ,-1),  
      stg.[ActivityStartDateKey],  
      stg.[ActivityEndDateKey]  ,  
      stg.[ActivityStartTime]   ,  
      stg.[ActivityEndTime]     ,  
      stg.[ActivityStartDateTime],  
      stg.[ActivityEndDateTime]  ,  
      stg.[MovementStartDateKey],  
      stg.[MovementEndDateKey]  ,  
      stg.[MovementStartTime]   ,  
      stg.[MovementEndTime]     ,  
      stg.[MovementStartDateTime],  
      stg.[MovementEndDateTime]  ,  
      [NextMovementActivityDetailKey] = -1,
      [NextMovementStartDateTime]     = @unknownDateDefault,
      ISNULL(stg.[IsLastMovement],0),
  
      stg.[StartOdometer]       ,  
      stg.[EndOdometer]         ,  
      stg.[StartEngineSeconds]  ,
      stg.[EndEngineSeconds]    ,

      ISNULL(stg.[StartGeoLocationKey] ,-1),  
      ISNULL(stg.[EndGeoLocationKey]   ,-1),  
      stg.[DistanceTravelled]   ,  
      stg.[Duration]            ,  
      stg.[DrivingTime]         ,  
      stg.[StandingTime]        ,  
  
      ISNULL(stg.[DriverKey]           ,-1),  
      ISNULL(stg.[VehicleKey]          ,-1),  
  
      stg.[MaxSpeed]            ,  
      stg.[SpeedTime]           ,  
      stg.[SpeedOccurs]         ,  
  
      stg.[MaxBrake]            ,  
      stg.[BrakeTime]           ,  
      stg.[BrakeOccurs]         ,  
  
      stg.[MaxAccel]            ,  
      stg.[AccelTime]           ,  
      stg.[AccelOccurs]         ,  
  
      stg.[MaxRPM]              ,  
      stg.[RPMTIme]             ,  
      stg.[RPMOccurs]           ,  
  
      stg.[OutOfGreenBandTime]  ,  
  
      stg.[ExcessiveIdleTime]   ,  
      stg.[ExcessiveIdleOccurs] ,  
  
      stg.[IdleTime]            ,  
      stg.[IdleOccurs]          ,  
  
      stg.[EngineSeconds]         ,  
  
      -- calculated fields  
      stg.[NoGoZoneEntry]       ,  
      stg.[Passengers]          ,  
        
      ISNULL(stg.[FuelUsedMeasured]  ,0.0),  
      ISNULL(stg.[FuelUsedCalculated],0.0),  
      ISNULL(stg.[FuelUsedHierarchy] ,-1) ,  
  
      ISNULL(stg.[NightDuration]     ,0.0),
      stg.[AfterHoursDuration]  ,  
      stg.[TotalCarbonEmission] ,  
      stg.[TotalCO2Emission]    ,

      ISNULL(stg.[RoadSpeedTime],0),
      ISNULL(stg.[RoadSpeedOccurs],0),

      stg.[UTCOffsetKey]        ,
      0                         , -- IsDeleted
      @batchKey                 ,  
      @batchKey  
    FROM   
      [StageUser1].[STAGE_FACT_ActivityDetails] AS stg  
    WHERE  
        stg.Operation in ('I','U')  
    AND NOT EXISTS (SELECT 1  
                    FROM  
                      [StageUser1].[ROLLBACK_FACT_ActivityDetails] AS roll WITH (NOLOCK)  
                    WHERE  
                        stg.ActivitySummaryKey = roll.ActivitySummaryKey  
                    AND stg.HostID             = roll.HostID);  
  
    -- record number of records inserted  
    SELECT @recordsInserted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
    RETURN -1;  
  END CATCH;  
  
  --------------------------------------------------------------------  
  -- 6. Update ActivityDetailKey foreignkeys on other tables  
  --------------------------------------------------------------------  
  
  BEGIN TRY  
  
    ------------------------------------------  
    -- ActivityDetailKey (beter to get ActivityDetailKey on STG and then use with Lookups for other FACT tables)  
    UPDATE [StageUser1].[STAGE_FACT_ActivityDetails]  
    SET  
      ActivityDetailKey = fad.ActivityDetailKey  
    FROM  
      [StageUser1].[STAGE_FACT_ActivityDetails] stg  
        INNER JOIN  
      [MiXData].dbo.FACT_ActivityDetails    fad WITH (NOLOCK) ON fad.ActivitySummaryKey   = stg.ActivitySummaryKey  
                                                                AND fad.HostID               = stg.HostID  
                                                                AND fad.OrganisationKey      = @organisationKey
                                                                AND fad.ActivityStartDateKey = stg.ActivityStartDateKey;

    ------------------------------------------  
    -- FACT_FuelCapture (ActivityDetailKey,FuelStopGeoLocationKey)  
    UPDATE  
      [MiXData].dbo.[FACT_FuelCapture]  
    SET  
      [ActivityDetailKey]       = fad.[ActivityDetailKey],  
      [FuelStopGeoLocationKey]  = fad.[StartGeoLocationKey]  
    FROM  
      [MiXData].dbo.[FACT_FuelCapture]        ffc
        INNER JOIN  
      #VehiclesLookup                         dvf               ON ffc.VehicleKey      = dvf.VehicleKey  
        INNER JOIN  
      [StageUser1].STAGE_FACT_ActivityDetails fad WITH (NOLOCK) ON fad.VehicleID       = dvf.HostID  
    WHERE  
        ffc.[OrganisationKey] = @organisationKey  
    AND ffc.[FillOdometer]    BETWEEN fad.[StartOdometer] AND fad.[EndOdometer];  
  
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivityDetails_ActivityStartDateTime_ActivityEndDateTime   
      ON [StageUser1].[STAGE_FACT_ActivityDetails](VehicleID,ActivityStartDateTime,ActivityEndDateTime)  
      INCLUDE(ActivityDetailKey);  
  
    ------------------------------------------  
    -- FACT_PositionDetails (ActivityDetailKey)  
    -- removed for now  

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='6. Update ActivityDetailKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Update ActivityDetailKey foreignkeys on other tables';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
    RETURN -1;  
  END CATCH;  

  --------------------------------------------------------------------  
  -- 7. Update Overall ActivityDetail values
  -------------------------------------------------------------------- 

  BEGIN TRY

    ------------------------------------------
    -- calc for NextMovement
    -- 7.1.1 Get min MovementStartDateTime for STAGE for each vehicle
    INSERT INTO #lastMovementStartDateTime
    (
      VehicleID               ,
      MinMovementStartDateTime
    )
    SELECT
      stg.VehicleID ,
      MIN(MovementStartDateTime)
    FROM
      [StageUser1].STAGE_FACT_ActivityDetails stg
    WHERE
      stg.HostID > 0
--      MovementStartDateTime > @validDateStartTime
    GROUP BY
      stg.VehicleID;

    CREATE CLUSTERED INDEX IX_lastMovementStartDateTime ON #lastMovementStartDateTime(VehicleID,MinMovementStartDateTime);

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='7.1.1 Get STAGE LastMovement', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7.1  Get STAGE LastMovement';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    -- 7.1.2. Get PreviousMovementStartDateTime from FAD because we need to recalc from that point onwards
    UPDATE
      #lastMovementStartDateTime
    SET
      PrevMovementStartDateTime = ISNULL((SELECT MAX(fad.MovementStartDateTime)
                                          FROM
                                            #VehiclesLookup                    dvh
                                              INNER JOIN
                                            [MiXData].dbo.FACT_ActivityDetails fad  WITH (NOLOCK) ON lm.VehicleID        = dvh.HostID
                                                                                                 AND fad.VehicleKey      = dvh.VehicleKey
                                          WHERE
                                              fad.MovementStartDateTime > '19000101'
                                          AND fad.MovementStartDateTime < lm.MinMovementStartDateTime),
                                          lm.MinMovementStartDateTime)
    FROM
      #lastMovementStartDateTime lm;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='7.1.2 Get Previous Movement from FAD', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7.2 Get Previous Movement from FAD';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  


    -- 7.1.3 get list of records to be updated with the cols necessary to do the calc
    INSERT INTO #recordsForNextMovementCalc
    ( 
      VehicleKey                    ,
      VehicleID                     ,
      MovementStartDateTime         ,
      MovementEndDateTime           ,
      ActivityDetailKey
    )
    SELECT
      fad.VehicleKey           ,
      lm.VehicleID             ,
      fad.MovementStartDateTime,
      fad.MovementEndDateTime  ,
      fad.ActivityDetailKey
    FROM
      #lastMovementStartDateTime         lm
        INNER JOIN
      #VehiclesLookup                    dvh                ON dvh.HostID           = lm.VehicleID
        INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails fad  WITH (NOLOCK) ON fad.VehicleKey       = dvh.VehicleKey
    WHERE
        fad.HostID > 0
    --    fad.MovementStartDateTime >  @validDateStartTime
    --AND fad.MovementEndDateTime   >  @validDateStartTime
    AND fad.MovementStartDateTime >= lm.PrevMovementStartDateTime;

    -- DROP INDEX IX_recordsForNextMovementCalc ON #recordsForNextMovementCalc;
    CREATE CLUSTERED INDEX IX_recordsForNextMovementCalc
      ON #recordsForNextMovementCalc
      (VehicleID,MovementStartDateTime,ActivityDetailKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='7.1.3 Get activities to process from FAD', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7.3 Get activities to process from FAD';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    -- 7.1.4 calculate values
    UPDATE
      #recordsForNextMovementCalc
    SET
      NextMovementStartDateTime = ISNULL((SELECT MIN(nm1.MovementStartDateTime)
                                          FROM #recordsForNextMovementCalc nm1
                                          WHERE
                                              nm1.VehicleID             = nm.VehicleID
                                          AND nm1.MovementStartDateTime > nm.MovementStartDateTime),
                                         nm.MovementStartDateTime)
    FROM                                 
      #recordsForNextMovementCalc nm;
-- 3s

    UPDATE
      #recordsForNextMovementCalc
    SET
      NextMovementActivityDetailKey = ISNULL((SELECT MIN(nm1.ActivityDetailKey)
                                              FROM #recordsForNextMovementCalc nm1
                                              WHERE
                                                  nm1.VehicleID = nm.VehicleID
                                              AND nm1.MovementStartDateTime = nm.NextMovementStartDateTime),
                                             -1)
    FROM
      #recordsForNextMovementCalc nm;
-- 1s

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='7.1.4 Calculate values', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7.1.4 Calculate values';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    ------------------------------------------
    -- NextMovementStartDateTime/NextMovementActivityDetailKey
    INSERT INTO [StageUser1].[ROLLBACK_FACT_ActivityDetails]  
    (   
      [ActivityDetailKey]   ,  
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
                              
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],
      [MovementEndDateTime]  ,
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]      ,
  
      [StartOdometer]       ,  
      [EndOdometer]         ,  
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,  
      [AccelTime]           ,  
      [AccelOccurs]         ,  
  
      [MaxRPM]              ,  
      [RPMTIme]             ,  
      [RPMOccurs]           ,  
                              
      [OutOfGreenBandTime]  ,  
  
      [ExcessiveIdleTime]   ,  
      [ExcessiveIdleOccurs] ,  
  
      [IdleTime]            ,  
      [IdleOccurs]          ,  
  
      [EngineSeconds]         ,  
  
      -- calculated fields  
      [NoGoZoneEntry]       ,  
      [Passengers]          ,  
  
      [FuelUsedMeasured]    ,  
      [FuelUsedCalculated]  ,  
      [FuelUsedHierarchy]   ,  
        
      [NightDuration]       ,
      [AfterHoursDuration]  ,
      [TotalCarbonEmission] ,
      [TotalCO2Emission]    ,
  
      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,
      [UpdateBatchKey]
    )  
    SELECT  
      [ActivityDetailKey]   ,  
      [ActivitySummaryKey]  ,  
      [OrganisationKey]     ,  
      [HostID]              ,  
  
      [VehicleSiteKey]      ,  
      [ActivityStartDateKey],  
      [ActivityEndDateKey]  ,  
      [ActivityStartTime]   ,  
      [ActivityEndTime]     ,  
      [ActivityStartDateTime],  
      [ActivityEndDateTime]  ,  
      [MovementStartDateKey],  
      [MovementEndDateKey]  ,  
      [MovementStartTime]   ,  
      [MovementEndTime]     ,  
      [MovementStartDateTime],  
      [MovementEndDateTime]  ,  
      [NextMovementActivityDetailKey],
      [NextMovementStartDateTime]    ,
      [IsLastMovement]      ,
  
      [StartOdometer]       ,  
      [EndOdometer]         ,  
      [StartEngineSeconds]  ,
      [EndEngineSeconds]    ,

      [StartGeoLocationKey] ,  
      [EndGeoLocationKey]   ,  
      [DistanceTravelled]   ,  
      [Duration]            ,  
      [DrivingTime]         ,  
      [StandingTime]        ,  
  
      [DriverKey]           ,  
      [VehicleKey]          ,  
  
      [MaxSpeed]            ,  
      [SpeedTime]           ,  
      [SpeedOccurs]         ,  
  
      [MaxBrake]            ,  
      [BrakeTime]           ,  
      [BrakeOccurs]         ,  
  
      [MaxAccel]            ,
      [AccelTime]           ,
      [AccelOccurs]         ,
  
      [MaxRPM]              ,
      [RPMTIme]             ,
      [RPMOccurs]           ,
  
      [OutOfGreenBandTime]  ,
  
      [ExcessiveIdleTime]   ,
      [ExcessiveIdleOccurs] ,
  
      [IdleTime]            ,
      [IdleOccurs]          ,
  
      [EngineSeconds]       ,
  
      -- calculated fields  
      [NoGoZoneEntry]       ,
      [Passengers]          ,
  
      [FuelUsedMeasured]    ,
      [FuelUsedCalculated]  ,
      [FuelUsedHierarchy]   ,
  
      [NightDuration]       ,
      [AfterHoursDuration]  ,
      [TotalCarbonEmission] ,
      [TotalCO2Emission]    ,

      [RoadSpeedTime]       ,
      [RoadSpeedOccurs]     ,

      [UTCOffsetKey]        ,
      [IsDeleted]           ,
      [CreateBatchKey]      ,
      [UpdateBatchKey]
    FROM  
     (UPDATE
        fad
      SET
        NextMovementStartDateTime     = nm.NextMovementStartDateTime,
        NextMovementActivityDetailKey = nm.NextMovementActivityDetailKey,
        UpdateBatchKey                = @batchKey
      OUTPUT  
        DELETED.[ActivityDetailKey]   ,  
        DELETED.[ActivitySummaryKey]  ,  
        DELETED.[OrganisationKey]     ,  
        DELETED.[HostID]              ,  
  
        DELETED.[VehicleSiteKey]      ,  
        DELETED.[ActivityStartDateKey],  
        DELETED.[ActivityEndDateKey]  ,  
        DELETED.[ActivityStartTime]   ,  
        DELETED.[ActivityEndTime]     ,  
        DELETED.[ActivityStartDateTime],  
        DELETED.[ActivityEndDateTime]  ,  
        DELETED.[MovementStartDateKey],  
        DELETED.[MovementEndDateKey]  ,  
        DELETED.[MovementStartTime]   ,  
        DELETED.[MovementEndTime]     ,  
        DELETED.[MovementStartDateTime],  
        DELETED.[MovementEndDateTime]  ,  
        DELETED.[NextMovementActivityDetailKey],
        DELETED.[NextMovementStartDateTime]    ,
        DELETED.[IsLastMovement]      ,
  
        DELETED.[StartOdometer]       ,  
        DELETED.[EndOdometer]         ,  
        DELETED.[StartEngineSeconds]  ,
        DELETED.[EndEngineSeconds]    ,

        DELETED.[StartGeoLocationKey] ,  
        DELETED.[EndGeoLocationKey]   ,  
        DELETED.[DistanceTravelled]   ,  
        DELETED.[Duration]            ,  
        DELETED.[DrivingTime]         ,  
        DELETED.[StandingTime]        ,  
  
        DELETED.[DriverKey]           ,  
        DELETED.[VehicleKey]          ,  
  
        DELETED.[MaxSpeed]            ,  
        DELETED.[SpeedTime]           ,  
        DELETED.[SpeedOccurs]         ,  
  
        DELETED.[MaxBrake]            ,  
        DELETED.[BrakeTime]           ,  
        DELETED.[BrakeOccurs]         ,  
  
        DELETED.[MaxAccel]            ,  
        DELETED.[AccelTime]           ,  
        DELETED.[AccelOccurs]         ,  
  
        DELETED.[MaxRPM]              ,  
        DELETED.[RPMTIme]             ,  
        DELETED.[RPMOccurs]           ,  
  
        DELETED.[OutOfGreenBandTime]  ,  
  
        DELETED.[ExcessiveIdleTime]   ,  
        DELETED.[ExcessiveIdleOccurs] ,  
  
        DELETED.[IdleTime]            ,  
        DELETED.[IdleOccurs]          ,  
  
        DELETED.[EngineSeconds]         ,  
  
        -- calculated fields  
        DELETED.[NoGoZoneEntry]       ,  
        DELETED.[Passengers]          ,  
  
        DELETED.[FuelUsedMeasured]    ,  
        DELETED.[FuelUsedCalculated]  ,  
        DELETED.[FuelUsedHierarchy]   ,  
          
        DELETED.[NightDuration]       ,  
        DELETED.[AfterHoursDuration]  ,  
        DELETED.[TotalCarbonEmission] ,  
        DELETED.[TotalCO2Emission]    ,

        DELETED.[RoadSpeedTime]       ,
        DELETED.[RoadSpeedOccurs]     ,
        
        DELETED.[UTCOffsetKey]        , 
        DELETED.[IsDeleted]           , 
        DELETED.[CreateBatchKey]      ,  
        DELETED.[UpdateBatchKey]
      FROM
        #recordsForNextMovementCalc        nm
          INNER JOIN
        [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK) ON fad.ActivityDetailKey = nm.ActivityDetailKey
      ) AS upd
    WHERE
      UpdateBatchKey <> @batchKey;
                                     
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='7.1 Update Overall - NextMovementStartDateTime/NextMovementActivityDetailKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
    RETURN -1;  
  END CATCH;  
  
  --------------------------------------------------------------------  
  -- 8. Cleanup work tables  
  --------------------------------------------------------------------  
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging  
  -- Have to keep STG table is it gets reused in FACT_SimpleScoreDetails  
  --    TRUNCATE TABLE [StageUser1].[STAGE_FACT_ActivityDetails];  
  
  IF @debugMode = 1  -- DebugMode is true  
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 8. Cleanup work tables';  
  
  --------------------------------------------------------------------  
  -- 9. Return values for Performance Monitoring  
  --------------------------------------------------------------------  
  SELECT RecordsInserted = isnull(@recordsInserted,0),  
         RecordsUpdated  = isnull(@recordsUpdated ,0),  
         RecordsDeleted  = isnull(@recordsDeleted ,0);  
  
  IF @debugMode = 1  -- DebugMode is true  
  BEGIN  
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set  
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 9. Return values for Performance Monitoring';  
  END;  
  
  --------------------------------------------------------------------  
  RETURN 0;  
  
END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_ActivitySummary_Late_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_ActivitySummary_Late_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE @endDateDefault     date   = '20501231';
  DECLARE @maxDuration        bigint = 2147483647; -- this is the max int data type value
  DECLARE @maxSubTripDuration int    = 157680000;  -- currently set to 5 years
  DECLARE	@currentDate     datetimeoffset = SYSUTCDATETIME(); -- used for validation
  
  -- for TripClassification calc
  DECLARE @locationTaxTypeBusinessLookupKey int;
  DECLARE @locationTaxTypePrivateLookupKey  int;
  DECLARE @tripClassBusinessLookupKey       int;
  DECLARE @tripClassPrivateLookupKey        int;
  DECLARE @tripClassCommuteLookupKey        int;
  DECLARE @tripClassOtherLookupKey          int;

  -- for DutchTaxClassification calc
  DECLARE @dutchTaxEventID                  int;

  SELECT
    @dutchTaxEventID = DutchTaxEventID
  FROM
    [MiXData].dbo.DIM_Organisations WITH (NOLOCK)
  WHERE OrganisationKey = @organisationKey;

  SELECT
    @locationTaxTypeBusinessLookupKey = tcl1.LookupRID,
    @locationTaxTypePrivateLookupKey  = tcl2.LookupRID,
    @tripClassBusinessLookupKey       = tcl3.LookupRID,
    @tripClassPrivateLookupKey        = tcl4.LookupRID,
    @tripClassCommuteLookupKey        = tcl5.LookupRID,
    @tripClassOtherLookupKey          = tcl6.LookupRID
  FROM
    [MiXData].dbo.DIM_TableColumnLookups tcl1 WITH (NOLOCK)
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tcl2 WITH (NOLOCK)
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tcl3 WITH (NOLOCK)
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tcl4 WITH (NOLOCK)
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tcl5 WITH (NOLOCK)
      CROSS JOIN
    [MiXData].dbo.DIM_TableColumnLookups tcl6 WITH (NOLOCK)
  WHERE
      tcl1.LookupTable  = 'DIM_Shapes'
  AND tcl1.LookupColumn = 'ShapeTaxTypeLookupKey'
  AND tcl1.LookupKey    = 1                 -- Business Shape Tax Type
  AND tcl2.LookupTable  = 'DIM_Shapes'
  AND tcl2.LookupColumn = 'ShapeTaxTypeLookupKey'
  AND tcl2.LookupKey    = 2                 -- Private Shape Tax Type
  AND tcl3.LookupTable  = 'FACT_ActivitySummary'
  AND tcl3.LookupColumn = 'TripClassificationLookupKey'
  AND tcl3.LookupKey    = 1                 -- Business Trip Class
  AND tcl4.LookupTable  = 'FACT_ActivitySummary'
  AND tcl4.LookupColumn = 'TripClassificationLookupKey'
  AND tcl4.LookupKey    = 2                 -- Private Trip Class
  AND tcl5.LookupTable  = 'FACT_ActivitySummary'
  AND tcl5.LookupColumn = 'TripClassificationLookupKey'
  AND tcl5.LookupKey    = 3                 -- Commute Trip Class
  AND tcl6.LookupTable  = 'FACT_ActivitySummary'
  AND tcl6.LookupColumn = 'TripClassificationLookupKey'
  AND tcl6.LookupKey    = 4;                -- Other Trip Class
  
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------

  -- Have to keep STG table is it gets reused from initial Summary transform
  
  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY
  
    -- insert changed records into STG (this already done in first proc)


    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -------------------------------------------
    -- Summary Totals from Details
    --   + get the ID of the last SubTrip record for the summary record
    ;WITH ActivityDetails AS
    (
      SELECT
        dtl.TripID,
        [MaxDetailID]             = MAX(dtl.HostID)              ,
        [TotalDuration]           = SUM(CONVERT(BIGINT,dtl.[Duration])),
        [TotalDistanceTravelled]  = SUM(dtl.[DistanceTravelled]) ,
        [TotalDrivingTime]        = SUM(CONVERT(BIGINT,dtl.[DrivingTime])),
        [TotalEngineSeconds]      = SUM(CONVERT(BIGINT,dtl.[EngineSeconds])),
        [MaxSpeed]                = MAX(dtl.[MaxSpeed])          ,
        [MaxAccel]                = MAX(dtl.[MaxAccel])          ,
        [MaxBrake]                = MAX(dtl.[MaxBrake])          ,
        [MaxRPM]                  = MAX(dtl.[MaxRPM])            ,
        
        [TotalFuelUsedMeasured]   = SUM(dtl.[FuelUsedMeasured])  ,
        [TotalFuelUsedCalculated] = SUM(dtl.[FuelUsedCalculated]),
        
        [TotalIdleTime]           = SUM(CONVERT(BIGINT,dtl.[IdleTime]))    ,
        [TotalPassengers]         = SUM(dtl.[Passengers])        ,
        [TotalStandingTime]       = SUM(CONVERT(BIGINT,dtl.[StandingTime])),
        [TotalNightDuration]      = SUM(CONVERT(BIGINT,dtl.[NightDuration]))     ,
        [TotalAfterHoursDuration] = SUM(CONVERT(BIGINT,dtl.[AfterHoursDuration])),
        [TotalCarbonEmission]     = SUM(dtl.[TotalCarbonEmission]),
        [TotalCO2Emission]        = SUM(dtl.[TotalCO2Emission]),
        [MovementCount]           = SUM(CASE WHEN dtl.HostID > 0 THEN 1 ELSE 0 END)  -- dont count activities where the vehicle was stationary
      FROM
        [StageUser1].[STAGE_FACT_ActivityDetails] dtl
      GROUP BY
        dtl.TripID
    )
    UPDATE
      [StageUser1].[STAGE_FACT_ActivitySummary]
    SET
      [MaxDetailID]             = slc.[MaxDetailID]            ,
      [TotalDuration]           = CASE WHEN ABS(slc.[TotalDuration]          ) > @maxDuration THEN -2 ELSE slc.[TotalDuration]           END,
      [TotalDistanceTravelled]  = slc.[TotalDistanceTravelled] ,
      [TotalDrivingTime]        = CASE WHEN ABS(slc.[TotalDrivingTime]       ) > @maxDuration THEN -2 ELSE slc.[TotalDrivingTime]        END,
      [TotalEngineSeconds]      = CASE WHEN ABS(slc.[TotalEngineSeconds]     ) > @maxDuration THEN -2 ELSE slc.[TotalEngineSeconds]      END,
      [MaxSpeed]                = slc.[MaxSpeed]               ,
      [MaxAccel]                = slc.[MaxAccel]               ,
      [MaxBrake]                = slc.[MaxBrake]               ,
      [MaxRPM]                  = slc.[MaxRPM]                 ,
      [TotalFuelUsedMeasured]   = slc.[TotalFuelUsedMeasured]  ,
      [TotalFuelUsedCalculated] = slc.[TotalFuelUsedCalculated],
      [TotalPassengers]         = slc.[TotalPassengers]        ,
      [TotalIdleTime]           = CASE WHEN ABS(slc.[TotalIdleTime]          ) > @maxDuration THEN -2 ELSE slc.[TotalIdleTime]           END,
      [TotalStandingTime]       = CASE WHEN ABS(slc.[TotalStandingTime]      ) > @maxDuration THEN -2 ELSE slc.[TotalStandingTime]       END,
      [TotalNightDuration]      = CASE WHEN ABS(slc.[TotalNightDuration]     ) > @maxDuration THEN -2 ELSE slc.[TotalNightDuration]      END,
      [TotalAfterHoursDuration] = CASE WHEN ABS(slc.[TotalAfterHoursDuration]) > @maxDuration THEN -2 ELSE slc.[TotalAfterHoursDuration] END,
      [TotalCarbonEmission]     = slc.[TotalCarbonEmission],
      [TotalCO2Emission]        = slc.[TotalCO2Emission],
      [MovementCount]           = slc.[MovementCount]
    FROM
      [StageUser1].[STAGE_FACT_ActivitySummary] stg
        INNER JOIN
      ActivityDetails                          slc ON slc.TripID = stg.HostID;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update ActivityDetails rollup', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    -------------------------------------------
    -- First SubTripData
    UPDATE
      [StageUser1].[STAGE_FACT_ActivitySummary]
    SET
      [StartOdometer]       = dtl.[StartOdometer]      ,
      [StartEngineSeconds]  = dtl.[StartEngineSeconds] ,
      [StartGeoLocationKey] = ISNULL(dtl.[StartGeoLocationKey],-1)
    FROM
      [StageUser1].[STAGE_FACT_ActivitySummary] stg
        INNER JOIN
      [StageUser1].[STAGE_FACT_ActivityDetails] dtl ON stg.HostID = dtl.TripID
    WHERE
      dtl.HostID IN (0,1)  -- First Detail(SubTrip) record

    -------------------------------------------
    -- Last SubTripData
    UPDATE
      [StageUser1].[STAGE_FACT_ActivitySummary]
    SET
      [EndOdometer]       = dtl.[EndOdometer]      ,
      [EndEngineSeconds]  = dtl.[EndEngineSeconds] ,
      [EndGeoLocationKey] = ISNULL(dtl.[EndGeoLocationKey],-1)
    FROM
      [StageUser1].[STAGE_FACT_ActivitySummary] stg
        INNER JOIN
      [StageUser1].[STAGE_FACT_ActivityDetails] dtl ON stg.HostID = dtl.TripID
    WHERE
      dtl.HostID = stg.MaxDetailID  -- Last Detail(SubTrip) record

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3 Update Start/End values', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    -------------------------------------------
    -- AverageSimpleDriverScore
    -- removed

    ------------------------------------------
    -- NextTripStartDateTime

    CREATE INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_HostID 
      ON [StageUser1].[STAGE_FACT_ActivitySummary](VehicleID,ActivityStartDateTime,HostID);
    
    ;WITH
    NextTrip (VehicleID,ActivityStartDateTime,HostID,SequenceNo) AS
    (
      SELECT
        VehicleID,
        ActivityStartDateTime,
        HostID,
        RANK() OVER (PARTITION BY VehicleID ORDER BY ActivityStartDateTime,HostID) AS 'SequenceNo'
      FROM
        [StageUser1].[STAGE_FACT_ActivitySummary]
    ),
    NextTripStart (HostID,NextTripStartDateTime) AS
    (
      SELECT
        nt1.HostID,
        nt2.ActivityStartDateTime AS NextTripStartDateTime
      FROM
        NextTrip nt1
          INNER JOIN
        NextTrip nt2 ON nt1.VehicleID = nt2.VehicleID AND nt1.SequenceNo + 1 = nt2.SequenceNo
    )
    UPDATE
      [StageUser1].[STAGE_FACT_ActivitySummary]
    SET
      NextTripStartDateTime = n.NextTripStartDateTime
    FROM
      [StageUser1].[STAGE_FACT_ActivitySummary] stg
        INNER JOIN
      NextTripStart                            n   ON stg.HostID = n.HostID;

    CREATE INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_NextTripStartDateTime
      ON [StageUser1].[STAGE_FACT_ActivitySummary](VehicleID,ActivityStartDateTime,NextTripStartDateTime);

    UPDATE
      [StageUser1].[STAGE_FACT_ActivitySummary]
    SET
      NextTripStartDateTime = ActivityEndDateTime
    WHERE NextTripStartDateTime IS NULL;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.5 Update AverageSimpleDriverScore', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    ------------------------------------------
    -- TripClassificationLookupKey
    --   Default of Other TripClass

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_ActivityEndDateTime
      ON [StageUser1].[STAGE_FACT_ActivitySummary](VehicleID,ActivityStartDateTime,ActivityEndDateTime);

    -- Hierachy 1 - User/AutoClass table TaxTripClassification
    UPDATE
      [StageUser1].[STAGE_FACT_ActivitySummary]
    SET
      TripClassificationLookupKey = CASE
                                      WHEN ttc.sTripClassification = 'resBusinessTrip'
                                        THEN @tripClassBusinessLookupKey
                                      WHEN ttc.sTripClassification = 'resPrivateTrip'
                                        THEN @tripClassPrivateLookupKey
                                      ELSE @tripClassOtherLookupKey
                                    END,
      TripClassificationHierarchy = 1
    FROM
      [StageUser1].[STAGE_FACT_ActivitySummary] stg
        INNER JOIN
      [StageUser1].TaxTripClassification        ttc ON stg.HostID = ttc.liTripID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.6.1 Update calculated cols - TripClassificationLookupKey - H1', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    -- Hierarchy 2
    --   basically the same as logic used to calculate auto tax in table TaxTripClassification
    --   IF either start or end of trip in business shape tax type then  Business Trip Class
    ;WITH BusinessTripClass (HostID) AS
    (
      SELECT 
        stg1.HostID
      FROM
        [StageUser1].[STAGE_FACT_ActivitySummary]  stg1
          INNER JOIN
        [MiXData].dbo.DIM_GeoLocationsToShapes dgs WITH (NOLOCK) ON stg1.StartGeoLocationKey = dgs.GeoLocationKey
          INNER JOIN
        [MiXData].dbo.DIM_Shapes               dsp WITH (NOLOCK) ON dgs.ShapeKey             = dsp.ShapeKey
      WHERE
          stg1.TripClassificationHierarchy = -1
      AND dsp.OrganisationKey       = @organisationKey
      AND dsp.ShapeTaxTypeLookupKey = @locationTaxTypeBusinessLookupKey
      UNION
      SELECT 
        stg2.HostID
      FROM
        [StageUser1].[STAGE_FACT_ActivitySummary]  stg2
          INNER JOIN
        [MiXData].dbo.DIM_GeoLocationsToShapes dgs WITH (NOLOCK) ON stg2.EndGeoLocationKey   = dgs.GeoLocationKey
          INNER JOIN
        [MiXData].dbo.DIM_Shapes               dsp WITH (NOLOCK) ON dgs.ShapeKey             = dsp.ShapeKey
      WHERE
          stg2.TripClassificationHierarchy = -1
      AND dsp.OrganisationKey       = @organisationKey
      AND dsp.ShapeTaxTypeLookupKey = @locationTaxTypeBusinessLookupKey
    )
    UPDATE
      [StageUser1].[STAGE_FACT_ActivitySummary]
    SET
      TripClassificationLookupKey = @tripClassBusinessLookupKey,
      TripClassificationHierarchy = 2
    FROM
      [StageUser1].[STAGE_FACT_ActivitySummary]  stg
        INNER JOIN
      BusinessTripClass                         btc WITH (NOLOCK) ON stg.HostID = btc.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.6.2 Update calculated cols - TripClassificationLookupKey - H2', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    -- Hierarchy 3 - TerminalData
    -- if more than 1 record per trip then use in decending order Business,Private,Commute,Other
    ;WITH TerminalData (HostID,TripTaxClass) AS
    (
      SELECT
        stg.HostID,
        TripTaxClass = CASE
                         WHEN ftd.MenuID IN ('BUSDR', 'JOBDR')
                           THEN 1     -- Business
                         WHEN ftd.MenuID = 'WTHDR'
                           THEN 2     -- Commute
                         WHEN ftd.MenuID = 'PVTDR'
                           THEN 3     -- Private
                         ELSE 
                           4          -- Other
                       END
      FROM
        [MiXData].dbo.FACT_TerminalDetails    ftd WITH (NOLOCK)
          INNER JOIN
        [MiXData].dbo.DIM_Vehicles            dvh WITH (NOLOCK) ON ftd.VehicleKey = dvh.VehicleKey
          INNER JOIN
        [StageUser1].[STAGE_FACT_ActivitySummary] stg               ON dvh.HostID     = stg.VehicleID
      WHERE
          stg.TripClassificationHierarchy = -1
      AND dvh.OrganisationKey  = @organisationKey
      AND ftd.MenuID           IN ('ACCDR', 'BUSDR', 'HTWDR', 'JOBDR', 'MNTDR', 'OTHDR', 'PVTDR', 'UNSDR', 'WTHDR')
      AND ftd.TerminalDateTime BETWEEN stg.ActivityStartDateTime AND stg.ActivityEndDateTime
    ),
    TripTaxClassification (HostID,TripTaxClass) AS
    (
      SELECT
        HostID,
        MIN(TripTaxClass)
      FROM
        TerminalData
      GROUP BY
        HostID
    )
    UPDATE
      [StageUser1].[STAGE_FACT_ActivitySummary]
    SET
      TripClassificationLookupKey = CASE
                                      WHEN ttc.TripTaxClass = 1
                                        THEN @tripClassBusinessLookupKey
                                      WHEN ttc.TripTaxClass = 2
                                        THEN @tripClassCommuteLookupKey
                                      WHEN ttc.TripTaxClass = 3
                                        THEN @tripClassPrivateLookupKey
                                      ELSE
                                        @tripClassOtherLookupKey
                                    END,
      TripClassificationHierarchy = 3
    FROM
      [StageUser1].[STAGE_FACT_ActivitySummary]  stg
        INNER JOIN
      TripTaxClassification                     ttc ON stg.HostID = ttc.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.6.3 Update calculated cols - TripClassificationLookupKey - H3', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    -- Hierarchy 4 - EventData (EventID = 41)
    -- if more than 1 record per trip then use in decending order Business,Private,Commute,Other
    ;WITH TripClassEventData (HostID,TripTaxClass) AS
    (
      SELECT
        stg.HostID,
        MIN(fed.EventValue)
      FROM
        [MiXData].dbo.FACT_EventDetails       fed WITH (NOLOCK)
          INNER JOIN
        [MiXData].dbo.DIM_EventDescriptions   ded WITH (NOLOCK) ON fed.EventDescriptionKey = ded.EventDescriptionKey
          INNER JOIN
        [MiXData].dbo.DIM_Vehicles            dvh WITH (NOLOCK) ON fed.VehicleKey          = dvh.VehicleKey
          INNER JOIN
        [StageUser1].[STAGE_FACT_ActivitySummary] stg               ON dvh.HostID              = stg.VehicleID
      WHERE
          stg.TripClassificationHierarchy = -1
      AND dvh.OrganisationKey    = @organisationKey
      AND ded.OrganisationKey    = @organisationKey
      AND ded.HostID             = 41
      AND fed.EventStartDateTime BETWEEN stg.ActivityStartDateTime AND stg.NextTripStartDateTime
      GROUP BY
        stg.HostID
    )
    UPDATE
      [StageUser1].[STAGE_FACT_ActivitySummary]
    SET
      TripClassificationLookupKey = CASE
                                      WHEN ttc.TripTaxClass = 1
                                        THEN @tripClassBusinessLookupKey
                                      WHEN ttc.TripTaxClass = 2
                                        THEN @tripClassPrivateLookupKey
                                      WHEN ttc.TripTaxClass = 3
                                        THEN @tripClassCommuteLookupKey
                                      ELSE
                                        @tripClassOtherLookupKey
                                    END,
      TripClassificationHierarchy = 4
    FROM
      [StageUser1].[STAGE_FACT_ActivitySummary]  stg
        INNER JOIN
      TripClassEventData                        ttc ON stg.HostID = ttc.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.6.4 Update calculated cols - TripClassificationLookupKey - H4', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- IsDutchTaxTripClassification
    --   where EventID = DutchTaxEventID (FMOnlineDB.tbDutchTaxOptions) and EventValue > 6
    ;WITH EventData (EventDetailKey,EventStartDateTime,EventValue,VehicleID) AS
    (
      SELECT
        DISTINCT
        fed.EventDetailKey,
        fed.EventStartDateTime,
        fed.EventValue,
        stg.VehicleID
      FROM
        [MiXData].dbo.FACT_EventDetails       fed WITH (NOLOCK)
          INNER JOIN
        [MiXData].dbo.DIM_EventDescriptions   ded WITH (NOLOCK) ON fed.EventDescriptionKey = ded.EventDescriptionKey
          INNER JOIN
        [MiXData].dbo.DIM_Vehicles            dvh WITH (NOLOCK) ON fed.VehicleKey          = dvh.VehicleKey
          INNER JOIN
        [StageUser1].[STAGE_FACT_ActivitySummary] stg               ON dvh.HostID              = stg.VehicleID
      WHERE
          dvh.OrganisationKey  = @organisationKey
      AND ded.OrganisationKey  = @organisationKey
      AND ded.HostID           = @dutchTaxEventID
      AND fed.EventValue       > 6                   -- DutchTax
--      AND fed.EventStartDateTime >= stg.ActivityEndDateTime
      AND fed.EventStartDateTime BETWEEN stg.ActivityStartDateTime AND stg.NextTripStartDateTime
    ),
    DutchTaxEventData (HostID,VehicleID,EventStartDateTime) AS
    (
      SELECT
        stg.HostID,
        e.VehicleID,
        MIN(e.EventStartDateTime)
      FROM
        EventData e
          INNER JOIN
        [StageUser1].[STAGE_FACT_ActivitySummary] stg ON e.VehicleID = stg.VehicleID
      WHERE
        e.EventStartDateTime > stg.ActivityEndDateTime
      GROUP BY
        stg.HostID,
        e.VehicleID
    )
    UPDATE
      [StageUser1].[STAGE_FACT_ActivitySummary]
    SET
      IsDutchTaxTripClassification = 1
    FROM
      [StageUser1].[STAGE_FACT_ActivitySummary]  stg
        INNER JOIN
      DutchTaxEventData                         dte ON stg.HostID = dte.HostID
        INNER JOIN
      EventData                                 ed  ON dte.VehicleID          = ed.VehicleID
                                                   AND dte.EventStartDateTime = ed.EventStartDateTime;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.7 Update calculated cols - IsDutchTaxTripClassification', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF EXISTS (SELECT 1
               FROM
                 [StageUser1].[STAGE_FACT_ActivitySummary]
               WHERE
                 ActivityStartDateKey > DATEADD(DAY,1,@currentDate))
    BEGIN
      RAISERROR(N'Some Units internal clock seem to be out of sync',16,1);
    END
 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    UPDATE
      [MiXData].dbo.FACT_ActivitySummary
    SET 
      [StartOdometer]            = stg.[StartOdometer]           ,
      [EndOdometer]              = stg.[EndOdometer]             ,
      [StartEngineSeconds]       = stg.[StartEngineSeconds]      ,
      [EndEngineSeconds]         = stg.[EndEngineSeconds]        ,
      [StartGeoLocationKey]      = stg.[StartGeoLocationKey]     ,
      [EndGeoLocationKey]        = stg.[EndGeoLocationKey]       ,
      [AverageSimpleDriverScore] = stg.[AverageSimpleDriverScore],
      [TotalDuration]            = stg.[TotalDuration]           ,
      [TotalDistanceTravelled]   = stg.[TotalDistanceTravelled]  ,
      [TotalDrivingTime]         = stg.[TotalDrivingTime]        ,
      [TotalEngineSeconds]       = stg.[TotalEngineSeconds]      ,
      [MaxSpeed]                 = stg.[MaxSpeed]                ,
      [MaxAccel]                 = stg.[MaxAccel]                ,
      [MaxBrake]                 = stg.[MaxBrake]                ,
      [MaxRPM]                   = stg.[MaxRPM]                  ,
      
      [TotalFuelUsedMeasured]    = stg.[TotalFuelUsedMeasured]   ,
      [TotalFuelUsedCalculated]  = stg.[TotalFuelUsedCalculated] ,
      
      [TotalIdleTime]            = stg.[TotalIdleTime]           ,
      [TotalPassengers]          = stg.[TotalPassengers]         ,
      [TotalStandingTime]        = stg.[TotalStandingTime]       ,
      [TotalNightDuration]       = stg.[TotalNightDuration]      ,
      [TotalAfterHoursDuration]  = stg.[TotalAfterHoursDuration] ,
      [TotalCarbonEmission]      = stg.[TotalCarbonEmission]     ,
      [TotalCO2Emission]         = stg.[TotalCO2Emission]        ,
      [MovementCount]            = stg.[MovementCount]           ,

      [TripClassificationLookupKey]  = CASE
                                         WHEN tar.[TripClassificationHierarchy] = 1 AND stg.[TripClassificationHierarchy] <> 1
                                           THEN tar.[TripClassificationLookupKey]
                                         ELSE
                                           ISNULL(stg.[TripClassificationLookupKey],@tripClassOtherLookupKey)
                                       END,
      [TripClassificationHierarchy]  = CASE
                                         WHEN tar.[TripClassificationHierarchy] = 1 AND stg.[TripClassificationHierarchy] <> 1
                                           THEN tar.[TripClassificationHierarchy]
                                         ELSE
                                           stg.[TripClassificationHierarchy]
                                       END,
      [IsDutchTaxTripClassification] = ISNULL(stg.[IsDutchTaxTripClassification],0),
      [UpdateBatchKey]               = @batchKey
    FROM
      [MiXData].dbo.FACT_ActivitySummary    tar
        INNER JOIN
      [StageUser1].[STAGE_FACT_ActivitySummary] stg ON tar.[OrganisationKey] = @organisationKey
                                                  AND tar.[HostID]          = stg.[HostID];

    -- record nr of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Rollup Values', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 7. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_ActivitySummary];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Cleanup work tables';

  --------------------------------------------------------------------
  -- 8. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = 0,
         RecordsUpdated  = @recordsUpdated,
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 8. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_ActivitySummary_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_ActivitySummary_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;

  DECLARE @unknownDateDefault     date     = '00010101';
  DECLARE @unknownDateTimeDefault datetime = '19000101';
  DECLARE @endDateDefault         date     = '20501231';
  DECLARE	@currentDate            datetimeoffset = SYSUTCDATETIME(); -- used for validation

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_ActivityChanges];
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_ActivitySummary];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_ActivitySummary];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_HostID_Operation ON [StageUser1].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_ActivityStartDateKey')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_ActivityStartDateKey ON [StageUser1].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_DriverID_ActivityStartDateKey')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_DriverID_ActivityStartDateKey ON [StageUser1].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateKey')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateKey ON [StageUser1].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_ActivityEndDateTime')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_ActivityEndDateTime ON [StageUser1].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_HostID')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_HostID ON [StageUser1].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivitySummary]') AND name = N'IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_NextTripStartDateTime')
      DROP INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_NextTripStartDateTime ON [StageUser1].[STAGE_FACT_ActivitySummary];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivityChanges]') AND name = N'PK_STAGE_FACT_ActivityChanges')
      DROP INDEX PK_STAGE_FACT_ActivityChanges ON [StageUser1].[STAGE_FACT_ActivityChanges];


    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_ActivitySummary]') AND name = N'IX_ROLLBACK_FACT_ActivitySummary_HostID')
      DROP INDEX IX_ROLLBACK_FACT_ActivitySummary_HostID ON [StageUser1].[ROLLBACK_FACT_ActivitySummary];

    -- insert changed records into STG
	  INSERT INTO [StageUser1].[STAGE_FACT_ActivitySummary]
	  (
	    [Operation]            ,
	    [VehicleID]            ,
      [DriverID]             ,
      [OriginalDriverID]     ,
      [HostID]               ,
      [UnitTripNumber]       ,
      [ActivityStartDateKey] ,
      [ActivityEndDateKey]   ,
      [ActivityStartTime]    ,
      [ActivityEndTime]      ,
      [ActivityStartDateTime],
      [ActivityEndDateTime]  ,
      [UTCOffsetKey]         ,
      [TripClassificationHierarchy]
	  )
	  SELECT
	    s.[Operation]                                      ,
	    [VehicleID]             = s.VehicleID              ,
      [DriverID]              = s.DriverID               ,
      [OriginalDriverID]      = s.OriginalDriverID       ,
      [HostID]                = s.TripID                 ,
      [UnitTripNumber]        = s.TripNumber             ,
      [ActivityStartDateKey]  = CONVERT(DATE,s.TripStart),
      [ActivityEndDateKey]    = CONVERT(DATE,s.TripEnd)  ,
      [ActivityStartTime]     = CONVERT(TIME,s.TripStart),
      [ActivityEndTime]       = CONVERT(TIME,s.TripEnd)  ,
      CASE 
        WHEN s.TripStart IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.TripStart,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      CASE 
        WHEN s.TripEnd IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.TripEnd,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      utc.UTCOffsetKey,
      [TripClassificationHierarchy] = -1
	  FROM
	    [StageUser1].TripData s WITH (NOLOCK)
        CROSS JOIN
      [StageUser1].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
    WHERE
        ISNULL(CONVERT(DATETIMEOFFSET(0),s.TripStart),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime  
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.TripStart),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2. Add to STG';
    END;

    -- get list of all TripIDs with changes in both Trip/SubTripData (Summary as well as Detail records, need update both sets where necessarry)
    INSERT INTO [StageUser1].[STAGE_FACT_ActivityChanges]
    ( 
      TripID,
      IsInTripSource,
      IsInSubTripSource,
      IsInTaxClassification,
      IsMoreThanScoreChangeOnly
    )
    SELECT TripID,0,0,0,0
    FROM [StageUser1].TripData
    UNION
    SELECT TripID,0,0,0,0
    FROM [StageUser1].SubTripData std
    UNION
    SELECT liTripID,0,0,0,0
    FROM [StageUser1].TaxTripClassification;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;

    CREATE CLUSTERED INDEX PK_STAGE_FACT_ActivityChanges
      ON [StageUser1].[STAGE_FACT_ActivityChanges](TripID);

    --------------------------------
    -- IsInTripSource
    UPDATE [StageUser1].[STAGE_FACT_ActivityChanges]
    SET IsInTripSource = 1
    FROM 
      [StageUser1].[STAGE_FACT_ActivityChanges] c
        INNER JOIN
      [StageUser1].TripData                     t ON c.TripID = t.TripID;

    --------------------------------
    -- IsInSubTripSource
    UPDATE [StageUser1].[STAGE_FACT_ActivityChanges]
    SET IsInSubTripSource = 1
    FROM 
      [StageUser1].[STAGE_FACT_ActivityChanges] c
        INNER JOIN
      [StageUser1].SubTripData                  t ON c.TripID = t.TripID;

    --------------------------------
    -- IsInTaxClassification
    UPDATE [StageUser1].[STAGE_FACT_ActivityChanges]
    SET IsInTaxClassification = 1
    FROM 
      [StageUser1].[STAGE_FACT_ActivityChanges] c
        INNER JOIN
      [StageUser1].TaxTripClassification        t ON c.TripID = t.liTripID;

    --------------------------------
    -- IsMoreThanScoreChangeOnly (includes new records as well)
    
    -- get existing data from Warehouse
    SELECT
      TripID            = fas.HostID,
      Sequence          = fad.HostID,
      Depart            = CONVERT(DATETIME,NULLIF(fad.MovementStartDateTime,@unknownDateDefault)),
      Halt              = CONVERT(DATETIME,NULLIF(fad.MovementEndDateTime  ,@unknownDateDefault)),
      fad.StandingTime      ,
      TripDistance      = fad.DistanceTravelled,
      Odometer          = fad.EndOdometer,
      fad.MaxSpeed          ,
      fad.SpeedTime         ,
      fad.SpeedOccurs       ,
      fad.MaxBrake          ,
      fad.BrakeTime         ,
      fad.BrakeOccurs       ,
      fad.MaxAccel          ,
      fad.AccelTime         ,
      fad.AccelOccurs       ,
      fad.MaxRPM            ,
      fad.RPMTime           ,
      fad.RPMOccurs         ,
      GBTime            = fad.OutOfGreenBandTime,
      ExIdleTime        = fad.ExcessiveIdleTime,
      ExIdleOccurs      = fad.ExcessiveIdleOccurs,
      NIdleTime         = fad.IdleTime,
      NIdleOccurs       = fad.IdleOccurs,
      Litres            = fad.FuelUsedMeasured,
      fad.PulseValue        ,
      fad.StartEngineSeconds,
      fad.EndEngineSeconds,
      fad.StartGeoLocationKey,
      fad.EndGeoLocationKey
    INTO #ExistingSubTripData
    FROM
      [StageUser1].SubTripData           std WITH (NOLOCK)
        INNER JOIN
      [MiXData].dbo.FACT_ActivitySummary fas WITH (NOLOCK) ON fas.OrganisationKey    = @organisationKey
                                                          AND fas.HostID             = std.TripID
        INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK) ON fad.ActivitySummaryKey = fas.ActivitySummaryKey
                                                          AND fad.HostID             = std.Sequence;
    
    -- add columns to compare GPSData
    ALTER TABLE #ExistingSubTripData
    ADD
    StartLatitude  real NULL,
    StartLongitude real NULL,
    EndLatitude    real NULL,
    EndLongitude   real NULL;

    CREATE INDEX IX_ExistingSubTripData_StartGeoLocationKey ON #ExistingSubTripData(StartGeoLocationKey);
    CREATE INDEX IX_ExistingSubTripData_EndGeoLocationKey   ON #ExistingSubTripData(EndGeoLocationKey);

    -- add GPSData
    UPDATE
      e
    SET
      StartLatitude  = dgl.Latitude,
      StartLongitude = dgl.Longitude
    FROM
      #ExistingSubTripData e
        INNER JOIN
      [MiXData].dbo.DIM_GeoLocations dgl WITH (NOLOCK) ON dgl.GeoLocationKey = e.StartGeoLocationKey;

    UPDATE
      e
    SET
      EndLatitude  = dgl.Latitude,
      EndLongitude = dgl.Longitude
    FROM
      #ExistingSubTripData e
        INNER JOIN
      [MiXData].dbo.DIM_GeoLocations dgl WITH (NOLOCK) ON dgl.GeoLocationKey = e.EndGeoLocationKey;

    DROP INDEX IX_ExistingSubTripData_StartGeoLocationKey ON #ExistingSubTripData;
    DROP INDEX IX_ExistingSubTripData_EndGeoLocationKey   ON #ExistingSubTripData;

    CREATE CLUSTERED INDEX IX_ExistingSubTripData_Compare
      ON #ExistingSubTripData(TripID,Sequence);
    
    -- compare new SubTripData to existing Warehouse SubTripData to identify other than score changes
    UPDATE
      c
    SET
      IsMoreThanScoreChangeOnly = 1
    FROM
      [StageUser1].[STAGE_FACT_ActivityChanges]  c
        INNER JOIN
      #ExistingSubTripData     e                 ON e.TripID       = c.TripID
        INNER JOIN
      [StageUser1].SubTripData std WITH (NOLOCK) ON std.TripID     = e.TripID
                                                AND std.Sequence   = e.Sequence
        LEFT JOIN
      [StageUser1].GPSData     gps WITH (NOLOCK) ON std.StartGPSID = gps.liGPSID
        LEFT JOIN
      [StageUser1].GPSData     gpe WITH (NOLOCK) ON std.EndGPSID   = gpe.liGPSID
    WHERE
       ISNULL(std.Depart,@unknownDateTimeDefault) <> ISNULL(e.Depart,@unknownDateTimeDefault)
    OR ISNULL(std.Halt  ,@unknownDateTimeDefault) <> ISNULL(e.Halt  ,@unknownDateTimeDefault)
    OR ISNULL(std.StandingTime      ,0.0)         <> ISNULL(e.StandingTime      ,0.0)
    OR ISNULL(std.TripDistance      ,0.0)         <> ISNULL(e.TripDistance      ,0.0)
    OR ISNULL(std.Odometer          ,0.0)         <> ISNULL(e.Odometer          ,0.0)
    OR ISNULL(std.MaxSpeed          ,0.0)         <> ISNULL(e.MaxSpeed          ,0.0)
    OR ISNULL(std.SpeedTime         ,0.0)         <> ISNULL(e.SpeedTime         ,0.0)
    OR ISNULL(std.SpeedOccurs       ,0.0)         <> ISNULL(e.SpeedOccurs       ,0.0)
    OR ISNULL(std.MaxBrake          ,0.0)         <> ISNULL(e.MaxBrake          ,0.0)
    OR ISNULL(std.BrakeTime         ,0.0)         <> ISNULL(e.BrakeTime         ,0.0)
    OR ISNULL(std.BrakeOccurs       ,0.0)         <> ISNULL(e.BrakeOccurs       ,0.0)
    OR ISNULL(std.MaxAccel          ,0.0)         <> ISNULL(e.MaxAccel          ,0.0)
    OR ISNULL(std.AccelTime         ,0.0)         <> ISNULL(e.AccelTime         ,0.0)
    OR ISNULL(std.AccelOccurs       ,0.0)         <> ISNULL(e.AccelOccurs       ,0.0)
    OR ISNULL(std.MaxRPM            ,0.0)         <> ISNULL(e.MaxRPM            ,0.0)
    OR ISNULL(std.RPMTime           ,0.0)         <> ISNULL(e.RPMTime           ,0.0)
    OR ISNULL(std.RPMOccurs         ,0.0)         <> ISNULL(e.RPMOccurs         ,0.0)
    OR ISNULL(std.GBTime            ,0.0)         <> ISNULL(e.GBTime            ,0.0)
    OR ISNULL(std.ExIdleTime        ,0.0)         <> ISNULL(e.ExIdleTime        ,0.0)
    OR ISNULL(std.ExIdleOccurs      ,0.0)         <> ISNULL(e.ExIdleOccurs      ,0.0)
    OR ISNULL(std.NIdleTime         ,0.0)         <> ISNULL(e.NIdleTime         ,0.0)
    OR ISNULL(std.NIdleOccurs       ,0.0)         <> ISNULL(e.NIdleOccurs       ,0.0)
    OR ISNULL(std.Litres            ,0.0)         <> ISNULL(e.Litres            ,0.0)
    OR ISNULL(std.PulseValue        ,0.0)         <> ISNULL(e.PulseValue        ,0.0)
    OR ISNULL(std.StartEngineSeconds,0.0)         <> ISNULL(e.StartEngineSeconds,0.0)
    OR ISNULL(std.EndEngineSeconds  ,0.0)         <> ISNULL(e.EndEngineSeconds  ,0.0)
    OR ISNULL(gps.fLatitude         ,0.0)         <> ISNULL(e.StartLatitude     ,0.0)
    OR ISNULL(gps.fLongitude        ,0.0)         <> ISNULL(e.StartLongitude    ,0.0)
    OR ISNULL(gpe.fLatitude         ,0.0)         <> ISNULL(e.EndLatitude       ,0.0)
    OR ISNULL(gpe.fLongitude        ,0.0)         <> ISNULL(e.EndLongitude      ,0.0);

    UPDATE
      c
    SET
      IsMoreThanScoreChangeOnly = 1
    FROM
      [StageUser1].[STAGE_FACT_ActivityChanges] c
        INNER JOIN
      [StageUser1].SubTripData                  std WITH (NOLOCK) ON std.TripID = c.TripID
    WHERE
      NOT EXISTS (SELECT 1 FROM #ExistingSubTripData e WITH (NOLOCK)
                  WHERE e.TripID   = std.TripID
                  AND   e.Sequence = std.Sequence);

    DROP TABLE #ExistingSubTripData;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.1 Indentify Activity Changes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.1 Indentify Activity Changes';
    END;

    -- insert changes in details subtrips (details) that is not contained in tripsource changes (summary)
	  INSERT INTO [StageUser1].[STAGE_FACT_ActivitySummary]
	  (
	    [Operation]            ,
	    [VehicleID]            ,
      [DriverID]             ,
      [OriginalDriverID]     ,
      [HostID]               ,
      [UnitTripNumber]       ,
      [ActivityStartDateKey] ,
      [ActivityEndDateKey]   ,
      [ActivityStartTime]    ,
      [ActivityEndTime]      ,
      [ActivityStartDateTime],
      [ActivityEndDateTime]  ,
      [UTCOffsetKey]         ,
      [TripClassificationHierarchy]
	  )
	  SELECT
	    'U'                                 , -- update operation
	    [VehicleID]             = dvh.HostID,
      [DriverID]              = dd1.HostID,
      [OriginalDriverID]      = dd2.HostID,
      s.[HostID]               ,
      s.[UnitTripNumber]       ,
      s.[ActivityStartDateKey] ,
      s.[ActivityEndDateKey]   ,
      s.[ActivityStartTime]    ,
      s.[ActivityEndTime]      ,
      s.[ActivityStartDateTime],
      s.[ActivityEndDateTime]  ,
      s.[UTCOffsetKey]         ,
      [TripClassificationHierarchy] = -1
	  FROM
	    [StageUser1].[STAGE_FACT_ActivityChanges] c
	      INNER JOIN
	    [MiXData].dbo.FACT_ActivitySummary    s   WITH (NOLOCK) ON s.OrganisationKey = @organisationKey
              	                                                AND s.HostID          = c.TripID
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles            dvh WITH (NOLOCK) ON dvh.VehicleKey    = s.VehicleKey
        INNER JOIN
      [MiXData].dbo.DIM_Drivers             dd1 WITH (NOLOCK) ON dd1.DriverKey     = s.DriverKey
        INNER JOIN
      [MiXData].dbo.DIM_Drivers             dd2 WITH (NOLOCK) ON dd2.DriverKey     = s.OriginalDriverKey

	  WHERE 
	       c.IsInTripSource            = 0
	  AND (c.IsMoreThanScoreChangeOnly = 1
	  OR   c.IsInTaxClassification     = 1);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.2 Insert NonExisting ActivityDetails records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2.2 Insert NonExisting ActivityDetails records';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivitySummary_HostID_Operation 
      ON [StageUser1].[STAGE_FACT_ActivitySummary](HostID,Operation);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivitySummary_ActivityStartDateKey
      ON [StageUser1].[STAGE_FACT_ActivitySummary](ActivityStartDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivitySummary_DriverID_ActivityStartDateKey
      ON [StageUser1].[STAGE_FACT_ActivitySummary](DriverID,ActivityStartDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateKey
      ON [StageUser1].[STAGE_FACT_ActivitySummary](VehicleID,ActivityStartDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
    END;

    ------------------------------------------
    -- DriverKey/OriginalDriverSiteKey
    UPDATE
      [StageUser1].[STAGE_FACT_ActivitySummary]
    SET
      [DriverKey]             = dd.[DriverKey],
      [OriginalDriverSiteKey] = ds.[SiteKey]
    FROM
      [StageUser1].[STAGE_FACT_ActivitySummary] stg
          INNER JOIN
      [MiXData].dbo.DIM_Drivers             dd WITH (NOLOCK) ON  dd.OrganisationKey = @organisationKey
                                                                AND stg.DriverID       = dd.HostID
        LEFT JOIN
      [MiXData].dbo.DIM_Sites               ds WITH (NOLOCK) ON  dd.OrganisationKey = ds.OrganisationKey
                                                                AND dd.SiteGUID        = ds.SiteGUID
    WHERE
      ISNULL(stg.ActivityStartDateKey, @endDateDefault) BETWEEN dd.StartDateKey AND dd.EndDateKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update calculated cols - DriverKey/DriverSiteKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- OriginalDriverKey
    UPDATE
      [StageUser1].[STAGE_FACT_ActivitySummary]
    SET
      [OriginalDriverKey]     = dd.[DriverKey]
    FROM
      [StageUser1].[STAGE_FACT_ActivitySummary] stg
        INNER JOIN
      [MiXData].dbo.DIM_Drivers             dd WITH (NOLOCK) ON dd.OrganisationKey   = @organisationKey
                                                               AND stg.OriginalDriverID = dd.HostID
    WHERE
      ISNULL(stg.ActivityStartDateKey,@endDateDefault) BETWEEN dd.StartDateKey AND dd.EndDateKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update calculated cols - OriginalDriverKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- VehicleKey/OriginalVehicleSiteKey
    UPDATE [StageUser1].[STAGE_FACT_ActivitySummary]
    SET
      [VehicleKey]             = dvh.[VehicleKey],
      [OriginalVehicleSiteKey] = ds.[SiteKey]
    FROM
      [StageUser1].[STAGE_FACT_ActivitySummary] stg
         INNER JOIN
      [MiXData].dbo.DIM_Vehicles            dvh WITH (NOLOCK) ON dvh.OrganisationKey = @organisationKey
                                                                AND stg.VehicleID       = dvh.HostID
         INNER JOIN
      [MiXData].dbo.DIM_Sites               ds  WITH (NOLOCK) ON dvh.OrganisationKey = ds.OrganisationKey
                                                                AND dvh.SiteGUID        = ds.SiteGUID
    WHERE
      ISNULL(stg.ActivityStartDateKey,@endDateDefault) BETWEEN dvh.StartDateKey AND dvh.EndDateKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update calculated cols - VehicleKey/VehicleSiteKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- TotalFuelUsed (calculated on ActivityDetail)

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF EXISTS (SELECT 1
               FROM
                 [StageUser1].[STAGE_FACT_ActivitySummary]
               WHERE
                 ActivityStartDateKey > DATEADD(DAY,1,@currentDate))
    BEGIN
      RAISERROR(N'Some Units internal clock seem to be out of sync',16,1);
    END
 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Add to RollBck table
    INSERT INTO [StageUser1].[ROLLBACK_FACT_ActivitySummary]
    ( 
      [ActivitySummaryKey]          ,
      [OrganisationKey]             ,
      [HostID]                      ,
      [UnitTripNumber]              ,
      [ActivityStartDateKey]        ,
      [ActivityEndDateKey]          ,
      [ActivityStartTime]           ,
      [ActivityEndTime]             ,
      [ActivityStartDateTime]       ,
      [ActivityEndDateTime]         ,
      [VehicleKey]                  ,
      [DriverKey]                   ,
      [OriginalDriverKey]           ,
      [OriginalDriverSiteKey]       ,
      [OriginalVehicleSiteKey]      ,
      [UTCOffsetKey]                ,
      [TotalFuelUsedMeasured]       ,
      [TotalFuelUsedCalculated]     ,
      [StartOdometer]               ,
      [EndOdometer]                 ,
      [StartEngineSeconds]          ,
      [EndEngineSeconds]            ,
      [StartGeoLocationKey]         ,
      [EndGeoLocationKey]           ,
      [AverageSimpleDriverScore]    ,
      [TotalDistanceTravelled]      ,
      [TotalDrivingTime]            ,
      [TotalEngineSeconds]          ,
      [MaxSpeed]                    ,
      [MaxAccel]                    ,
      [MaxBrake]                    ,
      [MaxRPM]                      ,
      [TotalIdleTime]               ,
      [TotalPassengers]             ,
      [TotalStandingTime]           ,
      [TotalNightDuration]          ,
      [TotalAfterHoursDuration]     ,
      [TotalCarbonEmission]         ,
      [TotalCO2Emission]            ,
      [TripClassificationLookupKey] ,
      [TripClassificationHierarchy] ,
      [IsDutchTaxTripClassification],
      [MovementCount]               ,
      [IsDeleted]                   ,
      [CreateBatchKey]              ,
      [UpdateBatchKey]
    )
    SELECT
      [ActivitySummaryKey]          ,
      [OrganisationKey]             ,
      [HostID]                      ,
      [UnitTripNumber]              ,
      [ActivityStartDateKey]        ,
      [ActivityEndDateKey]          ,
      [ActivityStartTime]           ,
      [ActivityEndTime]             ,
      [ActivityStartDateTime]       ,
      [ActivityEndDateTime]         ,
      [VehicleKey]                  ,
      [DriverKey]                   ,
      [OriginalDriverKey]           ,
      [OriginalDriverSiteKey]       ,
      [OriginalVehicleSiteKey]      ,
      [UTCOffsetKey]                ,
      [TotalFuelUsedMeasured]       ,
      [TotalFuelUsedCalculated]     ,
      [StartOdometer]               ,
      [EndOdometer]                 ,
      [StartEngineSeconds]          ,
      [EndEngineSeconds]            ,
      [StartGeoLocationKey]         ,
      [EndGeoLocationKey]           ,
      [AverageSimpleDriverScore]    ,
      [TotalDistanceTravelled]      ,
      [TotalDrivingTime]            ,
      [TotalEngineSeconds]          ,
      [MaxSpeed]                    ,
      [MaxAccel]                    ,
      [MaxBrake]                    ,
      [MaxRPM]                      ,
      [TotalIdleTime]               ,
      [TotalPassengers]             ,
      [TotalStandingTime]           ,
      [TotalNightDuration]          ,
      [TotalAfterHoursDuration]     ,
      [TotalCarbonEmission]         ,
      [TotalCO2Emission]            ,
      [TripClassificationLookupKey] ,
      [TripClassificationHierarchy] ,
      [IsDutchTaxTripClassification],
      [MovementCount]               ,
      [IsDeleted]                   ,
      [CreateBatchKey]              ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [UnitTripNumber]               = stg.[UnitTripNumber]        ,
        [ActivityStartDateKey]         = stg.[ActivityStartDateKey]  ,
        [ActivityEndDateKey]           = stg.[ActivityEndDateKey]    ,
        [ActivityStartTime]            = stg.[ActivityStartTime]     ,
        [ActivityEndTime]              = stg.[ActivityEndTime]       ,
        [ActivityStartDateTime]        = stg.[ActivityStartDateTime] ,
        [ActivityEndDateTime]          = stg.[ActivityEndDateTime]   ,
        [VehicleKey]                   = ISNULL(stg.[VehicleKey]            ,-1),
        [DriverKey]                    = ISNULL(stg.[DriverKey]             ,-1),
        [OriginalDriverKey]            = ISNULL(stg.[OriginalDriverKey]     ,-1),
        [OriginalDriverSiteKey]        = ISNULL(stg.[OriginalDriverSiteKey] ,-1),
        [OriginalVehicleSiteKey]       = ISNULL(stg.[OriginalVehicleSiteKey],-1),
        [UTCOffsetKey]                 = stg.[UTCOffsetKey]          ,
        [IsDeleted]                    = 0                           ,
        UpdateBatchKey                 = @batchKey
      OUTPUT
        DELETED.[ActivitySummaryKey]          ,
        DELETED.[OrganisationKey]             ,
        DELETED.[HostID]                      ,
        DELETED.[UnitTripNumber]              ,
        DELETED.[ActivityStartDateKey]        ,
        DELETED.[ActivityEndDateKey]          ,
        DELETED.[ActivityStartTime]           ,
        DELETED.[ActivityEndTime]             ,
        DELETED.[ActivityStartDateTime]       ,
        DELETED.[ActivityEndDateTime]         ,
        DELETED.[VehicleKey]                  ,
        DELETED.[DriverKey]                   ,
        DELETED.[OriginalDriverKey]           ,
        DELETED.[OriginalDriverSiteKey]       ,
        DELETED.[OriginalVehicleSiteKey]      ,
        DELETED.[UTCOffsetKey]                ,
        DELETED.[TotalFuelUsedMeasured]       ,
        DELETED.[TotalFuelUsedCalculated]     ,
        DELETED.[StartOdometer]               ,
        DELETED.[EndOdometer]                 ,
        DELETED.[StartEngineSeconds]          ,
        DELETED.[EndEngineSeconds]            ,
        DELETED.[StartGeoLocationKey]         ,
        DELETED.[EndGeoLocationKey]           ,
        DELETED.[AverageSimpleDriverScore]    ,
        DELETED.[TotalDistanceTravelled]      ,
        DELETED.[TotalDrivingTime]            ,
        DELETED.[TotalEngineSeconds]          ,
        DELETED.[MaxSpeed]                    ,
        DELETED.[MaxAccel]                    ,
        DELETED.[MaxBrake]                    ,
        DELETED.[MaxRPM]                      ,
        DELETED.[TotalIdleTime]               ,
        DELETED.[TotalPassengers]             ,
        DELETED.[TotalStandingTime]           ,
        DELETED.[TotalNightDuration]          ,
        DELETED.[TotalAfterHoursDuration]     ,
        DELETED.[TotalCarbonEmission]         ,
        DELETED.[TotalCO2Emission]            ,
        DELETED.[TripClassificationLookupKey] ,
        DELETED.[TripClassificationHierarchy] ,
        DELETED.[IsDutchTaxTripClassification],
        DELETED.[MovementCount]               ,
        DELETED.[IsDeleted]                   ,
        DELETED.[CreateBatchKey]              ,
        DELETED.[UpdateBatchKey]
      FROM 
        [MiXData].dbo.FACT_ActivitySummary    AS tar
          INNER JOIN
        [StageUser1].[STAGE_FACT_ActivitySummary] AS stg ON tar.HostID               = stg.HostID
                                                       AND tar.OrganisationKey      = @organisationKey
      WHERE stg.Operation in ('I','U')
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    -- Deleted records
    INSERT INTO [StageUser1].[ROLLBACK_FACT_ActivitySummary]
    ( 
      [ActivitySummaryKey]          ,
      [OrganisationKey]             ,
      [HostID]                      ,
      [UnitTripNumber]              ,
      [ActivityStartDateKey]        ,
      [ActivityEndDateKey]          ,
      [ActivityStartTime]           ,
      [ActivityEndTime]             ,
      [ActivityStartDateTime]       ,
      [ActivityEndDateTime]         ,
      [VehicleKey]                  ,
      [DriverKey]                   ,
      [OriginalDriverKey]           ,
      [OriginalDriverSiteKey]       ,
      [OriginalVehicleSiteKey]      ,
      [UTCOffsetKey]                ,
      [TotalFuelUsedMeasured]       ,
      [TotalFuelUsedCalculated]     ,
      [StartOdometer]               ,
      [EndOdometer]                 ,
      [StartEngineSeconds]          ,
      [EndEngineSeconds]            ,
      [StartGeoLocationKey]         ,
      [EndGeoLocationKey]           ,
      [AverageSimpleDriverScore]    ,
      [TotalDistanceTravelled]      ,
      [TotalDrivingTime]            ,
      [TotalEngineSeconds]          ,
      [MaxSpeed]                    ,
      [MaxAccel]                    ,
      [MaxBrake]                    ,
      [MaxRPM]                      ,
      [TotalIdleTime]               ,
      [TotalPassengers]             ,
      [TotalStandingTime]           ,
      [TotalNightDuration]          ,
      [TotalAfterHoursDuration]     ,
      [TotalCarbonEmission]         ,
      [TotalCO2Emission]            ,
      [TripClassificationLookupKey] ,
      [TripClassificationHierarchy] ,
      [IsDutchTaxTripClassification],
      [MovementCount]               ,
      [IsDeleted]                   ,
      [CreateBatchKey]              ,
      [UpdateBatchKey]
    )
    SELECT
      [ActivitySummaryKey]          ,
      [OrganisationKey]             ,
      [HostID]                      ,
      [UnitTripNumber]              ,
      [ActivityStartDateKey]        ,
      [ActivityEndDateKey]          ,
      [ActivityStartTime]           ,
      [ActivityEndTime]             ,
      [ActivityStartDateTime]       ,
      [ActivityEndDateTime]         ,
      [VehicleKey]                  ,
      [DriverKey]                   ,
      [OriginalDriverKey]           ,
      [OriginalDriverSiteKey]       ,
      [OriginalVehicleSiteKey]      ,
      [UTCOffsetKey]                ,
      [TotalFuelUsedMeasured]       ,
      [TotalFuelUsedCalculated]     ,
      [StartOdometer]               ,
      [EndOdometer]                 ,
      [StartEngineSeconds]          ,
      [EndEngineSeconds]            ,
      [StartGeoLocationKey]         ,
      [EndGeoLocationKey]           ,
      [AverageSimpleDriverScore]    ,
      [TotalDistanceTravelled]      ,
      [TotalDrivingTime]            ,
      [TotalEngineSeconds]          ,
      [MaxSpeed]                    ,
      [MaxAccel]                    ,
      [MaxBrake]                    ,
      [MaxRPM]                      ,
      [TotalIdleTime]               ,
      [TotalPassengers]             ,
      [TotalStandingTime]           ,
      [TotalNightDuration]          ,
      [TotalAfterHoursDuration]     ,
      [TotalCarbonEmission]         ,
      [TotalCO2Emission]            ,
      [TripClassificationLookupKey] ,
      [TripClassificationHierarchy] ,
      [IsDutchTaxTripClassification],
      [MovementCount]               ,
      [IsDeleted]                   ,
      [CreateBatchKey]              ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]      = 1,
        [UpdateBatchKey] = @batchKey
      OUTPUT
        DELETED.[ActivitySummaryKey]          ,
        DELETED.[OrganisationKey]             ,
        DELETED.[HostID]                      ,
        DELETED.[UnitTripNumber]              ,
        DELETED.[ActivityStartDateKey]        ,
        DELETED.[ActivityEndDateKey]          ,
        DELETED.[ActivityStartTime]           ,
        DELETED.[ActivityEndTime]             ,
        DELETED.[ActivityStartDateTime]       ,
        DELETED.[ActivityEndDateTime]         ,
        DELETED.[VehicleKey]                  ,
        DELETED.[DriverKey]                   ,
        DELETED.[OriginalDriverKey]           ,
        DELETED.[OriginalDriverSiteKey]       ,
        DELETED.[OriginalVehicleSiteKey]      ,
        DELETED.[UTCOffsetKey]                ,
        DELETED.[TotalFuelUsedMeasured]       ,
        DELETED.[TotalFuelUsedCalculated]     ,
        DELETED.[StartOdometer]               ,
        DELETED.[EndOdometer]                 ,
        DELETED.[StartEngineSeconds]          ,
        DELETED.[EndEngineSeconds]            ,
        DELETED.[StartGeoLocationKey]         ,
        DELETED.[EndGeoLocationKey]           ,
        DELETED.[AverageSimpleDriverScore]    ,
        DELETED.[TotalDistanceTravelled]      ,
        DELETED.[TotalDrivingTime]            ,
        DELETED.[TotalEngineSeconds]          ,
        DELETED.[MaxSpeed]                    ,
        DELETED.[MaxAccel]                    ,
        DELETED.[MaxBrake]                    ,
        DELETED.[MaxRPM]                      ,
        DELETED.[TotalIdleTime]               ,
        DELETED.[TotalPassengers]             ,
        DELETED.[TotalStandingTime]           ,
        DELETED.[TotalNightDuration]          ,
        DELETED.[TotalAfterHoursDuration]     ,
        DELETED.[TotalCarbonEmission]         ,
        DELETED.[TotalCO2Emission]            ,
        DELETED.[TripClassificationLookupKey] ,
        DELETED.[TripClassificationHierarchy] ,
        DELETED.[IsDutchTaxTripClassification],
        DELETED.[MovementCount]               ,
        DELETED.[IsDeleted]                   ,
        DELETED.[CreateBatchKey]              ,
        DELETED.[UpdateBatchKey]
      FROM 
        [MiXData].dbo.FACT_ActivitySummary    AS tar
          INNER JOIN
        [StageUser1].[STAGE_FACT_ActivitySummary] AS stg ON tar.HostID               = stg.HostID
                                                       AND tar.OrganisationKey      = @organisationKey
      WHERE stg.Operation = 'D'
      ) AS del;

    -- record number of records deleted  
    SELECT @recordsDeleted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;  
    END;  

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_ActivitySummary_HostID
      ON [StageUser1].[ROLLBACK_FACT_ActivitySummary](HostID);

    -- insert records not existing in DW
    INSERT INTO [MiXData].dbo.FACT_ActivitySummary
    ( 
      [OrganisationKey]             ,
      [HostID]                      ,
      [UnitTripNumber]              ,
      [ActivityStartDateKey]        ,
      [ActivityEndDateKey]          ,
      [ActivityStartTime]           ,
      [ActivityEndTime]             ,
      [ActivityStartDateTime]       ,
      [ActivityEndDateTime]         ,
      [VehicleKey]                  ,
      [DriverKey]                   ,
      [OriginalDriverKey]           ,
      [OriginalDriverSiteKey]       ,
      [OriginalVehicleSiteKey]      ,
      [StartGeoLocationKey]         ,
      [EndGeoLocationKey]           ,
      [UTCOffsetKey]                , 
      [IsDeleted]                   ,
      [CreateBatchKey]              ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey            ,
      stg.[HostID]                ,
      stg.[UnitTripNumber]        ,
      stg.[ActivityStartDateKey]  ,
      stg.[ActivityEndDateKey]    ,
      stg.[ActivityStartTime]     ,
      stg.[ActivityEndTime]       ,
      stg.[ActivityStartDateTime] ,
      stg.[ActivityEndDateTime]   ,
      ISNULL(stg.[VehicleKey]            ,-1),
      ISNULL(stg.[DriverKey]             ,-1),
      ISNULL(stg.[OriginalDriverKey]     ,-1),
      ISNULL(stg.[OriginalDriverSiteKey] ,-1),
      ISNULL(stg.[OriginalVehicleSiteKey],-1),
      -1                          , -- StartGeoLocationKey
      -1                          , -- EndGeoLocationKey
      stg.[UTCOffsetKey]          , 
      0                           , -- IsDeleted
      @batchKey                   ,
      @batchKey
    FROM 
      [StageUser1].[STAGE_FACT_ActivitySummary] AS stg
    WHERE
        stg.Operation IN ('I','U')
    AND NOT EXISTS (SELECT 1
                    FROM
                      [StageUser1].[ROLLBACK_FACT_ActivitySummary] AS roll WITH (NOLOCK)
                    WHERE
                      stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  
  -- Have to keep STG table is it gets reused in the Late transform and cleaned up then

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_EventDetails_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_EventDetails_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected  int = 0;
  DECLARE @nrOfValidationErrors int = 0;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE @endDateDefault     date = '20501231';
  DECLARE @currentDate        datetimeoffset(0); -- used for validation
  DECLARE @flagStartTime      datetimeoffset(0) = SYSUTCDATETIME();
  DECLARE @flagSeq            smallint = 1;

  CREATE TABLE #EventTypeLookup
  (
    LookupRID  INT,
    LookupKey  INT
  );

  CREATE TABLE #EventDescriptionsLookup
  (
    HostID              INT,
    EventDescriptionKey INT,
    ParameterKey        INT
  );

  CREATE TABLE #VehiclesLookup
  (
    VehicleKey   INT,
    HostID       INT,
    StartDateKey DATE,
    EndDateKey   DATE
  );

  CREATE TABLE #DriversLookup
  (
    DriverKey    INT,
    HostID       INT,
    StartDateKey DATE,
    EndDateKey   DATE
  );

  CREATE TABLE #rollback
  (
    HostID       BIGINT
  );

  SELECT @currentDate = SYSUTCDATETIME();
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_EventDetails];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_EventDetails];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY
    
    -- create required source indexes
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser1].[EventData]') AND name = N'IX_EventData_StartDate')
      CREATE NONCLUSTERED INDEX IX_EventData_StartDate
        ON [StageUser1].[EventData] ( [StartDate] )
        INCLUDE ( [Operation],[EventKey],[VehicleID],[DriverID],[EventID],[StartOdometer],[StartGPSID],[EndDate],[EndOdometer],[EndGPSID],[TotalTime],[TotalOccurs],[Value])

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.1. Create Source Index', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_HostID_EventStartDateKey_Operation')
      DROP INDEX IX_STAGE_FACT_EventDetails_HostID_EventStartDateKey_Operation ON [StageUser1].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_EventDetails_HostID_Operation ON [StageUser1].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_EventStartDateKey')
      DROP INDEX IX_STAGE_FACT_EventDetails_EventStartDateKey         ON [StageUser1].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_DriverID_EventStartDateKey')
      DROP INDEX IX_STAGE_FACT_EventDetails_DriverID_EventStartDateKey  ON [StageUser1].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime')
      DROP INDEX IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime ON [StageUser1].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_TrailerUnitID')
      DROP INDEX IX_STAGE_FACT_EventDetails_TrailerUnitID             ON [StageUser1].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_EventID')
      DROP INDEX IX_STAGE_FACT_EventDetails_EventID                   ON [StageUser1].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_EventDescriptionKey_VehicleKey_EventStartDateKey')
      DROP INDEX IX_STAGE_FACT_EventDetails_EventDescriptionKey_VehicleKey_EventStartDateKey ON [StageUser1].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime_Filtered')
      DROP INDEX IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime_Filtered ON [StageUser1].[STAGE_FACT_EventDetails];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_EventDetails]') AND name = N'IX_ROLLBACK_FACT_EventDetails_HostID')
      DROP INDEX IX_ROLLBACK_FACT_EventDetails_HostID ON [StageUser1].[ROLLBACK_FACT_EventDetails];

    -- get EventType LookupKeys
    INSERT INTO #EventTypeLookup
    ( LookupRID, LookupKey )
    SELECT
      tcl.LookupRID,
      tcl.LookupKey
    FROM
      [MiXData].dbo.DIM_TableColumnLookups tcl WITH (NOLOCK)
    WHERE
        tcl.LookupTable  = 'FACT_EventDetails'
    AND tcl.LookupColumn = 'EventTypeLookupKey';
    
    CREATE CLUSTERED INDEX IX_EventTypeLookup ON #EventTypeLookup(LookupRID);

    -- insert changed records into STG
    INSERT INTO [StageUser1].[STAGE_FACT_EventDetails]
    (
      [Operation]          ,
      [HostID]             ,

      [DriverID]           ,
      [VehicleID]          ,
      [TrailerUnitID]      ,
      [EventID]            ,
      [StartGPSID]         ,
      [EndGPSID]           ,
      [EventTypeLookupKey] ,

      [EventStartDateKey]  ,
      [EventEndDateKey]    ,
      [EventStartTime]     ,
      [EventEndTime]       ,
      [EventStartDateTime] ,
      [EventEndDateTime]   ,

      [StartOdometer]      ,
      [EndOdometer]        ,
      [EventValue]         ,
      [TotalOccurs]        ,
      [TotalTime]          ,
      [Litres]             ,
      [PulseParameterID]   ,
      [PulseValue]         ,
      [UTCOffsetKey]       ,
      [VideoKey]
    )
    SELECT
      s.Operation         ,
      HostID = s.EventKey ,

      s.DriverID          ,
      s.VehicleID         ,
      [TrailerUnitID] = CASE -- can also use DIM_CalibrationParameter.ValueFormat (11 passengers, 12 trailers)
                          WHEN s.EventID IN (31,32,33,34,35,118,119,120,121,122,123,124,125)
                            THEN CONVERT(INT,s.Value)
                          ELSE
                            NULL
                        END,
      s.EventID            ,
      s.StartGPSID         ,
      s.EndGPSID           ,
      ISNULL(et.LookupRID,-1),
      
      [EventStartDateKey] = ISNULL(CONVERT(DATE,s.StartDate),@unknownDateDefault),
      [EventEndDateKey]   = CASE 
                              WHEN s.EndDate IS NULL AND EventType = 3 -- Notifications
                                THEN ISNULL(CONVERT(DATE,s.StartDate),@unknownDateDefault)
                                ELSE ISNULL(CONVERT(DATE,s.EndDate)  ,@unknownDateDefault)
                            END,
      [EventStartTime]    = CONVERT(TIME(0),ISNULL(s.StartDate,0)),
      [EventEndTime]      = CASE 
                              WHEN s.EndDate IS NULL AND EventType = 3 -- Notifications
                                THEN CONVERT(TIME(0),ISNULL(s.StartDate,0))
                                ELSE CONVERT(TIME(0),ISNULL(s.EndDate  ,0)) 
                            END,
      [EventStartDateTime]= CASE 
                              WHEN s.StartDate IS NULL
                                THEN @unknownDateDefault
                                ELSE TODATETIMEOFFSET(s.StartDate,ISNULL(utc.UTCOffsetMinutes,0))
                            END,
      [EventEndDateTime]  = CASE 
                              WHEN s.EndDate IS NULL AND EventType = 3 -- Notifications
                                THEN
                                  CASE 
                                    WHEN s.StartDate IS NULL
                                      THEN @unknownDateDefault
                                      ELSE TODATETIMEOFFSET(s.StartDate,ISNULL(utc.UTCOffsetMinutes,0))
                                  END
                              WHEN s.EndDate IS NULL
                                THEN @unknownDateDefault
                              ELSE TODATETIMEOFFSET(s.EndDate  ,ISNULL(utc.UTCOffsetMinutes,0))
                            END,
      [StartOdometer]     = s.StartOdometer,
      [EndOdometer]       = s.EndOdometer  ,
      [EventValue]        = s.Value        ,
      s.TotalOccurs                        ,
      s.TotalTime                          ,
      s.Litres                             ,
      s.PulseParameterID                   ,
      s.PulseValue                         ,
      utc.UTCOffsetKey                     ,
      s.VideoKey
    FROM
      [StageUser1].EventData s WITH (NOLOCK)
        CROSS JOIN
      [StageUser1].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
        LEFT JOIN
      #EventTypeLookup                       et ON et.LookupKey = s.EventType
    WHERE
      ISNULL(CONVERT(DATETIMEOFFSET(0),s.StartDate),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime
  AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.StartDate),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
        
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create indexes required for lookups
    --CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_HostID_Operation 
    --  ON [StageUser1].[STAGE_FACT_EventDetails](HostID,Operation);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_EventStartDateKey
      ON [StageUser1].[STAGE_FACT_EventDetails](EventStartDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_DriverID_EventStartDateKey
      ON [StageUser1].[STAGE_FACT_EventDetails](DriverID,EventStartDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime
      ON [StageUser1].[STAGE_FACT_EventDetails](VehicleID,EventStartDateKey,EventStartDateTime);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_TrailerUnitID
      ON [StageUser1].[STAGE_FACT_EventDetails](TrailerUnitID,EventStartDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_EventID
      ON [StageUser1].[STAGE_FACT_EventDetails](EventID);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    ------------------------------------------
    -- DriverKey
    INSERT INTO #DriversLookup
    ( DriverKey,HostID,StartDateKey,EndDateKey )
    SELECT
      ddr.DriverKey,
      ddr.HostID,
      ddr.StartDateKey,
      ddr.EndDateKey
    FROM
      [MiXData].dbo.DIM_Drivers ddr WITH (NOLOCK)
    WHERE ddr.OrganisationKey = @organisationKey;

    CREATE CLUSTERED INDEX IX_DriversLookup ON #DriversLookup(DriverKey);

    UPDATE stg
    SET
      [DriverKey] = ddr.[DriverKey]
    FROM
      [StageUser1].[STAGE_FACT_EventDetails] stg
        INNER JOIN
      #DriversLookup                         ddr ON stg.DriverID = ddr.HostID
    WHERE
      ISNULL(stg.EventStartDateKey,@endDateDefault) BETWEEN ddr.StartDateKey AND ddr.EndDateKey;

    ------------------------------------------
    -- VehicleKey
    INSERT INTO #VehiclesLookup
    ( VehicleKey,HostID,StartDateKey,EndDateKey )
    SELECT
      dvh.VehicleKey,
      dvh.HostID,
      dvh.StartDateKey,
      dvh.EndDateKey
    FROM
      [MiXData].dbo.DIM_Vehicles dvh WITH (NOLOCK)
    WHERE dvh.OrganisationKey = @organisationKey;

    CREATE CLUSTERED INDEX IX_Vehicles ON #VehiclesLookup(VehicleKey);

    UPDATE [StageUser1].[STAGE_FACT_EventDetails]
    SET
      [VehicleKey]             = dvh.[VehicleKey]
    FROM
      [StageUser1].[STAGE_FACT_EventDetails] stg
         INNER JOIN
      #VehiclesLookup                       dvh ON stg.VehicleID = dvh.HostID
    WHERE
      ISNULL(stg.EventStartDateKey,@endDateDefault) BETWEEN dvh.StartDateKey AND dvh.EndDateKey;

    ------------------------------------------
    -- TrailerKey (still need to identify how to connect Trialer to event)
    UPDATE [StageUser1].[STAGE_FACT_EventDetails]
    SET
      [TrailerKey]             = dtl.[TrailerKey]
    FROM
      [StageUser1].[STAGE_FACT_EventDetails] stg
         INNER JOIN
      [MiXData].dbo.DIM_Trailers         dtl WITH (NOLOCK)
         ON  dtl.OrganisationKey = @organisationKey
         AND stg.TrailerUnitID   = dtl.TrailerUnitID
    WHERE
      ISNULL(stg.EventStartDateKey,@endDateDefault) BETWEEN dtl.StartDateKey AND dtl.EndDateKey;

    ------------------------------------------
    -- EventDescriptionKey 
    INSERT INTO #EventDescriptionsLookup
    ( HostID, EventDescriptionKey,ParameterKey )
    SELECT
      HostID,
      EventDescriptionKey,
      ParameterKey
    FROM [MiXData].dbo.DIM_EventDescriptions ded WITH (NOLOCK)
    WHERE ded.OrganisationKey = @organisationKey;
    
    CREATE CLUSTERED INDEX IX_EventDescriptionsLookup ON #EventDescriptionsLookup(HostID);
    
    UPDATE [StageUser1].[STAGE_FACT_EventDetails]
    SET
      [EventDescriptionKey] = ded.[EventDescriptionKey],
      [ParameterKey]        = ded.[ParameterKey]
    FROM
      [StageUser1].[STAGE_FACT_EventDetails]  stg
         INNER JOIN
      #EventDescriptionsLookup                ded ON stg.EventID = ded.HostID;

    ------------------------------------------
    -- ParameterKey
    UPDATE
      [StageUser1].STAGE_FACT_EventDetails
    SET
      [PulseParameterKey] = dcp.ParameterKey
    FROM
      [StageUser1].STAGE_FACT_EventDetails        stg
        INNER JOIN
      [MiXData].dbo.DIM_CalibrationParameters dcp WITH (NOLOCK) ON dcp.OrganisationKey = @organisationKey
                                                                  AND dcp.HostID          = stg.PulseParameterID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update Keys', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    ------------------------------------------
    -- ActivityDetailKey 
    -- enable after initial run
    UPDATE stg
    SET [ActivityDetailKey] = fad.[ActivityDetailKey]
    -- select top 10 fad.ActivityDetailKey,stg.HostID select count(1)
    FROM
      #VehiclesLookup                       dvh
         INNER JOIN -- select top 1000 * from
      [StageUser1].[STAGE_FACT_EventDetails] stg               ON stg.VehicleID         = dvh.HostID
                                                              AND stg.EventStartDateKey > '0001-01-01'
         INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK) ON fad.VehicleKey  = dvh.VehicleKey
    WHERE
        fad.ActivityStartDateKey BETWEEN DATEADD(DAY,-7,stg.EventStartDateKey) AND stg.EventStartDateKey
    AND stg.EventStartDateTime   BETWEEN fad.ActivityStartDateTime AND fad.ActivityEndDateTime
    OPTION (FAST 10000);
    SELECT @nrOfrecordsAffected = @@ROWCOUNT;

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime_Filtered
      ON [StageUser1].[STAGE_FACT_EventDetails](VehicleID,EventStartDateKey,EventStartDateTime)
      WHERE ActivityDetailKey IS NULL;

    IF EXISTS (SELECT 1 FROM [StageUser1].[STAGE_FACT_EventDetails] WHERE ActivityDetailKey IS NULL)
    BEGIN
      UPDATE stg
      SET [ActivityDetailKey] = fad.[ActivityDetailKey]
      FROM
        #VehiclesLookup                       dvh
           INNER JOIN
        [StageUser1].[STAGE_FACT_EventDetails] stg               ON stg.VehicleID   = dvh.HostID
                                                                AND stg.EventStartDateKey > '0001-01-01'
                                                                AND stg.[ActivityDetailKey]  IS NULL
           INNER JOIN
        [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK) ON fad.VehicleKey  = dvh.VehicleKey
      WHERE stg.EventStartDateTime   BETWEEN fad.ActivityStartDateTime AND fad.ActivityEndDateTime
      OPTION (FAST 10000);
    END;
    
    SELECT @nrOfrecordsAffected = @nrOfrecordsAffected + @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3 Update ActivityDetailKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    ------------------------------------------
    -- StartGeoLocationKey (still need to get logic to calc)
    UPDATE [StageUser1].[STAGE_FACT_EventDetails]
    SET
      StartGeoLocationKey = g.GeoLocationKey
    FROM
      [StageUser1].[STAGE_FACT_EventDetails] stg
        INNER JOIN
      [StageUser1].STAGE_DIM_GeoLocations       g WITH (NOLOCK) ON stg.StartGPSID = g.HostID;


    ------------------------------------------
    -- EndGeoLocationKey (still need to get logic to calc)
    UPDATE [StageUser1].[STAGE_FACT_EventDetails]
    SET
      EndGeoLocationKey = g.GeoLocationKey
    FROM
      [StageUser1].[STAGE_FACT_EventDetails] stg
        INNER JOIN
      [StageUser1].STAGE_DIM_GeoLocations       g WITH (NOLOCK) ON stg.EndGPSID = g.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.4 Update GeoLocationKeys', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    DROP INDEX IX_STAGE_FACT_EventDetails_EventStartDateKey
      ON [StageUser1].[STAGE_FACT_EventDetails];

    DROP INDEX IX_STAGE_FACT_EventDetails_DriverID_EventStartDateKey
      ON [StageUser1].[STAGE_FACT_EventDetails];

    DROP INDEX IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime
      ON [StageUser1].[STAGE_FACT_EventDetails];

    DROP INDEX IX_STAGE_FACT_EventDetails_TrailerUnitID
      ON [StageUser1].[STAGE_FACT_EventDetails];

    DROP INDEX IX_STAGE_FACT_EventDetails_EventID
      ON [StageUser1].[STAGE_FACT_EventDetails];

    DROP INDEX IX_STAGE_FACT_EventDetails_VehicleID_EventStartDateKey_EventStartDateTime_Filtered
      ON [StageUser1].[STAGE_FACT_EventDetails];

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
        
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    SELECT @nrOfValidationErrors = ISNULL(count(1),0)
    FROM
      [StageUser1].[STAGE_FACT_EventDetails]
    WHERE
      EventStartDateKey > DATEADD(DAY,1,@currentDate);

    IF @nrOfValidationErrors > 0
    BEGIN
      DELETE [StageUser1].[STAGE_FACT_EventDetails]
      WHERE EventStartDateKey > DATEADD(DAY,1,@currentDate);

      RAISERROR(N'Some Units internal clock seem to be out of sync',16,1);
    END

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE CLUSTERED INDEX IX_STAGE_FACT_EventDetails_HostID_EventStartDateKey_Operation
      ON [StageUser1].STAGE_FACT_EventDetails(HostID,EventStartDateKey,Operation);

    -- Add to RollBck table
    INSERT INTO #rollback
    SELECT HostID
    FROM
     (UPDATE
        tar
      SET
        [DriverKey]           = ISNULL(stg.[DriverKey]          ,-1),
        [VehicleKey]          = ISNULL(stg.[VehicleKey]         ,-1),
        [TrailerKey]          = ISNULL(stg.[TrailerKey]         ,-1),
        [EventDescriptionKey] = ISNULL(stg.[EventDescriptionKey],-1),
        [EventTypeLookupKey]  = stg.[EventTypeLookupKey],
        [ActivityDetailKey]   = ISNULL(stg.[ActivityDetailKey]  ,-1),
        [EventStartDateKey]   = stg.[EventStartDateKey]  ,
        [EventEndDateKey]     = stg.[EventEndDateKey]    ,
        [EventStartTime]      = stg.[EventStartTime]     ,
        [EventEndTime]        = stg.[EventEndTime]       ,
        [EventStartDateTime]  = stg.[EventStartDateTime] ,
        [EventEndDateTime]    = stg.[EventEndDateTime]   ,
        [StartOdometer]       = stg.[StartOdometer]      ,
        [EndOdometer]         = stg.[EndOdometer]        ,
        [EventValue]          = stg.[EventValue]         ,
        [StartGeoLocationKey] = ISNULL(stg.[StartGeoLocationKey],tar.[StartGeoLocationKey]),
        [EndGeoLocationKey]   = ISNULL(stg.[EndGeoLocationKey]  ,tar.[EndGeoLocationKey]  ),     
        [TotalOccurs]         = stg.[TotalOccurs]        ,
        [TotalTime]           = stg.[TotalTime]          ,
        [ParameterKey]        = stg.[ParameterKey]       ,
        [Litres]              = stg.[Litres]             ,
        [PulseParameterKey]   = stg.[PulseParameterKey]  ,
        [PulseValue]          = stg.[PulseValue]         ,
        [UTCOffsetKey]        = stg.[UTCOffsetKey]       ,
        [VideoKey]            = stg.[VideoKey]           ,
        [IsDeleted]           = 0                        ,
        [UpdateBatchKey]      = @batchKey
      OUTPUT
        DELETED.[HostID]
      FROM 
        [StageUser1].[STAGE_FACT_EventDetails] AS stg
          INNER JOIN 
        [MiXData].dbo.FACT_EventDetails    AS tar ON tar.OrganisationKey      = @organisationKey
                                                    AND tar.HostID            = stg.HostID
--                                                    AND tar.EventStartDateKey = stg.EventStartDateKey
      WHERE stg.Operation in ('I','U')
      ) AS upd
      OPTION (FAST 1000);
    SELECT @recordsUpdated = @@ROWCOUNT;

/*
    INSERT INTO #rollback
    SELECT HostID
    FROM
     (UPDATE
        tar
      SET
        [DriverKey]           = ISNULL(stg.[DriverKey]          ,-1),
        [VehicleKey]          = ISNULL(stg.[VehicleKey]         ,-1),
        [TrailerKey]          = ISNULL(stg.[TrailerKey]         ,-1),
        [EventDescriptionKey] = ISNULL(stg.[EventDescriptionKey],-1),
        [EventTypeLookupKey]  = stg.[EventTypeLookupKey],
        [ActivityDetailKey]   = ISNULL(stg.[ActivityDetailKey]  ,-1),
        [EventStartDateKey]   = stg.[EventStartDateKey]  ,
        [EventEndDateKey]     = stg.[EventEndDateKey]    ,
        [EventStartTime]      = stg.[EventStartTime]     ,
        [EventEndTime]        = stg.[EventEndTime]       ,
        [EventStartDateTime]  = stg.[EventStartDateTime] ,
        [EventEndDateTime]    = stg.[EventEndDateTime]   ,
        [StartOdometer]       = stg.[StartOdometer]      ,
        [EndOdometer]         = stg.[EndOdometer]        ,
        [EventValue]          = stg.[EventValue]         ,
        [StartGeoLocationKey] = ISNULL(stg.[StartGeoLocationKey],tar.[StartGeoLocationKey]),
        [EndGeoLocationKey]   = ISNULL(stg.[EndGeoLocationKey]  ,tar.[EndGeoLocationKey]  ),     
        [TotalOccurs]         = stg.[TotalOccurs]        ,
        [TotalTime]           = stg.[TotalTime]          ,
        [ParameterKey]        = stg.[ParameterKey]       ,
        [Litres]              = stg.[Litres]             ,
        [PulseParameterKey]   = stg.[PulseParameterKey]  ,
        [PulseValue]          = stg.[PulseValue]         ,
        [UTCOffsetKey]        = stg.[UTCOffsetKey]       ,
        [VideoKey]            = stg.[VideoKey]           ,
        [IsDeleted]           = 0                        ,
        [UpdateBatchKey]      = @batchKey
      OUTPUT
        DELETED.[HostID]
      FROM 
        [StageUser1].[STAGE_FACT_EventDetails] AS stg
          INNER JOIN 
        [$(MiXData)].dbo.FACT_EventDetails    AS tar ON tar.OrganisationKey      = @organisationKey
                                                    AND tar.HostID            = stg.HostID
                                                    AND stg.EventStartDateKey > '00010101'
                                                    AND tar.EventStartDateKey = '00010101'
      WHERE stg.Operation in ('I','U')
      ) AS upd;
*/
    -- record number of records updated
--    SELECT @recordsUpdated = @recordsUpdated + @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- Deleted records
    INSERT INTO #rollback
    SELECT HostID
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]      = 1,
        [UpdateBatchKey] = @batchKey
      OUTPUT
        DELETED.[HostID]
      FROM 
        [MiXData].dbo.FACT_EventDetails       tar
          INNER JOIN 
        [StageUser1].[STAGE_FACT_EventDetails] stg ON tar.HostID           = stg.HostID
                                                 AND tar.OrganisationKey  = @organisationKey
      WHERE stg.Operation in ('D')
      ) AS del
    OPTION (FAST 1000);
    SELECT @recordsDeleted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;  

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_EventDetails_HostID
      ON [StageUser1].[ROLLBACK_FACT_EventDetails](HostID);

    CREATE CLUSTERED INDEX IX_rollback ON #rollback(HostID);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventDetails_HostID_Operation
      ON [StageUser1].[STAGE_FACT_EventDetails](HostID,Operation);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_EventDetails
    ( 
      [OrganisationKey]    ,
      [HostID]             ,
      [DriverKey]          ,
      [VehicleKey]         ,
      [TrailerKey]         ,
      [EventDescriptionKey],
      [EventTypeLookupKey] ,
      [ActivityDetailKey]  ,
      [EventStartDateKey]  ,
      [EventEndDateKey]    ,
      [EventStartTime]     ,
      [EventEndTime]       ,
      [EventStartDateTime] ,
      [EventEndDateTime]   ,
      [StartOdometer]      ,
      [EndOdometer]        ,
      [EventValue]         ,
      [StartGeoLocationKey],
      [EndGeoLocationKey]  ,
      [TotalOccurs]        ,
      [TotalTime]          ,
      [ParameterKey]       ,
      [Litres]             ,
      [PulseParameterKey]  ,
      [PulseValue]         ,
      [UTCOffsetKey]       ,
      [IsDeleted]          ,
      [CreateBatchKey]     ,
      [UpdateBatchKey]     ,
      [VideoKey]
    )
    SELECT
      @organisationKey         ,
      stg.[HostID]             ,
      ISNULL(stg.[DriverKey]          ,-1),
      ISNULL(stg.[VehicleKey]         ,-1),
      ISNULL(stg.[TrailerKey]         ,-1),
      ISNULL(stg.[EventDescriptionKey],-1),
      stg.[EventTypeLookupKey] ,
      ISNULL(stg.[ActivityDetailKey]  ,-1),
      stg.[EventStartDateKey]  ,
      stg.[EventEndDateKey]    ,
      stg.[EventStartTime]     ,
      stg.[EventEndTime]       ,
      stg.[EventStartDateTime] ,
      stg.[EventEndDateTime]   ,
      stg.[StartOdometer]      ,
      stg.[EndOdometer]        ,
      stg.[EventValue]         ,
      ISNULL(stg.[StartGeoLocationKey],-1),
      ISNULL(stg.[EndGeoLocationKey]  ,-1),
      stg.[TotalOccurs]        ,
      stg.[TotalTime]          ,
      stg.[ParameterKey]       ,
      stg.[Litres]             ,
      stg.[PulseParameterKey]  ,
      stg.[PulseValue]         ,
      stg.[UTCOffsetKey]       ,
      0                        , -- IsDeleted
      @batchKey                ,
      @batchKey                ,
      stg.[VideoKey]
    FROM
      [StageUser1].[STAGE_FACT_EventDetails]    AS stg
    WHERE
        stg.Operation IN ('I','U')
    AND NOT EXISTS (SELECT 1
                    FROM
                      #rollback AS roll WITH (NOLOCK)
                    WHERE
                      stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_EventDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[EventData]') AND name = N'IX_EventData_StartDate')
      DROP INDEX IX_EventData_StartDate ON [StageUser1].[EventData];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_EventRoadspeedLimits_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_EventRoadspeedLimits_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected  int = 0;
  DECLARE @nrOfValidationErrors int = 0;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE @endDateDefault     date = '20501231';
  DECLARE @currentDate        datetimeoffset(0); -- used for validation

  SELECT @currentDate = SYSUTCDATETIME();

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
--  TRUNCATE TABLE [StageUser1].[STAGE_FACT_EventRoadspeedLimits];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_EventRoadspeedLimits];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  --BEGIN TRY

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
  --  EXEC [Control].sprLogError @organisationKey = @organisationKey;
        
  --  RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  --BEGIN TRY

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
  --  EXEC [Control].sprLogError @organisationKey = @organisationKey;
  --  RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  --BEGIN TRY


  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
  --  EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;
  --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Add to RollBck table

    -- merge records
    ;WITH
    STAGE_FACT_EventRoadspeedLimits AS
    (
      SELECT
        fed.EventDetailKey,
        fed.EventStartDateKey,
        stg.SpeedLimit,
        IsDeleted = CASE WHEN stg.Operation = 'D' THEN CONVERT(BIT,1) ELSE 0 END
      FROM
        [StageUser1].[STAGE_FACT_EventRoadspeedLimits] stg
          INNER JOIN
        [MiXData].dbo.FACT_EventDetails fed WITH (NOLOCK) ON fed.OrganisationKey = @organisationKey
                                                            AND fed.HostID          = stg.EventKey
    )
    INSERT [StageUser1].[ROLLBACK_FACT_EventRoadspeedLimits]
    (
      EventDetailKey   ,
      EventStartDateKey,
      OrganisationKey  ,
      SpeedLimit       ,
      IsDeleted        ,
      CreateBatchKey   ,
      UpdateBatchKey
    )
    SELECT
      EventDetailKey   ,
      EventStartDateKey,
      OrganisationKey  ,
      SpeedLimit       ,
      IsDeleted        ,
      CreateBatchKey   ,
      UpdateBatchKey
    FROM
      ( MERGE [MiXData].dbo.FACT_EventRoadspeedLimits tar
        USING STAGE_FACT_EventRoadspeedLimits stg
          ON tar.EventDetailKey = stg.EventDetailKey
        WHEN MATCHED THEN                           -- update existing records to FACT
          UPDATE
          SET tar.EventStartDateKey = stg.EventStartDateKey,
              tar.SpeedLimit        = stg.SpeedLimit,
              tar.IsDeleted         = stg.IsDeleted,
              tar.UpdateBatchKey    = @batchKey
        WHEN NOT MATCHED AND stg.IsDeleted = 0 THEN -- insert new records to FACT
          INSERT
          (
            EventDetailKey   ,
            EventStartDateKey,
            OrganisationKey  ,
            SpeedLimit       ,
            IsDeleted        ,
            CreateBatchKey   ,
            UpdateBatchKey
          )
          VALUES
          (
            stg.EventDetailKey   ,
            stg.EventStartDateKey,
            @organisationKey     ,
            stg.SpeedLimit       ,
            stg.IsDeleted        ,
            @batchKey,
            @batchKey
          )
        OUTPUT
          $action   AS Operation,
          DELETED.EventDetailKey   ,
          DELETED.EventStartDateKey,
          DELETED.OrganisationKey  ,
          DELETED.SpeedLimit       ,
          DELETED.IsDeleted        ,
          DELETED.CreateBatchKey   ,
          DELETED.UpdateBatchKey
        ) Rollbck
    WHERE Operation = 'UPDATE';

    SELECT @recordsUpdated = COUNT(1)
    FROM [StageUser1].ROLLBACK_FACT_EventRoadspeedLimits rll;
    SELECT @recordsInserted = COUNT(1)
    FROM [StageUser1].STAGE_FACT_EventRoadspeedLimits stg
    WHERE Operation IN ('U','I');

    -- record number of records deleted
    SELECT @recordsDeleted = COUNT(1)
    FROM [StageUser1].STAGE_FACT_EventRoadspeedLimits stg
    WHERE Operation = 'D';

    -- record number of records inserted
    SELECT @recordsInserted = CASE WHEN (@recordsInserted - @recordsUpdated) < 0 THEN 0 ELSE @recordsInserted - @recordsUpdated END;

    -- record number of records updated
    SELECT @recordsUpdated  = CASE WHEN @recordsUpdated  - @recordsDeleted < 0 THEN 0 ELSE @recordsUpdated  - @recordsDeleted END;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'5.1 Merge Records';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_EventRoadspeedLimits];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = ISNULL(@nrOfRecordsAffected,0);
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_EventSummary_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_EventSummary_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value         int;
  DECLARE @recordsInserted      int;
  DECLARE @recordsUpdated       int;
  DECLARE @recordsDeleted       int;
  DECLARE @nrOfrecordsAffected  int    = 0;
  DECLARE @unknownDateDefault   date   = '00010101';
  DECLARE @maxDuration          bigint = 2147483647; -- this is the max int data type value

  DECLARE @flagStartTime      datetimeoffset(0) = SYSUTCDATETIME();
  DECLARE @flagSeq            smallint = 1;

  CREATE TABLE #rollback
  (
    EventStartDateKey   DATE,
    EventDescriptionKey INT,
    VehicleKey          INT,
    DriverKey           INT
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].STAGE_FACT_EventSummary;

  IF @debugMode = 1  -- DebugMode is true
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0,
        @isStartFlag=1, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 0. Make sure work tables are cleared';
    END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_EventSummary]') AND name = N'IX_STAGE_FACT_EventSummary_EventDescriptionKey_VehicleKey_DriverKey_EventStartDateKey')
      BEGIN
        DROP INDEX IX_STAGE_FACT_EventSummary_EventDescriptionKey_VehicleKey_DriverKey_EventStartDateKey ON [StageUser1].[STAGE_FACT_EventSummary];  
      END;
  
    -- create index for changed records
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes
                  WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_EventDetails]') AND name = N'IX_STAGE_FACT_EventDetails_EventDescriptionKey_VehicleKey_EventStartDateKey')
      BEGIN
        CREATE INDEX IX_STAGE_FACT_EventDetails_EventDescriptionKey_VehicleKey_EventStartDateKey
          ON [StageUser1].[STAGE_FACT_EventDetails](EventDescriptionKey,VehicleKey,EventStartDateKey);
      END;

    -- insert changed records into STG  
    ;WITH changedKeys AS
    (
      SELECT
        EventDescriptionKey,
        VehicleKey,
        EventStartDateKey
      FROM
        [StageUser1].STAGE_FACT_EventDetails
      WHERE
        EventStartDateKey > @unknownDateDefault
      GROUP BY
        EventDescriptionKey,
        VehicleKey,
        EventStartDateKey
    )
    INSERT INTO [StageUser1].[STAGE_FACT_EventSummary]
    (
      EventDescriptionKey,
      VehicleKey,
      DriverKey,
      EventStartDateKey,
      TrailerKey,
      UTCOffsetKey,
      NumberOfEvents,
      MaxEventValue,
      MinEventValue,
      AvgEventValue,
      TotalEventValue,
      TotalOccurs,
      TotalTime,
      TotalLitres
    )
    SELECT
      fed.EventDescriptionKey,
      fed.VehicleKey,
      fed.DriverKey,
      fed.EventStartDateKey,
      fed.TrailerKey,
      fed.UTCOffsetKey,
      COUNT(*),
      MAX(fed.EventValue),
      MIN(fed.EventValue),
      AVG(fed.EventValue),
      SUM(fed.EventValue),
      SUM(fed.TotalOccurs),
      CASE
        WHEN ABS(SUM(CONVERT(BIGINT, fed.TotalTime))) >= @maxDuration
          THEN -2
        ELSE
          SUM(CONVERT(BIGINT, fed.TotalTime))
      END,
      SUM(CONVERT(decimal(19,4), fed.Litres))
    FROM
      changedKeys ck
        INNER JOIN
      [MiXData].dbo.FACT_EventDetails fed WITH (NOLOCK) ON ck.EventDescriptionKey = fed.EventDescriptionKey
                                                          AND ck.VehicleKey          = fed.VehicleKey
                                                          AND ck.EventStartDateKey   = fed.EventStartDateKey
    GROUP BY
      fed.EventDescriptionKey,
      fed.VehicleKey,
      fed.DriverKey,
      fed.EventStartDateKey,
      fed.TrailerKey,
      fed.UTCOffsetKey;
    SELECT @nrOfrecordsAffected = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
        @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_EventSummary_EventDescriptionKey_VehicleKey_DriverKey_EventStartDateKey
      ON [StageUser1].[STAGE_FACT_EventSummary](EventDescriptionKey, VehicleKey, DriverKey, EventStartDateKey);
    SELECT @nrOfrecordsAffected = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
        @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    ------------------------------------------
    -- VehicleSiteKey
      UPDATE stg
      SET
        VehicleSiteKey = ds.SiteKey
      FROM
        [StageUser1].STAGE_FACT_EventSummary stg
          INNER JOIN
        [MiXData].dbo.DIM_Vehicles              dvh WITH (NOLOCK) ON stg.VehicleKey     = dvh.VehicleKey
          INNER JOIN
        [MiXData].dbo.DIM_Sites                 ds  WITH (NOLOCK) ON ds.OrganisationKey = dvh.OrganisationKey
                                                                   AND ds.SiteGUID        = dvh.SiteGUID;
    SELECT @nrOfrecordsAffected = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update VehicleSiteKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
                @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------

    -- This assumes that EventDescriptionKey, VehicleKey and EventStartDateKey cannot change.

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;
  DECLARE @processPoint   int = 0;  -- what has already been done.
  WHILE @exceptionCount < 20
    BEGIN
      BEGIN TRY

      -- 5.1: Update existing rollups to have new totals
        IF @processPoint < 1
          BEGIN
            BEGIN TRANSACTION;
            INSERT INTO #rollback
            (
              EventDescriptionKey,
              DriverKey,
              VehicleKey,
              EventStartDateKey
            )
            SELECT
              EventDescriptionKey,
              DriverKey,
              VehicleKey,
              EventStartDateKey
            FROM
            (
              UPDATE
                fact
              SET
                TrailerKey        = stg.TrailerKey,
                NumberOfEvents    = ISNULL(stg.NumberOfEvents, 0),
                MaxEventValue     = stg.MaxEventValue,
                MinEventValue     = stg.MinEventValue,
                AvgEventValue     = stg.AvgEventValue,
                TotalEventValue   = ISNULL(stg.TotalEventValue, 0.0),
                TotalOccurs       = ISNULL(stg.TotalOccurs, 0),
                TotalTime         = ISNULL(stg.TotalTime, 0),
                TotalLitres       = ISNULL(stg.TotalLitres, 0.0),
                UTCOffsetKey      = stg.UTCOffsetKey,
                UpdateBatchKey    = @batchKey
              OUTPUT
                deleted.EventDescriptionKey,
                deleted.DriverKey,
                deleted.VehicleKey,
                deleted.EventStartDateKey
              FROM
                [MiXData].[dbo].FACT_EventSummary fact
                  INNER JOIN
                [StageUser1].STAGE_FACT_EventSummary stg ON  fact.EventDescriptionKey  = stg.EventDescriptionKey
                                                       AND fact.VehicleKey            = stg.VehicleKey
                                                       AND fact.DriverKey             = stg.DriverKey
                                                       AND fact.EventStartDateKey     = stg.EventStartDateKey
              ) updated
              OPTION (FAST 1000);
            SET @recordsUpdated = @@ROWCOUNT;
            COMMIT TRANSACTION;
            SET @processPoint += 1;

            IF @debugMode = 1  -- DebugMode is true
              BEGIN
                EXEC [Control].strProcProgressMonitor_Set
                  @flag='5.1 Update existing rollups', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
                  @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
                SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
                PRINT '5.1 Update existing rollups = ' + CAST(@recordsUpdated AS nvarchar);
              END;
          END; -- @processPoint 1

      -- 5.2: remove rollups where DriverKey not longer exists
        IF @processPoint < 2
          BEGIN
            BEGIN TRANSACTION;
            INSERT INTO #rollback
            (
              EventDescriptionKey,
              DriverKey,
              VehicleKey,
              EventStartDateKey
            )
            SELECT
              EventDescriptionKey,
              DriverKey,
              VehicleKey,
              EventStartDateKey
            FROM
            (
              DELETE
                [MiXData].[dbo].FACT_EventSummary
              OUTPUT
                deleted.EventDescriptionKey,
                deleted.DriverKey,
                deleted.VehicleKey,
                deleted.EventStartDateKey
              FROM
                [MiXData].[dbo].FACT_EventSummary fact
                  INNER JOIN
                [StageUser1].STAGE_FACT_EventSummary stg ON fact.EventDescriptionKey = stg.EventDescriptionKey
                                                       AND fact.EventStartDateKey   = stg.EventStartDateKey
                                                       AND fact.VehicleKey          = stg.VehicleKey
                                                       --- no driver match!
                                                       AND fact.UpdateBatchKey     != @batchKey
            ) deleted
            OPTION (FAST 1000);
            SET @recordsDeleted = @@ROWCOUNT;
            COMMIT TRANSACTION
            SET @processPoint += 1;

            IF @debugMode = 1  -- DebugMode is true
              BEGIN
                EXEC [Control].strProcProgressMonitor_Set
                  @flag='5.2: remove rollups where DriverKey not longer exists', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
                  @nrOfRecordsAffected=@recordsDeleted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
                SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
                PRINT '5.2: remove rollups where DriverKey not longer exists = ' + CAST(@recordsDeleted AS nvarchar);
              END;
          END; -- @processPoint 2

      -- 5.3: insert new rollups (no rollback required)
        IF @processPoint < 3
          BEGIN
            BEGIN TRANSACTION;
            INSERT INTO [MiXData].[dbo].FACT_EventSummary
            (
              OrganisationKey,
              VehicleSiteKey,
              DriverKey,
              VehicleKey,
              TrailerKey,
              EventDescriptionKey,
              EventStartDateKey,
              NumberOfEvents,
              MaxEventValue,
              MinEventValue,
              AvgEventValue,
              TotalEventValue,
              TotalOccurs,
              TotalTime,
              TotalLitres,
              UTCOffsetKey,
              CreateBatchKey,
              UpdateBatchKey
            )
            SELECT
              @organisationKey,
              ISNULL(VehicleSiteKey, -1),
              DriverKey,
              VehicleKey,
              TrailerKey,
              EventDescriptionKey,
              EventStartDateKey,
              ISNULL(NumberOfEvents, 0),
              MaxEventValue,
              MinEventValue,
              AvgEventValue,
              ISNULL(TotalEventValue, 0.0),
              ISNULL(TotalOccurs, 0),
              ISNULL(TotalTime, 0),
              ISNULL(TotalLitres, 0.0),
              UTCOffsetKey,
              @batchKey,
              @batchKey
            FROM
              [StageUser1].STAGE_FACT_EventSummary stg
            WHERE
              NOT EXISTS (SELECT *
                          FROM
                            #rollback rbk
                          WHERE
                            rbk.EventDescriptionKey     = stg.EventDescriptionKey
                            AND rbk.VehicleKey          = stg.VehicleKey
                            AND rbk.DriverKey           = stg.DriverKey
                            AND rbk.EventStartDateKey   = stg.EventStartDateKey);
            SET @recordsInserted = @@ROWCOUNT;
            COMMIT TRANSACTION;
            SET @processPoint += 1;

            IF @debugMode = 1  -- DebugMode is true
              BEGIN
                EXEC [Control].strProcProgressMonitor_Set
                  @flag='5.3: insert new rollups', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
                  @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
                SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
                PRINT '5.3: insert new rollups = ' + CAST(@recordsInserted AS nvarchar);
              END;
          END; -- @processPoint 3

          BREAK; -- out of while loop
      END TRY
      -- CATCH Errors
      BEGIN CATCH
        ROLLBACK TRANSACTION;
        SET @exceptionCount += 1;
        IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
          BEGIN
            EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
            IF @debugMode = 1  -- DebugMode is true
              BEGIN
                PRINT '5.error: deadlock occured, restarting merge';
                EXEC [Control].strProcProgressMonitor_Set
                  @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
                  @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
                SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
              END;
          END;
        ELSE
          BEGIN
            EXEC [Control].sprLogError @organisationKey = @organisationKey;
            RETURN -1;
            BREAK; -- out of while loop
          END;
      END CATCH;
    END -- While

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_EventSummary];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = ISNULL(@recordsInserted, 0),
         RecordsUpdated  = ISNULL(@recordsUpdated,  0),
         RecordsDeleted  = ISNULL(@recordsDeleted,  0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated + @recordsDeleted;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID,
      @nrOfRecordsAffected=@nrOfRecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    PRINT CONVERT(nvarchar(12), SYSDATETIME(), 114) + N' 7. Return values for Performance Monitoring';
  END;

  --------------------------------------------------------------------
  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_FuelCapture_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_FuelCapture_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE	@currentDate        datetimeoffset = SYSUTCDATETIME(); -- used for validation

  DECLARE	@maxFuelConsumption real = 35.0; -- (km/l) if fuelconsumption is bigger than this value then it is most probably incorrect

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_FuelCapture];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_FuelCapture];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_FuelCapture]') AND name = N'IX_STAGE_FACT_FuelCapture_VehicleID')
      DROP INDEX IX_STAGE_FACT_FuelCapture_VehicleID ON [StageUser1].[STAGE_FACT_FuelCapture];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *  
              FROM sys.indexes   
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_FuelCapture]') AND name = N'IX_ROLLBACK_FACT_FuelCapture_HostID')  
      DROP INDEX IX_ROLLBACK_FACT_FuelCapture_HostID ON [StageUser1].[ROLLBACK_FACT_FuelCapture];  

    -- insert changed records into STG
	  INSERT INTO [StageUser1].[STAGE_FACT_FuelCapture]
	  (
	    [Operation]    ,
      [HostID]       ,
      [VehicleID]    ,
      [FillDateKey]  ,
      [FillTime]     ,
      [FillDateTime] ,
      [Litres]       ,
      [BaseCost]     ,
      [BaseCurrency] ,
      [FillOdometer] ,
      [EngineSeconds],
      [UTCOffsetKey]
	  )
	  SELECT
	    s.Operation                  ,
      HostID = s.liFuelKey         ,
      s.iVehicleID                 ,
      CONVERT(DATE,s.dtFillDate)   ,
      CONVERT(TIME(0),s.dtFillDate),
      CASE 
        WHEN s.dtFillDate IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.dtFillDate,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      s.fLitres                    ,
      s.fBaseCost                  ,
      s.sBaseCur                   ,
      s.fFillOdo                   ,
      s.liEngineSeconds            ,
      utc.UTCOffsetKey
	  FROM
	    [StageUser1].FuelUsage s WITH (NOLOCK)
	      CROSS JOIN
      [StageUser1].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
    WHERE
        ISNULL(CONVERT(DATETIMEOFFSET(0),s.dtFillDate),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.dtFillDate),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    ------------------------------------------
    -- VehicleKey
    UPDATE
      [StageUser1].[STAGE_FACT_FuelCapture]
    SET
      [VehicleKey] = dv.[VehicleKey]
    FROM
      [StageUser1].[STAGE_FACT_FuelCapture] stg
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles      dv  WITH (NOLOCK)
        ON  dv.OrganisationKey = @organisationKey
        AND stg.VehicleID      = dv.HostID
    WHERE
      stg.FillDateKey BETWEEN dv.StartDateKey AND dv.EndDateKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update VehicleKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- BaseCurrencyKey
    UPDATE
      [StageUser1].[STAGE_FACT_FuelCapture]
    SET
      [BaseCurrencyKey] = dc.[CurrencyKey]
    FROM
      [StageUser1].[STAGE_FACT_FuelCapture] stg
        INNER JOIN -- select * from
      [MiXData].dbo.DIM_Currencies      dc WITH (NOLOCK)
        ON  dc.[CurrencyAlternateKey] = stg.[BaseCurrency];

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3 Update BaseCurrencyKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- PreviousFillOdometer/PreviousEngineSeconds

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_FuelCapture_VehicleID
      ON [StageUser1].STAGE_FACT_FuelCapture(VehicleID)
      INCLUDE(FillOdometer,FillDateTime,EngineSeconds);

    ;WITH Previous (VehicleID,FillOdometer,EngineSeconds) AS
    (
      SELECT VehicleID,
             FillOdometer,
             EngineSeconds
      FROM [StageUser1].[STAGE_FACT_FuelCapture]
      UNION
      SELECT VehicleID = dvh.HostID,
             ffc.FillOdometer,
             ffc.EngineSeconds
      FROM [MiXData].dbo.[FACT_FuelCapture] ffc WITH (NOLOCK)
             INNER JOIN
           [MiXData].dbo.[DIM_Vehicles]     dvh WITH (NOLOCK)
             ON ffc.VehicleKey = dvh.VehicleKey
      WHERE ffc.OrganisationKey = @organisationKey
    )
    UPDATE
      [StageUser1].[STAGE_FACT_FuelCapture]
    SET
      PreviousFillOdometer  = (SELECT MAX(p.FillOdometer)
                               FROM
                                 Previous p
                               WHERE
                                 stg.VehicleID  = p.VehicleID
                               AND
                                 p.FillOdometer < stg.FillOdometer),
      PreviousEngineSeconds = (SELECT MAX(p.EngineSeconds)
                               FROM
                                 Previous p
                               WHERE
                                 stg.VehicleID  = p.VehicleID
                               AND
                                 p.EngineSeconds < stg.EngineSeconds)
    FROM
      [StageUser1].[STAGE_FACT_FuelCapture] stg;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.4 Update PreviousFillOdometer/PreviousEngineSeconds', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- PreviousFillDateTime
    ;WITH Previous (VehicleID,FillDateTime) AS
    (
      SELECT VehicleID,
             FillDateTime
      FROM [StageUser1].[STAGE_FACT_FuelCapture]
      UNION
      SELECT VehicleID = dvh.HostID,
             ffc.FillDateTime
      FROM [MiXData].dbo.[FACT_FuelCapture] ffc WITH (NOLOCK)
             INNER JOIN
           [MiXData].dbo.[DIM_Vehicles]     dvh WITH (NOLOCK)
             ON ffc.VehicleKey = dvh.VehicleKey
      WHERE ffc.OrganisationKey = @organisationKey
    )
    UPDATE
      [StageUser1].[STAGE_FACT_FuelCapture]
    SET
      PreviousFillDateTime = (SELECT MAX(p.FillDateTime)
                              FROM
                                Previous p
                              WHERE
                                stg.VehicleID  = p.VehicleID
                              AND
                                p.FillDateTime < stg.FillDateTime)
    FROM
      [StageUser1].[STAGE_FACT_FuelCapture] stg;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.5 Update PreviousFillDateTime', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- DistanceTravelled
    UPDATE
      [StageUser1].[STAGE_FACT_FuelCapture]
    SET
      DistanceTravelled = CASE
                            WHEN FillOdometer >= ISNULL(PreviousFillOdometer,FillOdometer)
                              THEN FillOdometer - PreviousFillOdometer
                            ELSE 0.0
                          END;

    ------------------------------------------
    -- FillFuelConsumption (l/100km)
    UPDATE
      [StageUser1].[STAGE_FACT_FuelCapture]
    SET
      FillFuelConsumption   = CASE
                                WHEN ISNULL(DistanceTravelled,0.0) = 0.0
                                  THEN NULL
                                ELSE
                                  CASE
                                    WHEN (Litres/DistanceTravelled)*100 > @maxFuelConsumption
                                      THEN NULL
                                    ELSE
                                      (Litres/DistanceTravelled)*100
                                  END
                              END;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.6 Update FillFuelConsumption/DistanceTravelled', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;
    

    ------------------------------------------
    -- ActivityDetailKey
      -- calculated on sprFACT_ActivitySummary_Late_Transform

    ------------------------------------------
    -- FuelStopGeoLocationKey
      -- calculated on sprFACT_ActivitySummary_Late_Transform


  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Changed records
    INSERT INTO [StageUser1].[ROLLBACK_FACT_FuelCapture]
    ( 
      [FuelCapturekey]        ,
      [OrganisationKey]       ,
      [HostID]                ,
      [VehicleKey]            ,
      [FillDateKey]           ,
      [FillTime]              ,
      [FillDateTime]          ,
      [PreviousFillDateTime]  ,
      [Litres]                ,
      [BaseCost]              ,
      [BaseCurrencyKey]       ,
      [FillOdometer]          ,
      [PreviousFillOdometer]  ,
      [EngineSeconds]         ,
      [PreviousEngineSeconds] ,
      [DistanceTravelled]     ,
      [FillFuelConsumption]   ,
      [ActivityDetailKey]     ,
      [FuelStopGeoLocationKey],
      [UTCOffsetKey]          ,
      [IsDeleted]             ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    )
    SELECT
      [FuelCapturekey]        ,
      [OrganisationKey]       ,
      [HostID]                ,
      [VehicleKey]            ,
      [FillDateKey]           ,
      [FillTime]              ,
      [FillDateTime]          ,
      [PreviousFillDateTime]  ,
      [Litres]                ,
      [BaseCost]              ,
      [BaseCurrencyKey]       ,
      [FillOdometer]          ,
      [PreviousFillOdometer]  ,
      [EngineSeconds]         ,
      [PreviousEngineSeconds] ,
      [DistanceTravelled]     ,
      [FillFuelConsumption]   ,
      [ActivityDetailKey]     ,
      [FuelStopGeoLocationKey],
      [UTCOffsetKey]          ,
      [IsDeleted]             ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [VehicleKey]              = ISNULL(stg.[VehicleKey],-1) ,
        [FillDateKey]             = stg.[FillDateKey]           ,
        [FillTime]                = stg.[FillTime]              ,
        [FillDateTime]            = stg.[FillDateTime]          ,
        [PreviousFillDateTime]    = ISNULL(stg.[PreviousFillDateTime],@unknownDateDefault),
        [Litres]                  = stg.[Litres]                ,
        [BaseCost]                = stg.[BaseCost]              ,
        [BaseCurrencyKey]         = ISNULL(stg.[BaseCurrencyKey],-1),
        [FillOdometer]            = stg.[FillOdometer]          ,
        [PreviousFillOdometer]    = ISNULL(stg.[PreviousFillOdometer],stg.[FillOdometer]),
        [EngineSeconds]           = stg.[EngineSeconds],
        [PreviousEngineSeconds]   = ISNULL(stg.[PreviousEngineSeconds],stg.[EngineSeconds]),
        [DistanceTravelled]       = ISNULL(stg.[DistanceTravelled],0.0),
        [FillFuelConsumption]     = stg.[FillFuelConsumption]          ,
        [ActivityDetailKey]       = ISNULL(stg.[ActivityDetailKey],tar.[ActivityDetailKey]),
        [FuelStopGeoLocationKey]  = ISNULL(stg.[FuelStopGeoLocationKey],tar.[FuelStopGeoLocationKey]),
        [UTCOffsetKey]            = stg.[UTCOffsetKey]          ,
        [IsDeleted]               = 0                           ,
        [UpdateBatchKey]          = @batchKey
      OUTPUT
        DELETED.[FuelCapturekey]        ,
        DELETED.[OrganisationKey]       ,
        DELETED.[HostID]                ,
        DELETED.[VehicleKey]            ,
        DELETED.[FillDateKey]           ,
        DELETED.[FillTime]              ,
        DELETED.[FillDateTime]          ,
        DELETED.[PreviousFillDateTime]  ,
        DELETED.[Litres]                ,
        DELETED.[BaseCost]              ,
        DELETED.[BaseCurrencyKey]       ,
        DELETED.[FillOdometer]          ,
        DELETED.[PreviousFillOdometer]  ,
        DELETED.[EngineSeconds]         ,
        DELETED.[PreviousEngineSeconds] ,
        DELETED.[DistanceTravelled]     ,
        DELETED.[FillFuelConsumption]   ,
        DELETED.[ActivityDetailKey]     ,
        DELETED.[FuelStopGeoLocationKey],
        DELETED.[UTCOffsetKey]          ,
        DELETED.[IsDeleted]             ,
        DELETED.[CreateBatchKey]        ,
        DELETED.[UpdateBatchKey]
      FROM
        [MiXData].dbo.FACT_FuelCapture    AS tar WITH (NOLOCK)
          INNER JOIN
        [StageUser1].[STAGE_FACT_FuelCapture] AS stg ON tar.HostID          = stg.HostID
                                                   AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation in ('I','U')
      ) AS upd;

    -- record number of records updated  
    SELECT @recordsUpdated = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;  
    END;  

    -- Deleted records
    INSERT INTO [StageUser1].[ROLLBACK_FACT_FuelCapture]
    ( 
      [FuelCapturekey]        ,
      [OrganisationKey]       ,
      [HostID]                ,
      [VehicleKey]            ,
      [FillDateKey]           ,
      [FillTime]              ,
      [FillDateTime]          ,
      [PreviousFillDateTime]  ,
      [Litres]                ,
      [BaseCost]              ,
      [BaseCurrencyKey]       ,
      [FillOdometer]          ,
      [PreviousFillOdometer]  ,
      [EngineSeconds]         ,
      [PreviousEngineSeconds] ,
      [DistanceTravelled]     ,
      [FillFuelConsumption]   ,
      [ActivityDetailKey]     ,
      [FuelStopGeoLocationKey],
      [UTCOffsetKey]          ,
      [IsDeleted]             ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    )
    SELECT
      [FuelCapturekey]        ,
      [OrganisationKey]       ,
      [HostID]                ,
      [VehicleKey]            ,
      [FillDateKey]           ,
      [FillTime]              ,
      [FillDateTime]          ,
      [PreviousFillDateTime]  ,
      [Litres]                ,
      [BaseCost]              ,
      [BaseCurrencyKey]       ,
      [FillOdometer]          ,
      [PreviousFillOdometer]  ,
      [EngineSeconds]         ,
      [PreviousEngineSeconds] ,
      [DistanceTravelled]     ,
      [FillFuelConsumption]   ,
      [ActivityDetailKey]     ,
      [FuelStopGeoLocationKey],
      [UTCOffsetKey]          ,
      [IsDeleted]             ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]      = 1,
        [UpdateBatchKey] = @batchKey
      OUTPUT
        DELETED.[FuelCapturekey]        ,
        DELETED.[OrganisationKey]       ,
        DELETED.[HostID]                ,
        DELETED.[VehicleKey]            ,
        DELETED.[FillDateKey]           ,
        DELETED.[FillTime]              ,
        DELETED.[FillDateTime]          ,
        DELETED.[PreviousFillDateTime]  ,
        DELETED.[Litres]                ,
        DELETED.[BaseCost]              ,
        DELETED.[BaseCurrencyKey]       ,
        DELETED.[FillOdometer]          ,
        DELETED.[PreviousFillOdometer]  ,
        DELETED.[EngineSeconds]         ,
        DELETED.[PreviousEngineSeconds] ,
        DELETED.[DistanceTravelled]     ,
        DELETED.[FillFuelConsumption]   ,
        DELETED.[ActivityDetailKey]     ,
        DELETED.[FuelStopGeoLocationKey],
        DELETED.[UTCOffsetKey]          ,
        DELETED.[IsDeleted]             ,
        DELETED.[CreateBatchKey]        ,
        DELETED.[UpdateBatchKey]
      FROM
        [MiXData].dbo.FACT_FuelCapture    AS tar WITH (NOLOCK)
          INNER JOIN
        [StageUser1].[STAGE_FACT_FuelCapture] AS stg ON tar.HostID          = stg.HostID
                                                   AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation = 'D'
      ) AS del;

    -- record number of records deleted  
    SELECT @recordsDeleted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;  
    END;  

    -- create rollback index  
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_FuelCapture_HostID  
      ON [StageUser1].[ROLLBACK_FACT_FuelCapture](HostID);  

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_FuelCapture
    ( 
      [OrganisationKey]       ,
      [HostID]                ,
      [VehicleKey]            ,
      [FillDateKey]           ,
      [FillTime]              ,
      [FillDateTime]          ,
      [PreviousFillDateTime]  ,
      [Litres]                ,
      [BaseCost]              ,
      [BaseCurrencyKey]       ,
      [FillOdometer]          ,
      [PreviousFillOdometer]  ,
      [EngineSeconds]         ,
      [PreviousEngineSeconds] ,
      [DistanceTravelled]     ,
      [FillFuelConsumption]   ,
      [ActivityDetailKey]     ,
      [FuelStopGeoLocationKey],
      [UTCOffsetKey]          ,
      [IsDeleted]             ,
      [CreateBatchKey]        ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey            ,
      stg.[HostID]                ,
      ISNULL(stg.[VehicleKey],-1) ,
      stg.[FillDateKey]           ,
      stg.[FillTime]              ,
      stg.[FillDateTime]          ,
      ISNULL(stg.[PreviousFillDateTime],@unknownDateDefault),
      stg.[Litres]                ,
      stg.[BaseCost]              ,
      ISNULL(stg.[BaseCurrencyKey],-1),
      stg.[FillOdometer]          ,
      ISNULL(stg.[PreviousFillOdometer],stg.[FillOdometer]),
      stg.[EngineSeconds]         ,
      ISNULL(stg.[PreviousEngineSeconds],stg.[EngineSeconds]),
      ISNULL(stg.[DistanceTravelled],0.0),
      [FillFuelConsumption]           ,
      ISNULL(stg.[ActivityDetailKey],-1),
      ISNULL(stg.[FuelStopGeoLocationKey],-1),
      stg.[UTCOffsetKey]          ,
      0                           , -- IsDeleted
      @batchKey                   ,
      @batchKey
    FROM
      [StageUser1].[STAGE_FACT_FuelCapture]    AS stg
    WHERE
      stg.Operation in ('I','U')
    AND
      NOT EXISTS (SELECT 1
                  FROM
                    [StageUser1].[ROLLBACK_FACT_FuelCapture] AS roll WITH (NOLOCK)
                  WHERE
                    stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_FuelCapture];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated + @recordsDeleted;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_PassengerActivities_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_PassengerActivities_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected  int = 0;

  DECLARE	@currentDate        datetimeoffset; -- used for validation
  DECLARE @unknownDateDefault date = '00010101';

  SELECT @currentDate = SYSUTCDATETIME();

  CREATE TABLE #VehiclesLookup
  (
    VehicleKey   INT,
    HostID       INT,
    StartDateKey DATE,
    EndDateKey   DATE,
    PRIMARY KEY CLUSTERED (VehicleKey)
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_PassengerActivities];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_PassengerActivities];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create required source indexes
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser1].[PassengerData]') AND name = N'IX_PassengerData_IdentifiedDate')
      CREATE NONCLUSTERED INDEX IX_PassengerData_IdentifiedDate
        ON [StageUser1].PassengerData ( [IdentifiedDate] );

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_PassengerActivities]') AND name = N'IX_STAGE_FACT_PassengerActivities_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_PassengerActivities_HostID_Operation ON [StageUser1].STAGE_FACT_PassengerActivities;

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_PassengerActivities]') AND name = N'IX_STAGE_FACT_PassengerActivities_IdentifiedDateKey')
      DROP INDEX IX_STAGE_FACT_PassengerActivities_IdentifiedDateKey ON [StageUser1].STAGE_FACT_PassengerActivities;

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_PassengerActivities]') AND name = N'IX_STAGE_FACT_PassengerActivities_PassengerID_IdentifiedDateKey')
      DROP INDEX IX_STAGE_FACT_PassengerActivities_PassengerID_IdentifiedDateKey  ON [StageUser1].STAGE_FACT_PassengerActivities;

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_PassengerActivities]') AND name = N'IX_STAGE_FACT_PassengerActivities_VehicleID_IdentifiedDateKey')
      DROP INDEX IX_STAGE_FACT_PassengerActivities_VehicleID_IdentifiedDateKey ON [StageUser1].STAGE_FACT_PassengerActivities;

    -- insert changed records into STG
	  INSERT INTO [StageUser1].[STAGE_FACT_PassengerActivities]
	  (
      Operation      ,
      HostID         ,
      PassengerID    ,
      VehicleID      ,
      Odometer       ,
      IdentifiedDateKey,
      IdentifiedTime   ,
      IdentifiedDateTime,
      UTCOffsetKey
	  )
	  SELECT
      s.Operation,
      HostID = s.RID  ,
      s.PassengerID   ,
      s.VehicleID     ,
      s.Odometer      ,
      ISNULL(CONVERT(DATE,s.IdentifiedDate),@unknownDateDefault),
      CONVERT(TIME(0),ISNULL(s.IdentifiedDate,0)),
      TODATETIMEOFFSET(s.IdentifiedDate,ISNULL(utc.UTCOffsetMinutes,0)),
      utc.UTCOffsetKey
	  FROM
	    [StageUser1].PassengerData s WITH (NOLOCK)
	      CROSS JOIN
	    [StageUser1].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
	  WHERE s.RID IS NOT NULL
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.IdentifiedDate),'19010101') BETWEEN utc.StartDateTime       AND utc.EndDateTime
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.IdentifiedDate),'19010101') BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create indexes required for lookups
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_PassengerActivities_HostID_Operation ON [StageUser1].STAGE_FACT_PassengerActivities
    (HostID,Operation);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_PassengerActivities_IdentifiedDateKey ON [StageUser1].STAGE_FACT_PassengerActivities
    (IdentifiedDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_PassengerActivities_PassengerID_IdentifiedDateKey  ON [StageUser1].STAGE_FACT_PassengerActivities
    (PassengerID,IdentifiedDateKey);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_PassengerActivities_VehicleID_IdentifiedDateKey ON [StageUser1].STAGE_FACT_PassengerActivities
    (VehicleID,IdentifiedDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
    END;

    ------------------------------------------
    -- VehicleKey
    INSERT INTO #VehiclesLookup
    ( VehicleKey,HostID,StartDateKey,EndDateKey )
    SELECT
      dvh.VehicleKey,
      dvh.HostID,
      dvh.StartDateKey,
      dvh.EndDateKey
    FROM
      [MiXData].dbo.DIM_Vehicles dvh WITH (NOLOCK)
    WHERE dvh.OrganisationKey = @organisationKey;

    UPDATE
      [StageUser1].[STAGE_FACT_PassengerActivities]
    SET
      [VehicleKey] = dv.[VehicleKey]
    FROM
      [StageUser1].[STAGE_FACT_PassengerActivities] stg
        INNER JOIN
      #VehiclesLookup dv
        ON stg.VehicleID      = dv.HostID
    WHERE stg.[IdentifiedDateKey] BETWEEN dv.StartDateKey AND dv.EndDateKey;

    ------------------------------------------
    -- PassengerKey
    UPDATE
      [StageUser1].[STAGE_FACT_PassengerActivities]
    SET
      [PassengerKey] = dp.[PassengerKey]
    FROM
      [StageUser1].[STAGE_FACT_PassengerActivities] stg
        INNER JOIN
      [MiXData].dbo.DIM_Passengers dp WITH (NOLOCK) ON dp.OrganisationKey = @organisationKey
                                                      AND stg.PassengerID    = dp.HostID
    WHERE stg.[IdentifiedDateKey] BETWEEN dp.StartDateKey AND dp.EndDateKey;

    ------------------------------------------
    -- ActivityDetailKey/ActivitySummaryKey/DriverKey
    UPDATE
      [StageUser1].[STAGE_FACT_PassengerActivities]
    SET
      [ActivityDetailKey]   = fad.[ActivityDetailKey],
      [ActivitySummaryKey]  = fad.[ActivitySummaryKey]
    FROM
      #VehiclesLookup dv
        INNER JOIN
      [StageUser1].[STAGE_FACT_PassengerActivities] stg        ON stg.VehicleID = dv.HostID
        INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK) ON fad.OrganisationKey = @organisationKey
                                                             AND fad.VehicleKey      = dv.VehicleKey
    WHERE stg.IdentifiedDateTime IS NOT NULL
    AND stg.[IdentifiedDateTime] BETWEEN fad.ActivityStartDateTime AND fad.NextMovementStartDateTime;


    ------------------------------------------
    -- RankNo (based on PassengerID,ActivitySummaryKey ordered by IdentifiedDate,HostID)
 

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  --BEGIN TRY

 
  --  IF @debugMode = 1  -- DebugMode is true
  --    PRINT N'4. Validation before Loading to DW';

  --END TRY
  ---- CATCH Errors
  --BEGIN CATCH
  --  EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
  --  RETURN -1;
  --END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    INSERT [StageUser1].ROLLBACK_FACT_PassengerActivities
    (
      PassengerActivityKey,
      OrganisationKey     ,
      HostID              ,
      PassengerKey        ,
      VehicleKey          ,
      ActivitySummaryKey  ,
      ActivityDetailKey   ,
      IdentifiedDateKey   ,
      IdentifiedTime      ,
      IdentifiedDateTime  ,
      Odometer            ,
      UTCOffsetKey        ,
      IsDeleted           ,
      CreateBatchKey      ,
      UpdateBatchKey
    )
    SELECT
      PassengerActivityKey,
      OrganisationKey     ,
      HostID              ,
      PassengerKey        ,
      VehicleKey          ,
      ActivitySummaryKey  ,
      ActivityDetailKey   ,
      IdentifiedDateKey   ,
      IdentifiedTime      ,
      IdentifiedDateTime  ,
      Odometer            ,
      UTCOffsetKey        ,
      IsDeleted           ,
      CreateBatchKey      ,
      UpdateBatchKey
    FROM
      ( MERGE [MiXData].dbo.FACT_PassengerActivities tar
        USING [StageUser1].[STAGE_FACT_PassengerActivities] stg
           ON tar.OrganisationKey = @organisationKey
          AND tar.HostID          = stg.HostID
        WHEN MATCHED THEN                           -- update existing records to FACT
          UPDATE
          SET tar.PassengerKey       = ISNULL(stg.PassengerKey,-1),
              tar.VehicleKey         = ISNULL(stg.VehicleKey,-1),
              tar.ActivitySummaryKey = ISNULL(stg.ActivitySummaryKey,-1),
              tar.ActivityDetailKey  = ISNULL(stg.ActivityDetailKey,-1),
              tar.IdentifiedDateKey  = stg.IdentifiedDateKey ,
              tar.IdentifiedTime     = stg.IdentifiedTime    ,
              tar.IdentifiedDateTime = stg.IdentifiedDateTime,
              tar.Odometer           = stg.Odometer          ,
              tar.UTCOffsetKey       = stg.UTCOffsetKey      ,
              tar.IsDeleted          = CASE WHEN stg.Operation = 'D' THEN CONVERT(BIT,1) ELSE 0 END,
              tar.UpdateBatchKey     = @batchKey
        WHEN NOT MATCHED AND stg.Operation IN ('U','I') THEN -- insert new records to FACT
          INSERT
          (
            OrganisationKey   ,
            HostID            ,
            PassengerKey      ,
            VehicleKey        ,
            ActivitySummaryKey,
            ActivityDetailKey ,
            IdentifiedDateKey ,
            IdentifiedTime    ,
            IdentifiedDateTime,
            Odometer          ,
            UTCOffsetKey      ,
            IsDeleted        ,
            CreateBatchKey   ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey      ,
            stg.HostID            ,
            ISNULL(stg.PassengerKey,-1),
            ISNULL(stg.VehicleKey,-1),
            ISNULL(stg.ActivitySummaryKey,-1),
            ISNULL(stg.ActivityDetailKey ,-1),
            stg.IdentifiedDateKey ,
            stg.IdentifiedTime    ,
            stg.IdentifiedDateTime,
            stg.Odometer          ,
            stg.UTCOffsetKey      ,
            0,
            @batchKey,
            @batchKey
          )
        OUTPUT
          $action   AS Operation,
          DELETED.PassengerActivityKey,
          DELETED.OrganisationKey     ,
          DELETED.HostID              ,
          DELETED.PassengerKey        ,
          DELETED.VehicleKey          ,
          DELETED.ActivitySummaryKey  ,
          DELETED.ActivityDetailKey   ,
          DELETED.IdentifiedDateKey   ,
          DELETED.IdentifiedTime      ,
          DELETED.IdentifiedDateTime  ,
          DELETED.Odometer            ,
          DELETED.UTCOffsetKey        ,
          DELETED.IsDeleted           ,
          DELETED.CreateBatchKey      ,
          DELETED.UpdateBatchKey
        ) Rollbck
    WHERE Operation = 'UPDATE';

    SELECT @recordsUpdated = COUNT(1)
    FROM [StageUser1].ROLLBACK_FACT_PassengerActivities rll;
    SELECT @recordsInserted = COUNT(1)
    FROM [StageUser1].STAGE_FACT_PassengerActivities stg
    WHERE Operation IN ('U','I');

    -- record number of records deleted
    SELECT @recordsDeleted = COUNT(1)
    FROM [StageUser1].STAGE_FACT_PassengerActivities stg
    WHERE Operation = 'D';

    -- record number of records inserted
    SELECT @recordsInserted = CASE WHEN (@recordsInserted - @recordsUpdated) < 0 THEN 0 ELSE @recordsInserted - @recordsUpdated END;

    -- record number of records updated
    SELECT @recordsUpdated  = CASE WHEN @recordsUpdated  - @recordsDeleted   < 0 THEN 0 ELSE @recordsUpdated  - @recordsDeleted END;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'5.1 Merge Records';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_PassengerActivities];

  IF @debugMode = 1  -- DebugMode is true
    PRINT N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_ProfileDetails_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_ProfileDetails_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;

  DECLARE @nrOfrecordsAffected int  = 0;
  DECLARE @unknownDateDefault  date = '00010101';
  DECLARE	@currentDate         datetimeoffset = SYSUTCDATETIME(); -- used for validation

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_ProfileDetails];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_ProfileDetails];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM [sys].indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ProfileDetails]') AND name = N'IX_STAGE_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID')
      DROP INDEX IX_STAGE_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID ON [StageUser1].[STAGE_FACT_ProfileDetails];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_ProfileDetails]') AND name = N'IX_ROLLBACK_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID')
      DROP INDEX IX_ROLLBACK_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID ON [StageUser1].[ROLLBACK_FACT_ProfileDetails];

    -- create source indexes before insert
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser1].ProfileData') AND name = N'IX_ProfileData_TripID_SubTripSequence_ParameterID_Sequence')
      CREATE INDEX IX_ProfileData_TripID_SubTripSequence_ParameterID_Sequence 
        ON [StageUser1].ProfileData (TripID,SubTripSequence,ParameterID,[Sequence])
        INCLUDE (Operation);

    -- insert changed records into STG
    WITH 
      ProfileData AS
      ( SELECT
          s.Operation                        ,
          HostTripID      = s.TripID         ,
          HostSequenceID  = s.SubTripSequence,
          HostParameterID = s.ParameterID    ,
          RangeDuration0     = CASE
                                 WHEN s.Sequence = 0 THEN 
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration1     = CASE
                                 WHEN s.Sequence = 1 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration2     = CASE
                                 WHEN s.Sequence = 2 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration3     = CASE
                                 WHEN s.Sequence = 3 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration4     = CASE
                                 WHEN s.Sequence = 4 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration5     = CASE
                                 WHEN s.Sequence = 5 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration6     = CASE
                                 WHEN s.Sequence = 6 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration7     = CASE
                                 WHEN s.Sequence = 7 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration8     = CASE
                                 WHEN s.Sequence = 8 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration9     = CASE
                                 WHEN s.Sequence = 9 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration10    = CASE
                                 WHEN s.Sequence = 10 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END,
          RangeDuration11    = CASE
                                 WHEN s.Sequence = 11 THEN
                                   CASE 
                                     WHEN s.Operation = 'D' THEN NULL
                                     ELSE s.Duration 
                                   END 
                                 ELSE
                                   NULL
                               END
        --  Duration-- select *
        FROM
          [StageUser1].ProfileData s
      )
    INSERT INTO [StageUser1].STAGE_FACT_ProfileDetails
    (
--      Operation      ,
      HostTripID     ,
      HostSequenceID ,
      HostParameterID,
      RangeDuration0 , 
      RangeDuration1 , 
      RangeDuration2 , 
      RangeDuration3 , 
      RangeDuration4 , 
      RangeDuration5 , 
      RangeDuration6 , 
      RangeDuration7 , 
      RangeDuration8 , 
      RangeDuration9 , 
      RangeDuration10, 
      RangeDuration11 
    )
    SELECT
--      pd.Operation                             ,
      pd.HostTripID                            ,
      pd.HostSequenceID                        ,
      pd.HostParameterID                       ,
      RangeDuration0  = MAX(pd.RangeDuration0) ,
      RangeDuration1  = MAX(pd.RangeDuration1) ,
      RangeDuration2  = MAX(pd.RangeDuration2) ,
      RangeDuration3  = MAX(pd.RangeDuration3) ,
      RangeDuration4  = MAX(pd.RangeDuration4) ,
      RangeDuration5  = MAX(pd.RangeDuration5) ,
      RangeDuration6  = MAX(pd.RangeDuration6) ,
      RangeDuration7  = MAX(pd.RangeDuration7) ,
      RangeDuration8  = MAX(pd.RangeDuration8) ,
      RangeDuration9  = MAX(pd.RangeDuration9) ,
      RangeDuration10 = MAX(pd.RangeDuration10),
      RangeDuration11 = MAX(pd.RangeDuration11)
    FROM
      ProfileData pd
    GROUP BY
--      Operation      ,
      HostTripID     ,
      HostSequenceID ,
      HostParameterID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;
    
    -- remove source index
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].ProfileData') AND name = N'IX_ProfileData_TripID_SubTripSequence_ParameterID_Sequence')
      DROP INDEX IX_ProfileData_TripID_SubTripSequence_ParameterID_Sequence ON [StageUser1].ProfileData;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID
      ON [StageUser1].[STAGE_FACT_ProfileDetails](HostTripID,HostSequenceID,HostParameterID);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
    END;

    ------------------------------------------
    -- ActivityDetails Data
    ;WITH Activity AS
    (
      SELECT
        stg1.HostTripID,
        stg1.HostSequenceID,
        ActivityDetailKey = ( SELECT MIN(fad1.ActivityDetailKey)
                              FROM
                                [MiXData].dbo.FACT_ActivitySummary fas1 WITH (NOLOCK)
                                  INNER JOIN
                                [MiXData].dbo.FACT_ActivityDetails fad1 WITH (NOLOCK) ON fad1.ActivitySummaryKey = fas1.ActivitySummaryKey
                                                                                     AND fad1.HostID             = stg1.HostSequenceID
                              WHERE
                                  fas1.OrganisationKey = @organisationKey
                              AND fas1.HostID          = stg1.HostTripID)
      FROM
        [StageUser1].[STAGE_FACT_ProfileDetails] stg1
    )
    UPDATE
      [StageUser1].[STAGE_FACT_ProfileDetails]
    SET
      [ActivityDetailKey] = fad.[ActivityDetailKey]    ,
      [VehicleKey]        = fad.[VehicleKey]           ,
      [StartDateKey]      = fad.[ActivityStartDateKey] ,
      [EndDateKey]        = fad.[ActivityEndDateKey]   ,
      [StartTime]         = fad.[ActivityStartTime]    ,
      [EndTime]           = fad.[ActivityEndTime]      ,
      [StartDateTime]     = fad.[ActivityStartDateTime],
      [EndDateTime]       = fad.[ActivityEndDateTime]  ,
      [UTCOffsetKey]      = fad.[UTCOffsetKey]
    FROM
      [StageUser1].[STAGE_FACT_ProfileDetails] stg
        INNER JOIN
      Activity                                a   ON a.HostTripID     = stg.HostTripID
                                                 AND a.HostSequenceID = stg.HostSequenceID
        INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails      fad WITH (NOLOCK) ON fad.ActivityDetailKey = a.ActivityDetailKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update calculated cols - ActivityDetails Data', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;
    
    -- Remove from STAGE where Activity does not exist
    DELETE [StageUser1].[STAGE_FACT_ProfileDetails]
    WHERE [ActivityDetailKey] IS NULL;
    
    ------------------------------------------
    -- ParameterKey
    UPDATE
      [StageUser1].[STAGE_FACT_ProfileDetails]
    SET
      [ParameterKey] = dpr.[ParameterKey]
    FROM
      [StageUser1].[STAGE_FACT_ProfileDetails]      stg
        INNER JOIN
      [MiXData].[dbo].DIM_CalibrationParameters dpr WITH (NOLOCK) ON @organisationKey    = dpr.OrganisationKey
                                                                    AND stg.HostParameterID = dpr.HostID;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3 Update calculated cols - ParameterKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- VehicleProfileKey
    UPDATE
      [StageUser1].[STAGE_FACT_ProfileDetails]
    SET
      [VehicleProfileKey] = dvp.[VehicleProfileKey]
    FROM
      [StageUser1].[STAGE_FACT_ProfileDetails]  stg
        INNER JOIN
      [MiXData].[dbo].DIM_Vehicles          dvh WITH (NOLOCK) ON stg.VehicleKey      = dvh.VehicleKey
        INNER JOIN
      [MiXData].[dbo].DIM_VehicleProfiles   dvp WITH (NOLOCK) ON dvp.OrganisationKey  = @organisationKey
                                                                 AND dvh.VehicleGUID     = dvp.VehicleGUID
                                                                 AND stg.ParameterKey    = dvp.ParameterKey
    WHERE
      stg.StartDateKey BETWEEN dvp.StartDateKey AND dvp.EndDateKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.4 Update calculated cols - VehicleProfileKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Changed records
    INSERT INTO [StageUser1].[ROLLBACK_FACT_ProfileDetails]
    ( 
      ProfileDetailKey  ,
      OrganisationKey   ,
      HostTripID        ,
      HostSequenceID    ,
      HostParameterID   ,
      VehicleKey        ,
      ParameterKey      ,
      VehicleProfileKey ,
      ActivityDetailKey ,
      StartDateKey      ,
      StartTime         ,
      StartDateTime     ,
      EndDateKey        ,
      EndTime           ,
      EndDateTime       ,
      RangeDuration0    ,
      RangeDuration1    ,
      RangeDuration2    ,
      RangeDuration3    ,
      RangeDuration4    ,
      RangeDuration5    ,
      RangeDuration6    ,
      RangeDuration7    ,
      RangeDuration8    ,
      RangeDuration9    ,
      RangeDuration10   ,
      RangeDuration11   ,
      UTCOffsetKey      ,
      CreateBatchKey    ,
      UpdateBatchKey
    )
    SELECT
      ProfileDetailKey  ,
      OrganisationKey   ,
      HostTripID        ,
      HostSequenceID    ,
      HostParameterID   ,
      VehicleKey        ,
      ParameterKey      ,
      VehicleProfileKey ,
      ActivityDetailKey ,
      StartDateKey      ,
      StartTime         ,
      StartDateTime     ,
      EndDateKey        ,
      EndTime           ,
      EndDateTime       ,
      RangeDuration0    ,
      RangeDuration1    ,
      RangeDuration2    ,
      RangeDuration3    ,
      RangeDuration4    ,
      RangeDuration5    ,
      RangeDuration6    ,
      RangeDuration7    ,
      RangeDuration8    ,
      RangeDuration9    ,
      RangeDuration10   ,
      RangeDuration11   ,
      UTCOffsetKey      ,
      CreateBatchKey    ,
      UpdateBatchKey
    FROM
     (UPDATE
        tar
      SET
        VehicleKey          = ISNULL(stg.VehicleKey        ,-1),
        ParameterKey        = ISNULL(stg.ParameterKey      ,-1),
        VehicleProfileKey   = ISNULL(stg.VehicleProfileKey ,-1),
        ActivityDetailKey   = ISNULL(stg.ActivityDetailKey ,-1),
        StartDateKey        = stg.StartDateKey      ,
        StartTime           = stg.StartTime         ,
        StartDateTime       = stg.StartDateTime     ,
        EndDateKey          = stg.EndDateKey        ,
        EndTime             = stg.EndTime           ,
        EndDateTime         = stg.EndDateTime       ,
        RangeDuration0      = ISNULL(stg.RangeDuration0    , tar.RangeDuration0  ),
        RangeDuration1      = ISNULL(stg.RangeDuration1    , tar.RangeDuration1  ),
        RangeDuration2      = ISNULL(stg.RangeDuration2    , tar.RangeDuration2  ),
        RangeDuration3      = ISNULL(stg.RangeDuration3    , tar.RangeDuration3  ),
        RangeDuration4      = ISNULL(stg.RangeDuration4    , tar.RangeDuration4  ),
        RangeDuration5      = ISNULL(stg.RangeDuration5    , tar.RangeDuration5  ),
        RangeDuration6      = ISNULL(stg.RangeDuration6    , tar.RangeDuration6  ),
        RangeDuration7      = ISNULL(stg.RangeDuration7    , tar.RangeDuration7  ),
        RangeDuration8      = ISNULL(stg.RangeDuration8    , tar.RangeDuration8  ),
        RangeDuration9      = ISNULL(stg.RangeDuration9    , tar.RangeDuration9  ),
        RangeDuration10     = ISNULL(stg.RangeDuration10   , tar.RangeDuration10 ),
        RangeDuration11     = ISNULL(stg.RangeDuration11   , tar.RangeDuration11 ),
        UTCOffsetKey        = stg.UTCOffsetKey      ,
        UpdateBatchKey      = @batchKey
      OUTPUT
        DELETED.ProfileDetailKey  ,
        DELETED.OrganisationKey   ,
        DELETED.HostTripID        ,
        DELETED.HostSequenceID    ,
        DELETED.HostParameterID   ,
        DELETED.VehicleKey        ,
        DELETED.ParameterKey      ,
        DELETED.VehicleProfileKey ,
        DELETED.ActivityDetailKey ,
        DELETED.StartDateKey      ,
        DELETED.StartTime         ,
        DELETED.StartDateTime     ,
        DELETED.EndDateKey        ,
        DELETED.EndTime           ,
        DELETED.EndDateTime       ,
        DELETED.RangeDuration0    ,
        DELETED.RangeDuration1    ,
        DELETED.RangeDuration2    ,
        DELETED.RangeDuration3    ,
        DELETED.RangeDuration4    ,
        DELETED.RangeDuration5    ,
        DELETED.RangeDuration6    ,
        DELETED.RangeDuration7    ,
        DELETED.RangeDuration8    ,
        DELETED.RangeDuration9    ,
        DELETED.RangeDuration10   ,
        DELETED.RangeDuration11   ,
        DELETED.UTCOffsetKey      ,
        DELETED.CreateBatchKey    ,
        DELETED.UpdateBatchKey
      FROM 
       [MiXData].dbo.FACT_ProfileDetails    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser1].[STAGE_FACT_ProfileDetails] AS stg ON tar.HostTripID      = stg.HostTripID
                                                     AND tar.HostSequenceID  = stg.HostSequenceID
                                                     AND tar.HostParameterID = stg.HostParameterID
                                                     AND tar.OrganisationKey = @organisationKey
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID
      ON [StageUser1].[ROLLBACK_FACT_ProfileDetails](HostTripID,HostSequenceID,HostParameterID);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_ProfileDetails
    ( 
      OrganisationKey   ,
      HostTripID        ,
      HostSequenceID    ,
      HostParameterID   ,
      VehicleKey        ,
      ParameterKey      ,
      VehicleProfileKey ,
      ActivityDetailKey ,
      StartDateKey      ,
      StartTime         ,
      StartDateTime     ,
      EndDateKey        ,
      EndTime           ,
      EndDateTime       ,
      RangeDuration0    ,
      RangeDuration1    ,
      RangeDuration2    ,
      RangeDuration3    ,
      RangeDuration4    ,
      RangeDuration5    ,
      RangeDuration6    ,
      RangeDuration7    ,
      RangeDuration8    ,
      RangeDuration9    ,
      RangeDuration10   ,
      RangeDuration11   ,
      UTCOffsetKey      ,
      CreateBatchKey    ,
      UpdateBatchKey
    )
    SELECT
      @organisationKey      ,
      stg.HostTripID        ,
      stg.HostSequenceID    ,
      stg.HostParameterID   ,
      ISNULL(stg.VehicleKey        ,-1),
      ISNULL(stg.ParameterKey      ,-1),
      ISNULL(stg.VehicleProfileKey ,-1),
      ISNULL(stg.ActivityDetailKey ,-1),
      stg.StartDateKey      ,
      stg.StartTime         ,
      stg.StartDateTime     ,
      stg.EndDateKey        ,
      stg.EndTime           ,
      stg.EndDateTime       ,
      ISNULL(stg.RangeDuration0 , 0),
      ISNULL(stg.RangeDuration1 , 0),
      ISNULL(stg.RangeDuration2 , 0),
      ISNULL(stg.RangeDuration3 , 0),
      ISNULL(stg.RangeDuration4 , 0),
      ISNULL(stg.RangeDuration5 , 0),
      ISNULL(stg.RangeDuration6 , 0),
      ISNULL(stg.RangeDuration7 , 0),
      ISNULL(stg.RangeDuration8 , 0),
      ISNULL(stg.RangeDuration9 , 0),
      ISNULL(stg.RangeDuration10, 0),
      ISNULL(stg.RangeDuration11, 0),
      stg.UTCOffsetKey      ,
      @batchKey             ,
      @batchKey
    FROM
      [StageUser1].[STAGE_FACT_ProfileDetails]    AS stg
    WHERE
      NOT EXISTS (SELECT 1
                    FROM
                      [StageUser1].[ROLLBACK_FACT_ProfileDetails] AS roll WITH (NOLOCK)
                    WHERE
                        stg.HostTripID      = roll.HostTripID
                    AND stg.HostSequenceID  = roll.HostSequenceID
                    AND stg.HostParameterID = roll.HostParameterID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_ProfileDetails];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_ServiceHistory_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_ServiceHistory_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE	@currentDate        datetimeoffset; -- used for validation

  SELECT @currentDate = SYSUTCDATETIME();
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_ServiceHistory];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_ServiceHistory];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_ServiceHistory]') AND name = N'IX_ROLLBACK_FACT_ServiceHistory_HostID')
      DROP INDEX IX_ROLLBACK_FACT_ServiceHistory_HostID ON [StageUser1].[ROLLBACK_FACT_ServiceHistory];
  
    -- insert changed records into STG
	  INSERT INTO [StageUser1].[STAGE_FACT_ServiceHistory]
	  ( 
	    [Operation]      ,
      [HostID]         ,
      [VehicleID]      ,
      [ServiceDateKey] ,
      [ServiceDateTime],
      [Odometer]       ,
      [EngineSeconds]  ,
      [Reference]      ,
      [BaseCost]       ,
      [BaseCurrency]   ,
      [Notes]          ,
      [UTCOffsetKey]
	  )
	  SELECT
	    s.Operation                  ,
      HostID = s.liServiceKey      ,
      s.iVehicleID                 ,
      CONVERT(DATE,s.dtServiceDate),
      CASE 
        WHEN s.dtServiceDate IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.dtServiceDate,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      s.fOdometer                  ,
      s.liEngineSeconds            ,
      s.sReference                 ,
      s.fBaseCost                  ,
      s.sBaseCur                   ,
      s.sNotes                     ,
      utc.UTCOffsetKey
	  FROM
	    [StageUser1].ServiceHistory s WITH (NOLOCK)
	      CROSS JOIN
	    [StageUser1].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
	  WHERE
        ISNULL(CONVERT(DATETIMEOFFSET(0),s.dtServiceDate),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.dtServiceDate),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    ------------------------------------------
    -- VehicleKey
    UPDATE
      [StageUser1].[STAGE_FACT_ServiceHistory]
    SET
      [VehicleKey] = dv.[VehicleKey]
    FROM
      [StageUser1].[STAGE_FACT_ServiceHistory] stg
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles      dv  WITH (NOLOCK)
        ON  dv.OrganisationKey = @organisationKey
        AND stg.VehicleID      = dv.HostID
    WHERE
      stg.ServiceDateKey BETWEEN dv.StartDateKey AND dv.EndDateKey;

    ------------------------------------------
    -- BaseCurrrencyKey
    UPDATE
      [StageUser1].[STAGE_FACT_ServiceHistory]
    SET
      [BaseCurrencyKey] = dc.[CurrencyKey]
    FROM
      [StageUser1].[STAGE_FACT_ServiceHistory] stg
        INNER JOIN
      [MiXData].dbo.DIM_Currencies      dc WITH (NOLOCK)
        ON  dc.[CurrencyAlternateKey] = stg.[BaseCurrency];

    ------------------------------------------
    -- UTCOffsetKey (use company UTC for now, will change in future)
/*    
    UPDATE [StageUser1].[STAGE_FACT_ServiceHistory]
    SET
      UTCOffsetKey = utc.UTCOffsetKey
    FROM
      [StageUser1].[STAGE_FACT_ServiceHistory] stg,
      [StageUser1].STAGE_DIM_UTCOffsetsLookUp utc WITH (NOLOCK)
    WHERE
      stg.ServiceDateKey BETWEEN utc.StartDateKey    AND utc.EndDateKey
    AND
      stg.ServiceDateKey BETWEEN utc.SeasonStartDate AND utc.SeasonEndDate;
*/

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Changed records
    INSERT INTO [StageUser1].[ROLLBACK_FACT_ServiceHistory]
    ( 
      [ServiceHistoryKeyID],
      [OrganisationKey]    ,
      [HostID]             ,
      [VehicleKey]         ,
      [ServiceDateKey]     ,
      [ServiceDateTime]    ,
      [Odometer]           ,
      [EngineSeconds]      ,
      [Reference]          ,
      [BaseCost]           ,
      [BaseCurrencyKey]    ,
      [Notes]              ,
      [UTCOffsetKey]       ,
      [IsDeleted]          ,
      [CreateBatchKey]     ,
      [UpdateBatchKey]
    )
    SELECT
      [ServiceHistoryKeyID],
      [OrganisationKey]    ,
      [HostID]             ,
      [VehicleKey]         ,
      [ServiceDateKey]     ,
      [ServiceDateTime]    ,
      [Odometer]           ,
      [EngineSeconds]      ,
      [Reference]          ,
      [BaseCost]           ,
      [BaseCurrencyKey]    ,
      [Notes]              ,
      [UTCOffsetKey]       ,
      [IsDeleted]          ,
      [CreateBatchKey]     ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [VehicleKey]       = ISNULL(stg.[VehicleKey]     ,-1),
        [ServiceDateKey]   = stg.[ServiceDateKey] ,
        [ServiceDateTime]  = stg.[ServiceDateTime],
        [Odometer]         = stg.[Odometer]       ,
        [EngineSeconds]    = stg.[EngineSeconds]  ,
        [Reference]        = stg.[Reference]      ,
        [BaseCost]         = stg.[BaseCost]       ,
        [BaseCurrencyKey]  = ISNULL(stg.[BaseCurrencyKey],-1),
        [Notes]            = stg.[Notes]          ,
        [UTCOffsetKey]     = stg.[UTCOffsetKey]   ,
        [UpdateBatchKey]   = @batchKey
      OUTPUT
        DELETED.[ServiceHistoryKeyID],
        DELETED.[OrganisationKey]    ,
        DELETED.[HostID]             ,
        DELETED.[VehicleKey]         ,
        DELETED.[ServiceDateKey]     ,
        DELETED.[ServiceDateTime]    ,
        DELETED.[Odometer]           ,
        DELETED.[EngineSeconds]      ,
        DELETED.[Reference]          ,
        DELETED.[BaseCost]           ,
        DELETED.[BaseCurrencyKey]    ,
        DELETED.[Notes]              ,
        DELETED.[UTCOffsetKey]       ,
        DELETED.IsDeleted            ,
        DELETED.[CreateBatchKey]     ,
        DELETED.[UpdateBatchKey]
      FROM 
       [MiXData].dbo.FACT_ServiceHistory    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser1].[STAGE_FACT_ServiceHistory] AS stg ON tar.HostID          = stg.HostID
                                                     AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation in ('I','U')
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;  
    END;  

    -- Deleted records
    INSERT INTO [StageUser1].[ROLLBACK_FACT_ServiceHistory]
    ( 
      [ServiceHistoryKeyID],
      [OrganisationKey]    ,
      [HostID]             ,
      [VehicleKey]         ,
      [ServiceDateKey]     ,
      [ServiceDateTime]    ,
      [Odometer]           ,
      [EngineSeconds]      ,
      [Reference]          ,
      [BaseCost]           ,
      [BaseCurrencyKey]    ,
      [Notes]              ,
      [UTCOffsetKey]       ,
      [IsDeleted]          ,
      [CreateBatchKey]     ,
      [UpdateBatchKey]
    )
    SELECT
      [ServiceHistoryKeyID],
      [OrganisationKey]    ,
      [HostID]             ,
      [VehicleKey]         ,
      [ServiceDateKey]     ,
      [ServiceDateTime]    ,
      [Odometer]           ,
      [EngineSeconds]      ,
      [Reference]          ,
      [BaseCost]           ,
      [BaseCurrencyKey]    ,
      [Notes]              ,
      [UTCOffsetKey]       ,
      [IsDeleted]          ,
      [CreateBatchKey]     ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]       = 1,
        [UpdateBatchKey]  = @batchKey
      OUTPUT
        DELETED.[ServiceHistoryKeyID],
        DELETED.[OrganisationKey]    ,
        DELETED.[HostID]             ,
        DELETED.[VehicleKey]         ,
        DELETED.[ServiceDateKey]     ,
        DELETED.[ServiceDateTime]    ,
        DELETED.[Odometer]           ,
        DELETED.[EngineSeconds]      ,
        DELETED.[Reference]          ,
        DELETED.[BaseCost]           ,
        DELETED.[BaseCurrencyKey]    ,
        DELETED.[Notes]              ,
        DELETED.[UTCOffsetKey]       ,
        DELETED.[IsDeleted]          ,
        DELETED.[CreateBatchKey]     ,
        DELETED.[UpdateBatchKey]
      FROM 
       [MiXData].dbo.FACT_ServiceHistory    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser1].[STAGE_FACT_ServiceHistory] AS stg ON tar.HostID          = stg.HostID
                                                     AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation = 'D'
      ) AS del;

    -- record number of records deleted
    SELECT @recordsDeleted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;  
    END;  

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_ServiceHistory_HostID
      ON [StageUser1].[ROLLBACK_FACT_ServiceHistory](HostID);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_ServiceHistory
    ( 
      [OrganisationKey],
      [HostID]         ,
      [VehicleKey]     ,
      [ServiceDateKey] ,
      [ServiceDateTime],
      [Odometer]       ,
      [EngineSeconds]  ,
      [Reference]      ,
      [BaseCost]       ,
      [BaseCurrencyKey],
      [Notes]          ,
      [UTCOffsetKey]   ,
      [IsDeleted]      ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey     ,
      stg.[HostID]         ,
      ISNULL(stg.[VehicleKey]     ,-1),
      stg.[ServiceDateKey] ,
      stg.[ServiceDateTime],
      stg.[Odometer]       ,
      stg.[EngineSeconds]  ,
      stg.[Reference]      ,
      stg.[BaseCost]       ,
      ISNULL(stg.[BaseCurrencyKey],-1),
      stg.[Notes]          ,
      stg.[UTCOffsetKey]   ,
      IsDeleted = 0        ,
      @batchKey            ,
      @batchKey
    FROM
      [StageUser1].[STAGE_FACT_ServiceHistory]    AS stg
    WHERE
        stg.Operation IN ('I','U')
    AND NOT EXISTS (SELECT 1
                    FROM
                      [StageUser1].[ROLLBACK_FACT_ServiceHistory] AS roll WITH (NOLOCK)
                    WHERE
                      stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_ServiceHistory];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N'7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_ShapeVisits_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_ShapeVisits_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int   = 0;
  DECLARE @unknownDateDefault  date   = '00010101';
  DECLARE @maxDuration         bigint = 2147483647; -- this is the max int data type value
  DECLARE @maxDurationYears    int  = 68; -- anything bigger than 68 causes overflow of int datatype
  DECLARE @maxFuelLimit        int  = 99999.0; -- anything bigger than 68 causes overflow of int datatype  
  DECLARE @currentDate         datetimeoffset = SYSUTCDATETIME(); -- used for validation
  DECLARE @flagStartTime       datetimeoffset(0) = SYSUTCDATETIME();
  DECLARE @flagSeq             smallint = 1;
  
  CREATE TABLE #newChangedShapes
  (
    ShapeKey int
  );

  CREATE TABLE #ActivityChangedDates
  (
    VehicleKey           INT,
    ActivityStartDateKey DATE
  );

  -- used for temporary storage
  CREATE TABLE #activityDetails
  (
    ActivityDetailKey             bigint,
    NextMovementActivityDetailKey bigint,
    ActivityStartDateKey          date,
    VehicleKey                    int,
    DriverKey                     int,
    UTCOffsetKey                  int,
    DurationAtLocation            int,
    EndGeoLocationKey             bigint
  );

  CREATE TABLE #activityDetailsChanged
  (
    ActivityDetailKey             bigint,
    NextMovementActivityDetailKey bigint,
    ActivityStartDateKey          date,
    VehicleKey                    int,
    DriverKey                     int,
    UTCOffsetKey                  int,
    DurationAtLocation            int,
    EndGeoLocationKey             bigint
  );

  -- used for temporary storage
  CREATE TABLE #activityEndGeoLocation
  (
    EndGeoLocationKey  bigint,
    EndShapeKey        int
  );
  
  CREATE TABLE #VehiclesLookup
  (
    VehicleKey INT NOT NULL,
    HostID     INT NOT NULL
  );

  CREATE TABLE #ShapesLookup
  (
    ShapeKey INT NOT NULL
  );

  CREATE TABLE #DuplicateActivityShapes
  (
    VehicleKey                    int,
    DriverKey                     int,
    ActivityStartDateKey          date,
    ActivityDetailKey             bigint,
    NextMovementActivityDetailKey bigint,
    EndShapeKey                   int,
    NMEndShapeKey                 int
  );

  CREATE TABLE #DeDuplicatedActivityShapes
  (
    VehicleKey                    int,
    DriverKey                     int,
    ActivityStartDateKey          date,
    ActivityDetailKey             bigint,
    NextMovementActivityDetailKey bigint,
    EndShapeKey                   int,
    NMEndShapeKey                 int
  );

  CREATE TABLE #rollback
  (
    HostID       BIGINT
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_ShapeVisits];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_ShapeVisits];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY


    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ShapeVisits]') AND name = N'IX_STAGE_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey')
      DROP INDEX IX_STAGE_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey ON [StageUser1].[STAGE_FACT_ShapeVisits];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_ShapeVisits]') AND name = N'IX_ROLLBACK_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey')
      DROP INDEX IX_ROLLBACK_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey ON [StageUser1].[ROLLBACK_FACT_ShapeVisits];

    -- create STAGE indexes
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey_VehicleKey')
      CREATE INDEX IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey_VehicleKey
        ON [StageUser1].STAGE_FACT_ActivityDetails(ActivityStartDateKey,VehicleKey);

    INSERT INTO #newChangedShapes (ShapeKey)
    SELECT DISTINCT
      dsh.ShapeKey
    FROM
      [StageUser1].STAGE_DIM_Shapes ssh WITH (NOLOCK)
        INNER JOIN
      [MiXData].dbo.DIM_Shapes      dsh WITH (NOLOCK) ON dsh.OrganisationKey = @organisationKey
                                                     AND dsh.HostID          = ssh.HostID
    WHERE
      ssh.IsDeleted       = 0;
    
    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    CREATE CLUSTERED INDEX IX_newChangedShapes ON #newChangedShapes(ShapeKey);

    -- get GeoLocations for new Shapes
    IF EXISTS(SELECT 1 FROM #newChangedShapes)
    BEGIN
      INSERT INTO #activityEndGeoLocation
      ( EndGeoLocationKey, EndShapeKey )
      SELECT DISTINCT
        dgls.GeoLocationKey,
        dgls.ShapeKey
      FROM
        #newChangedShapes                      ncs
          INNER JOIN
        [MiXData].dbo.DIM_GeoLocationsToShapes dgls WITH (NOLOCK) ON dgls.ShapeKey            = ncs.ShapeKey;
    END;

    CREATE CLUSTERED INDEX IX_activityEndGeoLocation ON #activityEndGeoLocation(EndGeoLocationKey,EndShapeKey);

    INSERT INTO #VehiclesLookup
    ( VehicleKey, HostID )
    SELECT
      dvh.VehicleKey,
      dvh.HostID
    FROM
      [MiXData].dbo.DIM_Vehicles dvh  WITH (NOLOCK)
    WHERE dvh.OrganisationKey = @organisationKey;

    CREATE CLUSTERED INDEX IX_VehiclesLookup ON #VehiclesLookup(VehicleKey);

    INSERT INTO #ShapesLookup
    ( ShapeKey )
    SELECT
      ds.ShapeKey
    FROM
      [MiXData].dbo.DIM_Shapes ds  WITH (NOLOCK)
    WHERE ds.OrganisationKey = @organisationKey;

    CREATE CLUSTERED INDEX IX_ShapesLookup ON #ShapesLookup(ShapeKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.1 Initial Insert - Create Lookups', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.1 Initial Insert - Create Lookups';
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- insert Activities of new/changed shapes
    IF EXISTS(SELECT 1 FROM #newChangedShapes)
    BEGIN
      INSERT INTO #activityDetails
      (
        ActivityDetailKey            ,
        NextMovementActivityDetailKey,
        ActivityStartDateKey         ,
        VehicleKey                   ,
        DriverKey                    ,
        UTCOffsetKey                 ,
        DurationAtLocation           ,
        EndGeoLocationKey
      )
      SELECT
        fad.ActivityDetailKey            ,
        fad.NextMovementActivityDetailKey,
        fad.ActivityStartDateKey         ,
        fad.VehicleKey                   ,
        fad.DriverKey                    ,
        fad.UTCOffsetKey                 ,
        DurationAtLocation = CASE 
                               WHEN ABS(DATEDIFF(year,fad.MovementEndDateTime,fad.NextMovementStartDateTime)) < @maxDurationYears
                                AND fad.MovementEndDateTime < fad.NextMovementStartDateTime
                                 THEN DATEDIFF(s,fad.MovementEndDateTime,fad.NextMovementStartDateTime)
                               ELSE 0
                             END,
        fad.EndGeoLocationKey
      FROM
        #VehiclesLookup                       dvh
          INNER JOIN  -- select EndGeoLocationKey from
        [MiXData].dbo.FACT_ActivityDetails fad  WITH (NOLOCK) ON fad.VehicleKey = dvh.VehicleKey
      WHERE
          fad.HostID > 0
      AND EXISTS (SELECT 1
                  FROM #activityEndGeoLocation egl
                  WHERE egl.EndGeoLocationKey = fad.EndGeoLocationKey);
    END;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    CREATE CLUSTERED INDEX IX_activityDetails ON #activityDetails(ActivityDetailKey);
    
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.2 Initial Insert - Activities for new/changed Shapes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.2 Initial Insert - Activities for new/changed Shapes';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- insert changed Activities
    INSERT INTO #ActivityChangedDates
    ( ActivityStartDateKey,VehicleKey )
    SELECT
      ActivityStartDateKey,
      VehicleKey
    FROM
      [StageUser1].STAGE_FACT_ActivityDetails
    GROUP BY
      ActivityStartDateKey,
      VehicleKey;
    
    CREATE CLUSTERED INDEX IX_ActivityChangedDates ON #ActivityChangedDates(VehicleKey,ActivityStartDateKey);

    INSERT INTO #activityDetailsChanged
    (
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      ActivityStartDateKey         ,
      VehicleKey                   ,
      DriverKey                    ,
      UTCOffsetKey                 ,
      DurationAtLocation           ,
      EndGeoLocationKey
    )
    SELECT
      fad.ActivityDetailKey            ,
      fad.NextMovementActivityDetailKey,
      fad.ActivityStartDateKey         ,
      fad.VehicleKey                   ,
      fad.DriverKey                    ,
      fad.UTCOffsetKey                 ,
      DurationAtLocation = CASE 
                             WHEN ABS(DATEDIFF(year,fad.MovementEndDateTime,fad.NextMovementStartDateTime)) < @maxDurationYears
                              AND fad.MovementEndDateTime < fad.NextMovementStartDateTime
                               THEN DATEDIFF(s,fad.MovementEndDateTime,fad.NextMovementStartDateTime)
                             ELSE 0
                           END,
      fad.EndGeoLocationKey
    FROM
      #ActivityChangedDates                ac
        INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails fad  WITH (NOLOCK) ON fad.VehicleKey           = ac.VehicleKey
                                                              AND fad.ActivityStartDateKey = ac.ActivityStartDateKey
    WHERE
        fad.HostID > 0
    AND EXISTS (SELECT 1
                FROM 
                  #ShapesLookup                             dsh
                    INNER JOIN
                  [MiXData].dbo.DIM_GeoLocationsToShapes dgls WITH (NOLOCK) ON dgls.ShapeKey = dsh.ShapeKey
                WHERE dgls.GeoLocationKey = fad.EndGeoLocationKey);

    CREATE CLUSTERED INDEX IX_activityDetailsChanged ON #activityDetailsChanged(ActivityDetailKey);

    INSERT INTO #activityDetails
    (
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      ActivityStartDateKey         ,
      VehicleKey                   ,
      DriverKey                    ,
      UTCOffsetKey                 ,
      DurationAtLocation           ,
      EndGeoLocationKey
    )
    SELECT
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      ActivityStartDateKey         ,
      VehicleKey                   ,
      DriverKey                    ,
      UTCOffsetKey                 ,
      DurationAtLocation           ,
      EndGeoLocationKey
    FROM #activityDetailsChanged fad
    WHERE NOT EXISTS (SELECT 1
                      FROM #activityDetails a
                      WHERE a.ActivityDetailKey = fad.ActivityDetailKey);
    DROP TABLE #activityDetailsChanged;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.3 Initial Insert - changed Activities', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.3 Initial Insert - changed Activities';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- get GeoLocations for Changed Acitivities
    CREATE INDEX IX_activityDetails_EndGeoLocationKey ON #activityDetails(EndGeoLocationKey);

    ;WITH
    ActivityEndLocations AS
    (
      SELECT DISTINCT ad.EndGeoLocationKey
      FROM #activityDetails ad
    )
    INSERT INTO #activityEndGeoLocation
    ( EndGeoLocationKey, EndShapeKey )
    SELECT DISTINCT
      dgls.GeoLocationKey,
      dgls.ShapeKey
    FROM
      ActivityEndLocations                   al
        INNER JOIN
      [MiXData].dbo.DIM_GeoLocationsToShapes dgls WITH (NOLOCK) ON dgls.GeoLocationKey = al.EndGeoLocationKey
        INNER JOIN
      [MiXData].dbo.DIM_Shapes               dsh  WITH (NOLOCK) ON dsh.OrganisationKey = @organisationKey
                                                               AND dsh.ShapeKey        = dgls.ShapeKey
    WHERE
      NOT EXISTS (SELECT 1
                  FROM #activityEndGeoLocation agl
                  WHERE
                      agl.EndGeoLocationKey = dgls.GeoLocationKey
                  AND agl.EndShapeKey       = dgls.ShapeKey);

    -- Add simple visits to STAGE table
    INSERT INTO [StageUser1].[STAGE_FACT_ShapeVisits]
    (
      VisitDateKey      ,
      ShapeKey          ,
      VehicleKey        ,
      DriverKey         ,
      UTCOffsetKey      ,
      DurationAtLocation,
      NumberOfVisits
    )
    SELECT
      fad.ActivityStartDateKey,
      egl.EndShapeKey         ,
      fad.VehicleKey          ,
      fad.DriverKey           ,
      fad.UTCOffsetKey        ,
      DurationAtLocation = SUM(DurationAtLocation),
      NumberOfVisits     = COUNT(DISTINCT fad.ActivityDetailKey)
    FROM
      #activityEndGeoLocation egl
        INNER JOIN
      #activityDetails        fad ON fad.EndGeoLocationKey = egl.EndGeoLocationKey
    GROUP BY
      fad.ActivityStartDateKey,
      egl.EndShapeKey         ,
      fad.VehicleKey          ,
      fad.DriverKey           ,
      fad.UTCOffsetKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.4 Initial Insert - add Simple visits to STAGE', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.4 Initial Insert - add Simple visits to STAGE';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -------------------------------------
    -- 2.5 Calculate Unique Visits
    -- 2.5.1 Identify Duplicate ActivityShape rows
    CREATE INDEX IX_activityDetails_NextMovementActivityDetailKey_VehicleKey_DriverKey ON #activityDetails(NextMovementActivityDetailKey,VehicleKey,DriverKey);

    INSERT INTO #DuplicateActivityShapes
    (
      VehicleKey                   ,
      DriverKey                    ,
      ActivityStartDateKey         ,
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      EndShapeKey                  ,
      NMEndShapeKey
    )
    SELECT
      m.VehicleKey,
      m.DriverKey,
      m.ActivityStartDateKey,
      m.ActivityDetailKey,
      m.NextMovementActivityDetailKey,
      ge.EndShapeKey,
      NMEndShapeKey = gen.EndShapeKey
    FROM
      #activityEndGeoLocation ge
        INNER JOIN
      #activityDetails        m   ON m.EndGeoLocationKey             = ge.EndGeoLocationKey
        LEFT JOIN
      #activityDetails        nm  ON m.NextMovementActivityDetailKey = nm.ActivityDetailKey
                                 AND m.VehicleKey                    = nm.VehicleKey
                                 AND m.DriverKey                     = nm.DriverKey
        LEFT JOIN
      #activityEndGeoLocation gen ON nm.EndGeoLocationKey            = gen.EndGeoLocationKey
    WHERE
      ge.EndShapeKey = gen.EndShapeKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    
    CREATE CLUSTERED INDEX IX_DuplicatedActivityShapes ON #DuplicateActivityShapes(ActivityDetailKey,EndShapeKey,ActivityStartDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.5.1 Initial Insert - Unique ShapeVisits - Identify Duplicate ActivityShape rows', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.5.1 Initial Insert - Unique ShapeVisits - Identify Duplicate ActivityShape rows';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- 2.5.2 De-duplicate ActivityShape rows
    INSERT INTO #DeDuplicatedActivityShapes
    (
      VehicleKey                   ,
      DriverKey                    ,
      ActivityStartDateKey         ,
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      EndShapeKey                  ,
      NMEndShapeKey
    )
    SELECT
      VehicleKey                   ,
      DriverKey                    ,
      ActivityStartDateKey         ,
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      EndShapeKey                  ,
      NMEndShapeKey
    FROM #DuplicateActivityShapes;

    CREATE CLUSTERED INDEX IX_DeDuplicatedActivityShapes ON #DeDuplicatedActivityShapes(ActivityDetailKey,EndShapeKey,ActivityStartDateKey);

    DELETE dd
    FROM
      #DeDuplicatedActivityShapes dd
    WHERE
      EXISTS (SELECT 1
              FROM #DeDuplicatedActivityShapes dd2
              WHERE
                  dd2.ActivityDetailKey    = dd.NextMovementActivityDetailKey
              AND dd2.EndShapeKey          = dd.EndShapeKey
              AND dd2.ActivityStartDateKey = dd.ActivityStartDateKey
              AND dd2.VehicleKey           = dd.VehicleKey
              AND dd2.DriverKey            = dd.DriverKey);

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.5.2 Initial Insert - Unique ShapeVisits - De-duplicate ActivityShape rows', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.5.2 Initial Insert - Unique ShapeVisits - De-duplicate ActivityShape rows';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- 2.5.3 Identify Single ActivityShapeVisits
    INSERT INTO #DeDuplicatedActivityShapes
    (
      VehicleKey                   ,
      DriverKey                    ,
      ActivityStartDateKey         ,
      ActivityDetailKey            ,
      NextMovementActivityDetailKey,
      EndShapeKey
    )
    SELECT
      m.VehicleKey,
      m.DriverKey,
      m.ActivityStartDateKey,
      m.ActivityDetailKey,
      m.NextMovementActivityDetailKey,
      ge.EndShapeKey
    FROM
      #activityEndGeoLocation ge
        INNER JOIN
      #activityDetails        m  ON m.EndGeoLocationKey = ge.EndGeoLocationKey
    WHERE
      NOT EXISTS (SELECT 1
                  FROM #DuplicateActivityShapes d
                  where 
                      d.VehicleKey           = m.VehicleKey
                  AND d.VehicleKey           = m.VehicleKey
                  AND d.ActivityStartDateKey = m.ActivityStartDateKey
                  AND d.EndShapeKey          = ge.EndShapeKey
                  AND d.ActivityDetailKey    = m.ActivityDetailKey)
    AND
      NOT EXISTS (SELECT 1
                  FROM #DuplicateActivityShapes d
                  WHERE
                      d.VehicleKey                    = m.VehicleKey
                  AND d.DriverKey                     = m.DriverKey
                  AND d.ActivityStartDateKey          = m.ActivityStartDateKey
                  AND d.NMEndShapeKey                 = ge.EndShapeKey
                  AND d.NextMovementActivityDetailKey = m.ActivityDetailKey);

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.5.3 Initial Insert - Unique ShapeVisits - Identify Single ActivityShapeVisits', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.5.3 Initial Insert - Unique ShapeVisits - Identify Single ActivityShapeVisits';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;
    
    -- 2.5.4 Update Unique ShapeVisits
    ;WITH
    UniqueShapeVisits AS
    (
      SELECT
        dd.VehicleKey,
        dd.DriverKey,
        dd.ActivityStartDateKey,
        dd.EndShapeKey,
        NumberOfUniqueVisits = COUNT(1)
      FROM
        #DeDuplicatedActivityShapes dd
      GROUP BY
        dd.VehicleKey,
        dd.DriverKey,
        dd.ActivityStartDateKey,
        dd.EndShapeKey
    )
    UPDATE
      stg
    SET
      NumberOfUniqueVisits = usv.NumberOfUniqueVisits
    FROM
      [StageUser1].[STAGE_FACT_ShapeVisits] stg
        INNER JOIN
      UniqueShapeVisits                    usv ON usv.VehicleKey           = stg.VehicleKey
                                              AND usv.DriverKey            = stg.DriverKey
                                              AND usv.ActivityStartDateKey = stg.VisitDateKey
                                              AND usv.EndShapeKey          = stg.ShapeKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2.5.4 Initial Insert - Update Unique ShapeVisits', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2.5.4 Initial Insert - Update Unique ShapeVisits';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey
      ON [StageUser1].[STAGE_FACT_ShapeVisits](ShapeKey,VehicleKey,VisitDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;        
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;
  DECLARE @processPoint   int = 0;  -- what has already been done.
  WHILE @exceptionCount < 5
  BEGIN

    BEGIN TRY

      -- 5.1 Remove Changed records from DW
      IF @processPoint < 1
      BEGIN
        BEGIN TRANSACTION;
        DELETE tar
        FROM
          [StageUser1].[STAGE_FACT_ShapeVisits] stg
            INNER JOIN
          [MiXData].dbo.FACT_ShapeVisits    tar ON                tar.ShapeKey            = stg.ShapeKey
                                                                 AND tar.VehicleKey          = stg.VehicleKey
                                                                 AND tar.VisitDateKey        = stg.VisitDateKey;

        -- record number of records updated
        SELECT @recordsUpdated = @@ROWCOUNT;
        COMMIT TRANSACTION;
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.1 Merge Remove Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
      END; -- @processPoint 1

      -- 5.2 Remove Deleted Shapes records from DW
      IF @processPoint < 2
      BEGIN
        BEGIN TRANSACTION;
        IF EXISTS (SELECT 1
                   FROM [StageUser1].STAGE_DIM_Shapes
                   WHERE IsDeleted =1)
        BEGIN
          DELETE tar
          FROM 
            [StageUser1].STAGE_DIM_Shapes      ssh WITH (NOLOCK)
              INNER JOIN
            [MiXData].dbo.DIM_Shapes       dsh WITH (NOLOCK) ON dsh.OrganisationKey     = @organisationKey
                                                               AND ssh.IsDeleted           = 1
                                                               AND dsh.HostID              = ssh.HostID
              INNER JOIN
            [MiXData].dbo.FACT_ShapeVisits tar               ON tar.ShapeKey            = dsh.ShapeKey;
        END;

        -- record number of records updated
        SELECT @recordsDeleted = @@ROWCOUNT;
        COMMIT TRANSACTION
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.2 Merge Remove Deleted Shapes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;            
        END;
      END; -- @processPoint 2

      -- create rollback index
      IF NOT EXISTS(SELECT *
                    FROM sys.indexes 
                    WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_ShapeVisits]') AND name = N'IX_ROLLBACK_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey')
        CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey
          ON [StageUser1].[ROLLBACK_FACT_ShapeVisits](ShapeKey,VehicleKey,VisitDateKey);

      -- 5.3 insert new records to FACT
      IF @processPoint < 3
      BEGIN
        BEGIN TRANSACTION;

        INSERT INTO [MiXData].dbo.FACT_ShapeVisits
        (
          [OrganisationKey]   ,
          [VisitDateKey]      ,
          [ShapeKey]          ,
          [VehicleKey]        ,
          [DriverKey]         ,
          [DurationAtLocation],
          [NumberOfVisits]    ,
          NumberOfUniqueVisits,
          [UTCOffsetKey]      ,
          [CreateBatchKey]    ,
          [UpdateBatchKey]
        )
        SELECT
          @organisationKey    ,
          [VisitDateKey]      ,
          [ShapeKey]          ,
          [VehicleKey]        ,
          [DriverKey]         ,
          ISNULL([DurationAtLocation],0),
          ISNULL([NumberOfVisits]    ,0),
          ISNULL(NumberOfUniqueVisits,0),
          [UTCOffsetKey]      ,
          @batchKey           ,
          @batchKey
        FROM
          [StageUser1].[STAGE_FACT_ShapeVisits]    AS stg;

        -- record number of records inserted
        SELECT @recordsInserted = @@ROWCOUNT;
        COMMIT TRANSACTION;
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
        
      END; -- @processPoint 3

      BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 5 AND ERROR_NUMBER() = 1205 -- DEADLOCK
        BEGIN
          EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
          IF @debugMode = 1  -- DebugMode is true
            BEGIN
              PRINT '5.error: deadlock occured, restarting merge';
              EXEC [Control].strProcProgressMonitor_Set
                @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
              SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
            END;
        END;
      ELSE
        BEGIN
          EXEC [Control].sprLogError @organisationKey = @organisationKey;
          RETURN -1;
          BREAK; -- out of while loop
        END;
    END CATCH;
  END -- While

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_ShapeVisits];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_SimpleScoreDaily_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_SimpleScoreDaily_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int    = 0;
  DECLARE @maxDuration         bigint = 2147483647; -- this is the max int data type value
  
  DECLARE @currentDate   datetimeoffset; -- used for validation
  DECLARE @flagStartTime datetimeoffset(0) = SYSUTCDATETIME();
  DECLARE @flagSeq       smallint = 1;

  SELECT @currentDate = SYSUTCDATETIME();

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_SimpleScoreDaily];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_SimpleScoreDaily];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY


    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_SimpleScoreDaily]') AND name = N'IX_STAGE_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey')
      DROP INDEX IX_STAGE_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey ON [StageUser1].[STAGE_FACT_SimpleScoreDaily];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_SimpleScoreDaily]') AND name = N'IX_ROLLBACK_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey')
      DROP INDEX IX_ROLLBACK_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey ON [StageUser1].[ROLLBACK_FACT_SimpleScoreDaily];

    -- insert changed records into STG
    ;WITH
      SimpleScoreChangedDates AS
      (
        SELECT
          VehicleKey,
          ActivityStartDateKey
        FROM
          [StageUser1].STAGE_FACT_SimpleScoreDetails
        GROUP BY
          VehicleKey,
          ActivityStartDateKey
      )
    INSERT INTO [StageUser1].[STAGE_FACT_SimpleScoreDaily]
    (
      [SnapShotDateKey]              ,
      [DriverKey]                    ,
      [VehicleKey]                   ,
      [DistanceTravelled]            ,
      [DrivingTime]                  ,
      [Duration]                     ,
      [MaxSpeed]                     ,
      [SpeedTime]                    ,
      [SpeedOccurs]                  ,
      [SpeedScoreByDuration]         ,
      [MaxBrake]                     ,
      [BrakeTime]                    ,
      [BrakeOccurs]                  ,
      [BrakeScoreByDuration]         ,
      [MaxAccel]                     ,
      [AccelTime]                    ,
      [AccelOccurs]                  ,
      [AccelScoreByDuration]         ,
      [MaxRPM]                       ,
      [RPMTime]                      ,
      [RPMOccurs]                    ,
      [RPMScoreByDuration]           ,
      [OutOfGreenBandTime]           ,
      [OutOfGreenBandScoreByDuration],
      [ExcessiveIdleOccurs]          ,
      [ExcessiveIdleTime]            ,
      [ExcessiveIdleScoreByDuration] ,
      [RoadSpeedTime]                ,
      [RoadSpeedOccurs]              ,
      [RoadSpeedScoreByDuration]
    )
    SELECT
      fsd.[ActivityStartDateKey]          ,
      fsd.[DriverKey]                     ,
      fsd.[VehicleKey]                    ,
      SUM([DistanceTravelled])            ,
      SUM([DrivingTime])                  ,
      CASE
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN -1
        ELSE SUM(CONVERT(BIGINT,[Duration]))
      END,
      MAX([MaxSpeed])                     ,
      SUM([SpeedTime])                    ,
      SUM([SpeedOccurs])                  ,
      CASE 
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([SpeedScore]          * Duration)
      END,
      MAX([MaxBrake])                     ,
      SUM([BrakeTime])                    ,
      SUM([BrakeOccurs])                  ,
      CASE 
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([BrakeScore]          * Duration)
      END,
      MAX([MaxAccel])                     ,
      SUM([AccelTime])                    ,
      SUM([AccelOccurs])                  ,
      CASE 
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([AccelScore]          * Duration)
      END,
      MAX([MaxRPM])                       ,
      SUM([RPMTime])                      ,
      SUM([RPMOccurs])                    ,
      CASE 
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([RPMScore]            * Duration)
      END,
      SUM([OutOfGreenBandTime])           ,
      CASE 
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([OutOfGreenBandScore] * Duration)
      END,
      SUM([ExcessiveIdleOccurs])          ,
      SUM([ExcessiveIdleTime])            ,
      CASE 
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([ExcessiveIdleScore]  * Duration)
      END,
      SUM([RoadSpeedTime]),
      SUM([RoadSpeedOccurs]),
      CASE
        WHEN ISNULL(SUM(CONVERT(BIGINT,Duration)),0) = 0
          THEN 0
        WHEN ABS(SUM(CONVERT(BIGINT,[Duration]))) > @maxDuration
          THEN NULL
        ELSE SUM([RoadSpeedScore]  * Duration)
      END
    FROM
      [MiXData].dbo.FACT_SimpleScoreDetails fsd WITH (NOLOCK)
        INNER JOIN
      SimpleScoreChangedDates                  ssc ON fsd.VehicleKey           = ssc.VehicleKey
                                                  AND fsd.ActivityStartDateKey = ssc.ActivityStartDateKey
    GROUP BY
      fsd.[ActivityStartDateKey]         ,
      fsd.[DriverKey]                    ,
      fsd.[VehicleKey];

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey
      ON [StageUser1].[STAGE_FACT_SimpleScoreDaily](VehicleKey,DriverKey,SnapShotDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;
  DECLARE @processPoint   int = 0;  -- what has already been done.
  WHILE @exceptionCount < 4
  BEGIN

    BEGIN TRY

      IF @processPoint < 1
      BEGIN
        BEGIN TRANSACTION;

        -- 5.1 Changed records
        INSERT INTO [StageUser1].[ROLLBACK_FACT_SimpleScoreDaily]
        ( 
          [SimpleScoreDailyKey]          ,
          [OrganisationKey]              ,
          [SnapShotDateKey]              ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScoreByDuration]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScoreByDuration]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScoreByDuration]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScoreByDuration]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScoreByDuration],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScoreByDuration] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScoreByDuration]     ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        )
        SELECT
          [SimpleScoreDailyKey]          ,
          [OrganisationKey]              ,
          [SnapShotDateKey]              ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScoreByDuration]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScoreByDuration]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScoreByDuration]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScoreByDuration]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScoreByDuration],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScoreByDuration] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScoreByDuration]     ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        FROM
         (UPDATE
            tar
          SET
            [DistanceTravelled]             = stg.[DistanceTravelled]            ,
            [DrivingTime]                   = stg.[DrivingTime]                  ,
            [Duration]                      = stg.[Duration]                     ,
            [MaxSpeed]                      = stg.[MaxSpeed]                     ,
            [SpeedTime]                     = stg.[SpeedTime]                    ,
            [SpeedOccurs]                   = stg.[SpeedOccurs]                  ,
            [SpeedScoreByDuration]          = stg.[SpeedScoreByDuration]         ,
            [MaxBrake]                      = stg.[MaxBrake]                     ,
            [BrakeTime]                     = stg.[BrakeTime]                    ,
            [BrakeOccurs]                   = stg.[BrakeOccurs]                  ,
            [BrakeScoreByDuration]          = stg.[BrakeScoreByDuration]         ,
            [MaxAccel]                      = stg.[MaxAccel]                     ,
            [AccelTime]                     = stg.[AccelTime]                    ,
            [AccelOccurs]                   = stg.[AccelOccurs]                  ,
            [AccelScoreByDuration]          = stg.[AccelScoreByDuration]         ,
            [MaxRPM]                        = stg.[MaxRPM]                       ,
            [RPMTime]                       = stg.[RPMTime]                      ,
            [RPMOccurs]                     = stg.[RPMOccurs]                    ,
            [RPMScoreByDuration]            = stg.[RPMScoreByDuration]           ,
            [OutOfGreenBandTime]            = stg.[OutOfGreenBandTime]           ,
            [OutOfGreenBandScoreByDuration] = stg.[OutOfGreenBandScoreByDuration],
            [ExcessiveIdleOccurs]           = stg.[ExcessiveIdleOccurs]          ,
            [ExcessiveIdleTime]             = stg.[ExcessiveIdleTime]            ,
            [ExcessiveIdleScoreByDuration]  = stg.[ExcessiveIdleScoreByDuration] ,
            [RoadSpeedTime]                 = ISNULL(stg.[RoadSpeedTime],0),
            [RoadSpeedOccurs]               = ISNULL(stg.[RoadSpeedOccurs],0),
            [RoadSpeedScoreByDuration]      = ISNULL(stg.[RoadSpeedScoreByDuration],0),
            [UpdateBatchKey]                = @batchKey
          OUTPUT
            DELETED.[SimpleScoreDailyKey]          ,
            DELETED.[OrganisationKey]              ,
            DELETED.[SnapShotDateKey]              ,
            DELETED.[DriverKey]                    ,
            DELETED.[VehicleKey]                   ,
            DELETED.[DistanceTravelled]            ,
            DELETED.[DrivingTime]                  ,
            DELETED.[Duration]                     ,
            DELETED.[MaxSpeed]                     ,
            DELETED.[SpeedTime]                    ,
            DELETED.[SpeedOccurs]                  ,
            DELETED.[SpeedScoreByDuration]         ,
            DELETED.[MaxBrake]                     ,
            DELETED.[BrakeTime]                    ,
            DELETED.[BrakeOccurs]                  ,
            DELETED.[BrakeScoreByDuration]         ,
            DELETED.[MaxAccel]                     ,
            DELETED.[AccelTime]                    ,
            DELETED.[AccelOccurs]                  ,
            DELETED.[AccelScoreByDuration]         ,
            DELETED.[MaxRPM]                       ,
            DELETED.[RPMTime]                      ,
            DELETED.[RPMOccurs]                    ,
            DELETED.[RPMScoreByDuration]           ,
            DELETED.[OutOfGreenBandTime]           ,
            DELETED.[OutOfGreenBandScoreByDuration],
            DELETED.[ExcessiveIdleOccurs]          ,
            DELETED.[ExcessiveIdleTime]            ,
            DELETED.[ExcessiveIdleScoreByDuration] ,
            DELETED.[RoadSpeedTime]                ,
            DELETED.[RoadSpeedOccurs]              ,
            DELETED.[RoadSpeedScoreByDuration]     ,
            0 AS IsDeleted                         ,
            DELETED.[CreateBatchKey]               ,
            DELETED.[UpdateBatchKey]
          FROM 
           [MiXData].dbo.FACT_SimpleScoreDaily    AS tar WITH (NOLOCK)
             INNER JOIN
           [StageUser1].[STAGE_FACT_SimpleScoreDaily] AS stg ON tar.VehicleKey      = stg.VehicleKey
                                                           AND tar.DriverKey       = stg.DriverKey
                                                           AND tar.SnapShotDateKey = stg.SnapShotDateKey
          ) AS upd;

        -- record number of records updated
        SELECT @recordsUpdated = @@ROWCOUNT;
        COMMIT TRANSACTION;
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
      END; -- @processPoint 1

      -- create rollback index
      IF NOT EXISTS(SELECT *
                    FROM sys.indexes 
                    WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_SimpleScoreDaily]') AND name = N'IX_ROLLBACK_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey')
        CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey
          ON [StageUser1].[ROLLBACK_FACT_SimpleScoreDaily](VehicleKey,DriverKey,SnapShotDateKey);

      -- 5.2 insert new records to FACT
      IF @processPoint < 2
      BEGIN
        BEGIN TRANSACTION;

        INSERT INTO [MiXData].dbo.FACT_SimpleScoreDaily
        ( 
          [OrganisationKey]              ,
          [SnapShotDateKey]              ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScoreByDuration]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScoreByDuration]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScoreByDuration]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScoreByDuration]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScoreByDuration],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScoreByDuration] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScoreByDuration]     ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        )
        SELECT
          @organisationKey               ,
          [SnapShotDateKey]              ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScoreByDuration]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScoreByDuration]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScoreByDuration]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScoreByDuration]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScoreByDuration],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScoreByDuration] ,
          ISNULL([RoadSpeedTime],0),
          ISNULL([RoadSpeedOccurs],0),
          ISNULL([RoadSpeedScoreByDuration],0),
          @batchKey                      ,
          @batchKey
        FROM
          [StageUser1].[STAGE_FACT_SimpleScoreDaily]    AS stg
        WHERE
          NOT EXISTS (SELECT 1
                      FROM
                        [StageUser1].[ROLLBACK_FACT_SimpleScoreDaily] AS roll WITH (NOLOCK)
                      WHERE
                          stg.VehicleKey      = roll.VehicleKey
                      AND stg.DriverKey       = roll.DriverKey
                      AND stg.SnapShotDateKey = roll.SnapShotDateKey);

        -- record number of records inserted
        SELECT @recordsInserted = @@ROWCOUNT;
        COMMIT TRANSACTION
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.1 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
      END; -- @processPoint 2

      -- 5.3: remove rollups where DriverKey not longer exists
        IF @processPoint < 3
          BEGIN
            BEGIN TRANSACTION;
            INSERT INTO [StageUser1].[ROLLBACK_FACT_SimpleScoreDaily]
            ( 
              [SimpleScoreDailyKey]          ,
              [OrganisationKey]              ,
              [SnapShotDateKey]              ,
              [DriverKey]                    ,
              [VehicleKey]                   ,
              [DistanceTravelled]            ,
              [DrivingTime]                  ,
              [Duration]                     ,
              [MaxSpeed]                     ,
              [SpeedTime]                    ,
              [SpeedOccurs]                  ,
              [SpeedScoreByDuration]         ,
              [MaxBrake]                     ,
              [BrakeTime]                    ,
              [BrakeOccurs]                  ,
              [BrakeScoreByDuration]         ,
              [MaxAccel]                     ,
              [AccelTime]                    ,
              [AccelOccurs]                  ,
              [AccelScoreByDuration]         ,
              [MaxRPM]                       ,
              [RPMTime]                      ,
              [RPMOccurs]                    ,
              [RPMScoreByDuration]           ,
              [OutOfGreenBandTime]           ,
              [OutOfGreenBandScoreByDuration],
              [ExcessiveIdleOccurs]          ,
              [ExcessiveIdleTime]            ,
              [ExcessiveIdleScoreByDuration] ,
              [RoadSpeedTime]                ,
              [RoadSpeedOccurs]              ,
              [RoadSpeedScoreByDuration]     ,
              [IsDeleted]                    ,
              [CreateBatchKey]               ,
              [UpdateBatchKey]
            )
            SELECT
              [SimpleScoreDailyKey]          ,
              [OrganisationKey]              ,
              [SnapShotDateKey]              ,
              [DriverKey]                    ,
              [VehicleKey]                   ,
              [DistanceTravelled]            ,
              [DrivingTime]                  ,
              [Duration]                     ,
              [MaxSpeed]                     ,
              [SpeedTime]                    ,
              [SpeedOccurs]                  ,
              [SpeedScoreByDuration]         ,
              [MaxBrake]                     ,
              [BrakeTime]                    ,
              [BrakeOccurs]                  ,
              [BrakeScoreByDuration]         ,
              [MaxAccel]                     ,
              [AccelTime]                    ,
              [AccelOccurs]                  ,
              [AccelScoreByDuration]         ,
              [MaxRPM]                       ,
              [RPMTime]                      ,
              [RPMOccurs]                    ,
              [RPMScoreByDuration]           ,
              [OutOfGreenBandTime]           ,
              [OutOfGreenBandScoreByDuration],
              [ExcessiveIdleOccurs]          ,
              [ExcessiveIdleTime]            ,
              [ExcessiveIdleScoreByDuration] ,
              ISNULL([RoadSpeedTime],0),
              ISNULL([RoadSpeedOccurs],0),
              ISNULL([RoadSpeedScoreByDuration],0),
              [IsDeleted]                    ,
              [CreateBatchKey]               ,
              [UpdateBatchKey]
            FROM
            (
              DELETE
                [MiXData].[dbo].FACT_SimpleScoreDaily
              OUTPUT
                DELETED.[SimpleScoreDailyKey]          ,
                DELETED.[OrganisationKey]              ,
                DELETED.[SnapShotDateKey]              ,
                DELETED.[DriverKey]                    ,
                DELETED.[VehicleKey]                   ,
                DELETED.[DistanceTravelled]            ,
                DELETED.[DrivingTime]                  ,
                DELETED.[Duration]                     ,
                DELETED.[MaxSpeed]                     ,
                DELETED.[SpeedTime]                    ,
                DELETED.[SpeedOccurs]                  ,
                DELETED.[SpeedScoreByDuration]         ,
                DELETED.[MaxBrake]                     ,
                DELETED.[BrakeTime]                    ,
                DELETED.[BrakeOccurs]                  ,
                DELETED.[BrakeScoreByDuration]         ,
                DELETED.[MaxAccel]                     ,
                DELETED.[AccelTime]                    ,
                DELETED.[AccelOccurs]                  ,
                DELETED.[AccelScoreByDuration]         ,
                DELETED.[MaxRPM]                       ,
                DELETED.[RPMTime]                      ,
                DELETED.[RPMOccurs]                    ,
                DELETED.[RPMScoreByDuration]           ,
                DELETED.[OutOfGreenBandTime]           ,
                DELETED.[OutOfGreenBandScoreByDuration],
                DELETED.[ExcessiveIdleOccurs]          ,
                DELETED.[ExcessiveIdleTime]            ,
                DELETED.[ExcessiveIdleScoreByDuration] ,
                DELETED.[RoadSpeedTime]                ,
                DELETED.[RoadSpeedOccurs]              ,
                DELETED.[RoadSpeedScoreByDuration]     ,
                1 AS IsDeleted                         ,
                DELETED.[CreateBatchKey]               ,
                DELETED.[UpdateBatchKey]
              FROM
                [MiXData].dbo.FACT_SimpleScoreDaily    AS tar WITH (NOLOCK)
                  INNER JOIN
                [StageUser1].[STAGE_FACT_SimpleScoreDaily] AS stg ON tar.VehicleKey      = stg.VehicleKey
                                                                 AND tar.SnapShotDateKey = stg.SnapShotDateKey
                                                                 -- no driver match!
                                                                 AND tar.UpdateBatchKey != @batchKey
            ) deleted
            SET @recordsDeleted = @@ROWCOUNT;
            COMMIT TRANSACTION
            SET @processPoint += 1;

            IF @debugMode = 1  -- DebugMode is true
              BEGIN
                EXEC [Control].strProcProgressMonitor_Set
                  @flag='5.2: remove rollups where DriverKey not longer exists', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
                PRINT '5.2: remove rollups where DriverKey not longer exists = ' + CAST(@recordsDeleted AS nvarchar);
                SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
              END;
          END; -- @processPoint 3
      
      BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 4 AND ERROR_NUMBER() = 1205 -- DEADLOCK
        BEGIN
          EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
          IF @debugMode = 1  -- DebugMode is true
            BEGIN
              PRINT '5.error: deadlock occured, restarting merge';
              EXEC [Control].strProcProgressMonitor_Set
                @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
              SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
            END;
        END;
      ELSE
        BEGIN
          EXEC [Control].sprLogError @organisationKey = @organisationKey;
          RETURN -1;
          BREAK; -- out of while loop
        END;
    END CATCH;
  END -- While
  
  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_SimpleScoreDaily];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_SimpleScoreDetails_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_SimpleScoreDetails_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;

  DECLARE @maxDurationYears int            = 68;               -- anything bigger than 68 causes overflow of int datatype
  DECLARE @currentDate      datetimeoffset = SYSUTCDATETIME(); -- used for validation
  DECLARE @flagStartTime datetimeoffset(0) = SYSUTCDATETIME();
  DECLARE @flagSeq       smallint = 1;

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_SimpleScoreDetails];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_SimpleScoreDetails];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
    SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY
  
      -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_SimpleScoreDetails]') AND name = N'IX_STAGE_FACT_SimpleScoreDetails_ActivitySummaryKey_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_SimpleScoreDetails_ActivitySummaryKey_HostID_Operation ON [StageUser1].[STAGE_FACT_SimpleScoreDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_SimpleScoreDetails]') AND name = N'IX_STAGE_FACT_SimpleScoreDetails_ActivityStartDateKey')
      DROP INDEX IX_STAGE_FACT_SimpleScoreDetails_ActivityStartDateKey ON [StageUser1].[STAGE_FACT_SimpleScoreDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_SimpleScoreDetails]') AND name = N'IX_STAGE_FACT_SimpleScoreDetails_ActivityDetailKey')
      DROP INDEX IX_STAGE_FACT_SimpleScoreDetails_ActivityDetailKey ON [StageUser1].[STAGE_FACT_SimpleScoreDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_SimpleScoreDetails]') AND name = N'IX_STAGE_FACT_SimpleScoreDetails_ScoreKeys')
      DROP INDEX IX_STAGE_FACT_SimpleScoreDetails_ScoreKeys ON [StageUser1].[STAGE_FACT_SimpleScoreDetails]

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_SimpleScoreDetails]') AND name = N'IX_ROLLBACK_FACT_SimpleScoreDetails_ActivityDetailKey')
      DROP INDEX IX_ROLLBACK_FACT_SimpleScoreDetails_ActivityDetailKey ON [StageUser1].[ROLLBACK_FACT_SimpleScoreDetails];

    -- create Source index
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser1].SubTripData') AND name = N'IX_SubTripData_TripID_Sequence')
      CREATE INDEX IX_SubTripData_TripID_Sequence ON [StageUser1].SubTripData
        (TripID,Sequence)
        INCLUDE(Operation);

  -- insert changed records into STG
  INSERT INTO [StageUser1].[STAGE_FACT_SimpleScoreDetails]
  (
    [Operation]           ,
    [TripID]              ,
    [ActivityDetailKey]   ,
    [ActivitySummaryKey]  ,
    [HostID]              ,
    [ActivityStartDateKey],
    [VehicleKey]          ,
    [DriverKey]
  )
  SELECT
    std.Operation           ,
    std.TripID              ,
    fad.ActivityDetailKey   ,
    fad.ActivitySummaryKey  ,
    fad.HostID              ,
    fad.ActivityStartDateKey,
    fad.VehicleKey          ,
    fad.DriverKey
  FROM
    [StageUser1].STAGE_FACT_ActivityDetails std
      INNER JOIN
    [MiXData].dbo.FACT_ActivityDetails  fad WITH (NOLOCK) ON fad.ActivityDetailKey = std.ActivityDetailKey;

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].SubTripData') AND name = N'IX_SubTripData_TripID_Sequence')
      DROP INDEX IX_SubTripData_TripID_Sequence ON [StageUser1].SubTripData;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create indexes to be used for lookups
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SimpleScoreDetails_ActivitySummaryKey_HostID_Operation 
      ON [StageUser1].[STAGE_FACT_SimpleScoreDetails](ActivitySummaryKey,HostID,Operation);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SimpleScoreDetails_ActivityStartDateKey
      ON [StageUser1].[STAGE_FACT_SimpleScoreDetails](ActivityStartDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    ------------------------------------------
    -- ActivityDetailKey
    --UPDATE
      --[StageUser1].[STAGE_FACT_SimpleScoreDetails]
    --SET
    --ActivityDetailKey = fad.ActivityDetailKey
    --FROM
      --[StageUser1].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        --INNER JOIN
      --[$(MiXData)].dbo.FACT_ActivityDetails        fad WITH (NOLOCK) ON stg.ActivitySummaryKey = fad.ActivitySummaryKey
                                                               --AND stg.HostID             = fad.HostID
                                                               --AND fad.OrganisationKey    = @organisationKey;

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SimpleScoreDetails_ActivityDetailKey
      ON [StageUser1].[STAGE_FACT_SimpleScoreDetails](ActivityDetailKey);

    ------------------------------------------
    -- SpeedScoreCiteriaKey
    UPDATE
      [StageUser1].[STAGE_FACT_SimpleScoreDetails]
    SET
      SpeedScoreCiteriaKey = dsc.[ScoreCriteriaKey]
    FROM
      [StageUser1].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_SimpleScoreCriteria  dsc WITH (NOLOCK)
    WHERE
        dsc.OrganisationKey        = @organisationKey
    AND stg.[ActivityStartDateKey] BETWEEN dsc.StartDateKey AND dsc.EndDateKey
    AND dsc.HostID                 = 1; -- Speed

    ------------------------------------------
    -- RPMScoreCiteriaKey
    UPDATE
      [StageUser1].[STAGE_FACT_SimpleScoreDetails]
    SET
      RPMScoreCiteriaKey = dsc.[ScoreCriteriaKey]
    FROM
      [StageUser1].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_SimpleScoreCriteria  dsc WITH (NOLOCK)
    WHERE
        dsc.OrganisationKey        = @organisationKey
    AND stg.[ActivityStartDateKey] BETWEEN dsc.StartDateKey AND dsc.EndDateKey
    AND dsc.HostID                 = 2; -- RPM

    ------------------------------------------
    -- BrakeScoreCiteriaKey
    UPDATE
      [StageUser1].[STAGE_FACT_SimpleScoreDetails]
    SET
      BrakeScoreCiteriaKey = dsc.[ScoreCriteriaKey]
    FROM
      [StageUser1].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_SimpleScoreCriteria  dsc WITH (NOLOCK)
    WHERE
        dsc.OrganisationKey        = @organisationKey
    AND stg.[ActivityStartDateKey] BETWEEN dsc.StartDateKey AND dsc.EndDateKey
    AND dsc.HostID                 = 3; -- Brake

    ------------------------------------------
    -- OutOfGreenbandScoreCiteriaKey
    UPDATE
      [StageUser1].[STAGE_FACT_SimpleScoreDetails]
    SET
      OutOfGreenbandScoreCiteriaKey = dsc.[ScoreCriteriaKey]
    FROM
      [StageUser1].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_SimpleScoreCriteria  dsc WITH (NOLOCK)
    WHERE
        dsc.OrganisationKey        = @organisationKey
    AND stg.[ActivityStartDateKey] BETWEEN dsc.StartDateKey AND dsc.EndDateKey
    AND dsc.HostID                 = 4; -- OutOfGreenband

    ------------------------------------------
    -- ExcessiveIdleScoreCiteriaKey
    UPDATE
      [StageUser1].[STAGE_FACT_SimpleScoreDetails]
    SET
      ExcessiveIdleScoreCiteriaKey = dsc.[ScoreCriteriaKey]
    FROM
      [StageUser1].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_SimpleScoreCriteria  dsc WITH (NOLOCK)
    WHERE
        dsc.OrganisationKey        = @organisationKey
    AND stg.[ActivityStartDateKey] BETWEEN dsc.StartDateKey AND dsc.EndDateKey
    AND dsc.HostID                 = 5; -- ExcessiveIdle

    ------------------------------------------
    -- AccelScoreCiteriaKey
    UPDATE
      [StageUser1].[STAGE_FACT_SimpleScoreDetails]
    SET
      AccelScoreCiteriaKey = dsc.[ScoreCriteriaKey]
    FROM
      [StageUser1].STAGE_FACT_SimpleScoreDetails stg WITH (NOLOCK)
        CROSS JOIN
      [MiXData].dbo.DIM_SimpleScoreCriteria  dsc WITH (NOLOCK)
    WHERE
        dsc.OrganisationKey        = @organisationKey
    AND stg.[ActivityStartDateKey] BETWEEN dsc.StartDateKey AND dsc.EndDateKey
    AND dsc.HostID                 = 7; -- Accel

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update Keys', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
      SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
    END;

    -- drop index on stage_fact_activitydetails
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Duration')
      DROP INDEX IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Duration ON [StageUser1].[STAGE_FACT_ActivityDetails];

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 3. Update calculated columns onto STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;
  DECLARE @processPoint   int = 0;  -- what has already been done.
  WHILE @exceptionCount < 5
  BEGIN

    BEGIN TRY

      -- 5.1 Add to RollBck table
      IF @processPoint < 1
      BEGIN
        BEGIN TRANSACTION;

        INSERT INTO [StageUser1].[ROLLBACK_FACT_SimpleScoreDetails]
        ( 
          [SimpleScoreKey]               ,
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        )
        SELECT
          [SimpleScoreKey]               ,
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        FROM
         (UPDATE
            tar
          SET
            [ActivityStartDateKey]           = stg.[ActivityStartDateKey]         ,
            [DriverKey]                      = stg.[DriverKey]                    ,
            [VehicleKey]                     = stg.[VehicleKey]                   ,
            [DistanceTravelled]              = std.TripDistance                   ,
            [DrivingTime]                    = CASE  
                                                 WHEN ABS(DATEDIFF(YEAR,std.Depart,std.Halt)) > @maxDurationYears -- if Duration is longer than 68 years than indicate with error value  
                                                   THEN -2                                                        -- value used for indication erronous value  
                                                 ELSE  
                                                   DATEDIFF(SECOND,std.Depart,std.Halt)  
                                               END, 
            [Duration]                       = CASE  
                                                 WHEN ABS(DATEDIFF(YEAR,std.Depart,std.Halt)) > @maxDurationYears   -- if Duration is longer than 68 years than indicate with error value  
                                                   THEN -2                                                 -- value used for indication erronous value  
                                                 ELSE  
                                                   ISNULL(DATEDIFF(SECOND,std.Depart,std.Halt),0) + ISNULL(std.StandingTime,0)  
                                               END,
            [MaxSpeed]                       = std.[MaxSpeed]                     ,
            [SpeedTime]                      = std.[SpeedTime]                    ,
            [SpeedOccurs]                    = std.[SpeedOccurs]                  ,
            [SpeedScore]                     = std.[SpeedScore]                   ,
            [SpeedScoreCiteriaKey]           = stg.[SpeedScoreCiteriaKey]         ,
            [MaxBrake]                       = std.[MaxBrake]                     ,
            [BrakeTime]                      = std.[BrakeTime]                    ,
            [BrakeOccurs]                    = std.[BrakeOccurs]                  ,
            [BrakeScore]                     = std.[BrakeScore]                   ,
            [BrakeScoreCiteriaKey]           = stg.[BrakeScoreCiteriaKey]         ,
            [MaxAccel]                       = std.[MaxAccel]                     ,
            [AccelTime]                      = std.[AccelTime]                    ,
            [AccelOccurs]                    = std.[AccelOccurs]                  ,
            [AccelScore]                     = std.[AccelScore]                   ,
            [AccelScoreCiteriaKey]           = stg.[AccelScoreCiteriaKey]         ,
            [MaxRPM]                         = std.[MaxRPM]                       ,
            [RPMTime]                        = std.[RPMTime]                      ,
            [RPMOccurs]                      = std.[RPMOccurs]                    ,
            [RPMScore]                       = std.[RPMScore]                     ,
            [RPMScoreCiteriaKey]             = stg.[RPMScoreCiteriaKey]           ,
            [OutOfGreenBandTime]             = std.GBTime                         ,
            [OutOfGreenBandScore]            = std.GBScore                        ,
            [OutOfGreenbandScoreCiteriaKey]  = stg.[OutOfGreenbandScoreCiteriaKey],
            [ExcessiveIdleOccurs]            = std.ExIdleOccurs                   ,
            [ExcessiveIdleTime]              = std.ExIdleTime                     ,
            [ExcessiveIdleScore]             = std.ExIdleScore                    ,
            [ExcessiveIdleScoreCiteriaKey]   = stg.[ExcessiveIdleScoreCiteriaKey] ,
            [RoadSpeedTime]                  = ISNULL(std.[RoadSpeedTime],0)      ,
            [RoadSpeedOccurs]                = ISNULL(std.[RoadSpeedOccurs],0)    ,
            [RoadSpeedScore]                 = ISNULL(std.[RoadSpeedScore],100.0) ,
            [IsDeleted]                      = 0                                  ,
            [UpdateBatchKey]                 = @batchKey
          OUTPUT
            DELETED.[SimpleScoreKey]               ,
            DELETED.[OrganisationKey]              ,
            DELETED.[ActivityDetailKey]            ,
            DELETED.[ActivityStartDateKey]         ,
            DELETED.[DriverKey]                    ,
            DELETED.[VehicleKey]                   ,
            DELETED.[DistanceTravelled]            ,
            DELETED.[DrivingTime]                  ,
            DELETED.[Duration]                     ,
            DELETED.[MaxSpeed]                     ,
            DELETED.[SpeedTime]                    ,
            DELETED.[SpeedOccurs]                  ,
            DELETED.[SpeedScore]                   ,
            DELETED.[SpeedScoreCiteriaKey]         ,
            DELETED.[MaxBrake]                     ,
            DELETED.[BrakeTime]                    ,
            DELETED.[BrakeOccurs]                  ,
            DELETED.[BrakeScore]                   ,
            DELETED.[BrakeScoreCiteriaKey]         ,
            DELETED.[MaxAccel]                     ,
            DELETED.[AccelTime]                    ,
            DELETED.[AccelOccurs]                  ,
            DELETED.[AccelScore]                   ,
            DELETED.[AccelScoreCiteriaKey]         ,
            DELETED.[MaxRPM]                       ,
            DELETED.[RPMTime]                      ,
            DELETED.[RPMOccurs]                    ,
            DELETED.[RPMScore]                     ,
            DELETED.[RPMScoreCiteriaKey]           ,
            DELETED.[OutOfGreenBandTime]           ,
            DELETED.[OutOfGreenBandScore]          ,
            DELETED.[OutOfGreenbandScoreCiteriaKey],
            DELETED.[ExcessiveIdleOccurs]          ,
            DELETED.[ExcessiveIdleTime]            ,
            DELETED.[ExcessiveIdleScore]           ,
            DELETED.[ExcessiveIdleScoreCiteriaKey] ,
            DELETED.[RoadSpeedTime]                ,
            DELETED.[RoadSpeedOccurs]              ,
            DELETED.[RoadSpeedScore]               ,
            DELETED.[IsDeleted]                    ,
            DELETED.[CreateBatchKey]               ,
            DELETED.[UpdateBatchKey]
          FROM
            [MiXData].dbo.FACT_SimpleScoreDetails    tar
              INNER JOIN
            [StageUser1].[STAGE_FACT_SimpleScoreDetails] stg ON tar.ActivityDetailKey = stg.ActivityDetailKey
                                                           AND tar.OrganisationKey   = @organisationKey
              INNER JOIN
            [StageUser1].[SubTripData]                   std ON std.TripID            = stg.TripID
                                                           AND std.Sequence          = stg.HostID
          WHERE stg.Operation in ('I','U')
          ) AS upd;

        -- record number of records updated
        SELECT @recordsUpdated = @@ROWCOUNT;
        COMMIT TRANSACTION;
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
      END; -- @processPoint 1

      -- 5.2 Deleted records
      IF @processPoint < 2
      BEGIN
        BEGIN TRANSACTION;
        
        INSERT INTO [StageUser1].[ROLLBACK_FACT_SimpleScoreDetails]
        ( 
          [SimpleScoreKey]               ,
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        )
        SELECT
          [SimpleScoreKey]               ,
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        FROM
         (UPDATE
            tar
          SET
            [IsDeleted]      = 1,
            [UpdateBatchKey] = @batchKey
          OUTPUT
            DELETED.[SimpleScoreKey]               ,
            DELETED.[OrganisationKey]              ,
            DELETED.[ActivityDetailKey]            ,
            DELETED.[ActivityStartDateKey]         ,
            DELETED.[DriverKey]                    ,
            DELETED.[VehicleKey]                   ,
            DELETED.[DistanceTravelled]            ,
            DELETED.[DrivingTime]                  ,
            DELETED.[Duration]                     ,
            DELETED.[MaxSpeed]                     ,
            DELETED.[SpeedTime]                    ,
            DELETED.[SpeedOccurs]                  ,
            DELETED.[SpeedScore]                   ,
            DELETED.[SpeedScoreCiteriaKey]         ,
            DELETED.[MaxBrake]                     ,
            DELETED.[BrakeTime]                    ,
            DELETED.[BrakeOccurs]                  ,
            DELETED.[BrakeScore]                   ,
            DELETED.[BrakeScoreCiteriaKey]         ,
            DELETED.[MaxAccel]                     ,
            DELETED.[AccelTime]                    ,
            DELETED.[AccelOccurs]                  ,
            DELETED.[AccelScore]                   ,
            DELETED.[AccelScoreCiteriaKey]         ,
            DELETED.[MaxRPM]                       ,
            DELETED.[RPMTime]                      ,
            DELETED.[RPMOccurs]                    ,
            DELETED.[RPMScore]                     ,
            DELETED.[RPMScoreCiteriaKey]           ,
            DELETED.[OutOfGreenBandTime]           ,
            DELETED.[OutOfGreenBandScore]          ,
            DELETED.[OutOfGreenbandScoreCiteriaKey],
            DELETED.[ExcessiveIdleOccurs]          ,
            DELETED.[ExcessiveIdleTime]            ,
            DELETED.[ExcessiveIdleScore]           ,
            DELETED.[ExcessiveIdleScoreCiteriaKey] ,
            DELETED.[RoadSpeedTime]                ,
            DELETED.[RoadSpeedOccurs]              ,
            DELETED.[RoadSpeedScore]               ,
            DELETED.[IsDeleted]                    ,
            DELETED.[CreateBatchKey]               ,
            DELETED.[UpdateBatchKey]
          FROM
            [MiXData].dbo.FACT_SimpleScoreDetails    tar
              INNER JOIN
            [StageUser1].[STAGE_FACT_SimpleScoreDetails] stg ON tar.ActivityDetailKey = stg.ActivityDetailKey
                                                           AND tar.OrganisationKey   = @organisationKey
          WHERE stg.Operation = 'D'
          ) AS del;

        -- record number of records deleted  
        SELECT @recordsDeleted = @@ROWCOUNT;  
        COMMIT TRANSACTION
        SET @processPoint += 1;
      
        IF @debugMode = 1  -- DebugMode is true  
        BEGIN  
          EXEC [Control].strProcProgressMonitor_Set  
            @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;  
      END; -- @processPoint 2

      -- create rollback index
      IF NOT EXISTS(SELECT *
                    FROM sys.indexes 
                    WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_SimpleScoreDetails]') AND name = N'IX_ROLLBACK_FACT_SimpleScoreDetails_ActivityDetailKey')
        CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_SimpleScoreDetails_ActivityDetailKey
          ON [StageUser1].[ROLLBACK_FACT_SimpleScoreDetails](ActivityDetailKey);

      -- 5.3 insert new records to FACT
      IF @processPoint < 3
      BEGIN
        BEGIN TRANSACTION;

        INSERT INTO [MiXData].dbo.[FACT_SimpleScoreDetails]
        ( 
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        )
        SELECT
          @organisationKey                   ,
          stg.[ActivityDetailKey]            ,
          stg.[ActivityStartDateKey]         ,
          stg.[DriverKey]                    ,
          stg.[VehicleKey]                   ,
          std.TripDistance                   ,
          [DrivingTime]                      = CASE  
                                                 WHEN ABS(DATEDIFF(YEAR,std.Depart,std.Halt)) > @maxDurationYears -- if Duration is longer than 68 years than indicate with error value  
                                                   THEN -2                                                        -- value used for indication erronous value  
                                                 ELSE  
                                                   DATEDIFF(SECOND,std.Depart,std.Halt)  
                                               END, 
          [Duration]                         = CASE  
                                                 WHEN ABS(DATEDIFF(YEAR,std.Depart,std.Halt)) > @maxDurationYears   -- if Duration is longer than 68 years than indicate with error value  
                                                   THEN -2                                                          -- value used for indication erronous value  
                                                 ELSE  
                                                   ISNULL(DATEDIFF(SECOND,std.Depart,std.Halt),0) + ISNULL(std.StandingTime,0)  
                                               END,
          std.[MaxSpeed]                     ,
          std.[SpeedTime]                    ,
          std.[SpeedOccurs]                  ,
          std.[SpeedScore]                   ,
          stg.[SpeedScoreCiteriaKey]         ,
          std.[MaxBrake]                     ,
          std.[BrakeTime]                    ,
          std.[BrakeOccurs]                  ,
          std.[BrakeScore]                   ,
          stg.[BrakeScoreCiteriaKey]         ,
          std.[MaxAccel]                     ,
          std.[AccelTime]                    ,
          std.[AccelOccurs]                  ,
          std.[AccelScore]                   ,
          stg.[AccelScoreCiteriaKey]         ,
          std.[MaxRPM]                       ,
          std.[RPMTime]                      ,
          std.[RPMOccurs]                    ,
          std.[RPMScore]                     ,
          stg.[RPMScoreCiteriaKey]           ,
          std.GBTime                         ,
          std.GBScore                        ,
          stg.[OutOfGreenbandScoreCiteriaKey],
          std.ExIdleOccurs                   ,
          std.ExIdleTime                     ,
          std.ExIdleScore                    ,
          stg.[ExcessiveIdleScoreCiteriaKey] ,
          ISNULL(std.[RoadSpeedTime],0)      ,
          ISNULL(std.[RoadSpeedOccurs],0)    ,
          ISNULL(std.[RoadSpeedScore],100.0) ,
          0                                  , -- IsDeleted
          @batchKey                          ,
          @batchKey
        FROM
          [StageUser1].[STAGE_FACT_SimpleScoreDetails] stg
            INNER JOIN  -- select * from
          [StageUser1].SubTripData                     std ON std.TripID             = stg.TripID
                                                         AND std.Sequence           = stg.HostID
        WHERE
            stg.Operation IN ('I','U')
        AND NOT EXISTS (SELECT 1
                        FROM
                          [StageUser1].[ROLLBACK_FACT_SimpleScoreDetails] AS roll
                        WHERE
                          stg.ActivityDetailKey = roll.ActivityDetailKey);

        -- record number of records inserted
        SELECT @recordsInserted = @@ROWCOUNT;
        COMMIT TRANSACTION;
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
      
      END; -- @processPoint 3

      -- 5.4 Update DriverKey,VehicleKey updates
      IF @processPoint < 4
      BEGIN
        BEGIN TRANSACTION;

        INSERT INTO [StageUser1].[ROLLBACK_FACT_SimpleScoreDetails]
        ( 
          [SimpleScoreKey]               ,
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        )
        SELECT
          [SimpleScoreKey]               ,
          [OrganisationKey]              ,
          [ActivityDetailKey]            ,
          [ActivityStartDateKey]         ,
          [DriverKey]                    ,
          [VehicleKey]                   ,
          [DistanceTravelled]            ,
          [DrivingTime]                  ,
          [Duration]                     ,
          [MaxSpeed]                     ,
          [SpeedTime]                    ,
          [SpeedOccurs]                  ,
          [SpeedScore]                   ,
          [SpeedScoreCiteriaKey]         ,
          [MaxBrake]                     ,
          [BrakeTime]                    ,
          [BrakeOccurs]                  ,
          [BrakeScore]                   ,
          [BrakeScoreCiteriaKey]         ,
          [MaxAccel]                     ,
          [AccelTime]                    ,
          [AccelOccurs]                  ,
          [AccelScore]                   ,
          [AccelScoreCiteriaKey]         ,
          [MaxRPM]                       ,
          [RPMTime]                      ,
          [RPMOccurs]                    ,
          [RPMScore]                     ,
          [RPMScoreCiteriaKey]           ,
          [OutOfGreenBandTime]           ,
          [OutOfGreenBandScore]          ,
          [OutOfGreenbandScoreCiteriaKey],
          [ExcessiveIdleOccurs]          ,
          [ExcessiveIdleTime]            ,
          [ExcessiveIdleScore]           ,
          [ExcessiveIdleScoreCiteriaKey] ,
          [RoadSpeedTime]                ,
          [RoadSpeedOccurs]              ,
          [RoadSpeedScore]               ,
          [IsDeleted]                    ,
          [CreateBatchKey]               ,
          [UpdateBatchKey]
        FROM
         (UPDATE
            tar
          SET
            [ActivityStartDateKey]           = stg.[ActivityStartDateKey]         ,
            [DriverKey]                      = stg.[DriverKey]                    ,
            [VehicleKey]                     = stg.[VehicleKey]                   ,
            [UpdateBatchKey]                 = @batchKey
          OUTPUT
            DELETED.[SimpleScoreKey]               ,
            DELETED.[OrganisationKey]              ,
            DELETED.[ActivityDetailKey]            ,
            DELETED.[ActivityStartDateKey]         ,
            DELETED.[DriverKey]                    ,
            DELETED.[VehicleKey]                   ,
            DELETED.[DistanceTravelled]            ,
            DELETED.[DrivingTime]                  ,
            DELETED.[Duration]                     ,
            DELETED.[MaxSpeed]                     ,
            DELETED.[SpeedTime]                    ,
            DELETED.[SpeedOccurs]                  ,
            DELETED.[SpeedScore]                   ,
            DELETED.[SpeedScoreCiteriaKey]         ,
            DELETED.[MaxBrake]                     ,
            DELETED.[BrakeTime]                    ,
            DELETED.[BrakeOccurs]                  ,
            DELETED.[BrakeScore]                   ,
            DELETED.[BrakeScoreCiteriaKey]         ,
            DELETED.[MaxAccel]                     ,
            DELETED.[AccelTime]                    ,
            DELETED.[AccelOccurs]                  ,
            DELETED.[AccelScore]                   ,
            DELETED.[AccelScoreCiteriaKey]         ,
            DELETED.[MaxRPM]                       ,
            DELETED.[RPMTime]                      ,
            DELETED.[RPMOccurs]                    ,
            DELETED.[RPMScore]                     ,
            DELETED.[RPMScoreCiteriaKey]           ,
            DELETED.[OutOfGreenBandTime]           ,
            DELETED.[OutOfGreenBandScore]          ,
            DELETED.[OutOfGreenbandScoreCiteriaKey],
            DELETED.[ExcessiveIdleOccurs]          ,
            DELETED.[ExcessiveIdleTime]            ,
            DELETED.[ExcessiveIdleScore]           ,
            DELETED.[ExcessiveIdleScoreCiteriaKey] ,
            DELETED.[RoadSpeedTime]                ,
            DELETED.[RoadSpeedOccurs]              ,
            DELETED.[RoadSpeedScore]               ,
            DELETED.[IsDeleted]                    ,
            DELETED.[CreateBatchKey]               ,
            DELETED.[UpdateBatchKey]
          FROM
            [MiXData].dbo.FACT_SimpleScoreDetails    tar
              INNER JOIN
            [StageUser1].[STAGE_FACT_SimpleScoreDetails] stg ON tar.ActivityDetailKey = stg.ActivityDetailKey
                                                           AND tar.OrganisationKey   = @organisationKey
          WHERE NOT EXISTS (SELECT 1 FROM [StageUser1].[ROLLBACK_FACT_SimpleScoreDetails] roll
                            WHERE roll.ActivityDetailKey = stg.ActivityDetailKey)
          ) AS upd;

        -- record number of records updated
        SELECT @recordsUpdated = @@ROWCOUNT;
        COMMIT TRANSACTION;
        SET @processPoint += 1;

        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.4 Merge Updated Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
          SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
        END;
      END; -- @processPoint 4

      BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 5 AND ERROR_NUMBER() = 1205 -- DEADLOCK
        BEGIN
          EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
          IF @debugMode = 1  -- DebugMode is true
            BEGIN
              PRINT '5.error: deadlock occured, restarting merge';
              EXEC [Control].strProcProgressMonitor_Set
                @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
              SELECT @flagStartTime = SYSUTCDATETIME(), @flagSeq = @flagSeq + 1;
            END;
        END;
      ELSE
        BEGIN
          EXEC [Control].sprLogError @organisationKey = @organisationKey;
          RETURN -1;
          BREAK; -- out of while loop
        END;
    END CATCH;
  END -- While

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_SimpleScoreDetails];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected, @flagStartTime = @flagStartTime, @flagSeq = @flagSeq;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_SiteSnapshotDaily_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_SiteSnapshotDaily_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;
  DECLARE @maxDuration         bigint = 2147483647; -- this is the max int data type value
  
  DECLARE	@currentDate     datetimeoffset; -- used for validation

  SELECT @currentDate = SYSUTCDATETIME();

  CREATE TABLE #ActivityChangedDates
  (
    VehicleSiteKey       INT,
    ActivityStartDateKey DATE
  );

  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_SiteSnapshotDaily];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_SiteSnapshotDaily];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY


    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_SiteSnapshotDaily]') AND name = N'IX_STAGE_FACT_SiteSnapshotDaily_VehicleSiteKey_SnapShotDateKey')
      DROP INDEX IX_STAGE_FACT_SiteSnapshotDaily_VehicleSiteKey_SnapShotDateKey ON [StageUser1].[STAGE_FACT_SiteSnapshotDaily];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_SiteSnapshotDaily]') AND name = N'IX_ROLLBACK_FACT_SiteSnapshotDaily_SnapShotDateKey_VehicleSiteKey')
      DROP INDEX IX_ROLLBACK_FACT_SiteSnapshotDaily_SnapShotDateKey_VehicleSiteKey ON [StageUser1].[ROLLBACK_FACT_SiteSnapshotDaily];

    -- create STAGE indexes
    IF NOT EXISTS(SELECT *
                  FROM sys.indexes 
                  WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_ActivityDetails]') AND name = N'IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey_VehicleSiteKey')
      CREATE INDEX IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey_VehicleSiteKey
        ON [StageUser1].STAGE_FACT_ActivityDetails (ActivityStartDateKey,VehicleSiteKey);

    -- insert changed records into STG
    INSERT INTO #ActivityChangedDates
    ( ActivityStartDateKey,VehicleSiteKey )
    SELECT
      ActivityStartDateKey,
      VehicleSiteKey
    FROM
      [StageUser1].STAGE_FACT_ActivityDetails
    GROUP BY
      ActivityStartDateKey,
      VehicleSiteKey;
    
    CREATE CLUSTERED INDEX IX_ActivityChangedDates ON #ActivityChangedDates(VehicleSiteKey,ActivityStartDateKey);

    INSERT INTO [StageUser1].[STAGE_FACT_SiteSnapshotDaily]
    (
      SnapShotDateKey   ,
      VehicleSiteKey    ,
      UTCOffsetKey      ,

      VehiclesWithTrips ,
      DriversWithTrips  ,
      NumberOfTrips     ,
      NumberOfKMs       ,
      NumberOfHours     ,
      FuelUsedMeasured  ,
      FuelUsedCalculated,
      TotalIdlingTime
    )
    SELECT
      fad.ActivityStartDateKey  ,
      fad.VehicleSiteKey        ,
      fad.UTCOffsetKey          ,

      COUNT(DISTINCT fad.VehicleKey),
      COUNT(DISTINCT fad.DriverKey) ,
      COUNT(1)                      ,
      SUM(fad.DistanceTravelled)    ,
      CASE WHEN ABS(SUM(CONVERT(BIGINT,fad.DrivingTime))) > @maxDuration THEN -2 ELSE SUM(CONVERT(BIGINT,fad.DrivingTime)) END,

      CASE WHEN SUM(FuelUsedMeasured)   > 99999.0 THEN 99999.0 ELSE SUM(FuelUsedMeasured)   END,
      CASE WHEN SUM(FuelUsedCalculated) > 99999.0 THEN 99999.0 ELSE SUM(FuelUsedCalculated) END,

      CASE WHEN ABS(SUM(CONVERT(BIGINT,fad.IdleTime)))    > @maxDuration THEN -2 ELSE SUM(CONVERT(BIGINT,fad.IdleTime))    END
	  FROM
	    [MiXData].dbo.FACT_ActivityDetails fad WITH (NOLOCK)
	      INNER JOIN
	    #ActivityChangedDates                  ac ON fad.OrganisationKey      = @organisationKey
	                                            AND fad.ActivityStartDateKey = ac.ActivityStartDateKey
	                                            AND fad.VehicleSiteKey       = ac.VehicleSiteKey
	  GROUP BY
      fad.ActivityStartDateKey,
      fad.VehicleSiteKey      ,
      fad.UTCOffsetKey;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_SiteSnapshotDaily_VehicleSiteKey_SnapShotDateKey
      ON [StageUser1].[STAGE_FACT_SiteSnapshotDaily](VehicleSiteKey,SnapShotDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
    END;

    ------------------------------------------
    -- NumberOfCollisions
    UPDATE stg
    SET NumberOfCollisions = (SELECT COUNT(* )
                              FROM [MiXData].dbo.DIM_Sites ds WITH (NOLOCK)
                                     INNER JOIN
                                   [MiXData].dbo.DIM_Vehicles          dvh WITH (NOLOCK) ON ds.SiteGUID         = dvh.SiteGUID
                                                                                        AND ds.OrganisationKey  = @organisationKey
                                     INNER JOIN
                                   [MiXData].dbo.DIM_EventDescriptions ded WITH (NOLOCK) ON ded.OrganisationKey = ds.OrganisationKey
                                                                                        AND ded.HostID BETWEEN 49 AND 50
                                     INNER JOIN
                                   [MiXData].dbo.FACT_EventDetails     fed WITH (NOLOCK) ON ded.EventDescriptionKey = fed.EventDescriptionKey
                                                                                        AND dvh.VehicleKey          = fed.VehicleKey
                              WHERE  
                                  ds.SiteKey            = stg.VehicleSiteKey
                              AND fed.EventStartDateKey = stg.SnapShotDateKey)
    FROM [StageUser1].STAGE_FACT_SiteSnapshotDaily stg;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update NumberOfCollisions', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

    ------------------------------------------
    -- NumberOfActiveVehicles/NumberOfActiveDrivers
    UPDATE [StageUser1].STAGE_FACT_SiteSnapshotDaily
    SET
      NumberOfActiveVehicles = (SELECT COUNT(DISTINCT dvh.VehicleKey)
                                FROM 
                                  [MiXData].dbo.DIM_Vehicles dvh WITH (NOLOCK)
                                    INNER JOIN
                                  [MiXData].dbo.DIM_Sites    ds  WITH (NOLOCK) ON dvh.OrganisationKey = @organisationKey
                                                                                 AND dvh.SiteGUID        = ds.SiteGUID
                                WHERE 
                                    dvh.IsActive        = 1
                                AND stg.VehicleSiteKey  = ds.SiteKey
                                AND stg.SnapShotDateKey BETWEEN dvh.StartDateKey AND dvh.EndDateKey),
      NumberOfActiveDrivers  = (SELECT COUNT(DISTINCT dd.DriverKey)
                                FROM 
                                  [MiXData].dbo.DIM_Drivers dd WITH (NOLOCK)
                                    INNER JOIN
                                  [MiXData].dbo.DIM_Sites   ds WITH (NOLOCK) ON dd.OrganisationKey = @organisationKey
                                                                               AND dd.SiteGUID        = ds.SiteGUID
                                WHERE 
                                    dd.IsActive         = 1
                                AND stg.VehicleSiteKey  = ds.SiteKey
                                AND stg.SnapShotDateKey BETWEEN dd.StartDateKey AND dd.EndDateKey)
    FROM
      [StageUser1].STAGE_FACT_SiteSnapshotDaily stg;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3 Update NumberOfActiveVehicles/NumberOfActiveDrivers', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    ------------------------------------------
    -- VehicleUtilization/DriverUtilization
    UPDATE [StageUser1].STAGE_FACT_SiteSnapshotDaily
    SET
      VehicleUtilization = CASE
                             WHEN NumberOfActiveVehicles > 0
                               THEN VehiclesWithTrips/CONVERT(FLOAT,NumberOfActiveVehicles)
                             ELSE 0.0
                           END,
      DriverUtilization  =  CASE
                             WHEN NumberOfActiveDrivers  > 0
                               THEN VehiclesWithTrips/CONVERT(FLOAT,NumberOfActiveDrivers)
                             ELSE 0.0
                           END;

    SELECT @nrOfrecordsAffected = @@ROWCOUNT;
    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.4 Update VehicleUtilization/DriverUtilization', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfrecordsAffected;
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Changed records
    INSERT INTO [StageUser1].[ROLLBACK_FACT_SiteSnapshotDaily]
    ( 
      SiteSnapShotKey   ,
      OrganisationKey   ,
      SnapShotDateKey   ,
      VehicleSiteKey    ,
      VehiclesWithTrips ,
      DriversWithTrips  ,
      NumberOfTrips     ,
      NumberOfCollisions ,
      NumberOfKMs       ,
      NumberOfHours     ,
      FuelUsedMeasured  ,
      FuelUsedCalculated,
      TotalIdlingTime   ,
      NumberOfActiveVehicles,
      NumberOfActiveDrivers, 
      VehicleUtilization,    
      DriverUtilization ,    
      UTCOffsetKey      ,
      IsDeleted         ,
      CreateBatchKey    ,
      UpdateBatchKey
    )
    SELECT
      SiteSnapShotKey   ,
      OrganisationKey   ,
      SnapShotDateKey   ,
      VehicleSiteKey    ,
      VehiclesWithTrips ,
      DriversWithTrips  ,
      NumberOfTrips     ,
      NumberOfCollisions ,
      NumberOfKMs       ,
      NumberOfHours     ,
      FuelUsedMeasured  ,
      FuelUsedCalculated,
      TotalIdlingTime   ,
      NumberOfActiveVehicles,
      NumberOfActiveDrivers,
      VehicleUtilization,    
      DriverUtilization ,    
      UTCOffsetKey      ,
      IsDeleted         ,
      CreateBatchKey    ,
      UpdateBatchKey
    FROM
     (UPDATE
        tar
      SET
        VehiclesWithTrips      = stg.VehiclesWithTrips ,
        DriversWithTrips       = stg.DriversWithTrips  ,
        NumberOfTrips          = stg.NumberOfTrips     ,
        NumberOfCollisions     = ISNULL(stg.NumberOfCollisions,0),
        NumberOfKMs            = stg.NumberOfKMs       ,
        NumberOfHours          = stg.NumberOfHours     ,
        FuelUsedMeasured       = stg.FuelUsedMeasured  ,
        FuelUsedCalculated     = stg.FuelUsedCalculated,
        TotalIdlingTime        = stg.TotalIdlingTime   ,
        NumberOfActiveVehicles = ISNULL(stg.NumberOfActiveVehicles,0),
        NumberOfActiveDrivers  = ISNULL(stg.NumberOfActiveDrivers,0),
        VehicleUtilization     = stg.VehicleUtilization,
        DriverUtilization      = stg.DriverUtilization,
        UTCOffsetKey           = stg.UTCOffsetKey      ,
        UpdateBatchKey         = @batchKey
      OUTPUT
        DELETED.SiteSnapShotKey   ,
        DELETED.OrganisationKey   ,
        DELETED.SnapShotDateKey   ,
        DELETED.VehicleSiteKey    ,
        DELETED.VehiclesWithTrips ,
        DELETED.DriversWithTrips  ,
        DELETED.NumberOfTrips     ,
        DELETED.NumberOfCollisions ,
        DELETED.NumberOfKMs       ,
        DELETED.NumberOfHours     ,
        DELETED.FuelUsedMeasured  ,
        DELETED.FuelUsedCalculated,
        DELETED.TotalIdlingTime   ,
        DELETED.NumberOfActiveVehicles,
        DELETED.NumberOfActiveDrivers, 
        DELETED.VehicleUtilization,    
        DELETED.DriverUtilization ,    
        DELETED.UTCOffsetKey      ,
        0 AS IsDeleted            ,
        DELETED.CreateBatchKey    ,
        DELETED.UpdateBatchKey
      FROM 
       [MiXData].dbo.FACT_SiteSnapshotDaily    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser1].[STAGE_FACT_SiteSnapshotDaily] AS stg ON tar.OrganisationKey = @organisationKey
                                                       AND tar.SnapShotDateKey = stg.SnapShotDateKey
                                                       AND tar.VehicleSiteKey  = stg.VehicleSiteKey
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_SiteSnapshotDaily_SnapShotDateKey_VehicleSiteKey
      ON [StageUser1].[ROLLBACK_FACT_SiteSnapshotDaily](SnapShotDateKey,VehicleSiteKey);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_SiteSnapshotDaily
    ( 
      OrganisationKey   ,
      SnapShotDateKey   ,
      VehicleSiteKey    ,
      VehiclesWithTrips ,
      DriversWithTrips  ,
      NumberOfTrips     ,
      NumberOfCollisions ,
      NumberOfKMs       ,
      NumberOfHours     ,
      FuelUsedMeasured  ,
      FuelUsedCalculated,
      TotalIdlingTime   ,
      NumberOfActiveVehicles,
      NumberOfActiveDrivers, 
      VehicleUtilization,    
      DriverUtilization ,    
      UTCOffsetKey      ,
      CreateBatchKey    ,
      UpdateBatchKey
    )
    SELECT
      @organisationKey  ,
      SnapShotDateKey   ,
      VehicleSiteKey    ,
      VehiclesWithTrips ,
      DriversWithTrips  ,
      NumberOfTrips     ,
      ISNULL(NumberOfCollisions,0),
      NumberOfKMs       ,
      NumberOfHours     ,
      FuelUsedMeasured  ,
      FuelUsedCalculated,
      TotalIdlingTime   ,
      ISNULL(NumberOfActiveVehicles,0),
      ISNULL(NumberOfActiveDrivers,0),
      VehicleUtilization,    
      DriverUtilization ,    
      UTCOffsetKey      ,
      @batchKey         ,
      @batchKey
    FROM
      [StageUser1].[STAGE_FACT_SiteSnapshotDaily]    AS stg
    WHERE
      NOT EXISTS (SELECT 1
                  FROM
                    [StageUser1].[ROLLBACK_FACT_SiteSnapshotDaily] AS roll WITH (NOLOCK)
                  WHERE
                      stg.SnapShotDateKey = roll.SnapShotDateKey
                  AND stg.VehicleSiteKey  = roll.VehicleSiteKey);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.2 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_SiteSnapshotDaily];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = 0;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_TachoData_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_TachoData_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE	@currentDate        datetimeoffset; -- used for validation

  SELECT @currentDate = SYSUTCDATETIME();
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_TachoData];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_TachoData];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_TachoData]') AND name = N'IX_STAGE_FACT_TachoData_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_TachoData_HostID_Operation ON [StageUser1].[STAGE_FACT_TachoData];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_TachoData]') AND name = N'IX_STAGE_FACT_TachoData_VehicleID_TachoStartDateKey')
      DROP INDEX IX_STAGE_FACT_TachoData_VehicleID_TachoStartDateKey ON [StageUser1].[STAGE_FACT_TachoData];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_TachoData]') AND name = N'IX_ROLLBACK_FACT_TachoData_HostID')
      DROP INDEX IX_ROLLBACK_FACT_TachoData_HostID ON [StageUser1].[ROLLBACK_FACT_TachoData];
  
    -- insert changed records into STG
	  INSERT INTO [StageUser1].[STAGE_FACT_TachoData]
	  ( [Operation]         ,
      [HostID]            ,
      [BlockSequence]     ,
      [VehicleID]         ,
      [TachoStartDateKey] ,
      [TachoEndDateKey]   ,
      [TachoStartDateTime],
      [TachoEndDateTime]  ,
      [RawData]           ,
      [UTCOffsetKey]
	  )
	  SELECT
	    s.Operation              ,
      HostID = s.RID           ,
      s.BlockSequence          ,
      s.VehicleID              ,
      CONVERT(DATE,s.StartDate),
      CONVERT(DATE,s.EndDate)  ,
      CASE 
        WHEN s.StartDate IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.StartDate,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      CASE 
        WHEN s.EndDate IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.EndDate,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      s.RawData                ,
      utc.UTCOffsetKey
	  FROM
	    [StageUser1].TachoData                  s   WITH (NOLOCK)
	      CROSS JOIN
	    [StageUser1].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
	  WHERE
        ISNULL(CONVERT(DATETIMEOFFSET(0),s.StartDate),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.StartDate),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- create indexes required for lookups
    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_TachoData_HostID_Operation 
      ON [StageUser1].[STAGE_FACT_TachoData](HostID,Operation);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_TachoData_VehicleID_TachoStartDateKey
      ON [StageUser1].[STAGE_FACT_TachoData](VehicleID,TachoStartDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
    END;

    ------------------------------------------
    -- VehicleKey
    UPDATE
      [StageUser1].[STAGE_FACT_TachoData]
    SET
      VehicleKey = dv.[VehicleKey]
    FROM
      [StageUser1].[STAGE_FACT_TachoData] stg
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles      dv  WITH (NOLOCK)
        ON  dv.OrganisationKey = @organisationKey
        AND stg.VehicleID      = dv.HostID
    WHERE
      stg.TachoStartDateKey BETWEEN dv.StartDateKey AND dv.EndDateKey;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update VehicleKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    ------------------------------------------
    -- UTCOffsetKey (use company UTC for now, will change in future)
/*    
    UPDATE [StageUser1].[STAGE_FACT_TachoData]
    SET
      UTCOffsetKey = utc.UTCOffsetKey
    FROM
      [StageUser1].[STAGE_FACT_TachoData] stg,
      [StageUser1].STAGE_DIM_UTCOffsetsLookUp utc WITH (NOLOCK)
    WHERE
        stg.TachoStartDateKey BETWEEN utc.StartDateKey    AND utc.EndDateKey
    AND stg.TachoStartDateKey BETWEEN utc.SeasonStartDate AND utc.SeasonEndDate;
*/

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Changed records
    INSERT INTO [StageUser1].[ROLLBACK_FACT_TachoData]
    ( 
      [TachoDataKey]      ,
      [HostID]            ,
      [OrganisationKey]   ,
      [BlockSequence]     ,
      [VehicleKey]        ,
      [TachoStartDateKey] ,
      [TachoEndDateKey]   ,
      [TachoStartDateTime],
      [TachoEndDateTime]  ,
      [RawData]           ,
      [MaxSpeed]          ,
      [MinSpeed]          ,
      [AvgSpeed]          ,
      [UTCOffsetKey]      ,
      [IsDeleted]         ,
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    )
    SELECT
      [TachoDataKey]      ,
      [HostID]            ,
      [OrganisationKey]   ,
      [BlockSequence]     ,
      [VehicleKey]        ,
      [TachoStartDateKey] ,
      [TachoEndDateKey]   ,
      [TachoStartDateTime],
      [TachoEndDateTime]  ,
      [RawData]           ,
      [MaxSpeed]          ,
      [MinSpeed]          ,
      [AvgSpeed]          ,
      [UTCOffsetKey]      ,
      [IsDeleted]         ,
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [VehicleKey]         = ISNULL(stg.[VehicleKey]        ,-1),
        [BlockSequence]      = stg.[BlockSequence]     ,
        [TachoStartDateKey]  = stg.[TachoStartDateKey] ,
        [TachoEndDateKey]    = stg.[TachoEndDateKey]   ,
        [TachoStartDateTime] = stg.[TachoStartDateTime],
        [TachoEndDateTime]   = stg.[TachoEndDateTime]  ,
        [RawData]            = stg.[RawData]           ,
        [MaxSpeed]           = stg.[MaxSpeed]          ,
        [MinSpeed]           = stg.[MinSpeed]          ,
        [AvgSpeed]           = stg.[AvgSpeed]          ,
        [UTCOffsetKey]       = stg.[UTCOffsetKey]      ,
        [IsDeleted]          = 0                       ,
        [UpdateBatchKey]     = @batchKey
      OUTPUT
        DELETED.[TachoDataKey]      ,
        DELETED.[HostID]            ,
        DELETED.[OrganisationKey]   ,
        DELETED.[BlockSequence]     ,
        DELETED.[VehicleKey]        ,
        DELETED.[TachoStartDateKey] ,
        DELETED.[TachoEndDateKey]   ,
        DELETED.[TachoStartDateTime],
        DELETED.[TachoEndDateTime]  ,
        DELETED.[RawData]           ,
        DELETED.[MaxSpeed]          ,
        DELETED.[MinSpeed]          ,
        DELETED.[AvgSpeed]          ,
        DELETED.[UTCOffsetKey]      ,
        DELETED.[IsDeleted]         ,
        DELETED.[CreateBatchKey]    ,
        DELETED.[UpdateBatchKey]
      FROM 
       [MiXData].dbo.FACT_TachoData    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser1].[STAGE_FACT_TachoData] AS stg ON tar.HostID          = stg.HostID
                                                AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation in ('I','U')
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    -- Deleted records
    INSERT INTO [StageUser1].[ROLLBACK_FACT_TachoData]
    ( 
      [TachoDataKey]      ,
      [HostID]            ,
      [OrganisationKey]   ,
      [BlockSequence]     ,
      [VehicleKey]        ,
      [TachoStartDateKey] ,
      [TachoEndDateKey]   ,
      [TachoStartDateTime],
      [TachoEndDateTime]  ,
      [RawData]           ,
      [MaxSpeed]          ,
      [MinSpeed]          ,
      [AvgSpeed]          ,
      [UTCOffsetKey]      ,
      [IsDeleted]         ,
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    )
    SELECT
      [TachoDataKey]      ,
      [HostID]            ,
      [OrganisationKey]   ,
      [BlockSequence]     ,
      [VehicleKey]        ,
      [TachoStartDateKey] ,
      [TachoEndDateKey]   ,
      [TachoStartDateTime],
      [TachoEndDateTime]  ,
      [RawData]           ,
      [MaxSpeed]          ,
      [MinSpeed]          ,
      [AvgSpeed]          ,
      [UTCOffsetKey]      ,
      [IsDeleted]         ,
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]          = 1,
        [UpdateBatchKey]     = @batchKey
      OUTPUT
        DELETED.[TachoDataKey]      ,
        DELETED.[HostID]            ,
        DELETED.[OrganisationKey]   ,
        DELETED.[BlockSequence]     ,
        DELETED.[VehicleKey]        ,
        DELETED.[TachoStartDateKey] ,
        DELETED.[TachoEndDateKey]   ,
        DELETED.[TachoStartDateTime],
        DELETED.[TachoEndDateTime]  ,
        DELETED.[RawData]           ,
        DELETED.[MaxSpeed]          ,
        DELETED.[MinSpeed]          ,
        DELETED.[AvgSpeed]          ,
        DELETED.[UTCOffsetKey]      ,
        DELETED.[IsDeleted]         ,
        DELETED.[CreateBatchKey]    ,
        DELETED.[UpdateBatchKey]
      FROM 
       [MiXData].dbo.FACT_TachoData    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser1].[STAGE_FACT_TachoData] AS stg ON tar.HostID          = stg.HostID
                                                AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation = 'D'
      ) AS del;

    -- record number of records deleted  
    SELECT @recordsDeleted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;  
    END;  

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_TachoData_HostID
      ON [StageUser1].[ROLLBACK_FACT_TachoData](HostID);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_TachoData
    ( 
      [OrganisationKey]   ,
      [HostID]            ,
      [BlockSequence]     ,
      [VehicleKey]        ,
      [TachoStartDateKey] ,
      [TachoEndDateKey]   ,
      [TachoStartDateTime],
      [TachoEndDateTime]  ,
      [RawData]           ,
      [MaxSpeed]          ,
      [MinSpeed]          ,
      [AvgSpeed]          ,
      [UTCOffsetKey]      ,
      [IsDeleted]         ,
      [CreateBatchKey]    ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey        ,
      stg.[HostID]            ,
      stg.[BlockSequence]     ,
      ISNULL(stg.[VehicleKey]        ,-1),
      stg.[TachoStartDateKey] ,
      stg.[TachoEndDateKey]   ,
      stg.[TachoStartDateTime],
      stg.[TachoEndDateTime]  ,
      stg.[RawData]           ,
      stg.[MaxSpeed]          ,
      stg.[MinSpeed]          ,
      stg.[AvgSpeed]          ,
      stg.[UTCOffsetKey]      ,
      0                       , --IsDeleted
      @batchKey               ,
      @batchKey
    FROM
      [StageUser1].[STAGE_FACT_TachoData]    AS stg
    WHERE
        stg.Operation IN ('I','U')
    AND NOT EXISTS (SELECT 1
                    FROM
                      [StageUser1].[ROLLBACK_FACT_TachoData] AS roll WITH (NOLOCK)
                    WHERE
                      stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_TachoData];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_TerminalDetails_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_TerminalDetails_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  DECLARE @nrOfrecordsAffected int = 0;
  DECLARE @nrOfValidationErrors   int = 0;

  DECLARE @unknownDateDefault date = '00010101';
  DECLARE	@currentDate     datetimeoffset; -- used for validation

  SELECT @currentDate = SYSUTCDATETIME();
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_TerminalDetails];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_TerminalDetails];

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    EXEC [Control].strProcProgressMonitor_Set
      @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';
  END;

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY


    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_TerminalDetails]') AND name = N'IX_STAGE_FACT_TerminalDetails_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_TerminalDetails_HostID_Operation ON [StageUser1].[STAGE_FACT_TerminalDetails];

    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_TerminalDetails]') AND name = N'IX_STAGE_FACT_TerminalDetails_VehicleID_TerminalDateTime_TerminalDateKey')
      DROP INDEX IX_STAGE_FACT_TerminalDetails_VehicleID_TerminalDateTime_TerminalDateKey ON [StageUser1].[STAGE_FACT_TerminalDetails];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_TerminalDetails]') AND name = N'IX_ROLLBACK_FACT_TerminalDetails_HostID')
      DROP INDEX IX_ROLLBACK_FACT_TerminalDetails_HostID ON [StageUser1].[ROLLBACK_FACT_TerminalDetails];

    -- insert changed records into STG
    INSERT INTO [StageUser1].[STAGE_FACT_TerminalDetails]
    ( 
      [Operation]       ,
      [HostID]          ,
      [VehicleID]       ,
      [TerminalDateKey] ,
      [TerminalTime]    ,
      [TerminalDateTime],
      [Odometer]        ,
      [MenuID]          ,
      [MenuItemCode]    ,
      [ValueType]       ,
      [NumberValue]     ,
      [StringValue]     ,
      [UTCOffsetKey]
    )
    SELECT
      s.Operation        ,
      HostID = s.EventKey,
      s.VehicleID        ,
      [TerminalDateKey] = CONVERT(DATE,   s.EventDate),
      [TerminalTime]    = CONVERT(TIME(0),s.EventDate),
      CASE 
        WHEN s.EventDate IS NULL
          THEN @unknownDateDefault
          ELSE TODATETIMEOFFSET(s.EventDate,ISNULL(utc.UTCOffsetMinutes,0))
      END,
      s.Odometer         ,
      s.MenuID           ,
      s.MenuItemCode     ,
      s.ValueType        ,
      s.NumberValue      ,
      s.StringValue      ,
      utc.UTCOffsetKey
    FROM
      [StageUser1].TerminalData s WITH (NOLOCK)
        CROSS JOIN
      [StageUser1].STAGE_DIM_UTCOffsetsLookup utc WITH (NOLOCK)
    WHERE
        ISNULL(CONVERT(DATETIMEOFFSET(0),s.EventDate),@unknownDateDefault) BETWEEN utc.StartDateTime       AND utc.EndDateTime
    AND ISNULL(CONVERT(DATETIMEOFFSET(0),s.EventDate),@unknownDateDefault) BETWEEN utc.SeasonStartDateTime AND utc.SeasonEndDateTime;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='2. Initial Insert', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_TerminalDetails_HostID_Operation 
      ON [StageUser1].[STAGE_FACT_TerminalDetails](HostID,Operation);

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_TerminalDetails_VehicleID_TerminalDateTime_TerminalDateKey 
      ON [StageUser1].[STAGE_FACT_TerminalDetails](VehicleID,TerminalDateTime,TerminalDateKey);

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.1 Create STAGE indexes', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
    END;

    ------------------------------------------
    -- VehicleKey
    UPDATE
      [StageUser1].[STAGE_FACT_TerminalDetails]
    SET
      VehicleKey = dv.[VehicleKey]
    FROM
      [StageUser1].[STAGE_FACT_TerminalDetails] stg
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles            dv  WITH (NOLOCK) ON stg.VehicleID      = dv.HostID
                                                             AND dv.OrganisationKey = @organisationKey
    WHERE
      stg.[TerminalDateKey] BETWEEN dv.StartDateKey AND dv.EndDateKey;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.2 Update VehicleKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    ------------------------------------------
    -- ActivityDetailKey/DriverKey
    -- disabled for initial run
    UPDATE
      [StageUser1].[STAGE_FACT_TerminalDetails]
    SET
      ActivityDetailKey   = fad.[ActivityDetailKey],
      DriverKey           = fad.[DriverKey]
    FROM
      [MiXData].dbo.DIM_Vehicles            dv  WITH (NOLOCK)
        INNER JOIN
      [StageUser1].[STAGE_FACT_TerminalDetails] stg               ON dv.OrganisationKey   = @organisationKey
                                                                AND stg.VehicleID        = dv.HostID
        INNER JOIN
      [MiXData].dbo.FACT_ActivityDetails    fad WITH (NOLOCK) ON fad.VehicleKey      = dv.VehicleKey
    WHERE
      stg.[TerminalDateTime] BETWEEN fad.ActivityStartDateTime AND fad.ActivityEndDateTime;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='3.3 Update ActivityDetailKey/DriverKey', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@@ROWCOUNT;
    END;

    ------------------------------------------
    -- UTCOffsetKey (use company UTC for now, will change in future)

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------

  -- EventDate is null
  BEGIN TRY  

    SELECT
      @nrOfValidationErrors = ISNULL(COUNT(1),0)
    FROM
      [StageUser1].[STAGE_FACT_TerminalDetails]  
    WHERE 
        [TerminalDateKey] IS NULL
    AND Operation         <> 'D';
                 
    IF @nrOfValidationErrors > 0
    BEGIN  
      RAISERROR(N'Some TerminalDetails has EventDates of null',16,1);  
    END  
   
    IF @debugMode = 1  -- DebugMode is true  
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4.1 Validation before Loading to DW (EventDate is null)';  
  
  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0, @nrOfErrors = @nrOfValidationErrors;  
  END CATCH;

  -- Remove dirty data
  BEGIN TRY  

    DELETE
      [StageUser1].[STAGE_FACT_TerminalDetails]
    WHERE
       [TerminalDateKey] IS NULL
    AND Operation        <> 'D';

  END TRY  
  -- CATCH Errors  
  BEGIN CATCH  
    EXEC [Control].sprLogError @organisationKey = @organisationKey;  
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Changed records
    INSERT INTO [StageUser1].[ROLLBACK_FACT_TerminalDetails]
    ( 
      [TerminalDetailKey],
      [OrganisationKey]  ,
      [HostID]           ,
      [VehicleKey]       ,
      [DriverKey]        ,
      [TerminalDateKey]  ,
      [TerminalTime]     ,
      [TerminalDateTime] ,
      [Odometer]         ,
      [MenuID]           ,
      [MenuItemCode]     ,
      [ValueType]        ,
      [NumberValue]      ,
      [StringValue]      ,
      [ActivityDetailKey],
      [UTCOffsetKey]     ,
      [IsDeleted]        ,
      [CreateBatchKey]   ,
      [UpdateBatchKey]
    )
    SELECT
      [TerminalDetailKey],
      [OrganisationKey]  ,
      [HostID]           ,
      [VehicleKey]       ,
      [DriverKey]        ,
      [TerminalDateKey]  ,
      [TerminalTime]     ,
      [TerminalDateTime] ,
      [Odometer]         ,
      [MenuID]           ,
      [MenuItemCode]     ,
      [ValueType]        ,
      [NumberValue]      ,
      [StringValue]      ,
      [ActivityDetailKey],
      [UTCOffsetKey]     ,
      [IsDeleted]        ,
      [CreateBatchKey]   ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [VehicleKey]         = ISNULL(stg.[VehicleKey]       ,-1),
        [DriverKey]          = ISNULL(stg.[DriverKey]        ,-1),
        [TerminalDateKey]    = stg.[TerminalDateKey]  ,
        [TerminalTime]       = stg.[TerminalTime]     ,
        [Odometer]           = stg.[Odometer]         ,
        [MenuID]             = stg.[MenuID]           ,
        [MenuItemCode]       = stg.[MenuItemCode]     ,
        [ValueType]          = stg.[ValueType]        ,
        [NumberValue]        = stg.[NumberValue]      ,
        [StringValue]        = stg.[StringValue]      ,
        [ActivityDetailKey]  = ISNULL(stg.[ActivityDetailKey],-1),
        [UTCOffsetKey]       = stg.[UTCOffsetKey]     ,
        [IsDeleted]          = 0                      ,
        [UpdateBatchKey]     = @batchKey
      OUTPUT
        DELETED.[TerminalDetailKey],
        DELETED.[OrganisationKey]  ,
        DELETED.[HostID]           ,
        DELETED.[VehicleKey]       ,
        DELETED.[DriverKey]        ,
        DELETED.[TerminalDateKey]  ,
        DELETED.[TerminalTime]     ,
        DELETED.[TerminalDateTime] ,
        DELETED.[Odometer]         ,
        DELETED.[MenuID]           ,
        DELETED.[MenuItemCode]     ,
        DELETED.[ValueType]        ,
        DELETED.[NumberValue]      ,
        DELETED.[StringValue]      ,
        DELETED.[ActivityDetailKey],
        DELETED.[UTCOffsetKey]     ,
        DELETED.[IsDeleted]        ,
        DELETED.[CreateBatchKey]   ,
        DELETED.[UpdateBatchKey]
      FROM 
       [MiXData].dbo.FACT_TerminalDetails    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser1].[STAGE_FACT_TerminalDetails] AS stg ON tar.HostID          = stg.HostID
                                                      AND tar.OrganisationKey = @organisationKey

      WHERE stg.Operation in ('I','U')
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    -- Deleted records
    INSERT INTO [StageUser1].[ROLLBACK_FACT_TerminalDetails]
    ( 
      [TerminalDetailKey],
      [OrganisationKey]  ,
      [HostID]           ,
      [VehicleKey]       ,
      [DriverKey]        ,
      [TerminalDateKey]  ,
      [TerminalTime]     ,
      [TerminalDateTime] ,
      [Odometer]         ,
      [MenuID]           ,
      [MenuItemCode]     ,
      [ValueType]        ,
      [NumberValue]      ,
      [StringValue]      ,
      [ActivityDetailKey],
      [UTCOffsetKey]     ,
      [IsDeleted]        ,
      [CreateBatchKey]   ,
      [UpdateBatchKey]
    )
    SELECT
      [TerminalDetailKey],
      [OrganisationKey]  ,
      [HostID]           ,
      [VehicleKey]       ,
      [DriverKey]        ,
      [TerminalDateKey]  ,
      [TerminalTime]     ,
      [TerminalDateTime] ,
      [Odometer]         ,
      [MenuID]           ,
      [MenuItemCode]     ,
      [ValueType]        ,
      [NumberValue]      ,
      [StringValue]      ,
      [ActivityDetailKey],
      [UTCOffsetKey]     ,
      [IsDeleted]        ,
      [CreateBatchKey]   ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]          = 1,
        [UpdateBatchKey]     = @batchKey
      OUTPUT
        DELETED.[TerminalDetailKey],
        DELETED.[OrganisationKey]  ,
        DELETED.[HostID]           ,
        DELETED.[VehicleKey]       ,
        DELETED.[DriverKey]        ,
        DELETED.[TerminalDateKey]  ,
        DELETED.[TerminalTime]     ,
        DELETED.[TerminalDateTime] ,
        DELETED.[Odometer]         ,
        DELETED.[MenuID]           ,
        DELETED.[MenuItemCode]     ,
        DELETED.[ValueType]        ,
        DELETED.[NumberValue]      ,
        DELETED.[StringValue]      ,
        DELETED.[ActivityDetailKey],
        DELETED.[UTCOffsetKey]     ,
        DELETED.[IsDeleted]        ,
        DELETED.[CreateBatchKey]   ,
        DELETED.[UpdateBatchKey]
      FROM 
       [MiXData].dbo.FACT_TerminalDetails    AS tar WITH (NOLOCK)
         INNER JOIN
       [StageUser1].[STAGE_FACT_TerminalDetails] AS stg ON tar.HostID          = stg.HostID
                                                      AND tar.OrganisationKey = @organisationKey
      WHERE stg.Operation = 'D'
      ) AS del;

    -- record number of records deleted  
    SELECT @recordsDeleted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;  
    END;  

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_TerminalDetails_HostID
      ON [StageUser1].[ROLLBACK_FACT_TerminalDetails](HostID);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_TerminalDetails
    ( 
      [OrganisationKey]  ,
      [HostID]           ,
      [VehicleKey]       ,
      [DriverKey]        ,
      [TerminalDateKey]  ,
      [TerminalTime]     ,
      [TerminalDateTime] ,
      [Odometer]         ,
      [MenuID]           ,
      [MenuItemCode]     ,
      [ValueType]        ,
      [NumberValue]      ,
      [StringValue]      ,
      [ActivityDetailKey],
      [UTCOffsetKey]     ,
      [IsDeleted]        ,
      [CreateBatchKey]   ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey       ,
      stg.[HostID]           ,
      ISNULL(stg.[VehicleKey]       ,-1),
      ISNULL(stg.[DriverKey]        ,-1),
      stg.[TerminalDateKey]  ,
      stg.[TerminalTime]     ,
      stg.[TerminalDateTime] ,
      stg.[Odometer]         ,
      stg.[MenuID]           ,
      stg.[MenuItemCode]     ,
      stg.[ValueType]        ,
      stg.[NumberValue]      ,
      stg.[StringValue]      ,
      ISNULL(stg.[ActivityDetailKey],-1),
      stg.[UTCOffsetKey]     ,
      0                      , --IsDeleted
      @batchKey              ,
      @batchKey
    FROM
      [StageUser1].[STAGE_FACT_TerminalDetails]    AS stg
    WHERE
        stg.Operation IN ('I','U')
    AND NOT EXISTS (SELECT 1
                    FROM
                      [StageUser1].[ROLLBACK_FACT_TerminalDetails] AS roll WITH (NOLOCK)
                    WHERE
                      stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;
      
  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_TerminalDetails];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    SELECT @nrOfRecordsAffected = @recordsInserted + @recordsUpdated;
    EXEC [Control].strProcProgressMonitor_Set
      @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@nrOfRecordsAffected;
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
  END;
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprFACT_VehicleCosts_Transform]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprFACT_VehicleCosts_Transform]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE	@return_value    int;
  DECLARE @recordsInserted int;
  DECLARE @recordsUpdated  int;
  DECLARE @recordsDeleted  int;
  
  DECLARE	@currentDate     datetimeoffset; -- used for validation

  SELECT @currentDate = SYSUTCDATETIME();
  --------------------------------------------------------------------
  -- 0. Make sure work tables are cleared
  --------------------------------------------------------------------
  TRUNCATE TABLE [StageUser1].[STAGE_FACT_VehicleCosts];
  TRUNCATE TABLE [StageUser1].[ROLLBACK_FACT_VehicleCosts];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Make sure work tables are cleared';

  --------------------------------------------------------------------
  -- 1. Source Data Validation
  --------------------------------------------------------------------

  --------------------------------------------------------------------
  -- 2. Add to STG
  --------------------------------------------------------------------
  BEGIN TRY

    -- drop STAGE indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[STAGE_FACT_VehicleCosts]') AND name = N'IX_STAGE_FACT_VehicleCosts_HostID_Operation')
      DROP INDEX IX_STAGE_FACT_VehicleCosts_HostID_Operation ON [StageUser1].[STAGE_FACT_VehicleCosts];

    -- drop ROLLBACK indexes before insert
    IF EXISTS(SELECT *
              FROM sys.indexes 
              WHERE object_id = OBJECT_ID(N'[StageUser1].[ROLLBACK_FACT_VehicleCosts]') AND name = N'IX_ROLLBACK_FACT_VehicleCosts_HostID')
      DROP INDEX IX_ROLLBACK_FACT_VehicleCosts_HostID ON [StageUser1].[ROLLBACK_FACT_VehicleCosts];
  
    -- insert changed records into STG
	  INSERT INTO [StageUser1].[STAGE_FACT_VehicleCosts]
	  ( 
	    [Operation]      ,
      [HostID]         ,
      [VehicleID]      ,
      [CategoryID]     ,
      [CostDateKey]        ,
      [OdometerReading],
      [BaseCost]       ,
      [BaseCurrency]
	  )
    SELECT
      s.Operation                                                                  ,
      HostID       = s.sProperty                                                   ,
      VehicleID    = s.liObjectID                                                  ,
      CategoryID   = dbo.fncGetListItemInt(ISNULL(s.sValue,''),'CategoryID',0)                , --CONVERT(INT,dbo.fncStringColumnValueGet('CategoryID',s.sValue)),
      DateKey      = CONVERT(DATE,CONVERT(DATETIME,dbo.fncGetListItemFloat(ISNULL(s.sValue,''),'DateTime',0))),
      Odo          = dbo.fncGetListItemFloat(ISNULL(s.sValue,''),'Odo',0.0)                   , --CONVERT(INT,dbo.fncStringColumnValueGet('Odo',s.sValue)),      
      BaseValue    = dbo.fncGetListItemFloat(ISNULL(s.sValue,''),'BaseValue',0.0)             , --CONVERT(NUMERIC(16,4),dbo.fncStringColumnValueGet('BaseValue',s.sValue)),
      BaseCurrCode = dbo.fncGetListItem(ISNULL(s.sValue,''),'BaseCurrCode','')
    FROM
      [StageUser1].ExtensionProperties_FACT s WITH (NOLOCK)
    WHERE
        s.sAppID       = 'Costing'
    AND s.liObjectType = 1;  -- transactional costing values

    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Add to STG';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 3. Update calculated columns onto STG
  --------------------------------------------------------------------
  BEGIN TRY

    CREATE NONCLUSTERED INDEX IX_STAGE_FACT_VehicleCosts_HostID_Operation 
      ON [StageUser1].[STAGE_FACT_VehicleCosts](HostID,Operation);

    ------------------------------------------
    -- VehicleKey
    UPDATE
      [StageUser1].[STAGE_FACT_VehicleCosts]
    SET
      [VehicleKey] = dv.[VehicleKey]
    FROM
      [StageUser1].[STAGE_FACT_VehicleCosts] stg
        INNER JOIN
      [MiXData].dbo.DIM_Vehicles      dv  WITH (NOLOCK)
        ON  dv.OrganisationKey = @organisationKey
        AND stg.VehicleID      = dv.HostID
    WHERE
      stg.CostDateKey BETWEEN dv.StartDateKey AND dv.EndDateKey;

    ------------------------------------------
    -- CostCategoryKey/IsRecurring
    UPDATE
      [StageUser1].[STAGE_FACT_VehicleCosts]
    SET
      [CostCategoryKey] = dvc.[VehicleCostCategoryKey],
      [IsRecurring]     = dvc.[IsRecurring]
    FROM
      [StageUser1].[STAGE_FACT_VehicleCosts] stg
        INNER JOIN
      [MiXData].dbo.DIM_VehicleCostCategories dvc WITH (NOLOCK)
        ON  dvc.[OrganisationKey] = @organisationKey
        AND dvc.[HostID]          = stg.[CategoryID];

    ------------------------------------------
    -- BaseCurrencyKey
    UPDATE
      [StageUser1].[STAGE_FACT_VehicleCosts]
    SET
      [BaseCurrencyKey] = dc.[CurrencyKey]
    FROM
      [StageUser1].[STAGE_FACT_VehicleCosts] stg
        INNER JOIN
      [MiXData].dbo.DIM_Currencies dc WITH (NOLOCK)
        ON  dc.[CurrencyAlternateKey] = stg.[BaseCurrency];

    ------------------------------------------
    -- UTCOffsetKey (use company UTC for now, will change in future)
    UPDATE [StageUser1].[STAGE_FACT_VehicleCosts]
    SET
      UTCOffsetKey         = utc.[UTCOffsetKey]
    FROM
      [StageUser1].[STAGE_FACT_VehicleCosts]    stg,
      [StageUser1].STAGE_DIM_UTCOffsetsLookUp utc WITH (NOLOCK)
    WHERE
        stg.[CostDateKey] BETWEEN utc.[StartDateKey]        AND utc.[EndDateKey]
    AND stg.[CostDateKey] BETWEEN utc.[SeasonStartDateTime] AND utc.[SeasonEndDateTime]

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 4. Validation before Loading to DW
  --------------------------------------------------------------------
  BEGIN TRY

 
    IF @debugMode = 1  -- DebugMode is true
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 4. Validation before Loading to DW';

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 5. MERGE to DW (Load) and add to RollBck
  --------------------------------------------------------------------
  BEGIN TRY

    -- Add to RollBck table
    INSERT INTO [StageUser1].[ROLLBACK_FACT_VehicleCosts]
    ( 
      [VehicleCostKey] ,
      [OrganisationKey],
      [HostID]         ,
      [CostDateKey]    ,
      [IsRecurring]    ,
      [VehicleKey]     ,
      [OdometerReading],
      [CostCategoryKey],
      [BaseCost]       ,
      [BaseCurrencyKey],
      [UTCOffsetKey]   ,
      [IsDeleted]      ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      [VehicleCostKey] ,
      [OrganisationKey],
      [HostID]         ,
      [CostDateKey]    ,
      [IsRecurring]    ,
      [VehicleKey]     ,
      [OdometerReading],
      [CostCategoryKey],
      [BaseCost]       ,
      [BaseCurrencyKey],
      [UTCOffsetKey]   ,
      [IsDeleted]      ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [CostDateKey]     = stg.[CostDateKey]    ,
        [IsRecurring]     = stg.[IsRecurring]    ,
        [VehicleKey]      = ISNULL(stg.[VehicleKey]     ,-1),
        [OdometerReading] = stg.[OdometerReading],
        [CostCategoryKey] = ISNULL(stg.[CostCategoryKey],-1),
        [BaseCost]        = stg.[BaseCost]       ,
        [BaseCurrencyKey] = ISNULL(stg.[BaseCurrencyKey],-1),
        [UTCOffsetKey]    = stg.[UTCOffsetKey]   ,
        [IsDeleted]       = 0                    ,
        [UpdateBatchKey]  = @batchKey
      OUTPUT
        DELETED.[VehicleCostKey] ,
        DELETED.[OrganisationKey],
        DELETED.[HostID]         ,
        DELETED.[CostDateKey]    ,
        DELETED.[IsRecurring]    ,
        DELETED.[VehicleKey]     ,
        DELETED.[OdometerReading],
        DELETED.[CostCategoryKey],
        DELETED.[BaseCost]       ,
        DELETED.[BaseCurrencyKey],
        DELETED.[UTCOffsetKey]   ,
        DELETED.[IsDeleted]      ,
        DELETED.[CreateBatchKey] ,
        DELETED.[UpdateBatchKey]
      FROM [MiXData].dbo.FACT_VehicleCosts    AS tar
             INNER JOIN
           [StageUser1].[STAGE_FACT_VehicleCosts] AS stg ON tar.HostID               = stg.HostID
                                                       AND tar.OrganisationKey      = @organisationKey
      WHERE stg.Operation in ('I','U')
      ) AS upd;

    -- record number of records updated
    SELECT @recordsUpdated = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.1 Merge Existing Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsUpdated;
    END;

    -- Deleted records
    INSERT INTO [StageUser1].[ROLLBACK_FACT_VehicleCosts]
    ( 
      [VehicleCostKey] ,
      [OrganisationKey],
      [HostID]         ,
      [CostDateKey]    ,
      [IsRecurring]    ,
      [VehicleKey]     ,
      [OdometerReading],
      [CostCategoryKey],
      [BaseCost]       ,
      [BaseCurrencyKey],
      [UTCOffsetKey]   ,
      [IsDeleted]      ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      [VehicleCostKey] ,
      [OrganisationKey],
      [HostID]         ,
      [CostDateKey]    ,
      [IsRecurring]    ,
      [VehicleKey]     ,
      [OdometerReading],
      [CostCategoryKey],
      [BaseCost]       ,
      [BaseCurrencyKey],
      [UTCOffsetKey]   ,
      [IsDeleted]      ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    FROM
     (UPDATE
        tar
      SET
        [IsDeleted]       = 1,
        [UpdateBatchKey]  = @batchKey
      OUTPUT
        DELETED.[VehicleCostKey] ,
        DELETED.[OrganisationKey],
        DELETED.[HostID]         ,
        DELETED.[CostDateKey]    ,
        DELETED.[IsRecurring]    ,
        DELETED.[VehicleKey]     ,
        DELETED.[OdometerReading],
        DELETED.[CostCategoryKey],
        DELETED.[BaseCost]       ,
        DELETED.[BaseCurrencyKey],
        DELETED.[UTCOffsetKey]   ,
        DELETED.[IsDeleted]      ,
        DELETED.[CreateBatchKey] ,
        DELETED.[UpdateBatchKey]
      FROM [MiXData].dbo.FACT_VehicleCosts    AS tar
             INNER JOIN
           [StageUser1].[STAGE_FACT_VehicleCosts] AS stg ON tar.HostID               = stg.HostID
                                                       AND tar.OrganisationKey      = @organisationKey
      WHERE stg.Operation = 'D'
      ) AS del;

    -- record number of records deleted  
    SELECT @recordsDeleted = @@ROWCOUNT;  
  
    IF @debugMode = 1  -- DebugMode is true  
    BEGIN  
      EXEC [Control].strProcProgressMonitor_Set  
        @flag='5.2 Merge Deleted Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;  
    END;  

    -- create rollback index
    CREATE NONCLUSTERED INDEX IX_ROLLBACK_FACT_VehicleCosts_HostID
      ON [StageUser1].[ROLLBACK_FACT_VehicleCosts](HostID);

    -- insert new records to FACT
    INSERT INTO [MiXData].dbo.FACT_VehicleCosts
    ( 
      [OrganisationKey],
      [HostID]         ,
      [CostDateKey]    ,
      [IsRecurring]    ,
      [VehicleKey]     ,
      [OdometerReading],
      [CostCategoryKey],
      [BaseCost]       ,
      [BaseCurrencyKey],
      [UTCOffsetKey]   ,
      [IsDeleted]      ,
      [CreateBatchKey] ,
      [UpdateBatchKey]
    )
    SELECT
      @organisationKey     ,
      stg.[HostID]         ,
      stg.[CostDateKey]    ,
      stg.[IsRecurring]    ,
      ISNULL(stg.[VehicleKey]     ,-1),
      stg.[OdometerReading],
      ISNULL(stg.[CostCategoryKey],-1),
      stg.[BaseCost]       ,
      ISNULL(stg.[BaseCurrencyKey],-1),
      stg.[UTCOffsetKey]   ,
      0                    , -- IsDeleted
      @batchKey            ,
      @batchKey
    FROM
      [StageUser1].[STAGE_FACT_VehicleCosts]    AS stg
    WHERE
        stg.Operation IN ('I','U')
    AND NOT EXISTS (SELECT 1
                    FROM
                      [StageUser1].[ROLLBACK_FACT_VehicleCosts] AS roll WITH (NOLOCK)
                    WHERE
                      stg.HostID = roll.HostID);

    -- record number of records inserted
    SELECT @recordsInserted = @@ROWCOUNT;

    IF @debugMode = 1  -- DebugMode is true
    BEGIN
      EXEC [Control].strProcProgressMonitor_Set
        @flag='5.3 Merge New Records', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsInserted;
      PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 5. MERGE to DW (Load) and add to RollBck';
    END;

  END TRY
  -- CATCH Errors
  BEGIN CATCH
    EXEC [Control].sprLogError @organisationKey = @organisationKey;
    RETURN -1;
  END CATCH;

  --------------------------------------------------------------------
  -- 6. Cleanup work tables
  --------------------------------------------------------------------
  IF @debugMode = 0  -- Clear work tables by default, else leave them populated for debugging
    TRUNCATE TABLE [StageUser1].[STAGE_FACT_VehicleCosts];

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 6. Cleanup work tables';

  --------------------------------------------------------------------
  -- 7. Return values for Performance Monitoring
  --------------------------------------------------------------------
  SELECT RecordsInserted = isnull(@recordsInserted,0),
         RecordsUpdated  = isnull(@recordsUpdated ,0),
         RecordsDeleted  = isnull(@recordsDeleted ,0);

  IF @debugMode = 1  -- DebugMode is true
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 7. Return values for Performance Monitoring';
    
  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprGroupTriggers_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprGroupTriggers_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].GroupTriggers_CT  AS tar
      USING [StageUser1].GroupTriggers AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.liGroupID      = stg.liGroupID    ,
            tar.iEventID       = stg.iEventID     ,
            tar.ucTriggerID    = stg.ucTriggerID  ,
            tar.ucSeq          = stg.ucSeq        ,
            tar.iParameterID   = stg.iParameterID ,
            tar.ucOperator     = stg.ucOperator   ,
            tar.lfValue        = stg.lfValue      ,
            tar.bRequired      = stg.bRequired    ,
            tar.ucTOper        = stg.ucTOper      ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            liGroupID      ,
            iEventID       ,
            ucTriggerID    ,
            ucSeq          ,
            iParameterID   ,
            ucOperator     ,
            lfValue        ,
            bRequired      ,
            ucTOper        ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.liGroupID    ,
            stg.iEventID     ,
            stg.ucTriggerID  ,
            stg.ucSeq        ,
            stg.iParameterID ,
            stg.ucOperator   ,
            stg.lfValue      ,
            stg.bRequired    ,
            stg.ucTOper      ,
            @batchKey        ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprMapLocationPolygonPoints_Get]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprMapLocationPolygonPoints_Get]
	@locationID [int]
AS
SELECT
  fLongitude,
  fLatitude
FROM
  [StageUser1].MapLocationPolygonPoints
WHERE
  liLocationID = @locationID
ORDER BY
  liSequence ASC;

GO
/****** Object:  StoredProcedure [StageUser1].[sprOrgOptions_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprOrgOptions_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].OrgOptions_CT  AS tar
      USING [StageUser1].OrgOptions AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate    ,
            tar.Operation      = stg.Operation     ,
            tar.UpdateMask     = stg.UpdateMask    ,
            tar.ChangeVersion  = stg.ChangeVersion ,
            tar.sLPDealerName  = stg.sLPDealerName ,
            tar.sLPDealerTelNo = stg.sLPDealerTelNo,
            tar.sLPRegCode     = stg.sLPRegCode    ,
            tar.UpdateBatchKey = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            sLPDealerName  ,
            sLPDealerTelNo ,
            sLPRegCode     ,
            CreateBatchKey ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey  ,
            stg.RID           ,
            stg.ChangeDate    ,
            stg.Operation     ,
            stg.UpdateMask    ,
            stg.ChangeVersion ,
            stg.sLPDealerName ,
            stg.sLPDealerTelNo,
            stg.sLPRegCode    ,
            @batchKey         ,
            @batchKey
      );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprParam_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprParam_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  
  
  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Param_CT  AS tar
      USING [StageUser1].Param AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iParameterID   = stg.iParameterID ,
            tar.sDescription   = stg.sDescription ,
            tar.sSystemName    = stg.sSystemName  ,
            tar.ucValueFormat  = stg.ucValueFormat,
            tar.sUnits         = stg.sUnits       ,
            tar.bSystem        = stg.bSystem      ,
            tar.bFuelCounter   = stg.bFuelCounter ,
            tar.bProfiled      = stg.bProfiled    ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iParameterID   ,
            sDescription   ,
            sSystemName    ,
            ucValueFormat  ,
            sUnits         ,
            bSystem        ,
            bFuelCounter   ,
            bProfiled      ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.iParameterID ,
            stg.sDescription ,
            stg.sSystemName  ,
            stg.ucValueFormat,
            stg.sUnits       ,
            stg.bSystem      ,
            stg.bFuelCounter ,
            stg.bProfiled    ,
            @batchKey        ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprPartitionCreate]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprPartitionCreate]
	@Dbname [nvarchar](128),
	@PartitionScheme [nvarchar](128),
	@PartitionFunction [nvarchar](128),
	@PartitionSize [varchar](6)
AS
Declare @Stmt nvarchar(max);
Declare @CurrDate Date
Declare @NextMonth nchar(2);
Declare @NextYear nchar(4);
Declare @FileGroup nvarchar(10);

set @CurrDate = GETUTCDATE()
set @NextMonth = REPLICATE('0',2-LEN(RTRIM(CONVERT(varchar(20),DATEPART(month,DATEADD(month,1,@CurrDate))))))+CONVERT(varchar(20),DATEPART(month,DATEADD(month,1,@CurrDate)))
set @NextYear = DATEPART(year,DATEADD(month,1,@CurrDate))
set @FileGroup = @NextYear + '-' + @NextMonth

select @Stmt = 'Use [' + @Dbname + '];' + char(13);

select @Stmt = @Stmt + 'Alter Database [' + @Dbname + '] Add Filegroup [' + @FileGroup + '];' + char(13);

select @Stmt  = @Stmt +  'Alter Database [' + @Dbname + '] Add File (Name = [' + @FileGroup + '_' + FileNum + '],' + 'Filename = N''' + Drive + DPath + @Dbname + '_' + @FileGroup + '_' + FileNum + '.ndf'',Size = ' + @PartitionSize + 'MB,FILEGROWTH = 256MB)' + 'To FileGroup [' + @FileGroup + '];' + char(13)
				  from MixStaging.Control.PartitionInfo where MonNum = @NextMonth; 
 
select @Stmt  = @Stmt +   'Alter Partition Scheme [' + @PartitionScheme + '] Next Used [' + @FileGroup + '];' + char(13); 
 
select @Stmt  = @Stmt +   'Alter Partition Function [' + @PartitionFunction + '] () Split Range (''' + @FileGroup + '-' + '01'');' + char(13);
exec (@Stmt);
--print @Stmt;

RETURN 0;

GO
/****** Object:  StoredProcedure [StageUser1].[sprPassengers_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprPassengers_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Passengers_CT  AS tar
      USING [StageUser1].Passengers AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.PassengerGUID  = stg.PassengerGUID,
            tar.iPassengerID   = stg.iPassengerID ,
            tar.sName          = stg.sName        ,
            tar.UpdateBatchKey = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            PassengerGUID  ,
            iPassengerID   ,
            sName          ,
            CreateBatchKey ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.PassengerGUID,
            stg.iPassengerID ,
            stg.sName        ,
            @batchKey        ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprRestoreAuditRecordsMerge]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprRestoreAuditRecordsMerge]
	@organisationKey [int]
AS
BEGIN
  SET NOCOUNT ON

  DECLARE @firstAuditRecordHostRID INT;
  DECLARE @numberOfRecordsAffected INT;

  --------------------------------
  -- DeviceParam
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].DeviceParam
  
  INSERT INTO [StageUser1].DeviceParam
  (
    [OrganisationKey]  ,
    [RID]              ,
    [ChangeDate]       ,
    [Operation]        ,
    [UpdateMask]       ,
    [ChangeVersion]    ,
    [liDeviceID]       ,
    [iParameterID]     ,
    [bDeviceDefault]   ,
    [bParamDefault]    ,
    [ucCalibrationType],
    [lfCalibration1]   ,
    [lfValue1]         ,
    [lfCalibration2]   ,
    [lfValue2]         ,
    [sUserName]
  )
  SELECT
    [OrganisationKey]  ,
    [HostRID]          ,
    [ChangeDate]       ,
    [Operation]        ,
    [UpdateMask]       ,
    [ChangeVersion]    ,
    [liDeviceID]       ,
    [iParameterID]     ,
    [bDeviceDefault]   ,
    [bParamDefault]    ,
    [ucCalibrationType],
    [lfCalibration1]   ,
    [lfValue1]         ,
    [lfCalibration2]   ,
    [lfValue2]         ,
    [sUserName]
  FROM audit.DeviceParam_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey        = @organisationKey
  AND (a.HostRID                < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Devices
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].Devices

  INSERT INTO [StageUser1].Devices
  (
    [OrganisationKey]   ,
    [RID]               ,
    [ChangeDate]        ,
    [Operation]         ,
    [UpdateMask]        ,
    [ChangeVersion]     ,
    [liDeviceID]        ,
    [sDescription]      ,
    [sSystemName]       ,
    [ucDeviceType]      ,
    [bCanRecordInterval],
    [sReportProgID]     ,
    [sUserName]
  )
  SELECT
    [OrganisationKey]   ,
    [HostRID]           ,
    [ChangeDate]        ,
    [Operation]         ,
    [UpdateMask]        ,
    [ChangeVersion]     ,
    [liDeviceID]        ,
    [sDescription]      ,
    [sSystemName]       ,
    [ucDeviceType]      ,
    [bCanRecordInterval],
    [sReportProgID]     ,
    [sUserName]
  FROM audit.Devices_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- DriverCertifications
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].DriverCertifications

  INSERT INTO [StageUser1].DriverCertifications
  (
    [OrganisationKey]     ,
    [RID]                 ,
    [ChangeDate]          ,
    [Operation]           ,
    [UpdateMask]          ,
    [ChangeVersion]       ,
    [iDriverID]           ,
    [liCertificationID]   ,
    [dtObtained]          ,
    [sInstructor]         ,
    [bInstructorQualified],
    [sLocation]
  )
  SELECT
    [OrganisationKey]     ,
    [HostRID]             ,
    [ChangeDate]          ,
    [Operation]           ,
    [UpdateMask]          ,
    [ChangeVersion]       ,
    [iDriverID]           ,
    [liCertificationID]   ,
    [dtObtained]          ,
    [sInstructor]         ,
    [bInstructorQualified],
    [sLocation]
  FROM audit.DriverCertifications_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- DriverLicences
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].DriverLicences

  INSERT INTO [StageUser1].DriverLicences
  (
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [OrganisationKey],
    [iDriverID]      ,
    [liLicenceID]    ,
    [dtObtained]     ,
    [dtExpires]
  )
  SELECT
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [OrganisationKey],
    [iDriverID]      ,
    [liLicenceID]    ,
    [dtObtained]     ,
    [dtExpires]
  FROM audit.DriverLicences_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Drivers
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].Drivers

  INSERT INTO [StageUser1].Drivers
  (
    [RID]              ,
    [ChangeDate]       ,
    [Operation]        ,
    [UpdateMask]       ,
    [ChangeVersion]    ,
    [OrganisationKey]  ,
    [DriverGUID]       ,
    [iDriverID]        ,
    [liSiteID]         ,
    [liGroupID]        ,
    [sEmployeeNumber]  ,
    [sName]            ,
    [bLicense]         ,
    [dtLastLicense]    ,
    [dtNextLicense]    ,
    [ucLicenseInterval],
    [dtDistanceChecked],
    [sExtendedID]      ,
    [ucLicenseRemind]
  )
  SELECT
    [HostRID]          ,
    [ChangeDate]       ,
    [Operation]        ,
    [UpdateMask]       ,
    [ChangeVersion]    ,
    [OrganisationKey]  ,
    [DriverGUID]       ,
    [iDriverID]        ,
    [liSiteID]         ,
    [liGroupID]        ,
    [sEmployeeNumber]  ,
    [sName]            ,
    [bLicense]         ,
    [dtLastLicense]    ,
    [dtNextLicense]    ,
    [ucLicenseInterval],
    [dtDistanceChecked],
    [sExtendedID]      ,
    [ucLicenseRemind]
  FROM audit.Drivers_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- EventDescription
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].EventDescription

  INSERT INTO [StageUser1].EventDescription
  (
    [RID]          ,
    [ChangeDate]   ,
    [Operation]    ,
    [UpdateMask]   ,
    [ChangeVersion],
    [iEventID]     ,
    [sDescription] ,
    [sSystemName]  ,
    [sCriticalID]  ,
    [ucSummaryType],
    [iSummaryID]   ,
    [sUserName]
  )
  SELECT
    [HostRID]      ,
    [ChangeDate]   ,
    [Operation]    ,
    [UpdateMask]   ,
    [ChangeVersion],
    [iEventID]     ,
    [sDescription] ,
    [sSystemName]  ,
    [sCriticalID]  ,
    [ucSummaryType],
    [iSummaryID]   ,
    [sUserName]
  FROM audit.EventDescription_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- EventTriggers
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].EventTriggers

  INSERT INTO [StageUser1].EventTriggers
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iEventID]       ,
    [ucTriggerID]    ,
    [ucSeq]          ,
    [iParameterID]   ,
    [ucOperator]     ,
    [lfValue]        ,
    [bRequired]      ,
    [ucTOper]        ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iEventID]       ,
    [ucTriggerID]    ,
    [ucSeq]          ,
    [iParameterID]   ,
    [ucOperator]     ,
    [lfValue]        ,
    [bRequired]      ,
    [ucTOper]        ,
    [sUserName]
  FROM audit.EventTriggers_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- ExtensionProperties
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].ExtensionProperties_DIM

  INSERT INTO [StageUser1].ExtensionProperties_DIM
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [sAppID]         ,
    [liObjectType]   ,
    [liObjectID]     ,
    [sProperty]      ,
    [sValue]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [sAppID]         ,
    [liObjectType]   ,
    [liObjectID]     ,
    [sProperty]      ,
    [sValue]
  FROM audit.ExtensionProperties_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- GroupTriggers
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].GroupTriggers

  INSERT INTO [StageUser1].GroupTriggers
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [liGroupID]      ,
    [iEventID]       ,
    [ucTriggerID]    ,
    [ucSeq]          ,
    [iParameterID]   ,
    [ucOperator]     ,
    [lfValue]        ,
    [bRequired]      ,
    [ucTOper]        ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [liGroupID]      ,
    [iEventID]       ,
    [ucTriggerID]    ,
    [ucSeq]          ,
    [iParameterID]   ,
    [ucOperator]     ,
    [lfValue]        ,
    [bRequired]      ,
    [ucTOper]        ,
    [sUserName]
  FROM audit.GroupTriggers_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- OrgOptions
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].OrgOptions

  INSERT INTO [StageUser1].OrgOptions
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [sLPDealerName]  ,
    [sLPDealerTelNo] ,
    [sLPRegCode]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [sLPDealerName]  ,
    [sLPDealerTelNo] ,
    [sLPRegCode]
  FROM audit.OrgOptions_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Param
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].[Param]

  INSERT INTO [StageUser1].[Param]
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iParameterID]   ,
    [sDescription]   ,
    [sSystemName]    ,
    [ucValueFormat]  ,
    [sUnits]         ,
    [bSystem]        ,
    [bFuelCounter]   ,
    [bProfiled]      ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iParameterID]   ,
    [sDescription]   ,
    [sSystemName]    ,
    [ucValueFormat]  ,
    [sUnits]         ,
    [bSystem]        ,
    [bFuelCounter]   ,
    [bProfiled]      ,
    [sUserName]
  FROM audit.Param_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Passengers
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].Passengers

  INSERT INTO [StageUser1].Passengers
  (
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [OrganisationKey],
    [PassengerGUID]  ,
    [iPassengerID]   ,
    [sName]
  )
  SELECT
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [OrganisationKey],
    [PassengerGUID]  ,
    [iPassengerID]   ,
    [sName]
  FROM audit.Passengers_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- ScoredEvents
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].ScoredEvents

  INSERT INTO [StageUser1].ScoredEvents
  (
    [RID]             ,
    [ChangeDate]      ,
    [Operation]       ,
    [UpdateMask]      ,
    [ChangeVersion]   ,
    [iEventID]        ,
    [ucScoreWeight]   ,
    [lfScoreDuration] ,
    [lfScoreSeverity] ,
    [ucScoreTriggerID],
    [sUserName]
  )
  SELECT
    [HostRID]         ,
    [ChangeDate]      ,
    [Operation]       ,
    [UpdateMask]      ,
    [ChangeVersion]   ,
    [iEventID]        ,
    [ucScoreWeight]   ,
    [lfScoreDuration] ,
    [lfScoreSeverity] ,
    [ucScoreTriggerID],
    [sUserName]
  FROM audit.ScoredEvents_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Sites
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].Sites

  INSERT INTO [StageUser1].Sites
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [liSiteID]       ,
    [SiteGUID]       ,
    [sName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [liSiteID]       ,
    [SiteGUID]       ,
    [sName]
  FROM audit.Sites_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Trailers
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].Trailers

  INSERT INTO [StageUser1].Trailers
  (
    [RID]              ,
    [ChangeDate]       ,
    [Operation]        ,
    [UpdateMask]       ,
    [ChangeVersion]    ,
    [OrganisationKey]  ,
    [TrailerGUID]      ,
    [liTrailerID]      ,
    [sDescription]     ,
    [sRegNo]           ,
    [sAssetNumber]     ,
    [fSetOdometer]     ,
    [dtOdometerChanged],
    [dtPrevService]    ,
    [dtNextService]    ,
    [iServIntTime]     ,
    [fPrevService]     ,
    [fNextService]     ,
    [fServIntDistance]
  )
  SELECT
    [HostRID]          ,
    [ChangeDate]       ,
    [Operation]        ,
    [UpdateMask]       ,
    [ChangeVersion]    ,
    [OrganisationKey]  ,
    [TrailerGUID]      ,
    [liTrailerID]      ,
    [sDescription]     ,
    [sRegNo]           ,
    [sAssetNumber]     ,
    [fSetOdometer]     ,
    [dtOdometerChanged],
    [dtPrevService]    ,
    [dtNextService]    ,
    [iServIntTime]     ,
    [fPrevService]     ,
    [fNextService]     ,
    [fServIntDistance]
  FROM audit.Trailers_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- TrailerUnitIDs
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].TrailerUnitIDs

  INSERT INTO [StageUser1].TrailerUnitIDs
  (
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [OrganisationKey],
    [liUnitID]       ,
    [liTrailerID]    ,
    [dtAttached]
  )
  SELECT
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [OrganisationKey],
    [liUnitID]       ,
    [liTrailerID]    ,
    [dtAttached]
  FROM audit.TrailerUnitIDs_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- VehicleDeviceParam
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].VehicleDeviceParam;

  INSERT INTO [StageUser1].VehicleDeviceParam
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [liDeviceID]     ,
    [iParameterID]   ,
    [lfCalibration1] ,
    [lfValue1]       ,
    [lfCalibration2] ,
    [lfValue2]       ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [liDeviceID]     ,
    [iParameterID]   ,
    [lfCalibration1] ,
    [lfValue1]       ,
    [lfCalibration2] ,
    [lfValue2]       ,
    [sUserName]
  FROM audit.VehicleDeviceParam_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- VehicleDeviceProperties
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].VehicleDeviceProperties;

  INSERT INTO [StageUser1].VehicleDeviceProperties
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [liDeviceID]     ,
    [sProperty]      ,
    [sValue]         ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [liDeviceID]     ,
    [sProperty]      ,
    [sValue]         ,
    [sUserName]
  FROM audit.VehicleDeviceProperties_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- VehicleDevices
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].VehicleDevices;

  INSERT INTO [StageUser1].VehicleDevices
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [liDeviceID]     ,
    [sInputID]       ,
    [bIsActive]      ,
    [bRecordInterval],
    [liPowerDeviceID],
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [liDeviceID]     ,
    [sInputID]       ,
    [bIsActive]      ,
    [bRecordInterval],
    [liPowerDeviceID],
    [sUserName]
  FROM audit.VehicleDevices_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- VehicleEvent
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].VehicleEvent;

  INSERT INTO [StageUser1].VehicleEvent
  (
    [OrganisationKey]        ,
    [RID]                    ,
    [ChangeDate]             ,
    [Operation]              ,
    [UpdateMask]             ,
    [ChangeVersion]          ,
    [iVehicleID]             ,
    [iEventID]               ,
    [ucEventType]            ,
    [bInUse]                 ,
    [bStartOdo]              ,
    [bStartPosition]         ,
    [bEndOdo]                ,
    [bEndPosition]           ,
    [bRecordF3Count]         ,
    [bWarningMessage]        ,
    [bActivePosition]        ,
    [iRecordTime]            ,
    [iAlarmTime]             ,
    [iRelayTime]             ,
    [iRelay2Time]            ,
    [iCriticalTime]          ,
    [iActiveTime]            ,
    [iActiveEndTime]         ,
    [iTrackTime]             ,
    [iTrackInterval]         ,
    [ucAlarmState]           ,
    [ucRelayState]           ,
    [ucRelay2State]          ,
    [sWarningMessage]        ,
    [ucPriority]             ,
    [dtLastEventNotification],
    [sUserName]
  )
  SELECT
    [OrganisationKey]        ,
    [HostRID]                ,
    [ChangeDate]             ,
    [Operation]              ,
    [UpdateMask]             ,
    [ChangeVersion]          ,
    [iVehicleID]             ,
    [iEventID]               ,
    [ucEventType]            ,
    [bInUse]                 ,
    [bStartOdo]              ,
    [bStartPosition]         ,
    [bEndOdo]                ,
    [bEndPosition]           ,
    [bRecordF3Count]         ,
    [bWarningMessage]        ,
    [bActivePosition]        ,
    [iRecordTime]            ,
    [iAlarmTime]             ,
    [iRelayTime]             ,
    [iRelay2Time]            ,
    [iCriticalTime]          ,
    [iActiveTime]            ,
    [iActiveEndTime]         ,
    [iTrackTime]             ,
    [iTrackInterval]         ,
    [ucAlarmState]           ,
    [ucRelayState]           ,
    [ucRelay2State]          ,
    [sWarningMessage]        ,
    [ucPriority]             ,
    [dtLastEventNotification],
    [sUserName]
  FROM audit.VehicleEvent_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- VehicleProfile
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].VehicleProfile;

  INSERT INTO [StageUser1].VehicleProfile
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [iParameterID]   ,
    [ucSeq]          ,
    [lfValue]        ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [iParameterID]   ,
    [ucSeq]          ,
    [lfValue]        ,
    [sUserName]
  FROM audit.VehicleProfile_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- Vehicles
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].Vehicles;

  INSERT INTO [StageUser1].Vehicles
  (
    [OrganisationKey]        ,
    [RID]                    ,
    [ChangeDate]             ,
    [Operation]              ,
    [UpdateMask]             ,
    [ChangeVersion]          ,
    [VehicleGUID]            ,
    [iVehicleID]             ,
    [liSiteID]               ,
    [liGroupID]              ,
    [sDesc]                  ,
    [sRegNo]                 ,
    [ucUnitType]             ,
    [liLastServiceKey]       ,
    [fNextServiceKm]         ,
    [fServiceKm]             ,
    [fRemindKm]              ,
    [dtNextServiceDate]      ,
    [ucServiceMonths]        ,
    [ucRemindWeeks]          ,
    [liNextServiceSeconds]   ,
    [liServiceSeconds]       ,
    [liRemindSeconds]        ,
    [dtLastLicense]          ,
    [dtNextLicense]          ,
    [ucLicenseInterval]      ,
    [ucLicenseRemind]        ,
    [dtLastCOR]              ,
    [dtNextCOR]              ,
    [ucCORInterval]          ,
    [ucCORRemind]            ,
    [bServiceKm]             ,
    [bServiceDate]           ,
    [bServiceHours]          ,
    [bLicense]               ,
    [bCOR]                   ,
    [bActive]                ,
    [sActiveReason]          ,
    [ucActiveState]          ,
    [iDefaultDriver]         ,
    [fTargetConsumption]     ,
    [fTargetHourlyConsumption]
  )
  SELECT
    [OrganisationKey]        ,
    [HostRID]                ,
    [ChangeDate]             ,
    [Operation]              ,
    [UpdateMask]             ,
    [ChangeVersion]          ,
    [VehicleGUID]            ,
    [iVehicleID]             ,
    [liSiteID]               ,
    [liGroupID]              ,
    [sDesc]                  ,
    [sRegNo]                 ,
    [ucUnitType]             ,
    [liLastServiceKey]       ,
    [fNextServiceKm]         ,
    [fServiceKm]             ,
    [fRemindKm]              ,
    [dtNextServiceDate]      ,
    [ucServiceMonths]        ,
    [ucRemindWeeks]          ,
    [liNextServiceSeconds]   ,
    [liServiceSeconds]       ,
    [liRemindSeconds]        ,
    [dtLastLicense]          ,
    [dtNextLicense]          ,
    [ucLicenseInterval]      ,
    [ucLicenseRemind]        ,
    [dtLastCOR]              ,
    [dtNextCOR]              ,
    [ucCORInterval]          ,
    [ucCORRemind]            ,
    [bServiceKm]             ,
    [bServiceDate]           ,
    [bServiceHours]          ,
    [bLicense]               ,
    [bCOR]                   ,
    [bActive]                ,
    [sActiveReason]          ,
    [ucActiveState]          ,
    [iDefaultDriver]         ,
    [fTargetConsumption]     ,
    [fTargetHourlyConsumption]
  FROM audit.Vehicles_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;

  --------------------------------
  -- VehicleTriggers
  SELECT @firstAuditRecordHostRID = MIN(RID)
  FROM [StageUser1].VehicleTriggers;

  INSERT INTO [StageUser1].VehicleTriggers
  (
    [OrganisationKey],
    [RID]            ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [iEventID]       ,
    [ucTriggerID]    ,
    [lfValue]        ,
    [sUserName]
  )
  SELECT
    [OrganisationKey],
    [HostRID]        ,
    [ChangeDate]     ,
    [Operation]      ,
    [UpdateMask]     ,
    [ChangeVersion]  ,
    [iVehicleID]     ,
    [iEventID]       ,
    [ucTriggerID]    ,
    [lfValue]        ,
    [sUserName]
  FROM audit.VehicleTriggers_CT a WITH (NOLOCK)
  WHERE
       a.OrganisationKey = @organisationKey
  AND (a.HostRID         < @firstAuditRecordHostRID
  OR   @firstAuditRecordHostRID IS NULL);
  SELECT @numberOfRecordsAffected = ISNULL(@numberOfRecordsAffected,0) + @@ROWCOUNT;
  
  SELECT NumberOfRecordsAffected = @numberOfRecordsAffected;

  RETURN 0;
END; -- end proc

GO
/****** Object:  StoredProcedure [StageUser1].[sprScoredEvents_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprScoredEvents_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].ScoredEvents_CT  AS tar
      USING [StageUser1].ScoredEvents AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate       = stg.ChangeDate      ,
            tar.Operation        = stg.Operation       ,
            tar.UpdateMask       = stg.UpdateMask      ,
            tar.ChangeVersion    = stg.ChangeVersion   ,
            tar.iEventID         = stg.iEventID        ,
            tar.ucScoreWeight    = stg.ucScoreWeight   ,
            tar.lfScoreDuration  = stg.lfScoreDuration ,
            tar.lfScoreSeverity  = stg.lfScoreSeverity ,
            tar.ucScoreTriggerID = stg.ucScoreTriggerID,
            tar.UpdateBatchKey   = @batchKey,
            tar.sUserName        = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey ,
            HostRID         ,
            ChangeDate      ,
            Operation       ,
            UpdateMask      ,
            ChangeVersion   ,
            iEventID        ,
            ucScoreWeight   ,
            lfScoreDuration ,
            lfScoreSeverity ,
            ucScoreTriggerID,
            CreateBatchKey  ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey    ,
            stg.RID             ,
            stg.ChangeDate      ,
            stg.Operation       ,
            stg.UpdateMask      ,
            stg.ChangeVersion   ,
            stg.iEventID        ,
            stg.ucScoreWeight   ,
            stg.lfScoreDuration ,
            stg.lfScoreSeverity ,
            stg.ucScoreTriggerID,
            @batchKey           ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprSites_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprSites_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Sites_CT  AS tar
      USING [StageUser1].Sites AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.SiteGUID       = stg.SiteGUID     ,
            tar.liSiteID       = stg.liSiteID     ,
            tar.sName          = stg.sName        ,
            tar.UpdateBatchKey = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            SiteGUID       ,
            liSiteID       ,
            sName          ,
            CreateBatchKey ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.SiteGUID     ,
            stg.liSiteID     ,
            stg.sName        ,
            @batchKey        ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprSTAGE_VehicleDeviceProperties_GetForVehicleDevice]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprSTAGE_VehicleDeviceProperties_GetForVehicleDevice]
	@vehicleHostID [smallint],
	@deviceHostID [int]
AS
--  SET NOCOUNT ON;  CANNOT SET as this is called from SQLCLR function!

SELECT
  Operation,
  PropertyName,
  PropertyValue
FROM
  [StageUser1].STAGE_VehicleDeviceProperties
WHERE
  VehicleHostID = @vehicleHostID
  AND DeviceHostID = @deviceHostID;

RETURN;

GO
/****** Object:  StoredProcedure [StageUser1].[sprSTAGE_VehicleTriggers_GetForVehicleEvent]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprSTAGE_VehicleTriggers_GetForVehicleEvent]
	@vehicleHostID [smallint],
	@eventHostID [smallint]
AS
--  SET NOCOUNT ON;  CANNOT SET as this is called from SQLCLR function!

SELECT
  TriggerID,
  Operation,
  Sequence,
  ParameterKey,
  Operator,
  ThresholdValue,
  Required,
  JoinOperator
FROM
  [StageUser1].STAGE_VehicleTriggers
WHERE
  VehicleHostID = @vehicleHostID
  AND EventHostID = @eventHostID

RETURN;

GO
/****** Object:  StoredProcedure [StageUser1].[sprTachoData_RemoveNonTrackedChanges]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprTachoData_RemoveNonTrackedChanges]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  EXEC [Control].strProcProgressMonitor_Set
    @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 1. Start';
  END;

  --------------------------------------------------------------------
  -- 1. Remove records from Stage source table
  --------------------------------------------------------------------

  DELETE td
  FROM
    [StageUser1].TachoData         td
      INNER JOIN
    [MiXData].[dbo].FACT_TachoData fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                     AND td.RID           = fact.HostID
  WHERE
    CHECKSUM
    (
      CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),td.StartDate)),
      CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),td.EndDate))
    )
      =
    CHECKSUM
    (
      CONVERT(DATETIME,NULLIF(fact.TachoStartDateTime,'0001-01-01 00:00:00 +00:00')),
      CONVERT(DATETIME,NULLIF(fact.TachoEndDateTime,'0001-01-01 00:00:00 +00:00'))
    );

  SELECT @recordsDeleted = @@ROWCOUNT;

  --------------------------------------------------------------------
  -- 2. Return values for Performance Monitoring
  --------------------------------------------------------------------
  EXEC [Control].strProcProgressMonitor_Set
    @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Return values for Performance Monitoring';
  END;

  SELECT RecordsDeleted  = isnull(@recordsDeleted ,0);

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprTachoData_RemoveNonTrackedChanges_DataStream]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprTachoData_RemoveNonTrackedChanges_DataStream]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  --------------------------------------------------------------------
  -- 0. Remove resequenced records from Stage source table
  --------------------------------------------------------------------
  DELETE td
  FROM
    [StageUser1].TachoData td
      INNER JOIN
    [MiXData].[dbo].FACT_TachoData fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                        AND td.RID           = fact.HostID
  WHERE td.Operation   = 'U'
  AND td.BlockSequence < 0;

  --------------------------------------------------------------------
  -- 1. Identify records from Stage source table
  --------------------------------------------------------------------
--  ignore where swap unit has updated TripNumber
  SELECT
    td.RID,
    DWTachoStartDateTime = CONVERT(DATETIME,NULLIF(fact.TachoStartDateTime,'0001-01-01 00:00:00 +00:00')),
    td.StartDate,
    DWTachoEndDateTime   = CONVERT(DATETIME,NULLIF(fact.TachoEndDateTime,'0001-01-01 00:00:00 +00:00')),
    td.EndDate
  FROM
    [StageUser1].TachoData td
      INNER JOIN
    [MiXData].[dbo].FACT_TachoData fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                        AND td.RID           = fact.HostID
  WHERE
    td.Operation = 'U';

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprTachoData_RemoveNonTrackedChanges_Remove]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprTachoData_RemoveNonTrackedChanges_Remove]
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @RecordsDeleted INT;

  DELETE td
  FROM
    [StageUser1].TachoData td
      INNER JOIN
    [StageUser1].STAGE_FACT_TachoData_NonTrackedChanges tnc WITH (NOLOCK) ON tnc.RID = td.RID;

  SELECT RecordsDeleted = ISNULL(@@ROWCOUNT,0);

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprTerminalData_RemoveNonTrackedChanges]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprTerminalData_RemoveNonTrackedChanges]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  CREATE TABLE #Vehicles
  ( 
    VehicleKey INT PRIMARY KEY CLUSTERED,
    HostID     SMALLINT 
  );

  CREATE TABLE #Drivers
  ( 
    DriverKey  INT PRIMARY KEY CLUSTERED,
    HostID     SMALLINT
  );

  EXEC [Control].strProcProgressMonitor_Set
    @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Start';
  END;

  INSERT INTO #Vehicles
  ( 
    VehicleKey,
    HostID    
  )
  SELECT
    dvh.VehicleKey,
    dvh.HostID
  FROM [MiXData].[dbo].DIM_Vehicles dvh  WITH (NOLOCK)
  WHERE dvh.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    dvh.VehicleKey,
    dvh.HostID
  FROM [MiXData].[dbo].DIM_Vehicles dvh  WITH (NOLOCK)
  WHERE dvh.VehicleKey = -1;

  INSERT INTO #Drivers
  ( 
    DriverKey,
    HostID    
  )
  SELECT
    dd.DriverKey,
    dd.HostID
  FROM [MiXData].[dbo].DIM_Drivers dd  WITH (NOLOCK)
  WHERE dd.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    dd.DriverKey,
    dd.HostID
  FROM [MiXData].[dbo].DIM_Drivers dd  WITH (NOLOCK)
  WHERE dd.DriverKey = -1;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0.1 Get org DIM data';
  END;

  --------------------------------------------------------------------
  -- 1. Remove records from Stage source table
  --------------------------------------------------------------------
  --  ignore where Driver ID set to 0 (assume cause is driverID deleted)
  ;WITH
  UpdatedTerminalData AS
  (
    SELECT
      fact.HostID,
      fact.VehicleKey,
      fact.DriverKey,
      fact.Odometer,
      fact.MenuID,
      fact.ValueType,
      fact.TerminalDateTime,
      fact.MenuItemCode,
      fact.NumberValue,
      fact.StringValue
    FROM
      [StageUser1].TerminalData td
        INNER JOIN
      [MiXData].[dbo].FACT_TerminalDetails fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                                AND td.EventKey      = fact.HostID
  )
  DELETE td
  FROM
    [StageUser1].TerminalData td
      INNER JOIN
    UpdatedTerminalData       fact ON td.EventKey     = fact.HostID
      INNER JOIN
    #Vehicles                 veh  ON fact.VehicleKey = veh.VehicleKey
      INNER JOIN
    #Drivers                  drv  ON fact.DriverKey  = drv.DriverKey
  WHERE
    CHECKSUM
    (
      td.VehicleID,
      td.Odometer,
      td.MenuID,
      td.ValueType,
      CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),td.EventDate)),
      td.MenuItemCode,
      td.NumberValue,
      td.StringValue
    )
      =
    CHECKSUM
    (
      veh.HostID,
      fact.Odometer,
      fact.MenuID,
      fact.ValueType,
      CONVERT(DATETIME,NULLIF(fact.TerminalDateTime,'0001-01-01 00:00:00 +00:00')),
      fact.MenuItemCode,
      fact.NumberValue,
      fact.StringValue
    )
  AND (td.DriverID = 0
  OR   td.DriverID = drv.HostID);

  SELECT @recordsDeleted = @@ROWCOUNT;

  --------------------------------------------------------------------
  -- 2. Return values for Performance Monitoring
  --------------------------------------------------------------------
  EXEC [Control].strProcProgressMonitor_Set
    @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Return values for Performance Monitoring';
  END;

  SELECT RecordsDeleted  = isnull(@recordsDeleted ,0);

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprTerminalData_RemoveNonTrackedChanges_DataStream]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprTerminalData_RemoveNonTrackedChanges_DataStream]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  --------------------------------------------------------------------
  -- 0. Remove resequenced records from Stage source table
  --------------------------------------------------------------------
  ;WITH
  Vehicles AS
  (
    SELECT
      dvh.VehicleKey,
      VehicleID = dvh.HostID
    FROM
      [MiXData].[dbo].DIM_Vehicles dvh WITH (NOLOCK)
    WHERE dvh.OrganisationKey  = @organisationKey
  )
  DELETE td
  FROM
    [StageUser1].TerminalData td
      INNER JOIN
    [MiXData].[dbo].FACT_TerminalDetails fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                           AND td.EventKey      = fact.HostID
      INNER JOIN
    Vehicles                             veh  WITH (NOLOCK) ON fact.VehicleKey  = veh.VehicleKey
  WHERE
      td.Operation      = 'U'
  AND (td.DriverID      = 0
  OR   td.BlockSequence < 0);

  --------------------------------------------------------------------
  -- 1. Identify records from Stage source table
  --------------------------------------------------------------------
  --  ignore where Driver ID set to 0 (assume cause is driverID deleted)
  ;WITH
  Vehicles AS
  (
    SELECT
      dvh.VehicleKey,
      VehicleID = dvh.HostID
    FROM
      [MiXData].[dbo].DIM_Vehicles dvh WITH (NOLOCK)
    WHERE dvh.OrganisationKey  = @organisationKey
  )
  SELECT
    td.EventKey,
    DWVehicleID = veh.VehicleID,
    td.VehicleID,
    DWTerminalDateTime = CONVERT(DATETIME,NULLIF(fact.TerminalDateTime,'0001-01-01 00:00:00 +00:00')),
    td.EventDate,
    DWOdometer  = fact.Odometer,
    td.Odometer,
    DWMenuID    = fact.MenuID,
    td.MenuID,
    DWValueType = fact.ValueType,
    td.ValueType,
    DWMenuItemCode = fact.MenuItemCode,
    td.MenuItemCode,
    DWNumberValue  = fact.NumberValue,
    td.NumberValue,
    DWStringValue  = fact.StringValue,
    td.StringValue
  FROM
    [StageUser1].TerminalData td
      INNER JOIN
    [MiXData].[dbo].FACT_TerminalDetails fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                           AND td.EventKey      = fact.HostID
      INNER JOIN
    Vehicles                             veh  WITH (NOLOCK) ON fact.VehicleKey  = veh.VehicleKey
  WHERE
      td.Operation     = 'U';

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprTerminalData_RemoveNonTrackedChanges_Remove]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprTerminalData_RemoveNonTrackedChanges_Remove]
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @RecordsDeleted INT;

  DELETE td
  FROM
    [StageUser1].TerminalData td
      INNER JOIN
    [StageUser1].STAGE_FACT_TerminalDetails_NonTrackedChanges tnc WITH (NOLOCK) ON tnc.EventKey = td.EventKey;
  
  SELECT RecordsDeleted = ISNULL(@@ROWCOUNT,0);

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprTrailers_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprTrailers_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Trailers_CT  AS tar
      USING [StageUser1].Trailers AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate        = stg.ChangeDate       ,
            tar.Operation         = stg.Operation        ,
            tar.UpdateMask        = stg.UpdateMask       ,
            tar.ChangeVersion     = stg.ChangeVersion    ,
            tar.TrailerGUID       = stg.TrailerGUID      ,
            tar.liTrailerID       = stg.liTrailerID      ,
            tar.sDescription      = stg.sDescription     ,
            tar.sRegNo            = stg.sRegNo           ,
            tar.sAssetNumber      = stg.sAssetNumber     ,
            tar.fSetOdometer      = stg.fSetOdometer     ,
            tar.dtOdometerChanged = stg.dtOdometerChanged,
            tar.dtPrevService     = stg.dtPrevService    ,
            tar.dtNextService     = stg.dtNextService    ,
            tar.iServIntTime      = stg.iServIntTime     ,
            tar.fPrevService      = stg.fPrevService     ,
            tar.fNextService      = stg.fNextService     ,
            tar.fServIntDistance  = stg.fServIntDistance ,
            tar.UpdateBatchKey    = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey  ,
            HostRID          ,
            ChangeDate       ,
            Operation        ,
            UpdateMask       ,
            ChangeVersion    ,
            TrailerGUID      ,
            liTrailerID      ,
            sDescription     ,
            sRegNo           ,
            sAssetNumber     ,
            fSetOdometer     ,
            dtOdometerChanged,
            dtPrevService    ,
            dtNextService    ,
            iServIntTime     ,
            fPrevService     ,
            fNextService     ,
            fServIntDistance ,
            CreateBatchKey   ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey     ,
            stg.RID              ,
            stg.ChangeDate       ,
            stg.Operation        ,
            stg.UpdateMask       ,
            stg.ChangeVersion    ,
            stg.TrailerGUID      ,
            stg.liTrailerID      ,
            stg.sDescription     ,
            stg.sRegNo           ,
            stg.sAssetNumber     ,
            stg.fSetOdometer     ,
            stg.dtOdometerChanged,
            stg.dtPrevService    ,
            stg.dtNextService    ,
            stg.iServIntTime     ,
            stg.fPrevService     ,
            stg.fNextService     ,
            stg.fServIntDistance ,
            @batchKey            ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprTrailerUnitIDs_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprTrailerUnitIDs_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].TrailerUnitIDs_CT  AS tar
      USING [StageUser1].TrailerUnitIDs AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.liUnitID       = stg.liUnitID     ,
            tar.liTrailerID    = stg.liTrailerID  ,
            tar.dtAttached     = stg.dtAttached   ,
            tar.UpdateBatchKey = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            liUnitID       ,
            liTrailerID    ,
            dtAttached     ,
            CreateBatchKey ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey,
            stg.RID,
            stg.ChangeDate,
            stg.Operation,
            stg.UpdateMask,
            stg.ChangeVersion,
            stg.liUnitID,
            stg.liTrailerID,
            stg.dtAttached,
            @batchKey       ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprTripData_RemoveNonTrackedChanges]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprTripData_RemoveNonTrackedChanges]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  CREATE TABLE #Vehicles
  ( 
    VehicleKey INT PRIMARY KEY CLUSTERED,
    HostID     SMALLINT 
  );

  CREATE TABLE #Drivers
  ( 
    DriverKey  INT PRIMARY KEY CLUSTERED,
    HostID     SMALLINT
  );

  EXEC [Control].strProcProgressMonitor_Set
    @flag='Start', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0, @isStartFlag=1;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0. Start';
  END;

  INSERT INTO #Vehicles
  ( 
    VehicleKey,
    HostID    
  )
  SELECT
    dvh.VehicleKey,
    dvh.HostID
  FROM [MiXData].[dbo].DIM_Vehicles dvh  WITH (NOLOCK)
  WHERE dvh.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    dvh.VehicleKey,
    dvh.HostID
  FROM [MiXData].[dbo].DIM_Vehicles dvh  WITH (NOLOCK)
  WHERE dvh.VehicleKey = -1;

  INSERT INTO #Drivers
  ( 
    DriverKey,
    HostID    
  )
  SELECT
    dd.DriverKey,
    dd.HostID
  FROM [MiXData].[dbo].DIM_Drivers dd  WITH (NOLOCK)
  WHERE dd.OrganisationKey = @organisationKey
  UNION ALL
  SELECT
    dd.DriverKey,
    dd.HostID
  FROM [MiXData].[dbo].DIM_Drivers dd  WITH (NOLOCK)
  WHERE dd.DriverKey = -1;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 0.1 Get org DIM data';
  END;

  --------------------------------------------------------------------
  -- 1. Remove records from Stage source table
  --------------------------------------------------------------------
  --  ignore where Driver ID set to 0 (assume cause is driverID deleted)
  --  and where swap unit has updated TripNumber
  ;WITH
  UpdatedTripData AS
  (
    SELECT
      fact.HostID,
      fact.VehicleKey,
      fact.DriverKey,
      fact.UnitTripNumber,
      fact.ActivityStartDateTime,
      fact.ActivityEndDateTime
    FROM
      [StageUser1].TripData td
        INNER JOIN
      [MiXData].[dbo].FACT_ActivitySummary fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                                AND td.TripID        = fact.HostID
  )
  DELETE td
  FROM
    [StageUser1].TripData td
      INNER JOIN
    UpdatedTripData       fact ON td.TripID       = fact.HostID
      INNER JOIN
    #Vehicles             veh  ON fact.VehicleKey = veh.VehicleKey
      INNER JOIN
    #Drivers              drv  ON fact.DriverKey  = drv.DriverKey
  WHERE
    CHECKSUM
    (
      td.VehicleID,
      CONVERT(BIGINT,td.TripNumber),
      CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),td.TripStart)),
      CONVERT(DATETIME,CONVERT(DATETIMEOFFSET(0),td.TripEnd))
    )
      =
    CHECKSUM
    (
      veh.HostID,
      fact.UnitTripNumber,
      CONVERT(DATETIME,NULLIF(fact.ActivityStartDateTime,'0001-01-01 00:00:00 +00:00')),
      CONVERT(DATETIME,NULLIF(fact.ActivityEndDateTime,'0001-01-01 00:00:00 +00:00'))
    )
  AND (td.DriverID = 0
  OR   td.DriverID = drv.HostID);

  SELECT @recordsDeleted = @@ROWCOUNT;

  --------------------------------------------------------------------
  -- 2. Return values for Performance Monitoring
  --------------------------------------------------------------------
  EXEC [Control].strProcProgressMonitor_Set
    @flag='End', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=@recordsDeleted;

  IF @debugMode = 1  -- DebugMode is true
  BEGIN
    PRINT CONVERT(NVARCHAR(20),CONVERT(TIME,GETDATE())) + N' 2. Return values for Performance Monitoring';
  END;

  SELECT RecordsDeleted  = isnull(@recordsDeleted ,0);

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprTripData_RemoveNonTrackedChanges_DataStream]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprTripData_RemoveNonTrackedChanges_DataStream]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 0. Remove resequenced records from Stage source table
  --------------------------------------------------------------------
  DELETE td
  FROM
    [StageUser1].TripData td
      INNER JOIN
    [MiXData].[dbo].FACT_ActivitySummary fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                           AND td.TripID        = fact.HostID
  WHERE
      td.Operation   = 'U'
  AND (td.TripNumber < 0
  OR   td.DriverID   = 0);

  --------------------------------------------------------------------
  -- 1. Identify records from Stage source table
  --------------------------------------------------------------------
  --  ignore where Driver ID set to 0 (assume cause is driverID deleted)
  --  and where swap unit has updated TripNumber
  SELECT
    td.TripID,
    DWTripNumber = fact.UnitTripNumber,
    td.TripNumber,
    DWActivityStartDateTime = CONVERT(DATETIME,NULLIF(fact.ActivityStartDateTime,'0001-01-01 00:00:00 +00:00')),
    td.TripStart,
    DWActivityEndDateTime   = CONVERT(DATETIME,NULLIF(fact.ActivityEndDateTime,'0001-01-01 00:00:00 +00:00')),
    td.TripEnd
  FROM
    [StageUser1].TripData td
      INNER JOIN
    [MiXData].[dbo].FACT_ActivitySummary fact WITH (NOLOCK) ON @organisationKey = fact.OrganisationKey
                                                           AND td.TripID        = fact.HostID
  WHERE
    td.Operation  = 'U';

  RETURN 0;

END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprTripData_RemoveNonTrackedChanges_Remove]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprTripData_RemoveNonTrackedChanges_Remove]
AS
BEGIN
  SET NOCOUNT ON;

  DECLARE @recordsDeleted  int;

  DELETE td
  FROM
    [StageUser1].[TripData] td
      INNER JOIN
    [StageUser1].STAGE_FACT_ActivitySummary_NonTrackedChanges anc WITH (NOLOCK) ON anc.TripID = td.TripID;

  SELECT RecordsDeleted = ISNULL(@@ROWCOUNT,0);

  RETURN 0;
END;

GO
/****** Object:  StoredProcedure [StageUser1].[sprVehicleDeviceParam_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprVehicleDeviceParam_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].VehicleDeviceParam_CT  AS tar
      USING [StageUser1].VehicleDeviceParam AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate    ,
            tar.Operation      = stg.Operation     ,
            tar.UpdateMask     = stg.UpdateMask    ,
            tar.ChangeVersion  = stg.ChangeVersion ,
            tar.iVehicleID     = stg.iVehicleID    ,
            tar.liDeviceID     = stg.liDeviceID    ,
            tar.iParameterID   = stg.iParameterID  ,
            tar.lfCalibration1 = stg.lfCalibration1,
            tar.lfValue1       = stg.lfValue1      ,
            tar.lfCalibration2 = stg.lfCalibration2,
            tar.lfValue2       = stg.lfValue2      ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iVehicleID     ,
            liDeviceID     ,
            iParameterID   ,
            lfCalibration1 ,
            lfValue1       ,
            lfCalibration2 ,
            lfValue2       ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey  ,
            stg.RID           ,
            stg.ChangeDate    ,
            stg.Operation     ,
            stg.UpdateMask    ,
            stg.ChangeVersion ,
            stg.iVehicleID    ,
            stg.liDeviceID    ,
            stg.iParameterID  ,
            stg.lfCalibration1,
            stg.lfValue1      ,
            stg.lfCalibration2,
            stg.lfValue2      ,
            @batchKey         ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprVehicleDeviceProperties_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprVehicleDeviceProperties_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].VehicleDeviceProperties_CT  AS tar
      USING [StageUser1].VehicleDeviceProperties AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iVehicleID     = stg.iVehicleID   ,
            tar.liDeviceID     = stg.liDeviceID   ,
            tar.sProperty      = stg.sProperty    ,
            tar.sValue         = stg.sValue       ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iVehicleID     ,
            liDeviceID     ,
            sProperty      ,
            sValue         ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.iVehicleID   ,
            stg.liDeviceID   ,
            stg.sProperty    ,
            stg.sValue       ,
            @batchKey        ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprVehicleDevices_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprVehicleDevices_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].VehicleDevices_CT  AS tar
      USING [StageUser1].VehicleDevices AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate      = stg.ChangeDate     ,
            tar.Operation       = stg.Operation      ,
            tar.UpdateMask      = stg.UpdateMask     ,
            tar.ChangeVersion   = stg.ChangeVersion  ,
            tar.iVehicleID      = stg.iVehicleID     ,
            tar.liDeviceID      = stg.liDeviceID     ,
            tar.sInputID        = stg.sInputID       ,
            tar.bIsActive       = stg.bIsActive      ,
            tar.bRecordInterval = stg.bRecordInterval,
            tar.liPowerDeviceID = stg.liPowerDeviceID,
            tar.UpdateBatchKey  = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iVehicleID     ,
            liDeviceID     ,
            sInputID       ,
            bIsActive      ,
            bRecordInterval,
            liPowerDeviceID,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey   ,
            stg.RID            ,
            stg.ChangeDate     ,
            stg.Operation      ,
            stg.UpdateMask     ,
            stg.ChangeVersion  ,
            stg.iVehicleID     ,
            stg.liDeviceID     ,
            stg.sInputID       ,
            stg.bIsActive      ,
            stg.bRecordInterval,
            stg.liPowerDeviceID,
            @batchKey          ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprVehicleEvent_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprVehicleEvent_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].VehicleEvent_CT  AS tar
      USING [StageUser1].VehicleEvent AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate              = stg.ChangeDate             ,
            tar.Operation               = stg.Operation              ,
            tar.UpdateMask              = stg.UpdateMask             ,
            tar.ChangeVersion           = stg.ChangeVersion          ,
            tar.iVehicleID              = stg.iVehicleID             ,
            tar.iEventID                = stg.iEventID               ,
            tar.ucEventType             = stg.ucEventType            ,
            tar.bInUse                  = stg.bInUse                 ,
            tar.bStartOdo               = stg.bStartOdo              ,
            tar.bStartPosition          = stg.bStartPosition         ,
            tar.bEndOdo                 = stg.bEndOdo                ,
            tar.bEndPosition            = stg.bEndPosition           ,
            tar.bRecordF3Count          = stg.bRecordF3Count         ,
            tar.bWarningMessage         = stg.bWarningMessage        ,
            tar.bActivePosition         = stg.bActivePosition        ,
            tar.iRecordTime             = stg.iRecordTime            ,
            tar.iAlarmTime              = stg.iAlarmTime             ,
            tar.iRelayTime              = stg.iRelayTime             ,
            tar.iRelay2Time             = stg.iRelay2Time            ,
            tar.iCriticalTime           = stg.iCriticalTime          ,
            tar.iActiveTime             = stg.iActiveTime            ,
            tar.iActiveEndTime          = stg.iActiveEndTime         ,
            tar.iTrackTime              = stg.iTrackTime             ,
            tar.iTrackInterval          = stg.iTrackInterval         ,
            tar.ucAlarmState            = stg.ucAlarmState           ,
            tar.ucRelayState            = stg.ucRelayState           ,
            tar.ucRelay2State           = stg.ucRelay2State          ,
            tar.sWarningMessage         = stg.sWarningMessage        ,
            tar.ucPriority              = stg.ucPriority             ,
            tar.dtLastEventNotification = stg.dtLastEventNotification,
            tar.UpdateBatchKey          = @batchKey,
            tar.sUserName               = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey        ,
            HostRID                ,
            ChangeDate             ,
            Operation              ,
            UpdateMask             ,
            ChangeVersion          ,
            iVehicleID             ,
            iEventID               ,
            ucEventType            ,
            bInUse                 ,
            bStartOdo              ,
            bStartPosition         ,
            bEndOdo                ,
            bEndPosition           ,
            bRecordF3Count         ,
            bWarningMessage        ,
            bActivePosition        ,
            iRecordTime            ,
            iAlarmTime             ,
            iRelayTime             ,
            iRelay2Time            ,
            iCriticalTime          ,
            iActiveTime            ,
            iActiveEndTime         ,
            iTrackTime             ,
            iTrackInterval         ,
            ucAlarmState           ,
            ucRelayState           ,
            ucRelay2State          ,
            sWarningMessage        ,
            ucPriority             ,
            dtLastEventNotification,
            CreateBatchKey         ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey           ,
            stg.RID                    ,
            stg.ChangeDate             ,
            stg.Operation              ,
            stg.UpdateMask             ,
            stg.ChangeVersion          ,
            stg.iVehicleID             ,
            stg.iEventID               ,
            stg.ucEventType            ,
            stg.bInUse                 ,
            stg.bStartOdo              ,
            stg.bStartPosition         ,
            stg.bEndOdo                ,
            stg.bEndPosition           ,
            stg.bRecordF3Count         ,
            stg.bWarningMessage        ,
            stg.bActivePosition        ,
            stg.iRecordTime            ,
            stg.iAlarmTime             ,
            stg.iRelayTime             ,
            stg.iRelay2Time            ,
            stg.iCriticalTime          ,
            stg.iActiveTime            ,
            stg.iActiveEndTime         ,
            stg.iTrackTime             ,
            stg.iTrackInterval         ,
            stg.ucAlarmState           ,
            stg.ucRelayState           ,
            stg.ucRelay2State          ,
            stg.sWarningMessage        ,
            stg.ucPriority             ,
            stg.dtLastEventNotification,
            @batchKey                  ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprVehicleProfile_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprVehicleProfile_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].VehicleProfile_CT  AS tar
      USING [StageUser1].VehicleProfile AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iVehicleID     = stg.iVehicleID   ,
            tar.iParameterID   = stg.iParameterID ,
            tar.ucSeq          = stg.ucSeq        ,
            tar.lfValue        = stg.lfValue      ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iVehicleID     ,
            iParameterID   ,
            ucSeq          ,
            lfValue        ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey ,
            stg.RID          ,
            stg.ChangeDate   ,
            stg.Operation    ,
            stg.UpdateMask   ,
            stg.ChangeVersion,
            stg.iVehicleID   ,
            stg.iParameterID ,
            stg.ucSeq        ,
            stg.lfValue      ,
            @batchKey        ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprVehicles_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprVehicles_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].Vehicles_CT  AS tar
      USING [StageUser1].Vehicles AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate                 = stg.ChangeDate                ,
            tar.Operation                  = stg.Operation                 ,
            tar.UpdateMask                 = stg.UpdateMask                ,
            tar.ChangeVersion              = stg.ChangeVersion             ,
            tar.VehicleGUID                = stg.VehicleGUID               ,
            tar.iVehicleID                 = stg.iVehicleID                ,
            tar.liSiteID                   = stg.liSiteID                  ,
            tar.liGroupID                  = stg.liGroupID                 ,
            tar.sDesc                      = stg.sDesc                     ,
            tar.sRegNo                     = stg.sRegNo                    ,
            tar.ucUnitType                 = stg.ucUnitType                ,
            tar.liLastServiceKey           = stg.liLastServiceKey          ,
            tar.fNextServiceKm             = stg.fNextServiceKm            ,
            tar.fServiceKm                 = stg.fServiceKm                ,
            tar.fRemindKm                  = stg.fRemindKm                 ,
            tar.dtNextServiceDate          = stg.dtNextServiceDate         ,
            tar.ucServiceMonths            = stg.ucServiceMonths           ,
            tar.ucRemindWeeks              = stg.ucRemindWeeks             ,
            tar.liNextServiceSeconds       = stg.liNextServiceSeconds      ,
            tar.liServiceSeconds           = stg.liServiceSeconds          ,
            tar.liRemindSeconds            = stg.liRemindSeconds           ,
            tar.dtLastLicense              = stg.dtLastLicense             ,
            tar.dtNextLicense              = stg.dtNextLicense             ,
            tar.ucLicenseInterval          = stg.ucLicenseInterval         ,
            tar.ucLicenseRemind            = stg.ucLicenseRemind           ,
            tar.dtLastCOR                  = stg.dtLastCOR                 ,
            tar.dtNextCOR                  = stg.dtNextCOR                 ,
            tar.ucCORInterval              = stg.ucCORInterval             ,
            tar.ucCORRemind                = stg.ucCORRemind               ,
            tar.bServiceKm                 = stg.bServiceKm                ,
            tar.bServiceDate               = stg.bServiceDate              ,
            tar.bServiceHours              = stg.bServiceHours             ,
            tar.bLicense                   = stg.bLicense                  ,
            tar.bCOR                       = stg.bCOR                      ,
            tar.bActive                    = stg.bActive                   ,
            tar.sActiveReason              = stg.sActiveReason             ,
            tar.ucActiveState              = stg.ucActiveState             ,
            tar.iDefaultDriver             = stg.iDefaultDriver            ,
            tar.fTargetConsumption         = stg.fTargetConsumption        ,
            tar.fTargetHourlyConsumption   = stg.fTargetHourlyConsumption  ,
            tar.UpdateBatchKey = @batchKey
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey   ,
            HostRID           ,
            ChangeDate                ,
            Operation                 ,
            UpdateMask                ,
            ChangeVersion             ,
            VehicleGUID               ,
            iVehicleID                ,
            liSiteID                  ,
            liGroupID                 ,
            sDesc                     ,
            sRegNo                    ,
            ucUnitType                ,
            liLastServiceKey          ,
            fNextServiceKm            ,
            fServiceKm                ,
            fRemindKm                 ,
            dtNextServiceDate         ,
            ucServiceMonths           ,
            ucRemindWeeks             ,
            liNextServiceSeconds      ,
            liServiceSeconds          ,
            liRemindSeconds           ,
            dtLastLicense             ,
            dtNextLicense             ,
            ucLicenseInterval         ,
            ucLicenseRemind           ,
            dtLastCOR                 ,
            dtNextCOR                 ,
            ucCORInterval             ,
            ucCORRemind               ,
            bServiceKm                ,
            bServiceDate              ,
            bServiceHours             ,
            bLicense                  ,
            bCOR                      ,
            bActive                   ,
            sActiveReason             ,
            ucActiveState             ,
            iDefaultDriver            ,
            fTargetConsumption        ,
            fTargetHourlyConsumption  ,
            CreateBatchKey            ,
            UpdateBatchKey
          )
          VALUES
          (
            @organisationKey              ,
            stg.RID                       ,
            stg.ChangeDate                ,
            stg.Operation                 ,
            stg.UpdateMask                ,
            stg.ChangeVersion             ,
            stg.VehicleGUID               ,
            stg.iVehicleID                ,
            stg.liSiteID                  ,
            stg.liGroupID                 ,
            stg.sDesc                     ,
            stg.sRegNo                    ,
            stg.ucUnitType                ,
            stg.liLastServiceKey          ,
            stg.fNextServiceKm            ,
            stg.fServiceKm                ,
            stg.fRemindKm                 ,
            stg.dtNextServiceDate         ,
            stg.ucServiceMonths           ,
            stg.ucRemindWeeks             ,
            stg.liNextServiceSeconds      ,
            stg.liServiceSeconds          ,
            stg.liRemindSeconds           ,
            stg.dtLastLicense             ,
            stg.dtNextLicense             ,
            stg.ucLicenseInterval         ,
            stg.ucLicenseRemind           ,
            stg.dtLastCOR                 ,
            stg.dtNextCOR                 ,
            stg.ucCORInterval             ,
            stg.ucCORRemind               ,
            stg.bServiceKm                ,
            stg.bServiceDate              ,
            stg.bServiceHours             ,
            stg.bLicense                  ,
            stg.bCOR                      ,
            stg.bActive                   ,
            stg.sActiveReason             ,
            stg.ucActiveState             ,
            stg.iDefaultDriver            ,
            stg.fTargetConsumption        ,
            stg.fTargetHourlyConsumption  ,
            @batchKey                     ,
            @batchKey
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  StoredProcedure [StageUser1].[sprVehicleTriggers_MoveToAudit]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [StageUser1].[sprVehicleTriggers_MoveToAudit]
	@batchKey [int],
	@organisationKey [int],
	@debugMode [int] = 0
AS
BEGIN
  SET NOCOUNT ON;

  --------------------------------------------------------------------
  -- 1. Merge currently extracted records into audit schema for current organisation
  --------------------------------------------------------------------  

  -- Loop is for Deadlock detection only. loop should terminate if no deadlock occurs.
  DECLARE @exceptionCount int = 0;

  WHILE @exceptionCount < 20
  BEGIN

    BEGIN TRY

      BEGIN TRANSACTION;

      MERGE [audit].VehicleTriggers_CT  AS tar
      USING [StageUser1].VehicleTriggers AS stg
         ON tar.OrganisationKey = @organisationKey
        AND tar.HostRID         = stg.RID
        -- Matched
        WHEN MATCHED THEN
          UPDATE
          SET
            tar.ChangeDate     = stg.ChangeDate   ,
            tar.Operation      = stg.Operation    ,
            tar.UpdateMask     = stg.UpdateMask   ,
            tar.ChangeVersion  = stg.ChangeVersion,
            tar.iVehicleID     = stg.iVehicleID   ,
            tar.iEventID       = stg.iEventID     ,
            tar.ucTriggerID    = stg.ucTriggerID  ,
            tar.lfValue        = stg.lfValue      ,
            tar.UpdateBatchKey = @batchKey,
            tar.sUserName      = stg.sUserName
        -- Not Matched
        WHEN NOT MATCHED THEN
          INSERT
          (
            OrganisationKey,
            HostRID        ,
            ChangeDate     ,
            Operation      ,
            UpdateMask     ,
            ChangeVersion  ,
            iVehicleID     ,
            iEventID       ,
            ucTriggerID    ,
            lfValue        ,
            CreateBatchKey ,
            UpdateBatchKey,
            sUserName
          )
          VALUES
          (
            @organisationKey,
            RID             ,
            ChangeDate      ,
            Operation       ,
            UpdateMask      ,
            ChangeVersion   ,
            iVehicleID      ,
            stg.iEventID        ,
            ucTriggerID     ,
            lfValue         ,
            @batchKey       ,
            @batchKey,
            sUserName
          );

          COMMIT TRANSACTION;
          BREAK; -- out of while loop
    END TRY
    -- CATCH Errors
    BEGIN CATCH
      ROLLBACK TRANSACTION;
      SET @exceptionCount += 1;
      IF @exceptionCount < 20 AND ERROR_NUMBER() = 1205 -- DEADLOCK
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey, @reRaiserror = 0;
        IF @debugMode = 1  -- DebugMode is true
        BEGIN
          PRINT '5.error: deadlock occured, restarting merge';
          EXEC [Control].strProcProgressMonitor_Set
            @flag='5.error: deadlock occured, restarting merge', @batchKey=@batchKey, @organisationKey=@organisationKey, @procID=@@PROCID, @nrOfRecordsAffected=0;
        END;
      END;
      ELSE
      BEGIN
        EXEC [Control].sprLogError @organisationKey = @organisationKey;
        RETURN -1;
        BREAK; -- out of while loop
      END;
    END CATCH;
  END; -- end while

  --------------------------------------------------------------------
  RETURN 0;

END; -- END PROC

GO
/****** Object:  UserDefinedFunction [Control].[fncAnalyser_GetNextUTCReloadDate]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [Control].[fncAnalyser_GetNextUTCReloadDate] 
(
  @Offset int,
  @TimeToExecute char(10),
  @DayInterval int   --- currently 1 or 8. 1 is every day, 8 is on sundays
)
RETURNS datetime
AS
BEGIN
  DECLARE @NxtReloadDate datetime;
  DECLARE @CurrentDW     int;

  IF @DayInterval = 1
  BEGIN
    SELECT @NxtReloadDate = dateadd(s,@Offset,cast(cast(cast(DATEADD(day, @DayInterval, GetutcDate())as date) as CHAR(10))+' '+ @TimeToExecute as datetime));
  END		
  ELSE
  BEGIN
    SELECT @Offset    = @Offset*-1;
    SELECT @CurrentDW = DATEPART(dw,getutcdate());
    IF @CurrentDW > @DayInterval
    BEGIN
      SELECT @DayInterval   = 7- (@CurrentDW-@DayInterval);
      SELECT @NxtReloadDate = dateadd(s,@Offset,cast(cast(cast(DATEADD(day, @DayInterval, GetutcDate())as date) as CHAR(10))+' '+ @TimeToExecute as datetime)); 
    END
    ELSE
    BEGIN
      SELECT @DayInterval   = @DayInterval-@CurrentDW;
      SELECT @NxtReloadDate = dateadd(s,@Offset,cast(cast(cast(DATEADD(day, @DayInterval, GetutcDate())as date) as CHAR(10))+' '+ @TimeToExecute as datetime));
    END
  END		

  RETURN @NxtReloadDate;
END;

GO
/****** Object:  UserDefinedFunction [Control].[fncIDFromGUID]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [Control].[fncIDFromGUID]
(
    --@param1     int
)
RETURNS int
AS
BEGIN
  RETURN 42;
END

GO
/****** Object:  UserDefinedFunction [Control].[fncIsBatchInProgress]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [Control].[fncIsBatchInProgress]
( )
RETURNS BIT
AS
BEGIN
  DECLARE @busy bit = 0;
  DECLARE @failed bit = 0;
  SELECT TOP (1)
    @busy = BatchBusy,
    @failed = HasFailed
  FROM
    Control.BatchController
  ORDER BY
    BatchStart DESC

  IF @busy = 1 OR @failed = 1
  BEGIN
    SET @busy = 1
  END

  RETURN @Busy
END

GO
/****** Object:  UserDefinedFunction [dbo].[fncBuildCircle]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncBuildCircle](@longitude [real], @latitude [real], @radius [int])
RETURNS [geography] WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncBuildCircle]
GO
/****** Object:  UserDefinedFunction [dbo].[fncBuildLineFromMapLocationPolygonPoints]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncBuildLineFromMapLocationPolygonPoints](@schemaName [nvarchar](132), @locationID [int])
RETURNS [geography] WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncBuildLineFromMapLocationPolygonPoints]
GO
/****** Object:  UserDefinedFunction [dbo].[fncBuildPoint]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncBuildPoint](@longitude [real], @latitude [real])
RETURNS [geography] WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncBuildPoint]
GO
/****** Object:  UserDefinedFunction [dbo].[fncBuildPolygonFromMapLocationPolygonPoints]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncBuildPolygonFromMapLocationPolygonPoints](@schemaName [nvarchar](132), @locationID [int])
RETURNS [geography] WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncBuildPolygonFromMapLocationPolygonPoints]
GO
/****** Object:  UserDefinedFunction [dbo].[fncBuildRectangle]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncBuildRectangle](@UpperLeftLongitude [real], @UpperLeftLatitude [real], @LowerRightLongitude [real], @LowerRightLatitude [real])
RETURNS [geography] WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncBuildRectangle]
GO
/****** Object:  UserDefinedFunction [dbo].[fncCalculateRoadSpeedOverspeeding]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[fncCalculateRoadSpeedOverspeeding]
(
  @OverSpeedDurationLimit    DECIMAL(9, 6),  -- number between 0 and 100
  @OverSpeedScoreSeverity    DECIMAL(9, 6),
  @EventSpeedLimit           DECIMAL(9, 6),
  @EventSpeed                DECIMAL(9, 6),
  @EventTotalTime            INT,
  @SubTripDuration           INT
)
RETURNS DECIMAL(19, 6)  -- number between 0 and 100
BEGIN

  DECLARE   @MaxSpeed            DECIMAL(9, 6);
  DECLARE   @MaxDurationSeconds  DECIMAL(9, 6);
  DECLARE   @ScoreOnSpeed        DECIMAL(9, 6);
  DECLARE   @ScoreOnDuration     DECIMAL(9, 6);
  DECLARE   @OverallScore        DECIMAL(9, 6);

  --Get the limit speed, if event speed  > limit then Score = 0, else continue with calculation.
  SET @MaxSpeed = @OverSpeedScoreSeverity * @EventSpeedLimit;

  IF @EventSpeed IS NULL
  BEGIN
    SET @ScoreOnSpeed = 50.0;
  END
  ELSE IF @EventSpeed > @MaxSpeed
  BEGIN
    SET @ScoreOnSpeed = 0.0;
  END
  ELSE
  BEGIN
    SET @ScoreOnSpeed = 100.0-((@EventSpeed-@EventSpeedLimit)/((@EventSpeedLimit*@OverSpeedScoreSeverity)-@EventSpeedLimit)*100.0);
  END;

  IF @EventTotalTime IS NULL
  BEGIN
    SET @ScoreOnDuration = 50.0;
  END
  ELSE IF (CONVERT(DECIMAL(19,6),@EventTotalTime)/@SubTripDuration) > @OverSpeedDurationLimit
  BEGIN
    SET @ScoreOnDuration = 0.0;
  END
  ELSE
  BEGIN
    SET @ScoreOnDuration = 100.0-(CONVERT(DECIMAL(19,6),@EventTotalTime)/@SubTripDuration);
  END;

  --Now Merge the 2 scores into 1 Overspeed:Duration -> 1:1  
  SET @OverallScore =  (ISNULL(@ScoreOnSpeed,0.0) + ISNULL(@ScoreOnDuration,0.0))/2.0;

  RETURN @OverallScore;
END;

GO
/****** Object:  UserDefinedFunction [dbo].[fncCalculateRoadSpeedOverspeedingDurationScore]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[fncCalculateRoadSpeedOverspeedingDurationScore]
(
  @OverSpeedDurationFactor   DECIMAL(9, 6),
  @EventTotalTime            INT,
  @SubTripDuration           INT
)
RETURNS DECIMAL(19, 6)  -- number between 0 and 100
BEGIN
  DECLARE   @MaxDurationSeconds  DECIMAL(9, 6);
  DECLARE   @ScoreOnDuration     DECIMAL(9, 6);

  SET @ScoreOnDuration = CASE
                           WHEN ISNULL(@OverSpeedDurationFactor,0.0) <= 0.0
                             THEN 0.0
                           WHEN ISNULL(@SubTripDuration,0.0) <= 0
                             THEN 100.0
                           WHEN (CONVERT(DECIMAL(19,6),@EventTotalTime)/@SubTripDuration) > @OverSpeedDurationFactor
                             THEN 0.0
                           ELSE 100.0-(CONVERT(DECIMAL(19,6),@EventTotalTime)/@SubTripDuration)
                         END;

  RETURN @ScoreOnDuration;
END;

GO
/****** Object:  UserDefinedFunction [dbo].[fncCalculateRoadSpeedOverspeedingSeverityScore]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[fncCalculateRoadSpeedOverspeedingSeverityScore]
(
  @OverSpeedSeverityFactor   DECIMAL(9, 6),
  @EventSpeedLimit           DECIMAL(9, 6),
  @EventSpeed                DECIMAL(9, 6)
)
RETURNS DECIMAL(19, 6)  -- number between 0 and 100
BEGIN
  DECLARE   @MaxSpeed            DECIMAL(9, 6);
  DECLARE   @ScoreOnSpeed        DECIMAL(9, 6);

  --Get the limit speed, if event speed  > limit then Score = 0, else continue with calculation.
  SET @MaxSpeed = @OverSpeedSeverityFactor * @EventSpeedLimit;

  SET @ScoreOnSpeed = CASE
                        WHEN ISNULL(@OverSpeedSeverityFactor,0.0) <= 0.0
                          THEN 100.0
                        WHEN @EventSpeed > @MaxSpeed
                          THEN 0.0
                        WHEN (@EventSpeedLimit*@OverSpeedSeverityFactor)-@EventSpeedLimit > 0
                          THEN 100.0-((@EventSpeed-@EventSpeedLimit)/((@EventSpeedLimit*@OverSpeedSeverityFactor)-@EventSpeedLimit)*100.0)
                        ELSE 100.0
                      END;

  RETURN @ScoreOnSpeed;
END;

GO
/****** Object:  UserDefinedFunction [dbo].[fncDateToKey]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[fncDateToKey]
( @dateValue datetimeoffset )
RETURNS INT
BEGIN
  RETURN CONVERT(INT,CONVERT(CHAR(8),ISNULL(@dateValue,'1900-01-01'),112));
END;

GO
/****** Object:  UserDefinedFunction [dbo].[fncExtractValue]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncExtractValue](@list [nvarchar](max), @key [nvarchar](132), @delimiter [nvarchar](1))
RETURNS [nvarchar](max) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.SQL.Selection].[GeneralFunctions].[ExtractValue]
GO
/****** Object:  UserDefinedFunction [dbo].[fncFullTrim]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncFullTrim](@input [nvarchar](max))
RETURNS [nvarchar](max) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncFullTrim]
GO
/****** Object:  UserDefinedFunction [dbo].[fncGetListItem]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncGetListItem](@list [nvarchar](max), @key [nvarchar](132), @default [nvarchar](max))
RETURNS [nvarchar](max) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncGetListItem]
GO
/****** Object:  UserDefinedFunction [dbo].[fncGetListItemFloat]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncGetListItemFloat](@list [nvarchar](max), @key [nvarchar](132), @default [float])
RETURNS [float] WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncGetListItemDouble]
GO
/****** Object:  UserDefinedFunction [dbo].[fncGetListItemInt]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncGetListItemInt](@list [nvarchar](max), @key [nvarchar](132), @default [int])
RETURNS [int] WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncGetListItemInt]
GO
/****** Object:  UserDefinedFunction [dbo].[fncGetNextSchedule]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[fncGetNextSchedule]
(
  @ProcessIntervalInSec INT,
  @UTCOffsetInSec INT
 )

RETURNS DateTime AS 
BEGIN

DECLARE @BaseSchedule Datetime;

SET @BaseSchedule = DateAdd(DAY,-1,DateAdd(HOUR,(@UTCOffsetInSec/3600),  DateAdd(HOUR,23,DATEADD(dd, 0, DATEDIFF(dd, 0, SYSUTCDATETIME())))));

-- Create Future Dated Run time in fixed interval slot
  WHILE @BaseSchedule <= SYSUTCDATETIME()
  BEGIN
    SET @BaseSchedule = DateAdd(s,@ProcessIntervalInSec,@BaseSchedule)
  END

 RETURN @BaseSchedule;
 
END;

GO
/****** Object:  UserDefinedFunction [dbo].[fncIsNightTime]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncIsNightTime](@latitude [float], @longitude [float], @checkTime [datetimeoffset](7))
RETURNS [bit] WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncIsNightTime]
GO
/****** Object:  UserDefinedFunction [dbo].[fncKeyToDate]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [dbo].[fncKeyToDate]
( @keyValue INT )
RETURNS DATETIMEOFFSET
BEGIN
  DECLARE @returnValue DATETIMEOFFSET
  
  SELECT @returnValue = CASE
                          WHEN ISDATE(@keyValue) = 1
                            THEN CONVERT(DATETIMEOFFSET,CONVERT(CHAR(8),ISNULL(@keyValue,19000101)))
                          ELSE
                            NULL -- Default value if not valid date
                        END;
  
  RETURN @returnValue
END;

GO
/****** Object:  UserDefinedFunction [dbo].[fncNightTimeDuration]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncNightTimeDuration](@latitude [float], @longitude [float], @activityStartDateTime [datetimeoffset](7), @activityEndDateTime [datetimeoffset](7))
RETURNS [bigint] WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncNightTimeDuration]
GO
/****** Object:  UserDefinedFunction [dbo].[fncReplaceNullChar]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncReplaceNullChar](@input [nvarchar](max))
RETURNS [nvarchar](max) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncReplaceNullChar]
GO
/****** Object:  UserDefinedFunction [dbo].[fncSunriseTime]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncSunriseTime](@latitude [float], @longitude [float], @checkTime [datetimeoffset](7))
RETURNS [datetimeoffset](7) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncSunriseTime]
GO
/****** Object:  UserDefinedFunction [dbo].[fncSunsetTime]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncSunsetTime](@latitude [float], @longitude [float], @checkTime [datetimeoffset](7))
RETURNS [datetimeoffset](7) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncSunsetTime]
GO
/****** Object:  UserDefinedFunction [dbo].[fncTransformVehicleDeviceProperties]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncTransformVehicleDeviceProperties](@schemaName [nvarchar](132), @vehicleHostID [smallint], @deviceHostID [int], @existingProperties [xml])
RETURNS [nvarchar](max) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncTransformVehicleDeviceProperties]
GO
/****** Object:  UserDefinedFunction [dbo].[fncTransformVehicleTriggers]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[fncTransformVehicleTriggers](@schemaName [nvarchar](132), @vehicleHostID [smallint], @eventHostID [smallint], @existingTriggers [xml])
RETURNS [nvarchar](max) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.Insight.Staging].[UserDefinedFunctions].[fncTransformVehicleTriggers]
GO
/****** Object:  UserDefinedFunction [dbo].[UnpackIDs]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[UnpackIDs](@IDList [nvarchar](max))
RETURNS  TABLE (
	[ID] [int] NULL
) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.SQL.Selection].[MiX.SQL.Selection].[UnpackIDs]
GO
/****** Object:  UserDefinedFunction [dbo].[UnpackSmallIDs]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[UnpackSmallIDs](@IDList [nvarchar](max))
RETURNS  TABLE (
	[ID] [smallint] NULL
) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.SQL.Selection].[MiX.SQL.Selection].[UnpackSmallIDs]
GO
/****** Object:  UserDefinedFunction [dbo].[UnpackText]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO
CREATE FUNCTION [dbo].[UnpackText](@idList [nvarchar](max))
RETURNS  TABLE (
	[TextColumn] [nvarchar](max) NULL
) WITH EXECUTE AS CALLER
AS 
EXTERNAL NAME [MiX.SQL.Selection].[MiX.SQL.Selection].[UnpackText]
GO
/****** Object:  UserDefinedFunction [StageUser].[fncLineFromPoints]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [StageUser].[fncLineFromPoints]
(
  @locationID   int
) RETURNS geography AS
BEGIN
  DECLARE @result geography = dbo.fncBuildLineFromMapLocationPolygonPoints('[StageUser]', @locationID)
  RETURN @result;
END
GO
/****** Object:  UserDefinedFunction [StageUser].[fncPolygonFromPoints]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [StageUser].[fncPolygonFromPoints]
(
  @locationID   int
) RETURNS geography AS
BEGIN
  DECLARE @result geography = dbo.fncBuildPolygonFromMapLocationPolygonPoints('[StageUser]', @locationID)
  RETURN @result;
END
GO
/****** Object:  UserDefinedFunction [StageUser1].[fncLineFromPoints]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [StageUser1].[fncLineFromPoints](@locationID [int])
RETURNS [geography] AS 
BEGIN
  DECLARE @result geography = dbo.fncBuildLineFromMapLocationPolygonPoints('[StageUser]', @locationID)
  RETURN @result;
END

GO
/****** Object:  UserDefinedFunction [StageUser1].[fncPolygonFromPoints]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE FUNCTION [StageUser1].[fncPolygonFromPoints](@locationID [int])
RETURNS [geography] AS 
BEGIN
  DECLARE @result geography = dbo.fncBuildPolygonFromMapLocationPolygonPoints('[StageUser]', @locationID)
  RETURN @result;
END

GO
/****** Object:  Table [audit].[DeviceParam_CT]    Script Date: 2012/12/02 02:27:06 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[DeviceParam_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[bDeviceDefault] [bit] NOT NULL,
	[bParamDefault] [bit] NOT NULL,
	[ucCalibrationType] [tinyint] NOT NULL,
	[lfCalibration1] [float] NULL,
	[lfValue1] [float] NULL,
	[lfCalibration2] [float] NULL,
	[lfValue2] [float] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_DeviceParam_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[Devices_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[Devices_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[sDescription] [nvarchar](200) NOT NULL,
	[sSystemName] [nvarchar](255) NULL,
	[ucDeviceType] [tinyint] NOT NULL,
	[bCanRecordInterval] [bit] NOT NULL,
	[sReportProgID] [nvarchar](200) NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_Devices_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[DriverCertifications_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[DriverCertifications_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iDriverID] [smallint] NOT NULL,
	[liCertificationID] [int] NOT NULL,
	[dtObtained] [datetime] NOT NULL,
	[sInstructor] [nvarchar](50) NOT NULL,
	[bInstructorQualified] [bit] NOT NULL,
	[sLocation] [nvarchar](100) NOT NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
 CONSTRAINT [PK_DriverCertifications_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[DriverLicences_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[DriverLicences_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iDriverID] [smallint] NOT NULL,
	[liLicenceID] [int] NOT NULL,
	[dtObtained] [datetime] NOT NULL,
	[dtExpires] [datetime] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
 CONSTRAINT [PK_DriverLicences_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[Drivers_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[Drivers_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[DriverGUID] [uniqueidentifier] NOT NULL,
	[iDriverID] [smallint] NOT NULL,
	[liSiteID] [int] NOT NULL,
	[liGroupID] [int] NOT NULL,
	[sEmployeeNumber] [nvarchar](255) NULL,
	[sName] [nvarchar](255) NOT NULL,
	[bLicense] [bit] NOT NULL,
	[dtLastLicense] [datetime] NULL,
	[dtNextLicense] [datetime] NULL,
	[ucLicenseInterval] [tinyint] NULL,
	[dtDistanceChecked] [datetime] NULL,
	[sExtendedID] [varchar](32) NULL,
	[ucLicenseRemind] [tinyint] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
 CONSTRAINT [PK_Drivers_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[EventDescription_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[EventDescription_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[sDescription] [nvarchar](50) NOT NULL,
	[sSystemName] [nvarchar](255) NULL,
	[sCriticalID] [nchar](5) NULL,
	[ucSummaryType] [tinyint] NULL,
	[iSummaryID] [smallint] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_EventDescription_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[EventTriggers_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[EventTriggers_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucTriggerID] [tinyint] NOT NULL,
	[ucSeq] [tinyint] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[ucOperator] [tinyint] NOT NULL,
	[lfValue] [float] NOT NULL,
	[bRequired] [bit] NOT NULL,
	[ucTOper] [tinyint] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_EventTriggers_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[ExtensionProperties_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[ExtensionProperties_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[sAppID] [nvarchar](20) NOT NULL,
	[liObjectType] [int] NOT NULL,
	[liObjectID] [int] NOT NULL,
	[sProperty] [nvarchar](50) NOT NULL,
	[sValue] [nvarchar](max) NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [auditFG] TEXTIMAGE_ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[GroupTriggers_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[GroupTriggers_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[liGroupID] [int] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucTriggerID] [tinyint] NOT NULL,
	[ucSeq] [tinyint] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[ucOperator] [tinyint] NOT NULL,
	[lfValue] [float] NOT NULL,
	[bRequired] [bit] NOT NULL,
	[ucTOper] [tinyint] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_GroupTriggers_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[Organisation_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[Organisation_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NULL,
	[liOrgID] [int] NOT NULL,
	[CompanyGUID] [uniqueidentifier] NULL,
	[iCompanyID] [smallint] NULL,
	[sOrganisationName] [nvarchar](200) NULL,
	[sConnectServer] [nvarchar](256) NULL,
	[sConnectDatabase] [nvarchar](256) NULL,
	[bActive] [bit] NULL,
	[sLanguage] [nvarchar](100) NULL,
	[bDaylightEnabled] [bit] NULL,
	[dtDaylightStart] [datetime] NULL,
	[dtDaylightEnd] [datetime] NULL,
	[liDaylightAdjust] [int] NULL,
	[bReverseGeoAllowed] [bit] NULL,
	[MapProviderID] [nvarchar](20) NULL,
	[MapProviderConfiguration] [xml] NULL,
	[liGMTOffset] [int] NULL,
	[iDealerID] [smallint] NULL,
	[sDBVersion] [nvarchar](10) NULL,
	[bBillable] [bit] NULL,
	[ucBillingCode] [tinyint] NULL,
	[ucBillingContract] [tinyint] NULL,
	[sCountryCode] [nvarchar](4) NULL,
	[DutchTaxEventID] [smallint] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
 CONSTRAINT [PK_Organisation_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG] TEXTIMAGE_ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[OrgOptions_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[OrgOptions_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[sLPDealerName] [nvarchar](50) NULL,
	[sLPDealerTelNo] [nvarchar](20) NULL,
	[sLPRegCode] [nvarchar](50) NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
 CONSTRAINT [PK_OrgOptions_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[Param_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[Param_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[sDescription] [nvarchar](200) NULL,
	[sSystemName] [nvarchar](255) NULL,
	[ucValueFormat] [tinyint] NULL,
	[sUnits] [nvarchar](10) NULL,
	[bSystem] [bit] NULL,
	[bFuelCounter] [bit] NULL,
	[bProfiled] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_Param_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[Passengers_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[Passengers_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[PassengerGUID] [uniqueidentifier] NOT NULL,
	[iPassengerID] [smallint] NOT NULL,
	[sName] [nvarchar](255) NOT NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
 CONSTRAINT [PK_Passengers_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[ScoredEvents_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[ScoredEvents_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucScoreWeight] [tinyint] NOT NULL,
	[lfScoreDuration] [float] NOT NULL,
	[lfScoreSeverity] [float] NULL,
	[ucScoreTriggerID] [tinyint] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_ScoredEvents_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[Sites_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[Sites_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[SiteGUID] [uniqueidentifier] NOT NULL,
	[liSiteID] [int] NOT NULL,
	[sName] [nvarchar](255) NOT NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
 CONSTRAINT [PK_Sites_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[Trailers_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[Trailers_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[TrailerGUID] [uniqueidentifier] NOT NULL,
	[liTrailerID] [int] NOT NULL,
	[sDescription] [nvarchar](255) NOT NULL,
	[sRegNo] [nvarchar](15) NOT NULL,
	[sAssetNumber] [nvarchar](255) NULL,
	[fSetOdometer] [real] NULL,
	[dtOdometerChanged] [datetime] NULL,
	[dtPrevService] [datetime] NULL,
	[dtNextService] [datetime] NULL,
	[iServIntTime] [smallint] NULL,
	[fPrevService] [real] NULL,
	[fNextService] [real] NULL,
	[fServIntDistance] [real] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
 CONSTRAINT [PK_Trailers_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[TrailerUnitIDs_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[TrailerUnitIDs_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[liUnitID] [int] NOT NULL,
	[liTrailerID] [int] NOT NULL,
	[dtAttached] [datetime] NOT NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[VehicleDeviceParam_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[VehicleDeviceParam_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[lfCalibration1] [float] NULL,
	[lfValue1] [float] NULL,
	[lfCalibration2] [float] NULL,
	[lfValue2] [float] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleDeviceParam_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[VehicleDeviceProperties_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[VehicleDeviceProperties_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[sProperty] [nvarchar](50) NOT NULL,
	[sValue] [nvarchar](2000) NOT NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleDeviceProperties_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[VehicleDevices_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[VehicleDevices_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[sInputID] [char](2) NULL,
	[bIsActive] [bit] NULL,
	[bRecordInterval] [bit] NULL,
	[liPowerDeviceID] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleDevices_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[VehicleEvent_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[VehicleEvent_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucEventType] [tinyint] NOT NULL,
	[bInUse] [bit] NOT NULL,
	[bStartOdo] [bit] NOT NULL,
	[bStartPosition] [bit] NOT NULL,
	[bEndOdo] [bit] NOT NULL,
	[bEndPosition] [bit] NOT NULL,
	[bRecordF3Count] [bit] NOT NULL,
	[bWarningMessage] [bit] NOT NULL,
	[bActivePosition] [bit] NOT NULL,
	[iRecordTime] [smallint] NOT NULL,
	[iAlarmTime] [smallint] NOT NULL,
	[iRelayTime] [smallint] NOT NULL,
	[iRelay2Time] [smallint] NOT NULL,
	[iCriticalTime] [smallint] NULL,
	[iActiveTime] [smallint] NOT NULL,
	[iActiveEndTime] [smallint] NOT NULL,
	[iTrackTime] [smallint] NOT NULL,
	[iTrackInterval] [smallint] NOT NULL,
	[ucAlarmState] [tinyint] NOT NULL,
	[ucRelayState] [tinyint] NOT NULL,
	[ucRelay2State] [tinyint] NOT NULL,
	[sWarningMessage] [nvarchar](255) NULL,
	[ucPriority] [tinyint] NOT NULL,
	[dtLastEventNotification] [datetime] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleEvent_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[VehicleProfile_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[VehicleProfile_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[ucSeq] [smallint] NOT NULL,
	[lfValue] [float] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleProfile_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[Vehicles_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[Vehicles_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [bigint] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liSiteID] [int] NOT NULL,
	[liGroupID] [int] NOT NULL,
	[sDesc] [nvarchar](255) NOT NULL,
	[sRegNo] [nvarchar](15) NOT NULL,
	[ucUnitType] [tinyint] NOT NULL,
	[liLastServiceKey] [int] NULL,
	[fNextServiceKm] [real] NULL,
	[fServiceKm] [real] NULL,
	[fRemindKm] [real] NULL,
	[dtNextServiceDate] [datetime] NULL,
	[ucServiceMonths] [tinyint] NULL,
	[ucRemindWeeks] [tinyint] NULL,
	[liNextServiceSeconds] [int] NULL,
	[liServiceSeconds] [int] NULL,
	[liRemindSeconds] [int] NULL,
	[dtLastLicense] [datetime] NULL,
	[dtNextLicense] [datetime] NULL,
	[ucLicenseInterval] [tinyint] NULL,
	[ucLicenseRemind] [tinyint] NULL,
	[dtLastCOR] [datetime] NULL,
	[dtNextCOR] [datetime] NULL,
	[ucCORInterval] [tinyint] NULL,
	[ucCORRemind] [tinyint] NULL,
	[bServiceKm] [bit] NULL,
	[bServiceDate] [bit] NULL,
	[bServiceHours] [bit] NULL,
	[bLicense] [bit] NULL,
	[bCOR] [bit] NULL,
	[bActive] [bit] NULL,
	[sActiveReason] [nvarchar](500) NULL,
	[ucActiveState] [tinyint] NULL,
	[iDefaultDriver] [smallint] NULL,
	[fTargetConsumption] [real] NULL,
	[fTargetHourlyConsumption] [real] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
 CONSTRAINT [PK_Vehicles_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [audit].[VehicleTriggers_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [audit].[VehicleTriggers_CT](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostRID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucTriggerID] [tinyint] NOT NULL,
	[lfValue] [float] NOT NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleTriggers_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100, DATA_COMPRESSION = PAGE) ON [auditFG]
) ON [auditFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [Control].[AnalyserActivations]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[AnalyserActivations](
	[ActivationKey] [int] IDENTITY(1,1) NOT NULL,
	[MainOrganisationID] [int] NOT NULL,
	[OrganisationKeyList] [nvarchar](100) NULL,
	[MainOrganisationName] [nvarchar](200) NULL,
	[UTCOffset] [int] NOT NULL,
	[IsRunning] [bit] NULL,
 CONSTRAINT [PK_AnalyserActivations] PRIMARY KEY CLUSTERED 
(
	[ActivationKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[AnalyserModelAssignments]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[AnalyserModelAssignments](
	[ModelAssignmentKey] [int] IDENTITY(1,1) NOT NULL,
	[ActivationKey] [int] NULL,
	[ReloadOrder] [int] NULL,
	[ReloadAfter] [int] NULL,
	[ReloadType] [nvarchar](20) NULL,
	[AnalyserSourceFolder] [nvarchar](300) NULL,
	[AnalyserSourceModel] [nvarchar](300) NULL,
	[AnalyserDisplayName] [nvarchar](300) NULL,
	[AnalyserOrgType] [nvarchar](100) NULL,
	[AnalyserOrgList] [nvarchar](100) NULL,
	[ScheduleTypeKey] [int] NULL,
	[LastLoadSuccess] [nchar](10) NULL,
	[LastReloadDateTime] [datetimeoffset](0) NULL,
	[NextReloadDateTime] [datetimeoffset](0) NULL,
	[ReloadStarted] [int] NULL,
 CONSTRAINT [PK_AnalyserModelAssignments] PRIMARY KEY CLUSTERED 
(
	[ModelAssignmentKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[AnalyserReloadTypes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[AnalyserReloadTypes](
	[TypeKey] [int] IDENTITY(1,1) NOT NULL,
	[Description] [nvarchar](64) NULL,
	[DefaultTime] [time](0) NULL,
 CONSTRAINT [PK_AnalyserReloadTypes] PRIMARY KEY CLUSTERED 
(
	[TypeKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[BatchController]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[BatchController](
	[BatchID] [int] NOT NULL,
	[BatchBusy] [bit] NULL,
	[BatchStart] [datetimeoffset](0) NULL,
	[BatchEnd] [datetimeoffset](0) NULL,
	[BatchDBToComplete] [int] NULL,
	[BatchDBCompleted] [int] NULL,
	[BatchShouldStop] [bit] NULL,
	[WaitForIOUserImport] [nvarchar](50) NULL,
	[WaitForIOUserWrite] [nvarchar](50) NULL,
	[HasFailed] [bit] NULL,
 CONSTRAINT [PK_BatchController] PRIMARY KEY CLUSTERED 
(
	[BatchID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[DIM_Steps]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[DIM_Steps](
	[StepKey] [int] IDENTITY(1,1) NOT NULL,
	[StepName] [nvarchar](100) NULL,
	[ProcName] [nvarchar](100) NULL,
	[StepSequence] [int] NULL,
	[TaskKey] [int] NULL,
 CONSTRAINT [PK_DIM_Steps] PRIMARY KEY CLUSTERED 
(
	[StepKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[DIM_Tasks]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[DIM_Tasks](
	[TaskKey] [int] IDENTITY(1,1) NOT NULL,
	[TaskName] [nvarchar](50) NULL,
	[TaskType] [nchar](20) NULL,
 CONSTRAINT [PK_DIM_Tasks] PRIMARY KEY CLUSTERED 
(
	[TaskKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[DriverAppCache]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[DriverAppCache](
	[OrganisationID] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[ScheduleDateTime] [datetimeoffset](0) NULL,
	[LastProcessingAttemptDate] [datetimeoffset](0) NULL,
	[LastProcessingCompleteDate] [datetimeoffset](0) NULL,
	[NumberOfAttempts] [int] NULL,
	[ErrorDescription] [nvarchar](max) NULL,
 CONSTRAINT [PK_DriverAppCache] PRIMARY KEY CLUSTERED 
(
	[OrganisationID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG] TEXTIMAGE_ON [ControlFG]

GO
/****** Object:  Table [Control].[ErrorCodes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[ErrorCodes](
	[ErrorCode] [int] NOT NULL,
	[ErrorType] [nchar](20) NULL,
	[ErrorSeverity] [nchar](20) NULL,
	[ErrorLikelyCause] [nvarchar](200) NULL,
	[ErrorLikelyResolution] [nvarchar](200) NULL,
 CONSTRAINT [PK_ErrorCodes] PRIMARY KEY CLUSTERED 
(
	[ErrorCode] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[ErrorLog]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[ErrorLog](
	[ErrorLogID] [int] IDENTITY(1,1) NOT NULL,
	[ErrorTime] [datetimeoffset](7) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[UserName] [sysname] NOT NULL,
	[ErrorNumber] [int] NOT NULL,
	[ErrorSeverity] [int] NULL,
	[ErrorState] [int] NULL,
	[ErrorProcedure] [nvarchar](132) NULL,
	[ErrorLine] [int] NULL,
	[ErrorMessage] [nvarchar](max) NULL,
	[NrOfErrors] [int] NULL,
 CONSTRAINT [PK_ErrorLog_ErrorLogID] PRIMARY KEY CLUSTERED 
(
	[ErrorLogID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [ControlFG]
) ON [ControlFG] TEXTIMAGE_ON [ControlFG]

GO
/****** Object:  Table [Control].[ErrorLogging]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[ErrorLogging](
	[ErrorLogID] [int] IDENTITY(1,1) NOT NULL,
	[BatchID] [int] NULL,
	[OrganisationKey] [int] NULL,
	[ThreadUser] [nvarchar](50) NULL,
	[ActionType] [nchar](20) NULL,
	[ActionObjectName] [nvarchar](50) NULL,
	[StepDescription] [nvarchar](50) NULL,
	[StepStartDateTime] [datetimeoffset](7) NULL,
	[ErrorDateTime] [datetimeoffset](7) NULL,
	[ErrorCode] [int] NULL,
	[ErrorDescription] [nvarchar](max) NULL,
	[SourceDBCatalog] [nvarchar](256) NULL,
	[SourceDBServer] [nvarchar](256) NULL,
	[SourceDBCurrChangeVersion] [bigint] NULL,
	[SourceDBPrevChangeVersion] [bigint] NULL,
 CONSTRAINT [PK_ErrorLogging] PRIMARY KEY CLUSTERED 
(
	[ErrorLogID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG] TEXTIMAGE_ON [ControlFG]

GO
/****** Object:  Table [Control].[ErrorLoggingHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[ErrorLoggingHistory](
	[ErrorLogID] [int] NOT NULL,
	[BatchID] [int] NULL,
	[OrganisationKey] [int] NULL,
	[ThreadUser] [nvarchar](50) NULL,
	[ActionType] [nchar](20) NULL,
	[ActionObjectName] [nvarchar](50) NULL,
	[StepDescription] [nvarchar](50) NULL,
	[StepStartDateTime] [datetimeoffset](7) NULL,
	[ErrorDateTime] [datetimeoffset](7) NULL,
	[ErrorCode] [int] NULL,
	[ErrorDescription] [nvarchar](max) NULL,
	[SourceDBCatalog] [nvarchar](256) NULL,
	[SourceDBServer] [nvarchar](256) NULL,
	[SourceDBCurrChangeVersion] [bigint] NULL,
	[SourceDBPrevChangeVersion] [bigint] NULL,
 CONSTRAINT [PK_ErrorLoggingHistory
] PRIMARY KEY CLUSTERED 
(
	[ErrorLogID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG] TEXTIMAGE_ON [ControlFG]

GO
/****** Object:  Table [Control].[ErrorLogHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[ErrorLogHistory](
	[ErrorLogID] [int] NOT NULL,
	[ErrorTime] [datetimeoffset](7) NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[UserName] [sysname] NOT NULL,
	[ErrorNumber] [int] NOT NULL,
	[ErrorSeverity] [int] NULL,
	[ErrorState] [int] NULL,
	[ErrorProcedure] [nvarchar](132) NULL,
	[ErrorLine] [int] NULL,
	[ErrorMessage] [nvarchar](max) NULL,
	[NrOfErrors] [int] NULL,
 CONSTRAINT [PK_ErrorLogHistory_ErrorLogID] PRIMARY KEY CLUSTERED 
(
	[ErrorLogID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [ControlFG]
) ON [ControlFG] TEXTIMAGE_ON [ControlFG]

GO
/****** Object:  Table [Control].[EventGroupLookups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[EventGroupLookups](
	[EventGroupnameLookupKey] [int] NOT NULL,
	[iEventID] [int] NOT NULL,
	[EventGroup] [nvarchar](25) NULL,
	[sDescription] [nvarchar](255) NULL,
 CONSTRAINT [PK_EventGroupLookups] PRIMARY KEY CLUSTERED 
(
	[EventGroupnameLookupKey] ASC,
	[iEventID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[FACT_BatchInfo]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[FACT_BatchInfo](
	[BatchKey] [date] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[StartDateKey] [date] NULL,
	[StartTimeKey] [int] NULL,
	[EndDateKey] [date] NULL,
	[EndTimeKey] [int] NULL,
	[DurationInSeconds] [int] NULL,
	[RunStatus] [int] NULL,
	[NrOfErrors] [int] NULL,
	[NrOfRetries] [int] NULL,
	[DiskSpaceAvailableGb] [decimal](10, 2) NULL,
	[DiskSpaceTotalGb] [decimal](10, 2) NULL,
	[IsFirstRun] [bit] NULL,
	[IsRestoredDB] [bit] NULL,
	[ActiveThread] [int] NULL,
 CONSTRAINT [PK_FACT_BatchInfo] PRIMARY KEY CLUSTERED 
(
	[BatchKey] ASC,
	[OrganisationKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[FACT_DriveSpace]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[FACT_DriveSpace](
	[DriveSpaceKey] [int] IDENTITY(1,1) NOT NULL,
	[BatchKey] [date] NOT NULL,
	[DriveName] [nvarchar](50) NULL,
	[CapacityGB] [decimal](10, 2) NULL,
	[UsedSpaceGB] [decimal](10, 2) NULL,
	[FreeSpaceGB] [decimal](10, 2) NULL,
	[PercentFreeSpace] [decimal](10, 2) NULL
) ON [ControlFG]

GO
/****** Object:  Table [Control].[FACT_StepPerformance]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[FACT_StepPerformance](
	[StepPerformanceKey] [bigint] NOT NULL,
	[StepKey] [int] NOT NULL,
	[StepSequence] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[StartTimeKey] [int] NOT NULL,
	[BatchKey] [date] NULL,
	[StepStartDateTime] [datetimeoffset](0) NULL,
	[StepEndDateTime] [datetimeoffset](0) NULL,
	[DurationInSeconds] [int] NULL,
	[NrOfRecordsAffected] [int] NULL,
 CONSTRAINT [PK_FACT_StepPerformance] PRIMARY KEY CLUSTERED 
(
	[StepPerformanceKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[FACT_TaskPerformance]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[FACT_TaskPerformance](
	[TaskPerformanceKey] [bigint] NOT NULL,
	[TaskKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[ThreadUserKey] [int] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[StartTimeKey] [int] NOT NULL,
	[BatchKey] [date] NULL,
	[TaskStartDateTime] [datetimeoffset](0) NULL,
	[TaskEndDateTime] [datetimeoffset](0) NULL,
	[DurationInSeconds] [int] NULL,
	[Errors] [smallint] NULL,
	[RecordsInserted] [int] NULL,
	[RecordsType2Inserted] [int] NULL,
	[RecordsUpdated] [int] NULL,
	[RecordsDeleted] [int] NULL,
 CONSTRAINT [PK_FACT_TaskPerformance] PRIMARY KEY CLUSTERED 
(
	[TaskPerformanceKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[MaintenanceIndexStats]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[MaintenanceIndexStats](
	[RID] [int] IDENTITY(1,1) NOT NULL,
	[DBName] [nvarchar](255) NOT NULL,
	[SchemaName] [nvarchar](255) NOT NULL,
	[TableName] [nvarchar](255) NOT NULL,
	[IndexName] [nvarchar](255) NOT NULL,
	[IndexType] [nvarchar](50) NULL,
	[IndexAllocUnitType] [nvarchar](50) NULL,
	[PartitionNumber] [int] NULL,
	[PartitionMonthKey] [int] NULL,
	[PrevAvgFragmentationPerc] [float] NULL,
	[AvgFragmentationPerc] [float] NULL,
	[AvgFragmentationSizeInPages] [float] NULL,
	[PartitionPageCount] [bigint] NULL,
	[PartitionRows] [bigint] NULL,
	[LastSnapShotDateTime] [datetimeoffset](0) NOT NULL,
	[LastRebuildDateTime] [datetimeoffset](0) NULL,
	[LastRebuildOperation] [nvarchar](5) NULL,
 CONSTRAINT [PK_MaintenanceIndexStats] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[MaintenanceIndexStatsHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[MaintenanceIndexStatsHistory](
	[RID] [int] IDENTITY(1,1) NOT NULL,
	[SnapShotDateTime] [datetimeoffset](0) NOT NULL,
	[SnapShotEndDateTime] [datetimeoffset](0) NOT NULL,
	[DBName] [nvarchar](255) NOT NULL,
	[SchemaName] [nvarchar](255) NOT NULL,
	[TableName] [nvarchar](255) NOT NULL,
	[IndexName] [nvarchar](255) NOT NULL,
	[IndexType] [nvarchar](50) NULL,
	[IndexAllocUnitType] [nvarchar](50) NULL,
	[PartitionNumber] [int] NULL,
	[PartitionMonthKey] [int] NULL,
	[AvgFragmentationPerc] [float] NULL,
	[AvgFragmentationSizeInPages] [float] NULL,
	[PartitionPageCount] [bigint] NULL,
	[PartitionRows] [bigint] NULL,
 CONSTRAINT [PK_MaintenanceIndexStatsHistory] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[MaintenanceIndexStatsSummary]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[MaintenanceIndexStatsSummary](
	[RID] [int] IDENTITY(1,1) NOT NULL,
	[DBName] [nvarchar](255) NOT NULL,
	[SchemaName] [nvarchar](255) NOT NULL,
	[TableName] [nvarchar](255) NOT NULL,
	[IndexName] [nvarchar](255) NOT NULL,
	[IndexType] [nvarchar](50) NULL,
	[NumberOfRows] [bigint] NULL,
	[LastCheckStatsDateTime] [datetimeoffset](0) NULL,
	[LastRebuildDateTime] [datetimeoffset](0) NULL,
	[LastRebuildOperation] [nvarchar](5) NULL,
	[LastStatsFailedDateTime] [datetimeoffset](0) NULL,
	[AvgFragmentationPerc] [float] NULL,
	[MaxFragmentationPerc] [float] NULL,
	[NumberOfPartitionsAbove30Perc] [bigint] NULL,
	[IndexPageCount] [bigint] NULL,
 CONSTRAINT [PK_MaintenanceIndexStatsSummary] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[OrganisationController]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[OrganisationController](
	[OrganisationID] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[OrganisationName] [nvarchar](200) NULL,
	[OrganisationGUID] [uniqueidentifier] NULL,
	[ServerInstance] [nvarchar](256) NULL,
	[DatabaseName] [nvarchar](256) NULL,
	[ConnectUID] [nvarchar](256) NULL,
	[ConnectPWD] [nvarchar](256) NULL,
	[UTCOffset] [int] NOT NULL,
	[LastUpdateSuccess] [bit] NULL,
	[LastSuccessbatch] [int] NULL,
	[CurrentThreaduser] [nvarchar](50) NULL,
	[CurrentBatch] [int] NULL,
	[IsPartOfGroupID] [int] NULL,
	[IsFinished] [bit] NULL,
	[DBVersion] [nvarchar](10) NOT NULL,
	[DBChangeTrackVersion] [bigint] NULL,
	[DBChangeTrackVersionDate] [datetimeoffset](7) NULL,
	[LastProcessingAttemptDate] [datetimeoffset](7) NULL,
	[lastProcessingCompleteDate] [datetimeoffset](7) NULL,
	[ErrorEncountered] [bit] NULL,
	[bActive] [bit] NULL,
	[DWActive] [bit] NULL,
	[IsRemoved] [bit] NULL,
	[ScheduleDateTime] [datetimeoffset](0) NULL,
	[NumberOfExtractAttempts] [int] NULL,
	[RestrictTracerFlag] [int] NULL,
	[SiteGroupFlag] [int] NULL,
	[UTCOffsetPriority] [int] NULL,
	[ProcessIntervalInSec] [int] NULL,
 CONSTRAINT [PK_OrganisationController] PRIMARY KEY CLUSTERED 
(
	[OrganisationID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[OrganisationControllerHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [Control].[OrganisationControllerHistory](
	[RID] [int] IDENTITY(1,1) NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[OrganisationID] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[OrganisationName] [nvarchar](200) NULL,
	[OrganisationGUID] [uniqueidentifier] NULL,
	[ServerInstance] [nvarchar](256) NULL,
	[DatabaseName] [nvarchar](256) NULL,
	[UTCOffset] [int] NOT NULL,
	[LastUpdateSuccess] [bit] NULL,
	[LastSuccessbatch] [int] NULL,
	[CurrentThreaduser] [nvarchar](50) NULL,
	[CurrentBatch] [int] NULL,
	[IsFinished] [bit] NULL,
	[DBVersion] [nvarchar](10) NOT NULL,
	[DBChangeTrackVersion] [bigint] NULL,
	[DBChangeTrackVersionDate] [datetimeoffset](7) NULL,
	[LastProcessingAttemptDate] [datetimeoffset](7) NULL,
	[lastProcessingCompleteDate] [datetimeoffset](7) NULL,
	[ErrorEncountered] [bit] NULL,
	[BActive] [bit] NULL,
	[DWActive] [bit] NULL,
	[IsRemoved] [bit] NULL,
	[ScheduleDateTime] [datetimeoffset](0) NULL,
	[NumberOfExtractAttempts] [int] NULL,
	[RestrictTracerFlag] [int] NULL,
	[SiteGroupFlag] [int] NULL,
	[UTCOffsetPriority] [int] NULL,
	[ProcessIntervalInSec] [int] NULL,
	[IsPartOfGroupID] [int] NULL,
 CONSTRAINT [PK_OrganisationControllerHistory] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [Control].[OrganisationTableController]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[OrganisationTableController](
	[OrganisationKey] [int] NOT NULL,
	[ExtractTableName] [nvarchar](50) NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[FullLoadFlag] [bit] NOT NULL,
 CONSTRAINT [PK_OrganisationTableController] PRIMARY KEY CLUSTERED 
(
	[OrganisationKey] ASC,
	[ExtractTableName] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[OrganisationTableControllerHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [Control].[OrganisationTableControllerHistory](
	[RID] [int] IDENTITY(1,1) NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[ExtractTableName] [nvarchar](50) NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[FullLoadFlag] [bit] NOT NULL
) ON [ControlFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [Control].[PartitionInfo]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [Control].[PartitionInfo](
	[PartitionInfoKey] [int] IDENTITY(1,1) NOT NULL,
	[MonNum] [char](2) NULL,
	[FileNum] [char](1) NULL,
	[Drive] [varchar](50) NULL,
	[DPath] [varchar](256) NULL,
PRIMARY KEY CLUSTERED 
(
	[PartitionInfoKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [Control].[PerformanceMonitor]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[PerformanceMonitor](
	[MonitorID] [int] IDENTITY(1,1) NOT NULL,
	[BatchID] [int] NULL,
	[OrganisationKey] [int] NULL,
	[ThreadUser] [nvarchar](50) NULL,
	[ActionType] [nchar](20) NULL,
	[ActionObjectName] [nvarchar](50) NULL,
	[StepDescription] [nvarchar](50) NULL,
	[StepStartTime] [datetimeoffset](0) NULL,
	[StepEndTime] [datetimeoffset](0) NULL,
	[Errors] [int] NULL,
	[Issues] [int] NULL,
	[Alerts] [int] NULL,
	[RecordsInserted] [int] NULL,
	[RecordsType2Inserted] [int] NULL,
	[RecordsUpdated] [int] NULL,
	[RecordsDeleted] [int] NULL,
	[RecordsRead] [int] NULL,
 CONSTRAINT [PK_PerformanceMonitor] PRIMARY KEY CLUSTERED 
(
	[MonitorID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[PerformanceMonitorHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[PerformanceMonitorHistory](
	[MonitorID] [int] NOT NULL,
	[BatchID] [int] NULL,
	[OrganisationKey] [int] NULL,
	[ThreadUser] [nvarchar](50) NULL,
	[ActionType] [nchar](20) NULL,
	[ActionObjectName] [nvarchar](50) NULL,
	[StepDescription] [nvarchar](50) NULL,
	[StepStartTime] [datetimeoffset](7) NULL,
	[StepEndTime] [datetimeoffset](7) NULL,
	[Errors] [int] NULL,
	[Issues] [int] NULL,
	[Alerts] [int] NULL,
	[RecordsInserted] [int] NULL,
	[RecordsType2Inserted] [int] NULL,
	[RecordsUpdated] [int] NULL,
	[RecordsDeleted] [int] NULL,
	[RecordsRead] [int] NULL,
 CONSTRAINT [PK_PerformanceMonitorHistory] PRIMARY KEY CLUSTERED 
(
	[MonitorID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[ProcProgressMonitor]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [Control].[ProcProgressMonitor](
	[RID] [bigint] IDENTITY(1,1) NOT NULL,
	[BatchID] [int] NULL,
	[OrganisationKey] [int] NULL,
	[ProcName] [varchar](100) NULL,
	[Flag] [varchar](100) NULL,
	[FlagSeq] [int] NULL,
	[IsStartFlag] [bit] NULL,
	[FlagStartTime] [datetimeoffset](0) NULL,
	[FlagEndTime] [datetimeoffset](0) NULL,
	[DurationSeconds] [int] NULL,
	[DurationMinutes] [int] NULL,
	[NrOfRecordsAffected] [int] NULL
) ON [ControlFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [Control].[ProcProgressMonitorHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [Control].[ProcProgressMonitorHistory](
	[RID] [bigint] NOT NULL,
	[BatchID] [int] NULL,
	[OrganisationKey] [int] NULL,
	[ProcName] [varchar](100) NULL,
	[Flag] [varchar](100) NULL,
	[FlagSeq] [int] NULL,
	[IsStartFlag] [bit] NULL,
	[FlagStartTime] [datetimeoffset](0) NULL,
	[FlagEndTime] [datetimeoffset](0) NULL,
	[DurationSeconds] [int] NULL,
	[DurationMinutes] [int] NULL,
	[NrOfRecordsAffected] [int] NULL,
 CONSTRAINT [PK_ProcProgressMonitorHistory] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [Control].[ReverseGeoServiceHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[ReverseGeoServiceHistory](
	[RID] [int] IDENTITY(1,1) NOT NULL,
	[ServerName] [nvarchar](132) NOT NULL,
	[ServerState] [tinyint] NOT NULL,
	[InvalidMapProviders] [int] NOT NULL,
	[UnavailableMapProviders] [int] NOT NULL,
	[GeoLocationProcessedDelta] [int] NOT NULL,
	[GeoLocationIgnoredDelta] [int] NOT NULL,
	[GeographyNewDelta] [int] NOT NULL,
	[RecordDate] [datetimeoffset](0) NOT NULL
) ON [ControlFG]

GO
/****** Object:  Table [Control].[RollbackTableList]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[RollbackTableList](
	[RID] [int] IDENTITY(1,1) NOT NULL,
	[MiXDataTableName] [nvarchar](100) NOT NULL,
	[RollbackColumnList] [nvarchar](max) NULL,
	[ReInsertColumnList] [nvarchar](max) NULL,
	[PrimaryKey] [nvarchar](100) NULL,
	[HasOrganisationKeyFlag] [bit] NULL,
	[IsSummaryTableFlag] [bit] NULL,
	[Processed] [bit] NULL
) ON [ControlFG] TEXTIMAGE_ON [ControlFG]

GO
/****** Object:  Table [Control].[SSIS_Configurations]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[SSIS_Configurations](
	[ConfigurationFilter] [nvarchar](255) NOT NULL,
	[ConfiguredValue] [nvarchar](255) NULL,
	[PackagePath] [nvarchar](255) NOT NULL,
	[ConfiguredValueType] [nvarchar](20) NOT NULL
) ON [ControlFG]

GO
/****** Object:  Table [Control].[UnitTypeLookups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[UnitTypeLookups](
	[UnitTypeID] [int] NOT NULL,
	[UnitTypeLookupKey] [int] NOT NULL,
	[UnitTypeName] [nvarchar](50) NULL,
 CONSTRAINT [PK_UnitTypeLookups] PRIMARY KEY CLUSTERED 
(
	[UnitTypeLookupKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
) ON [ControlFG]

GO
/****** Object:  Table [Control].[WarehouseNotifications]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [Control].[WarehouseNotifications](
	[NotificationKey] [int] IDENTITY(1,1) NOT NULL,
	[NotificationType] [nvarchar](25) NOT NULL,
	[NotificationDateTime] [datetimeoffset](0) NOT NULL,
	[ActionTakenDateTime] [datetimeoffset](0) NULL,
	[ScheduleDateTime] [datetimeoffset](0) NULL,
	[ProcessedDateTime] [datetimeoffset](0) NULL,
	[IsBusyProcessing] [bit] NULL,
	[ActionTaken] [nvarchar](25) NULL,
	[OrganisationID] [int] NOT NULL,
	[DatabaseName] [nvarchar](256) NULL,
	[DatabaseSizeMB] [int] NULL,
	[RestoreDBChangeTrackVersion] [bigint] NULL,
	[CurrentDBChangeTrackVersion] [bigint] NULL,
	[ProcessingSlotHour] [int] NULL,
	[NotificationUser] [nvarchar](50) NULL,
	[ActionTakenUser] [nvarchar](50) NULL
) ON [ControlFG]

GO
/****** Object:  Table [StageControl].[DriverApp_RegisteredUsers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[DriverApp_RegisteredUsers](
	[OrganisationID] [int] NOT NULL,
	[DriverID] [int] NOT NULL,
 CONSTRAINT [PK_DriverApp_RegisteredUsers] PRIMARY KEY CLUSTERED 
(
	[OrganisationID] ASC,
	[DriverID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [StageControlFG]
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[DriverApp_SuccessfulImportedOrgs]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[DriverApp_SuccessfulImportedOrgs](
	[OrganisationID] [int] NOT NULL,
 CONSTRAINT [PK_DriverApp_SuccessfulImportedOrgs] PRIMARY KEY CLUSTERED 
(
	[OrganisationID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [StageControlFG]
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[Organisation]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[Organisation](
	[liOrgID] [int] NOT NULL,
	[sOrganisationName] [nvarchar](200) NULL,
	[sLanguage] [nvarchar](100) NOT NULL,
	[sConnectProvider] [nvarchar](256) NOT NULL,
	[sConnectServer] [nvarchar](256) NOT NULL,
	[sConnectDatabase] [nvarchar](256) NOT NULL,
	[sConnectUID] [nvarchar](256) NULL,
	[sConnectPWD] [nvarchar](256) NULL,
	[sConnectStatic] [nvarchar](256) NULL,
	[bActive] [bit] NOT NULL,
	[dtLastEventNotificationRun] [datetime] NOT NULL,
	[sGPSViewerAppID] [nvarchar](40) NULL,
	[ucConsumType] [smallint] NOT NULL,
	[ucMeasureType] [smallint] NOT NULL,
	[ucFuelCaptureVol] [smallint] NOT NULL,
	[ucFuelCaptureDist] [smallint] NOT NULL,
	[iUserLimit] [smallint] NOT NULL,
	[bReverseGeoAllowed] [bit] NOT NULL,
	[sCountryCode] [nvarchar](4) NULL,
	[dtCreated] [datetime] NULL,
	[liGMTOffset] [int] NOT NULL,
	[MapProviderID] [nvarchar](20) NULL,
	[ucBillingCode] [tinyint] NULL,
	[ucBillingContract] [tinyint] NULL,
	[iDealerID] [smallint] NULL,
	[bBillable] [bit] NOT NULL,
	[bTaxReporting] [bit] NOT NULL,
	[sRProvider] [nvarchar](256) NULL,
	[sRServer] [nvarchar](256) NULL,
	[sRDatabase] [nvarchar](256) NULL,
	[sRUID] [nvarchar](256) NULL,
	[sRPWD] [nvarchar](256) NULL,
	[sRStatic] [nvarchar](256) NULL,
	[sDBVersion] [nvarchar](10) NOT NULL,
	[iCompanyID] [smallint] NULL,
	[bDaylightEnabled] [bit] NOT NULL,
	[dtDaylightStart] [datetime] NULL,
	[dtDaylightEnd] [datetime] NULL,
	[liDaylightAdjust] [int] NULL,
	[CompanyGUID] [uniqueidentifier] NULL,
	[bRealTimeMessageDelete] [bit] NOT NULL,
	[bSaveDownloadRequest] [bit] NOT NULL,
 CONSTRAINT [PK_Organisations] PRIMARY KEY CLUSTERED 
(
	[liOrgID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageControlFG]
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[Organisation_CT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageControl].[Organisation_CT](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NULL,
	[liOrgID] [int] NOT NULL,
	[CompanyGUID] [uniqueidentifier] NOT NULL,
	[iCompanyID] [smallint] NOT NULL,
	[sOrganisationName] [nvarchar](200) NOT NULL,
	[sConnectServer] [nvarchar](256) NOT NULL,
	[sConnectDatabase] [nvarchar](256) NOT NULL,
	[bActive] [bit] NOT NULL,
	[sLanguage] [nvarchar](100) NOT NULL,
	[bDaylightEnabled] [bit] NOT NULL,
	[dtDaylightStart] [datetime] NULL,
	[dtDaylightEnd] [datetime] NULL,
	[liDaylightAdjust] [int] NULL,
	[bReverseGeoAllowed] [bit] NOT NULL,
	[MapProviderID] [nvarchar](20) NULL,
	[liGMTOffset] [int] NOT NULL,
	[iDealerID] [smallint] NULL,
	[sDBVersion] [nvarchar](10) NOT NULL,
	[bBillable] [bit] NOT NULL,
	[ucBillingCode] [tinyint] NULL,
	[ucBillingContract] [tinyint] NULL,
	[sCountryCode] [nvarchar](4) NULL,
	[MapProviderConfiguration] [xml] NULL,
	[DutchTaxEventID] [smallint] NULL,
	[OrganisationKey] [int] NULL,
 CONSTRAINT [PK_Organisation_CT] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageControlFG]
) ON [StageControlFG] TEXTIMAGE_ON [StageControlFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageControl].[ROLLBACK_DIM_Organisations]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[ROLLBACK_DIM_Organisations](
	[OrganisationKey] [int] NOT NULL,
	[HostID] [int] NULL,
	[OrganisationName] [nvarchar](200) NULL,
	[DealerName] [nvarchar](100) NULL,
	[DealerTelNo] [nchar](40) NULL,
	[OrganisationGUID] [uniqueidentifier] NULL,
	[MemberOfOrganisationKey] [int] NULL,
	[CountryCode] [nvarchar](4) NULL,
	[Language] [nvarchar](100) NULL,
	[IsActive] [bit] NULL,
	[MapProviderKey] [int] NULL,
	[DBVersion] [nvarchar](20) NULL,
	[DutchTaxEventID] [smallint] NULL,
	[UTCOffsetKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[ROLLBACK_DIM_UTCOffsets]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[ROLLBACK_DIM_UTCOffsets](
	[UTCOffsetKey] [int] NOT NULL,
	[StartDateKey] [date] NULL,
	[EndDateKey] [date] NULL,
	[IsCurrentRecord] [bit] NULL,
	[OrganisationKey] [int] NULL,
	[AdjustmentType] [nvarchar](10) NULL,
	[UTCOffset] [int] NULL,
	[DaylightAdjustment] [int] NULL,
	[UTCOffsetMinutes] [int] NULL,
	[DaylightStart] [datetimeoffset](0) NULL,
	[DaylightEnd] [datetimeoffset](0) NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[STAGE_DIM_MapProviderDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[STAGE_DIM_MapProviderDetails](
	[MapProviderName] [nvarchar](20) NOT NULL,
	[MapProviderConfiguration] [xml] NULL
) ON [StageControlFG] TEXTIMAGE_ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[STAGE_DIM_Organisations]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[STAGE_DIM_Organisations](
	[OrganisationKey] [int] NULL,
	[HostID] [int] NULL,
	[OrganisationName] [nvarchar](200) NULL,
	[DealerName] [nvarchar](100) NULL,
	[DealerTelNo] [nchar](40) NULL,
	[OrganisationGUID] [uniqueidentifier] NULL,
	[MemberOfOrganisationKey] [int] NULL,
	[CountryCode] [nvarchar](4) NULL,
	[Language] [nvarchar](100) NULL,
	[IsActive] [bit] NULL,
	[MapProviderKey] [int] NULL,
	[DBVersion] [nvarchar](20) NULL,
	[DutchTaxEventID] [smallint] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[STAGE_DIM_UTCOffsets]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[STAGE_DIM_UTCOffsets](
	[OrganisationKey] [int] NULL,
	[AdjustmentType] [nvarchar](10) NULL,
	[UTCOffset] [int] NULL,
	[DaylightAdjustment] [int] NULL,
	[UTCOffsetMinutes] [int] NULL,
	[DaylightStart] [datetimeoffset](0) NULL,
	[DaylightEnd] [datetimeoffset](0) NULL
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[STAGE_FACT_EventSummary]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[STAGE_FACT_EventSummary](
	[VehicleSiteKey] [int] NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[TrailerKey] [int] NULL,
	[EventDescriptionKey] [int] NULL,
	[EventStartDateKey] [date] NULL,
	[NumberOfEvents] [int] NULL,
	[MaxEventValue] [float] NULL,
	[MinEventValue] [float] NULL,
	[AvgEventValue] [float] NULL,
	[TotalEventValue] [float] NULL,
	[TotalOccurs] [int] NULL,
	[TotalTime] [int] NULL,
	[TotalLitres] [decimal](19, 4) NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[STAGE_FACT_EventSummary_Processed]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[STAGE_FACT_EventSummary_Processed](
	[OrganisationKey] [int] NOT NULL,
	[NrOfRecords] [bigint] NULL,
	[NrOfRecordsAffected] [bigint] NULL,
	[Processed] [bit] NULL
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[STAGE_FACT_ShapeVisits]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[STAGE_FACT_ShapeVisits](
	[VisitDateKey] [date] NULL,
	[ShapeKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[DriverKey] [int] NULL,
	[DurationAtLocation] [int] NULL,
	[NumberOfVisits] [int] NULL,
	[NumberOfUniqueVisits] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[STAGE_FACT_ShapeVisits_Processed]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[STAGE_FACT_ShapeVisits_Processed](
	[OrganisationKey] [int] NOT NULL,
	[NrOfRecords] [bigint] NULL,
	[NrOfRecordsAffected] [bigint] NULL,
	[Processed] [bit] NULL
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[STAGE_FACT_SimpleScoreDaily]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[STAGE_FACT_SimpleScoreDaily](
	[SnapShotDateKey] [date] NOT NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[DistanceTravelled] [decimal](19, 4) NULL,
	[DrivingTime] [int] NULL,
	[Duration] [int] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[SpeedTime] [int] NULL,
	[SpeedOccurs] [int] NULL,
	[SpeedScoreByDuration] [decimal](19, 5) NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[BrakeTime] [int] NULL,
	[BrakeOccurs] [int] NULL,
	[BrakeScoreByDuration] [decimal](19, 5) NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[AccelTime] [int] NULL,
	[AccelOccurs] [int] NULL,
	[AccelScoreByDuration] [decimal](19, 5) NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[RPMTime] [int] NULL,
	[RPMOccurs] [int] NULL,
	[RPMScoreByDuration] [decimal](19, 5) NULL,
	[OutOfGreenBandTime] [int] NULL,
	[OutOfGreenBandScoreByDuration] [decimal](19, 5) NULL,
	[ExcessiveIdleOccurs] [int] NULL,
	[ExcessiveIdleTime] [int] NULL,
	[ExcessiveIdleScoreByDuration] [decimal](19, 5) NULL,
	[IsDeleted] [bit] NULL
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[STAGE_FACT_SimpleScoreDaily_Processed]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[STAGE_FACT_SimpleScoreDaily_Processed](
	[OrganisationKey] [int] NOT NULL,
	[NrOfRecords] [bigint] NULL,
	[NrOfRecordsAffected] [bigint] NULL,
	[Processed] [bit] NULL
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[STAGE_FACT_SiteSnapshotDaily]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[STAGE_FACT_SiteSnapshotDaily](
	[SnapShotDateKey] [date] NOT NULL,
	[VehicleSiteKey] [int] NULL,
	[VehiclesWithTrips] [smallint] NULL,
	[DriversWithTrips] [smallint] NULL,
	[NumberOfTrips] [int] NULL,
	[NumberOfCollisions] [int] NULL,
	[NumberOfKMs] [decimal](19, 4) NULL,
	[NumberOfHours] [int] NULL,
	[FuelUsedMeasured] [decimal](9, 4) NULL,
	[FuelUsedCalculated] [decimal](9, 4) NULL,
	[TotalIdlingTime] [int] NULL,
	[NumberOfActiveVehicles] [int] NULL,
	[NumberOfActiveDrivers] [int] NULL,
	[VehicleUtilization] [int] NULL,
	[DriverUtilization] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[STAGE_FACT_SiteSnapshotDaily_Processed]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[STAGE_FACT_SiteSnapshotDaily_Processed](
	[OrganisationKey] [int] NOT NULL,
	[NrOfRecords] [bigint] NULL,
	[NrOfRecordsAffected] [bigint] NULL,
	[Processed] [bit] NULL
) ON [StageControlFG]

GO
/****** Object:  Table [StageControl].[STAGE_InitialRun_UpdateKeys_Date_Processed]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[STAGE_InitialRun_UpdateKeys_Date_Processed](
	[OrganisationKey] [int] NULL,
	[DateKey] [date] NULL,
	[Processed] [bit] NULL
) ON [PRIMARY]

GO
/****** Object:  Table [StageControl].[STAGE_InitialRun_UpdateKeys_Processed]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageControl].[STAGE_InitialRun_UpdateKeys_Processed](
	[OrganisationKey] [int] NULL,
	[Processed] [bit] NULL
) ON [StageControlFG]

GO
/****** Object:  Table [StageUser].[Certifications]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[Certifications](
	[liCertificationID] [int] NOT NULL,
	[sDescription] [nvarchar](100) NULL,
	[iValidMonths] [smallint] NULL,
	[bMandatory] [bit] NULL,
 CONSTRAINT [PK_Certifications] PRIMARY KEY CLUSTERED 
(
	[liCertificationID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[DeviceParam]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[DeviceParam](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[bDeviceDefault] [bit] NOT NULL,
	[bParamDefault] [bit] NOT NULL,
	[ucCalibrationType] [tinyint] NOT NULL,
	[lfCalibration1] [float] NULL,
	[lfValue1] [float] NULL,
	[lfCalibration2] [float] NULL,
	[lfValue2] [float] NULL,
	[sUserName] [nvarchar](100) NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[DeviceParam_VehicleDeviceParam]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[DeviceParam_VehicleDeviceParam](
	[VehicleID] [smallint] NOT NULL,
	[DeviceID] [int] NOT NULL,
	[ParameterID] [smallint] NOT NULL,
	[IsDeviceDefault] [bit] NOT NULL,
	[IsParameterDefault] [bit] NOT NULL,
	[CalibrationType] [tinyint] NOT NULL,
	[Calibration1] [float] NULL,
	[Value1] [float] NULL,
	[Calibration2] [float] NULL,
	[Value2] [float] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[Devices]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[Devices](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[sDescription] [nvarchar](200) NOT NULL,
	[sSystemName] [nvarchar](255) NULL,
	[ucDeviceType] [tinyint] NOT NULL,
	[bCanRecordInterval] [bit] NOT NULL,
	[sReportProgID] [nvarchar](200) NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_Devices] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[liDeviceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[DeviceTypes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[DeviceTypes](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[ucDeviceType] [tinyint] NOT NULL,
	[sDescription] [nvarchar](50) NULL,
	[ucValueFormat] [tinyint] NULL,
	[bCanRecordInterval] [bit] NULL,
	[bIsActive] [bit] NULL,
	[ucCalibrationType] [tinyint] NULL,
	[lfCalibration1] [float] NULL,
	[lfValue1] [float] NULL,
	[lfCalibration2] [float] NULL,
	[lfValue2] [float] NULL,
	[ucResolution] [tinyint] NULL,
	[sPropertyProgID] [nvarchar](200) NULL,
	[sReportProgID] [nvarchar](200) NULL,
	[sConfigProgID] [nvarchar](200) NULL,
 CONSTRAINT [PK_DeviceTypes] PRIMARY KEY CLUSTERED 
(
	[ucDeviceType] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[DriverCertifications]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[DriverCertifications](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iDriverID] [smallint] NOT NULL,
	[liCertificationID] [int] NOT NULL,
	[dtObtained] [datetime] NOT NULL,
	[sInstructor] [nvarchar](50) NOT NULL,
	[bInstructorQualified] [bit] NOT NULL,
	[sLocation] [nvarchar](100) NOT NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[DriverConfig]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[DriverConfig](
	[liGroupID] [int] NOT NULL,
	[sName] [nvarchar](255) NOT NULL,
	[sNote] [nvarchar](2048) NULL,
	[GroupGUID] [uniqueidentifier] NOT NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[DriverLicenceCodes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[DriverLicenceCodes](
	[liLicenceID] [int] NOT NULL,
	[liCountryID] [int] NULL,
	[sLicenceCode] [nvarchar](20) NULL,
	[sDescription] [nvarchar](250) NULL,
	[iExpiryMonths] [smallint] NULL,
	[iRemindWeeks] [smallint] NULL,
 CONSTRAINT [PK_DriverLicenceCodes] PRIMARY KEY CLUSTERED 
(
	[liLicenceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[DriverLicences]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[DriverLicences](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[iDriverID] [smallint] NOT NULL,
	[liLicenceID] [int] NOT NULL,
	[dtObtained] [datetime] NOT NULL,
	[dtExpires] [datetime] NULL,
 CONSTRAINT [PK_DriverLicences] PRIMARY KEY NONCLUSTERED 
(
	[RID] ASC,
	[iDriverID] ASC,
	[liLicenceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[DriverReporting]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[DriverReporting](
	[liGroupID] [int] NOT NULL,
	[GroupGUID] [uniqueidentifier] NOT NULL,
	[sName] [nvarchar](510) NULL,
	[sNote] [nvarchar](max) NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[DriverReportingGroups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[DriverReportingGroups](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liGroupID] [int] NOT NULL,
	[iDriverID] [int] NOT NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[Drivers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[Drivers](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetime] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[DriverGUID] [uniqueidentifier] NOT NULL,
	[iDriverID] [smallint] NOT NULL,
	[liSiteID] [int] NOT NULL,
	[liGroupID] [int] NOT NULL,
	[sEmployeeNumber] [nvarchar](255) NULL,
	[sName] [nvarchar](255) NOT NULL,
	[bLicense] [bit] NOT NULL,
	[dtLastLicense] [datetime] NULL,
	[dtNextLicense] [datetime] NULL,
	[ucLicenseInterval] [tinyint] NULL,
	[dtDistanceChecked] [datetime] NULL,
	[sExtendedID] [varchar](32) NULL,
	[ucLicenseRemind] [tinyint] NULL,
 CONSTRAINT [PK_Drivers] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iDriverID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[EventData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[EventData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[EventKey] [int] NOT NULL,
	[VehicleID] [smallint] NULL,
	[DriverID] [smallint] NULL,
	[OriginalDriverID] [smallint] NULL,
	[EventID] [smallint] NULL,
	[EventType] [tinyint] NULL,
	[StartSequence] [int] NULL,
	[StartDate] [datetime] NULL,
	[StartOdometer] [decimal](19, 5) NULL,
	[StartGPSID] [int] NULL,
	[EndSequence] [int] NULL,
	[EndDate] [datetime] NULL,
	[EndOdometer] [decimal](19, 5) NULL,
	[EndGPSID] [int] NULL,
	[TotalTime] [int] NULL,
	[TotalOccurs] [int] NULL,
	[Value] [float] NULL,
	[Litres] [decimal](9, 4) NULL,
	[PulseParameterID] [smallint] NULL,
	[PulseValue] [float] NULL,
	[VideoKey] [bigint] NULL,
 CONSTRAINT [PK_EventData] PRIMARY KEY CLUSTERED 
(
	[EventKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[EventDescription]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[EventDescription](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[sDescription] [nvarchar](50) NOT NULL,
	[sSystemName] [nvarchar](255) NULL,
	[sCriticalID] [nchar](5) NULL,
	[ucSummaryType] [tinyint] NULL,
	[iSummaryID] [smallint] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_EventDescription] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iEventID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[EventTriggers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[EventTriggers](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucTriggerID] [tinyint] NOT NULL,
	[ucSeq] [tinyint] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[ucOperator] [tinyint] NOT NULL,
	[lfValue] [float] NOT NULL,
	[bRequired] [bit] NOT NULL,
	[ucTOper] [tinyint] NULL,
	[sUserName] [nvarchar](100) NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[ExtensionProperties_DIM]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[ExtensionProperties_DIM](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[sAppID] [nvarchar](20) NOT NULL,
	[liObjectType] [int] NOT NULL,
	[liObjectID] [int] NOT NULL,
	[sProperty] [nvarchar](50) NOT NULL,
	[sValue] [nvarchar](max) NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[ExtensionProperties_FACT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[ExtensionProperties_FACT](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[sAppID] [nvarchar](20) NOT NULL,
	[liObjectType] [int] NOT NULL,
	[liObjectID] [int] NOT NULL,
	[sProperty] [nvarchar](50) NOT NULL,
	[sValue] [nvarchar](max) NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[FuelUsage]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[FuelUsage](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liFuelKey] [int] NOT NULL,
	[iVehicleID] [smallint] NULL,
	[dtFillDate] [datetime] NULL,
	[fFillOdo] [real] NULL,
	[liEngineSeconds] [int] NULL,
	[fLitres] [real] NULL,
	[sCur] [nchar](3) NULL,
	[fCost] [money] NULL,
	[sBaseCur] [nchar](3) NULL,
	[fBaseCost] [money] NULL,
 CONSTRAINT [PK_FuelUsage] PRIMARY KEY CLUSTERED 
(
	[liFuelKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[GPSData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[GPSData](
	[liGPSID] [int] NOT NULL,
	[fLatitude] [real] NULL,
	[fLongitude] [real] NULL,
 CONSTRAINT [PK_GPSData] PRIMARY KEY CLUSTERED 
(
	[liGPSID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[GroupTriggers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[GroupTriggers](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[liGroupID] [int] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucTriggerID] [tinyint] NOT NULL,
	[ucSeq] [tinyint] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[ucOperator] [tinyint] NOT NULL,
	[lfValue] [float] NOT NULL,
	[bRequired] [bit] NOT NULL,
	[ucTOper] [tinyint] NULL,
	[sUserName] [nvarchar](100) NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[GroupTriggers_VehicleTriggers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[GroupTriggers_VehicleTriggers](
	[iVehicleID] [int] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucTriggerID] [tinyint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[ucSeq] [tinyint] NULL,
	[iParameterID] [smallint] NULL,
	[ucOperator] [tinyint] NULL,
	[lfValue] [float] NULL,
	[bRequired] [bit] NULL,
	[ucTOper] [tinyint] NULL,
 CONSTRAINT [PK_GroupTriggers_VehicleTriggers] PRIMARY KEY CLUSTERED 
(
	[iVehicleID] ASC,
	[iEventID] ASC,
	[ucTriggerID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[MapLocationPolygonPoints]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[MapLocationPolygonPoints](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liLocationID] [int] NOT NULL,
	[liSequence] [int] NULL,
	[fLongitude] [real] NULL,
	[fLatitude] [real] NULL,
 CONSTRAINT [UK_MapLocationPolygonPoints] UNIQUE NONCLUSTERED 
(
	[liLocationID] ASC,
	[liSequence] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[MapLocations]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[MapLocations](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liLocationID] [int] NOT NULL,
	[sLocationName] [nvarchar](100) NULL,
	[sDetails] [nvarchar](3500) NULL,
	[ucLocationType] [tinyint] NULL,
	[ucShapeType] [tinyint] NULL,
	[ucLocationSource] [tinyint] NULL,
	[fPointLongitude] [real] NULL,
	[fPointLatitude] [real] NULL,
	[liPointRadius] [int] NULL,
	[fUpperLeftLongitude] [real] NULL,
	[fUpperLeftLatitude] [real] NULL,
	[fLowerRightLongitude] [real] NULL,
	[fLowerRightLatitude] [real] NULL,
	[bDeleted] [bit] NULL,
	[bShowOnMap] [bit] NULL,
	[bReadOnly] [bit] NULL,
	[ucTaxType] [tinyint] NULL,
	[liSiteID] [int] NULL,
 CONSTRAINT [PK_MapLocations] PRIMARY KEY CLUSTERED 
(
	[liLocationID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[OrgOptions]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[OrgOptions](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[sLPDealerName] [nvarchar](50) NULL,
	[sLPDealerTelNo] [nvarchar](20) NULL,
	[sLPRegCode] [nvarchar](50) NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[Param]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[Param](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[sDescription] [nvarchar](200) NULL,
	[sSystemName] [nvarchar](255) NULL,
	[ucValueFormat] [tinyint] NULL,
	[sUnits] [nvarchar](10) NULL,
	[bSystem] [bit] NULL,
	[bFuelCounter] [bit] NULL,
	[bProfiled] [bit] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_Param] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[PassengerData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[PassengerData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[RID] [int] NULL,
	[VehicleID] [smallint] NOT NULL,
	[BlockSequence] [int] NOT NULL,
	[PassengerID] [smallint] NULL,
	[IdentifiedDate] [datetime] NULL,
	[Odometer] [decimal](19, 5) NULL,
 CONSTRAINT [PK_PassengerData] PRIMARY KEY CLUSTERED 
(
	[VehicleID] ASC,
	[BlockSequence] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[Passengers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[Passengers](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[PassengerGUID] [uniqueidentifier] NOT NULL,
	[iPassengerID] [smallint] NOT NULL,
	[sName] [nvarchar](255) NOT NULL,
 CONSTRAINT [PK_Passengers] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iPassengerID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[ProfileData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[ProfileData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[RID] [int] NULL,
	[TripID] [int] NOT NULL,
	[SubTripSequence] [smallint] NOT NULL,
	[ParameterID] [smallint] NOT NULL,
	[Sequence] [smallint] NOT NULL,
	[Duration] [float] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[QuarantinedDataSummary]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[QuarantinedDataSummary](
	[SourceTable] [varchar](50) NULL,
	[VehicleID] [int] NULL,
	[ChangeDateKey] [date] NULL,
	[Occurrences] [int] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_CalibrationParameters]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_CalibrationParameters](
	[ParameterKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [smallint] NOT NULL,
	[Description] [nvarchar](200) NOT NULL,
	[Units] [nvarchar](20) NULL,
	[ValueFormat] [tinyint] NOT NULL,
	[IsFuelCounter] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_Certifications]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_Certifications](
	[CertificationKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[ChangeDate] [date] NULL,
	[HostID] [int] NULL,
	[DriverGUID] [uniqueidentifier] NULL,
	[TrailerGUID] [uniqueidentifier] NULL,
	[VehicleGUID] [uniqueidentifier] NULL,
	[CertificationTypeLookupKey] [int] NULL,
	[CertificationDescription] [nvarchar](255) NULL,
	[ExpirationDateKey] [date] NULL,
	[ObtainedDateKey] [date] NULL,
	[LastRenewalDateKey] [date] NULL,
	[CertificationDurationDays] [int] NULL,
	[CertificationReminderDays] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_Devices]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_Devices](
	[DeviceKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [int] NOT NULL,
	[DeviceType] [nvarchar](50) NULL,
	[DeviceName] [nvarchar](200) NULL,
	[SystemName] [nvarchar](255) NULL,
	[ReportProgID] [nvarchar](200) NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_Drivers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_Drivers](
	[DriverKey] [int] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[EndDateKey] [date] NOT NULL,
	[IsCurrentRecord] [bit] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [int] NOT NULL,
	[DriverGUID] [uniqueidentifier] NULL,
	[IsActive] [bit] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[SiteKey] [int] NULL,
	[DriverName] [nvarchar](255) NULL,
	[DriverEmployeeNumber] [nvarchar](255) NULL,
	[DriverExtendedID] [varchar](32) NULL,
	[ConfigurationGroupName] [nvarchar](255) NULL,
	[UTCOffsetKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_EventDescriptions]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_EventDescriptions](
	[EventDescriptionKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [int] NULL,
	[EventName] [nvarchar](255) NULL,
	[ParameterKey] [int] NULL,
	[SummaryTypeLookupKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_EventGroups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_EventGroups](
	[EventGroupKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[EventGroupnameLookupKey] [int] NOT NULL,
	[EventDescriptionKey] [int] NOT NULL,
	[EventGroupCategory] [nvarchar](25) NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_GeoLocationsToShapes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_GeoLocationsToShapes](
	[GeoLocationToShapeKey] [bigint] NOT NULL,
	[GeoLocationKey] [bigint] NOT NULL,
	[ShapeKey] [int] NOT NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_Organisations_Late]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_Organisations_Late](
	[OrganisationKey] [int] NOT NULL,
	[OrganisationGUID] [uniqueidentifier] NULL,
	[DealerName] [nvarchar](50) NULL,
	[DealerTelNo] [nchar](20) NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_Passengers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_Passengers](
	[PassengerKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[StartDateKey] [date] NULL,
	[EndDateKey] [date] NULL,
	[IsCurrentRecord] [bit] NULL,
	[HostID] [int] NULL,
	[PassengerGUID] [uniqueidentifier] NULL,
	[PassengerName] [nvarchar](255) NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_ReportingGroups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_ReportingGroups](
	[ReportingGroupKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[ReportingGroupTypeLookupKey] [int] NULL,
	[HostID] [int] NULL,
	[ReportingGroupGUID] [uniqueidentifier] NULL,
	[ReportingGroupName] [nvarchar](510) NULL,
	[MemberGUID] [uniqueidentifier] NULL,
	[ReportingGroupParentKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_Shapes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_Shapes](
	[ShapeKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [int] NOT NULL,
	[SiteKey] [int] NULL,
	[ShapeType] [tinyint] NOT NULL,
	[ShapeName] [nvarchar](100) NOT NULL,
	[ShapeBoundaryType] [tinyint] NOT NULL,
	[ShapeBoundary] [geography] NULL,
	[ShapeTaxTypeLookupKey] [int] NULL,
	[IsDeleted] [bit] NOT NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_SimpleScoreCriteria]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_SimpleScoreCriteria](
	[ScoreCriteriaKey] [int] NOT NULL,
	[StartDateKey] [date] NULL,
	[EndDateKey] [date] NULL,
	[IsCurrentRecord] [bit] NULL,
	[IsActive] [bit] NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [int] NULL,
	[EventDescriptionKey] [int] NULL,
	[TriggerID] [int] NULL,
	[ScoreDuration] [float] NULL,
	[ScoreSeverity] [float] NULL,
	[ScoreWeight] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_Sites]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_Sites](
	[SiteKey] [int] NOT NULL,
	[StartDateKey] [int] NULL,
	[EndDateKey] [int] NULL,
	[IsActiveRecord] [bit] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [int] NULL,
	[SiteName] [nvarchar](510) NULL,
	[MemberOfSiteGUID] [uniqueidentifier] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_Trailers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_Trailers](
	[TrailerKey] [int] NOT NULL,
	[StartDateKey] [date] NULL,
	[EndDateKey] [date] NULL,
	[IsCurrentRecord] [bit] NULL,
	[IsActive] [bit] NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [int] NULL,
	[TrailerGUID] [uniqueidentifier] NULL,
	[TrailerAssetNumber] [nvarchar](255) NULL,
	[TrailerRegNumber] [nvarchar](15) NULL,
	[TrailerDescription] [nvarchar](255) NULL,
	[TrailerUnitID] [int] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[UnitTypeLookupKey] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_Units]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_Units](
	[UnitKey] [int] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[EndDateKey] [date] NOT NULL,
	[IsCurrentRecord] [bit] NOT NULL,
	[IsActive] [bit] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[AssetHostID] [int] NOT NULL,
	[AssetTypeLookupKey] [int] NOT NULL,
	[UnitSerial] [nvarchar](50) NULL,
	[AssetGUID] [uniqueidentifier] NULL,
	[UnitTypeLookupKey] [int] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[OSVersion] [nvarchar](50) NULL,
	[FirmwareVersion] [nvarchar](50) NULL,
	[FirmwareLoadedDateKey] [date] NULL,
	[UTCOffsetKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_VehicleCostCategories]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_VehicleCostCategories](
	[VehicleCostCategoryKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [int] NULL,
	[CategoryName] [nvarchar](50) NULL,
	[CategoryNotes] [nvarchar](255) NULL,
	[Type] [nvarchar](10) NULL,
	[IsRecurring] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_VehicleDeviceParameters]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_VehicleDeviceParameters](
	[VehicleDeviceParameterKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NOT NULL,
	[DeviceKey] [int] NOT NULL,
	[ParameterKey] [int] NOT NULL,
	[IsDeviceDefault] [bit] NOT NULL,
	[IsParameterDefault] [bit] NOT NULL,
	[CalibrationType] [tinyint] NOT NULL,
	[CalibrationProperties] [xml] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_VehicleDevices]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_VehicleDevices](
	[VehicleDeviceKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NOT NULL,
	[DeviceKey] [int] NOT NULL,
	[InputLine] [char](2) NULL,
	[DeviceProperties] [xml] NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_VehicleEventDefinitions]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_VehicleEventDefinitions](
	[VehicleEventKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[VehicleGUID] [uniqueidentifier] NOT NULL,
	[EventDescriptionKey] [int] NOT NULL,
	[EventType] [tinyint] NULL,
	[InUse] [bit] NULL,
	[RecordStartOdometer] [bit] NULL,
	[RecordStartPosition] [bit] NULL,
	[RecordEndOdometer] [bit] NULL,
	[RecordEndPosition] [bit] NULL,
	[RecordPulseCount] [bit] NULL,
	[SendActivePosition] [bit] NULL,
	[StartRecordDelay] [smallint] NULL,
	[StartAlarmDelay] [smallint] NULL,
	[StartExternalRelay1Delay] [smallint] NULL,
	[StartExternalRelay2Delay] [smallint] NULL,
	[StartCriticalDisplayDelay] [smallint] NULL,
	[ActiveSendDelay] [smallint] NULL,
	[ActiveEndSendDelay] [smallint] NULL,
	[StartActiveTrackDelay] [smallint] NULL,
	[ActiveTrackInterval] [smallint] NULL,
	[AlarmState] [tinyint] NULL,
	[ExternalRelay1State] [tinyint] NULL,
	[ExternalRelay2State] [tinyint] NULL,
	[WarningMessage] [nvarchar](255) NULL,
	[ActiveMessagePriority] [tinyint] NULL,
	[EventTriggerDefinition] [xml] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_VehicleProfiles]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_VehicleProfiles](
	[VehicleProfileKey] [int] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[EndDateKey] [date] NOT NULL,
	[IsCurrentRecord] [bit] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NOT NULL,
	[ParameterKey] [int] NOT NULL,
	[RangeLowerValue1] [float] SPARSE  NULL,
	[RangeLowerValue2] [float] SPARSE  NULL,
	[RangeLowerValue3] [float] SPARSE  NULL,
	[RangeLowerValue4] [float] SPARSE  NULL,
	[RangeLowerValue5] [float] SPARSE  NULL,
	[RangeLowerValue6] [float] SPARSE  NULL,
	[RangeLowerValue7] [float] SPARSE  NULL,
	[RangeLowerValue8] [float] SPARSE  NULL,
	[RangeLowerValue9] [float] SPARSE  NULL,
	[RangeLowerValue10] [float] SPARSE  NULL,
	[RangeLowerValue11] [float] SPARSE  NULL,
	[UTCOffsetKey] [smallint] NOT NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_DIM_Vehicles]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_DIM_Vehicles](
	[VehicleKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[EndDateKey] [date] NOT NULL,
	[IsCurrentRecord] [bit] NOT NULL,
	[IsActive] [bit] NOT NULL,
	[HostID] [int] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NULL,
	[VehicleDescription] [nvarchar](255) NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[SiteKey] [int] NULL,
	[LastServiceDateKey] [date] NULL,
	[IsYellowEquip] [bit] NULL,
	[RegNumber] [nvarchar](15) NULL,
	[ServiceByDistance] [decimal](19, 4) NULL,
	[ServiceByDate] [tinyint] NULL,
	[ServiceByEngineSeconds] [int] NULL,
	[NextServiceDueDistance] [decimal](19, 4) NULL,
	[NextServiceDueDateKey] [date] NULL,
	[NextServiceDueEngineSeconds] [int] NULL,
	[DefaultDriverGUID] [uniqueidentifier] NULL,
	[TargetFuelConsumption] [real] NULL,
	[TargetFuelConsumptionHourly] [real] NULL,
	[ScoreTriggerOverspeeding] [float] NULL,
	[ScoreTriggerOverRevving] [float] NULL,
	[ScoreTriggerOverHarshDeceleration] [float] NULL,
	[ScoreTriggerOverHarshAccelleration] [float] NULL,
	[TermScriptConfigGroup] [int] NULL,
	[ConfigurationGroupNameID] [int] NULL,
	[ConfigurationGroupName] [nvarchar](255) NULL,
	[FuelTypeLookupKey] [int] NULL,
	[EstimateCO2EmissionGramsperKm] [float] NULL,
	[UnitTypeLookupKey] [int] NULL,
	[BatteryVoltage] [numeric](19, 6) NULL,
	[CurrentDeviceDriverVersion] [nvarchar](25) NULL,
	[LastDeviceDriverUploadDateTime] [datetimeoffset](0) NULL,
	[LastConfigurationUploadDateTime] [datetimeoffset](0) NULL,
	[LastDeviceChangeDateTime] [datetimeoffset](0) NULL,
	[LastEventChangeDateTime] [datetimeoffset](0) NULL,
	[CreateDateKey] [date] NULL,
	[IsMeasuringFuel] [bit] NULL,
	[IsCofiguredForMeasuringFuel] [bit] NULL,
	[UTCOffsetKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_ActivityDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_ActivityDetails](
	[ActivityDetailKey] [bigint] NOT NULL,
	[ActivitySummaryKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [int] NOT NULL,
	[VehicleSiteKey] [int] NULL,
	[ActivityStartDateKey] [date] NULL,
	[ActivityEndDateKey] [date] NULL,
	[ActivityStartTime] [time](0) NULL,
	[ActivityEndTime] [time](0) NULL,
	[ActivityStartDateTime] [datetimeoffset](0) NULL,
	[ActivityEndDateTime] [datetimeoffset](0) NULL,
	[MovementStartDateKey] [date] NULL,
	[MovementEndDateKey] [date] NULL,
	[MovementStartTime] [time](0) NULL,
	[MovementEndTime] [time](0) NULL,
	[MovementStartDateTime] [datetimeoffset](0) NULL,
	[MovementEndDateTime] [datetimeoffset](0) NULL,
	[NextMovementActivityDetailKey] [bigint] NULL,
	[NextMovementStartDateTime] [datetimeoffset](0) NULL,
	[IsLastMovement] [bit] NULL,
	[StartOdometer] [decimal](19, 4) NULL,
	[EndOdometer] [decimal](19, 4) NULL,
	[StartEngineSeconds] [int] NULL,
	[EndEngineSeconds] [int] NULL,
	[StartGeoLocationKey] [bigint] NULL,
	[EndGeoLocationKey] [bigint] NULL,
	[DistanceTravelled] [decimal](19, 4) NULL,
	[Duration] [int] NULL,
	[DrivingTime] [int] NULL,
	[StandingTime] [int] NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[SpeedTime] [int] NULL,
	[SpeedOccurs] [int] NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[BrakeTime] [int] NULL,
	[BrakeOccurs] [int] NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[AccelTime] [int] NULL,
	[AccelOccurs] [int] NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[RPMTIme] [int] NULL,
	[RPMOccurs] [int] NULL,
	[OutOfGreenBandTime] [int] NULL,
	[ExcessiveIdleTime] [int] NULL,
	[ExcessiveIdleOccurs] [int] NULL,
	[IdleTime] [int] NULL,
	[IdleOccurs] [int] NULL,
	[EngineSeconds] [int] NULL,
	[NoGoZoneEntry] [bit] NULL,
	[Passengers] [smallint] NULL,
	[FuelUsedMeasured] [decimal](9, 4) NULL,
	[FuelUsedCalculated] [decimal](9, 4) NULL,
	[FuelUsedHierarchy] [smallint] NULL,
	[NightDuration] [int] NULL,
	[AfterHoursDuration] [int] NULL,
	[TotalCarbonEmission] [float] NULL,
	[TotalCO2Emission] [float] NULL,
	[PulseParameterKey] [int] NULL,
	[PulseValue] [float] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[RoadSpeedTime] [int] NULL,
	[RoadSpeedOccurs] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_ActivitySummary]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_ActivitySummary](
	[ActivitySummaryKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [bigint] NOT NULL,
	[UnitTripNumber] [bigint] NOT NULL,
	[ActivityStartDateKey] [date] NOT NULL,
	[ActivityEndDateKey] [date] NOT NULL,
	[ActivityStartTime] [time](0) NULL,
	[ActivityEndTime] [time](0) NULL,
	[ActivityStartDateTime] [datetimeoffset](0) NOT NULL,
	[ActivityEndDateTime] [datetimeoffset](0) NOT NULL,
	[VehicleKey] [int] NULL,
	[DriverKey] [int] NULL,
	[OriginalDriverKey] [int] NULL,
	[OriginalDriverSiteKey] [int] NULL,
	[OriginalVehicleSiteKey] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[TotalFuelUsedMeasured] [decimal](19, 4) NULL,
	[TotalFuelUsedCalculated] [decimal](19, 4) NULL,
	[StartOdometer] [decimal](19, 4) NULL,
	[EndOdometer] [decimal](19, 4) NULL,
	[StartEngineSeconds] [int] NULL,
	[EndEngineSeconds] [int] NULL,
	[StartGeoLocationKey] [bigint] NULL,
	[EndGeoLocationKey] [bigint] NULL,
	[AverageSimpleDriverScore] [decimal](19, 5) NULL,
	[TotalDuration] [int] NULL,
	[TotalDistanceTravelled] [decimal](19, 4) NULL,
	[TotalDrivingTime] [int] NULL,
	[TotalEngineSeconds] [int] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[TotalIdleTime] [int] NULL,
	[TotalPassengers] [smallint] NULL,
	[TotalStandingTime] [int] NULL,
	[TotalNightDuration] [int] NULL,
	[TotalAfterHoursDuration] [int] NULL,
	[TotalCarbonEmission] [float] NULL,
	[TotalCO2Emission] [float] NULL,
	[TripClassificationLookupKey] [int] NULL,
	[TripClassificationHierarchy] [smallint] NULL,
	[IsDutchTaxTripClassification] [bit] NULL,
	[MovementCount] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_EventDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_EventDetails](
	[EventDetailKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [bigint] NOT NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[TrailerKey] [int] NULL,
	[EventDescriptionKey] [int] NULL,
	[EventTypeLookupKey] [int] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[EventStartDateKey] [date] NULL,
	[EventEndDateKey] [date] NULL,
	[EventStartTime] [time](0) NULL,
	[EventEndTime] [time](0) NULL,
	[EventStartDateTime] [datetimeoffset](0) NULL,
	[EventEndDateTime] [datetimeoffset](0) NULL,
	[StartOdometer] [decimal](19, 4) NULL,
	[EndOdometer] [decimal](19, 4) NULL,
	[EventValue] [float] NULL,
	[StartGeoLocationKey] [bigint] NULL,
	[EndGeoLocationKey] [bigint] NULL,
	[TotalOccurs] [int] NULL,
	[TotalTime] [int] NULL,
	[ParameterKey] [int] NULL,
	[Litres] [decimal](9, 4) NULL,
	[PulseParameterKey] [int] NULL,
	[PulseValue] [float] NULL,
	[UTCOffsetKey] [int] NULL,
	[VideoKey] [bigint] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_EventRoadspeedLimits]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_EventRoadspeedLimits](
	[EventDetailKey] [bigint] NOT NULL,
	[EventStartDateKey] [date] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[SpeedLimit] [decimal](9, 5) NULL,
	[IsDeleted] [bit] NOT NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_EventSummary]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_EventSummary](
	[EventSummaryKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[VehicleSiteKey] [int] NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NOT NULL,
	[TrailerKey] [int] NULL,
	[EventDescriptionKey] [int] NOT NULL,
	[EventStartDateKey] [date] NOT NULL,
	[NumberOfEvents] [int] NULL,
	[MaxEventValue] [float] NULL,
	[MinEventValue] [float] NULL,
	[AvgEventValue] [float] NULL,
	[TotalEventValue] [float] NULL,
	[TotalOccurs] [int] NULL,
	[TotalTime] [int] NULL,
	[TotalLitres] [decimal](19, 4) NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_FuelCapture]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_FuelCapture](
	[FuelCapturekey] [bigint] NOT NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [bigint] NULL,
	[VehicleKey] [int] NOT NULL,
	[FillDateKey] [date] NOT NULL,
	[FillTime] [time](0) NULL,
	[FillDateTime] [datetimeoffset](0) NOT NULL,
	[PreviousFillDateTime] [datetimeoffset](0) NULL,
	[Litres] [real] NULL,
	[BaseCost] [money] NULL,
	[BaseCurrencyKey] [int] NULL,
	[FillOdometer] [decimal](19, 5) NULL,
	[PreviousFillOdometer] [decimal](19, 5) NULL,
	[EngineSeconds] [int] NULL,
	[PreviousEngineSeconds] [int] NULL,
	[DistanceTravelled] [decimal](19, 5) NULL,
	[FillFuelConsumption] [real] NULL,
	[ActivityDetailKey] [int] NULL,
	[FuelStopGeoLocationKey] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_PassengerActivities]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_PassengerActivities](
	[PassengerActivityKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [int] NOT NULL,
	[PassengerKey] [int] NOT NULL,
	[VehicleKey] [int] NOT NULL,
	[ActivitySummaryKey] [bigint] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[IdentifiedDateKey] [date] NOT NULL,
	[IdentifiedTime] [time](0) NULL,
	[IdentifiedDateTime] [datetimeoffset](0) NOT NULL,
	[Odometer] [decimal](19, 4) NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_ProfileDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_ProfileDetails](
	[ProfileDetailKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostTripID] [int] NOT NULL,
	[HostSequenceID] [smallint] NOT NULL,
	[HostParameterID] [smallint] NOT NULL,
	[VehicleKey] [int] NOT NULL,
	[ParameterKey] [int] NOT NULL,
	[VehicleProfileKey] [int] NULL,
	[ActivityDetailKey] [bigint] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[StartTime] [time](0) NOT NULL,
	[StartDateTime] [datetimeoffset](0) NOT NULL,
	[EndDateKey] [date] NOT NULL,
	[EndTime] [time](0) NOT NULL,
	[EndDateTime] [datetimeoffset](0) NOT NULL,
	[RangeDuration0] [int] SPARSE  NULL,
	[RangeDuration1] [int] SPARSE  NULL,
	[RangeDuration2] [int] SPARSE  NULL,
	[RangeDuration3] [int] SPARSE  NULL,
	[RangeDuration4] [int] SPARSE  NULL,
	[RangeDuration5] [int] SPARSE  NULL,
	[RangeDuration6] [int] SPARSE  NULL,
	[RangeDuration7] [int] SPARSE  NULL,
	[RangeDuration8] [int] SPARSE  NULL,
	[RangeDuration9] [int] SPARSE  NULL,
	[RangeDuration10] [int] SPARSE  NULL,
	[RangeDuration11] [int] SPARSE  NULL,
	[UTCOffsetKey] [int] NOT NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_ServiceHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_ServiceHistory](
	[ServiceHistoryKeyID] [bigint] NOT NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [int] NULL,
	[VehicleKey] [int] NULL,
	[ServiceDateKey] [date] NOT NULL,
	[ServiceDateTime] [datetimeoffset](0) NOT NULL,
	[Odometer] [real] NOT NULL,
	[EngineSeconds] [int] NULL,
	[Reference] [nvarchar](50) NULL,
	[BaseCost] [money] NULL,
	[BaseCurrencyKey] [int] NULL,
	[Notes] [nvarchar](max) NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_ShapeVisits]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_ShapeVisits](
	[ShapeVisitKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[VisitDateKey] [date] NOT NULL,
	[ShapeKey] [int] NOT NULL,
	[VehicleKey] [int] NOT NULL,
	[DriverKey] [int] NULL,
	[DurationAtLocation] [int] NULL,
	[NumberOfVisits] [int] NULL,
	[NumberOfUniqueVisits] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_SimpleScoreDaily]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_SimpleScoreDaily](
	[SimpleScoreDailyKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[SnapShotDateKey] [date] NOT NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[DistanceTravelled] [decimal](19, 4) NULL,
	[DrivingTime] [int] NULL,
	[Duration] [int] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[SpeedTime] [int] NULL,
	[SpeedOccurs] [int] NULL,
	[SpeedScoreByDuration] [decimal](19, 5) NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[BrakeTime] [int] NULL,
	[BrakeOccurs] [int] NULL,
	[BrakeScoreByDuration] [decimal](19, 5) NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[AccelTime] [int] NULL,
	[AccelOccurs] [int] NULL,
	[AccelScoreByDuration] [decimal](19, 5) NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[RPMTime] [int] NULL,
	[RPMOccurs] [int] NULL,
	[RPMScoreByDuration] [decimal](19, 5) NULL,
	[OutOfGreenBandTime] [int] NULL,
	[OutOfGreenBandScoreByDuration] [decimal](19, 5) NULL,
	[ExcessiveIdleOccurs] [int] NULL,
	[ExcessiveIdleTime] [int] NULL,
	[ExcessiveIdleScoreByDuration] [decimal](19, 5) NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[RoadSpeedTime] [int] NULL,
	[RoadSpeedOccurs] [int] NULL,
	[RoadSpeedScoreByDuration] [decimal](19, 5) NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_SimpleScoreDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_SimpleScoreDetails](
	[SimpleScoreKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[ActivityStartDateKey] [date] NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[DistanceTravelled] [decimal](19, 4) NULL,
	[DrivingTime] [int] NULL,
	[Duration] [int] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[SpeedTime] [int] NULL,
	[SpeedOccurs] [int] NULL,
	[SpeedScore] [decimal](9, 5) NULL,
	[SpeedScoreCiteriaKey] [int] NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[BrakeTime] [int] NULL,
	[BrakeOccurs] [int] NULL,
	[BrakeScore] [decimal](9, 5) NULL,
	[BrakeScoreCiteriaKey] [int] NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[AccelTime] [int] NULL,
	[AccelOccurs] [int] NULL,
	[AccelScore] [decimal](9, 5) NULL,
	[AccelScoreCiteriaKey] [int] NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[RPMTime] [int] NULL,
	[RPMOccurs] [int] NULL,
	[RPMScore] [decimal](9, 5) NULL,
	[RPMScoreCiteriaKey] [int] NULL,
	[OutOfGreenBandTime] [int] NULL,
	[OutOfGreenBandScore] [decimal](9, 5) NULL,
	[OutOfGreenbandScoreCiteriaKey] [int] NULL,
	[ExcessiveIdleOccurs] [int] NULL,
	[ExcessiveIdleTime] [int] NULL,
	[ExcessiveIdleScore] [decimal](9, 5) NULL,
	[ExcessiveIdleScoreCiteriaKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[RoadSpeedTime] [int] NULL,
	[RoadSpeedOccurs] [int] NULL,
	[RoadSpeedScore] [decimal](9, 5) NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_SiteSnapshotDaily]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_SiteSnapshotDaily](
	[SiteSnapShotKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[SnapShotDateKey] [date] NOT NULL,
	[VehicleSiteKey] [int] NULL,
	[VehiclesWithTrips] [smallint] NULL,
	[DriversWithTrips] [smallint] NULL,
	[NumberOfTrips] [int] NULL,
	[NumberOfCollisions] [int] NULL,
	[NumberOfKMs] [decimal](19, 4) NULL,
	[NumberOfHours] [int] NULL,
	[FuelUsedMeasured] [decimal](9, 4) NULL,
	[FuelUsedCalculated] [decimal](9, 4) NULL,
	[TotalIdlingTime] [int] NULL,
	[NumberOfActiveVehicles] [int] NULL,
	[NumberOfActiveDrivers] [int] NULL,
	[VehicleUtilization] [int] NULL,
	[DriverUtilization] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_TachoData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_TachoData](
	[TachoDataKey] [bigint] NOT NULL,
	[HostID] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[BlockSequence] [int] NOT NULL,
	[VehicleKey] [int] NOT NULL,
	[TachoStartDateKey] [date] NOT NULL,
	[TachoEndDateKey] [date] NOT NULL,
	[TachoStartDateTime] [datetimeoffset](0) NOT NULL,
	[TachoEndDateTime] [datetimeoffset](0) NOT NULL,
	[RawData] [binary](1024) NULL,
	[MaxSpeed] [int] NULL,
	[MinSpeed] [int] NULL,
	[AvgSpeed] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_TerminalDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_TerminalDetails](
	[TerminalDetailKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [bigint] NOT NULL,
	[VehicleKey] [int] NOT NULL,
	[DriverKey] [int] NULL,
	[TerminalDateKey] [date] NOT NULL,
	[TerminalTime] [time](0) NOT NULL,
	[TerminalDateTime] [datetimeoffset](0) NULL,
	[Odometer] [decimal](19, 4) NULL,
	[MenuID] [char](5) NULL,
	[MenuItemCode] [char](5) NULL,
	[ValueType] [tinyint] NULL,
	[NumberValue] [float] NULL,
	[StringValue] [nvarchar](255) NULL,
	[ActivityDetailKey] [bigint] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[ROLLBACK_FACT_VehicleCosts]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[ROLLBACK_FACT_VehicleCosts](
	[VehicleCostKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [nvarchar](50) NULL,
	[CostDateKey] [date] NOT NULL,
	[IsRecurring] [int] NULL,
	[VehicleKey] [int] NOT NULL,
	[OdometerReading] [decimal](19, 4) NULL,
	[CostCategoryKey] [int] NULL,
	[BaseCost] [money] NULL,
	[BaseCurrencyKey] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[ScoredEvents]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[ScoredEvents](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucScoreWeight] [tinyint] NOT NULL,
	[lfScoreDuration] [float] NOT NULL,
	[lfScoreSeverity] [float] NULL,
	[ucScoreTriggerID] [tinyint] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_ScoredEvents] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iEventID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[ServiceHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[ServiceHistory](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liServiceKey] [int] NOT NULL,
	[iVehicleID] [smallint] NULL,
	[dtServiceDate] [datetime] NULL,
	[fOdometer] [real] NULL,
	[liEngineSeconds] [int] NULL,
	[sReference] [nvarchar](50) NULL,
	[fCost] [money] NULL,
	[sCur] [nchar](3) NULL,
	[fBaseCost] [money] NULL,
	[sBaseCur] [nchar](3) NULL,
	[sNotes] [nvarchar](max) NULL,
 CONSTRAINT [PK_ServiceHistory] PRIMARY KEY NONCLUSTERED 
(
	[liServiceKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[Sites]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[Sites](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetime] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[liSiteID] [int] NOT NULL,
	[SiteGUID] [uniqueidentifier] NOT NULL,
	[sName] [nvarchar](255) NOT NULL,
 CONSTRAINT [PK_Sites] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[liSiteID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_DIM_CalibrationParameters]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_CalibrationParameters](
	[HostID] [smallint] NOT NULL,
	[Description] [nvarchar](200) NOT NULL,
	[Units] [nvarchar](20) NULL,
	[ValueFormat] [tinyint] NOT NULL,
	[IsFuelCounter] [bit] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_Certifications]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_Certifications](
	[MaxRID] [bigint] NULL,
	[ChangeDate] [date] NULL,
	[HostID] [int] NULL,
	[DriverGUID] [uniqueidentifier] NULL,
	[TrailerGUID] [uniqueidentifier] NULL,
	[VehicleGUID] [uniqueidentifier] NULL,
	[CertificationTypeLookupKey] [int] NULL,
	[CertificationDescription] [nvarchar](255) NULL,
	[ExpirationDateKey] [date] NULL,
	[ObtainedDateKey] [date] NULL,
	[LastRenewalDateKey] [date] NULL,
	[CertificationDurationDays] [int] NULL,
	[CertificationReminderDays] [int] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_Devices]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_Devices](
	[HostID] [int] NOT NULL,
	[DeviceType] [nvarchar](50) NULL,
	[DeviceName] [nvarchar](200) NULL,
	[SystemName] [nvarchar](255) NULL,
	[ReportProgID] [nvarchar](200) NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_Drivers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_Drivers](
	[DriverHostID] [smallint] NOT NULL,
	[DriverGUID] [uniqueidentifier] NULL,
	[SiteHostID] [int] NULL,
	[IsActive] [bit] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[SiteKey] [int] NULL,
	[DriverName] [nvarchar](255) NULL,
	[DriverEmployeeNumber] [nvarchar](255) NULL,
	[DriverExtendedID] [varchar](32) NULL,
	[ConfigurationGroupName] [nvarchar](255) NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_DIM_EventDescriptions]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_EventDescriptions](
	[MaxRID] [int] NULL,
	[HostID] [int] NULL,
	[EventName] [nvarchar](255) NULL,
	[SummaryID] [smallint] NULL,
	[ParameterKey] [int] NULL,
	[SummaryTypeLookupKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_EventGroups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_EventGroups](
	[EventID] [int] NULL,
	[EventGroupnameLookupKey] [int] NULL,
	[EventDescriptionKey] [int] NULL,
	[EventGroupCategory] [nvarchar](25) NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_GeoLocations]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_GeoLocations](
	[HostID] [int] NOT NULL,
	[Longitude] [real] NOT NULL,
	[Latitude] [real] NOT NULL,
	[GeoLocationKey] [bigint] NULL,
 CONSTRAINT [PK_STAGE_DIM_GeoLocations] PRIMARY KEY CLUSTERED 
(
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_GeoLocationsToShapes_ChangedShapes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_GeoLocationsToShapes_ChangedShapes](
	[ShapeKey] [int] NOT NULL,
	[ShapeBoundary] [geography] NULL,
PRIMARY KEY CLUSTERED 
(
	[ShapeKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_Organisations_Late]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_Organisations_Late](
	[DealerName] [nvarchar](50) NULL,
	[DealerTelNo] [nvarchar](20) NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_OrganisationsToGeoLocations]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_OrganisationsToGeoLocations](
	[GeoLocationKey] [bigint] NOT NULL,
	[LocationPoint] [geography] NOT NULL,
 CONSTRAINT [PK_STAGE_DIM_OrganisationsToGeoLocations] PRIMARY KEY CLUSTERED 
(
	[GeoLocationKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_Passengers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_Passengers](
	[MaxRID] [bigint] NULL,
	[HostID] [int] NULL,
	[PassengerGUID] [uniqueidentifier] NULL,
	[PassengerName] [nvarchar](255) NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_ReportingGroups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_ReportingGroups](
	[MemberID] [int] NOT NULL,
	[ReportingGroupTypeLookupKey] [int] NULL,
	[HostID] [int] NULL,
	[ReportingGroupGUID] [uniqueidentifier] NULL,
	[ReportingGroupName] [nvarchar](510) NULL,
	[MemberGUID] [uniqueidentifier] NULL,
	[ReportingGroupParentKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_Shapes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_Shapes](
	[HostID] [int] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[SiteHostID] [int] NULL,
	[SiteKey] [int] NULL,
	[ShapeType] [tinyint] NULL,
	[ShapeName] [nvarchar](100) NULL,
	[ShapeBoundaryType] [tinyint] NULL,
	[ShapeBoundary] [geography] NULL,
	[ShapeTaxTypeLookupKey] [int] NULL,
	[IsDeleted] [bit] NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_DIM_SimpleScoreCriteria]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_SimpleScoreCriteria](
	[IsActive] [bit] NULL,
	[HostID] [int] NULL,
	[EventDescriptionKey] [int] NULL,
	[TriggerID] [int] NULL,
	[ScoreDuration] [float] NULL,
	[ScoreSeverity] [float] NULL,
	[ScoreWeight] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_Sites]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_Sites](
	[HostID] [int] NULL,
	[SiteName] [nvarchar](510) NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[MemberOfSiteGUID] [uniqueidentifier] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_Trailers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_Trailers](
	[HostID] [int] NULL,
	[IsActive] [bit] NULL,
	[TrailerGUID] [uniqueidentifier] NULL,
	[TrailerAssetNumber] [nvarchar](255) NULL,
	[TrailerRegNumber] [nvarchar](15) NULL,
	[TrailerDescription] [nvarchar](255) NULL,
	[TrailerUnitID] [int] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[UnitTypeLookupKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_Units]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_Units](
	[Operation] [char](1) NOT NULL,
	[AssetHostID] [int] NOT NULL,
	[AssetTypeLookupKey] [int] NOT NULL,
	[IsActive] [bit] NOT NULL,
	[UnitSerial] [nvarchar](50) NULL,
	[AssetGUID] [uniqueidentifier] NULL,
	[UnitTypeLookupKey] [int] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[OSVersion] [nvarchar](50) NULL,
	[FirmwareVersion] [nvarchar](50) NULL,
	[FirmwareLoadedDateKey] [date] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_DIM_UTCOffsetsLookUp]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_UTCOffsetsLookUp](
	[UTCOffsetKey] [int] NOT NULL,
	[OffsetYear] [int] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[EndDateKey] [date] NOT NULL,
	[StartDateTime] [datetimeoffset](0) NOT NULL,
	[EndDateTime] [datetimeoffset](0) NOT NULL,
	[SeasonStartDateTime] [datetimeoffset](0) NOT NULL,
	[SeasonEndDateTime] [datetimeoffset](0) NOT NULL,
	[UTCOffsetMinutes] [int] NOT NULL,
	[AdjustmentType] [nvarchar](15) NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_VehicleCostCategories]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_VehicleCostCategories](
	[Operation] [char](1) NULL,
	[HostID] [int] NULL,
	[CategoryName] [nvarchar](50) NULL,
	[CategoryNotes] [nvarchar](255) NULL,
	[Type] [nvarchar](10) NULL,
	[IsRecurring] [bit] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_DIM_VehicleDeviceParameters]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_VehicleDeviceParameters](
	[VehicleHostID] [smallint] NULL,
	[DeviceHostID] [int] NULL,
	[ParameterHostID] [smallint] NULL,
	[IsDeviceDefault] [bit] NULL,
	[IsParameterDefault] [bit] NULL,
	[CalibrationType] [tinyint] NULL,
	[VehicleGUID] [uniqueidentifier] NULL,
	[DeviceKey] [int] NULL,
	[ParameterKey] [int] NULL,
	[CalibrationProperties] [xml] NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_VehicleDevices]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_VehicleDevices](
	[VehicleHostID] [smallint] NOT NULL,
	[DeviceHostID] [int] NOT NULL,
	[PowerDeviceHostID] [int] NULL,
	[RecordInterval] [bit] NULL,
	[VehicleGuid] [uniqueidentifier] NULL,
	[DeviceKey] [int] NULL,
	[InputLine] [char](2) NULL,
	[DeviceProperties] [xml] NULL,
 CONSTRAINT [PK_STAGE_VehicleDevices] PRIMARY KEY CLUSTERED 
(
	[VehicleHostID] ASC,
	[DeviceHostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_DIM_VehicleEventDefinitions]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_VehicleEventDefinitions](
	[VehicleHostID] [smallint] NOT NULL,
	[EventHostID] [smallint] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NULL,
	[EventDescriptionKey] [int] NULL,
	[EventType] [tinyint] NULL,
	[InUse] [bit] NULL,
	[RecordStartOdometer] [bit] NULL,
	[RecordStartPosition] [bit] NULL,
	[RecordEndOdometer] [bit] NULL,
	[RecordEndPosition] [bit] NULL,
	[RecordPulseCount] [bit] NULL,
	[SendActivePosition] [bit] NULL,
	[StartRecordDelay] [smallint] NULL,
	[StartAlarmDelay] [smallint] NULL,
	[StartExternalRelay1Delay] [smallint] NULL,
	[StartExternalRelay2Delay] [smallint] NULL,
	[StartCriticalDisplayDelay] [smallint] NULL,
	[ActiveSendDelay] [smallint] NULL,
	[ActiveEndSendDelay] [smallint] NULL,
	[StartActiveTrackDelay] [smallint] NULL,
	[ActiveTrackInterval] [smallint] NULL,
	[AlarmState] [tinyint] NULL,
	[ExternalRelay1State] [tinyint] NULL,
	[ExternalRelay2State] [tinyint] NULL,
	[WarningMessage] [nvarchar](255) NULL,
	[ActiveMessagePriority] [tinyint] NULL,
	[EventTriggerDefinition] [xml] NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_DIM_VehicleProfiles]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_VehicleProfiles](
	[VehicleHostID] [smallint] NOT NULL,
	[ParameterHostID] [smallint] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NULL,
	[ParameterKey] [int] NULL,
	[RangeLowerValue1] [float] SPARSE  NULL,
	[RangeOperation1] [char](1) SPARSE  NULL,
	[RangeLowerValue2] [float] SPARSE  NULL,
	[RangeOperation2] [char](1) SPARSE  NULL,
	[RangeLowerValue3] [float] SPARSE  NULL,
	[RangeOperation3] [char](1) SPARSE  NULL,
	[RangeLowerValue4] [float] SPARSE  NULL,
	[RangeOperation4] [char](1) SPARSE  NULL,
	[RangeLowerValue5] [float] SPARSE  NULL,
	[RangeOperation5] [char](1) SPARSE  NULL,
	[RangeLowerValue6] [float] SPARSE  NULL,
	[RangeOperation6] [char](1) SPARSE  NULL,
	[RangeLowerValue7] [float] SPARSE  NULL,
	[RangeOperation7] [char](1) SPARSE  NULL,
	[RangeLowerValue8] [float] SPARSE  NULL,
	[RangeOperation8] [char](1) SPARSE  NULL,
	[RangeLowerValue9] [float] SPARSE  NULL,
	[RangeOperation9] [char](1) SPARSE  NULL,
	[RangeLowerValue10] [float] SPARSE  NULL,
	[RangeOperation10] [char](1) SPARSE  NULL,
	[RangeLowerValue11] [float] SPARSE  NULL,
	[RangeOperation11] [char](1) SPARSE  NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_DIM_Vehicles]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_DIM_Vehicles](
	[VehicleGUID] [uniqueidentifier] NULL,
	[SiteID] [bigint] NULL,
	[DefaultDriverID] [int] NULL,
	[ucUnitType] [int] NULL,
	[HostID] [int] NOT NULL,
	[IsActive] [bit] NULL,
	[VehicleDescription] [nvarchar](255) NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[SiteKey] [int] NULL,
	[LastServiceDateKey] [date] NULL,
	[IsYellowEquip] [bit] NULL,
	[RegNumber] [nvarchar](15) NULL,
	[ServiceByDistance] [decimal](19, 4) NULL,
	[ServiceByDate] [tinyint] NULL,
	[ServiceByEngineSeconds] [int] NULL,
	[NextServiceDueDistance] [decimal](19, 4) NULL,
	[NextServiceDueDateKey] [date] NULL,
	[NextServiceDueEngineSeconds] [int] NULL,
	[DefaultDriverGUID] [uniqueidentifier] NULL,
	[TargetFuelConsumption] [real] NULL,
	[TargetFuelConsumptionHourly] [real] NULL,
	[ScoreTriggerOverspeeding] [float] NULL,
	[ScoreTriggerOverRevving] [float] NULL,
	[ScoreTriggerOverHarshDeceleration] [float] NULL,
	[ScoreTriggerOverHarshAccelleration] [float] NULL,
	[TermScriptConfigGroup] [smallint] NULL,
	[ConfigurationGroupNameID] [int] NULL,
	[ConfigurationGroupName] [nvarchar](255) NULL,
	[FuelTypeLookupKey] [int] NULL,
	[EstimateCO2EmissionGramsperKm] [float] NULL,
	[UnitTypeLookupKey] [int] NULL,
	[BatteryVoltage] [numeric](19, 6) NULL,
	[CurrentDeviceDriverVersion] [nvarchar](25) NULL,
	[LastDeviceDriverUploadDateTime] [datetimeoffset](0) NULL,
	[LastConfigurationUploadDateTime] [datetimeoffset](0) NULL,
	[LastDeviceChangeDateTime] [datetimeoffset](0) NULL,
	[LastEventChangeDateTime] [datetimeoffset](0) NULL,
	[CreateDateKey] [date] NULL,
	[IsMeasuringFuel] [bit] NULL,
	[IsCofiguredForMeasuringFuel] [bit] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_FACT_ActivityChanges]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_ActivityChanges](
	[TripID] [bigint] NULL,
	[IsInTripSource] [bit] NULL,
	[IsInSubTripSource] [bit] NULL,
	[IsInTaxClassification] [bit] NULL,
	[IsMoreThanScoreChangeOnly] [bit] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_FACT_ActivityDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_ActivityDetails](
	[Operation] [char](1) NULL,
	[TripID] [bigint] NULL,
	[StartGPSID] [bigint] NULL,
	[EndGPSID] [bigint] NULL,
	[VehicleID] [int] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[PulseParameterID] [smallint] NULL,
	[ActivitySummaryKey] [bigint] NULL,
	[HostID] [int] NULL,
	[VehicleSiteKey] [int] NULL,
	[ActivityStartDateKey] [date] NULL,
	[ActivityEndDateKey] [date] NULL,
	[ActivityStartTime] [time](0) NULL,
	[ActivityEndTime] [time](0) NULL,
	[ActivityStartDateTime] [datetimeoffset](0) NULL,
	[ActivityEndDateTime] [datetimeoffset](0) NULL,
	[MovementStartDateKey] [date] NULL,
	[MovementEndDateKey] [date] NULL,
	[MovementStartTime] [time](0) NULL,
	[MovementEndTime] [time](0) NULL,
	[MovementStartDateTime] [datetimeoffset](0) NULL,
	[MovementEndDateTime] [datetimeoffset](0) NULL,
	[NextMovementActivityDetailKey] [bigint] NULL,
	[NextMovementStartDateTime] [datetimeoffset](0) NULL,
	[IsLastMovement] [bit] NULL,
	[StartOdometer] [decimal](19, 4) NULL,
	[EndOdometer] [decimal](19, 4) NULL,
	[StartEngineSeconds] [int] NULL,
	[EndEngineSeconds] [int] NULL,
	[StartGeoLocationKey] [bigint] NULL,
	[EndGeoLocationKey] [bigint] NULL,
	[DistanceTravelled] [decimal](19, 4) NULL,
	[Duration] [int] NULL,
	[DrivingTime] [int] NULL,
	[StandingTime] [int] NULL,
	[DriverKey] [bigint] NULL,
	[VehicleKey] [bigint] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[SpeedTime] [int] NULL,
	[SpeedOccurs] [int] NULL,
	[SpeedScore] [decimal](9, 5) NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[BrakeTime] [int] NULL,
	[BrakeOccurs] [int] NULL,
	[BrakeScore] [decimal](9, 5) NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[AccelTime] [int] NULL,
	[AccelOccurs] [int] NULL,
	[AccelScore] [decimal](9, 5) NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[RPMTIme] [int] NULL,
	[RPMOccurs] [int] NULL,
	[RPMScore] [decimal](9, 5) NULL,
	[OutOfGreenBandTime] [int] NULL,
	[OutOfGreenBandScore] [decimal](9, 5) NULL,
	[ExcessiveIdleTime] [int] NULL,
	[ExcessiveIdleOccurs] [int] NULL,
	[ExcessiveIdleScore] [decimal](9, 5) NULL,
	[IdleTime] [int] NULL,
	[IdleOccurs] [int] NULL,
	[EngineSeconds] [int] NULL,
	[NoGoZoneEntry] [bit] NULL,
	[Passengers] [smallint] NULL,
	[FuelUsedMeasured] [decimal](9, 4) NULL,
	[FuelUsedCalculated] [decimal](9, 4) NULL,
	[FuelUsedHierarchy] [smallint] NULL,
	[NightDuration] [int] NULL,
	[AfterHoursDuration] [int] NULL,
	[TotalCarbonEmission] [float] NULL,
	[TotalCO2Emission] [float] NULL,
	[PulseParameterKey] [int] NULL,
	[PulseValue] [float] NULL,
	[UTCOffsetKey] [int] NULL,
	[RoadSpeedTime] [int] NULL,
	[RoadSpeedOccurs] [int] NULL,
	[RoadSpeedScore] [decimal](9, 5) NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_FACT_ActivitySummary]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_ActivitySummary](
	[Operation] [char](1) NULL,
	[MaxDetailID] [bigint] NULL,
	[VehicleID] [int] NULL,
	[DriverID] [int] NULL,
	[OriginalDriverID] [int] NULL,
	[NextTripStartDateTime] [datetimeoffset](0) NULL,
	[HostID] [bigint] NULL,
	[UnitTripNumber] [bigint] NULL,
	[ActivityStartDateKey] [date] NULL,
	[ActivityEndDateKey] [date] NULL,
	[ActivityStartTime] [time](7) NULL,
	[ActivityEndTime] [time](7) NULL,
	[ActivityStartDateTime] [datetimeoffset](0) NULL,
	[ActivityEndDateTime] [datetimeoffset](0) NULL,
	[VehicleKey] [int] NULL,
	[DriverKey] [int] NULL,
	[OriginalDriverKey] [int] NULL,
	[OriginalDriverSiteKey] [int] NULL,
	[OriginalVehicleSiteKey] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[TotalFuelUsedMeasured] [decimal](19, 4) NULL,
	[TotalFuelUsedCalculated] [decimal](19, 4) NULL,
	[StartOdometer] [decimal](19, 4) NULL,
	[EndOdometer] [decimal](19, 4) NULL,
	[StartEngineSeconds] [int] NULL,
	[EndEngineSeconds] [int] NULL,
	[StartGeoLocationKey] [bigint] NULL,
	[EndGeoLocationKey] [bigint] NULL,
	[AverageSimpleDriverScore] [decimal](9, 6) NULL,
	[TotalDuration] [int] NULL,
	[TotalDistanceTravelled] [decimal](19, 4) NULL,
	[TotalDrivingTime] [int] NULL,
	[TotalEngineSeconds] [int] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[TotalIdleTime] [int] NULL,
	[TotalPassengers] [smallint] NULL,
	[TotalStandingTime] [int] NULL,
	[TotalNightDuration] [int] NULL,
	[TotalAfterHoursDuration] [int] NULL,
	[TotalCarbonEmission] [float] NULL,
	[TotalCO2Emission] [float] NULL,
	[TripClassificationLookupKey] [int] NULL,
	[TripClassificationHierarchy] [smallint] NULL,
	[IsDutchTaxTripClassification] [bit] NULL,
	[MovementCount] [int] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_FACT_ActivitySummary_NonTrackedChanges]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_ActivitySummary_NonTrackedChanges](
	[TripID] [bigint] NOT NULL,
 CONSTRAINT [PK_STAGE_FACT_ActivitySummary_NonTrackedChanges] PRIMARY KEY CLUSTERED 
(
	[TripID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_FACT_EventDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_EventDetails](
	[Operation] [char](1) NOT NULL,
	[DriverID] [int] NULL,
	[VehicleID] [int] NULL,
	[TrailerUnitID] [int] NULL,
	[EventID] [int] NULL,
	[StartGPSID] [bigint] NULL,
	[EndGPSID] [bigint] NULL,
	[PulseParameterID] [smallint] NULL,
	[HostID] [bigint] NOT NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[TrailerKey] [int] NULL,
	[EventDescriptionKey] [int] NULL,
	[EventTypeLookupKey] [int] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[EventStartDateKey] [date] NULL,
	[EventEndDateKey] [date] NULL,
	[EventStartTime] [time](0) NULL,
	[EventEndTime] [time](0) NULL,
	[EventStartDateTime] [datetimeoffset](0) NULL,
	[EventEndDateTime] [datetimeoffset](0) NULL,
	[StartOdometer] [decimal](19, 4) NULL,
	[EndOdometer] [decimal](19, 4) NULL,
	[EventValue] [float] NULL,
	[StartGeoLocationKey] [bigint] NULL,
	[EndGeoLocationKey] [bigint] NULL,
	[TotalOccurs] [int] NULL,
	[TotalTime] [int] NULL,
	[ParameterKey] [int] NULL,
	[Litres] [decimal](9, 4) NULL,
	[PulseParameterKey] [int] NULL,
	[PulseValue] [float] NULL,
	[UTCOffsetKey] [int] NULL,
	[VideoKey] [bigint] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_FACT_EventDetails_NonTrackedChanges]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_EventDetails_NonTrackedChanges](
	[EventKey] [bigint] NOT NULL,
 CONSTRAINT [PK_STAGE_FACT_EventDetails_NonTrackedChanges] PRIMARY KEY CLUSTERED 
(
	[EventKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_FACT_EventRoadspeedLimits]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_EventRoadspeedLimits](
	[EventKey] [bigint] NOT NULL,
	[SpeedLimit] [decimal](9, 5) NULL,
	[Operation] [char](1) NOT NULL,
 CONSTRAINT [PK_STAGE_FACT_EventRoadspeedLimits] PRIMARY KEY CLUSTERED 
(
	[EventKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_FACT_EventRoadspeedLimitsScores]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_EventRoadspeedLimitsScores](
	[TripID] [bigint] NOT NULL,
	[HostID] [int] NOT NULL,
	[RoadSpeedOccurs] [int] NULL,
	[RoadSpeedTime] [int] NULL,
	[SeverityScore] [decimal](9, 5) NULL,
	[DurationScore] [decimal](9, 5) NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_FACT_EventSummary]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_EventSummary](
	[VehicleSiteKey] [int] NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[TrailerKey] [int] NULL,
	[EventDescriptionKey] [int] NULL,
	[EventStartDateKey] [date] NULL,
	[NumberOfEvents] [int] NULL,
	[MaxEventValue] [float] NULL,
	[MinEventValue] [float] NULL,
	[AvgEventValue] [float] NULL,
	[TotalEventValue] [float] NULL,
	[TotalOccurs] [int] NULL,
	[TotalTime] [int] NULL,
	[TotalLitres] [decimal](19, 4) NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_FACT_FuelCapture]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_FuelCapture](
	[Operation] [char](1) NOT NULL,
	[VehicleID] [int] NULL,
	[BaseCurrency] [nchar](6) NULL,
	[HostID] [bigint] NOT NULL,
	[VehicleKey] [int] NULL,
	[FillDateKey] [date] NULL,
	[FillTime] [time](0) NULL,
	[FillDateTime] [datetimeoffset](0) NULL,
	[PreviousFillDateTime] [datetimeoffset](0) NULL,
	[Litres] [real] NULL,
	[BaseCost] [money] NULL,
	[BaseCurrencyKey] [int] NULL,
	[FillOdometer] [decimal](19, 5) NULL,
	[PreviousFillOdometer] [decimal](19, 5) NULL,
	[EngineSeconds] [int] NULL,
	[PreviousEngineSeconds] [int] NULL,
	[DistanceTravelled] [decimal](19, 5) NULL,
	[FillFuelConsumption] [real] NULL,
	[ActivityDetailKey] [int] NULL,
	[FuelStopGeoLocationKey] [int] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_FACT_PassengerActivities]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_PassengerActivities](
	[Operation] [char](1) NOT NULL,
	[PassengerID] [int] NOT NULL,
	[VehicleID] [int] NOT NULL,
	[HostID] [int] NOT NULL,
	[Odometer] [float] NULL,
	[RankNo] [int] NULL,
	[PassengerKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[ActivitySummaryKey] [bigint] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[IdentifiedDateKey] [date] NULL,
	[IdentifiedTime] [time](0) NULL,
	[IdentifiedDateTime] [datetimeoffset](0) NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_FACT_ProfileDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_ProfileDetails](
	[HostTripID] [int] NULL,
	[HostSequenceID] [smallint] NULL,
	[HostParameterID] [smallint] NULL,
	[VehicleKey] [int] NULL,
	[ParameterKey] [int] NULL,
	[VehicleProfileKey] [int] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[StartDateKey] [date] NULL,
	[StartTime] [time](0) NULL,
	[StartDateTime] [datetimeoffset](0) NULL,
	[EndDateKey] [date] NULL,
	[EndTime] [time](0) NULL,
	[EndDateTime] [datetimeoffset](0) NULL,
	[RangeDuration0] [int] SPARSE  NULL,
	[RangeDuration1] [int] SPARSE  NULL,
	[RangeDuration2] [int] SPARSE  NULL,
	[RangeDuration3] [int] SPARSE  NULL,
	[RangeDuration4] [int] SPARSE  NULL,
	[RangeDuration5] [int] SPARSE  NULL,
	[RangeDuration6] [int] SPARSE  NULL,
	[RangeDuration7] [int] SPARSE  NULL,
	[RangeDuration8] [int] SPARSE  NULL,
	[RangeDuration9] [int] SPARSE  NULL,
	[RangeDuration10] [int] SPARSE  NULL,
	[RangeDuration11] [int] SPARSE  NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_FACT_ServiceHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_ServiceHistory](
	[Operation] [char](1) NOT NULL,
	[VehicleID] [int] NULL,
	[BaseCurrency] [nchar](6) NULL,
	[HostID] [int] NULL,
	[VehicleKey] [int] NULL,
	[ServiceDateKey] [date] NULL,
	[ServiceDateTime] [datetimeoffset](0) NULL,
	[Odometer] [real] NULL,
	[EngineSeconds] [int] NULL,
	[Reference] [nvarchar](50) NULL,
	[BaseCost] [money] NULL,
	[BaseCurrencyKey] [int] NULL,
	[Notes] [nvarchar](max) NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_FACT_ShapeVisits]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_ShapeVisits](
	[VisitDateKey] [date] NULL,
	[ShapeKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[DriverKey] [int] NULL,
	[DurationAtLocation] [int] NULL,
	[NumberOfVisits] [int] NULL,
	[NumberOfUniqueVisits] [int] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_FACT_SimpleScoreDaily]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_SimpleScoreDaily](
	[SnapShotDateKey] [date] NOT NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[DistanceTravelled] [decimal](19, 4) NULL,
	[DrivingTime] [int] NULL,
	[Duration] [int] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[SpeedTime] [int] NULL,
	[SpeedOccurs] [int] NULL,
	[SpeedScoreByDuration] [decimal](19, 5) NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[BrakeTime] [int] NULL,
	[BrakeOccurs] [int] NULL,
	[BrakeScoreByDuration] [decimal](19, 5) NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[AccelTime] [int] NULL,
	[AccelOccurs] [int] NULL,
	[AccelScoreByDuration] [decimal](19, 5) NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[RPMTime] [int] NULL,
	[RPMOccurs] [int] NULL,
	[RPMScoreByDuration] [decimal](19, 5) NULL,
	[OutOfGreenBandTime] [int] NULL,
	[OutOfGreenBandScoreByDuration] [decimal](19, 5) NULL,
	[ExcessiveIdleOccurs] [int] NULL,
	[ExcessiveIdleTime] [int] NULL,
	[ExcessiveIdleScoreByDuration] [decimal](19, 5) NULL,
	[RoadSpeedTime] [int] NULL,
	[RoadSpeedOccurs] [int] NULL,
	[RoadSpeedScoreByDuration] [decimal](19, 5) NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_FACT_SimpleScoreDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_SimpleScoreDetails](
	[Operation] [char](1) NULL,
	[TripID] [int] NULL,
	[ActivitySummaryKey] [bigint] NULL,
	[HostID] [int] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[VehicleKey] [int] NULL,
	[DriverKey] [int] NULL,
	[ActivityStartDateKey] [date] NULL,
	[SpeedScoreCiteriaKey] [int] NULL,
	[BrakeScoreCiteriaKey] [int] NULL,
	[AccelScoreCiteriaKey] [int] NULL,
	[RPMScoreCiteriaKey] [int] NULL,
	[OutOfGreenbandScoreCiteriaKey] [int] NULL,
	[ExcessiveIdleScoreCiteriaKey] [int] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_FACT_SiteSnapshotDaily]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_SiteSnapshotDaily](
	[SnapShotDateKey] [date] NOT NULL,
	[VehicleSiteKey] [int] NULL,
	[VehiclesWithTrips] [smallint] NULL,
	[DriversWithTrips] [smallint] NULL,
	[NumberOfTrips] [int] NULL,
	[NumberOfCollisions] [int] NULL,
	[NumberOfKMs] [decimal](19, 4) NULL,
	[NumberOfHours] [int] NULL,
	[FuelUsedMeasured] [decimal](9, 4) NULL,
	[FuelUsedCalculated] [decimal](9, 4) NULL,
	[TotalIdlingTime] [int] NULL,
	[NumberOfActiveVehicles] [int] NULL,
	[NumberOfActiveDrivers] [int] NULL,
	[VehicleUtilization] [int] NULL,
	[DriverUtilization] [int] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_FACT_TachoData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_TachoData](
	[Operation] [char](1) NOT NULL,
	[VehicleID] [int] NOT NULL,
	[HostID] [bigint] NULL,
	[BlockSequence] [int] NOT NULL,
	[VehicleKey] [int] NULL,
	[TachoStartDateKey] [date] NULL,
	[TachoEndDateKey] [date] NULL,
	[TachoStartDateTime] [datetimeoffset](0) NULL,
	[TachoEndDateTime] [datetimeoffset](0) NULL,
	[RawData] [binary](1024) NULL,
	[MaxSpeed] [int] NULL,
	[MinSpeed] [int] NULL,
	[AvgSpeed] [int] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_FACT_TachoData_NonTrackedChanges]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_TachoData_NonTrackedChanges](
	[RID] [bigint] NOT NULL,
 CONSTRAINT [PK_STAGE_FACT_TachoData_NonTrackedChanges] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_FACT_TerminalDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_TerminalDetails](
	[Operation] [char](1) NOT NULL,
	[VehicleID] [int] NULL,
	[HostID] [bigint] NOT NULL,
	[VehicleKey] [int] NULL,
	[DriverKey] [int] NULL,
	[TerminalDateKey] [date] NULL,
	[TerminalTime] [time](0) NULL,
	[TerminalDateTime] [datetimeoffset](0) NULL,
	[Odometer] [decimal](19, 4) NULL,
	[MenuID] [char](5) NULL,
	[MenuItemCode] [char](5) NULL,
	[ValueType] [tinyint] NULL,
	[NumberValue] [float] NULL,
	[StringValue] [nvarchar](255) NULL,
	[ActivityDetailKey] [bigint] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_FACT_TerminalDetails_NonTrackedChanges]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_TerminalDetails_NonTrackedChanges](
	[EventKey] [bigint] NOT NULL,
 CONSTRAINT [PK_STAGE_FACT_TerminalDetails_NonTrackedChanges] PRIMARY KEY CLUSTERED 
(
	[EventKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[STAGE_FACT_VehicleCosts]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_FACT_VehicleCosts](
	[Operation] [char](1) NULL,
	[VehicleID] [int] NULL,
	[CategoryID] [int] NULL,
	[BaseCurrency] [nvarchar](5) NULL,
	[HostID] [nvarchar](50) NULL,
	[CostDateKey] [date] NULL,
	[IsRecurring] [int] NULL,
	[VehicleKey] [int] NULL,
	[OdometerReading] [decimal](19, 4) NULL,
	[CostCategoryKey] [int] NULL,
	[BaseCost] [money] NULL,
	[BaseCurrencyKey] [int] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_VehicleDeviceProperties]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_VehicleDeviceProperties](
	[VehicleHostID] [smallint] NOT NULL,
	[DeviceHostID] [int] NOT NULL,
	[PropertyName] [nvarchar](50) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[PropertyValue] [nvarchar](2000) NULL,
 CONSTRAINT [PK_STAGE_VehicleDeviceProperties] PRIMARY KEY CLUSTERED 
(
	[VehicleHostID] ASC,
	[DeviceHostID] ASC,
	[PropertyName] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[STAGE_VehicleTriggers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[STAGE_VehicleTriggers](
	[VehicleHostID] [int] NOT NULL,
	[EventHostID] [smallint] NOT NULL,
	[TriggerID] [tinyint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[Sequence] [tinyint] NULL,
	[ParameterKey] [int] NULL,
	[Operator] [tinyint] NULL,
	[ThresholdValue] [float] NULL,
	[Required] [bit] NULL,
	[JoinOperator] [tinyint] NULL,
 CONSTRAINT [PK_STAGE_VehicleTriggers] PRIMARY KEY CLUSTERED 
(
	[VehicleHostID] ASC,
	[EventHostID] ASC,
	[TriggerID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[SubTripData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[SubTripData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[TripID] [int] NOT NULL,
	[Sequence] [smallint] NOT NULL,
	[Depart] [datetime] NULL,
	[Halt] [datetime] NULL,
	[StandingTime] [int] NULL,
	[TripDistance] [decimal](19, 5) NULL,
	[Odometer] [decimal](19, 5) NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[SpeedTime] [int] NULL,
	[SpeedOccurs] [int] NULL,
	[SpeedScore] [decimal](9, 6) NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[BrakeTime] [int] NULL,
	[BrakeOccurs] [int] NULL,
	[BrakeScore] [decimal](9, 6) NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[AccelTime] [int] NULL,
	[AccelOccurs] [int] NULL,
	[AccelScore] [decimal](9, 6) NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[RPMTime] [int] NULL,
	[RPMOccurs] [int] NULL,
	[RPMScore] [decimal](9, 6) NULL,
	[GBTime] [int] NULL,
	[GBScore] [decimal](9, 6) NULL,
	[ExIdleTime] [int] NULL,
	[ExIdleOccurs] [int] NULL,
	[ExIdleScore] [decimal](9, 6) NULL,
	[NIdleTime] [int] NULL,
	[NIdleOccurs] [int] NULL,
	[Litres] [decimal](9, 4) NULL,
	[PulseParameterID] [smallint] NULL,
	[PulseValue] [float] NULL,
	[StartGPSID] [int] NULL,
	[EndGPSID] [int] NULL,
	[StartEngineSeconds] [int] NULL,
	[EndEngineSeconds] [int] NULL,
	[RoadSpeedTime] [int] NULL,
	[RoadSpeedOccurs] [int] NULL,
	[RoadSpeedScore] [decimal](9, 5) NULL,
 CONSTRAINT [PK_SubTripData] PRIMARY KEY CLUSTERED 
(
	[TripID] ASC,
	[Sequence] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[TachoData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[TachoData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[RID] [int] NULL,
	[VehicleID] [smallint] NOT NULL,
	[BlockSequence] [int] NOT NULL,
	[StartDate] [datetime] NULL,
	[EndDate] [datetime] NULL,
	[RawData] [binary](1024) NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[TaxTripClassification]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[TaxTripClassification](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liRID] [int] NULL,
	[liTripID] [int] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liSiteID] [int] NOT NULL,
	[liStartLocationID] [int] NULL,
	[liEndLocationID] [int] NULL,
	[fStartLocationLong] [real] NULL,
	[fStartLocationLat] [real] NULL,
	[fEndLocationLong] [real] NULL,
	[fEndLocationLat] [real] NULL,
	[liTripContactID] [int] NULL,
	[sTripClassification] [nvarchar](200) NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[TerminalData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[TerminalData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[EventKey] [int] NOT NULL,
	[VehicleID] [smallint] NULL,
	[BlockSequence] [int] NULL,
	[DriverID] [smallint] NULL,
	[OriginalDriverID] [smallint] NULL,
	[EventDate] [datetime] NULL,
	[Odometer] [decimal](19, 5) NULL,
	[MenuID] [nvarchar](5) NULL,
	[MenuItemCode] [nvarchar](5) NULL,
	[ValueType] [tinyint] NULL,
	[NumberValue] [float] NULL,
	[StringValue] [nvarchar](240) NULL,
 CONSTRAINT [PK_tbTerminalData] PRIMARY KEY CLUSTERED 
(
	[EventKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[Trailers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[Trailers](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[TrailerGUID] [uniqueidentifier] NOT NULL,
	[liTrailerID] [int] NOT NULL,
	[sDescription] [nvarchar](255) NOT NULL,
	[sRegNo] [nvarchar](15) NOT NULL,
	[sAssetNumber] [nvarchar](255) NULL,
	[fSetOdometer] [real] NULL,
	[dtOdometerChanged] [datetime] NULL,
	[dtPrevService] [datetime] NULL,
	[dtNextService] [datetime] NULL,
	[iServIntTime] [smallint] NULL,
	[fPrevService] [real] NULL,
	[fNextService] [real] NULL,
	[fServIntDistance] [real] NULL,
 CONSTRAINT [PK_Trailers] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[liTrailerID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[TrailerUnitIDs]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[TrailerUnitIDs](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[liUnitID] [int] NOT NULL,
	[liTrailerID] [int] NOT NULL,
	[dtAttached] [datetime] NOT NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[TripData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[TripData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[TripID] [int] NOT NULL,
	[VehicleID] [smallint] NULL,
	[TripNumber] [int] NULL,
	[DriverID] [smallint] NULL,
	[OriginalDriverID] [smallint] NULL,
	[TripStart] [datetime] NULL,
	[TripEnd] [datetime] NULL,
 CONSTRAINT [PK_TripData] PRIMARY KEY CLUSTERED 
(
	[TripID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[UnitTypes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[UnitTypes](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[ucUnitType] [tinyint] NOT NULL,
	[ucSelectionSort] [tinyint] NULL,
	[sDescription] [nvarchar](50) NULL,
	[bIsConfigUnit] [bit] NULL,
 CONSTRAINT [PK_UnitTypes] PRIMARY KEY CLUSTERED 
(
	[ucUnitType] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[VehicleConfig]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[VehicleConfig](
	[liGroupID] [int] NOT NULL,
	[sName] [nvarchar](255) NOT NULL,
	[sNote] [nvarchar](max) NULL,
	[GroupGUID] [uniqueidentifier] NOT NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[VehicleDeviceParam]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[VehicleDeviceParam](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[lfCalibration1] [float] NULL,
	[lfValue1] [float] NULL,
	[lfCalibration2] [float] NULL,
	[lfValue2] [float] NULL,
	[sUserName] [nvarchar](100) NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[VehicleDeviceProperties]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[VehicleDeviceProperties](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[sProperty] [nvarchar](50) NOT NULL,
	[sValue] [nvarchar](2000) NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleDeviceProperties] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iVehicleID] ASC,
	[liDeviceID] ASC,
	[sProperty] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[VehicleDevices]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[VehicleDevices](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[sInputID] [char](2) NULL,
	[bIsActive] [bit] NULL,
	[bRecordInterval] [bit] NULL,
	[liPowerDeviceID] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleDevices] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iVehicleID] ASC,
	[liDeviceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[VehicleEvent]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[VehicleEvent](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucEventType] [tinyint] NOT NULL,
	[bInUse] [bit] NOT NULL,
	[bStartOdo] [bit] NOT NULL,
	[bStartPosition] [bit] NOT NULL,
	[bEndOdo] [bit] NOT NULL,
	[bEndPosition] [bit] NOT NULL,
	[bRecordF3Count] [bit] NOT NULL,
	[bWarningMessage] [bit] NOT NULL,
	[bActivePosition] [bit] NOT NULL,
	[iRecordTime] [smallint] NOT NULL,
	[iAlarmTime] [smallint] NOT NULL,
	[iRelayTime] [smallint] NOT NULL,
	[iRelay2Time] [smallint] NOT NULL,
	[iCriticalTime] [smallint] NULL,
	[iActiveTime] [smallint] NOT NULL,
	[iActiveEndTime] [smallint] NOT NULL,
	[iTrackTime] [smallint] NOT NULL,
	[iTrackInterval] [smallint] NOT NULL,
	[ucAlarmState] [tinyint] NOT NULL,
	[ucRelayState] [tinyint] NOT NULL,
	[ucRelay2State] [tinyint] NOT NULL,
	[sWarningMessage] [nvarchar](255) NULL,
	[ucPriority] [tinyint] NOT NULL,
	[dtLastEventNotification] [datetime] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleEvent] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iVehicleID] ASC,
	[iEventID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[VehicleProfile]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[VehicleProfile](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[ucSeq] [smallint] NOT NULL,
	[lfValue] [float] NULL,
	[sUserName] [nvarchar](100) NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[VehicleReporting]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser].[VehicleReporting](
	[liGroupID] [int] NOT NULL,
	[GroupGUID] [uniqueidentifier] NOT NULL,
	[sName] [nvarchar](510) NOT NULL,
	[sNote] [nvarchar](max) NULL
) ON [StageUserFG] TEXTIMAGE_ON [StageUserFG]

GO
/****** Object:  Table [StageUser].[VehicleReportingGroups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[VehicleReportingGroups](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liGroupID] [int] NOT NULL,
	[iVehicleID] [int] NOT NULL
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[Vehicles]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[Vehicles](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [bigint] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liSiteID] [int] NULL,
	[liGroupID] [int] NULL,
	[sDesc] [nvarchar](255) NULL,
	[sRegNo] [nvarchar](15) NULL,
	[ucUnitType] [tinyint] NULL,
	[liLastServiceKey] [int] NULL,
	[fNextServiceKm] [real] NULL,
	[fServiceKm] [real] NULL,
	[fRemindKm] [real] NULL,
	[dtNextServiceDate] [datetime] NULL,
	[ucServiceMonths] [tinyint] NULL,
	[ucRemindWeeks] [tinyint] NULL,
	[liNextServiceSeconds] [int] NULL,
	[liServiceSeconds] [int] NULL,
	[liRemindSeconds] [int] NULL,
	[dtLastLicense] [datetime] NULL,
	[dtNextLicense] [datetime] NULL,
	[ucLicenseInterval] [tinyint] NULL,
	[ucLicenseRemind] [tinyint] NULL,
	[dtLastCOR] [datetime] NULL,
	[dtNextCOR] [datetime] NULL,
	[ucCORInterval] [tinyint] NULL,
	[ucCORRemind] [tinyint] NULL,
	[bServiceKm] [bit] NULL,
	[bServiceDate] [bit] NULL,
	[bServiceHours] [bit] NULL,
	[bLicense] [bit] NULL,
	[bCOR] [bit] NULL,
	[bActive] [bit] NULL,
	[sActiveReason] [nvarchar](500) NULL,
	[ucActiveState] [tinyint] NULL,
	[iDefaultDriver] [smallint] NULL,
	[fTargetConsumption] [real] NULL,
	[fTargetHourlyConsumption] [real] NULL,
 CONSTRAINT [PK_Vehicles] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iVehicleID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser].[VehicleTriggers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser].[VehicleTriggers](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucTriggerID] [tinyint] NOT NULL,
	[lfValue] [float] NOT NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleTriggers] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iVehicleID] ASC,
	[iEventID] ASC,
	[ucTriggerID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
) ON [StageUserFG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[Certifications]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[Certifications](
	[liCertificationID] [int] NOT NULL,
	[sDescription] [nvarchar](100) NULL,
	[iValidMonths] [smallint] NULL,
	[bMandatory] [bit] NULL,
 CONSTRAINT [PK_Certifications] PRIMARY KEY CLUSTERED 
(
	[liCertificationID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[DeviceParam]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[DeviceParam](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[bDeviceDefault] [bit] NOT NULL,
	[bParamDefault] [bit] NOT NULL,
	[ucCalibrationType] [tinyint] NOT NULL,
	[lfCalibration1] [float] NULL,
	[lfValue1] [float] NULL,
	[lfCalibration2] [float] NULL,
	[lfValue2] [float] NULL,
	[sUserName] [nvarchar](100) NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[DeviceParam_VehicleDeviceParam]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[DeviceParam_VehicleDeviceParam](
	[VehicleID] [smallint] NOT NULL,
	[DeviceID] [int] NOT NULL,
	[ParameterID] [smallint] NOT NULL,
	[IsDeviceDefault] [bit] NOT NULL,
	[IsParameterDefault] [bit] NOT NULL,
	[CalibrationType] [tinyint] NOT NULL,
	[Calibration1] [float] NULL,
	[Value1] [float] NULL,
	[Calibration2] [float] NULL,
	[Value2] [float] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[Devices]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[Devices](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[sDescription] [nvarchar](200) NOT NULL,
	[sSystemName] [nvarchar](255) NULL,
	[ucDeviceType] [tinyint] NOT NULL,
	[bCanRecordInterval] [bit] NOT NULL,
	[sReportProgID] [nvarchar](200) NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_Devices] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[liDeviceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[DeviceTypes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[DeviceTypes](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[ucDeviceType] [tinyint] NOT NULL,
	[sDescription] [nvarchar](50) NULL,
	[ucValueFormat] [tinyint] NULL,
	[bCanRecordInterval] [bit] NULL,
	[bIsActive] [bit] NULL,
	[ucCalibrationType] [tinyint] NULL,
	[lfCalibration1] [float] NULL,
	[lfValue1] [float] NULL,
	[lfCalibration2] [float] NULL,
	[lfValue2] [float] NULL,
	[ucResolution] [tinyint] NULL,
	[sPropertyProgID] [nvarchar](200) NULL,
	[sReportProgID] [nvarchar](200) NULL,
	[sConfigProgID] [nvarchar](200) NULL,
 CONSTRAINT [PK_DeviceTypes] PRIMARY KEY CLUSTERED 
(
	[ucDeviceType] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[DriverCertifications]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[DriverCertifications](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iDriverID] [smallint] NOT NULL,
	[liCertificationID] [int] NOT NULL,
	[dtObtained] [datetime] NOT NULL,
	[sInstructor] [nvarchar](50) NOT NULL,
	[bInstructorQualified] [bit] NOT NULL,
	[sLocation] [nvarchar](100) NOT NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[DriverConfig]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[DriverConfig](
	[liGroupID] [int] NOT NULL,
	[sName] [nvarchar](255) NOT NULL,
	[sNote] [nvarchar](2048) NULL,
	[GroupGUID] [uniqueidentifier] NOT NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[DriverLicenceCodes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[DriverLicenceCodes](
	[liLicenceID] [int] NOT NULL,
	[liCountryID] [int] NULL,
	[sLicenceCode] [nvarchar](20) NULL,
	[sDescription] [nvarchar](250) NULL,
	[iExpiryMonths] [smallint] NULL,
	[iRemindWeeks] [smallint] NULL,
 CONSTRAINT [PK_DriverLicenceCodes] PRIMARY KEY CLUSTERED 
(
	[liLicenceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[DriverLicences]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[DriverLicences](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[iDriverID] [smallint] NOT NULL,
	[liLicenceID] [int] NOT NULL,
	[dtObtained] [datetime] NOT NULL,
	[dtExpires] [datetime] NULL,
 CONSTRAINT [PK_DriverLicences] PRIMARY KEY NONCLUSTERED 
(
	[RID] ASC,
	[iDriverID] ASC,
	[liLicenceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[DriverReporting]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[DriverReporting](
	[liGroupID] [int] NOT NULL,
	[GroupGUID] [uniqueidentifier] NOT NULL,
	[sName] [nvarchar](510) NULL,
	[sNote] [nvarchar](max) NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[DriverReportingGroups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[DriverReportingGroups](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liGroupID] [int] NOT NULL,
	[iDriverID] [int] NOT NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[Drivers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[Drivers](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetime] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[DriverGUID] [uniqueidentifier] NOT NULL,
	[iDriverID] [smallint] NOT NULL,
	[liSiteID] [int] NOT NULL,
	[liGroupID] [int] NOT NULL,
	[sEmployeeNumber] [nvarchar](255) NULL,
	[sName] [nvarchar](255) NOT NULL,
	[bLicense] [bit] NOT NULL,
	[dtLastLicense] [datetime] NULL,
	[dtNextLicense] [datetime] NULL,
	[ucLicenseInterval] [tinyint] NULL,
	[dtDistanceChecked] [datetime] NULL,
	[sExtendedID] [varchar](32) NULL,
	[ucLicenseRemind] [tinyint] NULL,
 CONSTRAINT [PK_Drivers] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iDriverID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[EventData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[EventData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[EventKey] [int] NOT NULL,
	[VehicleID] [smallint] NULL,
	[DriverID] [smallint] NULL,
	[OriginalDriverID] [smallint] NULL,
	[EventID] [smallint] NULL,
	[EventType] [tinyint] NULL,
	[StartSequence] [int] NULL,
	[StartDate] [datetime] NULL,
	[StartOdometer] [decimal](19, 5) NULL,
	[StartGPSID] [int] NULL,
	[EndSequence] [int] NULL,
	[EndDate] [datetime] NULL,
	[EndOdometer] [decimal](19, 5) NULL,
	[EndGPSID] [int] NULL,
	[TotalTime] [int] NULL,
	[TotalOccurs] [int] NULL,
	[Value] [float] NULL,
	[Litres] [decimal](9, 4) NULL,
	[PulseParameterID] [smallint] NULL,
	[PulseValue] [float] NULL,
	[VideoKey] [bigint] NULL,
 CONSTRAINT [PK_EventData] PRIMARY KEY CLUSTERED 
(
	[EventKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[EventDescription]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[EventDescription](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[sDescription] [nvarchar](50) NOT NULL,
	[sSystemName] [nvarchar](255) NULL,
	[sCriticalID] [nchar](5) NULL,
	[ucSummaryType] [tinyint] NULL,
	[iSummaryID] [smallint] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_EventDescription] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iEventID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[EventTriggers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[EventTriggers](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucTriggerID] [tinyint] NOT NULL,
	[ucSeq] [tinyint] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[ucOperator] [tinyint] NOT NULL,
	[lfValue] [float] NOT NULL,
	[bRequired] [bit] NOT NULL,
	[ucTOper] [tinyint] NULL,
	[sUserName] [nvarchar](100) NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[ExtensionProperties_DIM]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[ExtensionProperties_DIM](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[sAppID] [nvarchar](20) NOT NULL,
	[liObjectType] [int] NOT NULL,
	[liObjectID] [int] NOT NULL,
	[sProperty] [nvarchar](50) NOT NULL,
	[sValue] [nvarchar](max) NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[ExtensionProperties_FACT]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[ExtensionProperties_FACT](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[sAppID] [nvarchar](20) NOT NULL,
	[liObjectType] [int] NOT NULL,
	[liObjectID] [int] NOT NULL,
	[sProperty] [nvarchar](50) NOT NULL,
	[sValue] [nvarchar](max) NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[FuelUsage]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[FuelUsage](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liFuelKey] [int] NOT NULL,
	[iVehicleID] [smallint] NULL,
	[dtFillDate] [datetime] NULL,
	[fFillOdo] [real] NULL,
	[liEngineSeconds] [int] NULL,
	[fLitres] [real] NULL,
	[sCur] [nchar](3) NULL,
	[fCost] [money] NULL,
	[sBaseCur] [nchar](3) NULL,
	[fBaseCost] [money] NULL,
 CONSTRAINT [PK_FuelUsage] PRIMARY KEY CLUSTERED 
(
	[liFuelKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[GPSData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[GPSData](
	[liGPSID] [int] NOT NULL,
	[fLatitude] [real] NULL,
	[fLongitude] [real] NULL,
 CONSTRAINT [PK_GPSData] PRIMARY KEY CLUSTERED 
(
	[liGPSID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[GroupTriggers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[GroupTriggers](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[liGroupID] [int] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucTriggerID] [tinyint] NOT NULL,
	[ucSeq] [tinyint] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[ucOperator] [tinyint] NOT NULL,
	[lfValue] [float] NOT NULL,
	[bRequired] [bit] NOT NULL,
	[ucTOper] [tinyint] NULL,
	[sUserName] [nvarchar](100) NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[GroupTriggers_VehicleTriggers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[GroupTriggers_VehicleTriggers](
	[iVehicleID] [int] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucTriggerID] [tinyint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[ucSeq] [tinyint] NULL,
	[iParameterID] [smallint] NULL,
	[ucOperator] [tinyint] NULL,
	[lfValue] [float] NULL,
	[bRequired] [bit] NULL,
	[ucTOper] [tinyint] NULL,
 CONSTRAINT [PK_GroupTriggers_VehicleTriggers] PRIMARY KEY CLUSTERED 
(
	[iVehicleID] ASC,
	[iEventID] ASC,
	[ucTriggerID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[MapLocationPolygonPoints]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[MapLocationPolygonPoints](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liLocationID] [int] NOT NULL,
	[liSequence] [int] NULL,
	[fLongitude] [real] NULL,
	[fLatitude] [real] NULL,
 CONSTRAINT [UK_MapLocationPolygonPoints] UNIQUE NONCLUSTERED 
(
	[liLocationID] ASC,
	[liSequence] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[MapLocations]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[MapLocations](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liLocationID] [int] NOT NULL,
	[sLocationName] [nvarchar](100) NULL,
	[sDetails] [nvarchar](3500) NULL,
	[ucLocationType] [tinyint] NULL,
	[ucShapeType] [tinyint] NULL,
	[ucLocationSource] [tinyint] NULL,
	[fPointLongitude] [real] NULL,
	[fPointLatitude] [real] NULL,
	[liPointRadius] [int] NULL,
	[fUpperLeftLongitude] [real] NULL,
	[fUpperLeftLatitude] [real] NULL,
	[fLowerRightLongitude] [real] NULL,
	[fLowerRightLatitude] [real] NULL,
	[bDeleted] [bit] NULL,
	[bShowOnMap] [bit] NULL,
	[bReadOnly] [bit] NULL,
	[ucTaxType] [tinyint] NULL,
	[liSiteID] [int] NULL,
 CONSTRAINT [PK_MapLocations] PRIMARY KEY CLUSTERED 
(
	[liLocationID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[OrgOptions]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[OrgOptions](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[sLPDealerName] [nvarchar](50) NULL,
	[sLPDealerTelNo] [nvarchar](20) NULL,
	[sLPRegCode] [nvarchar](50) NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[Param]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[Param](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[sDescription] [nvarchar](200) NULL,
	[sSystemName] [nvarchar](255) NULL,
	[ucValueFormat] [tinyint] NULL,
	[sUnits] [nvarchar](10) NULL,
	[bSystem] [bit] NULL,
	[bFuelCounter] [bit] NULL,
	[bProfiled] [bit] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_Param] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[PassengerData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[PassengerData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[RID] [int] NULL,
	[VehicleID] [smallint] NOT NULL,
	[BlockSequence] [int] NOT NULL,
	[PassengerID] [smallint] NULL,
	[IdentifiedDate] [datetime] NULL,
	[Odometer] [decimal](19, 5) NULL,
 CONSTRAINT [PK_PassengerData] PRIMARY KEY CLUSTERED 
(
	[VehicleID] ASC,
	[BlockSequence] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[Passengers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[Passengers](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[PassengerGUID] [uniqueidentifier] NOT NULL,
	[iPassengerID] [smallint] NOT NULL,
	[sName] [nvarchar](255) NOT NULL,
 CONSTRAINT [PK_Passengers] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iPassengerID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[ProfileData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[ProfileData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[RID] [int] NULL,
	[TripID] [int] NOT NULL,
	[SubTripSequence] [smallint] NOT NULL,
	[ParameterID] [smallint] NOT NULL,
	[Sequence] [smallint] NOT NULL,
	[Duration] [float] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[QuarantinedDataSummary]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[QuarantinedDataSummary](
	[SourceTable] [varchar](50) NULL,
	[VehicleID] [int] NULL,
	[ChangeDateKey] [date] NULL,
	[Occurrences] [int] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_CalibrationParameters]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_CalibrationParameters](
	[ParameterKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [smallint] NOT NULL,
	[Description] [nvarchar](200) NOT NULL,
	[Units] [nvarchar](20) NULL,
	[ValueFormat] [tinyint] NOT NULL,
	[IsFuelCounter] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_Certifications]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_Certifications](
	[CertificationKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[ChangeDate] [date] NULL,
	[HostID] [int] NULL,
	[DriverGUID] [uniqueidentifier] NULL,
	[TrailerGUID] [uniqueidentifier] NULL,
	[VehicleGUID] [uniqueidentifier] NULL,
	[CertificationTypeLookupKey] [int] NULL,
	[CertificationDescription] [nvarchar](255) NULL,
	[ExpirationDateKey] [date] NULL,
	[ObtainedDateKey] [date] NULL,
	[LastRenewalDateKey] [date] NULL,
	[CertificationDurationDays] [int] NULL,
	[CertificationReminderDays] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_Devices]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_Devices](
	[DeviceKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [int] NOT NULL,
	[DeviceType] [nvarchar](50) NULL,
	[DeviceName] [nvarchar](200) NULL,
	[SystemName] [nvarchar](255) NULL,
	[ReportProgID] [nvarchar](200) NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_Drivers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_Drivers](
	[DriverKey] [int] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[EndDateKey] [date] NOT NULL,
	[IsCurrentRecord] [bit] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [int] NOT NULL,
	[SiteKey] [int] NOT NULL,
	[DriverGUID] [uniqueidentifier] NULL,
	[IsActive] [bit] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[DriverName] [nvarchar](255) NULL,
	[DriverEmployeeNumber] [nvarchar](255) NULL,
	[DriverExtendedID] [varchar](32) NULL,
	[ConfigurationGroupName] [nvarchar](255) NULL,
	[UTCOffsetKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_EventDescriptions]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_EventDescriptions](
	[EventDescriptionKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [int] NULL,
	[EventName] [nvarchar](255) NULL,
	[ParameterKey] [int] NULL,
	[SummaryTypeLookupKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_EventGroups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_EventGroups](
	[EventGroupKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[EventGroupnameLookupKey] [int] NOT NULL,
	[EventDescriptionKey] [int] NOT NULL,
	[EventGroupCategory] [nvarchar](25) NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_GeoLocationsToShapes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_GeoLocationsToShapes](
	[GeoLocationToShapeKey] [bigint] NOT NULL,
	[GeoLocationKey] [bigint] NOT NULL,
	[ShapeKey] [int] NOT NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_Organisations_Late]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_Organisations_Late](
	[OrganisationKey] [int] NOT NULL,
	[OrganisationGUID] [uniqueidentifier] NULL,
	[DealerName] [nvarchar](50) NULL,
	[DealerTelNo] [nchar](20) NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_Passengers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_Passengers](
	[PassengerKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[StartDateKey] [date] NULL,
	[EndDateKey] [date] NULL,
	[IsCurrentRecord] [bit] NULL,
	[HostID] [int] NULL,
	[PassengerGUID] [uniqueidentifier] NULL,
	[PassengerName] [nvarchar](255) NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_ReportingGroups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_ReportingGroups](
	[ReportingGroupKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[ReportingGroupTypeLookupKey] [int] NULL,
	[HostID] [int] NULL,
	[ReportingGroupGUID] [uniqueidentifier] NULL,
	[ReportingGroupName] [nvarchar](510) NULL,
	[MemberGUID] [uniqueidentifier] NULL,
	[ReportingGroupParentKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_Shapes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_Shapes](
	[ShapeKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [int] NOT NULL,
	[SiteKey] [int] NULL,
	[ShapeType] [tinyint] NOT NULL,
	[ShapeName] [nvarchar](100) NOT NULL,
	[ShapeBoundaryType] [tinyint] NOT NULL,
	[ShapeBoundary] [geography] NULL,
	[ShapeTaxTypeLookupKey] [int] NULL,
	[IsDeleted] [bit] NOT NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_SimpleScoreCriteria]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_SimpleScoreCriteria](
	[ScoreCriteriaKey] [int] NOT NULL,
	[StartDateKey] [date] NULL,
	[EndDateKey] [date] NULL,
	[IsCurrentRecord] [bit] NULL,
	[IsActive] [bit] NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [int] NULL,
	[EventDescriptionKey] [int] NULL,
	[TriggerID] [int] NULL,
	[ScoreDuration] [float] NULL,
	[ScoreSeverity] [float] NULL,
	[ScoreWeight] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_Sites]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_Sites](
	[SiteKey] [int] NOT NULL,
	[StartDateKey] [int] NULL,
	[EndDateKey] [int] NULL,
	[IsActiveRecord] [bit] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [int] NULL,
	[SiteName] [nvarchar](510) NULL,
	[MemberOfSiteGUID] [uniqueidentifier] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_Trailers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_Trailers](
	[TrailerKey] [int] NOT NULL,
	[StartDateKey] [date] NULL,
	[EndDateKey] [date] NULL,
	[IsCurrentRecord] [bit] NULL,
	[IsActive] [bit] NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [int] NULL,
	[TrailerGUID] [uniqueidentifier] NULL,
	[TrailerAssetNumber] [nvarchar](255) NULL,
	[TrailerRegNumber] [nvarchar](15) NULL,
	[TrailerDescription] [nvarchar](255) NULL,
	[TrailerUnitID] [int] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[UnitTypeLookupKey] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_Units]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_Units](
	[UnitKey] [int] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[EndDateKey] [date] NOT NULL,
	[IsCurrentRecord] [bit] NOT NULL,
	[IsActive] [bit] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[AssetHostID] [int] NOT NULL,
	[AssetTypeLookupKey] [int] NOT NULL,
	[UnitSerial] [nvarchar](50) NULL,
	[AssetGUID] [uniqueidentifier] NULL,
	[UnitTypeLookupKey] [int] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[OSVersion] [nvarchar](50) NULL,
	[FirmwareVersion] [nvarchar](50) NULL,
	[FirmwareLoadedDateKey] [date] NULL,
	[UTCOffsetKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_VehicleCostCategories]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_VehicleCostCategories](
	[VehicleCostCategoryKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [int] NULL,
	[CategoryName] [nvarchar](50) NULL,
	[CategoryNotes] [nvarchar](255) NULL,
	[Type] [nvarchar](10) NULL,
	[IsRecurring] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_VehicleDeviceParameters]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_VehicleDeviceParameters](
	[VehicleDeviceParameterKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NOT NULL,
	[DeviceKey] [int] NOT NULL,
	[ParameterKey] [int] NOT NULL,
	[IsDeviceDefault] [bit] NOT NULL,
	[IsParameterDefault] [bit] NOT NULL,
	[CalibrationType] [tinyint] NOT NULL,
	[CalibrationProperties] [xml] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_VehicleDevices]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_VehicleDevices](
	[VehicleDeviceKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NOT NULL,
	[DeviceKey] [int] NOT NULL,
	[InputLine] [char](2) NULL,
	[DeviceProperties] [xml] NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_VehicleEventDefinitions]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_VehicleEventDefinitions](
	[VehicleEventKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[VehicleGUID] [uniqueidentifier] NOT NULL,
	[EventDescriptionKey] [int] NOT NULL,
	[EventType] [tinyint] NULL,
	[InUse] [bit] NULL,
	[RecordStartOdometer] [bit] NULL,
	[RecordStartPosition] [bit] NULL,
	[RecordEndOdometer] [bit] NULL,
	[RecordEndPosition] [bit] NULL,
	[RecordPulseCount] [bit] NULL,
	[SendActivePosition] [bit] NULL,
	[StartRecordDelay] [smallint] NULL,
	[StartAlarmDelay] [smallint] NULL,
	[StartExternalRelay1Delay] [smallint] NULL,
	[StartExternalRelay2Delay] [smallint] NULL,
	[StartCriticalDisplayDelay] [smallint] NULL,
	[ActiveSendDelay] [smallint] NULL,
	[ActiveEndSendDelay] [smallint] NULL,
	[StartActiveTrackDelay] [smallint] NULL,
	[ActiveTrackInterval] [smallint] NULL,
	[AlarmState] [tinyint] NULL,
	[ExternalRelay1State] [tinyint] NULL,
	[ExternalRelay2State] [tinyint] NULL,
	[WarningMessage] [nvarchar](255) NULL,
	[ActiveMessagePriority] [tinyint] NULL,
	[EventTriggerDefinition] [xml] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_VehicleProfiles]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_VehicleProfiles](
	[VehicleProfileKey] [int] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[EndDateKey] [date] NOT NULL,
	[IsCurrentRecord] [bit] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NOT NULL,
	[ParameterKey] [int] NOT NULL,
	[RangeLowerValue1] [float] NULL,
	[RangeLowerValue2] [float] NULL,
	[RangeLowerValue3] [float] NULL,
	[RangeLowerValue4] [float] NULL,
	[RangeLowerValue5] [float] NULL,
	[RangeLowerValue6] [float] NULL,
	[RangeLowerValue7] [float] NULL,
	[RangeLowerValue8] [float] NULL,
	[RangeLowerValue9] [float] NULL,
	[RangeLowerValue10] [float] NULL,
	[RangeLowerValue11] [float] NULL,
	[UTCOffsetKey] [smallint] NOT NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_DIM_Vehicles]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_DIM_Vehicles](
	[VehicleKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[EndDateKey] [date] NOT NULL,
	[IsCurrentRecord] [bit] NOT NULL,
	[IsActive] [bit] NOT NULL,
	[HostID] [int] NOT NULL,
	[SiteKey] [int] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NULL,
	[VehicleDescription] [nvarchar](255) NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[LastServiceDateKey] [date] NULL,
	[IsYellowEquip] [bit] NULL,
	[RegNumber] [nvarchar](15) NULL,
	[ServiceByDistance] [decimal](19, 4) NULL,
	[ServiceByDate] [tinyint] NULL,
	[ServiceByEngineSeconds] [int] NULL,
	[NextServiceDueDistance] [decimal](19, 4) NULL,
	[NextServiceDueDateKey] [date] NULL,
	[NextServiceDueEngineSeconds] [int] NULL,
	[DefaultDriverGUID] [uniqueidentifier] NULL,
	[TargetFuelConsumption] [real] NULL,
	[TargetFuelConsumptionHourly] [real] NULL,
	[ScoreTriggerOverspeeding] [float] NULL,
	[ScoreTriggerOverRevving] [float] NULL,
	[ScoreTriggerOverHarshDeceleration] [float] NULL,
	[ScoreTriggerOverHarshAccelleration] [float] NULL,
	[TermScriptConfigGroup] [int] NULL,
	[ConfigurationGroupNameID] [int] NULL,
	[ConfigurationGroupName] [nvarchar](255) NULL,
	[FuelTypeLookupKey] [int] NULL,
	[EstimateCO2EmissionGramsperKm] [float] NULL,
	[UnitTypeLookupKey] [int] NULL,
	[BatteryVoltage] [numeric](19, 6) NULL,
	[CurrentDeviceDriverVersion] [nvarchar](25) NULL,
	[LastDeviceDriverUploadDateTime] [datetimeoffset](0) NULL,
	[LastConfigurationUploadDateTime] [datetimeoffset](0) NULL,
	[LastDeviceChangeDateTime] [datetimeoffset](0) NULL,
	[LastEventChangeDateTime] [datetimeoffset](0) NULL,
	[CreateDateKey] [date] NULL,
	[IsMeasuringFuel] [bit] NULL,
	[IsCofiguredForMeasuringFuel] [bit] NULL,
	[UTCOffsetKey] [int] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_ActivityDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_ActivityDetails](
	[ActivityDetailKey] [bigint] NOT NULL,
	[ActivitySummaryKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [int] NOT NULL,
	[VehicleSiteKey] [int] NULL,
	[ActivityStartDateKey] [date] NULL,
	[ActivityEndDateKey] [date] NULL,
	[ActivityStartTime] [time](0) NULL,
	[ActivityEndTime] [time](0) NULL,
	[ActivityStartDateTime] [datetimeoffset](0) NULL,
	[ActivityEndDateTime] [datetimeoffset](0) NULL,
	[MovementStartDateKey] [date] NULL,
	[MovementEndDateKey] [date] NULL,
	[MovementStartTime] [time](0) NULL,
	[MovementEndTime] [time](0) NULL,
	[MovementStartDateTime] [datetimeoffset](0) NULL,
	[MovementEndDateTime] [datetimeoffset](0) NULL,
	[NextMovementActivityDetailKey] [bigint] NULL,
	[NextMovementStartDateTime] [datetimeoffset](0) NULL,
	[IsLastMovement] [bit] NULL,
	[StartOdometer] [decimal](19, 4) NULL,
	[EndOdometer] [decimal](19, 4) NULL,
	[StartEngineSeconds] [int] NULL,
	[EndEngineSeconds] [int] NULL,
	[StartGeoLocationKey] [bigint] NULL,
	[EndGeoLocationKey] [bigint] NULL,
	[DistanceTravelled] [decimal](19, 4) NULL,
	[Duration] [int] NULL,
	[DrivingTime] [int] NULL,
	[StandingTime] [int] NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[SpeedTime] [int] NULL,
	[SpeedOccurs] [int] NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[BrakeTime] [int] NULL,
	[BrakeOccurs] [int] NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[AccelTime] [int] NULL,
	[AccelOccurs] [int] NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[RPMTIme] [int] NULL,
	[RPMOccurs] [int] NULL,
	[OutOfGreenBandTime] [int] NULL,
	[ExcessiveIdleTime] [int] NULL,
	[ExcessiveIdleOccurs] [int] NULL,
	[IdleTime] [int] NULL,
	[IdleOccurs] [int] NULL,
	[EngineSeconds] [int] NULL,
	[NoGoZoneEntry] [bit] NULL,
	[Passengers] [smallint] NULL,
	[FuelUsedMeasured] [decimal](9, 4) NULL,
	[FuelUsedCalculated] [decimal](9, 4) NULL,
	[FuelUsedHierarchy] [smallint] NULL,
	[NightDuration] [int] NULL,
	[AfterHoursDuration] [int] NULL,
	[TotalCarbonEmission] [float] NULL,
	[TotalCO2Emission] [float] NULL,
	[PulseParameterKey] [int] NULL,
	[PulseValue] [float] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[RoadSpeedTime] [int] NULL,
	[RoadSpeedOccurs] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_ActivitySummary]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_ActivitySummary](
	[ActivitySummaryKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [bigint] NOT NULL,
	[UnitTripNumber] [bigint] NOT NULL,
	[ActivityStartDateKey] [date] NOT NULL,
	[ActivityEndDateKey] [date] NOT NULL,
	[ActivityStartTime] [time](0) NULL,
	[ActivityEndTime] [time](0) NULL,
	[ActivityStartDateTime] [datetimeoffset](0) NOT NULL,
	[ActivityEndDateTime] [datetimeoffset](0) NOT NULL,
	[VehicleKey] [int] NULL,
	[DriverKey] [int] NULL,
	[OriginalDriverKey] [int] NULL,
	[OriginalDriverSiteKey] [int] NULL,
	[OriginalVehicleSiteKey] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[TotalFuelUsedMeasured] [decimal](19, 4) NULL,
	[TotalFuelUsedCalculated] [decimal](19, 4) NULL,
	[StartOdometer] [decimal](19, 4) NULL,
	[EndOdometer] [decimal](19, 4) NULL,
	[StartEngineSeconds] [int] NULL,
	[EndEngineSeconds] [int] NULL,
	[StartGeoLocationKey] [bigint] NULL,
	[EndGeoLocationKey] [bigint] NULL,
	[AverageSimpleDriverScore] [decimal](19, 5) NULL,
	[TotalDuration] [int] NULL,
	[TotalDistanceTravelled] [decimal](19, 4) NULL,
	[TotalDrivingTime] [int] NULL,
	[TotalEngineSeconds] [int] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[TotalIdleTime] [int] NULL,
	[TotalPassengers] [smallint] NULL,
	[TotalStandingTime] [int] NULL,
	[TotalNightDuration] [int] NULL,
	[TotalAfterHoursDuration] [int] NULL,
	[TotalCarbonEmission] [float] NULL,
	[TotalCO2Emission] [float] NULL,
	[TripClassificationLookupKey] [int] NULL,
	[TripClassificationHierarchy] [smallint] NULL,
	[IsDutchTaxTripClassification] [bit] NULL,
	[MovementCount] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_EventDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_EventDetails](
	[EventDetailKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [bigint] NOT NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[TrailerKey] [int] NULL,
	[EventDescriptionKey] [int] NULL,
	[EventTypeLookupKey] [int] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[EventStartDateKey] [date] NULL,
	[EventEndDateKey] [date] NULL,
	[EventStartTime] [time](0) NULL,
	[EventEndTime] [time](0) NULL,
	[EventStartDateTime] [datetimeoffset](0) NULL,
	[EventEndDateTime] [datetimeoffset](0) NULL,
	[StartOdometer] [decimal](19, 4) NULL,
	[EndOdometer] [decimal](19, 4) NULL,
	[EventValue] [float] NULL,
	[StartGeoLocationKey] [bigint] NULL,
	[EndGeoLocationKey] [bigint] NULL,
	[TotalOccurs] [int] NULL,
	[TotalTime] [int] NULL,
	[ParameterKey] [int] NULL,
	[Litres] [decimal](9, 4) NULL,
	[PulseParameterKey] [int] NULL,
	[PulseValue] [float] NULL,
	[UTCOffsetKey] [int] NULL,
	[VideoKey] [bigint] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_EventRoadspeedLimits]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_EventRoadspeedLimits](
	[EventDetailKey] [bigint] NOT NULL,
	[EventStartDateKey] [date] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[SpeedLimit] [decimal](9, 5) NULL,
	[IsDeleted] [bit] NOT NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_EventSummary]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_EventSummary](
	[EventSummaryKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[VehicleSiteKey] [int] NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NOT NULL,
	[TrailerKey] [int] NULL,
	[EventDescriptionKey] [int] NOT NULL,
	[EventStartDateKey] [date] NOT NULL,
	[NumberOfEvents] [int] NULL,
	[MaxEventValue] [float] NULL,
	[MinEventValue] [float] NULL,
	[AvgEventValue] [float] NULL,
	[TotalEventValue] [float] NULL,
	[TotalOccurs] [int] NULL,
	[TotalTime] [int] NULL,
	[TotalLitres] [decimal](19, 4) NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_FuelCapture]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_FuelCapture](
	[FuelCapturekey] [bigint] NOT NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [bigint] NULL,
	[VehicleKey] [int] NOT NULL,
	[FillDateKey] [date] NOT NULL,
	[FillTime] [time](0) NULL,
	[FillDateTime] [datetimeoffset](0) NOT NULL,
	[PreviousFillDateTime] [datetimeoffset](0) NULL,
	[Litres] [real] NULL,
	[BaseCost] [money] NULL,
	[BaseCurrencyKey] [int] NULL,
	[FillOdometer] [decimal](19, 5) NULL,
	[PreviousFillOdometer] [decimal](19, 5) NULL,
	[EngineSeconds] [int] NULL,
	[PreviousEngineSeconds] [int] NULL,
	[DistanceTravelled] [decimal](19, 5) NULL,
	[FillFuelConsumption] [real] NULL,
	[ActivityDetailKey] [int] NULL,
	[FuelStopGeoLocationKey] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_PassengerActivities]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_PassengerActivities](
	[PassengerActivityKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [int] NOT NULL,
	[PassengerKey] [int] NOT NULL,
	[VehicleKey] [int] NOT NULL,
	[ActivitySummaryKey] [bigint] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[IdentifiedDateKey] [date] NOT NULL,
	[IdentifiedTime] [time](0) NULL,
	[IdentifiedDateTime] [datetimeoffset](0) NOT NULL,
	[Odometer] [decimal](19, 4) NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_ProfileDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_ProfileDetails](
	[ProfileDetailKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostTripID] [int] NOT NULL,
	[HostSequenceID] [smallint] NOT NULL,
	[HostParameterID] [smallint] NOT NULL,
	[VehicleKey] [int] NOT NULL,
	[ParameterKey] [int] NOT NULL,
	[VehicleProfileKey] [int] NULL,
	[ActivityDetailKey] [bigint] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[StartTime] [time](0) NOT NULL,
	[StartDateTime] [datetimeoffset](0) NOT NULL,
	[EndDateKey] [date] NOT NULL,
	[EndTime] [time](0) NOT NULL,
	[EndDateTime] [datetimeoffset](0) NOT NULL,
	[RangeDuration0] [int] NULL,
	[RangeDuration1] [int] NULL,
	[RangeDuration2] [int] NULL,
	[RangeDuration3] [int] NULL,
	[RangeDuration4] [int] NULL,
	[RangeDuration5] [int] NULL,
	[RangeDuration6] [int] NULL,
	[RangeDuration7] [int] NULL,
	[RangeDuration8] [int] NULL,
	[RangeDuration9] [int] NULL,
	[RangeDuration10] [int] NULL,
	[RangeDuration11] [int] NULL,
	[UTCOffsetKey] [int] NOT NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_ServiceHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_ServiceHistory](
	[ServiceHistoryKeyID] [bigint] NOT NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [int] NULL,
	[VehicleKey] [int] NULL,
	[ServiceDateKey] [date] NOT NULL,
	[ServiceDateTime] [datetimeoffset](0) NOT NULL,
	[Odometer] [real] NOT NULL,
	[EngineSeconds] [int] NULL,
	[Reference] [nvarchar](50) NULL,
	[BaseCost] [money] NULL,
	[BaseCurrencyKey] [int] NULL,
	[Notes] [nvarchar](max) NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_ShapeVisits]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_ShapeVisits](
	[ShapeVisitKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[VisitDateKey] [date] NOT NULL,
	[ShapeKey] [int] NOT NULL,
	[VehicleKey] [int] NOT NULL,
	[DriverKey] [int] NULL,
	[DurationAtLocation] [int] NULL,
	[NumberOfVisits] [int] NULL,
	[NumberOfUniqueVisits] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NOT NULL,
	[UpdateBatchKey] [int] NOT NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_SimpleScoreDaily]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_SimpleScoreDaily](
	[SimpleScoreDailyKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[SnapShotDateKey] [date] NOT NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[DistanceTravelled] [decimal](19, 4) NULL,
	[DrivingTime] [int] NULL,
	[Duration] [int] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[SpeedTime] [int] NULL,
	[SpeedOccurs] [int] NULL,
	[SpeedScoreByDuration] [decimal](19, 5) NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[BrakeTime] [int] NULL,
	[BrakeOccurs] [int] NULL,
	[BrakeScoreByDuration] [decimal](19, 5) NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[AccelTime] [int] NULL,
	[AccelOccurs] [int] NULL,
	[AccelScoreByDuration] [decimal](19, 5) NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[RPMTime] [int] NULL,
	[RPMOccurs] [int] NULL,
	[RPMScoreByDuration] [decimal](19, 5) NULL,
	[OutOfGreenBandTime] [int] NULL,
	[OutOfGreenBandScoreByDuration] [decimal](19, 5) NULL,
	[ExcessiveIdleOccurs] [int] NULL,
	[ExcessiveIdleTime] [int] NULL,
	[ExcessiveIdleScoreByDuration] [decimal](19, 5) NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[RoadSpeedTime] [int] NULL,
	[RoadSpeedOccurs] [int] NULL,
	[RoadSpeedScoreByDuration] [decimal](19, 5) NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_SimpleScoreDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_SimpleScoreDetails](
	[SimpleScoreKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[ActivityStartDateKey] [date] NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[DistanceTravelled] [decimal](19, 4) NULL,
	[DrivingTime] [int] NULL,
	[Duration] [int] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[SpeedTime] [int] NULL,
	[SpeedOccurs] [int] NULL,
	[SpeedScore] [decimal](9, 5) NULL,
	[SpeedScoreCiteriaKey] [int] NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[BrakeTime] [int] NULL,
	[BrakeOccurs] [int] NULL,
	[BrakeScore] [decimal](9, 5) NULL,
	[BrakeScoreCiteriaKey] [int] NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[AccelTime] [int] NULL,
	[AccelOccurs] [int] NULL,
	[AccelScore] [decimal](9, 5) NULL,
	[AccelScoreCiteriaKey] [int] NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[RPMTime] [int] NULL,
	[RPMOccurs] [int] NULL,
	[RPMScore] [decimal](9, 5) NULL,
	[RPMScoreCiteriaKey] [int] NULL,
	[OutOfGreenBandTime] [int] NULL,
	[OutOfGreenBandScore] [decimal](9, 5) NULL,
	[OutOfGreenbandScoreCiteriaKey] [int] NULL,
	[ExcessiveIdleOccurs] [int] NULL,
	[ExcessiveIdleTime] [int] NULL,
	[ExcessiveIdleScore] [decimal](9, 5) NULL,
	[ExcessiveIdleScoreCiteriaKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL,
	[RoadSpeedTime] [int] NULL,
	[RoadSpeedOccurs] [int] NULL,
	[RoadSpeedScore] [decimal](9, 5) NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_SiteSnapshotDaily]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_SiteSnapshotDaily](
	[SiteSnapShotKey] [int] NOT NULL,
	[OrganisationKey] [int] NULL,
	[SnapShotDateKey] [date] NOT NULL,
	[VehicleSiteKey] [int] NULL,
	[VehiclesWithTrips] [smallint] NULL,
	[DriversWithTrips] [smallint] NULL,
	[NumberOfTrips] [int] NULL,
	[NumberOfCollisions] [int] NULL,
	[NumberOfKMs] [decimal](19, 4) NULL,
	[NumberOfHours] [int] NULL,
	[FuelUsedMeasured] [decimal](9, 4) NULL,
	[FuelUsedCalculated] [decimal](9, 4) NULL,
	[TotalIdlingTime] [int] NULL,
	[NumberOfActiveVehicles] [int] NULL,
	[NumberOfActiveDrivers] [int] NULL,
	[VehicleUtilization] [int] NULL,
	[DriverUtilization] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_TachoData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_TachoData](
	[TachoDataKey] [bigint] NOT NULL,
	[HostID] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[BlockSequence] [int] NOT NULL,
	[VehicleKey] [int] NOT NULL,
	[TachoStartDateKey] [date] NOT NULL,
	[TachoEndDateKey] [date] NOT NULL,
	[TachoStartDateTime] [datetimeoffset](0) NOT NULL,
	[TachoEndDateTime] [datetimeoffset](0) NOT NULL,
	[RawData] [binary](1024) NULL,
	[MaxSpeed] [int] NULL,
	[MinSpeed] [int] NULL,
	[AvgSpeed] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_TerminalDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_TerminalDetails](
	[TerminalDetailKey] [int] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[HostID] [bigint] NOT NULL,
	[VehicleKey] [int] NOT NULL,
	[DriverKey] [int] NULL,
	[TerminalDateKey] [date] NOT NULL,
	[TerminalTime] [time](0) NOT NULL,
	[TerminalDateTime] [datetimeoffset](0) NULL,
	[Odometer] [decimal](19, 4) NULL,
	[MenuID] [char](5) NULL,
	[MenuItemCode] [char](5) NULL,
	[ValueType] [tinyint] NULL,
	[NumberValue] [float] NULL,
	[StringValue] [nvarchar](255) NULL,
	[ActivityDetailKey] [bigint] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[ROLLBACK_FACT_VehicleCosts]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[ROLLBACK_FACT_VehicleCosts](
	[VehicleCostKey] [bigint] NOT NULL,
	[OrganisationKey] [int] NULL,
	[HostID] [nvarchar](50) NULL,
	[CostDateKey] [date] NOT NULL,
	[IsRecurring] [int] NULL,
	[VehicleKey] [int] NOT NULL,
	[OdometerReading] [decimal](19, 4) NULL,
	[CostCategoryKey] [int] NULL,
	[BaseCost] [money] NULL,
	[BaseCurrencyKey] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[IsDeleted] [bit] NULL,
	[CreateBatchKey] [int] NULL,
	[UpdateBatchKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[ScoredEvents]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[ScoredEvents](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucScoreWeight] [tinyint] NOT NULL,
	[lfScoreDuration] [float] NOT NULL,
	[lfScoreSeverity] [float] NULL,
	[ucScoreTriggerID] [tinyint] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_ScoredEvents] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iEventID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[ServiceHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[ServiceHistory](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liServiceKey] [int] NOT NULL,
	[iVehicleID] [smallint] NULL,
	[dtServiceDate] [datetime] NULL,
	[fOdometer] [real] NULL,
	[liEngineSeconds] [int] NULL,
	[sReference] [nvarchar](50) NULL,
	[fCost] [money] NULL,
	[sCur] [nchar](3) NULL,
	[fBaseCost] [money] NULL,
	[sBaseCur] [nchar](3) NULL,
	[sNotes] [nvarchar](max) NULL,
 CONSTRAINT [PK_ServiceHistory] PRIMARY KEY NONCLUSTERED 
(
	[liServiceKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[Sites]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[Sites](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetime] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[liSiteID] [int] NOT NULL,
	[SiteGUID] [uniqueidentifier] NOT NULL,
	[sName] [nvarchar](255) NOT NULL,
 CONSTRAINT [PK_Sites] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[liSiteID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_DIM_CalibrationParameters]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_CalibrationParameters](
	[HostID] [smallint] NOT NULL,
	[Description] [nvarchar](200) NOT NULL,
	[Units] [nvarchar](20) NULL,
	[ValueFormat] [tinyint] NOT NULL,
	[IsFuelCounter] [bit] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_Certifications]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_Certifications](
	[MaxRID] [bigint] NULL,
	[ChangeDate] [date] NULL,
	[HostID] [int] NULL,
	[DriverGUID] [uniqueidentifier] NULL,
	[TrailerGUID] [uniqueidentifier] NULL,
	[VehicleGUID] [uniqueidentifier] NULL,
	[CertificationTypeLookupKey] [int] NULL,
	[CertificationDescription] [nvarchar](255) NULL,
	[ExpirationDateKey] [date] NULL,
	[ObtainedDateKey] [date] NULL,
	[LastRenewalDateKey] [date] NULL,
	[CertificationDurationDays] [int] NULL,
	[CertificationReminderDays] [int] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_Devices]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_Devices](
	[HostID] [int] NOT NULL,
	[DeviceType] [nvarchar](50) NULL,
	[DeviceName] [nvarchar](200) NULL,
	[SystemName] [nvarchar](255) NULL,
	[ReportProgID] [nvarchar](200) NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_Drivers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_Drivers](
	[DriverHostID] [smallint] NOT NULL,
	[DriverGUID] [uniqueidentifier] NULL,
	[SiteHostID] [int] NULL,
	[IsActive] [bit] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[SiteKey] [int] NULL,
	[DriverName] [nvarchar](255) NULL,
	[DriverEmployeeNumber] [nvarchar](255) NULL,
	[DriverExtendedID] [varchar](32) NULL,
	[ConfigurationGroupName] [nvarchar](255) NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_DIM_EventDescriptions]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_EventDescriptions](
	[MaxRID] [int] NULL,
	[HostID] [int] NULL,
	[EventName] [nvarchar](255) NULL,
	[SummaryID] [smallint] NULL,
	[ParameterKey] [int] NULL,
	[SummaryTypeLookupKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_EventGroups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_EventGroups](
	[EventID] [int] NULL,
	[EventGroupnameLookupKey] [int] NULL,
	[EventDescriptionKey] [int] NULL,
	[EventGroupCategory] [nvarchar](25) NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_GeoLocations]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_GeoLocations](
	[HostID] [int] NOT NULL,
	[Longitude] [real] NOT NULL,
	[Latitude] [real] NOT NULL,
	[GeoLocationKey] [bigint] NULL,
 CONSTRAINT [PK_STAGE_DIM_GeoLocations] PRIMARY KEY CLUSTERED 
(
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_GeoLocationsToShapes_ChangedShapes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_GeoLocationsToShapes_ChangedShapes](
	[ShapeKey] [int] NOT NULL,
	[ShapeBoundary] [geography] NULL,
 CONSTRAINT [PK__STAGE_DI__472BD2AD55009F39] PRIMARY KEY CLUSTERED 
(
	[ShapeKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_Organisations_Late]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_Organisations_Late](
	[DealerName] [nvarchar](50) NULL,
	[DealerTelNo] [nvarchar](20) NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_OrganisationsToGeoLocations]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_OrganisationsToGeoLocations](
	[GeoLocationKey] [bigint] NOT NULL,
	[LocationPoint] [geography] NOT NULL,
 CONSTRAINT [PK_STAGE_DIM_OrganisationsToGeoLocations] PRIMARY KEY CLUSTERED 
(
	[GeoLocationKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_Passengers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_Passengers](
	[MaxRID] [bigint] NULL,
	[HostID] [int] NULL,
	[PassengerGUID] [uniqueidentifier] NULL,
	[PassengerName] [nvarchar](255) NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_ReportingGroups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_ReportingGroups](
	[MemberID] [int] NOT NULL,
	[ReportingGroupTypeLookupKey] [int] NULL,
	[HostID] [int] NULL,
	[ReportingGroupGUID] [uniqueidentifier] NULL,
	[ReportingGroupName] [nvarchar](510) NULL,
	[MemberGUID] [uniqueidentifier] NULL,
	[ReportingGroupParentKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_Shapes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_Shapes](
	[HostID] [int] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[SiteHostID] [int] NULL,
	[SiteKey] [int] NULL,
	[ShapeType] [tinyint] NULL,
	[ShapeName] [nvarchar](100) NULL,
	[ShapeBoundaryType] [tinyint] NULL,
	[ShapeBoundary] [geography] NULL,
	[ShapeTaxTypeLookupKey] [int] NULL,
	[IsDeleted] [bit] NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_DIM_SimpleScoreCriteria]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_SimpleScoreCriteria](
	[IsActive] [bit] NULL,
	[HostID] [int] NULL,
	[EventDescriptionKey] [int] NULL,
	[TriggerID] [int] NULL,
	[ScoreDuration] [float] NULL,
	[ScoreSeverity] [float] NULL,
	[ScoreWeight] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_Sites]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_Sites](
	[HostID] [int] NULL,
	[SiteName] [nvarchar](510) NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[MemberOfSiteGUID] [uniqueidentifier] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_Trailers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_Trailers](
	[HostID] [int] NULL,
	[IsActive] [bit] NULL,
	[TrailerGUID] [uniqueidentifier] NULL,
	[TrailerAssetNumber] [nvarchar](255) NULL,
	[TrailerRegNumber] [nvarchar](15) NULL,
	[TrailerDescription] [nvarchar](255) NULL,
	[TrailerUnitID] [int] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[UnitTypeLookupKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_Units]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_Units](
	[Operation] [char](1) NOT NULL,
	[AssetHostID] [int] NOT NULL,
	[AssetTypeLookupKey] [int] NOT NULL,
	[IsActive] [bit] NOT NULL,
	[UnitSerial] [nvarchar](50) NULL,
	[AssetGUID] [uniqueidentifier] NULL,
	[UnitTypeLookupKey] [int] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[OSVersion] [nvarchar](50) NULL,
	[FirmwareVersion] [nvarchar](50) NULL,
	[FirmwareLoadedDateKey] [date] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_DIM_UTCOffsetsLookUp]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_UTCOffsetsLookUp](
	[UTCOffsetKey] [int] NOT NULL,
	[OffsetYear] [int] NOT NULL,
	[StartDateKey] [date] NOT NULL,
	[EndDateKey] [date] NOT NULL,
	[StartDateTime] [datetimeoffset](0) NOT NULL,
	[EndDateTime] [datetimeoffset](0) NOT NULL,
	[SeasonStartDateTime] [datetimeoffset](0) NOT NULL,
	[SeasonEndDateTime] [datetimeoffset](0) NOT NULL,
	[UTCOffsetMinutes] [int] NOT NULL,
	[AdjustmentType] [nvarchar](15) NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_VehicleCostCategories]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_VehicleCostCategories](
	[Operation] [char](1) NULL,
	[HostID] [int] NULL,
	[CategoryName] [nvarchar](50) NULL,
	[CategoryNotes] [nvarchar](255) NULL,
	[Type] [nvarchar](10) NULL,
	[IsRecurring] [bit] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_DIM_VehicleDeviceParameters]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_VehicleDeviceParameters](
	[VehicleHostID] [smallint] NULL,
	[DeviceHostID] [int] NULL,
	[ParameterHostID] [smallint] NULL,
	[IsDeviceDefault] [bit] NULL,
	[IsParameterDefault] [bit] NULL,
	[CalibrationType] [tinyint] NULL,
	[VehicleGUID] [uniqueidentifier] NULL,
	[DeviceKey] [int] NULL,
	[ParameterKey] [int] NULL,
	[CalibrationProperties] [xml] NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_VehicleDevices]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_VehicleDevices](
	[VehicleHostID] [smallint] NOT NULL,
	[DeviceHostID] [int] NOT NULL,
	[PowerDeviceHostID] [int] NULL,
	[RecordInterval] [bit] NULL,
	[VehicleGuid] [uniqueidentifier] NULL,
	[DeviceKey] [int] NULL,
	[InputLine] [char](2) NULL,
	[DeviceProperties] [xml] NULL,
 CONSTRAINT [PK_STAGE_VehicleDevices] PRIMARY KEY CLUSTERED 
(
	[VehicleHostID] ASC,
	[DeviceHostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_DIM_VehicleEventDefinitions]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_VehicleEventDefinitions](
	[VehicleHostID] [smallint] NOT NULL,
	[EventHostID] [smallint] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NULL,
	[EventDescriptionKey] [int] NULL,
	[EventType] [tinyint] NULL,
	[InUse] [bit] NULL,
	[RecordStartOdometer] [bit] NULL,
	[RecordStartPosition] [bit] NULL,
	[RecordEndOdometer] [bit] NULL,
	[RecordEndPosition] [bit] NULL,
	[RecordPulseCount] [bit] NULL,
	[SendActivePosition] [bit] NULL,
	[StartRecordDelay] [smallint] NULL,
	[StartAlarmDelay] [smallint] NULL,
	[StartExternalRelay1Delay] [smallint] NULL,
	[StartExternalRelay2Delay] [smallint] NULL,
	[StartCriticalDisplayDelay] [smallint] NULL,
	[ActiveSendDelay] [smallint] NULL,
	[ActiveEndSendDelay] [smallint] NULL,
	[StartActiveTrackDelay] [smallint] NULL,
	[ActiveTrackInterval] [smallint] NULL,
	[AlarmState] [tinyint] NULL,
	[ExternalRelay1State] [tinyint] NULL,
	[ExternalRelay2State] [tinyint] NULL,
	[WarningMessage] [nvarchar](255) NULL,
	[ActiveMessagePriority] [tinyint] NULL,
	[EventTriggerDefinition] [xml] NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_DIM_VehicleProfiles]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_VehicleProfiles](
	[VehicleHostID] [smallint] NOT NULL,
	[ParameterHostID] [smallint] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NULL,
	[ParameterKey] [int] NULL,
	[RangeLowerValue1] [float] NULL,
	[RangeOperation1] [char](1) NULL,
	[RangeLowerValue2] [float] NULL,
	[RangeOperation2] [char](1) NULL,
	[RangeLowerValue3] [float] NULL,
	[RangeOperation3] [char](1) NULL,
	[RangeLowerValue4] [float] NULL,
	[RangeOperation4] [char](1) NULL,
	[RangeLowerValue5] [float] NULL,
	[RangeOperation5] [char](1) NULL,
	[RangeLowerValue6] [float] NULL,
	[RangeOperation6] [char](1) NULL,
	[RangeLowerValue7] [float] NULL,
	[RangeOperation7] [char](1) NULL,
	[RangeLowerValue8] [float] NULL,
	[RangeOperation8] [char](1) NULL,
	[RangeLowerValue9] [float] NULL,
	[RangeOperation9] [char](1) NULL,
	[RangeLowerValue10] [float] NULL,
	[RangeOperation10] [char](1) NULL,
	[RangeLowerValue11] [float] NULL,
	[RangeOperation11] [char](1) NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_DIM_Vehicles]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_DIM_Vehicles](
	[VehicleGUID] [uniqueidentifier] NULL,
	[SiteID] [bigint] NULL,
	[DefaultDriverID] [int] NULL,
	[ucUnitType] [int] NULL,
	[HostID] [int] NOT NULL,
	[IsActive] [bit] NULL,
	[VehicleDescription] [nvarchar](255) NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[SiteKey] [int] NULL,
	[LastServiceDateKey] [date] NULL,
	[IsYellowEquip] [bit] NULL,
	[RegNumber] [nvarchar](15) NULL,
	[ServiceByDistance] [decimal](19, 4) NULL,
	[ServiceByDate] [tinyint] NULL,
	[ServiceByEngineSeconds] [int] NULL,
	[NextServiceDueDistance] [decimal](19, 4) NULL,
	[NextServiceDueDateKey] [date] NULL,
	[NextServiceDueEngineSeconds] [int] NULL,
	[DefaultDriverGUID] [uniqueidentifier] NULL,
	[TargetFuelConsumption] [real] NULL,
	[TargetFuelConsumptionHourly] [real] NULL,
	[ScoreTriggerOverspeeding] [float] NULL,
	[ScoreTriggerOverRevving] [float] NULL,
	[ScoreTriggerOverHarshDeceleration] [float] NULL,
	[ScoreTriggerOverHarshAccelleration] [float] NULL,
	[TermScriptConfigGroup] [smallint] NULL,
	[ConfigurationGroupNameID] [int] NULL,
	[ConfigurationGroupName] [nvarchar](255) NULL,
	[FuelTypeLookupKey] [int] NULL,
	[EstimateCO2EmissionGramsperKm] [float] NULL,
	[UnitTypeLookupKey] [int] NULL,
	[BatteryVoltage] [numeric](19, 6) NULL,
	[CurrentDeviceDriverVersion] [nvarchar](25) NULL,
	[LastDeviceDriverUploadDateTime] [datetimeoffset](0) NULL,
	[LastConfigurationUploadDateTime] [datetimeoffset](0) NULL,
	[LastDeviceChangeDateTime] [datetimeoffset](0) NULL,
	[LastEventChangeDateTime] [datetimeoffset](0) NULL,
	[CreateDateKey] [date] NULL,
	[IsMeasuringFuel] [bit] NULL,
	[IsCofiguredForMeasuringFuel] [bit] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_FACT_ActivityChanges]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_ActivityChanges](
	[TripID] [bigint] NULL,
	[IsInTripSource] [bit] NULL,
	[IsInSubTripSource] [bit] NULL,
	[IsInTaxClassification] [bit] NULL,
	[IsMoreThanScoreChangeOnly] [bit] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_FACT_ActivityDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_ActivityDetails](
	[Operation] [char](1) NULL,
	[TripID] [bigint] NULL,
	[StartGPSID] [bigint] NULL,
	[EndGPSID] [bigint] NULL,
	[VehicleID] [int] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[PulseParameterID] [smallint] NULL,
	[ActivitySummaryKey] [bigint] NULL,
	[HostID] [int] NULL,
	[VehicleSiteKey] [int] NULL,
	[ActivityStartDateKey] [date] NULL,
	[ActivityEndDateKey] [date] NULL,
	[ActivityStartTime] [time](0) NULL,
	[ActivityEndTime] [time](0) NULL,
	[ActivityStartDateTime] [datetimeoffset](0) NULL,
	[ActivityEndDateTime] [datetimeoffset](0) NULL,
	[MovementStartDateKey] [date] NULL,
	[MovementEndDateKey] [date] NULL,
	[MovementStartTime] [time](0) NULL,
	[MovementEndTime] [time](0) NULL,
	[MovementStartDateTime] [datetimeoffset](0) NULL,
	[MovementEndDateTime] [datetimeoffset](0) NULL,
	[NextMovementActivityDetailKey] [bigint] NULL,
	[NextMovementStartDateTime] [datetimeoffset](0) NULL,
	[IsLastMovement] [bit] NULL,
	[StartOdometer] [decimal](19, 4) NULL,
	[EndOdometer] [decimal](19, 4) NULL,
	[StartEngineSeconds] [int] NULL,
	[EndEngineSeconds] [int] NULL,
	[StartGeoLocationKey] [bigint] NULL,
	[EndGeoLocationKey] [bigint] NULL,
	[DistanceTravelled] [decimal](19, 4) NULL,
	[Duration] [int] NULL,
	[DrivingTime] [int] NULL,
	[StandingTime] [int] NULL,
	[DriverKey] [bigint] NULL,
	[VehicleKey] [bigint] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[SpeedTime] [int] NULL,
	[SpeedOccurs] [int] NULL,
	[SpeedScore] [decimal](9, 5) NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[BrakeTime] [int] NULL,
	[BrakeOccurs] [int] NULL,
	[BrakeScore] [decimal](9, 5) NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[AccelTime] [int] NULL,
	[AccelOccurs] [int] NULL,
	[AccelScore] [decimal](9, 5) NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[RPMTIme] [int] NULL,
	[RPMOccurs] [int] NULL,
	[RPMScore] [decimal](9, 5) NULL,
	[OutOfGreenBandTime] [int] NULL,
	[OutOfGreenBandScore] [decimal](9, 5) NULL,
	[ExcessiveIdleTime] [int] NULL,
	[ExcessiveIdleOccurs] [int] NULL,
	[ExcessiveIdleScore] [decimal](9, 5) NULL,
	[IdleTime] [int] NULL,
	[IdleOccurs] [int] NULL,
	[EngineSeconds] [int] NULL,
	[NoGoZoneEntry] [bit] NULL,
	[Passengers] [smallint] NULL,
	[FuelUsedMeasured] [decimal](9, 4) NULL,
	[FuelUsedCalculated] [decimal](9, 4) NULL,
	[FuelUsedHierarchy] [smallint] NULL,
	[NightDuration] [int] NULL,
	[AfterHoursDuration] [int] NULL,
	[TotalCarbonEmission] [float] NULL,
	[TotalCO2Emission] [float] NULL,
	[PulseParameterKey] [int] NULL,
	[PulseValue] [float] NULL,
	[UTCOffsetKey] [int] NULL,
	[RoadSpeedTime] [int] NULL,
	[RoadSpeedOccurs] [int] NULL,
	[RoadSpeedScore] [decimal](9, 5) NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_FACT_ActivitySummary]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_ActivitySummary](
	[Operation] [char](1) NULL,
	[MaxDetailID] [bigint] NULL,
	[VehicleID] [int] NULL,
	[DriverID] [int] NULL,
	[OriginalDriverID] [int] NULL,
	[NextTripStartDateTime] [datetimeoffset](0) NULL,
	[HostID] [bigint] NULL,
	[UnitTripNumber] [bigint] NULL,
	[ActivityStartDateKey] [date] NULL,
	[ActivityEndDateKey] [date] NULL,
	[ActivityStartTime] [time](7) NULL,
	[ActivityEndTime] [time](7) NULL,
	[ActivityStartDateTime] [datetimeoffset](0) NULL,
	[ActivityEndDateTime] [datetimeoffset](0) NULL,
	[VehicleKey] [int] NULL,
	[DriverKey] [int] NULL,
	[OriginalDriverKey] [int] NULL,
	[OriginalDriverSiteKey] [int] NULL,
	[OriginalVehicleSiteKey] [int] NULL,
	[UTCOffsetKey] [int] NULL,
	[TotalFuelUsedMeasured] [decimal](19, 4) NULL,
	[TotalFuelUsedCalculated] [decimal](19, 4) NULL,
	[StartOdometer] [decimal](19, 4) NULL,
	[EndOdometer] [decimal](19, 4) NULL,
	[StartEngineSeconds] [int] NULL,
	[EndEngineSeconds] [int] NULL,
	[StartGeoLocationKey] [bigint] NULL,
	[EndGeoLocationKey] [bigint] NULL,
	[AverageSimpleDriverScore] [decimal](9, 6) NULL,
	[TotalDuration] [int] NULL,
	[TotalDistanceTravelled] [decimal](19, 4) NULL,
	[TotalDrivingTime] [int] NULL,
	[TotalEngineSeconds] [int] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[TotalIdleTime] [int] NULL,
	[TotalPassengers] [smallint] NULL,
	[TotalStandingTime] [int] NULL,
	[TotalNightDuration] [int] NULL,
	[TotalAfterHoursDuration] [int] NULL,
	[TotalCarbonEmission] [float] NULL,
	[TotalCO2Emission] [float] NULL,
	[TripClassificationLookupKey] [int] NULL,
	[TripClassificationHierarchy] [smallint] NULL,
	[IsDutchTaxTripClassification] [bit] NULL,
	[MovementCount] [int] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_FACT_ActivitySummary_NonTrackedChanges]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_ActivitySummary_NonTrackedChanges](
	[TripID] [bigint] NOT NULL,
 CONSTRAINT [PK_STAGE_FACT_ActivitySummary_NonTrackedChanges] PRIMARY KEY CLUSTERED 
(
	[TripID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_FACT_EventDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_EventDetails](
	[Operation] [char](1) NOT NULL,
	[DriverID] [int] NULL,
	[VehicleID] [int] NULL,
	[TrailerUnitID] [int] NULL,
	[EventID] [int] NULL,
	[StartGPSID] [bigint] NULL,
	[EndGPSID] [bigint] NULL,
	[PulseParameterID] [smallint] NULL,
	[HostID] [bigint] NOT NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[TrailerKey] [int] NULL,
	[EventDescriptionKey] [int] NULL,
	[EventTypeLookupKey] [int] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[EventStartDateKey] [date] NULL,
	[EventEndDateKey] [date] NULL,
	[EventStartTime] [time](0) NULL,
	[EventEndTime] [time](0) NULL,
	[EventStartDateTime] [datetimeoffset](0) NULL,
	[EventEndDateTime] [datetimeoffset](0) NULL,
	[StartOdometer] [decimal](19, 4) NULL,
	[EndOdometer] [decimal](19, 4) NULL,
	[EventValue] [float] NULL,
	[StartGeoLocationKey] [bigint] NULL,
	[EndGeoLocationKey] [bigint] NULL,
	[TotalOccurs] [int] NULL,
	[TotalTime] [int] NULL,
	[ParameterKey] [int] NULL,
	[Litres] [decimal](9, 4) NULL,
	[PulseParameterKey] [int] NULL,
	[PulseValue] [float] NULL,
	[UTCOffsetKey] [int] NULL,
	[VideoKey] [bigint] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_FACT_EventDetails_NonTrackedChanges]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_EventDetails_NonTrackedChanges](
	[EventKey] [bigint] NOT NULL,
 CONSTRAINT [PK_STAGE_FACT_EventDetails_NonTrackedChanges] PRIMARY KEY CLUSTERED 
(
	[EventKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_FACT_EventRoadspeedLimits]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_EventRoadspeedLimits](
	[EventKey] [bigint] NOT NULL,
	[SpeedLimit] [decimal](9, 5) NULL,
	[Operation] [char](1) NOT NULL,
 CONSTRAINT [PK_STAGE_FACT_EventRoadspeedLimits] PRIMARY KEY CLUSTERED 
(
	[EventKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_FACT_EventRoadspeedLimitsScores]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_EventRoadspeedLimitsScores](
	[TripID] [bigint] NOT NULL,
	[HostID] [int] NOT NULL,
	[RoadSpeedOccurs] [int] NULL,
	[RoadSpeedTime] [int] NULL,
	[SeverityScore] [decimal](9, 5) NULL,
	[DurationScore] [decimal](9, 5) NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_FACT_EventSummary]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_EventSummary](
	[VehicleSiteKey] [int] NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[TrailerKey] [int] NULL,
	[EventDescriptionKey] [int] NULL,
	[EventStartDateKey] [date] NULL,
	[NumberOfEvents] [int] NULL,
	[MaxEventValue] [float] NULL,
	[MinEventValue] [float] NULL,
	[AvgEventValue] [float] NULL,
	[TotalEventValue] [float] NULL,
	[TotalOccurs] [int] NULL,
	[TotalTime] [int] NULL,
	[TotalLitres] [decimal](19, 4) NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_FACT_FuelCapture]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_FuelCapture](
	[Operation] [char](1) NOT NULL,
	[VehicleID] [int] NULL,
	[BaseCurrency] [nchar](6) NULL,
	[HostID] [bigint] NOT NULL,
	[VehicleKey] [int] NULL,
	[FillDateKey] [date] NULL,
	[FillTime] [time](0) NULL,
	[FillDateTime] [datetimeoffset](0) NULL,
	[PreviousFillDateTime] [datetimeoffset](0) NULL,
	[Litres] [real] NULL,
	[BaseCost] [money] NULL,
	[BaseCurrencyKey] [int] NULL,
	[FillOdometer] [decimal](19, 5) NULL,
	[PreviousFillOdometer] [decimal](19, 5) NULL,
	[EngineSeconds] [int] NULL,
	[PreviousEngineSeconds] [int] NULL,
	[DistanceTravelled] [decimal](19, 5) NULL,
	[FillFuelConsumption] [real] NULL,
	[ActivityDetailKey] [int] NULL,
	[FuelStopGeoLocationKey] [int] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_FACT_PassengerActivities]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_PassengerActivities](
	[Operation] [char](1) NOT NULL,
	[PassengerID] [int] NOT NULL,
	[VehicleID] [int] NOT NULL,
	[HostID] [int] NOT NULL,
	[Odometer] [float] NULL,
	[RankNo] [int] NULL,
	[PassengerKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[ActivitySummaryKey] [bigint] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[IdentifiedDateKey] [date] NULL,
	[IdentifiedTime] [time](0) NULL,
	[IdentifiedDateTime] [datetimeoffset](0) NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_FACT_ProfileDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_ProfileDetails](
	[HostTripID] [int] NULL,
	[HostSequenceID] [smallint] NULL,
	[HostParameterID] [smallint] NULL,
	[VehicleKey] [int] NULL,
	[ParameterKey] [int] NULL,
	[VehicleProfileKey] [int] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[StartDateKey] [date] NULL,
	[StartTime] [time](0) NULL,
	[StartDateTime] [datetimeoffset](0) NULL,
	[EndDateKey] [date] NULL,
	[EndTime] [time](0) NULL,
	[EndDateTime] [datetimeoffset](0) NULL,
	[RangeDuration0] [int] NULL,
	[RangeDuration1] [int] NULL,
	[RangeDuration2] [int] NULL,
	[RangeDuration3] [int] NULL,
	[RangeDuration4] [int] NULL,
	[RangeDuration5] [int] NULL,
	[RangeDuration6] [int] NULL,
	[RangeDuration7] [int] NULL,
	[RangeDuration8] [int] NULL,
	[RangeDuration9] [int] NULL,
	[RangeDuration10] [int] NULL,
	[RangeDuration11] [int] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_FACT_ServiceHistory]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_ServiceHistory](
	[Operation] [char](1) NOT NULL,
	[VehicleID] [int] NULL,
	[BaseCurrency] [nchar](6) NULL,
	[HostID] [int] NULL,
	[VehicleKey] [int] NULL,
	[ServiceDateKey] [date] NULL,
	[ServiceDateTime] [datetimeoffset](0) NULL,
	[Odometer] [real] NULL,
	[EngineSeconds] [int] NULL,
	[Reference] [nvarchar](50) NULL,
	[BaseCost] [money] NULL,
	[BaseCurrencyKey] [int] NULL,
	[Notes] [nvarchar](max) NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_FACT_ShapeVisits]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_ShapeVisits](
	[VisitDateKey] [date] NULL,
	[ShapeKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[DriverKey] [int] NULL,
	[DurationAtLocation] [int] NULL,
	[NumberOfVisits] [int] NULL,
	[NumberOfUniqueVisits] [int] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_FACT_SimpleScoreDaily]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_SimpleScoreDaily](
	[SnapShotDateKey] [date] NOT NULL,
	[DriverKey] [int] NULL,
	[VehicleKey] [int] NULL,
	[DistanceTravelled] [decimal](19, 4) NULL,
	[DrivingTime] [int] NULL,
	[Duration] [int] NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[SpeedTime] [int] NULL,
	[SpeedOccurs] [int] NULL,
	[SpeedScoreByDuration] [decimal](19, 5) NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[BrakeTime] [int] NULL,
	[BrakeOccurs] [int] NULL,
	[BrakeScoreByDuration] [decimal](19, 5) NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[AccelTime] [int] NULL,
	[AccelOccurs] [int] NULL,
	[AccelScoreByDuration] [decimal](19, 5) NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[RPMTime] [int] NULL,
	[RPMOccurs] [int] NULL,
	[RPMScoreByDuration] [decimal](19, 5) NULL,
	[OutOfGreenBandTime] [int] NULL,
	[OutOfGreenBandScoreByDuration] [decimal](19, 5) NULL,
	[ExcessiveIdleOccurs] [int] NULL,
	[ExcessiveIdleTime] [int] NULL,
	[ExcessiveIdleScoreByDuration] [decimal](19, 5) NULL,
	[RoadSpeedTime] [int] NULL,
	[RoadSpeedOccurs] [int] NULL,
	[RoadSpeedScoreByDuration] [decimal](19, 5) NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_FACT_SimpleScoreDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_SimpleScoreDetails](
	[Operation] [char](1) NULL,
	[TripID] [int] NULL,
	[ActivitySummaryKey] [bigint] NULL,
	[HostID] [int] NULL,
	[ActivityDetailKey] [bigint] NULL,
	[VehicleKey] [int] NULL,
	[DriverKey] [int] NULL,
	[ActivityStartDateKey] [date] NULL,
	[SpeedScoreCiteriaKey] [int] NULL,
	[BrakeScoreCiteriaKey] [int] NULL,
	[AccelScoreCiteriaKey] [int] NULL,
	[RPMScoreCiteriaKey] [int] NULL,
	[OutOfGreenbandScoreCiteriaKey] [int] NULL,
	[ExcessiveIdleScoreCiteriaKey] [int] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_FACT_SiteSnapshotDaily]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_SiteSnapshotDaily](
	[SnapShotDateKey] [date] NOT NULL,
	[VehicleSiteKey] [int] NULL,
	[VehiclesWithTrips] [smallint] NULL,
	[DriversWithTrips] [smallint] NULL,
	[NumberOfTrips] [int] NULL,
	[NumberOfCollisions] [int] NULL,
	[NumberOfKMs] [decimal](19, 4) NULL,
	[NumberOfHours] [int] NULL,
	[FuelUsedMeasured] [decimal](9, 4) NULL,
	[FuelUsedCalculated] [decimal](9, 4) NULL,
	[TotalIdlingTime] [int] NULL,
	[NumberOfActiveVehicles] [int] NULL,
	[NumberOfActiveDrivers] [int] NULL,
	[VehicleUtilization] [int] NULL,
	[DriverUtilization] [int] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_FACT_TachoData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_TachoData](
	[Operation] [char](1) NOT NULL,
	[VehicleID] [int] NOT NULL,
	[HostID] [bigint] NULL,
	[BlockSequence] [int] NOT NULL,
	[VehicleKey] [int] NULL,
	[TachoStartDateKey] [date] NULL,
	[TachoEndDateKey] [date] NULL,
	[TachoStartDateTime] [datetimeoffset](0) NULL,
	[TachoEndDateTime] [datetimeoffset](0) NULL,
	[RawData] [binary](1024) NULL,
	[MaxSpeed] [int] NULL,
	[MinSpeed] [int] NULL,
	[AvgSpeed] [int] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_FACT_TachoData_NonTrackedChanges]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_TachoData_NonTrackedChanges](
	[RID] [bigint] NOT NULL,
 CONSTRAINT [PK_STAGE_FACT_TachoData_NonTrackedChanges] PRIMARY KEY CLUSTERED 
(
	[RID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_FACT_TerminalDetails]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_TerminalDetails](
	[Operation] [char](1) NOT NULL,
	[VehicleID] [int] NULL,
	[HostID] [bigint] NOT NULL,
	[VehicleKey] [int] NULL,
	[DriverKey] [int] NULL,
	[TerminalDateKey] [date] NULL,
	[TerminalTime] [time](0) NULL,
	[TerminalDateTime] [datetimeoffset](0) NULL,
	[Odometer] [decimal](19, 4) NULL,
	[MenuID] [char](5) NULL,
	[MenuItemCode] [char](5) NULL,
	[ValueType] [tinyint] NULL,
	[NumberValue] [float] NULL,
	[StringValue] [nvarchar](255) NULL,
	[ActivityDetailKey] [bigint] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_FACT_TerminalDetails_NonTrackedChanges]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_TerminalDetails_NonTrackedChanges](
	[EventKey] [bigint] NOT NULL,
 CONSTRAINT [PK_STAGE_FACT_TerminalDetails_NonTrackedChanges] PRIMARY KEY CLUSTERED 
(
	[EventKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[STAGE_FACT_VehicleCosts]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_FACT_VehicleCosts](
	[Operation] [char](1) NULL,
	[VehicleID] [int] NULL,
	[CategoryID] [int] NULL,
	[BaseCurrency] [nvarchar](5) NULL,
	[HostID] [nvarchar](50) NULL,
	[CostDateKey] [date] NULL,
	[IsRecurring] [int] NULL,
	[VehicleKey] [int] NULL,
	[OdometerReading] [decimal](19, 4) NULL,
	[CostCategoryKey] [int] NULL,
	[BaseCost] [money] NULL,
	[BaseCurrencyKey] [int] NULL,
	[UTCOffsetKey] [int] NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_VehicleDeviceProperties]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_VehicleDeviceProperties](
	[VehicleHostID] [smallint] NOT NULL,
	[DeviceHostID] [int] NOT NULL,
	[PropertyName] [nvarchar](50) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[PropertyValue] [nvarchar](2000) NULL,
 CONSTRAINT [PK_STAGE_VehicleDeviceProperties] PRIMARY KEY CLUSTERED 
(
	[VehicleHostID] ASC,
	[DeviceHostID] ASC,
	[PropertyName] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[STAGE_VehicleTriggers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[STAGE_VehicleTriggers](
	[VehicleHostID] [int] NOT NULL,
	[EventHostID] [smallint] NOT NULL,
	[TriggerID] [tinyint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[Sequence] [tinyint] NULL,
	[ParameterKey] [int] NULL,
	[Operator] [tinyint] NULL,
	[ThresholdValue] [float] NULL,
	[Required] [bit] NULL,
	[JoinOperator] [tinyint] NULL,
 CONSTRAINT [PK_STAGE_VehicleTriggers] PRIMARY KEY CLUSTERED 
(
	[VehicleHostID] ASC,
	[EventHostID] ASC,
	[TriggerID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[SubTripData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[SubTripData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[TripID] [int] NOT NULL,
	[Sequence] [smallint] NOT NULL,
	[Depart] [datetime] NULL,
	[Halt] [datetime] NULL,
	[StandingTime] [int] NULL,
	[TripDistance] [decimal](19, 5) NULL,
	[Odometer] [decimal](19, 5) NULL,
	[MaxSpeed] [decimal](9, 5) NULL,
	[SpeedTime] [int] NULL,
	[SpeedOccurs] [int] NULL,
	[SpeedScore] [decimal](9, 6) NULL,
	[MaxBrake] [decimal](9, 5) NULL,
	[BrakeTime] [int] NULL,
	[BrakeOccurs] [int] NULL,
	[BrakeScore] [decimal](9, 6) NULL,
	[MaxAccel] [decimal](9, 5) NULL,
	[AccelTime] [int] NULL,
	[AccelOccurs] [int] NULL,
	[AccelScore] [decimal](9, 6) NULL,
	[MaxRPM] [decimal](9, 4) NULL,
	[RPMTime] [int] NULL,
	[RPMOccurs] [int] NULL,
	[RPMScore] [decimal](9, 6) NULL,
	[GBTime] [int] NULL,
	[GBScore] [decimal](9, 6) NULL,
	[ExIdleTime] [int] NULL,
	[ExIdleOccurs] [int] NULL,
	[ExIdleScore] [decimal](9, 6) NULL,
	[NIdleTime] [int] NULL,
	[NIdleOccurs] [int] NULL,
	[Litres] [decimal](9, 4) NULL,
	[PulseParameterID] [smallint] NULL,
	[PulseValue] [float] NULL,
	[StartGPSID] [int] NULL,
	[EndGPSID] [int] NULL,
	[StartEngineSeconds] [int] NULL,
	[EndEngineSeconds] [int] NULL,
	[RoadSpeedTime] [int] NULL,
	[RoadSpeedOccurs] [int] NULL,
	[RoadSpeedScore] [decimal](9, 5) NULL,
 CONSTRAINT [PK_SubTripData] PRIMARY KEY CLUSTERED 
(
	[TripID] ASC,
	[Sequence] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[TachoData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[TachoData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[RID] [int] NULL,
	[VehicleID] [smallint] NOT NULL,
	[BlockSequence] [int] NOT NULL,
	[StartDate] [datetime] NULL,
	[EndDate] [datetime] NULL,
	[RawData] [binary](1024) NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[TaxTripClassification]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[TaxTripClassification](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liRID] [int] NULL,
	[liTripID] [int] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liSiteID] [int] NOT NULL,
	[liStartLocationID] [int] NULL,
	[liEndLocationID] [int] NULL,
	[fStartLocationLong] [real] NULL,
	[fStartLocationLat] [real] NULL,
	[fEndLocationLong] [real] NULL,
	[fEndLocationLat] [real] NULL,
	[liTripContactID] [int] NULL,
	[sTripClassification] [nvarchar](200) NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[TerminalData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[TerminalData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[EventKey] [int] NOT NULL,
	[VehicleID] [smallint] NULL,
	[BlockSequence] [int] NULL,
	[DriverID] [smallint] NULL,
	[OriginalDriverID] [smallint] NULL,
	[EventDate] [datetime] NULL,
	[Odometer] [decimal](19, 5) NULL,
	[MenuID] [nvarchar](5) NULL,
	[MenuItemCode] [nvarchar](5) NULL,
	[ValueType] [tinyint] NULL,
	[NumberValue] [float] NULL,
	[StringValue] [nvarchar](240) NULL,
 CONSTRAINT [PK_tbTerminalData] PRIMARY KEY CLUSTERED 
(
	[EventKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[Trailers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[Trailers](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[TrailerGUID] [uniqueidentifier] NOT NULL,
	[liTrailerID] [int] NOT NULL,
	[sDescription] [nvarchar](255) NOT NULL,
	[sRegNo] [nvarchar](15) NOT NULL,
	[sAssetNumber] [nvarchar](255) NULL,
	[fSetOdometer] [real] NULL,
	[dtOdometerChanged] [datetime] NULL,
	[dtPrevService] [datetime] NULL,
	[dtNextService] [datetime] NULL,
	[iServIntTime] [smallint] NULL,
	[fPrevService] [real] NULL,
	[fNextService] [real] NULL,
	[fServIntDistance] [real] NULL,
 CONSTRAINT [PK_Trailers] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[liTrailerID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[TrailerUnitIDs]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[TrailerUnitIDs](
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[OrganisationKey] [int] NOT NULL,
	[liUnitID] [int] NOT NULL,
	[liTrailerID] [int] NOT NULL,
	[dtAttached] [datetime] NOT NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[TripData]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[TripData](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[TripID] [int] NOT NULL,
	[VehicleID] [smallint] NULL,
	[TripNumber] [int] NULL,
	[DriverID] [smallint] NULL,
	[OriginalDriverID] [smallint] NULL,
	[TripStart] [datetime] NULL,
	[TripEnd] [datetime] NULL,
 CONSTRAINT [PK_TripData] PRIMARY KEY CLUSTERED 
(
	[TripID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[UnitTypes]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[UnitTypes](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[ucUnitType] [tinyint] NOT NULL,
	[ucSelectionSort] [tinyint] NULL,
	[sDescription] [nvarchar](50) NULL,
	[bIsConfigUnit] [bit] NULL,
 CONSTRAINT [PK_UnitTypes] PRIMARY KEY CLUSTERED 
(
	[ucUnitType] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[VehicleConfig]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[VehicleConfig](
	[liGroupID] [int] NOT NULL,
	[sName] [nvarchar](255) NOT NULL,
	[sNote] [nvarchar](max) NULL,
	[GroupGUID] [uniqueidentifier] NOT NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[VehicleDeviceParam]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[VehicleDeviceParam](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[lfCalibration1] [float] NULL,
	[lfValue1] [float] NULL,
	[lfCalibration2] [float] NULL,
	[lfValue2] [float] NULL,
	[sUserName] [nvarchar](100) NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[VehicleDeviceProperties]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[VehicleDeviceProperties](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[sProperty] [nvarchar](50) NOT NULL,
	[sValue] [nvarchar](2000) NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleDeviceProperties] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iVehicleID] ASC,
	[liDeviceID] ASC,
	[sProperty] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[VehicleDevices]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[VehicleDevices](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liDeviceID] [int] NOT NULL,
	[sInputID] [char](2) NULL,
	[bIsActive] [bit] NULL,
	[bRecordInterval] [bit] NULL,
	[liPowerDeviceID] [int] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleDevices] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iVehicleID] ASC,
	[liDeviceID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[VehicleEvent]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[VehicleEvent](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucEventType] [tinyint] NOT NULL,
	[bInUse] [bit] NOT NULL,
	[bStartOdo] [bit] NOT NULL,
	[bStartPosition] [bit] NOT NULL,
	[bEndOdo] [bit] NOT NULL,
	[bEndPosition] [bit] NOT NULL,
	[bRecordF3Count] [bit] NOT NULL,
	[bWarningMessage] [bit] NOT NULL,
	[bActivePosition] [bit] NOT NULL,
	[iRecordTime] [smallint] NOT NULL,
	[iAlarmTime] [smallint] NOT NULL,
	[iRelayTime] [smallint] NOT NULL,
	[iRelay2Time] [smallint] NOT NULL,
	[iCriticalTime] [smallint] NULL,
	[iActiveTime] [smallint] NOT NULL,
	[iActiveEndTime] [smallint] NOT NULL,
	[iTrackTime] [smallint] NOT NULL,
	[iTrackInterval] [smallint] NOT NULL,
	[ucAlarmState] [tinyint] NOT NULL,
	[ucRelayState] [tinyint] NOT NULL,
	[ucRelay2State] [tinyint] NOT NULL,
	[sWarningMessage] [nvarchar](255) NULL,
	[ucPriority] [tinyint] NOT NULL,
	[dtLastEventNotification] [datetime] NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleEvent] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iVehicleID] ASC,
	[iEventID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[VehicleProfile]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[VehicleProfile](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[iParameterID] [smallint] NOT NULL,
	[ucSeq] [smallint] NOT NULL,
	[lfValue] [float] NULL,
	[sUserName] [nvarchar](100) NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[VehicleReporting]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [StageUser1].[VehicleReporting](
	[liGroupID] [int] NOT NULL,
	[GroupGUID] [uniqueidentifier] NOT NULL,
	[sName] [nvarchar](510) NOT NULL,
	[sNote] [nvarchar](max) NULL
) ON [StageUser1FG] TEXTIMAGE_ON [StageUser1FG]

GO
/****** Object:  Table [StageUser1].[VehicleReportingGroups]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[VehicleReportingGroups](
	[ChangeTrackVersion] [bigint] NOT NULL,
	[Operation] [char](1) NOT NULL,
	[liGroupID] [int] NOT NULL,
	[iVehicleID] [int] NOT NULL
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[Vehicles]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[Vehicles](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [bigint] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[VehicleGUID] [uniqueidentifier] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[liSiteID] [int] NULL,
	[liGroupID] [int] NULL,
	[sDesc] [nvarchar](255) NULL,
	[sRegNo] [nvarchar](15) NULL,
	[ucUnitType] [tinyint] NULL,
	[liLastServiceKey] [int] NULL,
	[fNextServiceKm] [real] NULL,
	[fServiceKm] [real] NULL,
	[fRemindKm] [real] NULL,
	[dtNextServiceDate] [datetime] NULL,
	[ucServiceMonths] [tinyint] NULL,
	[ucRemindWeeks] [tinyint] NULL,
	[liNextServiceSeconds] [int] NULL,
	[liServiceSeconds] [int] NULL,
	[liRemindSeconds] [int] NULL,
	[dtLastLicense] [datetime] NULL,
	[dtNextLicense] [datetime] NULL,
	[ucLicenseInterval] [tinyint] NULL,
	[ucLicenseRemind] [tinyint] NULL,
	[dtLastCOR] [datetime] NULL,
	[dtNextCOR] [datetime] NULL,
	[ucCORInterval] [tinyint] NULL,
	[ucCORRemind] [tinyint] NULL,
	[bServiceKm] [bit] NULL,
	[bServiceDate] [bit] NULL,
	[bServiceHours] [bit] NULL,
	[bLicense] [bit] NULL,
	[bCOR] [bit] NULL,
	[bActive] [bit] NULL,
	[sActiveReason] [nvarchar](500) NULL,
	[ucActiveState] [tinyint] NULL,
	[iDefaultDriver] [smallint] NULL,
	[fTargetConsumption] [real] NULL,
	[fTargetHourlyConsumption] [real] NULL,
 CONSTRAINT [PK_Vehicles] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iVehicleID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Table [StageUser1].[VehicleTriggers]    Script Date: 2012/12/02 02:27:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [StageUser1].[VehicleTriggers](
	[OrganisationKey] [int] NOT NULL,
	[RID] [int] NOT NULL,
	[ChangeDate] [datetimeoffset](0) NOT NULL,
	[Operation] [char](1) NOT NULL,
	[UpdateMask] [int] NOT NULL,
	[ChangeVersion] [bigint] NOT NULL,
	[iVehicleID] [smallint] NOT NULL,
	[iEventID] [smallint] NOT NULL,
	[ucTriggerID] [tinyint] NOT NULL,
	[lfValue] [float] NOT NULL,
	[sUserName] [nvarchar](100) NULL,
 CONSTRAINT [PK_VehicleTriggers] PRIMARY KEY CLUSTERED 
(
	[RID] ASC,
	[iVehicleID] ASC,
	[iEventID] ASC,
	[ucTriggerID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
) ON [StageUser1FG]

GO
SET ANSI_PADDING ON
GO
/****** Object:  Index [PK_STAGE_FACT_ActivityChanges]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE CLUSTERED INDEX [PK_STAGE_FACT_ActivityChanges] ON [StageUser1].[STAGE_FACT_ActivityChanges]
(
	[TripID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_STAGE_FACT_EventDetails_HostID_EventStartDateKey_Operation]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE CLUSTERED INDEX [IX_STAGE_FACT_EventDetails_HostID_EventStartDateKey_Operation] ON [StageUser1].[STAGE_FACT_EventDetails]
(
	[HostID] ASC,
	[EventStartDateKey] ASC,
	[Operation] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_DeviceParam_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_DeviceParam_CT_OrganisationKey_HostRID] ON [audit].[DeviceParam_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_Devices_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_Devices_CT_OrganisationKey_HostRID] ON [audit].[Devices_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_DriverCertifications_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_DriverCertifications_CT_OrganisationKey_HostRID] ON [audit].[DriverCertifications_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_DriverLicences_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_DriverLicences_CT_OrganisationKey_HostRID] ON [audit].[DriverLicences_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_Drivers_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_Drivers_CT_OrganisationKey_HostRID] ON [audit].[Drivers_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_EventDescription_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_EventDescription_CT_OrganisationKey_HostRID] ON [audit].[EventDescription_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_EventTriggers_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_EventTriggers_CT_OrganisationKey_HostRID] ON [audit].[EventTriggers_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_GroupTriggers_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_GroupTriggers_CT_OrganisationKey_HostRID] ON [audit].[GroupTriggers_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_Organisation_CT_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_Organisation_CT_HostRID] ON [audit].[Organisation_CT]
(
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_OrgOptions_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_OrgOptions_CT_OrganisationKey_HostRID] ON [audit].[OrgOptions_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_Param_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_Param_CT_OrganisationKey_HostRID] ON [audit].[Param_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_Passengers_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_Passengers_CT_OrganisationKey_HostRID] ON [audit].[Passengers_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_ScoredEvents_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ScoredEvents_CT_OrganisationKey_HostRID] ON [audit].[ScoredEvents_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_Sites_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_Sites_CT_OrganisationKey_HostRID] ON [audit].[Sites_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_Trailers_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_Trailers_CT_OrganisationKey_HostRID] ON [audit].[Trailers_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_TrailerUnitIDs_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_TrailerUnitIDs_CT_OrganisationKey_HostRID] ON [audit].[TrailerUnitIDs_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_VehicleDeviceParam_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_VehicleDeviceParam_CT_OrganisationKey_HostRID] ON [audit].[VehicleDeviceParam_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_VehicleDeviceParam_CT_OrganisationKey_iVehicleID_ChangeDate_HostRID_liDeviceID_iParameterID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_VehicleDeviceParam_CT_OrganisationKey_iVehicleID_ChangeDate_HostRID_liDeviceID_iParameterID] ON [audit].[VehicleDeviceParam_CT]
(
	[OrganisationKey] ASC,
	[iVehicleID] ASC,
	[ChangeDate] ASC,
	[HostRID] ASC,
	[liDeviceID] ASC,
	[iParameterID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_VehicleDeviceProperties_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_VehicleDeviceProperties_CT_OrganisationKey_HostRID] ON [audit].[VehicleDeviceProperties_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_VehicleDeviceProperties_CT_OrganisationKey_iVehicleID_ChangeDate_HostRID_liDeviceID_sProperty]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_VehicleDeviceProperties_CT_OrganisationKey_iVehicleID_ChangeDate_HostRID_liDeviceID_sProperty] ON [audit].[VehicleDeviceProperties_CT]
(
	[OrganisationKey] ASC,
	[iVehicleID] ASC,
	[ChangeDate] ASC,
	[HostRID] ASC,
	[liDeviceID] ASC,
	[sProperty] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_VehicleDevices_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_VehicleDevices_CT_OrganisationKey_HostRID] ON [audit].[VehicleDevices_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_VehicleEvent_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_VehicleEvent_CT_OrganisationKey_HostRID] ON [audit].[VehicleEvent_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_VehicleEvent_CT_OrganisationKey_iVehicleID_ChangeDate_HostRID_iEventID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_VehicleEvent_CT_OrganisationKey_iVehicleID_ChangeDate_HostRID_iEventID] ON [audit].[VehicleEvent_CT]
(
	[OrganisationKey] ASC,
	[iVehicleID] ASC,
	[ChangeDate] ASC,
	[HostRID] ASC,
	[iEventID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_VehicleProfile_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_VehicleProfile_CT_OrganisationKey_HostRID] ON [audit].[VehicleProfile_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_Vehicles_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_Vehicles_CT_OrganisationKey_HostRID] ON [audit].[Vehicles_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_VehicleTriggers_CT_OrganisationKey_HostRID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_VehicleTriggers_CT_OrganisationKey_HostRID] ON [audit].[VehicleTriggers_CT]
(
	[OrganisationKey] ASC,
	[HostRID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [auditFG]
GO
/****** Object:  Index [IX_DIM_Steps_TaskKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_DIM_Steps_TaskKey] ON [Control].[DIM_Steps]
(
	[TaskKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
GO
/****** Object:  Index [IX_DriverAppCache_ScheduleDateTime]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_DriverAppCache_ScheduleDateTime] ON [Control].[DriverAppCache]
(
	[ScheduleDateTime] ASC
)
INCLUDE ( 	[OrganisationID],
	[NumberOfAttempts]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
GO
/****** Object:  Index [IX_FACT_TaskPerformance_BatchKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_FACT_TaskPerformance_BatchKey] ON [Control].[FACT_TaskPerformance]
(
	[BatchKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
GO
/****** Object:  Index [IX_FACT_TaskPerformance_StartDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_FACT_TaskPerformance_StartDateKey] ON [Control].[FACT_TaskPerformance]
(
	[StartDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
GO
/****** Object:  Index [IX_FACT_TaskPerformance_TaskKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_FACT_TaskPerformance_TaskKey] ON [Control].[FACT_TaskPerformance]
(
	[TaskKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_OrganisationController_OrganisationKey_DWActive_bActive_IsFinished_CurrentBatch]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_OrganisationController_OrganisationKey_DWActive_bActive_IsFinished_CurrentBatch] ON [Control].[OrganisationController]
(
	[OrganisationKey] ASC,
	[DWActive] ASC,
	[bActive] ASC,
	[IsFinished] ASC,
	[CurrentBatch] ASC
)
INCLUDE ( 	[CurrentThreaduser]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [ControlFG]
GO
/****** Object:  Index [IX_Organisation_CT_liOrgID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_Organisation_CT_liOrgID] ON [StageControl].[Organisation_CT]
(
	[liOrgID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageControlFG]
GO
/****** Object:  Index [IX_STAGE_FACT_EventSummary_VehicleKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_EventSummary_VehicleKey] ON [StageControl].[STAGE_FACT_EventSummary]
(
	[VehicleKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageControlFG]
GO
/****** Object:  Index [IX_STAGE_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey] ON [StageControl].[STAGE_FACT_ShapeVisits]
(
	[ShapeKey] ASC,
	[VehicleKey] ASC,
	[VisitDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageControlFG]
GO
/****** Object:  Index [IX_STAGE_FACT_SiteSnapshotDaily_VehicleSiteKey_SnapShotDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_SiteSnapshotDaily_VehicleSiteKey_SnapShotDateKey] ON [StageControl].[STAGE_FACT_SiteSnapshotDaily]
(
	[VehicleSiteKey] ASC,
	[SnapShotDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageControlFG]
GO
/****** Object:  Index [IX_GPSData_fLongitude_fLatitude]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_GPSData_fLongitude_fLatitude] ON [StageUser].[GPSData]
(
	[fLongitude] ASC,
	[fLatitude] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
GO
/****** Object:  Index [IX_ROLLBACK_FACT_ActivityDetails_ActivitySummaryKey_HostID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_ActivityDetails_ActivitySummaryKey_HostID] ON [StageUser].[ROLLBACK_FACT_ActivityDetails]
(
	[ActivitySummaryKey] ASC,
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
/****** Object:  Index [IX_STAGE_DIM_GeoLocations_GeoLocationKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_DIM_GeoLocations_GeoLocationKey] ON [StageUser].[STAGE_DIM_GeoLocations]
(
	[GeoLocationKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
GO
/****** Object:  Index [IX_STAGE_DIM_GeoLocations_Longitude_Latitude]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_DIM_GeoLocations_Longitude_Latitude] ON [StageUser].[STAGE_DIM_GeoLocations]
(
	[Longitude] ASC,
	[Latitude] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUserFG]
GO
/****** Object:  Index [IX_STAGE_DIM_UTCOffsetsLookup]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_DIM_UTCOffsetsLookup] ON [StageUser].[STAGE_DIM_UTCOffsetsLookUp]
(
	[StartDateKey] ASC,
	[EndDateKey] ASC,
	[SeasonStartDateTime] ASC,
	[SeasonEndDateTime] ASC
)
INCLUDE ( 	[UTCOffsetKey],
	[UTCOffsetMinutes]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey] ON [StageUser].[STAGE_FACT_ActivityDetails]
(
	[ActivityStartDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Operation]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Operation] ON [StageUser].[STAGE_FACT_ActivityDetails]
(
	[ActivitySummaryKey] ASC,
	[HostID] ASC,
	[Operation] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_EndGPSID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_EndGPSID] ON [StageUser].[STAGE_FACT_ActivityDetails]
(
	[EndGPSID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_StartGPSID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_StartGPSID] ON [StageUser].[STAGE_FACT_ActivityDetails]
(
	[StartGPSID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_TripID_HostID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_TripID_HostID] ON [StageUser].[STAGE_FACT_ActivityDetails]
(
	[TripID] ASC,
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_VehicleKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_VehicleKey] ON [StageUser].[STAGE_FACT_ActivityDetails]
(
	[VehicleKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_VehicleKey_StartOdometer_EndOdometer]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_VehicleKey_StartOdometer_EndOdometer] ON [StageUser].[STAGE_FACT_ActivityDetails]
(
	[VehicleKey] ASC,
	[StartOdometer] ASC,
	[EndOdometer] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivitySummary_ActivityStartDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivitySummary_ActivityStartDateKey] ON [StageUser].[STAGE_FACT_ActivitySummary]
(
	[ActivityStartDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivitySummary_DriverID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivitySummary_DriverID] ON [StageUser].[STAGE_FACT_ActivitySummary]
(
	[DriverID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_STAGE_FACT_ActivitySummary_HostID_Operation]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivitySummary_HostID_Operation] ON [StageUser].[STAGE_FACT_ActivitySummary]
(
	[HostID] ASC,
	[Operation] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivitySummary_VehicleID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivitySummary_VehicleID] ON [StageUser].[STAGE_FACT_ActivitySummary]
(
	[VehicleID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_STAGE_FACT_VehicleCosts_HostID_Operation]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_VehicleCosts_HostID_Operation] ON [StageUser].[STAGE_FACT_VehicleCosts]
(
	[HostID] ASC,
	[Operation] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUserFG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_ExtensionProperties_DIM_sAppID_sProperty_liObjectType]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ExtensionProperties_DIM_sAppID_sProperty_liObjectType] ON [StageUser1].[ExtensionProperties_DIM]
(
	[sAppID] ASC,
	[sProperty] ASC,
	[liObjectType] ASC
)
INCLUDE ( 	[liObjectID],
	[sValue]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_PassengerData_IdentifiedDate]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_PassengerData_IdentifiedDate] ON [StageUser1].[PassengerData]
(
	[IdentifiedDate] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_ROLLBACK_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID] ON [StageUser1].[ROLLBACK_DIM_Certifications]
(
	[HostID] ASC,
	[CertificationTypeLookupKey] ASC,
	[DriverGUID] ASC
)
INCLUDE ( 	[ExpirationDateKey],
	[ObtainedDateKey]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_ROLLBACK_FACT_ActivityDetails_ActivitySummaryKey_HostID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_ActivityDetails_ActivitySummaryKey_HostID] ON [StageUser1].[ROLLBACK_FACT_ActivityDetails]
(
	[ActivitySummaryKey] ASC,
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_ROLLBACK_FACT_ActivitySummary_HostID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_ActivitySummary_HostID] ON [StageUser1].[ROLLBACK_FACT_ActivitySummary]
(
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_ROLLBACK_FACT_EventDetails_HostID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_EventDetails_HostID] ON [StageUser1].[ROLLBACK_FACT_EventDetails]
(
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_ROLLBACK_FACT_FuelCapture_HostID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_FuelCapture_HostID] ON [StageUser1].[ROLLBACK_FACT_FuelCapture]
(
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_ROLLBACK_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID] ON [StageUser1].[ROLLBACK_FACT_ProfileDetails]
(
	[HostTripID] ASC,
	[HostSequenceID] ASC,
	[HostParameterID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_ROLLBACK_FACT_ServiceHistory_HostID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_ServiceHistory_HostID] ON [StageUser1].[ROLLBACK_FACT_ServiceHistory]
(
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_ROLLBACK_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey] ON [StageUser1].[ROLLBACK_FACT_ShapeVisits]
(
	[ShapeKey] ASC,
	[VehicleKey] ASC,
	[VisitDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_ROLLBACK_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey] ON [StageUser1].[ROLLBACK_FACT_SimpleScoreDaily]
(
	[VehicleKey] ASC,
	[DriverKey] ASC,
	[SnapShotDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_ROLLBACK_FACT_SimpleScoreDetails_ActivityDetailKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_SimpleScoreDetails_ActivityDetailKey] ON [StageUser1].[ROLLBACK_FACT_SimpleScoreDetails]
(
	[ActivityDetailKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_ROLLBACK_FACT_SiteSnapshotDaily_SnapShotDateKey_VehicleSiteKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_SiteSnapshotDaily_SnapShotDateKey_VehicleSiteKey] ON [StageUser1].[ROLLBACK_FACT_SiteSnapshotDaily]
(
	[SnapShotDateKey] ASC,
	[VehicleSiteKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_ROLLBACK_FACT_TachoData_HostID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_TachoData_HostID] ON [StageUser1].[ROLLBACK_FACT_TachoData]
(
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_ROLLBACK_FACT_TerminalDetails_HostID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_TerminalDetails_HostID] ON [StageUser1].[ROLLBACK_FACT_TerminalDetails]
(
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_ROLLBACK_FACT_VehicleCosts_HostID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_ROLLBACK_FACT_VehicleCosts_HostID] ON [StageUser1].[ROLLBACK_FACT_VehicleCosts]
(
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_DIM_Certifications_HostID_CertificationTypeLookupKey_DriverGUID] ON [StageUser1].[STAGE_DIM_Certifications]
(
	[HostID] ASC,
	[CertificationTypeLookupKey] ASC,
	[DriverGUID] ASC
)
INCLUDE ( 	[ExpirationDateKey],
	[ObtainedDateKey]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_DIM_GeoLocations_GeoLocationKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_DIM_GeoLocations_GeoLocationKey] ON [StageUser1].[STAGE_DIM_GeoLocations]
(
	[GeoLocationKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_DIM_GeoLocations_Longitude_Latitude]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_DIM_GeoLocations_Longitude_Latitude] ON [StageUser1].[STAGE_DIM_GeoLocations]
(
	[Longitude] ASC,
	[Latitude] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_DIM_UTCOffsetsLookup]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_DIM_UTCOffsetsLookup] ON [StageUser1].[STAGE_DIM_UTCOffsetsLookUp]
(
	[StartDateTime] ASC,
	[EndDateTime] ASC,
	[SeasonStartDateTime] ASC,
	[SeasonEndDateTime] ASC,
	[StartDateKey] ASC,
	[EndDateKey] ASC
)
INCLUDE ( 	[UTCOffsetKey],
	[UTCOffsetMinutes]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_DIM_VehicleEventDefinitions_VehicleGUID_EventDescriptionKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_DIM_VehicleEventDefinitions_VehicleGUID_EventDescriptionKey] ON [StageUser1].[STAGE_DIM_VehicleEventDefinitions]
(
	[VehicleGUID] ASC,
	[EventDescriptionKey] ASC
)
INCLUDE ( 	[VehicleHostID],
	[EventHostID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_DIM_VehicleEventDefinitions_VehicleHostID_EventHostID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_DIM_VehicleEventDefinitions_VehicleHostID_EventHostID] ON [StageUser1].[STAGE_DIM_VehicleEventDefinitions]
(
	[VehicleHostID] ASC,
	[EventHostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey] ON [StageUser1].[STAGE_FACT_ActivityDetails]
(
	[ActivityStartDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey_VehicleKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey_VehicleKey] ON [StageUser1].[STAGE_FACT_ActivityDetails]
(
	[ActivityStartDateKey] ASC,
	[VehicleKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey_VehicleSiteKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_ActivityStartDateKey_VehicleSiteKey] ON [StageUser1].[STAGE_FACT_ActivityDetails]
(
	[ActivityStartDateKey] ASC,
	[VehicleSiteKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_ActivityStartDateTime_ActivityEndDateTime]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_ActivityStartDateTime_ActivityEndDateTime] ON [StageUser1].[STAGE_FACT_ActivityDetails]
(
	[VehicleID] ASC,
	[ActivityStartDateTime] ASC,
	[ActivityEndDateTime] ASC
)
INCLUDE ( 	[ActivityDetailKey]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Operation]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_ActivitySummaryKey_HostID_Operation] ON [StageUser1].[STAGE_FACT_ActivityDetails]
(
	[ActivitySummaryKey] ASC,
	[HostID] ASC,
	[Operation] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_EndGPSID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_EndGPSID] ON [StageUser1].[STAGE_FACT_ActivityDetails]
(
	[EndGPSID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_StartGPSID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_StartGPSID] ON [StageUser1].[STAGE_FACT_ActivityDetails]
(
	[StartGPSID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_TripID_HostID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_TripID_HostID] ON [StageUser1].[STAGE_FACT_ActivityDetails]
(
	[TripID] ASC,
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_VehicleID_ActivityStartDateTime]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_VehicleID_ActivityStartDateTime] ON [StageUser1].[STAGE_FACT_ActivityDetails]
(
	[VehicleID] ASC,
	[ActivityStartDateTime] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_VehicleKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_VehicleKey] ON [StageUser1].[STAGE_FACT_ActivityDetails]
(
	[VehicleKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivityDetails_VehicleKey_StartOdometer_EndOdometer]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivityDetails_VehicleKey_StartOdometer_EndOdometer] ON [StageUser1].[STAGE_FACT_ActivityDetails]
(
	[VehicleKey] ASC,
	[StartOdometer] ASC,
	[EndOdometer] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivitySummary_ActivityStartDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivitySummary_ActivityStartDateKey] ON [StageUser1].[STAGE_FACT_ActivitySummary]
(
	[ActivityStartDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivitySummary_DriverID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivitySummary_DriverID] ON [StageUser1].[STAGE_FACT_ActivitySummary]
(
	[DriverID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivitySummary_DriverID_ActivityStartDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivitySummary_DriverID_ActivityStartDateKey] ON [StageUser1].[STAGE_FACT_ActivitySummary]
(
	[DriverID] ASC,
	[ActivityStartDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_STAGE_FACT_ActivitySummary_HostID_Operation]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivitySummary_HostID_Operation] ON [StageUser1].[STAGE_FACT_ActivitySummary]
(
	[HostID] ASC,
	[Operation] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivitySummary_VehicleID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivitySummary_VehicleID] ON [StageUser1].[STAGE_FACT_ActivitySummary]
(
	[VehicleID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateKey] ON [StageUser1].[STAGE_FACT_ActivitySummary]
(
	[VehicleID] ASC,
	[ActivityStartDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_ActivityEndDateTime]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_ActivityEndDateTime] ON [StageUser1].[STAGE_FACT_ActivitySummary]
(
	[VehicleID] ASC,
	[ActivityStartDateTime] ASC,
	[ActivityEndDateTime] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_HostID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_HostID] ON [StageUser1].[STAGE_FACT_ActivitySummary]
(
	[VehicleID] ASC,
	[ActivityStartDateTime] ASC,
	[HostID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_NextTripStartDateTime]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ActivitySummary_VehicleID_ActivityStartDateTime_NextTripStartDateTime] ON [StageUser1].[STAGE_FACT_ActivitySummary]
(
	[VehicleID] ASC,
	[ActivityStartDateTime] ASC,
	[NextTripStartDateTime] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_STAGE_FACT_EventDetails_HostID_Operation]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_EventDetails_HostID_Operation] ON [StageUser1].[STAGE_FACT_EventDetails]
(
	[HostID] ASC,
	[Operation] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_FuelCapture_VehicleID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_FuelCapture_VehicleID] ON [StageUser1].[STAGE_FACT_FuelCapture]
(
	[VehicleID] ASC
)
INCLUDE ( 	[FillOdometer],
	[FillDateTime],
	[EngineSeconds]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_STAGE_FACT_PassengerActivities_HostID_Operation]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_PassengerActivities_HostID_Operation] ON [StageUser1].[STAGE_FACT_PassengerActivities]
(
	[HostID] ASC,
	[Operation] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_PassengerActivities_IdentifiedDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_PassengerActivities_IdentifiedDateKey] ON [StageUser1].[STAGE_FACT_PassengerActivities]
(
	[IdentifiedDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_PassengerActivities_PassengerID_IdentifiedDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_PassengerActivities_PassengerID_IdentifiedDateKey] ON [StageUser1].[STAGE_FACT_PassengerActivities]
(
	[PassengerID] ASC,
	[IdentifiedDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_PassengerActivities_VehicleID_IdentifiedDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_PassengerActivities_VehicleID_IdentifiedDateKey] ON [StageUser1].[STAGE_FACT_PassengerActivities]
(
	[VehicleID] ASC,
	[IdentifiedDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ProfileDetails_HostTripID_HostSequenceID_HostParameterID] ON [StageUser1].[STAGE_FACT_ProfileDetails]
(
	[HostTripID] ASC,
	[HostSequenceID] ASC,
	[HostParameterID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_ShapeVisits_ShapeKey_VehicleKey_VisitDateKey] ON [StageUser1].[STAGE_FACT_ShapeVisits]
(
	[ShapeKey] ASC,
	[VehicleKey] ASC,
	[VisitDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_SimpleScoreDaily_VehicleKey_DriverKey_SnapShotDateKey] ON [StageUser1].[STAGE_FACT_SimpleScoreDaily]
(
	[VehicleKey] ASC,
	[DriverKey] ASC,
	[SnapShotDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_SimpleScoreDetails_ActivityDetailKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_SimpleScoreDetails_ActivityDetailKey] ON [StageUser1].[STAGE_FACT_SimpleScoreDetails]
(
	[ActivityDetailKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_SimpleScoreDetails_ActivityStartDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_SimpleScoreDetails_ActivityStartDateKey] ON [StageUser1].[STAGE_FACT_SimpleScoreDetails]
(
	[ActivityStartDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_STAGE_FACT_SimpleScoreDetails_ActivitySummaryKey_HostID_Operation]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_SimpleScoreDetails_ActivitySummaryKey_HostID_Operation] ON [StageUser1].[STAGE_FACT_SimpleScoreDetails]
(
	[ActivitySummaryKey] ASC,
	[HostID] ASC,
	[Operation] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_SiteSnapshotDaily_VehicleSiteKey_SnapShotDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_SiteSnapshotDaily_VehicleSiteKey_SnapShotDateKey] ON [StageUser1].[STAGE_FACT_SiteSnapshotDaily]
(
	[VehicleSiteKey] ASC,
	[SnapShotDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_STAGE_FACT_TachoData_HostID_Operation]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_TachoData_HostID_Operation] ON [StageUser1].[STAGE_FACT_TachoData]
(
	[HostID] ASC,
	[Operation] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_TachoData_VehicleID_TachoStartDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_TachoData_VehicleID_TachoStartDateKey] ON [StageUser1].[STAGE_FACT_TachoData]
(
	[VehicleID] ASC,
	[TachoStartDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_STAGE_FACT_TerminalDetails_HostID_Operation]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_TerminalDetails_HostID_Operation] ON [StageUser1].[STAGE_FACT_TerminalDetails]
(
	[HostID] ASC,
	[Operation] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
/****** Object:  Index [IX_STAGE_FACT_TerminalDetails_VehicleID_TerminalDateTime_TerminalDateKey]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_TerminalDetails_VehicleID_TerminalDateTime_TerminalDateKey] ON [StageUser1].[STAGE_FACT_TerminalDetails]
(
	[VehicleID] ASC,
	[TerminalDateTime] ASC,
	[TerminalDateKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
SET ANSI_PADDING ON

GO
/****** Object:  Index [IX_STAGE_FACT_VehicleCosts_HostID_Operation]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE NONCLUSTERED INDEX [IX_STAGE_FACT_VehicleCosts_HostID_Operation] ON [StageUser1].[STAGE_FACT_VehicleCosts]
(
	[HostID] ASC,
	[Operation] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
ALTER TABLE [Control].[ErrorLog] ADD  CONSTRAINT [DF_ErrorLog_ErrorTime]  DEFAULT (sysutcdatetime()) FOR [ErrorTime]
GO
ALTER TABLE [Control].[OrganisationController] ADD  CONSTRAINT [DF_OrganisationController_IsFinished]  DEFAULT ((0)) FOR [IsFinished]
GO
ALTER TABLE [Control].[OrganisationController] ADD  DEFAULT ((0)) FOR [DWActive]
GO
ALTER TABLE [Control].[OrganisationController] ADD  DEFAULT ((0)) FOR [IsRemoved]
GO
ALTER TABLE [Control].[OrganisationController] ADD  DEFAULT ((0)) FOR [NumberOfExtractAttempts]
GO
ALTER TABLE [Control].[OrganisationController] ADD  DEFAULT ((1)) FOR [RestrictTracerFlag]
GO
ALTER TABLE [Control].[OrganisationController] ADD  DEFAULT ((0)) FOR [SiteGroupFlag]
GO
ALTER TABLE [Control].[OrganisationController] ADD  DEFAULT ((0)) FOR [UTCOffsetPriority]
GO
ALTER TABLE [Control].[OrganisationController] ADD  DEFAULT ((86400)) FOR [ProcessIntervalInSec]
GO
ALTER TABLE [Control].[OrganisationControllerHistory] ADD  CONSTRAINT [DF_OrganisationControllerHistory_ChangeDate]  DEFAULT (sysutcdatetime()) FOR [ChangeDate]
GO
ALTER TABLE [Control].[OrganisationControllerHistory] ADD  DEFAULT ((0)) FOR [DWActive]
GO
ALTER TABLE [Control].[OrganisationControllerHistory] ADD  DEFAULT ((0)) FOR [IsRemoved]
GO
ALTER TABLE [Control].[OrganisationControllerHistory] ADD  DEFAULT ((0)) FOR [NumberOfExtractAttempts]
GO
ALTER TABLE [Control].[OrganisationControllerHistory] ADD  DEFAULT ((1)) FOR [RestrictTracerFlag]
GO
ALTER TABLE [Control].[OrganisationControllerHistory] ADD  DEFAULT ((0)) FOR [SiteGroupFlag]
GO
ALTER TABLE [Control].[OrganisationTableControllerHistory] ADD  CONSTRAINT [DF_OrganisationTableControllerHistory_ChangeDate]  DEFAULT (sysutcdatetime()) FOR [ChangeDate]
GO
ALTER TABLE [Control].[RollbackTableList] ADD  DEFAULT ((0)) FOR [HasOrganisationKeyFlag]
GO
ALTER TABLE [Control].[RollbackTableList] ADD  DEFAULT ((0)) FOR [IsSummaryTableFlag]
GO
ALTER TABLE [Control].[RollbackTableList] ADD  DEFAULT ((0)) FOR [Processed]
GO
ALTER TABLE [StageControl].[STAGE_FACT_EventSummary_Processed] ADD  DEFAULT ((0)) FOR [Processed]
GO
ALTER TABLE [StageControl].[STAGE_FACT_ShapeVisits_Processed] ADD  DEFAULT ((0)) FOR [Processed]
GO
ALTER TABLE [StageControl].[STAGE_FACT_SimpleScoreDaily_Processed] ADD  DEFAULT ((0)) FOR [Processed]
GO
ALTER TABLE [StageControl].[STAGE_FACT_SiteSnapshotDaily_Processed] ADD  DEFAULT ((0)) FOR [Processed]
GO
ALTER TABLE [StageControl].[STAGE_InitialRun_UpdateKeys_Date_Processed] ADD  CONSTRAINT [DF_STAGE_InitialRun_UpdateKeys_Date_Processed]  DEFAULT ((0)) FOR [Processed]
GO
ALTER TABLE [StageControl].[STAGE_InitialRun_UpdateKeys_Processed] ADD  CONSTRAINT [DF_STAGE_InitialRun_UpdateKeys_Processed]  DEFAULT ((0)) FOR [Processed]
GO
ALTER TABLE [StageUser].[STAGE_DIM_Drivers] ADD  DEFAULT ((1)) FOR [IsActive]
GO
ALTER TABLE [StageUser].[STAGE_DIM_Vehicles] ADD  DEFAULT ((0)) FOR [IsYellowEquip]
GO
ALTER TABLE [StageUser].[STAGE_DIM_Vehicles] ADD  DEFAULT ((1)) FOR [TermScriptConfigGroup]
GO
USE [master]
GO
ALTER DATABASE [MiXStaging] SET  READ_WRITE 
GO
USE [MiXStaging]
GO
SET ARITHABORT ON
SET CONCAT_NULL_YIELDS_NULL ON
SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
SET NUMERIC_ROUNDABORT OFF

GO
/****** Object:  Index [IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE SPATIAL INDEX [IX_STAGE_DIM_GeoLocationsToShapes_ChangedShapes] ON [StageUser1].[STAGE_DIM_GeoLocationsToShapes_ChangedShapes]
(
	[ShapeBoundary]
)USING  GEOGRAPHY_GRID 
WITH (GRIDS =(LEVEL_1 = MEDIUM,LEVEL_2 = MEDIUM,LEVEL_3 = HIGH,LEVEL_4 = HIGH), 
CELLS_PER_OBJECT = 32, PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
SET ARITHABORT ON
SET CONCAT_NULL_YIELDS_NULL ON
SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
SET NUMERIC_ROUNDABORT OFF

GO
/****** Object:  Index [IX_STAGE_DIM_OrganisationsToGeoLocations_LocationPoint]    Script Date: 2012/12/02 02:27:07 PM ******/
CREATE SPATIAL INDEX [IX_STAGE_DIM_OrganisationsToGeoLocations_LocationPoint] ON [StageUser1].[STAGE_DIM_OrganisationsToGeoLocations]
(
	[LocationPoint]
)USING  GEOGRAPHY_GRID 
WITH (GRIDS =(LEVEL_1 = HIGH,LEVEL_2 = HIGH,LEVEL_3 = HIGH,LEVEL_4 = HIGH), 
CELLS_PER_OBJECT = 6, PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [StageUser1FG]
GO
